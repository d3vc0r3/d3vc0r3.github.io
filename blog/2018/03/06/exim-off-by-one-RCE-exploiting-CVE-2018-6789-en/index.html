

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>Exim Off-by-one RCE: Exploiting CVE-2018-6789 with Fully Mitigations Bypassing | DEVCORE</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="We reported an overflow vulnerability in the base64 decode function of Exim on 5 February, 2018, identified as CVE-2018-6789. This bug exists since the first commit of exim, hence ALL versions are affected. According to our research, it can be leveraged to gain Pre-auth Remote Code Execution and at least 400k servers are at risk. Patched version 4.90.1 is already released and we suggest to upgrade exim immediately." />
    <meta name="keywords" content="Advisory, Exim, RCE, CVE" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="Exim Off-by-one RCE: Exploiting CVE-2018-6789 with Fully Mitigations Bypassing | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2018/03/06/exim-off-by-one-RCE-exploiting-CVE-2018-6789-en/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20180306/cover.png" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Exim Off-by-one RCE: Exploiting CVE-2018-6789 with Fully Mitigations Bypassing | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="We reported an overflow vulnerability in the base64 decode function of Exim on 5 February, 2018, identified as CVE-2018-6789. This bug exists since the first commit of exim, hence ALL versions are affected. According to our research, it can be leveraged to gain Pre-auth Remote Code Execution and at least 400k servers are at risk. Patched version 4.90.1 is already released and we suggest to upgrade exim immediately.">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20180306/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2018/03/06/exim-off-by-one-RCE-exploiting-CVE-2018-6789-en/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body class="en">
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/en/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>Services<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    Red Team Assessment
                                </h2>
                                <p class="two-line">
                                    Simulation of real-world attacks to identify vulnerabilities and achieve objectives without disrupting business operations.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    Penetration Testing
                                </h2>
                                <p class="two-line">
                                    Infiltration of designated enterprise systems to uncover potential vulnerabilities and assess the risks or damages.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    Security Consulting
                                </h2>
                                <p class="two-line">
                                    Consultation of resource distribution and long-term defensive strategies from the attacker’s perspective.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    Security Training
                                </h2>
                                <p class="two-line">
                                    Instruction on defending and preventing incidents with the hacker mindset, also the response procedures and analysis of attacks when incidents happen.
                                </p>
                            </div>
                        </a>

                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>Research<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    Overview
                                </h2>
                                <p class="two-line">
                                    Research of updated cybersecurity techniques and trends, assess the security of products, and evolve the red team with broad experience.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    Competitions and Awards
                                </h2>
                                <p class="two-line">
                                    Awards from international cybersecurity competitions.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    Enterprise Vulnerability Reports
                                </h2>
                                <p class="two-line">
                                    Research of the risk of enterprise systems, identification of potential weaknesses, and report to vendors.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    International Conferences
                                </h2>
                                <p class="two-line">
                                    Sharing vulnerability research and security knowledge at international cybersecurity conferences.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE List
                                </h2>
                                <p class="two-line">
                                    Discovery of critical vulnerabilities in leading international products and services.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>Company<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                Company Overview
                            </h2>
                            <p>
                                Founded by a world-class white hat hacker team, providing cybersecurity services including Red Team Assessment,  Penetration Testing, Security Consulting, and Security Training.
                            </p>
                        </div>
                        </a>
                        <a href="/en/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    Team Members
                                </h2>
                                <p class="two-line">
                                    Composed of cybersecurity experts with the hacker mindset, exploring innovative exploitation techniques with high morality and extreme caution.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    Achievements
                                </h2>
                                <p class="two-line">
                                    DEVCORE has been invited to leading cybersecurity conferences, has uncovered hundreds of critical product vulnerabilities, and helped enterprises improve their defensive capabilities.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    Corporate Social Responsibility
                                </h2>
                                <p class="two-line">
                                    We provide diverse internship channels and programs to nurture the next generation and promote cybersecurity awareness.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    Job Opportunities
                                </h2>
                                <p class="two-line">
                                    Join us to secure the world and improve the cybersecurity industry together.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>News<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/en/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    Latest news
                                </p>
                            </div>
                        </a>
                        <a href="/en/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    Media Resources
                                </h2>
                                <p>
                                    Media Kit, Logo and Usage Guideline
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/en/search/">Search</a>
            </li>
            <li>
                <a class="menuLable" href="/en/contact/">Contact</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>Services</span>
                <div class="menuItem">
                    <a href="/en/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                Red Team Assessment
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                Penetration Testing
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                Security Consulting
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                Security Training
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>Research</span>
                <div class="menuItem">
                    <a href="/en/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>Overview</h2>
                        </div>
                    </a>
                    <a href="/en/research/awards/">
                        <div class="item">
                            <h2>Competitions and Awards</h2>
                        </div>
                    </a>
                    <a href="/en/research/bug-bounty/">
                        <div class="item">
                            <h2>Enterprise Vulnerability Reports</h2>
                        </div>
                    </a>
                    <a href="/en/research/talks/">
                        <div class="item">
                            <h2>International Conferences</h2>
                        </div>
                    </a>
                    <a href="/en/research/cve/">
                        <div class="item">
                            <h2>CVE List</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>Company</span>
                <div class="menuItem">
                    <a href="/en/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>Company Overview</h2>
                        </div>
                    </a>
                    <a href="/en/company/our-team/">
                        <div class="item">
                            <h2>Team Members</h2>
                        </div>
                    </a>
                    <a href="/en/company/history/">
                        <div class="item">
                            <h2>Achievements</h2>
                        </div>
                    </a>
                    <a href="/en/company/csr/">
                        <div class="item">
                            <h2>Corporate Social Responsibility</h2>
                        </div>
                    </a>
                    <a href="/en/company/jobs/">
                        <div class="item">
                            <h2>Job Opportunities</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>News</span>
                <div class="menuItem">
                    <a href="/en/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/en/media-kit/">
                        <div class="item">
                            <h2>Media Resources</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/en/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                Search
                            </h2>
                        </div>
                    </a>
                    <a href="/en/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                Contact
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/en/blog/">All Articles</a>
                </li>
                <li>
                    <a href="/en/blog/category/Tech%20Editorials/">Tech Editorials</a>
                </li>
                <li>
                    <a href="/en/media-kit/">Media Resources</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/en/blog/category/Tech Editorials">Tech Editorials</a>
                    <span class="tag">

                      <a href="/en/blog/tag/Advisory/">#Advisory</a> <a href="/en/blog/tag/Exim/">#Exim</a> <a href="/en/blog/tag/RCE/">#RCE</a> <a href="/en/blog/tag/CVE/">#CVE</a> 
                    </span>
                    <h1>
                        Exim Off-by-one RCE: Exploiting CVE-2018-6789 with Fully Mitigations Bypassing
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/en/blog/author/meh">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/meh.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/en/blog/author/meh">Meh</a></span>
                        <span class="date">2018-03-06</span>
                    </div>
                    
                    
                    <div class="article_img">
                        <img src="https://devco.re/assets/img/blog/20180306/cover.png"/>
                    </div>
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<h2 id="overview">Overview</h2>
<p>We reported an overflow vulnerability in the base64 decode function of <a href="https://www.exim.org/"><strong>Exim</strong></a> on 5 February, 2018, identified as <a href="https://exim.org/static/doc/security/CVE-2018-6789.txt">CVE-2018-6789</a>. This bug exists since the first commit of exim, hence <strong>ALL versions</strong> are affected. According to our research, it can be leveraged to gain <strong>Pre-auth Remote Code Execution</strong> and at least 400k servers are at risk. Patched version 4.90.1 is already released and we suggest to upgrade exim immediately.</p>

<h2 id="affected">Affected</h2>
<ul>
  <li>All Exim versions below 4.90.1</li>
</ul>

<h1 id="one-byte-overflow-in-base64-decoding">One byte overflow in base64 decoding</h1>

<h3 id="vulnerability-analysis">Vulnerability Analysis</h3>

<p>This is a calculation mistake of decode buffer length in <code class="language-plaintext highlighter-rouge">b64decode</code> function:
<a href="https://github.com/Exim/exim/blob/master/src/src/base64.c#L153">base64.c: 153 b64decode</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">b64decode</span><span class="p">(</span><span class="k">const</span> <span class="n">uschar</span> <span class="o">*</span><span class="n">code</span><span class="p">,</span> <span class="n">uschar</span> <span class="o">**</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
<span class="n">uschar</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">store_get</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">Ustrlen</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
<span class="c1">// perform decoding</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As shown above, exim allocates a buffer of <code class="language-plaintext highlighter-rouge">3*(len/4)+1</code> bytes to store decoded base64 data. However, when the input is not a valid base64 string and the length is <code class="language-plaintext highlighter-rouge">4n+3</code>, exim allocates <code class="language-plaintext highlighter-rouge">3n+1</code> but consumes <code class="language-plaintext highlighter-rouge">3n+2</code> bytes while decoding. This causes one byte heap overflow (aka off-by-one).
Generally, this bug is harmless because the memory overwritten is usually unused. However, this byte overwrites some critical data when the string fits some specific length. In addition, this byte is controllable, which makes exploitation more feasible.
Base64 decoding is such a fundamental function and therefore this bug can be triggered easily, causing remote code execution.
<a id="back"></a></p>

<h3 id="exploitation">Exploitation</h3>
<p>To estimate the severity of this bug, we developed an exploit targeting SMTP daemon of exim. The exploitation mechanism used to achieve pre-auth remote code execution is described in the following paragraphs. In order to leverage this one byte overflow, it is necessary to trick memory management mechanism. It is highly recommended to have basic knowledge of heap exploitation <a href="#heap_exp">[ref]</a> before reading this section.</p>

<p>We developed the exploit with:</p>
<ul>
  <li><strong>Debian(stretch)</strong> and <strong>Ubuntu(zesty)</strong></li>
  <li><strong>SMTP daemon of Exim4 package</strong> installed with apt-get (4.89/4.88)</li>
  <li>Config enabled (uncommented in default config) <strong>CRAM-MD5 authenticator</strong> (any other authenticator using base64 also works)</li>
  <li>Basic SMTP commands (<strong>EHLO, MAIL FROM/RCPT TO</strong>) and <strong>AUTH</strong></li>
</ul>

<h4 id="memory-allocation">Memory allocation</h4>

<p>First, we review the source code and search for useful memory allocation. As we mentioned in the <a href="">previous article</a>, exim uses self-defined functions for dynamic allocation:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">extern</span> <span class="n">BOOL</span>    <span class="nf">store_extend_3</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>  <span class="cm">/* The */</span>
<span class="k">extern</span> <span class="kt">void</span>    <span class="nf">store_free_3</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>     <span class="cm">/* value of the */</span>
<span class="k">extern</span> <span class="kt">void</span>   <span class="o">*</span><span class="nf">store_get_3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>         <span class="cm">/* 2nd arg is   */</span>
<span class="k">extern</span> <span class="kt">void</span>   <span class="o">*</span><span class="nf">store_get_perm_3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>    <span class="cm">/* __FILE__ in  */</span>
<span class="k">extern</span> <span class="kt">void</span>   <span class="o">*</span><span class="nf">store_malloc_3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>      <span class="cm">/* every call,  */</span>
<span class="k">extern</span> <span class="kt">void</span>    <span class="nf">store_release_3</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>  <span class="cm">/* so give its  */</span>
<span class="k">extern</span> <span class="kt">void</span>    <span class="nf">store_reset_3</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>    <span class="cm">/* correct type */</span>
</code></pre></div></div>
<p>Function <code class="language-plaintext highlighter-rouge">store_free()</code> and <code class="language-plaintext highlighter-rouge">store_malloc()</code> calls <code class="language-plaintext highlighter-rouge">malloc()</code> and <code class="language-plaintext highlighter-rouge">free()</code> of glibc directly. Glibc takes a slightly bigger (<code class="language-plaintext highlighter-rouge">0x10</code> bytes) <strong>chunk</strong> and stores its metadata in the first <code class="language-plaintext highlighter-rouge">0x10</code> bytes (x86-64) on every allocation, and then returns the location of <code class="language-plaintext highlighter-rouge">data</code>. The following illustration describes structure of chunk:
<img src="/assets/img/blog/20180306/1.png" alt="" /></p>

<p>Metadata includes size of previous chunk (the one exactly above in memory), size of current block and some flags. The first three bits of <code class="language-plaintext highlighter-rouge">size</code> are used to store flags. In this example, size of <code class="language-plaintext highlighter-rouge">0x81</code> implies current chunk is <code class="language-plaintext highlighter-rouge">0x80</code> bytes and the previous chunk is in use.
Most of released chunks used in exim are put into a doubly linked list called <strong>unsorted bin</strong>. Glibc maintains it according to the flags, and merges adjacent released chunks into a bigger chunk to avoid fragmentation. For every allocation request, glibc checks these chunks in an FIFO (first in, first-out) order and reuses the chunks.</p>

<p>For some performance issues, exim maintains its own linked list structure with <code class="language-plaintext highlighter-rouge">store_get()</code>, <code class="language-plaintext highlighter-rouge">store_release()</code>, <code class="language-plaintext highlighter-rouge">store_extend()</code> and <code class="language-plaintext highlighter-rouge">store_reset()</code>.
<img src="/assets/img/blog/20180306/2.png" alt="architecture of storeblock" />
The main feature of storeblocks is that every block is at least <code class="language-plaintext highlighter-rouge">0x2000</code> bytes, which becomes a restriction to our exploitation. Note that a storeblock is also the <code class="language-plaintext highlighter-rouge">data</code> of a chunk. Therefore, if we look into the memory, it is like:
<img src="/assets/img/blog/20180306/3.png" alt="" /></p>

<p>Here we list functions used to arrange heap data:</p>

<ul>
  <li>EHLO hostname
  For each EHLO(or HELO) command, exim stores the pointer of hostname in <code class="language-plaintext highlighter-rouge">sender_host_name</code>.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">store_free()</code> old name</li>
      <li><code class="language-plaintext highlighter-rouge">store_malloc()</code> for new name</li>
    </ul>

    <p><a href="https://github.com/Exim/exim/blob/master/src/src/smtp_in.c#L1833">smtp_in.c: 1833 check_helo</a></p>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="mi">1839</span> <span class="cm">/* Discard any previous helo name */</span>
  <span class="mi">1840</span>
  <span class="mi">1841</span> <span class="nf">if</span> <span class="p">(</span><span class="n">sender_helo_name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="mi">1842</span>   <span class="p">{</span>
  <span class="mi">1843</span>   <span class="n">store_free</span><span class="p">(</span><span class="n">sender_helo_name</span><span class="p">);</span>
  <span class="mi">1844</span>   <span class="n">sender_helo_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="mi">1845</span>   <span class="err">}</span>
  <span class="p">...</span>
  <span class="mi">1884</span> <span class="nf">if</span> <span class="p">(</span><span class="n">yield</span><span class="p">)</span> <span class="n">sender_helo_name</span> <span class="o">=</span> <span class="n">string_copy_malloc</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
  <span class="mi">1885</span> <span class="k">return</span> <span class="n">yield</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>Unrecognized command
  For every unrecognized command with unprintable characters, exim allocates a buffer to convert it to printable
    <ul>
      <li><code class="language-plaintext highlighter-rouge">store_get()</code> to store error message</li>
    </ul>

    <p><a href="https://github.com/Exim/exim/blob/master/src/src/smtp_in.c#L5725">smtp_in.c: 5725 smtp_setup_msg</a></p>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="mi">5725</span>   <span class="n">done</span> <span class="o">=</span> <span class="n">synprot_error</span><span class="p">(</span><span class="n">L_smtp_syntax_error</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
  <span class="mi">5726</span>     <span class="n">US</span><span class="s">"unrecognized command"</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>AUTH
  In most authentication procedure, exim uses base64 encoding to communicate with client. The encode and decode string are stored in a buffer allocated by <code class="language-plaintext highlighter-rouge">store_get()</code>.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">store_get()</code> for strings</li>
      <li>can contain unprintable characters, NULL bytes</li>
      <li>not necessarily null terminated</li>
    </ul>
  </li>
  <li>Reset in EHLO/HELO, MAIL, RCPT
  When a command is done correctly, <code class="language-plaintext highlighter-rouge">smtp_reset()</code> is called. This function calls <code class="language-plaintext highlighter-rouge">store_reset()</code> to reset block chain to a <strong>reset point</strong>, which means all storeblocks allocated by <code class="language-plaintext highlighter-rouge">store_get()</code> after last command are released.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">store_reset()</code> to reset point (set at the beginning of function)</li>
      <li>release blocks added at a time</li>
    </ul>

    <p><a href="https://github.com/Exim/exim/blob/master/src/src/smtp_in.c#L3771">smtp_in.c: 3771 smtp_setup_msg</a></p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  3771 int
  3772 smtp_setup_msg(void)
  3773 {
  3774 int done = 0;
  3775 BOOL toomany = FALSE;
  3776 BOOL discarded = FALSE;
  3777 BOOL last_was_rej_mail = FALSE;
  3778 BOOL last_was_rcpt = FALSE;
  3779 void *reset_point = store_get(0);
  3780
  3781 DEBUG(D_receive) debug_printf("smtp_setup_msg entered\n");
  3782
  3783 /* Reset for start of new message. We allow one RSET not to be counted as a
  3784 nonmail command, for those MTAs that insist on sending it between every
  3785 message. Ditto for EHLO/HELO and for STARTTLS, to allow for going in and out of
  3786 TLS between messages (an Exim client may do this if it has messages queued up
  3787 for the host). Note: we do NOT reset AUTH at this point. */
  3788
  3789 smtp_reset(reset_point);
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="exploit-steps">Exploit steps</h4>
<p>To leverage this off-by-one, the chunk beneath decoded base64 data should be freed easily and controllable. After several attempts, we found that <code class="language-plaintext highlighter-rouge">sender_host_name</code> is a better choice. We arrange the heap layout to leave a freed chunk above <code class="language-plaintext highlighter-rouge">sender_host_name</code> for the base64 data.
<img src="/assets/img/blog/20180306/4.png" alt="" /></p>

<ol>
  <li>
    <p>Put a huge chunk into unsorted bin
 First of all, we send a EHLO message with huge hostname to make it allocate and deallocate, leaving a <code class="language-plaintext highlighter-rouge">0x6060</code> length (3 storeblocks long) chunk in unsorted bin.</p>
  </li>
  <li>
    <p>Cut the first storeblock
 Then we send an unrecognized string to trigger <code class="language-plaintext highlighter-rouge">store_get()</code> and allocate a storeblock inside the freed chunk.</p>
  </li>
  <li>
    <p>Cut the second storeblock and release the first one
 We send a EHLO message again to get the second storeblock. The first block is freed sequentially because of the <code class="language-plaintext highlighter-rouge">smtp_reset</code> called after EHLO is done.</p>

    <p>After the heap layout is prepared, we can use the off-by-one to overwrite the original chunk size. We modify <code class="language-plaintext highlighter-rouge">0x2021</code> to <code class="language-plaintext highlighter-rouge">0x20f1</code>, which slightly extends the chunk.</p>

    <p><img src="/assets/img/blog/20180306/5.png" alt="" /></p>
  </li>
  <li>
    <p>Send base64 data and trigger off-by-one
 To trigger off-by-one, we start an AUTH command to send base64 data. The overflow byte precisely overwrites the first byte of next chunk and extends the next chunk.</p>
  </li>
  <li>
    <p>Forge a reasonable chunk size
 Because the chunk is extended, the start of next chunk of is changed to somewhere inside of the original one. Therefore, we need to make it <strong>seems like</strong> a normal chunk to pass sanity checks in glibc. We send another base64 string here, because it requires <code class="language-plaintext highlighter-rouge">NULL</code> byte and unprintable character to forge chunk size.</p>
  </li>
  <li>
    <p>Release the extended chunk
 To control the content of extended chunk, we need to release the chunk first because we cannot edit it directly. That is, we should send a new EHLO message to release the old host name. However, normal EHLO message calls <code class="language-plaintext highlighter-rouge">smtp_reset</code> after it succeeds, which possibly makes program abort or crash. To avoid this, we send an <strong>invalid</strong> host name such as <code class="language-plaintext highlighter-rouge">a+</code>.</p>
  </li>
  <li>
    <p>Overwrite the <strong><code class="language-plaintext highlighter-rouge">next</code></strong> pointer of overlapped storeblock</p>

    <p><img src="/assets/img/blog/20180306/6.png" alt="" />
 After the chunk is released, we can retrieve it with AUTH and overwrite part of overlapped storeblock. Here we use a trick called <strong>partial write</strong>. With this, we can modify the pointer without breaking <strong>ASLR</strong> (Address space layout randomization). We partially changed the <code class="language-plaintext highlighter-rouge">next</code> pointer to a storeblock containing ACL (Access Control List) strings. The ACL strings are pointed by a set of global pointers such as:</p>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">uschar</span> <span class="o">*</span><span class="n">acl_smtp_auth</span><span class="p">;</span>
 <span class="n">uschar</span> <span class="o">*</span><span class="n">acl_smtp_data</span><span class="p">;</span>
 <span class="n">uschar</span> <span class="o">*</span><span class="n">acl_smtp_etrn</span><span class="p">;</span>
 <span class="n">uschar</span> <span class="o">*</span><span class="n">acl_smtp_expn</span><span class="p">;</span>
 <span class="n">uschar</span> <span class="o">*</span><span class="n">acl_smtp_helo</span><span class="p">;</span>
 <span class="n">uschar</span> <span class="o">*</span><span class="n">acl_smtp_mail</span><span class="p">;</span>
 <span class="n">uschar</span> <span class="o">*</span><span class="n">acl_smtp_quit</span><span class="p">;</span>
 <span class="n">uschar</span> <span class="o">*</span><span class="n">acl_smtp_rcpt</span><span class="p">;</span>
</code></pre></div>    </div>
    <p>These pointers are initialized at the beginning of exim process, set according to the configure. For example, if there is a line <code class="language-plaintext highlighter-rouge">acl_smtp_mail = acl_check_mail</code> in the configure, the pointer <code class="language-plaintext highlighter-rouge">acl_smtp_mail</code> points to the string <code class="language-plaintext highlighter-rouge">acl_check_mail</code>. Whenever MAIL FROM is used, exim performs an ACL check, which expands <code class="language-plaintext highlighter-rouge">acl_check_mail</code> first. While expanding, exim tries to execute commands if it encounters <code class="language-plaintext highlighter-rouge">${run{cmd}}</code>, so we achieve code execution as long as we control the ACL strings. In addition, we do not need to hijack program control flow directly and therefore we can bypass mitigations such as <strong>PIE</strong> (Position Independent Executables), <strong>NX</strong> easily.</p>
  </li>
  <li>
    <p>Reset storeblocks and retrieve the ACL storeblock
 Now the ACL storeblock is in the linked list chain. It will be released once <code class="language-plaintext highlighter-rouge">smtp_reset()</code> is triggered, and then we can retrieve it again by allocating multiple blocks.</p>
  </li>
  <li>
    <p>Overwrite ACL strings and trigger ACL check
 Finally, we overwrite the whole block containing ACL strings. Now we send commands such as EHLO, MAIL, RCPT to trigger ACL checks. Once we touch an acl defined in the configure, we achieve remote code execution.</p>
  </li>
</ol>

<h2 id="fix">Fix</h2>
<p>Upgrade to 4.90.1 or above</p>

<h2 id="timeline">Timeline</h2>

<ul>
  <li>5 February, 2018 09:10 Reported to Exim</li>
  <li>6 February, 2018 23:23 CVE received</li>
  <li>10 February, 2018 18:00 Patch released</li>
</ul>

<h2 id="credits">Credits</h2>
<p>Vulnerabilities found by Meh, DEVCORE research team.
meh [at] devco [dot] re</p>

<h2 id="reference">Reference</h2>

<p>https://exim.org/static/doc/security/CVE-2018-6789.txt
https://git.exim.org/exim.git/commit/cf3cd306062a08969c41a1cdd32c6855f1abecf1
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-6789
http://www.openwall.com/lists/oss-security/2018/02/07/2</p>

<p><a id="heap_exp"></a></p>
<h4 id="heap-exploitation-materials-return">Heap exploitation materials <a href="#back">[return]</a></h4>
<ul>
  <li><a href="https://heap-exploitation.dhavalkapil.com/">Heap Exploitation</a>: A tutorial of heap exploitation by Dhaval Kapil</li>
  <li><a href="https://github.com/shellphish/how2heap">how2heap</a>: A repo for learning heap exploitation by Shellphish</li>
  <li><a href="https://www.slideshare.net/AngelBoy1/heap-exploitation-51891400">Heap exploitation</a>: (Chinese) A slide introducing basic glibc heap exploitation by Angelboy</li>
  <li><a href="https://www.slideshare.net/AngelBoy1/advanced-heap-exploitaion">Advanced heap exploitation</a>: (Chinese) A slide of advanced heap exploitation techniques by Angelboy</li>
  <li><a href="https://googleprojectzero.blogspot.tw/2014/08/the-poisoned-nul-byte-2014-edition.html">The poisoned NUL byte</a>: An article of Null byte off-by-one exploitation by Project Zero</li>
</ul>


                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/en/blog/author/meh">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/meh.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/en/blog/author/meh">
                            <h3>Meh</h3>
                        </a>
                        <span>Business Development Manager</span>
                        <p>
                            I am a pwner.
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/en/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Services</h6>
        <ul>
            <li><a href="/en/services/red-team/">Red Team Assessment</a></li>
            <li><a href="/en/services/penetration-test/">Penetration Testing</a></li>
            <li><a href="/en/services/security-consulting/">Security Consulting</a></li>
            <li><a href="/en/services/security-training/">Security Training</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Research</h6>
        <ul>
            <li><a href="/en/research/overview/">Overview</a></li>
            <li><a href="/en/research/awards/">Competitions and Awards</a></li>
            <li><a href="/en/research/bug-bounty/">Enterprise Vulnerability Reports</a></li>
            <li><a href="/en/research/talks/">International Conferences</a></li>
            <li><a href="/en/research/cve/">CVE List</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Company</h6>
        <ul>
            <li><a href="/en/company/about/">Company Overview</a></li>
            <li><a href="/en/company/our-team/">Team Members</a></li>
            <li><a href="/en/company/history/">Achievements</a></li>
            <li><a href="/en/company/csr/">Corporate Social Responsibility</a></li>
            <li><a href="/en/company/jobs/">Job Opportunities</a></li>
            <li><a href="/en/contact/">Contact</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">News</h6>
        <ul>
            <li><a href="/en/blog/">Blog</a></li>
            <li><a href="/en/media-kit/">Media Resources</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2023 DEVCORE <b class="line-block">All right reserved.</b></span>
            <span><a href="/en/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>










