

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>Content-Security-Policy - HTTP Headers 的資安議題 (2) | DEVCORE 戴夫寇爾</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="Content-Security-Policy 主要目的是用來防止 Cross-Site Scripting (XSS) 跟網頁樣式置換，本文將介紹 Content-Security-Policy 的使用方式、實際使用案例、常見誤用案例。" />
    <meta name="keywords" content="HTTP header,Defense,JavaScript,XSS" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="Content-Security-Policy - HTTP Headers 的資安議題 (2) | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2014/04/08/security-issues-of-http-headers-2-content-security-policy/" />
    <meta property="og:type" content="website" />
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Content-Security-Policy - HTTP Headers 的資安議題 (2) | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="Content-Security-Policy 主要目的是用來防止 Cross-Site Scripting (XSS) 跟網頁樣式置換，本文將介紹 Content-Security-Policy 的使用方式、實際使用案例、常見誤用案例。">
    <meta name="twitter:creator" content="d3vc0r3">
    
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2014/04/08/security-issues-of-http-headers-2-content-security-policy/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body>
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>服務<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    紅隊演練
                                </h2>
                                <p class="two-line">
                                    在不影響企業營運前提下，無所不用其極，從各種進入點執行模擬入侵攻擊，達成企業指定的演練情境。
                                </p>
                            </div>
                        </a>
                        <a href="/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    滲透測試
                                </h2>
                                <p class="two-line">
                                    以駭客思維及手法嘗試入侵企業指定系統，找出潛在漏洞，驗證企業資料與設備是否可被竊取或破壞。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    資安顧問服務
                                </h2>
                                <p class="two-line">
                                    以紅隊演練為基礎，提供攻擊者視角與可能入侵路徑，協助企業評估資安資源優先順序，並擬定長期防禦策略。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    資安教育訓練
                                </h2>
                                <p class="two-line">
                                    從攻擊思維出發，協助企業有效預防資安事故並防禦；以及事件發生時，如何快速判定攻擊目的、手法、漏洞與及應變方式。
                                </p>
                            </div>
                        </a>

                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>研究<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    總覽概要
                                </h2>
                                <p class="two-line">
                                    持續精研資安最新技術及漏洞研究趨勢，全方位檢測企業產品安全性、吸取經驗並轉化為紅隊演練工具與手法。
                                </p>
                            </div>
                        </a>
                        <a href="/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    競賽與獎項
                                </h2>
                                <p class="two-line">
                                    國際級資訊安全競賽獎項肯定。
                                </p>
                            </div>
                        </a>
                        <a href="/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    企業漏洞回報
                                </h2>
                                <p class="two-line">
                                    研究企業系統中的資安風險及各種可能的突破口，並通報企業修補。
                                </p>
                            </div>
                        </a>
                        <a href="/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    國際研討會
                                </h2>
                                <p class="two-line">
                                    參與全球資安盛會，發表、交流漏洞的知識與資訊。
                                </p>
                            </div>
                        </a>
                        <a href="/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE 漏洞列表
                                </h2>
                                <p class="two-line">
                                    挖掘並回報國際知名產品與服務的重大漏洞。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>公司<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                公司簡介
                            </h2>
                            <p>
                                DEVCORE 戴夫寇爾由世界級白帽駭客團隊創立，提供紅隊演練、滲透測試、資安顧問服務、資安教育訓練等服務。
                            </p>
                        </div>
                        </a>
                        <a href="/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    團隊成員
                                </h2>
                                <p class="two-line">
                                    由熱衷挑戰、具備駭客思維的資安專家組成，專注於創新攻擊手法研究，並以「高道德、高自律、高嚴謹」為最高指導原則。
                                </p>
                            </div>
                        </a>
                        <a href="/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    成就與沿革
                                </h2>
                                <p class="two-line">
                                    長期聚焦於攻擊研究，屢屢獲邀參與全球知名資安研討會，已揭露數百個重要產品漏洞、協助企業提升防禦能量。
                                </p>
                            </div>
                        </a>
                        <a href="/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    企業社會責任
                                </h2>
                                <p class="two-line">
                                    提供多元實習管道和研習計畫，提升新世代人才資安能量，推廣資訊安全意識。
                                </p>
                            </div>
                        </a>
                        <a href="/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    工作機會
                                </h2>
                                <p class="two-line">
                                    加入 DEVCORE，共同改善資安產業結構，與我們一起打造更安全的世界。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>新聞<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    DEVCORE 最新消息。
                                </p>
                            </div>
                        </a>
                        <a href="/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    媒體素材下載
                                </h2>
                                <p>
                                    使用 DEVCORE 商標須遵循的使用規範。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/search/">搜尋</a>
            </li>
            <li>
                <a class="menuLable" href="/contact/">聯絡我們</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>服務</span>
                <div class="menuItem">
                    <a href="/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                紅隊演練
                            </h2>
                        </div>
                    </a>
                    <a href="/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                滲透測試
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                顧問服務
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                教育訓練
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>資安研究</span>
                <div class="menuItem">
                    <a href="/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>總覽概要</h2>
                        </div>
                    </a>
                    <a href="/research/awards/">
                        <div class="item">
                            <h2>競賽與獎項</h2>
                        </div>
                    </a>
                    <a href="/research/bug-bounty/">
                        <div class="item">
                            <h2>Bug Bounty</h2>
                        </div>
                    </a>
                    <a href="/research/talks/">
                        <div class="item">
                            <h2>國際研討會</h2>
                        </div>
                    </a>
                    <a href="/research/cve/">
                        <div class="item">
                            <h2>CVE 漏洞列表</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>公司</span>
                <div class="menuItem">
                    <a href="/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>公司簡介</h2>
                        </div>
                    </a>
                    <a href="/company/our-team/">
                        <div class="item">
                            <h2>團隊成員</h2>
                        </div>
                    </a>
                    <a href="/company/history/">
                        <div class="item">
                            <h2>成就與沿革</h2>
                        </div>
                    </a>
                    <a href="/company/csr/">
                        <div class="item">
                            <h2>企業社會責任</h2>
                        </div>
                    </a>
                    <a href="/company/jobs/">
                        <div class="item">
                            <h2>工作機會</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>新聞</span>
                <div class="menuItem">
                    <!-- <a href="/blog/">
                    <div class="item">
                        <h2>所有文章</h2>
                    </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>案例剖析</h2>
                        </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>科普文章</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>技術專欄</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>資安新聞</h2>
                        </div>
                    </a> -->
                    <a href="/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/media-kit/">
                        <div class="item">
                            <h2>媒體素材下載</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                搜尋
                            </h2>
                        </div>
                    </a>
                    <a href="/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                聯絡我們
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/blog/">所有文章</a>
                </li>
                <li>
                    <a href="/blog/category/最新消息/">最新消息</a>
                </li>
                <li>
                    <a href="/blog/category/技術專欄/">技術專欄</a>
                </li>
                <li>
                    <a href="/blog/category/科普文章/">科普文章</a>
                </li>
                <li>
                    <a href="/blog/category/資安新聞/">資安新聞</a>
                </li>
                <li>
                    <a href="/media-kit/">媒體素材下載</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                    <span class="tag">

                      <a href="/blog/tag/HTTP Header/">#HTTP Header</a> <a href="/blog/tag/Defense/">#Defense</a> <a href="/blog/tag/JavaScript/">#JavaScript</a> <a href="/blog/tag/XSS/">#XSS</a> 
                    </span>
                    <h1>
                        Content-Security-Policy - HTTP Headers 的資安議題 (2)
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/blog/author/bowenhsu">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/bowen.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/blog/author/bowenhsu">Bowen Hsu</a></span>
                        <span class="date">2014-04-08</span>
                    </div>
                    
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<h3 id="content-security-policy">Content-Security-Policy</h3>

<p>還記得在上一篇 <a href="http://devco.re/blog/2014/03/10/security-issues-of-http-headers-1/">HTTP headers 的資安議題 (1)</a> 文章中，我們提到了多種資安相關的 HTTP headers 嗎？接下來的幾篇文章我們會介紹幾個專門對付 XSS 的 HTTP headers，首先就由 Content-Security-Policy 打頭陣。</p>

<p><a href="https://www.owasp.org/index.php/Content_Security_Policy">Content-Security-Policy</a>（以下簡稱 CSP）是從 2010 年被提出來的一項 Web 規格，主要目的是用來防止 Cross-Site Scripting（以下簡稱 XSS）跟網頁樣式置換（例如<a href="https://web.archive.org/web/20140321184408/http://udn.com:80/NEWS/NATIONAL/NAT5/8554327.shtml">科技部被惡搞</a>就是一個最好的例子）。經過五年發展，CSP 1.0 已從 W3C 的 TR (Technical Report) 變成 <a href="http://www.w3.org/TR/CSP/">Candidate Recommendation</a>，應該不久就會將成為 W3C 推薦標準。新的 <a href="http://w3c.github.io/webappsec/specs/content-security-policy/csp-specification.dev.html">CSP 1.1</a> 則仍在草案階段。</p>

<p>CSP 家族龐大，總共有三個類別，六個項目：</p>

<ul>
  <li>Content-Security-Policy</li>
  <li>Content-Security-Policy-Report-Only</li>
  <li>X-Content-Security-Policy</li>
  <li>X-Content-Security-Policy-Report-Only</li>
  <li>X-WebKit-CSP</li>
  <li>X-WebKit-CSP-Report-Only</li>
</ul>

<p>在 CSP 發展初期，主流瀏覽器並未全部依照同一標準來開發，因此發展成這三種類別。目前由於 CSP 1.0 即將成為標準，大多數瀏覽器已支援 Content-Security-Policy 這個類別，因此狀況已逐漸收斂。主流瀏覽器的支援列表如下圖：</p>

<p><a href="/assets/img/blog/20140408/csp-browser-support-list.png" title="Content-Security-Policy 瀏覽器支援列表"><img src="/assets/img/blog/20140408/csp-browser-support-list.png" alt="Content-Security-Policy 瀏覽器支援列表" title="Content-Security-Policy 瀏覽器支援列表" /></a></p>

<p>從列表中可看到，只要使用 Content-Security-Policy 與 X-Content-Security-Policy 就已有很高的覆蓋率，除非要支援 Safari 6，否則不用特意使用 X-WebKit-CSP。更詳細的瀏覽器支援列表可參考 <a href="http://caniuse.com/contentsecuritypolicy">Can I use</a>。</p>

<!-- more -->

<h3 id="csp-10-主要作用">CSP 1.0 主要作用</h3>

<ul>
  <li>
    <p>載入來源白名單</p>

    <p>宣告一組受信任的白名單與資源種類（如 JavaScript, CSS, image 等等），使瀏覽器只能從此白名單中載入資源，藉此防止攻擊者從外部引入含有惡意程式碼的資源。</p>

    <p>例：Content-Security-Policy: default-src ‘self’; script-src ‘self’ http://js.devco.re; style-src ‘self’ http://css.devco.re; img-src ‘self’ data:; frame-src ‘none’</p>

    <p>效果：限定 script 資源只能從 http://js.devco.re 載入；限定 style 資源只能從 http://css.devco.re 載入；限定 img 只能從相同 domain 載入，並且支援 data scheme；限定 frame 不能從任何來源載入；除了 script、style、img、frame 之外的資源，則只能從同樣 domain 以及同樣協定的來源載入。</p>
  </li>
  <li>
    <p>禁止 inline 程式碼</p>

    <p>一般人開發網站時為求便利，經常會在 HTML 中寫入一些 inline 程式碼，但攻擊者意圖入侵網站時也常用此手法。然而瀏覽器其實無法分辨這些 inline 程式碼究竟是開發人員寫的，還是攻擊者植入的。因此 CSP 乾脆強迫開發者必須把所有 inline 程式碼移到外部檔案，完全杜絕在 HTML 中出現 inline 程式碼的狀況。因此除非你在 CSP 宣告時有註明 ‘unsafe-inline’，否則 CSP 預設禁止使用 inline script 或 inline CSS。</p>

    <p>例：Content-Security-Policy: default-src ‘self’; script-src ‘unsafe-inline’</p>
  </li>
  <li>
    <p>禁止 eval 函式</p>

    <p>eval() 對許多開發者來說一直是個非常方便的函式，然而若缺乏資安觀念，使用此函式時很可能會導致潛在的 XSS 風險。因此除非你在 CSP 宣告時有註明 ‘unsafe-eval’，否則 CSP 預設禁止使用 eval() 函式。</p>

    <p>例：Content-Security-Policy: default-src ‘self’; script-src ‘unsafe-eval’</p>
  </li>
  <li>
    <p>防止 sniffer</p>

    <p>由於 CSP 可指定載入資源時強制使用 https 協定，因此可降低被 sniffing 的機率。</p>

    <p>例：Content-Security-Policy: default-src http://devco.re; img-src https:</p>

    <p>效果：限定圖片只能從 https 協定載入，不限定 domain。而除了圖片之外的資源則可從任意來源載入。</p>
  </li>
</ul>

<h3 id="csp-demo">CSP Demo</h3>

<p>下面這一段程式碼，使用 default-src * 讓相關資源可正常顯示：</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nb">header</span><span class="p">(</span><span class="s2">"Content-Security-Policy: default-src *"</span><span class="p">);</span>
<span class="cp">?&gt;</span>

<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>CSP Demo Site<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;h3&gt;</span>Content Security Policy Demo Site<span class="nt">&lt;/h3&gt;</span>
        <span class="nt">&lt;img</span> <span class="na">width=</span><span class="s">"200"</span> <span class="na">height=</span><span class="s">"200"</span> <span class="na">src=</span><span class="s">"http://devco.re/assets/themes/devcore/images/double-sticker.png"</span><span class="nt">&gt;&lt;/img&gt;</span>
        <span class="nt">&lt;iframe</span> <span class="na">frameborder=</span><span class="s">'0'</span> <span class="na">width=</span><span class="s">'300'</span> <span class="na">height=</span><span class="s">'200'</span> <span class="na">src=</span><span class="s">'http://www.youtube.com/embed/E-BGf1MwecU'</span><span class="nt">&gt;&lt;/iframe&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre></figure>

<p><a href="/assets/img/blog/20140408/csp-demo-1.png" title="使用最寬鬆的 Content-Security-Policy 規則"><img src="/assets/img/blog/20140408/csp-demo-1.png" alt="使用最寬鬆的 Content-Security-Policy 規則" title="使用最寬鬆的 Content-Security-Policy 規則" /></a></p>

<p>接下來我們將 php header 的那一行程式碼修改如下並且 reload 瀏覽器頁面：</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nb">header</span><span class="p">(</span><span class="s2">"Content-Security-Policy: default-src *; img-src https:; frame-src 'none'"</span><span class="p">);</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p><a href="/assets/img/blog/20140408/csp-demo-2.png" title="使用 Content-Security-Policy 限制 img 與 frame 的來源"><img src="/assets/img/blog/20140408/csp-demo-2.png" alt="使用 Content-Security-Policy 限制 img 與 frame 的來源" title="使用 Content-Security-Policy 限制 img 與 frame 的來源" /></a></p>

<p>使用 CSP 限制 img 與 frame 的來源種類後，我們可以從上圖 Chrome Inspector 的紅字觀察到，網站的圖片與 iframe 影片已被瀏覽器擋掉，無法載入。</p>

<p>如果擔心直接使用 CSP 會影響網站營運，但又想嘗試 CSP，可以先使用 Content-Security-Policy-Report-Only，示範如下：</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nb">header</span><span class="p">(</span><span class="s2">"Content-Security-Policy-Report-Only: default-src *; img-src https:; frame-src 'none'; report-uri http://devco.re/demo"</span><span class="p">);</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p><a href="/assets/img/blog/20140408/csp-demo-report-only.png" title="Content-Security-Policy-Report-Only"><img src="/assets/img/blog/20140408/csp-demo-report-only.png" alt="Content-Security-Policy-Report-Only" title="Content-Security-Policy-Report-Only" /></a></p>

<p>由上圖可以看到，此 header 不會直接阻擋不符合 CSP 規範的資源，但是會根據使用者所違反的規則發送相對應的 POST request 至指定的 URI，發送內容如下：</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"csp-report"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"blocked-uri"</span><span class="p">:</span><span class="s2">"http://devco.re/"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"document-uri"</span><span class="p">:</span><span class="s2">"http://yoursite.com/csp.php"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"original-policy"</span><span class="p">:</span><span class="s2">"default-src *; img-src https:; frame-src 'none'; report-uri http://devco.re/demo"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"referrer"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status-code"</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="w">
    </span><span class="nl">"violated-directive"</span><span class="p">:</span><span class="s2">"img-src https:"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>由發送內容可看出這個 request 因為違反了「img-src https:」規則而將「http://devco.re/」這個來源擋掉。經由此方式，可一邊修改網站一邊觀察是否仍有不符合 CSP 規範之處，等到所有違規的內容都修正完畢後，再將 CSP 套用到正式上線環境。</p>

<p>由於宣告方式非常多種，在這邊就不一一條列，若有興趣可前往 <a href="https://content-security-policy.com/">Content Security Policy Reference &amp; Examples</a>、<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Using Content Security Policy - Security | MDN</a> 等網頁，有更完整的使用情境與範例可供參考。另外也有 <a href="http://benvinegar.github.io/csp-talk-2013/">Slide</a> (by Ben Vinegar) 跟 <a href="https://www.youtube.com/watch?v=pocsv39pNXA">YouTube 影片</a> (by Adam Barth) 可參考。</p>

<h3 id="csp-實際使用案例">CSP 實際使用案例</h3>

<p>目前採用 CSP 的案例較少，比較知名的使用案例是 <a href="https://github.com/">GitHub</a>，在 2013 年 4 月 <a href="https://github.com/blog/1477-content-security-policy">GitHub 還寫了一篇專文</a>公告表示他們已開始採用 CSP。另外一個案例廠商可能較廣為人知，是在 2013 年當紅的免費儲存空間 <a href="https://mega.co.nz/">MEGA</a>。兩個案例的實際內容可見於下圖：</p>

<p><a href="/assets/img/blog/20140408/http-headers-github-and-mega.jpg" title="GitHub 與 MEGA 使用 CSP 後的 HTTP response"><img src="/assets/img/blog/20140408/http-headers-github-and-mega.jpg" alt="GitHub 與 MEGA 使用 CSP 後的 HTTP response" title="GitHub 與 MEGA 使用 CSP 後的 HTTP response" /></a></p>

<p>另一項知名使用案例是 Google 明定<a href="https://developer.chrome.com/extensions/contentSecurityPolicy">開發 Chrome Extension 時必須使用 CSP</a>，以追求更高的安全性。Mozilla 也在 <a href="https://wiki.mozilla.org/Security/CSP/Specification">MozillaWiki 開了一頁</a>存放相關技術細節。若您想觀察其他使用案例，可使用 Chrome Inspector 或 curl 觀察以下幾個網站：<a href="https://lastpass.com/">LastPass</a>，<a href="https://twitter.com/">Twitter</a>，<a href="https://1password.com/">1Password</a>。</p>

<h3 id="csp-常見誤用案例">CSP 常見誤用案例</h3>

<ul>
  <li>
    <p>directives 後面不需加冒號</p>

    <p>錯誤：default-src: ‘self’</p>

    <p>正確：<strong>default-src ‘self’</strong></p>
  </li>
  <li>
    <p>directives 之間以分號區隔</p>

    <p>錯誤：default-src ‘self’, script-src ‘self’</p>

    <p>正確：<strong>default-src ‘self’; script-src ‘self’</strong></p>
  </li>
  <li>
    <p>多個 source 之間僅以空白區隔</p>

    <p>錯誤：default-src ‘self’; img-src ‘self’, img1.devco.re, img2.devco.re</p>

    <p>正確：<strong>default-src ‘self’; img-src ‘self’ img1.devco.re img2.devco.re</strong></p>
  </li>
  <li>
    <p>某些 source 必須加冒號（https:、data:）</p>

    <p>錯誤：default-src ‘self’; img-src ‘self’ https data</p>

    <p>正確：<strong>default-src ‘self’; img-src ‘self’ https: data:</strong></p>
  </li>
  <li>
    <p>某些 source 必須用單引號括起來（’none’、’self’、’unsafe-inline’、’unsafe-eval’）</p>

    <p>錯誤：script-src self unsafe-inline unsafe-eval</p>

    <p>正確：<strong>script-src ‘self’ ‘unsafe-inline’ ‘unsafe-eval’</strong></p>
  </li>
</ul>

<h3 id="結論">結論</h3>

<p>使用 CSP 可以有效提升攻擊難度，讓許多常見的 XSS 攻擊失效，是一個非常推薦開發者使用的 HTTP header。但由於目前的開發者在 HTML 裡面寫 inline script 及 inline CSS 的比例非常高，同時也有一些網路服務預設都需要使用 inline script（例如 Google Analytics，相關解法可參考<a href="http://stackoverflow.com/questions/3870345/new-google-analytics-code-into-external-file">這裡</a>），因此要享受這樣的安全之前，可能需要先付出許多時間與心力將網站大幅整理，套用 CSP 規範後網頁才能正常運作。</p>

                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/blog/author/bowenhsu">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/bowen.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/blog/author/bowenhsu">
                            <h3>Bowen Hsu</h3>
                        </a>
                        <span>Senior Vice President</span>
                        <p>
                            「如果你不想讓別人進來一探究竟，你有責任將它打造得更好。」正是這種熱血的使命讓我一腳踏入資訊安全。專長於滲透測試，喜歡用 Python 寫各種資安工具！
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

        <!-- 相關文章 -->
        <section class="recommand articles-list">
            <div class="container">
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/最新消息">最新消息</a>
                        <span class="tag">
    
                          <a href="/blog/tag/公告/">#公告</a> <a href="/blog/tag/徵才/">#徵才</a> 
                        </span>
                        <h2>
                            <a href="/blog/2023/07/18/4nd-internship-program-recruit/">DEVCORE 2023 第四屆實習生計畫</a> 
                        </h2>
                    
                    
                        <span class="date">2023-07-18</span>
                        <p class="line-litmit-3">DEVCORE 第四屆實習生計畫開始，計畫目的希望能培育人才、增強新世代的資安技能，如果您對這個計畫有興趣，歡迎來信報名！
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                        <span class="tag">
    
                          <a href="/blog/tag/Google, LFI, Shell/">#Google, LFI, Shell</a> 
                        </span>
                        <h2>
                            <a href="/blog/2023/07/07/a-journey-into-hacking-google-search-appliance/">[REL] 深入破解 Google Search Appliance</a> 
                        </h2>
                    
                    
                        <span class="date">2023-07-07</span>
                        <p class="line-litmit-3">Google Search Appliance (以下簡稱 GSA ) 是 Google 於2002 年開始為企業推出的搜尋設備，主要功能為放置於企業內網用於索引內部網路資訊並提供檢索。
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/最新消息">最新消息</a>
                        <span class="tag">
    
                          <a href="/blog/tag/資安人才/">#資安人才</a> 
                        </span>
                        <h2>
                            <a href="/blog/2023/05/26/from-cybersecurity-muggle-to-red-team-specialist-vtim/">從資安麻瓜到紅隊演練專家－Vtim</a> 
                        </h2>
                    
                    
                        <span class="date">2023-05-26</span>
                        <p class="line-litmit-3">目前於 DEVCORE 戴夫寇爾擔任紅隊演練專家的 Vtim，現年 27 歲，曾帶領過多次紅隊演練專案，擁有數十場紅隊演練經驗，也有豐富的資安競賽及國際企業漏洞獎勵計畫經驗，亦通過 OSCP、OSWE 認證，具備專業的 Web 檢測與內網滲透能力。
                        </p>
                    </div>
                </article>
              

            </div>
        </section>
    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">服務</h6>
        <ul>
            <li><a href="/services/red-team/">紅隊演練</a></li>
            <li><a href="/services/penetration-test/">滲透測試</a></li>
            <li><a href="/services/security-consulting/">資安顧問服務</a></li>
            <li><a href="/services/security-training/">資安教育訓練</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">研究</h6>
        <ul>
            <li><a href="/research/overview/">總覽概要</a></li>
            <li><a href="/research/awards/">競賽與獎項</a></li>
            <li><a href="/research/bug-bounty/">企業漏洞回報</a></li>
            <li><a href="/research/talks/">國際研討會</a></li>
            <li><a href="/research/cve/">CVE 漏洞列表</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">公司</h6>
        <ul>
            <li><a href="/company/about/">公司簡介</a></li>
            <li><a href="/company/our-team/">團隊成員</a></li>
            <li><a href="/company/history/">成就與沿革</a></li>
            <li><a href="/company/csr/">企業社會責任</a></li>
            <li><a href="/company/jobs/">工作機會</a></li>
            <li><a href="/contact/">聯絡我們</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">新聞</h6>
        <ul>
            <li><a href="/blog/">BLOG</a></li>
            <li><a href="/media-kit/">媒體素材下載</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2023 DEVCORE 戴夫寇爾股份有限公司. <b class="line-block">All right reserved.</b></span>
            <span><a href="/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>

