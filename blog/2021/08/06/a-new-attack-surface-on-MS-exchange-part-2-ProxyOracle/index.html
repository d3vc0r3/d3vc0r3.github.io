

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>A New Attack Surface on MS Exchange Part 2 - ProxyOracle! | DEVCORE</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="ProxyOracle! The attack on Exchange Server to recover any user's password in plaintext format" />
    <meta name="keywords" content="CVE-2021-31196, CVE-2021-31195" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="A New Attack Surface on MS Exchange Part 2 - ProxyOracle! | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2021/08/06/a-new-attack-surface-on-MS-exchange-part-2-ProxyOracle/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20210806/2/cover.png" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="A New Attack Surface on MS Exchange Part 2 - ProxyOracle! | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="ProxyOracle! The attack on Exchange Server to recover any user's password in plaintext format">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20210806/2/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2021/08/06/a-new-attack-surface-on-MS-exchange-part-2-ProxyOracle/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body class="en">
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/en/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>Services<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    Red Team Assessment
                                </h2>
                                <p class="two-line">
                                    Simulation of real-world attacks to identify vulnerabilities and achieve objectives without disrupting business operations.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    Penetration Testing
                                </h2>
                                <p class="two-line">
                                    Infiltration of designated enterprise systems to uncover potential vulnerabilities and assess the risks or damages.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    Security Consulting
                                </h2>
                                <p class="two-line">
                                    Consultation of resource distribution and long-term defensive strategies from the attacker’s perspective.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    Security Training
                                </h2>
                                <p class="two-line">
                                    Instruction on defending and preventing incidents with the hacker mindset, also the response procedures and analysis of attacks when incidents happen.
                                </p>
                            </div>
                        </a>

                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>Research<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    Overview
                                </h2>
                                <p class="two-line">
                                    Research of updated cybersecurity techniques and trends, assess the security of products, and evolve the red team with broad experience.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    Competitions and Awards
                                </h2>
                                <p class="two-line">
                                    Awards from international cybersecurity competitions.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    Enterprise Vulnerability Reports
                                </h2>
                                <p class="two-line">
                                    Research of the risk of enterprise systems, identification of potential weaknesses, and report to vendors.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    International Conferences
                                </h2>
                                <p class="two-line">
                                    Sharing vulnerability research and security knowledge at international cybersecurity conferences.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE List
                                </h2>
                                <p class="two-line">
                                    Discovery of critical vulnerabilities in leading international products and services.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>Company<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                Company Overview
                            </h2>
                            <p>
                                Founded by a world-class white hat hacker team, providing cybersecurity services including Red Team Assessment,  Penetration Testing, Security Consulting, and Security Training.
                            </p>
                        </div>
                        </a>
                        <a href="/en/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    Team Members
                                </h2>
                                <p class="two-line">
                                    Composed of cybersecurity experts with the hacker mindset, exploring innovative exploitation techniques with high morality and extreme caution.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    Achievements
                                </h2>
                                <p class="two-line">
                                    DEVCORE has been invited to leading cybersecurity conferences, has uncovered hundreds of critical product vulnerabilities, and helped enterprises improve their defensive capabilities.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    Corporate Social Responsibility
                                </h2>
                                <p class="two-line">
                                    We provide diverse internship channels and programs to nurture the next generation and promote cybersecurity awareness.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    Job Opportunities
                                </h2>
                                <p class="two-line">
                                    Join us to secure the world and improve the cybersecurity industry together.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>News<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/en/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    Latest news
                                </p>
                            </div>
                        </a>
                        <a href="/en/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    Media Resources
                                </h2>
                                <p>
                                    Media Kit, Logo and Usage Guideline
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/en/search/">Search</a>
            </li>
            <li>
                <a class="menuLable" href="/en/contact/">Contact</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>Services</span>
                <div class="menuItem">
                    <a href="/en/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                Red Team Assessment
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                Penetration Testing
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                Security Consulting
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                Security Training
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>Research</span>
                <div class="menuItem">
                    <a href="/en/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>Overview</h2>
                        </div>
                    </a>
                    <a href="/en/research/awards/">
                        <div class="item">
                            <h2>Competitions and Awards</h2>
                        </div>
                    </a>
                    <a href="/en/research/bug-bounty/">
                        <div class="item">
                            <h2>Enterprise Vulnerability Reports</h2>
                        </div>
                    </a>
                    <a href="/en/research/talks/">
                        <div class="item">
                            <h2>International Conferences</h2>
                        </div>
                    </a>
                    <a href="/en/research/cve/">
                        <div class="item">
                            <h2>CVE List</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>Company</span>
                <div class="menuItem">
                    <a href="/en/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>Company Overview</h2>
                        </div>
                    </a>
                    <a href="/en/company/our-team/">
                        <div class="item">
                            <h2>Team Members</h2>
                        </div>
                    </a>
                    <a href="/en/company/history/">
                        <div class="item">
                            <h2>Achievements</h2>
                        </div>
                    </a>
                    <a href="/en/company/csr/">
                        <div class="item">
                            <h2>Corporate Social Responsibility</h2>
                        </div>
                    </a>
                    <a href="/en/company/jobs/">
                        <div class="item">
                            <h2>Job Opportunities</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>News</span>
                <div class="menuItem">
                    <a href="/en/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/en/media-kit/">
                        <div class="item">
                            <h2>Media Resources</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/en/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                Search
                            </h2>
                        </div>
                    </a>
                    <a href="/en/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                Contact
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/en/blog/">All Articles</a>
                </li>
                <li>
                    <a href="/en/blog/category/Tech%20Editorials/">Tech Editorials</a>
                </li>
                <li>
                    <a href="/en/media-kit/">Media Resources</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/en/blog/category/Tech Editorials">Tech Editorials</a>
                    <span class="tag">

                      <a href="/en/blog/tag/Advisory/">#Advisory</a> <a href="/en/blog/tag/CVE/">#CVE</a> <a href="/en/blog/tag/RCE/">#RCE</a> <a href="/en/blog/tag/Exchange/">#Exchange</a> 
                    </span>
                    <h1>
                        A New Attack Surface on MS Exchange Part 2 - ProxyOracle!
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/en/blog/author/orange">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/orange.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/en/blog/author/orange">Orange Tsai</a></span>
                        <span class="date">2021-08-06</span>
                    </div>
                    
                    
                    <div class="article_img">
                        <img src="https://devco.re/assets/img/blog/20210806/2/cover.png"/>
                    </div>
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<style type="text/css">
    .center-image {
        margin: 0 auto;
        display: block;
    }
</style>

<p>Hi, this is the part 2 of the New MS Exchange Attack Surface. Because this article refers to several architecture introductions and attack surface concepts in the previous article, you could find the first piece here:</p>
<ul>
  <li><a href="/blog/2021/08/06/a-new-attack-surface-on-MS-exchange-part-1-ProxyLogon/">A New Attack Surface on MS Exchange Part 1 - ProxyLogon!</a></li>
</ul>

<p>This time, we will be introducing ProxyOracle. Compared with ProxyLogon, ProxyOracle is an interesting exploit with a different approach. By simply leading a user to visit a malicious link, ProxyOracle allows an attacker to recover the user’s password in plaintext  format completely. ProxyOracle consists of two vulnerabilities:</p>
<ul>
  <li><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31195">CVE-2021-31195</a> - Reflected Cross-Site Scripting</li>
  <li><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31196">CVE-2021-31196</a> - Padding Oracle Attack on Exchange Cookies Parsing</li>
</ul>

<h1 id="where-is-proxyoracle">Where is ProxyOracle</h1>

<p>So where is ProxyOracle? Based on the CAS architecture we introduced before, the Frontend of CAS will first serialize the User Identity to a string and put it in the header of <code class="language-plaintext highlighter-rouge">X-CommonAccessToken</code>. The header will be merged into the client’s HTTP request and sent to the Backend later. Once the Backend receives, it deserializes the header back to the original User Identity in Frontend.</p>

<p>We now know how the Frontend and Backend synchronize the User Identity. The next is to explain how the Frontend knows who you are and processes your credentials. The Outlook Web Access (OWA) uses a fancy interface to handle the whole login mechanism, which is called Form-Based Authentication (FBA). The FBA is a special IIS module that inherits the <code class="language-plaintext highlighter-rouge">ProxyModule</code> and is responsible for executing the transformation between the credentials and cookies before entering the proxy logic.</p>

<p><img src="/assets/img/blog/20210806/2/1.png" alt="" /></p>

<h1 id="the-fba-mechanism">The FBA Mechanism</h1>

<p>HTTP is a stateless protocol. To keep your login state, FBA saves the username and password in cookies. Every time you visit the OWA, Exchange will parse the cookies, retrieve the credential and try to log in with that. If the login succeed, Exchange will serialize your User Identity into a string, put it into the header of <code class="language-plaintext highlighter-rouge">X-CommonAccessToken</code>, and forward it to the Backend</p>

<p><strong>HttpProxy\FbaModule.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnBeginRequestInternal</span><span class="p">(</span><span class="n">HttpApplication</span> <span class="n">httpApplication</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">httpApplication</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Items</span><span class="p">[</span><span class="s">"AuthType"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"FBA"</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="p">.</span><span class="nf">HandleFbaAuthFormPost</span><span class="p">(</span><span class="n">httpApplication</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">ParseCadataCookies</span><span class="p">(</span><span class="n">httpApplication</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">MissingSslCertificateException</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NameValueCollection</span> <span class="n">nameValueCollection</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NameValueCollection</span><span class="p">();</span>
            <span class="n">nameValueCollection</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"CafeError"</span><span class="p">,</span> <span class="n">ErrorFE</span><span class="p">.</span><span class="n">FEErrorCodes</span><span class="p">.</span><span class="n">SSLCertificateProblem</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">HttpException</span><span class="p">(</span><span class="m">302</span><span class="p">,</span> <span class="n">AspNetHelper</span><span class="p">.</span><span class="nf">GetCafeErrorPageRedirectUrl</span><span class="p">(</span><span class="n">httpApplication</span><span class="p">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">nameValueCollection</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">base</span><span class="p">.</span><span class="nf">OnBeginRequestInternal</span><span class="p">(</span><span class="n">httpApplication</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>All the cookies are encrypted to ensure even if an attacker can hijack the HTTP request, he/she still couldn’t get your credential in plaintext format. FBA leverages 5 special cookies to accomplish the whole de/encryption process:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">cadata</code> - The encrypted username and password</li>
  <li><code class="language-plaintext highlighter-rouge">cadataTTL</code> - The Time-To-Live timestamp</li>
  <li><code class="language-plaintext highlighter-rouge">cadataKey</code> - The KEY for encryption</li>
  <li><code class="language-plaintext highlighter-rouge">cadataIV</code> - The IV for encryption</li>
  <li><code class="language-plaintext highlighter-rouge">cadataSig</code> - The signature to prevent tampering</li>
</ul>

<p><img src="/assets/img/blog/20210806/2/2.png" alt="" /></p>

<p>The encryption logic will first generate two 16 bytes random strings as the IV and KEY for the current session. The username and password will then be encoded with Base64, encrypted by the algorithm AES and sent back to the client within cookies. Meanwhile, the IV and KEY will be sent to the user, too. To prevent the client from decrypting the credential by the known IV and KEY directly, Exchange will once again use the algorithm RSA to encrypt the IV and KEY via its SSL certificate private key before sending out!</p>

<p>Here is a Pseudo Code for the encryption logic:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">@key</span> <span class="p">=</span> <span class="nf">GetServerSSLCert</span><span class="p">().</span><span class="nf">GetPrivateKey</span><span class="p">()</span>
 <span class="n">cadataSig</span> <span class="p">=</span> <span class="nf">RSA</span><span class="p">(</span><span class="n">@key</span><span class="p">).</span><span class="nf">Encrypt</span><span class="p">(</span><span class="s">"Fba Rocks!"</span><span class="p">)</span>
 <span class="n">cadataIV</span>  <span class="p">=</span> <span class="nf">RSA</span><span class="p">(</span><span class="n">@key</span><span class="p">).</span><span class="nf">Encrypt</span><span class="p">(</span><span class="nf">GetRandomBytes</span><span class="p">(</span><span class="m">16</span><span class="p">))</span>
 <span class="n">cadataKey</span> <span class="p">=</span> <span class="nf">RSA</span><span class="p">(</span><span class="n">@key</span><span class="p">).</span><span class="nf">Encrypt</span><span class="p">(</span><span class="nf">GetRandomBytes</span><span class="p">(</span><span class="m">16</span><span class="p">))</span>

 <span class="n">@timestamp</span> <span class="p">=</span> <span class="nf">GetCurrentTimestamp</span><span class="p">()</span>
 <span class="n">cadataTTL</span>  <span class="p">=</span> <span class="nf">AES_CBC</span><span class="p">(</span><span class="n">cadataKey</span><span class="p">,</span> <span class="n">cadataIV</span><span class="p">).</span><span class="nf">Encrypt</span><span class="p">(</span><span class="n">@timestamp</span><span class="p">)</span>

 <span class="n">@blob</span>  <span class="p">=</span> <span class="s">"Basic "</span> <span class="p">+</span> <span class="nf">ToBase64String</span><span class="p">(</span><span class="n">UserName</span> <span class="p">+</span> <span class="s">":"</span> <span class="p">+</span> <span class="n">Password</span><span class="p">)</span>
 <span class="n">cadata</span> <span class="p">=</span> <span class="nf">AES_CBC</span><span class="p">(</span><span class="n">cadataKey</span><span class="p">,</span> <span class="n">cadataIV</span><span class="p">).</span><span class="nf">Encrypt</span><span class="p">(</span><span class="n">@blob</span><span class="p">)</span>
</code></pre></div></div>

<p>The Exchange takes CBC as its padding mode. If you are familiar with Cryptography, you might be wondering whether the CBC mode here is vulnerable to the Padding Oracle Attack? Bingo! As a matter of fact, Padding Oracle Attack is still existing in such essential software like Exchange in 2021!</p>

<p><img src="/assets/img/blog/20210806/2/3.gif" alt="" class="center-image" /></p>

<h1 id="cve-2021-31196---the-padding-oracle">CVE-2021-31196 - The Padding Oracle</h1>

<p>When there is something wrong with the FBA, Exchange attaches an error code and redirects the HTTP request back to the original login page. So where is the Oracle? In the cookie decryption, Exchange uses an exception to catch the Padding Error, and because of the exception, the program returned immediately so that error code number is <code class="language-plaintext highlighter-rouge">0</code>, which means <code class="language-plaintext highlighter-rouge">None</code>:</p>

<blockquote>
  <p>Location: /OWA/logon.aspx?url=…&amp;reason=0</p>
</blockquote>

<p>In contrast with the Padding Error, if the decryption is good, Exchange will continue the authentication process and try to login with the corrupted username and password. At this moment, the result must be a failure and the error code number is <code class="language-plaintext highlighter-rouge">2</code>, which represents <code class="language-plaintext highlighter-rouge">InvalidCredntials</code>:</p>

<blockquote>
  <p>Location: /OWA/logon.aspx?url=…&amp;reason=2</p>
</blockquote>

<p>The diagram looks like:</p>

<p><img src="/assets/img/blog/20210806/2/4.png" alt="" /></p>

<p>With the difference, we now have an Oracle to identify whether the decryption process is successful or not.</p>

<p><strong>HttpProxy\FbaModule.cs</strong></p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">ParseCadataCookies</span><span class="p">(</span><span class="n">HttpApplication</span> <span class="n">httpApplication</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HttpContext</span> <span class="n">context</span> <span class="p">=</span> <span class="n">httpApplication</span><span class="p">.</span><span class="n">Context</span><span class="p">;</span>
    <span class="n">HttpRequest</span> <span class="n">request</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">;</span>
    <span class="n">HttpResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">;</span>
    
    <span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Cookies</span><span class="p">[</span><span class="s">"cadata"</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>    
    <span class="kt">string</span> <span class="n">text2</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Cookies</span><span class="p">[</span><span class="s">"cadataKey"</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>    
    <span class="kt">string</span> <span class="n">text3</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Cookies</span><span class="p">[</span><span class="s">"cadataIV"</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>    
    <span class="kt">string</span> <span class="n">text4</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Cookies</span><span class="p">[</span><span class="s">"cadataSig"</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>    
    <span class="kt">string</span> <span class="n">text5</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Cookies</span><span class="p">[</span><span class="s">"cadataTTL"</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
    
    <span class="c1">// ...</span>
    <span class="n">RSACryptoServiceProvider</span> <span class="n">rsacryptoServiceProvider</span> <span class="p">=</span> <span class="p">(</span><span class="n">x509Certificate</span><span class="p">.</span><span class="n">PrivateKey</span> <span class="k">as</span> <span class="n">RSACryptoServiceProvider</span><span class="p">);</span>
    
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">array2</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">rgb2</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">FromBase64String</span><span class="p">(</span><span class="n">text2</span><span class="p">);</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">rgb3</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">FromBase64String</span><span class="p">(</span><span class="n">text3</span><span class="p">);</span>
    <span class="n">array</span> <span class="p">=</span> <span class="n">rsacryptoServiceProvider</span><span class="p">.</span><span class="nf">Decrypt</span><span class="p">(</span><span class="n">rgb2</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
    <span class="n">array2</span> <span class="p">=</span> <span class="n">rsacryptoServiceProvider</span><span class="p">.</span><span class="nf">Decrypt</span><span class="p">(</span><span class="n">rgb3</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
    
    <span class="c1">// ...</span>
    
    <span class="k">using</span> <span class="p">(</span><span class="n">AesCryptoServiceProvider</span> <span class="n">aesCryptoServiceProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AesCryptoServiceProvider</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">aesCryptoServiceProvider</span><span class="p">.</span><span class="n">Key</span> <span class="p">=</span> <span class="n">array</span><span class="p">;</span>
        <span class="n">aesCryptoServiceProvider</span><span class="p">.</span><span class="n">IV</span> <span class="p">=</span> <span class="n">array2</span><span class="p">;</span>
        
        <span class="k">using</span> <span class="p">(</span><span class="n">ICryptoTransform</span> <span class="n">cryptoTransform2</span> <span class="p">=</span> <span class="n">aesCryptoServiceProvider</span><span class="p">.</span><span class="nf">CreateDecryptor</span><span class="p">())</span> <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes2</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">array5</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">FromBase64String</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
                <span class="n">bytes2</span> <span class="p">=</span> <span class="n">cryptoTransform2</span><span class="p">.</span><span class="nf">TransformFinalBlock</span><span class="p">(</span><span class="n">array5</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">array5</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">CryptographicException</span> <span class="n">ex8</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ExTraceGlobals</span><span class="p">.</span><span class="n">VerboseTracer</span><span class="p">.</span><span class="nf">IsTraceEnabled</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">ExTraceGlobals</span><span class="p">.</span><span class="n">VerboseTracer</span><span class="p">.</span><span class="n">TraceDebug</span><span class="p">&lt;</span><span class="n">CryptographicException</span><span class="p">&gt;((</span><span class="kt">long</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="nf">GetHashCode</span><span class="p">(),</span> <span class="s">"[FbaModule::ParseCadataCookies] Received CryptographicException {0} transforming auth"</span><span class="p">,</span> <span class="n">ex8</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">httpApplication</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">AppendToLog</span><span class="p">(</span><span class="s">"&amp;CryptoError=PossibleSSLCertrolloverMismatch"</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">FormatException</span> <span class="n">ex9</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ExTraceGlobals</span><span class="p">.</span><span class="n">VerboseTracer</span><span class="p">.</span><span class="nf">IsTraceEnabled</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">ExTraceGlobals</span><span class="p">.</span><span class="n">VerboseTracer</span><span class="p">.</span><span class="n">TraceDebug</span><span class="p">&lt;</span><span class="n">FormatException</span><span class="p">&gt;((</span><span class="kt">long</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="nf">GetHashCode</span><span class="p">(),</span> <span class="s">"[FbaModule::ParseCadataCookies] Received FormatException {0} decoding caData auth"</span><span class="p">,</span> <span class="n">ex9</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">httpApplication</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">AppendToLog</span><span class="p">(</span><span class="s">"&amp;DecodeError=InvalidCaDataAuthCookie"</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kt">string</span> <span class="n">@string</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">Unicode</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">bytes2</span><span class="p">);</span>
            <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">"Authorization"</span><span class="p">]</span> <span class="p">=</span> <span class="n">@string</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It should be noted that since the IV is encrypted with the SSL certificate private key, we can’t recover the first block of the ciphertext through XOR. But it wouldn’t cause any problem for us because the C# internally processes the strings as UTF-16, so the first 12 bytes of the ciphertext must be <code class="language-plaintext highlighter-rouge">B\x00a\x00s\x00i\x00c\x00 \x00</code>. With one more Base64 encoding applied, we will only lose the first 1.5 bytes in the username field.</p>

<blockquote>
  <p>(16−6×2) ÷ 2 × (3/4) = 1.5</p>
</blockquote>

<h1 id="the-exploit">The Exploit</h1>

<p>As of now, we have a Padding Oracle that allows us to decrypt any user’s cookie. BUT, how can we get the client cookies? Here we find another vulnerability to chain them together.</p>

<h2 id="xss-to-steal-client-cookies">XSS to Steal Client Cookies</h2>

<p>We discover an XSS (CVE-2021-31195) in the CAS Frontend (Yeah, CAS again) to chain together, the root cause of this XSS is relatively easy: Exchange forgets to sanitize the data before printing it out so that we can use the <code class="language-plaintext highlighter-rouge">\</code> to escape from the JSON format and inject arbitrary JavaScript code.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://exchange/owa/auth/frowny.aspx
?app=people
&amp;et=ServerError
&amp;esrc=MasterPage
&amp;te=\
&amp;refurl=}}};alert(document.domain)//
</code></pre></div></div>

<p><img src="/assets/img/blog/20210806/2/5.png" alt="" /></p>

<p>But here comes another question: all the sensitive cookies are protected by the HttpOnly flag, which makes us unable to access the cookies by JavaScript. WHAT SHOULD WE DO?</p>

<h2 id="bypass-the-httponly">Bypass the HttpOnly</h2>

<p>As we could execute arbitrary JavaScript on browsers, why don’t we just insert the SSRF cookie we used in ProxyLogon? Once we add this cookie and assign the Backend target value as our malicious server, Exchange will become a proxy between the victims and us. We can then take over all the client’s HTTP static resources and get the protected HttpOnly cookies!</p>

<p><img src="/assets/img/blog/20210806/2/6.png" alt="" /></p>

<p>By chaining bugs together, we have an elegant exploit that can steal any user’s cookies by just sending him/her a malicious link. What’s noteworthy is that the XSS here is only helping us to steal the cookie, which means all the decryption processes wouldn’t require any authentication and user interaction. Even if the user closes the browser, it wouldn’t affect our Padding Oracle Attack!</p>

<p>Here is the <a href="https://www.youtube.com/watch?v=VuJvmJZxogc">demonstration video</a> showing how we recover the victim’s password:</p>

<div style="text-align: center;"><iframe width="560" height="315" src="https://www.youtube.com/embed/VuJvmJZxogc" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>

<!-- # The Timeline

* -->

                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/en/blog/author/orange">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/orange.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/en/blog/author/orange">
                            <h3>Orange Tsai</h3>
                        </a>
                        <span>Principal Security Researcher</span>
                        <p>
                            I am Orange : )
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/en/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Services</h6>
        <ul>
            <li><a href="/en/services/red-team/">Red Team Assessment</a></li>
            <li><a href="/en/services/penetration-test/">Penetration Testing</a></li>
            <li><a href="/en/services/security-consulting/">Security Consulting</a></li>
            <li><a href="/en/services/security-training/">Security Training</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Research</h6>
        <ul>
            <li><a href="/en/research/overview/">Overview</a></li>
            <li><a href="/en/research/awards/">Competitions and Awards</a></li>
            <li><a href="/en/research/bug-bounty/">Enterprise Vulnerability Reports</a></li>
            <li><a href="/en/research/talks/">International Conferences</a></li>
            <li><a href="/en/research/cve/">CVE List</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Company</h6>
        <ul>
            <li><a href="/en/company/about/">Company Overview</a></li>
            <li><a href="/en/company/our-team/">Team Members</a></li>
            <li><a href="/en/company/history/">Achievements</a></li>
            <li><a href="/en/company/csr/">Corporate Social Responsibility</a></li>
            <li><a href="/en/company/jobs/">Job Opportunities</a></li>
            <li><a href="/en/contact/">Contact</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">News</h6>
        <ul>
            <li><a href="/en/blog/">Blog</a></li>
            <li><a href="/en/media-kit/">Media Resources</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2024 DEVCORE <b class="line-block">All rights reserved.</b></span>
            <span><a href="/en/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>










