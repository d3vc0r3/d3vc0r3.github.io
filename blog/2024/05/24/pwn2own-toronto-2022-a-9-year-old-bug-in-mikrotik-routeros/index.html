

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>Pwn2Own Toronto 2022 : A 9-year-old bug in MikroTik RouterOS | DEVCORE 戴夫寇爾</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="DEVCORE 研究組在 Pwn2Own Toronto 2022 白帽駭客競賽期間，在 MikroTik 的路由器產品中，發現了存在九年之久的 WAN 端弱點，透過串連 Canon printer 的弱點，DEVCORE 成為史上第一個在 Pwn2Own 賽事中成功挑戰 SOHO Smashup 項目的隊伍；最終 DEVCORE 在 Pwn2Own Toronto 2022 奪下冠軍，並獲頒破解大師（Master of Pwn）的稱號。" />
    <meta name="keywords" content="CVE-2023-32154, Pwn2Own, MikroTik RouterOS" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="Pwn2Own Toronto 2022 : A 9-year-old bug in MikroTik RouterOS | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2024/05/24/pwn2own-toronto-2022-a-9-year-old-bug-in-mikrotik-routeros/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20240524/cover.png" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Pwn2Own Toronto 2022 : A 9-year-old bug in MikroTik RouterOS | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="DEVCORE 研究組在 Pwn2Own Toronto 2022 白帽駭客競賽期間，在 MikroTik 的路由器產品中，發現了存在九年之久的 WAN 端弱點，透過串連 Canon printer 的弱點，DEVCORE 成為史上第一個在 Pwn2Own 賽事中成功挑戰 SOHO Smashup 項目的隊伍；最終 DEVCORE 在 Pwn2Own Toronto 2022 奪下冠軍，並獲頒破解大師（Master of Pwn）的稱號。">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20240524/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2024/05/24/pwn2own-toronto-2022-a-9-year-old-bug-in-mikrotik-routeros/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body>
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>服務<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    紅隊演練
                                </h2>
                                <p class="two-line">
                                    在不影響企業營運前提下，無所不用其極，從各種進入點執行模擬入侵攻擊，達成企業指定的演練情境。
                                </p>
                            </div>
                        </a>
                        <a href="/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    滲透測試
                                </h2>
                                <p class="two-line">
                                    以駭客思維及手法嘗試入侵企業指定系統，找出潛在漏洞，驗證企業資料與設備是否可被竊取或破壞。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    資安顧問服務
                                </h2>
                                <p class="two-line">
                                    以紅隊演練為基礎，提供攻擊者視角與可能入侵路徑，協助企業評估資安資源優先順序，並擬定長期防禦策略。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    資安教育訓練
                                </h2>
                                <p class="two-line">
                                    從攻擊思維出發，協助企業有效預防資安事故並防禦；以及事件發生時，如何快速判定攻擊目的、手法、漏洞與及應變方式。
                                </p>
                            </div>
                        </a>
                        <a href="https://training.devco.re/" target="_blank">
                            <div class="item">
                                <h2>
                                    <i class="icon menu offsec"></i>
                                    OffSec 駭客技術課程 <i class="icon open-in-new"></i>
                                </h2>
                                <p class="two-line">
                                    攜手全球網路安全培訓及認證商 OffSec，透過 Live Training 原廠講師實體授課及線上課程的結構化學習資源，讓資安人員的網路安全攻擊技術與時俱進。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>研究<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    總覽概要
                                </h2>
                                <p class="two-line">
                                    持續精研資安最新技術及漏洞研究趨勢，全方位檢測企業產品安全性、吸取經驗並轉化為紅隊演練工具與手法。
                                </p>
                            </div>
                        </a>
                        <a href="/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    競賽與獎項
                                </h2>
                                <p class="two-line">
                                    國際級資訊安全競賽獎項肯定。
                                </p>
                            </div>
                        </a>
                        <a href="/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    企業漏洞回報
                                </h2>
                                <p class="two-line">
                                    研究企業系統中的資安風險及各種可能的突破口，並通報企業修補。
                                </p>
                            </div>
                        </a>
                        <a href="/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    國際研討會
                                </h2>
                                <p class="two-line">
                                    參與全球資安盛會，發表、交流漏洞的知識與資訊。
                                </p>
                            </div>
                        </a>
                        <a href="/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE 漏洞列表
                                </h2>
                                <p class="two-line">
                                    挖掘並回報國際知名產品與服務的重大漏洞。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>公司<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                公司簡介
                            </h2>
                            <p>
                                DEVCORE 戴夫寇爾由世界級白帽駭客團隊創立，提供紅隊演練、滲透測試、資安顧問服務、資安教育訓練等服務。
                            </p>
                        </div>
                        </a>
                        <a href="/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    團隊成員
                                </h2>
                                <p class="two-line">
                                    由熱衷挑戰、具備駭客思維的資安專家組成，專注於創新攻擊手法研究，並以「高道德、高自律、高嚴謹」為最高指導原則。
                                </p>
                            </div>
                        </a>
                        <a href="/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    成就與沿革
                                </h2>
                                <p class="two-line">
                                    長期聚焦於攻擊研究，屢屢獲邀參與全球知名資安研討會，已揭露數百個重要產品漏洞、協助企業提升防禦能量。
                                </p>
                            </div>
                        </a>
                        <a href="/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    企業社會責任
                                </h2>
                                <p class="two-line">
                                    提供多元實習管道和研習計畫，提升新世代人才資安能量，推廣資訊安全意識。
                                </p>
                            </div>
                        </a>
                        <a href="/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    工作機會
                                </h2>
                                <p class="two-line">
                                    加入 DEVCORE，共同改善資安產業結構，與我們一起打造更安全的世界。
                                </p>
                            </div>
                        </a>
                        <a href="https://conf.devco.re/" target="_blank">
                            <div class="item">
                                <h2>
                                    <i class="icon menu conference"></i>
                                    攻擊導向技術研討會 <i class="icon open-in-new"></i>
                                </h2>
                                <p class="two-line">
                                    由 DEVCORE 舉辦的技術研討會，聚焦於技術並由駭客視角出發，帶您探索創新的攻擊技術與手法，從攻擊思考防禦的策略。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>新聞<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    DEVCORE 最新消息。
                                </p>
                            </div>
                        </a>
                        <a href="/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    媒體素材下載
                                </h2>
                                <p>
                                    使用 DEVCORE 商標須遵循的使用規範。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/search/">搜尋</a>
            </li>
            <li>
                <a class="menuLable" href="/contact/">聯絡我們</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>服務</span>
                <div class="menuItem">
                    <a href="/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                紅隊演練
                            </h2>
                        </div>
                    </a>
                    <a href="/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                滲透測試
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                顧問服務
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                教育訓練
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>資安研究</span>
                <div class="menuItem">
                    <a href="/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>總覽概要</h2>
                        </div>
                    </a>
                    <a href="/research/awards/">
                        <div class="item">
                            <h2>競賽與獎項</h2>
                        </div>
                    </a>
                    <a href="/research/bug-bounty/">
                        <div class="item">
                            <h2>Bug Bounty</h2>
                        </div>
                    </a>
                    <a href="/research/talks/">
                        <div class="item">
                            <h2>國際研討會</h2>
                        </div>
                    </a>
                    <a href="/research/cve/">
                        <div class="item">
                            <h2>CVE 漏洞列表</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>公司</span>
                <div class="menuItem">
                    <a href="/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>公司簡介</h2>
                        </div>
                    </a>
                    <a href="/company/our-team/">
                        <div class="item">
                            <h2>團隊成員</h2>
                        </div>
                    </a>
                    <a href="/company/history/">
                        <div class="item">
                            <h2>成就與沿革</h2>
                        </div>
                    </a>
                    <a href="/company/csr/">
                        <div class="item">
                            <h2>企業社會責任</h2>
                        </div>
                    </a>
                    <a href="/company/jobs/">
                        <div class="item">
                            <h2>工作機會</h2>
                        </div>
                    </a>
                    <a href="https://conf.devco.re/" target="_blank">
                        <div class="item">
                            <h2>DEVCORE CONFERENCE</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>新聞</span>
                <div class="menuItem">
                    <!-- <a href="/blog/">
                    <div class="item">
                        <h2>所有文章</h2>
                    </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>案例剖析</h2>
                        </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>科普文章</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>技術專欄</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>資安新聞</h2>
                        </div>
                    </a> -->
                    <a href="/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/media-kit/">
                        <div class="item">
                            <h2>媒體素材下載</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                搜尋
                            </h2>
                        </div>
                    </a>
                    <a href="/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                聯絡我們
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/blog/">所有文章</a>
                </li>
                <li>
                    <a href="/blog/category/最新消息/">最新消息</a>
                </li>
                <li>
                    <a href="/blog/category/技術專欄/">技術專欄</a>
                </li>
                <li>
                    <a href="/blog/category/科普文章/">科普文章</a>
                </li>
                <li>
                    <a href="/blog/category/資安新聞/">資安新聞</a>
                </li>
                <li>
                    <a href="/blog/category/學生相關計劃/">學生相關計劃</a>
                </li>
                <li>
                    <a href="/media-kit/">媒體素材下載</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                    <span class="tag">

                      <a href="/blog/tag/CVE/">#CVE</a> <a href="/blog/tag/Pwn2Own/">#Pwn2Own</a> <a href="/blog/tag/RCE/">#RCE</a> <a href="/blog/tag/IoT/">#IoT</a> 
                    </span>
                    <h1>
                        Pwn2Own Toronto 2022 : A 9-year-old bug in MikroTik RouterOS
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/blog/author/terrynini">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/nini.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/blog/author/terrynini">Terrynini</a></span>
                        <span class="date">2024-05-24</span>
                    </div>
                    
                    
                    <div class="article_img">
                        <img src="https://devco.re/assets/img/blog/20240524/cover.png"/>
                    </div>
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<p><a href="/blog/2024/05/24/pwn2own-toronto-2022-a-9-year-old-bug-in-mikrotik-routeros-en/">English Version</a>, <a href="/blog/2024/05/24/pwn2own-toronto-2022-a-9-year-old-bug-in-mikrotik-routeros/">中文版本</a></p>

<h2 id="tldr">TL;DR</h2>

<p>DEVCORE 研究組在 Pwn2Own Toronto 2022 白帽駭客競賽期間，透過研究過去少有人注意到的攻擊面，在 MikroTik 旗下路由器產品所使用的 RouterOS 作業系統中，發現了存在九年之久的 WAN 端弱點，透過串連該弱點與另一個同樣由 DEVCORE 發現的 Canon printer 弱點，DEVCORE 成為史上第一個在 Pwn2Own 賽事中成功挑戰 SOHO Smashup 項目的隊伍；最終 DEVCORE 在 Pwn2Own Toronto 2022 奪下冠軍，並獲頒破解大師（Master of Pwn）的稱號。</p>

<p>該 WAN 端弱點發生在 RouterOS 中的 radvd 程式，由於該程式在處理 IPv6 SLAAC 的 ICMPv6 封包時，未對 RDNSS 欄位的長度進行檢查，導致攻擊者可透過發送兩次 Router Advertisement 封包觸發緩衝區溢位攻擊，使得攻擊者可在不需登入且無需使用者互動的情況下控制路由器底層的 Linux 系統進行高權限操作，取得路由器的完整控制權；此弱點被登記為 CVE-2023-32154，其 CVSS 分數為 7.5。</p>

<p>針對上述弱點， DEVCORE 已於 2022/12/29 經由 <a href="https://www.zerodayinitiative.com/advisories/ZDI-23-710/">ZDI</a> 回報 MikroTik 處理，並在 2023/05/19 完成修補，以下 RouterOS 版本已經對此弱點進行修補：</p>
<ul>
  <li>Long-term Release 6.48.7</li>
  <li>Stable Release 6.49.8</li>
  <li>Stable Release 7.10</li>
  <li>Testing Release 7.10rc6</li>
</ul>

<h2 id="pwn2own-與-soho-smashup-簡介">Pwn2Own 與 SOHO Smashup 簡介</h2>

<p>Pwn2Own 是一系列由趨勢科技的 Zero Day Initiative（ZDI）主辦的比賽，每場賽事都會針對該次主題挑選一些熱門的產品作為目標，例如：作業系統、瀏覽器、電動車、工控系統、路由器、印表機、智慧音箱、手機、NAS、網路攝影機……等等。只要參賽隊伍可以在無需使用者互動、設備處於預設狀態、軟體更新至最新版本的條件下，演示攻擊並成功獲得設備的主控權，就可以獲得相應的 Master of Pwn 點數和獎金。賽末結算時，Master of Pwn 點數最高的隊伍就是冠軍，也被稱為破解大師（Master of Pwn）。</p>

<p>前幾年由於疫情的關係，Work From Home 或是 SOHO（即小型辦公／家庭辦公）變得非常普遍，因此 2022 的 Pwn2Own  Toronto 也新增了一個稱作 SOHO Smashup 的特別項目，參賽者需要從 WAN 端入侵路由器後，再將路由器作為跳板攻擊居家常見的設備，例如：智慧音響、印表機等設備。</p>

<p>這個特別的新項目，除了獎金是所有項目中第二高的 $100,000（USD）之外，得分也是最高的十分，因此如果目標是奪冠，奪下這個項目絕對是如虎添翼！DEVCORE 在本次賽事中也特別挑選較少人研究的 MikroTik 作為目標，避免與他人找到重複的漏洞（與其他人撞洞時，獎金與得分皆減半），最大化奪冠的機率。</p>

<h2 id="routeros-簡介">RouterOS 簡介</h2>

<p>MikroTik 開發的 RouterOS 是一套基於 Linux 核心的作業系統，也是 MikroTik 旗下產品 「RouterBoard」上預設安裝的作業系統，RouterOS 亦可被安裝在個人電腦上，用來將電腦作為路由器使用。</p>

<p>雖然基於 Linux 核心開發的 RouterOS 確實有使用 GPL 授權的開源軟體，但如果想要得到相關的程式碼，根據官方網站 <a href="https://web.archive.org/web/20220603140018/https://mikrotik.com/downloadterms.html">downloadterms</a> 的說明，需要匯 45 塊美金給 MikroTik ，他們才會寄給你一張燒好 GPL source 的光碟，非常有趣的想法！幸好已經有人將 MikroTik 的 <a href="https://github.com/robimarko/routeros-GPL">GPL source</a>上傳到 Github，但在檢視過後，我們認為裡面的程式碼對於後續分析沒有太大的幫助。</p>

<h3 id="routeros-v7-與-routeros-v6">RouterOS v7 與 RouterOS v6</h3>

<p>在 MikroTik 官網的下載頁面上同時存在 RouterOS v7 以及 RouterOS v6 兩個版本，兩者之間的關係比較像是 RouterOS 的不同 branch，在設計上大同小異。因為我們的目標設備 RouterBoard RB2011UiAS-IN 預設安裝的是 RouterOS v6，所以我們先以 RouterOS v6 作為研究對象。</p>

<p><img src="/assets/img/blog/20240524/1.png" alt="" /></p>

<p>RouterOS 並沒有正式提供一個方法讓使用者直接管理底層的 Linux 系統，使用者被關在一個功能受限的 console 裡面，只能使用 RouterOS 提供的有限指令去管理這台路由器。因此過去有不少研究是關於如何 jailbreak RouterOS。</p>

<p><img src="/assets/img/blog/20240524/2.png" alt="" /></p>

<p>RouterOS 上的 binary 之間使用一種 MikroTik 自製的 IPC 進行溝通，此 IPC 利用稱為 nova message 的資料結構在各程式間交換資訊，因此我們將這類 binary 統一稱作 nova binary。</p>

<p>另外，RouterOS 還存在一個比較特別的攻擊面。在日常應用中，使用者可以透過 WinBox 這套 GUI 管理工具在 Windows 電腦上對 RouterOS 進行遠端管理，其原理是透過 TCP 向路由器傳送 nova message。因此若 RouterOS 沒有針對 nova message 做好權限驗證時，攻擊者就有機會自遠端發送一個夾帶惡意 nova message 的 TCP 封包入侵路由器；不過 WinBox 預設僅能從 LAN 端使用，對我們來說不是優先事項，因為這次的目標是從 WAN 端進行攻擊！</p>

<p><img src="/assets/img/blog/20240524/3.png" alt="" /></p>

<h2 id="cve-回顧">CVE 回顧</h2>

<p>首先，為了熟悉 RouterOS 的攻擊面，我們全面審視了過去的 CVE。當時與 RouterOS 有關的 CVE 總共有 80 個，而當中可被用來在 pre-auth 情境下進行攻擊，且目標是路由器本身的共有 28 個 。</p>

<p><img src="/assets/img/blog/20240524/4.png" alt="" /></p>

<p>28 個 CVE 當中有 4 個 CVE 的使用情境是較符合 Pwn2Own 規則所描述的情境，這些 CVE 可以讓攻擊者在不需使用者互動的情況下在路由器上喚起一個 shell 或登入為 admin。這 4 個漏洞當中，有 3 個是在 2017 年至 2019 年這段時間被發現的，而且當中 3 個是「in the wild」而不是第一時間經由白帽駭客主動通報，這四個漏洞分別是：</p>

<ul>
  <li>CVE-2017-20149：又稱 Chimay-Red，是 2017 年從 CIA 外洩的武器庫「Vault 7」中，針對 RouterOS 進行攻擊的漏洞之一。漏洞發生在 RouterOS 解析 HTTP 請求時，若 HTTP headers 中的 Content-Length 是負值，會造成 Integer Underflow，搭配 Stack Clash 的攻擊手法就能控制程式流程達成 RCE。</li>
  <li><a href="https://medium.com/@maxi./finding-and-exploiting-cve-2018-7445-f3103f163cc1">CVE-2018-7445</a>：是一個存在於 RouterOS 自己實做的 SMB 中的 buffer overflow。這是透過黑箱模糊測試找到的漏洞，也是四個漏洞中唯一一個由發現者自行回報的漏洞，一樣能夠控制程式執行流程最後達成 RCE，但 SMB 不是預設開啟的服務。</li>
  <li>CVE-2018-14847：也是「Vault 7」中針對 RouterOS 進行攻擊的漏洞之一。這個漏洞使攻擊者可以不需登入就讀取任意檔案，乍聽之下好像不是大問題，但由於在 RouterOS 的早期版本中，使用者的密碼是以 <code class="language-plaintext highlighter-rouge">password xor md5(username + "283i4jfkai3389")</code> 的方式儲存在檔案中，所以只要能夠讀取這個檔案，攻擊者就可以逆算得到 admin 的密碼。</li>
  <li><a href="https://teamt5.org/en/posts/vulnerability-mikrotik-cve-2021-41987/">CVE-2021-41987</a>：在 SCEP 服務的 base64 解碼過程中，因為長度計算錯誤導致的 heap buffer overflow 漏洞，這是資安研究員分析了 APT 在其 C2 server 上的 exploit 後反推出來的漏洞。</li>
</ul>

<p>可以發現，這些漏洞大多是「in the wild」，我們無從得知當初發現漏洞的人是如何進行分析及思考。因此關於分析 RouterOS 的思路或是技巧，透過這些漏洞能學習到的十分有限。</p>

<h2 id="相關研究回顧">相關研究回顧</h2>

<p>我們繼續研讀公開的研究資料，在比賽的當下我們有這些文章以及演講可以參考：</p>

<ul>
  <li>2017
    <ul>
      <li><a href="https://kirils.org/slides/2017-08-06_prez_SHA_MT_pub.pdf">Kirils. Rooting the MikroTik routers</a>
        <ul>
          <li>主要關於 jailbreak</li>
        </ul>
      </li>
      <li><a href="https://kirils.org/slides/2017-09-15_prez_15_MT_Balccon_pub.pdf">Kirils. A deeper journey into MikroTik routers</a>
        <ul>
          <li>主要關於 jailbreak</li>
        </ul>
      </li>
      <li><a href="https://kirils.org/slides/2017-10-21_MT_Hacktivity_pub.pdf">Kirils. Tools for effortless reverse engineering of MikroTik routers</a>
        <ul>
          <li>主要關於 jailbreak</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>2018
    <ul>
      <li><a href="https://github.com/tenable/routeros">Jacob Baines. Bug Hunting in RouterOS</a>
        <ul>
          <li>探討 IPC 中的 nova message 的運作</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>2019
    <ul>
      <li><a href="https://medium.com/tenable-techblog/make-it-rain-with-mikrotik-c90705459bc6">Jacob Baines. Make It Rain with MikroTik</a>
        <ul>
          <li>與 2018 的演講內容相同</li>
        </ul>
      </li>
      <li><a href="https://medium.com/tenable-techblog/mikrotik-firewall-nat-bypass-b8d46398bf24">Jacob Baines. MikroTik Firewall &amp; NAT Bypass</a>
        <ul>
          <li>當時的 WinBox 存在一個弱點：當暴露在外網時，可以被用來對內網進行掃描</li>
        </ul>
      </li>
      <li><a href="https://medium.com/@maxi./finding-and-exploiting-cve-2018-7445-f3103f163cc1">Maximiliano Vidal, Juan Caillava. Finding and exploiting CVE-2018–7445</a>
        <ul>
          <li>透過黑箱模糊測試找到 SMB 中的 Buffer Overflow 以及完整 exploit 方法</li>
        </ul>
      </li>
      <li><a href="https://mum.mikrotik.com/presentations/ID18/presentation_6149_1540240927.pdf">Tomas Kirnak. Deep-dive: MikroTik exploits - a security analysis</a>
        <ul>
          <li>討論 CIA 武器庫「Vault 7」外洩後所造成的大規模利用事件</li>
        </ul>
      </li>
      <li><a href="https://media.defcon.org/DEF%20CON%2027/DEF%20CON%2027%20presentations/DEFCON-27-Jacob-Baines-Help-Me-Vulnerabilities.-Youre-My-Only-Hope.pdf">Jacob Baines. Help Me Vulnerabilities You’re My Only Hope</a>
        <ul>
          <li>釋出一套協助使用者 jailbreak RouterOS 的工具，讓使用者有能力檢查自己的機器是否在大規模利用事件中被入侵</li>
        </ul>
      </li>
      <li><a href="https://medium.com/tenable-techblog/routeros-chain-to-root-f4e0b07c0b21">Jacob Baines. RouterOS: Chain to Root</a>
        <ul>
          <li>如何透過串連 DNS poisoning 弱點及降版弱點拿到 shell</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>2022
    <ul>
      <li><a href="https://teamt5.org/en/posts/vulnerability-mikrotik-cve-2021-41987/">D39. Vulnerability Exposure &amp; Notification on Mikrotik (CVE-2021-41987)</a>
        <ul>
          <li>在 APT 的 C2 server 上發現一個利用 RouterOS 0-day 的武器，透過分析找到漏洞的成因</li>
        </ul>
      </li>
      <li><a href="https://margin.re/2022/06/pulling-mikrotik-into-the-limelight/">Ian Dupont, Harrison Green. Pulling MikroTik into the Limelight</a>
        <ul>
          <li>更詳細地闡述了 RouterOS 的 IPC 機制，並且釋出一套稱作 FOISted 的 jailbreak 工具協助研究員在 amd64 版本的 RouterOS 上進行近一步的研究</li>
        </ul>
      </li>
      <li><a href="https://powerofcommunity.net/poc2022/QianChen.pdf">Qian Chen. MikroTik RouterOS Security: The Forgotten IPC Message</a>
        <ul>
          <li>透過模糊測試在 IPC 中挖掘漏洞</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="ipc-與-nova-message-回顧">IPC 與 Nova Message 回顧</h2>

<p>可以發現上述的研究大部分都離不開 RouterOS 的自製 IPC，所以我們也簡單的對其機制進行了回顧。 這裡使用一個簡單的例子對 IPC 進行說明。</p>

<p>日常使用場景中，使用者可以透過 telnet 登入至 RouterOS，並使用 conolse 對路由器進行管理。
<img src="/assets/img/blog/20240524/5.png" alt="" /></p>

<p>讓我們拆解整個流程中 IPC 參與的部分：</p>

<ol>
  <li>當使用者欲透過 telnet 存取 RouterOS 的 console 時，<code class="language-plaintext highlighter-rouge">telnet</code> process 會使用 <code class="language-plaintext highlighter-rouge">execl</code> 去執行 <code class="language-plaintext highlighter-rouge">login</code> 這個程式，並向使用者索取帳號及密碼。
<img src="/assets/img/blog/20240524/6.png" alt="" /></li>
  <li>當使用者送出帳號密碼之後，<code class="language-plaintext highlighter-rouge">login</code> process 會將帳號密碼放進 nova message 中，發送至 <code class="language-plaintext highlighter-rouge">user</code> process 請求驗證
<img src="/assets/img/blog/20240524/7.png" alt="" /></li>
  <li><code class="language-plaintext highlighter-rouge">user</code> process 完成驗證後，透過 nova message 通知驗證的結果
<img src="/assets/img/blog/20240524/8.png" alt="" /></li>
  <li>如果登入成功就會喚起 <code class="language-plaintext highlighter-rouge">console</code> process，接下來使用者與 <code class="language-plaintext highlighter-rouge">console</code> 互動的過程都是透過 <code class="language-plaintext highlighter-rouge">login</code> process 轉發</li>
</ol>

<h3 id="ipc-簡介">IPC 簡介</h3>

<p>上面的例子簡單地描述了 IPC 的基本概念，但兩個 process 間的溝通實際上更加複雜。首先，每個送往其他程式的 nova message 都會先透過 socket 被送往 <code class="language-plaintext highlighter-rouge">loader</code>，接著 <code class="language-plaintext highlighter-rouge">loader</code> 才根據 message 內容把 message 分派給對應的 nova binary。</p>

<p>讓我們舉一個簡單的例子來說明：假設 <code class="language-plaintext highlighter-rouge">login</code> process 的 id 是 1039；<code class="language-plaintext highlighter-rouge">user</code> process 的 id 是 13，且 <code class="language-plaintext highlighter-rouge">user</code> process 中負責驗證帳號密碼的是 id 為 4 的 handler。 則在登入驗證流程中，<code class="language-plaintext highlighter-rouge">login</code> process 首先會送一個包含帳號密碼的請求給 <code class="language-plaintext highlighter-rouge">user</code> process，這時的 <code class="language-plaintext highlighter-rouge">SYS_TO</code> 是一個包含兩個元素的陣列：<code class="language-plaintext highlighter-rouge">[13, 4]</code> ，表示要把 message 送給 binary id 為 13 的 process 中 id 為 4 的 handler。</p>

<p><img src="/assets/img/blog/20240524/9.png" alt="" /></p>

<p>當 <code class="language-plaintext highlighter-rouge">loader</code> 收到 message 後，它會先移除 message 內 <code class="language-plaintext highlighter-rouge">SYS_TO</code> 中代表目標 binary id 的 13，並在 SYS_FROM 中增加來源 binary 的 id，也就是 1039，之後把 message 傳送給 <code class="language-plaintext highlighter-rouge">user</code> process。</p>

<p><img src="/assets/img/blog/20240524/10.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">user</code> process 收到 message 後也會做類似的事情，將<code class="language-plaintext highlighter-rouge">SYS_TO</code> 中代表目標 handler id 的 4 移除後，接著把 nova message 送至 handler 4 進行處理，最終由 handler 4 執行驗證的邏輯。</p>

<p><img src="/assets/img/blog/20240524/11.png" alt="" /></p>

<h3 id="nova-message-簡介">Nova Message 簡介</h3>

<p>而上述 IPC 中使用的 nova message 是由 <code class="language-plaintext highlighter-rouge">nv::message</code> 及相關的 function 進行初始化與設定。Nova message 實際上是由具有型別的 key-value pair 構成，且 key 只能是整數，所以 <code class="language-plaintext highlighter-rouge">SYS_TO</code> 及 <code class="language-plaintext highlighter-rouge">SYS_FROM</code> 等 key 只是單純的 macro 罷了。而 nova message 中可以使用的型別包括 u32, u64, bool, string, bytes, IP 及 nova message （也就是可以建立巢狀的 nova message）。</p>

<p><img src="/assets/img/blog/20240524/12.png" alt="" /></p>

<p>因為 RouterOS 已不用 JSON 來傳遞 nova message，所以我們只針對 binary 格式進行說明。在 IPC 溝通過程中，收方的 socket 首先會收到一個表達當前 nova message 長度的整數，之後接著 binary 格式的 nova message。
<img src="/assets/img/blog/20240524/13.png" alt="" /></p>

<p>Nova message 的開頭是兩個 magic bytes：<code class="language-plaintext highlighter-rouge">M2</code>。接下來，每個 key 都使用 4 bytes 來描述；其中，前 3 bytes 用來表達 key 的 id，最後一個 byte 是 key 的型別。根據型別，會以不同解析方式將緊接在後的 bytes 取出作為 data，取完 data 之後，後面緊接著的便是下一個 key，如此循環下去。當中比較特別的是 bool 型別，因為 bool 可以僅用一個 bit 表示，nova message 便直接使用 type 的最低一位 bit 來表示 True/False，更詳細的格式可以參考 <a href="https://margin.re/2022/06/pulling-mikrotik-into-the-limelight/">Ian Dupont, Harrison Green. Pulling MikroTik into the Limelight</a>：
<img src="/assets/img/blog/20240524/14.png" alt="" /></p>

<h3 id="x3-format">x3 format</h3>

<p>為了瞭解 nova message 中 <code class="language-plaintext highlighter-rouge">SYS_TO</code> 及 <code class="language-plaintext highlighter-rouge">SYS_FROM</code> 的 id 具體是指哪一個 nova binary，我們需要解析一種副檔名為 x3 的檔案，它是 binary 格式的 xml。在撰寫工具解析  <code class="language-plaintext highlighter-rouge">/nova/etc/loader/system.x3</code> 後，我們便可得知每個 id 所對應的是哪個 nova binary，例如在下圖中，<code class="language-plaintext highlighter-rouge">/nova/bin/log</code> 的 id 就是 3。</p>

<p><img src="/assets/img/blog/20240524/15.png" alt="" /></p>

<p>但有些 binary 的 id 並不在這個檔案當中，是因為該 binary 可能是透過安裝 MikroTik 官方提供的 package 之後才有的功能，此時 binary 的 id 就會存在於 <code class="language-plaintext highlighter-rouge">/ram/pckg/&lt;package_name&gt;/nova/etc/loader/&lt;package_name&gt;.x3</code> 當中，<code class="language-plaintext highlighter-rouge">radvd</code> 就是一例。
<img src="/assets/img/blog/20240524/16.png" alt="" /></p>

<p>儘管如此，依舊有些 binary id 是無法在任何 .x3 檔案中找到的，因為這類型的 process 並不是持久存在，例如：只有使用者嘗試登入時才會被喚起的 <code class="language-plaintext highlighter-rouge">login</code> process，這類 process 就以流水號作為 id。</p>

<p>另外，.x3 檔案也被用來記錄 nova binary 的相關設定，例如 <code class="language-plaintext highlighter-rouge">www</code> 就在 .x3 中指定每個 URI 應該使用哪一個 servlet 來進行處理。
<img src="/assets/img/blog/20240524/17.png" alt="" /></p>

<h2 id="小結">小結</h2>

<p>經由回顧了過去的研究及 CVE，可以發現大多我們感興趣的漏洞都集中在過去的一段時間內，近期似乎很難在 RouterOS 的 WAN 端找到 pre-auth 的漏洞。 且雖然這期間持續有漏洞被揭露，但可以發現 MikroTik 變得越來越安全。MikroTik 上真的已經不存在 pre-auth 的漏洞了嗎？或許單純只是所有人都把什麼東西漏看了？</p>

<p>前面提及的公開研究，可以簡單分成下面三類：</p>
<ul>
  <li>越獄（Jailbreaking）</li>
  <li>分析在野的 exploit</li>
  <li>研究 IPC 中的 nova message</li>
</ul>

<p>然而在逆向 RouterOS 上的 binary 一段時間之後，我們發現整個系統的複雜度不僅於此，但卻沒什麼人提及相關細節。因此有了以下的感想：「沒有任何理智正常的人想要花時間逆向 nova binary」。</p>

<p>除了從 CIA 及 APT 取得的 exploit 之外，大部分在 RouterOS 上尋找漏洞的研究不外乎是 Fuzzing 網路協議、玩弄 nova message 或是針對 nova message 進行模糊測試。從成果來看，攻擊者對於 RouterOS 的理解似乎高過我們很多，我們需要探索更多關於 nova binary 的細節來彌補差距，才有機會找到我們想要找的漏洞。雖然我們並不反對 fuzzing 這個手法，但若要在這場比賽中取得優勢，我們就必須確定所有細節都被親眼看過。</p>

<h2 id="從何開始">從何開始</h2>

<p>我們不認為 RouterOS 已經完美無暇，而且不難發現研究員與攻擊者對於 RouterOS 的理解存在著差距。所以，要在 RouterOS 上找到 pre-auth RCE 我們還缺少什麼？</p>

<p>首先我們想到的第一個問題是：IPC 的入口點在哪裡，它又通往哪裡？大部分透過 IPC 觸發的功能都需要進行登入，所以可以預期到：拘泥於 IPC，只會找到更多 post-auth 的弱點。且 IPC 不過只是 RouterOS 上用來實作主要功能的其中一個環節，我們更想直接、謹慎的觀察每個功能的核心程式碼。</p>

<p>舉例來說：負責處理 DHCP 的 process 是如何從一個 DHCP 封包中擷取需要的資訊？這些資訊可能直接被存在該 process 中，或可能需要透過 IPC 送給其他 process 做進一步處理。
<img src="/assets/img/blog/20240524/18.png" alt="" /></p>

<h3 id="nova-binary-的架構">Nova Binary 的架構</h3>

<p>因此我們必須先認識 nova binary 的架構，每個 nova binary 中都有一個 Looper（或其衍生類別：MultifiberLooper），Looper 是負責執行 event loop 邏輯的一個類別，每次迭代都會呼叫 <code class="language-plaintext highlighter-rouge">runTimer</code> 來執行時間到了的 timer ，以及呼叫 <code class="language-plaintext highlighter-rouge">poll</code> 去檢查 socket 的狀態並做相對應的處理。</p>

<p><img src="/assets/img/blog/20240524/19.png" alt="" /></p>

<p>Looper 也負責自己所在的 nova binary 與 loader 之間的溝通，Looper 首先會先會針對當前 binary 與 loader 之間的 unix socket 註冊一個特別的 callback function：<code class="language-plaintext highlighter-rouge">onMsgSock</code>，這個函式負責把從 socket 收到的 nova message 分配給 nova binary 中對應的 handler。</p>

<p><img src="/assets/img/blog/20240524/20.png" alt="" /></p>

<h3 id="handler-類別與其衍生類">Handler 類別與其衍生類</h3>

<p>當 Looper 收到一個 nova message 時，它會將之分派給對應的 handler。例如，<code class="language-plaintext highlighter-rouge">SYS_TO</code> 為 <code class="language-plaintext highlighter-rouge">[14, 0]</code> 的訊息會被 loader 分配給 binary id 為 14 的 nova binary，而 binary id 為 14 的 binary 中的 looper 收到時，<code class="language-plaintext highlighter-rouge">SYS_TO</code> 已經剩下 <code class="language-plaintext highlighter-rouge">[0]</code>，因此 looper 會將其分配給 handler 0 進行處理。如果一開始的 nova message 中 <code class="language-plaintext highlighter-rouge">SYS_TO</code> 為 <code class="language-plaintext highlighter-rouge">[14]</code>，則 looper 收到時 <code class="language-plaintext highlighter-rouge">SYS_TO</code> 為 <code class="language-plaintext highlighter-rouge">[]</code>，這種情境將由 Looper 自行處理。</p>

<p><img src="/assets/img/blog/20240524/21.png" alt="" /></p>

<p>現在讓我們假設，Looper 收到了一個由 handler 1 負責的 nova message，並分配給 handler 1，在收到 message 後，handler 1 會去呼叫 Handler 類別中的 <code class="language-plaintext highlighter-rouge">nv::Handler::handleCmd</code>，這個函式會根據 nova message 中的 <code class="language-plaintext highlighter-rouge">SYS_CMD</code> 在 vtable 中尋找對應的 function 執行。</p>

<p>除了常規的功能之外，vtable 中的 <code class="language-plaintext highlighter-rouge">cmdUnknown</code> 常被開發者 override 用以擴充功能，但有時開發者反而是 override <code class="language-plaintext highlighter-rouge">handleCmd</code>，看起來是全依 MikroTik 開發者的心情而定。而 Handler 類別因為是基礎類別，所以 object 相關的指令並沒有被實作。</p>

<p><img src="/assets/img/blog/20240524/22.png" alt="" /></p>

<h3 id="衍生類別">衍生類別</h3>

<p>然而 nova binary 中使用最多的並不是基本的 Handler 類別，而是其衍生類別。 衍生類別可以用來儲存多個單一型別物件，類似 C++ 的 STL 容器。</p>

<p>舉例來說，當使用者透過 web panel 的管理介面建立一個 DHCP server 的時候，會送出一個指令為「add object」的 nova message 到 <code class="language-plaintext highlighter-rouge">dhcp</code> process 的 handler 0，接下來 handler 0 會產生一個 dhcp server 物件記錄相關設定，並且該物件會被保存在 handler 0 內部的一個 tree 當中。</p>

<p><img src="/assets/img/blog/20240524/23.png" alt="" /></p>

<p>這裡的 handler 0 就是一個 <code class="language-plaintext highlighter-rouge">AMap</code> 的 instance，<code class="language-plaintext highlighter-rouge">AMap</code> 即是 <code class="language-plaintext highlighter-rouge">Handler</code> 的一個衍生類別。 且由於指令是「add object」，所以觸發了 <code class="language-plaintext highlighter-rouge">AMap::cmdAddObj</code> 這個成員函式，這個成員函式會去呼叫 handler 0 的 vtable 中位於 offset 0x7c 位置所指向的一個 function，這個 function 實際上就是 <code class="language-plaintext highlighter-rouge">AMap</code> 中包含的物件的建構式，例如，若開發者在宣告 handler 0 時，其類型為 <code class="language-plaintext highlighter-rouge">AMap&lt;string&gt;</code> ，則 offset 0x7c 的位置所指向的 function 就是 <code class="language-plaintext highlighter-rouge">string</code> 的建構式。</p>

<p>每個衍生類別儲存內部物件建構式的 function 在 vtable 上的 offset 都不相同，想要找到衍生類別中物件的建構子，可以透過逆向它們個別的 <code class="language-plaintext highlighter-rouge">cmdAddObj</code> 來找到。</p>

<h3 id="ipc和-ipc-以外的">IPC，和 IPC 以外的</h3>

<p>儘管 IPC 似乎無處不在，但其實 RouterOS 中有許多功能並不以 IPC 實現。以實作在 <code class="language-plaintext highlighter-rouge">discover</code> 程式中的兩個 layer 2 的發現協議：CDP、LLDP 為例：</p>
<ol>
  <li>在開啟這兩個服務時，<code class="language-plaintext highlighter-rouge">discover</code> 中的 handler 0 會負責去呼叫 <code class="language-plaintext highlighter-rouge">nv::createPacketReceiver</code> 來開啟 CDP 及 LLDP 使用的 socket 並且註冊分別對應的 callback function</li>
  <li>在 Looper 的每次迭代中，程式會透過 poll 來檢查 CDP 及 LLDP socket 是否有收到封包</li>
  <li>如果發現有收到封包就會呼叫對應的 callback function 去進行處理</li>
</ol>

<p><img src="/assets/img/blog/20240524/24.png" alt="" /></p>

<p>CDP 的 callback 做的事情也非常簡單：確定收到封包的 interface 是允許存取的，如果正確，就解析封包並直接把資訊直接存入 <code class="language-plaintext highlighter-rouge">nv::ASecMap</code> 接著就直接結束，過程中並不使用 nova message。</p>

<p><img src="/assets/img/blog/20240524/25.png" alt="" /></p>

<p>在此類情境中，IPC 除了用來開啟 CDP 或 LLDP 服務之外（預設開啟），完全無法觸發 CDP 或是 LLDP 的任何功能，因此以往專注於 IPC 的研究就很有可能沒有檢測到這種實作方式的程式邏輯。</p>

<h2 id="pre-auth-rce-的故事">Pre-Auth RCE 的故事</h2>

<p>對於 RouterOS 的理解，也伴隨著一次驚喜的意外帶領我們找到深藏已久的漏洞。</p>

<p>賽前某一天，我們照常為了在 RouterOS 上進行逆向及除錯而插拔網路線時，發現 log file 紀錄到 <code class="language-plaintext highlighter-rouge">radvd</code> 這隻程式已經 crash 了好幾次！所以我們嘗試插拔網路線來手動復現 crash 的發生，搭配 debugger 使用就能定位到出問題的地方，但經過了上千次的插拔，我們還是無法確定 crash 產生的條件，只能任憑 crash 隨機的發生。</p>

<p>經過一段時間的掙扎後，我們停止透過這種盲目的嘗試來定位漏洞，轉而利用靜態逆向分析 <code class="language-plaintext highlighter-rouge">radvd</code> 來尋找 crash 產生的位置，雖然最後依舊沒找到造成 crash 的根因，但受益於我們對於 nova binary 的理解，我們在 <code class="language-plaintext highlighter-rouge">radvd</code> 中找到了另外一個可以利用的漏洞。</p>

<p>在介紹這個漏洞之前，必須得先介紹一下 <code class="language-plaintext highlighter-rouge">radvd</code>  process 究竟是負責什麼功能的程式。</p>

<h3 id="slaac-stateless-address-auto-configuration-">SLAAC (Stateless Address Auto-Configuration )</h3>

<p>一言以蔽之，<code class="language-plaintext highlighter-rouge">radvd</code> 是一個負責處理 IPv6 的 SLAAC 的服務。</p>

<p>在 SLAAC 環境中，假設一台電腦想要取得一個 IPv6 的地址上網，他首先會向所有 router 廣播一個 RS（Router Solicitation）的請求。 在 Router 收到 RS 之後，就會透過 RA（Router Advertisement）將 network prefix 廣播出去；收到 RA 的電腦便可以拿 network prefix 以及 EUI-64 來自行決定自己用來連網的 IPv6 為何。</p>

<p><img src="/assets/img/blog/20240524/26.png" alt="" /></p>

<p>若 ISP 或是網管，想把一個網段分配給用戶，讓用戶可自行分配地址給用戶管理的機器，在只使用 SLAAC 而不輔以 DHCP 時，如何分配一個網段給使用者？因為 SLAAC 並沒有辦法直接委派，所以通常會是這麼運作的：</p>

<p>假設有一個 upstream router：Router A，它屬於 ISP 或網管、還有一台用戶自行管理的 Router B、一台用戶管理的電腦。ISP 或網管會預先透過 email 通知用戶一個分配給用戶使用的 /48 network preifx，這裡假設是 <code class="language-plaintext highlighter-rouge">2001:db8::/48</code>。用戶可以將之設定在 Router B 上，則當電腦向 Router B 發送 RS 時，Router B 就會把這個 prefix 放入 RA 中回傳，而這個 prefix 稱作 routed prefix。</p>

<p><img src="/assets/img/blog/20240524/27.png" alt="" /></p>

<p>同時為了讓使用者的 Router B 有辦法與 Router A 溝通，它也需要一個自己的 IPv6 地址，這時 Router B 從 Router A 拿到的 network prefix 就稱作 link prefix。</p>

<p><img src="/assets/img/blog/20240524/28.png" alt="" /></p>

<h3 id="radvd-的執行流程">radvd 的執行流程</h3>

<ol>
  <li><code class="language-plaintext highlighter-rouge">radvd</code> process 被啟動時，會透過 <code class="language-plaintext highlighter-rouge">nv::ThinRunner::addSocket</code> 來開啟 <code class="language-plaintext highlighter-rouge">radvd</code> 使用的 socket 並且註冊對應的 callback function
<img src="/assets/img/blog/20240524/29.png" alt="" /></li>
  <li>
    <p>在 <code class="language-plaintext highlighter-rouge">Looper</code> 的每次迭代中會透過 poll 檢查 socket 是否有收到封包
<img src="/assets/img/blog/20240524/30.png" alt="" /></p>
  </li>
  <li>如果發現有收到封包就會呼叫對應的 callback function 去進行處理
<img src="/assets/img/blog/20240524/31.png" alt="" /></li>
</ol>

<p>在 <code class="language-plaintext highlighter-rouge">radvd</code> 的 callback 中，它首先檢查封包是否是合法的 RA 或 RS，是 RA 就把資訊存起來；是 RS 就開始往 LAN 廣播 RA。</p>

<p>而總共有三種情況 RouterOS 會往 LAN 廣播 prefix：</p>
<ol>
  <li>從 LAN 收到 RS 封包</li>
  <li>從 WAN 收到 RA 封包</li>
  <li>定時在 LAN 廣播 RA 封包（預設隨機在 200~600 秒之後廣播一次）</li>
</ol>

<p>不過在 callback 中我們沒有馬上透過靜態分析找到 case 2 發送 RA 的地方，當時我們還不確定具體原因。後來發現這部分的行為與 RouterOS IPC 中的訂閱機制有關，我們將會在後面的章節進行解釋，這同時也與我們發現的 race condition 相關。不過另外兩個情況我們到是可以直接透過靜態分析找到。</p>

<p>在 case 1 中，當從 LAN 收到 RS 時，<code class="language-plaintext highlighter-rouge">radvd</code> 會呼叫 sendRA 來廣播 RA 封包：
<img src="/assets/img/blog/20240524/32.png" alt="" /></p>

<p>在 case 2 中，handler 1 在初始化後便會去註冊一個 timer，<code class="language-plaintext highlighter-rouge">RAroutine</code>：
<img src="/assets/img/blog/20240524/33.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">RAroutine</code> 被用來在每隔一段時間去呼叫 sendRA 來廣播封包：
<img src="/assets/img/blog/20240524/34.png" alt="" /></p>

<h2 id="cve-2023-32154">CVE-2023-32154</h2>

<p>可以發現共同的函式就是 <code class="language-plaintext highlighter-rouge">sendRA</code>，在深入分析 <code class="language-plaintext highlighter-rouge">sendRA</code> 之後，我們發現 <code class="language-plaintext highlighter-rouge">radvd</code> 在處理 DNS advisory 的地方存在弱點。</p>

<p>首先，<code class="language-plaintext highlighter-rouge">radvd</code> 會將 upstream 收到的 RA 中的 DNS advisory 儲存起來（使用 tree 作為資料結構），當 router 要往 LAN 廣播 RA 時，這些 DNS 也會被包進 RA 中一起被廣播給 LAN 的機器。在 <code class="language-plaintext highlighter-rouge">radvd</code> 中，是 <code class="language-plaintext highlighter-rouge">addDNS</code> 這個 function 將樹狀結構的 DNS 展開後放進 ICMPv6 的封包當中。用來傳遞給 <code class="language-plaintext highlighter-rouge">addDNS</code> 的第一個參數 <code class="language-plaintext highlighter-rouge">RA_raw</code> 是一個 4096 bytes 的 buffer，也就是最終被送出的 ICMPv6。</p>

<p><img src="/assets/img/blog/20240524/35.png" alt="" /></p>

<p>跟進 <code class="language-plaintext highlighter-rouge">addDNS</code> 後我們馬上可以發現這裡可能存在一個 stack buffer overflow 的弱點，<code class="language-plaintext highlighter-rouge">addDNS</code> 透過 <code class="language-plaintext highlighter-rouge">memcpy</code> 把 DNS 放進 ICMPv6 封包中而且沒有任何 boundary check，只要 DNS advisory 給的夠多就可以觸發 stack buffer overflow。</p>

<p><img src="/assets/img/blog/20240524/36.png" alt="" /></p>

<p>這裡使用的 DNS 來自於 RA 封包中的 RDNSS 欄位，但根據 RFC 可以發現，用來描述 RDNSS 長度的欄位只有 8-bit，所以最多僅能覆蓋 255*16 bytes，這個長度並無法使我們覆寫到 return address。</p>

<p><img src="/assets/img/blog/20240524/37.png" alt="" /></p>

<p>但如果這不是 <code class="language-plaintext highlighter-rouge">radvd</code> 第一次收到 RA，<code class="language-plaintext highlighter-rouge">radvd</code> 就需要在接下來的封包中將舊的 DNS 標為 expired，所以實際上我們可以覆蓋兩倍的長度，也就是 255*16*2 bytes，這就足以讓我們覆蓋到 return address 了。</p>

<p><img src="/assets/img/blog/20240524/38.png" alt="" /></p>

<h2 id="攻擊流程">攻擊流程</h2>

<p>有了上述的弱點，我們只要透過往目標 RouterOS 送兩個 RDNSS 欄位長度為 255 的惡意 RA 封包，就可以利用 RDNSS 中的 IPv6 地址來控制 <code class="language-plaintext highlighter-rouge">radvd</code> 程式的執行流程。</p>

<p><img src="/assets/img/blog/20240524/39.png" alt="" /></p>

<h3 id="保護">保護</h3>

<p>由於 RouterOS 使用 MIPS 的架構，所以 CPU 並不支援 NX ，但除此之外的保護也沒有被開啟。
所以只要找到好用的 ROP gadget 讓執行流程最終 jump 到我們放在 stack 上的 shellcode 就行了，聽起來極度簡單。</p>

<p><img src="/assets/img/blog/20240524/40.png" alt="" /></p>

<h3 id="shellcode-限制">shellcode 限制</h3>

<p>但是在構造 exploit 的過程中其實存在不少限制，例如，因為 IPv6 地址被儲存在 tree 結構中，所以會在排序後才放上 stack，因此我們必須保證我們建構的 payload 在經過排序之後還會是我們一開始構造的 shellcode。</p>

<p>最簡單的方法是把 IPv6 的 prefix 當作流水號，這樣可以保證我們構造的內容照順序排列，接者只要透過 ROP gadget 跳到後半段的 shellcode 上面就算完成了。而在撰寫 shellcode 時，我們只要把每個地址的 suffix 都構造成 <code class="language-plaintext highlighter-rouge">jump</code> ，用來跳過無法執行的流水號即可。</p>

<p><img src="/assets/img/blog/20240524/41.png" alt="" /></p>

<p>但由於 MIPS 存在 delay slot 機制的關係，CPU 實際上會先去執行 <code class="language-plaintext highlighter-rouge">jump</code> 指令的後一條指令。</p>

<p><img src="/assets/img/blog/20240524/42.png" alt="" /></p>

<p>所以我們必須把 <code class="language-plaintext highlighter-rouge">jump</code> 往前移動才行，但緊接著的問題便是：在 delay slot 中不能使用 <code class="language-plaintext highlighter-rouge">syscall</code> 這個指令。這種情境下，payload 構造起來相當麻煩之外，還可能會超過我們可以使用的長度，因此這從一開始就是個壞主意。</p>

<p><img src="/assets/img/blog/20240524/43.png" alt="" /></p>

<p>然而眼尖的朋友肯定已經發現了，這其實是 CTF 中常見的初學等級題目，只要讓 prefix 是一個合法且不影響執行結果的指令就好了，我們把 prefix 改成 <code class="language-plaintext highlighter-rouge">addi s8, s0, 1</code>, <code class="language-plaintext highlighter-rouge">addi s8, s0, 2</code>, <code class="language-plaintext highlighter-rouge">addi s8, s0, 3</code>……，以此類推。除了 payload 會照排序排好之外，也節省了本來用來放 <code class="language-plaintext highlighter-rouge">jump</code> 指令的空間。</p>

<p><img src="/assets/img/blog/20240524/44.png" alt="" /></p>

<p>但我們還需要稍微修改一下 payload 才行，因為我們沒有 leak stack 位址的漏洞，加上我們找不到任何可用的 gadget 來把 stack 位址從 <code class="language-plaintext highlighter-rouge">$sp</code> 暫存器搬到 <code class="language-plaintext highlighter-rouge">$t9</code> 暫存器，所以我們這裡做的事情是：首先，透過 ROP gadget 把 <code class="language-plaintext highlighter-rouge">jalr $sp</code> 指令寫到一塊記憶體上，之後再用一個 ROP gadget 跳上去執行它，這樣就可以將執行流程導向我們構造的 shellcode，聽起來是一片光明的未來：
<img src="/assets/img/blog/20240524/45.png" alt="" /></p>

<p>但光是這樣是無法順利執行 shellcode 的，因為 MIPS 針對記憶體的存取方式有兩個不同的 cache。</p>

<h3 id="cache">cache</h3>

<p>MIPS 上存在兩個 cache：I-cache（instruction cache）、D-cache（data cache）。</p>

<p>當我們把 <code class="language-plaintext highlighter-rouge">jslr $sp</code> 指令寫上記憶體時，實際上是寫到 D-cache 中。</p>

<p><img src="/assets/img/blog/20240524/46.png" alt="" /></p>

<p>而當我們接著把執行流程控制到 <code class="language-plaintext highlighter-rouge">jslr $sp</code> 的地址時，處理器會先去檢查這個地址的指令有沒有在 I-cache 當中，因為該位址位於 data section，在正常執行流程中肯定沒有被執行過，所以 cache 永遠都會 miss，因此處理器會接著將 memory 的內容載入 I-cache 當中。</p>

<p><img src="/assets/img/blog/20240524/47.png" alt="" /></p>

<p>此時因為 D-cache 的內容還沒有被更新到 memory 上，I-cache 只會抓到一堆 null bytes，也就是 MIPS 上的 nop，所以程式只會執行一堆毫無意義的 nop 直到 crash 為止。</p>

<p><img src="/assets/img/blog/20240524/48.png" alt="" /></p>

<p>在這裡我們需要使處理器將 D-cache 的內容寫回 memory，有兩個方法可以做到這件事情：context switch 或是用盡 D-cache 所有空間（32 KB）。觸發 context switch 是比較簡單的做法，但在 <code class="language-plaintext highlighter-rouge">radvd</code> 中並沒有任何 <code class="language-plaintext highlighter-rouge">sleep</code> 讓我們用來觸發 context switch，其他 function 雖然也會陷進 kernel，但 context switch 發生的機率並不高，為了角逐 Pwn2Own 冠軍，讓攻擊達到趨近 100% 成功的穩定度是必須的，因此我們轉而尋找耗盡 D-cache 的 32kb 容量的方法。</p>

<p>首先，透過簡單的檢查可以發現 RouterOS 的 <code class="language-plaintext highlighter-rouge">radomize_va_space</code> 變數是 1，表示 heap 的記憶體位址不是隨機的，因此不需要 leak 就可以知道 heap 所在位址，所以我們只要接著想辦法讓 heap 分配足夠大的空間，然後寫一些無關緊要的東西上去就可以耗盡 32kb 的 D-cache 了！不過 <code class="language-plaintext highlighter-rouge">radvd</code> 中並沒有太多好用的 ROP gadget，所以要構造這樣的 payload 需要串連更多 ROP gadget 才能達到同樣的目的，最終 payload 長度可能會超過我們可以覆蓋的長度。</p>

<p><img src="/assets/img/blog/20240524/49.png" alt="" /></p>

<p>幸運的是如同前面所說，DNS 被存放在 tree 結構中，所以儲存時就已經在 heap 中佔據一大塊記憶體，透過 gdb 逐步執行，我們可以確定在處理 DNS 時，heap 的空間已經比 32kb 還要大！因此我們只要接著透過 GOT hijack 呼叫 memcpy 往 heap 寫 32kb 的垃圾就可以了！</p>

<p><img src="/assets/img/blog/20240524/50.png" alt="" /></p>

<p>最後我們的 exploit 就完成了：</p>

<p><img src="/assets/img/blog/20240524/51.png" alt="" /></p>

<p>結合我們另外一個為了 Pwn2Own 找的 Canon printer 弱點，攻擊流程會是</p>

<ol>
  <li>攻擊者作為 router 的壞鄰居，對它發送惡意的 ICMPv6 封包</li>
  <li>在成功控制 router 後，我們進行 port forwarding，把 payload 導向在 LAN 的 Canon 印表機。</li>
</ol>

<p><img src="/assets/img/blog/20240524/52.png" alt="" /></p>

<p>在 Pwn2Own 的比賽環境中，網路環境可以被簡化得更簡單一點，如下：
<img src="/assets/img/blog/20240524/53.png" alt="" /></p>

<h2 id="exploit-除錯過程">Exploit 除錯過程</h2>

<p>就在我們覺得 $100,000 的獎金已經到手的時候，不可思議的事情發生了，那就是我們的攻擊只要在 Ubuntu 上執行就會失敗，不管這個 Ubuntu 系統是在 MacOS 內的一台虛擬機器又或者是一台 Ubuntu 實機；而 Pwn2Own 官方，基本上是使用 Ubuntu 來執行我們的 exploit，所以我們必須要解決這個問題。</p>

<p><img src="/assets/img/blog/20240524/54.png" alt="" /></p>

<p>我們嘗試在 MacOS 上執行 exploit 並且紀錄網路封包，然後在 Ubuntu 上重放流量，可以觀察到重放會失敗：</p>

<p><img src="/assets/img/blog/20240524/55.png" alt="" /></p>

<p>我們也嘗試在 Ubuntu 上執行 exploit 並且記錄網路封包，當然在 Ubuntu 上是失敗的，但當我們在 MacOS 重放失敗的流量時，他竟然成功了：</p>

<p><img src="/assets/img/blog/20240524/56.png" alt="" /></p>

<p>到這裡我們猜測可能是其中一個 OS 在送出封包之前會對封包進行重新排序，而重新排序的這個行為或許在 wireshark 擷取到封包之後，所以才沒被 wireshark 紀錄到。因此我們直接寫了一個 sniffer 放在 router 上面來監控流量，且因為 <code class="language-plaintext highlighter-rouge">AF_PACKET</code> 類型的 socket 不會被防火牆規則影響，結果應該要非常可靠：
<img src="/assets/img/blog/20240524/57.png" alt="" /></p>

<p>然而，從兩邊錄到的封包根本<strong>一模一樣</strong>……</p>

<p>所以，exploit 目前只在我的 MacOS 上成功過，如果狀況不解決，唯一的方法就是我帶著我的 Mac 筆電飛去多倫多，在現場用我自己的筆電進行攻擊。但我們不可能放著這個成因不明的問題不管，誰知道會不會在比賽中也發生在我的筆電上，如果真的發生那就虧大了。</p>

<p><img src="/assets/img/blog/20240524/58.png" alt="" /></p>

<p>在經過幾次謹慎的復盤之後我們終於知道問題的成因了——速度。因為兩個 RA 封包送出時間間隔並不大，所以很難在 wireshark 的時間軸上直接看出來，但如果計算一下會發現，兩個所花費的時間其實<strong>相差了 390 倍</strong>。所以問題也不是出在 Ubuntu 上，而是因為 Mac 送兩個封包送的太快，不小心觸發了存在在 radvd 中的 race condition（加上極度懶惰的我沒有好好計算蓋到 return address 要花多少 bytes，直接在上面寫滿垃圾然後做 pattern match 而已，所以這個 offset 只在 race 的情況下才正確）。</p>

<p><img src="/assets/img/blog/20240524/59.png" alt="" /></p>

<p>解決方法就是在送出兩個 RA 封包之間 sleep 一下，並把 payload 中的 offset 修復成沒有 race 的情況下觀察到的 offset，就可以穩定我們的攻擊腳本，把成功機率提升到 100%。</p>

<h3 id="fix">Fix</h3>

<p>這個漏洞在以下版本中已經被修復：</p>
<ul>
  <li>Long-term Release 6.48.7</li>
  <li>Stable Release 6.49.8, 7.10</li>
  <li>Testing Release 7.10rc6</li>
</ul>

<p>同時我們也發現這個漏洞從 RouterOS v6.0 就已經存在了，從官網可以發現 6.0 的發布日期是 2013-05-20，也就是說這個漏洞已經存在在那裡<strong>九年之久</strong>，卻沒有人發現他。</p>

<p><img src="/assets/img/blog/20240524/60.png" alt="" /></p>

<p>呼應到我們一開始的想法：「沒有任何理智正常的人想要花時間逆向 nova binary」，得證。</p>

<h2 id="the-race-condition">The race condition</h2>

<p>然而這個妨礙我們輕鬆賺取 $100,000 的 race condition 是怎麼發生的？如前面所述，nova binary 中有一個 Looper 循環檢查當前有什麼事件發生，也就是説這是一個 single thread 的程式，那 race condition 是怎麼回事？（有些 nova binary 是 multi-fiber，但 <code class="language-plaintext highlighter-rouge">radvd</code> 並不是）</p>

<p>這就要提到一個剛才沒有提到的細節，當 <code class="language-plaintext highlighter-rouge">radvd</code> 在解析從 WAN 收到的 RA 封包時，DNS 是被存入一個 「vector」 當中，然而在準備 LAN 廣播用的 RA 封包時，<code class="language-plaintext highlighter-rouge">addDNS</code> 卻是把一個儲存了 DNS 的 「tree」給展開，所以這個 vector 跟 tree 之間是什麼關係？又是怎麼轉換過去的？</p>

<p><img src="/assets/img/blog/20240524/61.png" alt="" /></p>

<p>這也是為什麼我們沒有第一時間就在 callback 裡面找到「從 WAN 收到 RA 就會往 LAN 廣播 RA 封包」的邏輯，因為這是由兩個 process 在一陣複雜的互動之後所產生的結果。</p>

<p>我們仔細看一下 callback 具體上做了什麼，可以看到有一個 array 負責用來存放一種叫做「 remote object」的物件，這段程式碼看起來很直觀，就是迭代存有 DNS 的 vector，然後為每個 DNS 地址都呼叫一次 <code class="language-plaintext highlighter-rouge">nv::roDNS</code>，並把函式的執行結果保存在 <code class="language-plaintext highlighter-rouge">DNS_remoteObject</code> vector 當中。</p>

<p><img src="/assets/img/blog/20240524/62.png" alt="" /></p>

<h3 id="remote-object">remote object</h3>

<p>所以什麼是 remote object？remote object 是 RouterOS 中用來跨 process 分享資源的一個機制：一個 process 負責保存共用資源，然後另外一個 prcoess 可以通過 id 向負責保存的 process 發送請求來進行增刪查改。 例如 DNS remote object 實際上放在 <code class="language-plaintext highlighter-rouge">resolver</code> process 中的 handler 2，而 <code class="language-plaintext highlighter-rouge">radvd</code> 的 handler 1 只是單純保有這些物件對應的 id 而已。</p>

<p><img src="/assets/img/blog/20240524/63.png" alt="" /></p>

<h3 id="subscription-and-notification">subscription and notification</h3>

<p>當一個 remote object 被更新時，有些 process 可能會想要做出對應的行為，所以 nova binary 可以透過 IPC 事先訂閱其他 nova binary 中的 remote object。以 <code class="language-plaintext highlighter-rouge">dhcp</code> 及 <code class="language-plaintext highlighter-rouge">ippool6</code> 為例，<code class="language-plaintext highlighter-rouge">ippool6</code> 中的 handler 1  負責管理 ipv6 address pool，<code class="language-plaintext highlighter-rouge">dchp</code> process 會去訂閱 <code class="language-plaintext highlighter-rouge">ippool6</code> 的 handler 1，所以當 ipv6 address pool 有異動時，dhcp 可以檢查需不需要針對這些異動進行進一步的處理，例如關閉某個 dhcp server。</p>

<p>訂閱的這個行為是透過發送一個指令為 subscribe 的 nova message 給想要訂閱的 binary，當中的 <code class="language-plaintext highlighter-rouge">SYS_NOTIFYCMD</code> 包含了具體想要被通知的狀況是什麼。
<img src="/assets/img/blog/20240524/64.png" alt="" /></p>

<p>所以在上述情況中，當有另外一個 process 往 <code class="language-plaintext highlighter-rouge">ippool6</code> 中增加 object 時，handler 1 的 <code class="language-plaintext highlighter-rouge">cmdAddObj</code> 函式會被執行。
<img src="/assets/img/blog/20240524/65.png" alt="" /></p>

<p>在大部分情況裡，<code class="language-plaintext highlighter-rouge">AddObj</code> 固定會去呼叫 <code class="language-plaintext highlighter-rouge">sendNotifies</code> 來通知那些有訂閱 0xfe000b 事件的 subscribers，告訴他們訂閱的物件已被改動，所以 <code class="language-plaintext highlighter-rouge">ippool6</code> 這裡會送一個 nova message 給 <code class="language-plaintext highlighter-rouge">dhcp</code> process，告知物件被改動後的結果。</p>

<p><img src="/assets/img/blog/20240524/66.png" alt="" /></p>

<p>在理解了訂閱機制之後，我們可以更全面的理解 <code class="language-plaintext highlighter-rouge">radvd</code> 與 <code class="language-plaintext highlighter-rouge">resolver</code> 之間的互動如下：</p>

<p>當 <code class="language-plaintext highlighter-rouge">radvd</code> 從 WAN 收到 RA 封包後，它會對每個 IPv6 地址呼叫 <code class="language-plaintext highlighter-rouge">roDNS</code> 來請 <code class="language-plaintext highlighter-rouge">resolver</code> 建立相關的 remote object。而 <code class="language-plaintext highlighter-rouge">resolver</code> 中的 handler 4 會負責處理這個請求，並在 handler 2 中建立對應的 ipv6 object，接著因為 <code class="language-plaintext highlighter-rouge">radvd</code> 的 handler 1 訂閱了 <code class="language-plaintext highlighter-rouge">resovler</code> 的 handler 2，所以 <code class="language-plaintext highlighter-rouge">resolver</code> 的 handler 2 把目前擁有的所有 DNS address 推播給 <code class="language-plaintext highlighter-rouge">radvd</code> 的 handler 1，接著 handler 1 就依照他收到的 DNS address 構造 RA 封包，之後在 LAN 廣播該封包。</p>

<p><img src="/assets/img/blog/20240524/67.png" alt="" /></p>

<h3 id="race-condition-成因">Race Condition 成因</h3>

<p>Race condition 的問題實際上出在 <code class="language-plaintext highlighter-rouge">roDNS</code> 的實作，<code class="language-plaintext highlighter-rouge">roDNS</code> 中使用 <code class="language-plaintext highlighter-rouge">postMessage</code> 來發送 nova message，而這個方法是 non-blocking 的，表示 <code class="language-plaintext highlighter-rouge">radvd</code> 中的 remote object 並不會馬上知道它在 <code class="language-plaintext highlighter-rouge">resolver</code> 中對應的 id 是什麼。</p>

<p><img src="/assets/img/blog/20240524/68.png" alt="" /></p>

<p>因此若第二個封包太快到達，以至於 <code class="language-plaintext highlighter-rouge">radvd</code> 還無從得知 remote object 的 id 是什麼的時候，<code class="language-plaintext highlighter-rouge">radvd</code> 就沒有辦法第一時間確實的刪除這些物件，只能先將它們標記成 destroyed 進行軟刪除，這就造成了 race condition 的產生。
<img src="/assets/img/blog/20240524/69.png" alt="" /></p>

<p>我們一步一步的分解整個流程：</p>

<p>首先，因為兩個 process 都是 single thread，我們可以假設 <code class="language-plaintext highlighter-rouge">radvd</code>、<code class="language-plaintext highlighter-rouge">resolver</code> 兩個 process 現在正在執行他們的第一個 loop。</p>

<p>當 <code class="language-plaintext highlighter-rouge">radvd</code> 從 WAN 收到一個只有一個 DNS address 的 RA 時，<code class="language-plaintext highlighter-rouge">radvd</code> 會向 <code class="language-plaintext highlighter-rouge">resolver</code> 發送一個創建 remote object 的請求。
<img src="/assets/img/blog/20240524/70.png" alt="" /></p>

<p>而 <code class="language-plaintext highlighter-rouge">resolver</code> 在收到第一個請求的同時會設定一個 timer，因爲在 IPC 的機制中，<code class="language-plaintext highlighter-rouge">resolver</code> 無法知道多少個 <code class="language-plaintext highlighter-rouge">AddObj</code> 請求屬於同一批，所以它非常簡單的設了一個一次性的 timer，時間到了才送出一次 notification。除此之外，每次 <code class="language-plaintext highlighter-rouge">resolver</code> 處理完單個創建的請求後應該要回傳一個 nova message 作為 response，通知 <code class="language-plaintext highlighter-rouge">radvd</code> 剛剛被新增的 remote object 的 id 是多少，而 <code class="language-plaintext highlighter-rouge">radvd</code> 會透過方才送出請求時一併註冊的一次性 ResponseHandler 來處理這個回應。</p>

<p><img src="/assets/img/blog/20240524/71.png" alt="" /></p>

<p>但如果第二個 RA 封包太快被送到，以至於 <code class="language-plaintext highlighter-rouge">resolver</code> 都還沒有把 id 透過 response 送回來時，<code class="language-plaintext highlighter-rouge">radvd</code> 只能先把舊的 DNS remote object 標記成 destroyed 進行軟刪除。</p>

<p><img src="/assets/img/blog/20240524/72.png" alt="" /></p>

<p>接著 <code class="language-plaintext highlighter-rouge">radvd</code> 繼續為收到的第二個 RA 封包中的 RDNSS 欄位建立新的 DNS remote object，但由於 <code class="language-plaintext highlighter-rouge">resolver</code> 還沒有結束第一個迭代，所以這個新的請求會停留在 socket 裡面等待下一個迭代才處理。</p>

<p><img src="/assets/img/blog/20240524/73.png" alt="" /></p>

<p>接下來回到 <code class="language-plaintext highlighter-rouge">resolver</code>，第一個迭代以回傳 id 給 <code class="language-plaintext highlighter-rouge">radvd</code> 做收尾，<code class="language-plaintext highlighter-rouge">radvd</code> 的 ResponseHandler 會根據拿到的 id 去更新 remote object，但由於對應的 remote object 已經被標記成刪除，所以 ResponseHandler 不會去更新 object id，而是直接刪除該 object。</p>

<p><img src="/assets/img/blog/20240524/74.png" alt="" /></p>

<p>ResponseHandler 在刪除完 <code class="language-plaintext highlighter-rouge">radvd</code> 中保存的 remote object 之後，會發送一個 delete object 的 message 給 <code class="language-plaintext highlighter-rouge">resolver</code>，告知它對應的 remote object 已經不再使用所以要進行刪除，但一樣會先卡在 socket 裡面等待處理</p>

<p><img src="/assets/img/blog/20240524/75.png" alt="" /></p>

<p>接著 <code class="language-plaintext highlighter-rouge">resolver</code> 進入了第二次迭代，它會先拿到 socket 中為了第二個 RA 創建 remote object 的請求，為第二個 RA 的 DNS 創建對應的 remote object：</p>

<p><img src="/assets/img/blog/20240524/76.png" alt="" /></p>

<p>但在接著處理 delete 請求之前，先前設定的 timer 時間到了，所以<code class="language-plaintext highlighter-rouge">resolver</code> 會呼叫 <code class="language-plaintext highlighter-rouge">nv::Handler::sendChanges</code> 來通知所有的訂閱者現在 resolver 知道的 DNS 有哪些，因為 object 1 還沒有被刪除，因此 resolver 會把兩次的請求創建的 DNS 通通都推播出去。</p>

<p>radvd 在收到這樣的資訊之後就會馬上構造用來在 LAN 廣播的 RA 封包，此時兩次的請求結果被混在一起了，這也就是為什麼一開始我們的攻擊只會在 MacOS 上成功的原因。雖然這個 race condition 聽起來很難觸發（刪除請求比 timer 先進行處理的話就不會觸發），但這是因為方便解釋，所以整個流程被我們大幅簡化了，實際上只要兩個封包到達的時間間隔夠短這個 race 就一定會成功。
<img src="/assets/img/blog/20240524/77.png" alt="" /></p>

<h3 id="小結-1">小結</h3>

<p>透過上面的分析，我們在 RouterOS 的 remote object 機制中找到了一個 race condition 的 pattern：</p>
<ul>
  <li>在新增/刪除 remote object 時，使用了 non-blocking 的方法</li>
  <li>有訂閱 remote object</li>
</ul>

<p>透過這類型的漏洞，攻擊者可以將兩次請求的結果混合成一個回傳，或許可以作為一個用來繞過某些安全性檢查的手法。如果順利找到可利用的漏洞，我們還可以用來參加 Pwn2Own 當中的 router  類別中的 LAN 項目。</p>

<p>然而最後時間緊迫，我們並沒有透過 race condition 找到可以利用的漏洞。而且禍不單行，在報名準備截止時，我們才發現這幾個月來被我們測試了上百次的 exploit 存在一些問題，就在報名截止的三個小時前像鬼打牆一樣，怎麼打怎麼失敗，簡直就是數位世代的逢魔時刻，我們一直更新 exploit 並且不斷更新準備上交的漏洞白皮書，一直到報名前止的半小時前（凌晨四點截止）才順利完成。</p>

<p>但是非常幸運的，我們在賽中僅嘗試一次就順利的完成了攻擊，成為 Pwn2Own 歷史上第一組完成 SOHO SMASHUP 這個新類別的隊伍：</p>

<p><img src="/assets/img/blog/20240524/78.png" alt="" /></p>

<p>我們在這個項目中獲得了 10 點 Master of Pwn 點數還有 $100,000 美金的獎金，最終在比賽結算時，DEVCORE 以 18.5 個 Master of Pwn 點數奪下冠軍。</p>

<p><img src="/assets/img/blog/20240524/79.png" alt="" /></p>

<p>冠軍除了獲得 Master of Pwn 的頭銜、獎杯、外套之外，照慣例，主辦方還會各寄一台我們打下的設備過來。</p>

<p>（我們沒辦法把所有東西都塞進相框裡）
<img src="/assets/img/blog/20240524/80.png" alt="" /></p>

<h2 id="結論">結論</h2>

<p>在本次研究中，我們對 RouterOS 進行了深入探討，進而揭露了一個潛藏在 RouterOS 內長達九年的安全漏洞，並成功利用該漏洞在 Pwn2Own Toronto 2022 的賽事中奪下 SOHO SMASHUP 的項目。此外，我們還在 IPC 中發現了一種導致 race condition 的行為模式。最後，我們也將賽事中使用的工具開源於 https://github.com/terrynini/routeros-tools ，供大家參考。</p>

<p>通過本次研究及分享，DEVCORE 希望分享我們的發現和經驗，從而協助白帽駭客深入了解 RouterOS，使之變得更加透明易懂。</p>

                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/blog/author/terrynini">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/nini.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/blog/author/terrynini">
                            <h3>Terrynini</h3>
                        </a>
                        <span>Security Researcher</span>
                        <p>
                            I’m NiNi, hunting the demons that lurk in your binary every day. <br>๛ฅ(=ˇωˇ=)ฅ
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

        <!-- 相關文章 -->
        <section class="recommand articles-list">
            <div class="container">
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/最新消息">最新消息</a>
                        <span class="tag">
    
                          <a href="/blog/tag/OffSec/">#OffSec</a> <a href="/blog/tag/Windows/">#Windows</a> <a href="/blog/tag/OSEE/">#OSEE</a> <a href="/blog/tag/LiveTraining/">#LiveTraining</a> 
                        </span>
                        <h2>
                            <a href="/blog/2025/07/12/finally-stepping-into-the-world-of-osee-after-five-years/">錯過五年，我終於踏進 OSEE 的世界</a> 
                        </h2>
                    
                    
                        <a class="author" href="/blog/author/angelboy">
                            <h3>Angelboy</h3>
                        </a>
                    
                        <span class="date">2025-07-12</span>
                        <p class="line-litmit-3">這邊主要是以平常有在碰 Windows 的人的角度出發。老實說，大約在 5 年前就對 OSEE 這張證照略有所聞，而當時也剛好開始學一些 Windows Pwn 的相關知識，出一些 CTF 題目給大家玩玩，順便增進 Windows 知識，當時也學了一些有關 Windows Kernel 的利用技巧，不過剛開時學時也處處碰壁，花了好一段時間才慢慢學會怎麼去好好搞一個 Windows Kernel Exploit。在得知有這張證照之後，便下定決心未來某一天一定要拿到這張證照。
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/最新消息">最新消息</a>
                        <span class="tag">
    
                          <a href="/blog/tag/OffSec/">#OffSec</a> <a href="/blog/tag/Windows/">#Windows</a> <a href="/blog/tag/OSEE/">#OSEE</a> <a href="/blog/tag/LiveTraining/">#LiveTraining</a> 
                        </span>
                        <h2>
                            <a href="/blog/2025/07/11/exp-401-course-and-second-exam-thoughts/">EXP-401 課程 && 第二次考試心得</a> 
                        </h2>
                    
                    
                        <a class="author" href="/blog/author/research">
                            <h3>DEVCORE Research Team</h3>
                        </a>
                    
                        <span class="date">2025-07-11</span>
                        <p class="line-litmit-3">EXP-401 (OSEE) 考試第二次挑戰心得公開！從 VMware 到 Windows Kernel，完整分享學習曲線、踩坑經驗、考試細節與重考流程。
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/學生相關計劃">學生相關計劃</a>
                        <span class="tag">
    
                          <a href="/blog/tag/公告/">#公告</a> <a href="/blog/tag/徵才/">#徵才</a> 
                        </span>
                        <h2>
                            <a href="/blog/2025/07/07/8th-internship-program-recruit/">DEVCORE 2025 第八屆實習生計畫</a> 
                        </h2>
                    
                    
                        <span class="date">2025-07-07</span>
                        <p class="line-litmit-3">DEVCORE 第八屆實習生計畫將於 2025 年 9 月正式登場，即日起開放報名！歡迎詳閱以下資訊並填寫報名表單，報名至 07/28 23:59 截止。
                        </p>
                    </div>
                </article>
              

            </div>
        </section>
    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">服務</h6>
        <ul>
            <li><a href="/services/red-team/">紅隊演練</a></li>
            <li><a href="/services/penetration-test/">滲透測試</a></li>
            <li><a href="/services/security-consulting/">資安顧問服務</a></li>
            <li><a href="/services/security-training/">資安教育訓練</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">研究</h6>
        <ul>
            <li><a href="/research/overview/">總覽概要</a></li>
            <li><a href="/research/awards/">競賽與獎項</a></li>
            <li><a href="/research/bug-bounty/">企業漏洞回報</a></li>
            <li><a href="/research/talks/">國際研討會</a></li>
            <li><a href="/research/cve/">CVE 漏洞列表</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">公司</h6>
        <ul>
            <li><a href="/company/about/">公司簡介</a></li>
            <li><a href="/company/our-team/">團隊成員</a></li>
            <li><a href="/company/history/">成就與沿革</a></li>
            <li><a href="/company/csr/">企業社會責任</a></li>
            <li><a href="/company/jobs/">工作機會</a></li>
            <li><a href="/contact/">聯絡我們</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">新聞</h6>
        <ul>
            <li><a href="/blog/">BLOG</a></li>
            <li><a href="/media-kit/">媒體素材下載</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2025 DEVCORE 戴夫寇爾股份有限公司. <b class="line-block">All rights reserved.</b></span>
            <span><a href="/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>

