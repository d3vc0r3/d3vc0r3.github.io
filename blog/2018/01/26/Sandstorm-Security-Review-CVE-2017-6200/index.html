
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>一次在 Sandstorm 跳脫沙箱的滲透經驗 | DEVCORE 戴夫寇爾</title><link href="/assets/themes/devcore-v2/stylesheets/webpack_bundle.css" rel="stylesheet" />
    <link href="/assets/themes/devcore-v2/images/favicon.png" rel="icon" size="32x32">
    <meta name="description" property="og:description" content="關於 Sandstorm 一些少見的有趣弱點，提升權限、跳脫沙箱...。" />
    <meta name="keywords" content="Advisory, CVE, Vulnerability, IDOR, Pentest" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="一次在 Sandstorm 跳脫沙箱的滲透經驗 | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20180126/cover.png" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="一次在 Sandstorm 跳脫沙箱的滲透經驗 | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="關於 Sandstorm 一些少見的有趣弱點，提升權限、跳脫沙箱...。">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20180126/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">
    <link rel="publisher" href="https://plus.google.com/118439315679478709768/" />

  </head>
  <body>
    <div class="page">
      <div class="container--wrapper">
        <div class="topbar">
          <div class="topbar__brand">
            <a href="/">
                <div class="logo">
                  DEVCORE 戴夫寇爾
                </div></a>
            <p class="slogan">
              我們提供<a href="/services/penetration-test" class="link">滲透測試</a>、<a href="/services/red-team" class="link">紅隊演練</a>、<a href="/services/security-consulting" class="link">資安顧問</a>與<a href="/services/security-training" class="link">教育訓練</a>服務
            </p>
          </div>
          <div class="drawer" id="drawer">
            <div class="drawer__container">
              <nav class="main-menu">
                <div class="hidden">
                  主選單
                </div>
                <a href="/services/penetration-test" class="main-menu__link mobile-only">滲透測試</a>
                <a href="/services/red-team" class="main-menu__link mobile-only">紅隊演練</a>
                <a href="/services/security-consulting" class="main-menu__link mobile-only">資安顧問</a>
                <a href="/services/security-training" class="main-menu__link mobile-only">教育訓練</a>
                <a href="/about/" class="main-menu__link">駭客思維</a><a href="/blog/" class="main-menu__link">最新訊息</a><a href="/search/" class="main-menu__link main-menu__search desktop-only"><span class="hidden">搜尋</span><svg class="icon-search icon"><use xlink:href="#icon-search" /></svg></a>
              </nav>
              <a href="/contact/" class="drawer__contact button--dense">聯絡我們</a>
              <nav class="lang-menu">
                <div class="lang-menu__label">
                  語言:
                </div>
                <a href="/" class="lang-menu__link">中文</a>
                <a href="/en/" class="lang-menu__link">English</a>
              </nav>
            </div>
          </div><span class="topbar__menu mobile-only">menu</span><button class="appearance-none topbar__hamburger mobile-only" data-toggle="#drawer" id="drawer-toggle" type="button">
            <div class="bars">
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
            </div>
          </button>
        </div>
      </div><main role="main">


          <div class="container--wrapper">
            <div class="container">
              <section class="blog-header">
                <small class="blog-header__category"><a href="/blog/category/技術專欄/">技術專欄</a></small>
                <img src="https://devco.re/assets/img/blog/20180126/cover.png" class="blog-header__image" alt="一次在 Sandstorm 跳脫沙箱的滲透經驗" />
                <h1 class="blog-header__title">
                  一次在 Sandstorm 跳脫沙箱的滲透經驗
                </h1>
                <div class="blog-header__tags">
                  
                  <a href="/blog/tag/Advisory/" class="blog-header__tag">Advisory</a><a href="/blog/tag/CVE/" class="blog-header__tag">CVE</a><a href="/blog/tag/Vulnerability/" class="blog-header__tag">Vulnerability</a><a href="/blog/tag/IDOR/" class="blog-header__tag">IDOR</a><a href="/blog/tag/Pentest/" class="blog-header__tag">Pentest</a>
                </div>
          
          
                <p class="blog-header__info">
                  By <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/shaolinhsu.jpg)"></span> <a href="/blog/author/shaolin" class="author-name">Shaolin</a> <time class="date">on 2018-01-26 </time>
                </p>
          
              </section>
              <article class="article">
          <p><a href="/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200-en/">Sandstorm Security Review</a> (English Version)  <br />
<a href="/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200/">一次在 Sandstorm 跳脫沙箱的滲透經驗</a> (中文版本)</p>

<h2 id="前言">前言</h2>

<p>2017 年初，我們有個滲透測試專案，專案的標的架構在 <a href="https://sandstorm.io/">Sandstorm</a> 之上。Sandstorm 是一款 Web 平台，使用者可以輕易的在該平台安裝各種 Web App（如 WordPress、GitLab…），該平台最大的特色在於這些 App 都是在沙箱中執行。因此，即使我們測試中找到多項 App 弱點，也無法對平台本身造成威脅。</p>

<p>為了讓弱點效益最大化，我們將一部分精力轉移到研究 Sandstorm 原始碼，目的是跳脫 App 的沙箱環境看有沒有機會影響整台伺服器。最後，我們找到了幾個少見且有趣的弱點，並申請 CVE 編號如下：</p>

<ul>
  <li>阻斷服務攻擊（Denial of Service），CVE-2017-6198</li>
  <li>繞過授權模式（Bypassing Authorization Schema），CVE-2017-6199</li>
  <li>不安全的直接存取物件（Insecure Direct Object References），CVE-2017-6200</li>
  <li>服務端請求偽造（Server-Side Request Forgery），CVE-2017-6201</li>
</ul>

<h2 id="漏洞細節">漏洞細節</h2>

<h3 id="cve-2017-6198">CVE-2017-6198</h3>

<p>這是一個消耗系統資源造成的 DoS。起因是 Sandstorm 並未完善限制每個 App 所能使用的資源，在 <code class="highlighter-rouge">src/sandstorm/supervisor.c++</code> 僅限制了每個程序能夠打開的最多檔案數，相關程式碼如下：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">SupervisorMain</span><span class="o">::</span><span class="n">setResourceLimits</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">rlimit</span> <span class="n">limit</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">limit</span><span class="p">));</span>
  <span class="n">limit</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
  <span class="n">limit</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
  <span class="n">KJ_SYSCALL</span><span class="p">(</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_NOFILE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">limit</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ref: <a href="https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/supervisor.c++#L824">https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/supervisor.c++#L824</a></p>

<p>由於 supervisor 未限制子程序數量以及未限制儲存空間用量，因此攻擊者只要讓 App 不斷執行 fork（通常稱為 Fork Bomb）或是大量使用硬碟空間，就會造成伺服器資源不足而中斷服務。</p>

<h3 id="cve-2017-6199">CVE-2017-6199</h3>

<p>通常 Sandstorm 會設定特定組織成員才能擁有特殊的權限，而系統預設的組織成員判斷方式是檢查使用者 email 中「@」符號最後的字串是否在白名單內，相關程式碼如下：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">identity</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s2">"@"</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span> <span class="o">===</span> <span class="nx">emailDomain</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ref: <a href="https://github.com/sandstorm-io/sandstorm/blob/v0.202/shell/packages/sandstorm-db/db.js#L1112">https://github.com/sandstorm-io/sandstorm/blob/v0.202/shell/packages/sandstorm-db/db.js#L1112</a></p>

<p>因此，當攻擊者填入的 email 為 <code class="highlighter-rouge">demo@devco.re,ccc@aaa.bbb</code>，系統便會將攻擊者視為 <code class="highlighter-rouge">aaa.bbb</code> 組織的使用者。</p>

<p>這項攻擊得以成功還有另外一個關鍵點，發生在 Sandstorm 登入的一個特色上。使用 Sandstorm 服務不需要設定密碼，使用者每次欲登入時填入 email，系統便會發送一組每次皆不同的隨機密碼作為登入使用。上述的例子之所以能夠成功，就是因為系統將 <code class="highlighter-rouge">demo@devco.re,ccc@aaa.bbb</code> 視為一個 aaa.bbb 網域的使用者，而隨機密碼會發送到 <code class="highlighter-rouge">demo@devco.re</code> 以及 <code class="highlighter-rouge">ccc@aaa.bbb</code> 兩個不同信箱中，只要可以收到密碼就可以登入使用服務。</p>

<p>直接案例說明：</p>

<ol>
  <li>
    <p>在 Sandstorm 限定只有用 <code class="highlighter-rouge">aaa.bbb</code> 網域才可以登入。<br />
<img src="/assets/img/blog/20180126/1.png" alt="" /></p>
  </li>
  <li>
    <p>登入處 email 欄位填入 <code class="highlighter-rouge">demo@devco.re,ccc@aaa.bbb</code>。（註：email 欄位在前端有用 HTML5 Validation，但後端並無檢查 email 是否合法）<br />
<img src="/assets/img/blog/20180126/2.png" alt="" /></p>
  </li>
  <li>
    <p>在 demo@devco.re 信箱收到隨機密碼。<br />
<img src="/assets/img/blog/20180126/3.png" alt="" /></p>
  </li>
  <li>
    <p>成功登入，<code class="highlighter-rouge">demo@devco.re,ccc@aaa.bbb</code> 被視為一個使用者，且為 <code class="highlighter-rouge">aaa.bbb</code> 組織成員！<br />
<img src="/assets/img/blog/20180126/4.png" alt="" /></p>
  </li>
</ol>

<p>在我們的滲透測試中，標的網站是允許認證的網域使用者自行安裝 App 的。因此透過這項繞過弱點，攻擊者可以再搭配本篇其他漏洞（CVE-2017-6198、CVE-2017-6200、CVE-2017-6201）做更進一步的攻擊。</p>

<h3 id="cve-2017-6200">CVE-2017-6200</h3>

<p>這是一個有趣的弱點，總共組合了兩個驗證上的小疏忽才能達成攻擊！<br />
在 Sandstorm 中每個 Grain（Sandstorm container，簡單來說就是一個 App 沙箱）的擁有者都可以下載該 App 的備份資料，但由於打包流程中存在兩個弱點，因此攻擊者可以打包沙箱外伺服器的 <code class="highlighter-rouge">/etc</code> 和 <code class="highlighter-rouge">/run</code> 下的檔案。發生的問題如下：</p>

<ol>
  <li>
    <p>打包的流程隱藏了 <code class="highlighter-rouge">/var</code>、<code class="highlighter-rouge">/proc</code>、<code class="highlighter-rouge">/etc</code> 等敏感目錄，卻沒有隱藏 <code class="highlighter-rouge">/etc.host</code> 及 <code class="highlighter-rouge">/run.host</code> 這兩個目錄。這兩個目錄分別是伺服器下 <code class="highlighter-rouge">/etc</code> 和 <code class="highlighter-rouge">/run</code> 的別名，是較後期的功能。</p>
  </li>
  <li>
    <p>系統會將欲打包的合法檔案整理出來透過標準輸入介面傳給 zip 打包，而判斷檔案和檔案間的區隔是靠換行符號(<code class="highlighter-rouge">\n</code>)。因此，當檔名中出現換行符號，可以插入非法的路徑檔名藉由 zip 打包。程式雖然有檢查檔名是否存在換行符，卻疏忽了檢查目錄名。</p>
  </li>
</ol>

<p>Ref: <a href="https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/backup.c%2B%2B#L271">https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/backup.c%2B%2B#L271</a></p>

<p>綜合上述兩個弱點，攻擊者只要在沙箱內建立一個目錄 <code class="highlighter-rouge">/var/exp\n/etc.host/passwd\n</code>，就可以透過下載備份的功能取得含有伺服器 <code class="highlighter-rouge">/etc/passwd</code> 檔案的備份檔。</p>

<p>實際情境截圖：</p>
<ol>
  <li>
    <p>先在 Grain 裡新建目錄 <code class="highlighter-rouge">/var/exp\n/etc.host/passwd\n</code>，並用 Grain Backup 的功能下載備份檔。<br />
<img src="/assets/img/blog/20180126/5.png" alt="" /></p>
  </li>
  <li>
    <p>解開備份檔後在 <code class="highlighter-rouge">etc.host</code> 目錄下看到沙箱外伺服器的 <code class="highlighter-rouge">/etc/passwd</code><br />
<img src="/assets/img/blog/20180126/6.png" alt="" /></p>
  </li>
</ol>

<h3 id="cve-2017-6201">CVE-2017-6201</h3>

<p>這是經典的 SSRF（Server-Side Request Forgery）問題，在 Sandstorm 安裝 App 流程沒有限制安裝來源，攻擊者提供一個安裝 URL 就能讓伺服器存取該位置。該問題發生在 <code class="highlighter-rouge">https://[target]/install/xxxChangeItEveryTimexxx?url=http://127.0.0.1:22/</code>，這個範例連結得以確認伺服器的 22 port 是否開啟。</p>

<p><img src="/assets/img/blog/20180126/7.png" alt="" /></p>
<center>（Parse Error，代表伺服器 22 port 開啟）</center>

<h2 id="後續">後續</h2>

<p>在提交弱點後，Sandstorm 官方非常迅速修正了弱點，並且發表了一篇文章：<br />
<a href="https://sandstorm.io/news/2017-03-02-security-review">https://sandstorm.io/news/2017-03-02-security-review</a></p>

<p>在這次滲透經驗中，我們認為 Sandstorm 是一款安全、有出色防禦機制的平台。主要原因取決於它的一個核心設計理念：就是假設使用者安裝的 App 都是惡意的。以這樣的前提出發去保護核心系統的安全，建立起來的防禦機制自然是全面且完善的。除了伺服器本身的保護，一些常見的客戶端攻擊（例如：XSS、CSRF）也透過 Sandstorm 特殊的隨機 hostname 等機制保護的很好。因此攻擊者很難從 App 本身去破壞伺服器，也很難透過攻擊客戶端去提升使用者的權限。</p>

<p>儘管是如此優秀的平台，仍舊會因一些小地方疏忽導致攻擊者有機可乘。這次發現弱點的地方多半在於 library 的誤用和新功能的撰寫沒有考慮到舊有防禦架構。這在其他專案也是常見的問題，藉機也提醒開發者在開發新功能時應做全面的安全檢視，以避免防禦落差所導致的弱點。</p>


              </article>
              <p class="sns-widgets">
                Share this on <button class="appearance-none sns-widgets__button" id="sns-facebook" type="button">Facebook</button> or <button class="appearance-none sns-widgets__button" id="sns-twitter" type="button">Twitter</button>
              </p>
          
              <div class="heading--side-lined">
                About <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/shaolinhsu.jpg)"></span> <a href="/blog/author/shaolin" class="blog-author-name">Shaolin</a> 
              </div>
              <p class="blog-author-info">
                喜愛資訊技術、喜歡跟別人走不一樣的路。有一點點智障的熱血人，期望能利用資訊的力量對世界有所貢獻。
              </p>
          
              <div class="heading--side-lined">
                讀者留言
              </div>
              <div class="blog-comments">
                


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'd3vc0r3'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




              </div>
            </div>
          </div>






</main>
      <div class="container--wrapper">

        <div class="relative-posts">
          <div class="heading--side-lined container">
            最新消息
          </div>
          <div class="relative-posts__cells">
  
            <section class="card">
              <a href="/blog/2019/08/09/Fortigate-SSL-VPN-advisory/">
                <div class="card__thumbnail" style="background-image: url(https://devco.re/assets/img/blog/20190807/cover.png)"></div>
                <h3 class="card__title">
                  Fortigate SSL VPN 資安通報
                </h3></a>
              <div class="card__tags">
  
                <a href="/blog/tag/Advisory/" class="card__tag">Advisory</a><a href="/blog/tag/VPN/" class="card__tag">VPN</a><a href="/blog/tag/RCE/" class="card__tag">RCE</a>
              </div>
              <small class="card__category"><a href="/blog/category/資安新聞/">資安新聞</a></small>
            </section>
  
            <section class="card">
              <a href="/blog/2019/07/23/devcore-201907-recruit/">
                <div class="card__thumbnail" style="background-image: url(https://devco.re/assets/img/blog/20150819/devcore_office_1.jpg)"></div>
                <h3 class="card__title">
                  [已結束] DEVCORE 徵求行政專員
                </h3></a>
              <div class="card__tags">
  
                <a href="/blog/tag/公告/" class="card__tag">公告</a><a href="/blog/tag/徵才/" class="card__tag">徵才</a>
              </div>
              <small class="card__category"><a href="/blog/category/最新消息/">最新消息</a></small>
            </section>
  
            <section class="card">
              <a href="/blog/2019/07/17/Palo-Alto-GlobalProtect-advisory/">
                <div class="card__thumbnail" style="background-image: url(https://devco.re/assets/img/blog/20190717/cover.png)"></div>
                <h3 class="card__title">
                  Palo Alto GlobalProtect 資安通報
                </h3></a>
              <div class="card__tags">
  
                <a href="/blog/tag/Advisory/" class="card__tag">Advisory</a><a href="/blog/tag/VPN/" class="card__tag">VPN</a><a href="/blog/tag/RCE/" class="card__tag">RCE</a>
              </div>
              <small class="card__category"><a href="/blog/category/資安新聞/">資安新聞</a></small>
            </section>
  
          </div>
        </div>


        <div class="contact-section container">
          <h2 class="contact-section__title">
            用最真實的攻擊，驗證企業的防禦
          </h2>
          <a href="/contact/" class="home-contact__button button--dense">聯絡我們</a>
        </div>

        <footer class="main-footer">
          <div class="main-footer__about">
            戴夫寇爾提供<br class="mobile-only" /><a href="/services/penetration-test" class="link">滲透測試</a>、<a href="/services/red-team" class="link">紅隊演練</a>、<a href="/services/security-consulting" class="link">資安顧問</a>與<a href="/services/security-training" class="link">教育訓練</a>服務<br />在<a href="https://www.facebook.com/D3VC0RE" class="link" target="_blank">Facebook</a>或<a href="https://twitter.com/d3vc0r3" class="link" target="_blank">Twitter</a>上追蹤我們的<a href="/blog/" class="link">最新訊息</a><br />瞭解更多戴夫寇爾的<a href="/about/" class="link">駭客思維</a>
          </div>
          <div class="main-footer__snses"><a href="https://www.facebook.com/D3VC0RE" class="main-footer__sns" target="_blank">
                <svg class="icon-fb icon"><use xlink:href="#icon-fb" /></svg></a><a href="https://plus.google.com/118439315679478709768/posts" class="main-footer__sns">
                <svg class="icon-googleplus icon"><use xlink:href="#icon-googleplus" /></svg></a><a href="https://twitter.com/d3vc0r3" class="main-footer__sns" target="_blank">
                <svg class="icon-twitter icon"><use xlink:href="#icon-twitter" /></svg></a>
          </div>
          <address class="main-footer__address">
            <ul class="list--unstyled">
              <li>
                地址 10487 台北市中山區復興北路 168 號 10 樓
              </li>
              <li>
                Email contact@devco.re
              </li>
              <li>
                電話 02-2718-0156
              </li>
              <li>
                統編 53955237
              </li>
            </ul>
          </address><small class="main-footer__copyright"><a href="/" class="logo">DEVCORE</a>©2019 DEVCORE 戴夫寇爾</small>
        </footer>
      </div>
    </div>
    <script src="/assets/themes/devcore-v2/javascripts/webpack_bundle.js"></script>



  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30830800-1']);
  _gaq.push(['_trackPageview', location.pathname + location.search + location.hash]);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>





  </body>
</html>




