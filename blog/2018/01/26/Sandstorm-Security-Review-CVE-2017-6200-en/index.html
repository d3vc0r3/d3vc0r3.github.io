
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Sandstorm Security Review | DEVCORE</title><link href="/assets/themes/devcore-v2/stylesheets/webpack_bundle.css" rel="stylesheet" />
    <link href="/assets/themes/devcore-v2/images/favicon.png" rel="icon" size="32x32">
    <meta name="description" property="og:description" content="In order to leverage the vulnerabilities, we put part of efforts into review of Sandstorm's source codes, and tried to escape the sandbox to impact the whole server..." />
    <meta name="keywords" content="Advisory, CVE, Vulnerability" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="Sandstorm Security Review | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200-en/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20180126/cover.png" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Sandstorm Security Review | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="In order to leverage the vulnerabilities, we put part of efforts into review of Sandstorm's source codes, and tried to escape the sandbox to impact the whole server...">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20180126/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200-en/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">
    <link rel="publisher" href="https://plus.google.com/118439315679478709768/" />

  </head>
  <body>
    <div class="page">
      <div class="container--wrapper">
        <div class="topbar">
          <div class="topbar__brand">
            <a href="/en/">
                <div class="logo">
                  DEVCORE
                </div></a>
            <p class="slogan">
              We offer professional <a href="/en/services/penetration-test" class="link">pentesting</a>, <a href="/en/services/red-team" class="link">red teaming</a>, <a href="/en/services/security-consulting" class="link">consulting</a>, and <a href="/en/services/security-training" class="link">training</a> services
            </p>
          </div>
          <div class="drawer" id="drawer">
            <div class="drawer__container">
              <nav class="main-menu">
                <div class="hidden">
                  Menu
                </div>
                <a href="/en/services/penetration-test" class="main-menu__link mobile-only">Penetration Testing</a>
                <a href="/en/services/red-team" class="main-menu__link mobile-only">Red Team Assessment</a>
                <a href="/en/services/security-consulting" class="main-menu__link mobile-only">Consulting</a>
                <a href="/en/services/security-training" class="main-menu__link mobile-only">Training</a>
                <a href="/en/about/" class="main-menu__link">Hackers</a><a href="/en/blog/" class="main-menu__link">News</a><a href="/en/search/" class="main-menu__link main-menu__search desktop-only"><span class="hidden">Search</span><svg class="icon-search icon"><use xlink:href="#icon-search" /></svg></a>
              </nav>
              <a href="/en/contact/" class="drawer__contact button--dense">Contact</a>
              <nav class="lang-menu">
                <div class="lang-menu__label">
                  Lang:
                </div>
                <a href="/" class="lang-menu__link">中文</a>
                <a href="/en/" class="lang-menu__link">English</a>
              </nav>
            </div>
          </div><span class="topbar__menu mobile-only">menu</span><button class="appearance-none topbar__hamburger mobile-only" data-toggle="#drawer" id="drawer-toggle" type="button">
            <div class="bars">
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
            </div>
          </button>
        </div>
      </div><main role="main">


          <div class="container--wrapper">
            <div class="container">
              <section class="blog-header">
                <small class="blog-header__category"><a href="/en/blog/category/Tech Editorials/">Tech Editorials</a></small>
                <img src="https://devco.re/assets/img/blog/20180126/cover.png" class="blog-header__image" alt="Sandstorm Security Review" />
                <h1 class="blog-header__title">
                  Sandstorm Security Review
                </h1>
                <div class="blog-header__tags">
                  
                  <a href="/en/blog/tag/Advisory/" class="blog-header__tag">Advisory</a><a href="/en/blog/tag/CVE/" class="blog-header__tag">CVE</a><a href="/en/blog/tag/Vulnerability/" class="blog-header__tag">Vulnerability</a>
                </div>
          
          
                <p class="blog-header__info">
                  By <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/shaolinhsu.jpg)"></span> <a href="/en/blog/author/shaolin" class="author-name">Shaolin</a> <time class="date">on 2018-01-26 </time>
                </p>
          
              </section>
              <article class="article">
          <p><a href="/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200-en/">Sandstorm Security Review</a> (English Version)  <br />
<a href="/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200/">一次在 Sandstorm 跳脫沙箱的滲透經驗</a> (中文版本)</p>

<h2 id="introduction">Introduction</h2>

<p>In early 2017, we had a pentesting target protected with <a href="https://sandstorm.io/">Sandstorm</a>. Sandstorm is a web-based platform which allows users to install their web apps, such as WordPress, GitLab, etc. The main feature of Sandstorm is that it containerizes every app in its own sandbox. Therefore, even though we had found several vulnerabilities of the apps, we still could not put a threat to the server.</p>

<p>In order to leverage the vulnerabilities, we put part of efforts into review of Sandstorm’s source codes, and tried to escape the sandbox to impact the whole server. Finally, we found a number of uncommon and interesting vulnerabilities, and received CVE IDs as follows:</p>

<ul>
  <li>CVE-2017-6198 (Denial of Service)</li>
  <li>CVE-2017-6199 (Bypassing Authorization Schema)</li>
  <li>CVE-2017-6200 (Insecure Direct Object References)</li>
  <li>CVE-2017-6201 (Server-Side Request Forgery)</li>
</ul>

<h2 id="exploitation-details">Exploitation Details</h2>

<h3 id="cve-2017-6198">CVE-2017-6198</h3>

<p>This is a DoS created by system resource exhaustion. The root cause is that Sandstorm does not have a comprehensive policy to limit the amount of resource used by every apps run on it. In <code class="highlighter-rouge">src/sandstorm/supervisor.c++</code> only the maximum number of files opened by each process was limited. See the codes below:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">SupervisorMain</span><span class="o">::</span><span class="n">setResourceLimits</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">rlimit</span> <span class="n">limit</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">limit</span><span class="p">));</span>
  <span class="n">limit</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
  <span class="n">limit</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
  <span class="n">KJ_SYSCALL</span><span class="p">(</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_NOFILE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">limit</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ref: <a href="https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/supervisor.c++#L824">https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/supervisor.c++#L824</a></p>

<p>Since supervisor does not restrict the amount of subprocesses and storage usage, attackers can raise a resource exhaustion attack to crash the server by simply uploading a malicious app which keeps calling fork() (aka the “fork bomb”) or consumes huge storage space.</p>

<h3 id="cve-2017-6199">CVE-2017-6199</h3>

<p>Usually Sandstorm will designate unique permissions to the specific members of a certain organization, and the default membership validation method is to check user’s email address and see whether the string after <code class="highlighter-rouge">@</code> exists in their white list. See the codes below:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">identity</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s2">"@"</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span> <span class="o">===</span> <span class="nx">emailDomain</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ref: <a href="https://github.com/sandstorm-io/sandstorm/blob/v0.202/shell/packages/sandstorm-db/db.js#L1112">https://github.com/sandstorm-io/sandstorm/blob/v0.202/shell/packages/sandstorm-db/db.js#L1112</a></p>

<p>Therefore, when an attacker fills in an email like <code class="highlighter-rouge">demo@devco.re,ccc@aaa.bbb</code> and the system will automatically consider the attacker a member of the <code class="highlighter-rouge">aaa.bbb</code> organization.</p>

<p>Another key factor that contributes to the successful attack lies in one of the features when users log on Sandstorm. Users does not need to set up passwords for Sandstorm. Each time when the users need to log onto the service, they only need to fill in their email address, and they’ll receive a set of random unique password for login. The reason why the example above works is because the system treats <code class="highlighter-rouge">demo@devco.re,ccc@aaa.bbb</code> as a user from aaa.bbb domain, and the random password will be sent to the two email addresses, <code class="highlighter-rouge">demo@devco.re</code> and <code class="highlighter-rouge">ccc@aaa.bbb</code> As long as one can receive the password, they can log in to use the service.</p>

<p>Below is a quick demonstration:</p>

<ol>
  <li>
    <p>On Sandstorm, restrict access to users from domain <code class="highlighter-rouge">aaa.bbb</code> only.<br />
<img src="/assets/img/blog/20180126/1.png" alt="" /></p>
  </li>
  <li>
    <p>On login page, fill in <code class="highlighter-rouge">demo@devco.re,ccc@aaa.bbb</code> for the email field.<br />
(Note: at the front end, the email field is checked with HTML5 validation, but it is not further checked for validity at the back end)<br />
<img src="/assets/img/blog/20180126/2.png" alt="" /></p>
  </li>
  <li>
    <p>Retrieve random password in demo@devco.re mailbox.<br />
<img src="/assets/img/blog/20180126/3.png" alt="" /></p>
  </li>
  <li>
    <p>Login successful. <code class="highlighter-rouge">demo@devco.re,ccc@aaa.bbb</code> is considered as a user and member of <code class="highlighter-rouge">aaa.bbb</code> organization!<br />
<img src="/assets/img/blog/20180126/4.png" alt="" /></p>
  </li>
</ol>

<p>In our pentesting, the target website allowed users from validated domains to install their own apps. Therefore, through this bypass exploit, further attacks could be accomplished by combining other vulnerabilities described in this blog post (CVE-2017-6198, CVE-2017-6200, CVE-2017-6201).</p>

<h3 id="cve-2017-6200">CVE-2017-6200</h3>

<p>This is an interesting vulnerability. Totally two little validation flaws were exploited to initiate this attack!<br />
On Sandstorm, owners of each Grain (Sandstorm container, in short, an app sandbox) can download their backup data for the app. But because of the two vulnerabilities in the packing process, an attacker can pack the files under the <code class="highlighter-rouge">/etc</code> and <code class="highlighter-rouge">/run</code> directories located on the server outside the sandbox. The security issues were as follows:</p>

<ol>
  <li>
    <p>The packing process has hid <code class="highlighter-rouge">/var</code>, <code class="highlighter-rouge">/proc</code>, <code class="highlighter-rouge">/etc</code> and other sensitive directories, but did not hide <code class="highlighter-rouge">/etc.host</code> and <code class="highlighter-rouge">/run.host</code> these two directories. These directories are the aliases for the directories <code class="highlighter-rouge">/etc</code> and <code class="highlighter-rouge">/run</code> on the server respectively, which are relatively newer features.</p>
  </li>
  <li>
    <p>The system will pack the legitimate files, have them sorted out, and create zip packages through the standard input interface. The separation between files are determined by line-breaks (<code class="highlighter-rouge">\n</code>). As a result, when a line-break string appears in the file name, illegal path file names can be injected and packed with zip. Although the app checks whether there is a line-break in the file name, but the directory name was not checked.</p>
  </li>
</ol>

<p>Ref: <a href="https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/backup.c%2B%2B#L271">https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/backup.c%2B%2B#L271</a></p>

<p>By using these two vulnerabilities together, the attacker simply has to create a directory in the sandbox <code class="highlighter-rouge">/var/exp\n/etc.host/passwd\n</code> , then backup files containing <code class="highlighter-rouge">/etc/passwd</code> on the server can be retrieved through backup downloading function.</p>

<p>Screenshot of a real-world scenario:</p>
<ol>
  <li>
    <p>First, create a new directory in Grain <code class="highlighter-rouge">/var/exp\n/etc.host/passwd\n</code>, and use the Grain Backup function to download the backup file.<br />
<img src="/assets/img/blog/20180126/5.png" alt="" /></p>
  </li>
  <li>
    <p>After unzipping the backup file, from <code class="highlighter-rouge">etc.host</code> we’ll see <code class="highlighter-rouge">/etc/passwd</code> of the server outside the sandbox.<br />
<img src="/assets/img/blog/20180126/6.png" alt="" /></p>
  </li>
</ol>

<h3 id="cve-2017-6201">CVE-2017-6201</h3>

<p>This is a classic SSRF (Server-Side Request Forgery) issue. Sandstorm allow installation of apps from arbitrary sources, and an attacker can simply let the server access a certain location by providing an installation URL. The problem was identified on <code class="highlighter-rouge">https://[target]/install/xxxChangeItEveryTimexxx?url=http://127.0.0.1:22/</code> This sample link confirms whether the server’s port 22 is open.</p>

<p><img src="/assets/img/blog/20180126/7.png" alt="" /></p>
<center>(Parse Error, which implies server’s port 22 is open)</center>

<h2 id="follow-up-updates">Follow-up Updates</h2>

<p>After we reported the vulnerabilities, Sandstorm fixed it immediately and then published an article:<br />
<a href="https://sandstorm.io/news/2017-03-02-security-review">https://sandstorm.io/news/2017-03-02-security-review</a></p>

<p>Through this pentesting experience, we consider Sandstorm a safe platform with outstanding security mechanisms. This is mainly attributed to its fundamental design rationale: to assume that every app installed is malicious. With this vigilant assumption, Sandstorm’s defence mechanisms for the core system become comprehensive and watertight. Apart from the server-side protection, some common client-side attacks (such as XSS, CSRF) are handled properly by Sandstorm’s unique countermeasures, such as host name randomization. That is, it is very difficult for attackers to sabotage the server by simply manipulating the apps, and so does privilege escalation through attacking at the client-side.</p>

<p>Nevertheless, such an impressive platform still had some minor mistakes which led to security issues. Most of the vulnerabilities found this time are improper usages of libraries or negligence of existing defence architecture while introducing new features. These types of vulnerability are also common in our other projects. We would like to take the opportunity to remind developers, always present a comprehensive security review especially when developing new features to avoid vulnerabilities caused by the gaps between defence mechanisms.</p>


              </article>
              <p class="sns-widgets">
                Share this on <button class="appearance-none sns-widgets__button" id="sns-facebook" type="button">Facebook</button> or <button class="appearance-none sns-widgets__button" id="sns-twitter" type="button">Twitter</button>
              </p>
          
              <div class="heading--side-lined">
                About <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/shaolinhsu.jpg)"></span> <a href="/en/blog/author/shaolin" class="blog-author-name">Shaolin</a> 
              </div>
              <p class="blog-author-info">
                喜愛資訊技術、喜歡跟別人走不一樣的路。有一點點智障的熱血人，期望能利用資訊的力量對世界有所貢獻。
              </p>
          
              <div class="heading--side-lined">
                Comments
              </div>
              <div class="blog-comments">
                


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'd3vc0r3'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




              </div>
            </div>
          </div>






</main>
      <div class="container--wrapper">


        <div class="contact-section container">
          <h2 class="contact-section__title">
            Put your defenses to the test with authentic attacks
          </h2>
          <a href="/en/contact/" class="home-contact__button button--dense">Contact us now</a>
        </div>

        <footer class="main-footer">
          <div class="main-footer__about">
            DEVCORE offers professional<br class="mobile-only" /><a href="/en/services/penetration-test" class="link">pentesting</a>, <a href="/en/services/red-team" class="link">red teaming</a>, <a href="/en/services/security-consulting" class="link">consulting</a>, and <a href="/en/services/security-training" class="link">training</a> services.<br />For <a href="/en/blog/" class="link">latest updates</a>, follow us on <a href="https://www.facebook.com/D3VC0RE" class="link" target="_blank">Facebook</a> or <a href="https://twitter.com/d3vc0r3" class="link" target="_blank">Twitter</a>.
          </div>
          <div class="main-footer__snses"><a href="https://www.facebook.com/D3VC0RE" class="main-footer__sns" target="_blank">
                <svg class="icon-fb icon"><use xlink:href="#icon-fb" /></svg></a><a href="https://plus.google.com/118439315679478709768/posts" class="main-footer__sns">
                <svg class="icon-googleplus icon"><use xlink:href="#icon-googleplus" /></svg></a><a href="https://twitter.com/d3vc0r3" class="main-footer__sns" target="_blank">
                <svg class="icon-twitter icon"><use xlink:href="#icon-twitter" /></svg></a>
          </div>
          <address class="main-footer__address">
            <ul class="list--unstyled">
              <li>
                10F., No.168, Fuxing N. Rd., Zhongshan Dist., Taipei City 10487, Taiwan (R.O.C.)
              </li>
              <li>
                contact@devco.re
              </li>
              <li>
                +886-2-2718-0156
              </li>
            </ul>
          </address><small class="main-footer__copyright"><a href="/" class="logo">DEVCORE</a>©2018 DEVCORE</small>
        </footer>
      </div>
    </div>
    <script src="/assets/themes/devcore-v2/javascripts/webpack_bundle.js"></script>



  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30830800-1']);
  _gaq.push(['_trackPageview', location.pathname + location.search + location.hash]);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>





  </body>
</html>




