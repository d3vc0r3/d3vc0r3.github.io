
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Your NAS is not your NAS ! | DEVCORE</title><link href="/assets/themes/devcore-v2/stylesheets/webpack_bundle.css" rel="stylesheet" />
    <link href="/assets/themes/devcore-v2/images/favicon.png" rel="icon" size="32x32">
    <meta name="description" property="og:description" content="We have successfully found a serious vulnerability in the NAS, and successfully wrote a proof-of-concept, which proved that it can be exploited on many NAS such as Synology, QNAP and Asustor." />
    <meta name="keywords" content="RCE, Netatalk, Synology, QNAP, Asustor" />
    <meta property="og:site_name" content="DEVCORE æˆ´å¤«å¯‡çˆ¾" />
    <meta property="og:title" content="Your NAS is not your NAS ! | DEVCORE æˆ´å¤«å¯‡çˆ¾" />
    <meta property="og:url" content="https://devco.re/blog/2022/03/28/your-NAS-is-not-your-NAS-en/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20220328/cover.png" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Your NAS is not your NAS ! | DEVCORE æˆ´å¤«å¯‡çˆ¾">
    <meta name="twitter:description" content="We have successfully found a serious vulnerability in the NAS, and successfully wrote a proof-of-concept, which proved that it can be exploited on many NAS such as Synology, QNAP and Asustor.">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20220328/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2022/03/28/your-NAS-is-not-your-NAS-en/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE æˆ´å¤«å¯‡çˆ¾" href="https://devco.re/rss">

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K5B8NW');</script>
    <!-- End Google Tag Manager -->
  </head>
  <body>
    <div class="page">
      <div class="container--wrapper">
        <div class="topbar">
          <div class="topbar__brand">
            <a href="/en/">
                <div class="logo">
                  DEVCORE
                </div></a>
            <p class="slogan">
              We offer professional <a href="/en/services/penetration-test" class="link">pentesting</a>, <a href="/en/services/red-team" class="link">red teaming</a>, <a href="/en/services/security-consulting" class="link">consulting</a>, and <a href="/en/services/security-training" class="link">training</a> services
            </p>
          </div>
          <div class="drawer" id="drawer">
            <div class="drawer__container">
              <nav class="main-menu">
                <div class="hidden">
                  Menu
                </div>
                <a href="/en/services/penetration-test" class="main-menu__link mobile-only">Penetration Testing</a>
                <a href="/en/services/red-team" class="main-menu__link mobile-only">Red Team Assessment</a>
                <a href="/en/services/security-consulting" class="main-menu__link mobile-only">Consulting</a>
                <a href="/en/services/security-training" class="main-menu__link mobile-only">Training</a>
                <a href="/en/about/" class="main-menu__link">Hackers</a><a href="/en/blog/" class="main-menu__link">News</a><a href="/en/search/" class="main-menu__link main-menu__search desktop-only"><span class="hidden">Search</span><svg class="icon-search icon"><use xlink:href="#icon-search" /></svg></a>
              </nav>
              <a href="/en/contact/" class="drawer__contact button--dense">Contact</a>
              <nav class="lang-menu">
                <div class="lang-menu__label">
                  Lang:
                </div>
                <a href="/" class="lang-menu__link">ä¸­æ–‡</a>
                <a href="/en/" class="lang-menu__link">English</a>
              </nav>
            </div>
          </div><span class="topbar__menu mobile-only">menu</span><button class="appearance-none topbar__hamburger mobile-only" data-toggle="#drawer" id="drawer-toggle" type="button">
            <div class="bars">
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
            </div>
          </button>
        </div>
      </div><main role="main">


          <div class="container--wrapper">
            <div class="container">
              <section class="blog-header">
                <small class="blog-header__category"><a href="/en/blog/category/Tech Editorials/" style="text-transform: uppercase;">Tech Editorials</a></small>
                <img src="https://devco.re/assets/img/blog/20220328/cover.png" class="blog-header__image" alt="Your NAS is not your NAS !" />
                <h1 class="blog-header__title">
                  Your NAS is not your NAS !
                </h1>
                <div class="blog-header__tags">
                  
                  <a href="/en/blog/tag/RCE/" class="blog-header__tag">RCE</a><a href="/en/blog/tag/NAS/" class="blog-header__tag">NAS</a><a href="/en/blog/tag/IoT/" class="blog-header__tag">IoT</a>
                </div>
          
          
                <p class="blog-header__info">
                  By <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/angelboy.jpg)"></span> <a href="/en/blog/author/angelboy" class="author-name">Angelboy</a> <time class="date">on 2022-03-28 </time>
                </p>
          
              </section>
              <article class="article">
          <p><a href="/blog/2022/03/28/your-NAS-is-not-your-NAS-en/">English Version</a><br />
<a href="/blog/2022/03/28/your-NAS-is-not-your-NAS/">ä¸­æ–‡ç‰ˆæœ¬</a></p>

<p>Two years ago, we found a <a href="https://www.zerodayinitiative.com/advisories/ZDI-21-492/">critical vulnerability</a>, CVE-2021-31439, on Synology NAS. This vulnerability can let an unauthorized attacker gain code execution on remote Synology DiskStation NAS server. We used this vulnerability to exploit Synology DS418play NAS in Pwn2Own Tokyo 2020. After that, we found the vulnerability is not only exists on Synology but also on most NAS vendors. Following we will describe the details and how we exploit it.</p>

<p>This research is also presented at <a href="https://hitcon.org/2021/en">HITCON 2021</a>. You can check the slides <a href="https://hitcon.org/2021/agenda/03f06675-261d-4c97-b524-33ef9cc6ccb2/%E4%BD%A0%E7%9A%84%20NAS%20%E4%B8%8D%E6%98%AF%E4%BD%A0%E7%9A%84%20NAS%20!.pdf">here</a>.</p>

<h2 id="network-attached-storage">Network Attached Storage</h2>

<p>In the early days, NAS was generally used to separate the server and data and also used for backup. It was mainly used to allow users to directly access data and share files on the Internet. In modern times, NAS provides not only file sharing but also various services. In this era of Internet of Things, there will be more people combining NAS and home assistants to make life more convenient.</p>

<p><img src="/assets/img/blog/20220328/1.png" alt="" /></p>

<h2 id="motivation">Motivation</h2>

<h3 id="why-do-we-want-to-research-nas">Why do we want to research NAS?</h3>

<h4 id="red-team">Red Team</h4>
<p>While we were doing red team assessment, we found that NAS generally appeared in the corporate intranet, or sometimes even exposed to the external network. They usually stored a lot of corporate confidential information on the NAS. Therefore, NAS gradually attracted our attention, and its Strategic Value has been much higher than before.</p>

<h4 id="ransomware">Ransomware</h4>
<p>NAS has become more and more popular in recent years. More and more people store important data on NAS. It makes NAS a target of ransomware. At the beginning of last year, NAS vulnerabilities led to outbreak of locker event. We hope to reduce the recurrence of similar things, thereby increasing the priority of NAS research to improve NAS security.</p>

<h4 id="pwn2own-mobile-2020">Pwn2Own Mobile 2020</h4>
<p>The last reason is that NAS has become one of the main targets of Pwn2Own Mobile since 2020. We also wanted to try to join Pwn2Pwn event, so we decided to make NAS as the primary goal of the research at that time. Because of Synology is the most popular device in Taiwan, we decided start from it.</p>

<h2 id="recon">Recon</h2>

<h3 id="environment">Environment</h3>
<ul>
  <li>DS918+</li>
  <li>DSM 6.2.3-25426</li>
</ul>

<p>Our test environment is Synology DS918+. It very similar as DS418 play(target of Pwn2Own Tokyo 2020). In order to better meet the environment that we usually encounter and the requirements in Pwn2Own, it will be in the state of all default settings.</p>

<h3 id="attack-surface">Attack surface</h3>

<p><img src="/assets/img/blog/20220328/2.png" alt="" /></p>

<p>First of all, we can use netstat to find which port is open. We can see that in the default environment, many services are opened, such as smb/nginx/afpd.</p>

<p><img src="/assets/img/blog/20220328/3.png" alt="" /></p>

<p>In UDP, it has minissdpd/findhost/snmpd, etc., most of protocols help to find devices.</p>

<p>We selected a few services for preliminary analysis.</p>

<h4 id="dsm-web-interface">DSM Web interface</h4>
<p>The first one is the DSM Web interface. This part is probably the one that most people analyze and it has obvious entry points. Many years ago, there were many command injection vulnerabilities, but after that Synology set strict specifications. There are almost no similar problems nowadays.</p>

<h4 id="smb">SMB</h4>
<p>The SMB protocol in Synology is based on <a href="https://www.samba.org/">Samba</a>. Due to the large number of user, many researcher are doing code review on it. Therefore, there are many vulnerabilities found in Samba every year. The most famous vulnerability recently is <a href="https://www.samba.org/samba/security/CVE-2017-7494.html">SambaCry</a>. But because more people are reviewing, it is relatively safer than other services.</p>

<h4 id="iscsi-manager">iSCSI Manager</h4>
<p>It mainly helps users manage and monitor iSCSI services and it is developed by Synology itself. There are a lot of vulnerabilities in iSCSI recently. Maybe it will be a good target. If there is no other attack surface, we might analyze it first.</p>

<h4 id="netatalk">Netatalk</h4>
<p>The last one is Netatalk, which is known as afp protocol. Netatalk in Synology is based on <a href="http://netatalk.sourceforge.net/">Netatak</a> 3.1.8. The most critical vulnerability recently is CVE-2018-1160. For this vulnerability, please refer to <a href="https://medium.com/tenable-techblog/exploiting-an-18-year-old-bug-b47afe54172">Exploiting an 18 Year Old Bug</a>. Compared with other services, Netatalk has very few vulnerabilities in the past. It is less noticed, and it has not been updated and maintained for a long time.</p>

<p>After overall analysis, we believe that Netatalk is the most vulnerable point in Synology. We finally decided to analyze it first. In fact, there are other services and attack surfaces, but we didnâ€™t spend much time on other service. We will only focus on Netatalk in this article.</p>

<h2 id="netatalk-1">Netatalk</h2>
<p>Apple Filing Protocol (AFP) is a file transfer protocol similar to SMB. It is used to transfer and share files on MAC. Because Apple itself is not open-sourced, in order to utilize AFP on Unix-like systems, Netatalk is created. Netatalk is a freely-available Open Source AFP fileserver. Almost every NAS uses it to make file sharing on MAC more convenient.</p>

<h3 id="netatalk-in-synology">Netatalk in Synology</h3>

<p>The netatalk in Synology is enabled by default. The version is modified from netatalk 3.1.8, and it tracks security updates regularly. Once installed, you can use the AFP protocol to share files with Synology NAS. It also enables protections such as ASLR, NX and StackGuard.</p>

<p><img src="/assets/img/blog/20220328/4.png" alt="" /></p>

<h4 id="dsi">DSI</h4>
<p>Before we look into the detail of the vulnerability we need to talk about Data Stream Interface (DSI). The DSI is a session layer format used to carry AFP traffic over TCP. While server and client communicate through the AFP, a DSI header is in front of each packet.</p>

<p>DSI Packet Header :</p>

<p><img src="/assets/img/blog/20220328/5.png" alt="" /></p>

<p>The content of the DSI packet is shown as the figure above. It contains metadata and payload, which generally follows the DSI header and payload format.</p>

<p>AFP over DSI :</p>

<p><img src="/assets/img/blog/20220328/6.png" alt="" /></p>

<p>The communication of the AFP protocol is shown above. The client first gets the server information to determine available authentication methods, the version used, and so on. Then it opens a new session and to execute AFP commands. Without authentication, we can only do related operations such as login and logout. Once the client is verified, we can do file operations like SMB.</p>

<p>In Netatalk implementation, <code class="highlighter-rouge">dsi_block</code> will be used as the packet structure.</p>

<p>dsi_block :</p>

<p><img src="/assets/img/blog/20220328/7.png" alt="" /></p>

<ul>
  <li>dsi_flag means that the packet is a request or reply</li>
  <li>dsi_command indicates what our request does
    <ul>
      <li>DSICloseSession</li>
      <li>DSICommand</li>
      <li>DSIGetStatus</li>
      <li>DSIOpenSession</li>
    </ul>
  </li>
  <li>dsi_code
    <ul>
      <li>Error code</li>
      <li>For reply</li>
    </ul>
  </li>
  <li>dsi_doff
    <ul>
      <li>DSI data offset</li>
      <li>Using in DSIWrite</li>
    </ul>
  </li>
  <li>dsi_len
    <ul>
      <li>The Length of Payload</li>
    </ul>
  </li>
</ul>

<p>DSI : A descriptor of dsi stream</p>

<p><img src="/assets/img/blog/20220328/8.png" alt="" /></p>

<p>In Netatalk, most of the information are stored in a structure called DSI for subsequent operations after parsing the packet and configuration files, such as <code class="highlighter-rouge">server_quantum</code> and payload content.</p>

<p><img src="/assets/img/blog/20220328/9.png" alt="" /></p>

<p>The payload of the packet is stored in the <code class="highlighter-rouge">command</code> buffer in the DSI structure. The buffer size is <code class="highlighter-rouge">server_quantum</code>, and the value is specified in the afp configuration file <code class="highlighter-rouge">afp.conf</code>.</p>

<p><img src="/assets/img/blog/20220328/10.png" alt="" /></p>

<p>If not specified, it uses the default size(0x100000).</p>

<p>With a preliminary understanding, letâ€™s talk about this vulnerability.</p>

<h3 id="vulnerability">Vulnerability</h3>

<p><img src="/assets/img/blog/20220328/11.png" alt="" /></p>

<p>The vulnerability we found occurs while receiving the payload. It can be triggered without authentication. The vulnerable function is <code class="highlighter-rouge">dsi_stream_receive</code>.</p>

<p><img src="/assets/img/blog/20220328/12.png" alt="" /></p>

<p>Itâ€™s the function that parses the information from received packet and puts it into the DSI structure. When it receives the packet data, it first determine how much data to read into the command buffer according to the <code class="highlighter-rouge">dsi_len</code> in the dsi header. At the beginning, the size of <code class="highlighter-rouge">dsi_cmdlen</code> is verified.</p>

<p><img src="/assets/img/blog/20220328/13.png" alt="" /></p>

<p>However, as shown in the picture above, if <code class="highlighter-rouge">dsi_doff</code> is provided by user, <code class="highlighter-rouge">dsi_doff</code> is used as the length. There is no verification here.</p>

<p><img src="/assets/img/blog/20220328/14.png" alt="" /></p>

<p>The default length of <code class="highlighter-rouge">dsi-&gt;commands</code> is 0x100000(<code class="highlighter-rouge">dsi-&gt;server_quantum</code>), which is a fixed length allocated in <code class="highlighter-rouge">dsi_init</code>, so as long as <code class="highlighter-rouge">dsi-&gt;header.dsi_doff</code> is larger than <code class="highlighter-rouge">dsi-&gt;server_quantum</code>, heap overflow occurs.</p>

<h3 id="exploitation">Exploitation</h3>

<p>In DSM 6.2.3, <code class="highlighter-rouge">dsi-&gt;commands</code> buffer is allocated by malloc at libc 2.20. When it allocates more than 0x20000, malloc calls mmap to allocate memory. The memory layout of afpd after <code class="highlighter-rouge">dsi_init</code> is as below.</p>

<p><img src="/assets/img/blog/20220328/15.png" alt="" /></p>

<p>At the below of <code class="highlighter-rouge">dsi-&gt;commands</code> is Thread Local Storage, which is used to store thread local variables of the main thread.</p>

<p><img src="/assets/img/blog/20220328/16.png" alt="" /></p>

<p>Because of this memory layout, we can use the vulnerability to overwrite the data on Thread Local Storage. What variables to be overwritten in the Thread Local Storage?</p>

<h4 id="thread-local-storage">Thread-local Storage</h4>
<p>Thread-local Storage (TLS) is used to store the local variables of the thread. Each thread have its own TLS, which allocated when the Thread is created. It will be released when thread is destroyed. We can use heap overflow vulnerabilities to overwrite most of the variables stored in TLS.</p>

<h4 id="target-in-tls">Target in TLS</h4>
<p>In fact, there are many variables that can control RIP on TLS. Here are a few more common ones.</p>

<ul>
  <li><code class="highlighter-rouge">main_arena</code>
    <ul>
      <li>We can forge main_arena to achieve arbitrary writing, but itâ€™s more complicated</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">pointer_guard</code>
    <ul>
      <li>We can modify the pointer guard to change the function pointer, but it requires a leak.</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">tls_dtor_list</code>
    <ul>
      <li>Itâ€™s more suitable for our current situation</li>
    </ul>
  </li>
</ul>

<h4 id="overwrite-tls_dtor_list">Overwrite <code class="highlighter-rouge">tls_dtor_list</code></h4>

<p>We can use the <a href="https://googleprojectzero.blogspot.com/2014/08/the-poisoned-nul-byte-2014-edition.html">technique</a> used by project zero in 2014 to overwrite the <code class="highlighter-rouge">tls_dtor_list</code> in the <code class="highlighter-rouge">Thread Local Storage</code>, and then control the RIP in exit().</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">dtor_list</span>
<span class="p">{</span>
    <span class="n">dtor_func</span> <span class="n">func</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">link_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dtor_list</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">tls_dtor_list</code> is a singly linked list of <code class="highlighter-rouge">dtor_list</code> objects. It is mainly a destructor for thread local storage. In the end of the thread execution, it calls destructor function pointer in the linked list. We can overwrite <code class="highlighter-rouge">tls_dtor_list</code> with <code class="highlighter-rouge">dtor_list</code> we forged.</p>

<p><img src="/assets/img/blog/20220328/17.png" alt="" /></p>

<p>When the process exits, it calls <code class="highlighter-rouge">call_tls_dtors()</code>. This function takes the object in <code class="highlighter-rouge">tls_dtor_list</code> and calls each destructor. At this time, if we can control <code class="highlighter-rouge">tls_dtor_list</code>, it calls the function we specified.</p>

<p><img src="/assets/img/blog/20220328/18.png" alt="" /></p>

<p>However, in the new version of glibc, the function of <code class="highlighter-rouge">dtor_list</code> is protected by pointer guard. So we need to know the value of pointer guard before we overwrite it. The pointer guard is initialized at the beginning of the program and is an unpredictable random number. If we donâ€™t have information leakage, itâ€™s hard to know the value.</p>

<p>But in fact pointer guard would also be placed in <code class="highlighter-rouge">Thread Local Storage</code>.</p>

<p><img src="/assets/img/blog/20220328/19.png" alt="" /></p>

<p>In the <code class="highlighter-rouge">Thread Local Storage</code>, there is a <code class="highlighter-rouge">tcbhead_t</code> structure below the <code class="highlighter-rouge">tls_dtor_list</code>, which is the thread descriptor of main thread.</p>

<p><code class="highlighter-rouge">tcbhead_t</code> structure is used to store various information about the thread such as the <code class="highlighter-rouge">stack_guard</code> and <code class="highlighter-rouge">pointer_guard</code> used by the thread. In x86-64 Linux system, the fs register always points to the <code class="highlighter-rouge">tcbhead_t</code> of the current thread, so the program access thread local storage by using fs register. The memory layout of <code class="highlighter-rouge">Thread local storage</code> is shown as below.</p>

<p><img src="/assets/img/blog/20220328/20.png" alt="" /></p>

<p>We can use the vulnerability to overwrite not only <code class="highlighter-rouge">tls_dtor_list</code> but also pointer guard in the <code class="highlighter-rouge">tcbhead_t</code>. In this way, we can overwrite it with <code class="highlighter-rouge">NULL</code> to solve the pointer guard problem mentioned earlier.</p>

<p><img src="/assets/img/blog/20220328/21.png" alt="" /></p>

<p>But another problem appears, after we overwrite pointer guard, stack guard will also be overwritten.</p>

<p><img src="/assets/img/blog/20220328/22.png" alt="" /></p>

<p>Before netatalk receives data, it first puts the original stack guard on the stack, and then invoke recv() to receive data to <code class="highlighter-rouge">dsi-&gt;command</code>. At this time, the buffer overflow occurs and cause stack guard and pointer guard to be overwritten. After this, netatalk returns to normal execution flow. It takes the stack guard from the stack and compare it with the stack guard in <code class="highlighter-rouge">Thread Local Storage</code>. However, it has been overwritten by us, the comparison here fails, causing abort to terminate the program.</p>

<h4 id="bypass-stack-guard">Bypass stack guard</h4>

<p><img src="/assets/img/blog/20220328/23.png" alt="" /></p>

<p>In the netatalk(afpd) architecture, each connection forks a new process to handle the userâ€™s request, so the memory address and stack guard of each connection are the same as the parent process. Because of this behavior, we can use brute-force bytes one by one to leak stack guard.</p>

<h4 id="brute-force-stack-guard">Brute-force stack guard</h4>

<p>We can use the overflow vulnerability to overwrite only the last byte of stack guard on <code class="highlighter-rouge">Thread Local Storage</code> with different value in each different connection. Once the value is different from the original value, the service disconnects. Therefore, we can use the behavior to validate whether the value we overwritten is the same as stack guard. After the lowest byte is determined, we can continue to add another byte, and so on.</p>

<p><img src="/assets/img/blog/20220328/24.png" alt="" /></p>

<p>In the above figure, we assume that the stack guard is <code class="highlighter-rouge">0xdeadbeeffacebc00</code>. Due to the stack guard feature in Linux, the lowest byte must be 0. Letâ€™s start with the second byte. We can overwrite with 0x00 to see if the connection is disconnected first. If it is disconnected, it means the value we overwrote is wrong. Next, we will test other values to see if the connection is disconnected. And so on, until there is no disconnection, we can find the correct value of section bytes. Then we can try to overwrite third byte, fourth byte and so on. After the stack guard is overwritten with 8 bytes and the connection is not disconnected, we can successfully bypass the stack guard.</p>

<p>After we leak the stack guard, we can actually control RIP successfully. <br />
Next, we need to forge the structure <code class="highlighter-rouge">_dtor_list</code> to control RIP.</p>

<h4 id="construct-the-_dtor_list-to-control-rip">Construct the <code class="highlighter-rouge">_dtor_list</code> to control RIP</h4>

<p>In DSM 6.2.3-25426, Because it does not enable PIE, we can forge <code class="highlighter-rouge">_dtor_list</code> on the data section of afpd.</p>

<p><img src="/assets/img/blog/20220328/25.png" alt="" /></p>

<p>Luckily, when netatalk use <code class="highlighter-rouge">dhx2 login</code> authentication, it will copy the username we provided to the data section of afpd. We can use the feature to construct <code class="highlighter-rouge">_dtor_list</code> on the known address.</p>

<p><img src="/assets/img/blog/20220328/26.png" alt="" /></p>

<p>After everything is constructed, we can trigger the normal function <code class="highlighter-rouge">DSICloseSession</code> to control the RIP.</p>

<h4 id="tls_dtor_list-in-synology"><code class="highlighter-rouge">tls_dtor_list</code> in Synology</h4>

<p><img src="/assets/img/blog/20220328/27.png" alt="" /></p>

<p>But in the glibc-2.20 in DSM 6.2.3-25426, it will invoke  <code class="highlighter-rouge">__tls_get_addr</code> to get the variable <code class="highlighter-rouge">tls_dtor_list</code>. The function will take the variable from <code class="highlighter-rouge">tcb-&gt;div</code>. We also need to construct it on a known address.</p>

<p>The final structure we forged is as follows</p>

<p><img src="/assets/img/blog/20220328/28.png" alt="" /></p>

<p>Finally, we control RIP to invoke execl() in afpd to get the reverse shell.</p>

<center><div class="videowrapper"><iframe width="560" height="420" src="https://www.youtube.com/embed/ocZkWuSCr4Y" frameborder="0"> </iframe></div></center>

<h3 id="remark">Remark</h3>
<p>In general Netatalk, PIE protection is enabled by default. It is difficult to construct <code class="highlighter-rouge">_dtor_list</code> in a known address. In fact, you can also leak libc address using a similar method. It is still exploitable.</p>

<p>This vulnerability not only affects Synology, but also affects some devices use Netatalk.</p>

<h3 id="other-vendor">Other vendor</h3>

<p>We tested several vendors using Netatalk and found that most device have similar problems, some are unexploitable but some are exploitable. We have tested QNAP and Asustor here, and both have successfully obtained the shell.</p>

<h4 id="qnap">QNAP</h4>
<ul>
  <li>We tested on TS451
    <ul>
      <li>QTS 4.5.4.1741</li>
    </ul>
  </li>
  <li>Not enable by default</li>
  <li>Protection
    <ul>
      <li><strong>No Stack Guard</strong></li>
      <li>No PIE</li>
    </ul>
  </li>
  <li>Built-in system function</li>
</ul>

<p><img src="/assets/img/blog/20220328/29.png" alt="" /><br />
<img src="/assets/img/blog/20220328/30.png" alt="" /></p>

<h4 id="asustor">Asustor</h4>
<ul>
  <li>We tested on AS5202T
    <ul>
      <li>ADM 3.5.7.RJR1</li>
    </ul>
  </li>
  <li>Not enable by default</li>
  <li>Protection
    <ul>
      <li><strong>No Stack Guard</strong></li>
      <li>No PIE</li>
    </ul>
  </li>
  <li>Built-in system function</li>
</ul>

<p><img src="/assets/img/blog/20220328/31.png" alt="" /></p>

<p>It is worth mentioning that both QNAP and Asustor NAS does not enabled stack guard, and you can get the reverse shell without brute-force.</p>

<p>When Synology has not yet patched this vulnerability, it can be exploited as long as the default is installed. <strong>No authentication is required</strong>.</p>

<p>Although QNAP and Asustor are not enabled by default, many users who use Macs still turn it on for convenience. Actually, Netatalk will be used almost in NAS. Most NAS will have an impact, as long as they enable Netatalk, an attacker can use this vulnerability to take over most of the NAS.</p>

<p><strong>Your NAS is not your NAS !</strong></p>

<p><img src="/assets/img/blog/20220328/32.png" alt="" /></p>

<p>In fact, many people open Netatalk on the external network. There are 130,000 machines on shodan alone, most of which are Synology.</p>

<h2 id="mitigation">Mitigation</h2>
<h3 id="update">Update</h3>
<p>At present, the above three have been patched, please update to the latest version.</p>
<ul>
  <li>Synology
    <ul>
      <li>https://www.synology.com/zh-hk/security/advisory/Synology_SA_20_26</li>
    </ul>
  </li>
  <li>QNAP
    <ul>
      <li>https://www.qnap.com/en/security-advisory/qsa-21-50</li>
    </ul>
  </li>
  <li>Asustor
    <ul>
      <li>https://www.asustor.com/service/release_notes#ADM%203.5.7.RKU2</li>
    </ul>
  </li>
</ul>

<p>This vulnerability is also fixed in the recently released <a href="https://netatalk.sourceforge.io/3.1/ReleaseNotes3.1.13.html">Netatalk 3.1.13</a>. If you use a version before Netatalk 3.1.13, you also need to update to the latest version.</p>

<h3 id="disable-afp">Disable AFP</h3>
<ul>
  <li>Itâ€™s best to disable it directly. The project is rarely maintained, and the risk of continuing to use it is extremely high.</li>
  <li>SMB is <strong>relatively safe</strong>
    <ul>
      <li>If you want to use similar feature, it is recommended to use SMB. It is relatively safe, but it can only be said to be relatively safe.</li>
      <li>It is recommended that all related services should be opened in the intranet.</li>
    </ul>
  </li>
</ul>

<h2 id="summary">Summary</h2>
<p>We have successfully found a serious vulnerability in the NAS, and successfully wrote a proof-of-concept, which proved that it can be exploited on many NAS such as Synology, QNAP and Asustor.</p>

<p>We also think that Netatalk is a new generation of backdoor in NAS!</p>

<p>In the future, We hope that NAS vendor who use third-party can re-examine the security issues caused by them. It is strongly recommended that NAS vendor can review it by themselves and pay attention to whether other vendor have also fixed the vulnerabilities in the same third-party. It is possible that it will also be affected.</p>

<p>The users who want to use NAS can also pay more attention to not opening the NAS on the external network and unused services should be disabled as much as possible to reduce the attack surface.</p>

<h2 id="to-be-continue">To be continue</h2>
<p>In fact, we have not only found one vulnerability, we have also found that there are still many problems. In next part, we will publish more research after most vendor fix it.</p>

<p>Please look forward to Part II.</p>


              </article>
              <p class="sns-widgets">
                Share this on <button class="appearance-none sns-widgets__button" id="sns-facebook" type="button">Facebook</button> or <button class="appearance-none sns-widgets__button" id="sns-twitter" type="button">Twitter</button>
              </p>
          
              <div class="heading--side-lined">
                About <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/angelboy.jpg)"></span> <a href="/en/blog/author/angelboy" class="blog-author-name">Angelboy</a> 
              </div>
              <p class="blog-author-info">
                I am ðŸ‘¼ :)
              </p>
          
              <div class="heading--side-lined">
                Comments
              </div>
              <div class="blog-comments">
                


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'd3vc0r3'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




              </div>
            </div>
          </div>






</main>
      <div class="container--wrapper">


        <div class="contact-section container">
          <h2 class="contact-section__title">
            Put your defenses to the test with authentic attacks
          </h2>
          <a href="/en/contact/" class="home-contact__button button--dense">Contact us now</a>
        </div>

        <footer class="main-footer">
          <div class="main-footer__about">
            DEVCORE offers professional<br class="mobile-only" /><a href="/en/services/penetration-test" class="link">pentesting</a>, <a href="/en/services/red-team" class="link">red teaming</a>, <a href="/en/services/security-consulting" class="link">consulting</a>, and <a href="/en/services/security-training" class="link">training</a> services.<br />For <a href="/en/blog/" class="link">latest updates</a>, follow us on <a href="https://www.facebook.com/D3VC0RE" class="link" target="_blank">Facebook</a> or <a href="https://twitter.com/d3vc0r3" class="link" target="_blank">Twitter</a>.
          </div>
          <div class="main-footer__snses"><a href="https://www.facebook.com/D3VC0RE" class="main-footer__sns" target="_blank">
                <svg class="icon-fb icon"><use xlink:href="#icon-fb" /></svg></a><a href="https://twitter.com/d3vc0r3" class="main-footer__sns" target="_blank">
                <svg class="icon-twitter icon"><use xlink:href="#icon-twitter" /></svg></a>
          </div>
          <address class="main-footer__address">
            <ul class="list--unstyled">
              <li>
                13F., No. 32, Sec. 3, Bade Rd., Songshan Dist., Taipei City 105608, Taiwan
              </li>
              <li>
                contact@devco.re
              </li>
              <li>
                +886-2-2577-0925
              </li>
            </ul>
          </address><small class="main-footer__copyright"><a href="/" class="logo">DEVCORE</a>Â©2022 DEVCORE</small>
        </footer>
      </div>
    </div>
    <script src="/assets/themes/devcore-v2/javascripts/webpack_bundle.js"></script>



  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30830800-1']);
  _gaq.push(['_trackPageview', location.pathname + location.search + location.hash]);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K5B8NW"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

  </body>
</html>




