

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>Rails 動態樣板路徑的風險 | DEVCORE 戴夫寇爾</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="OWASP 是說，如果你的樣板路徑是動態產生的，而且使用者可以控制那個樣板路徑，那麼使用者就可以讀取到任意樣板，包含管理介面的樣板。這樣的描述感覺還好，但就我們的發現，這其實是更嚴重的直接存取物件問題(Insecure Direct Object References)，甚至有機會造成遠端命令執行(Remote Code Execution)，怎麼說呢？我們直接看下去。" />
    <meta name="keywords" content="Rails, Vulnerability, RCE, IDOR" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="Rails 動態樣板路徑的風險 | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2015/07/24/the-vulnerability-of-dynamic-render-paths-in-rails/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20150724/rails.png" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Rails 動態樣板路徑的風險 | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="OWASP 是說，如果你的樣板路徑是動態產生的，而且使用者可以控制那個樣板路徑，那麼使用者就可以讀取到任意樣板，包含管理介面的樣板。這樣的描述感覺還好，但就我們的發現，這其實是更嚴重的直接存取物件問題(Insecure Direct Object References)，甚至有機會造成遠端命令執行(Remote Code Execution)，怎麼說呢？我們直接看下去。">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20150724/rails.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2015/07/24/the-vulnerability-of-dynamic-render-paths-in-rails/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body>
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>服務<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    紅隊演練
                                </h2>
                                <p class="two-line">
                                    在不影響企業營運前提下，無所不用其極，從各種進入點執行模擬入侵攻擊，達成企業指定的演練情境。
                                </p>
                            </div>
                        </a>
                        <a href="/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    滲透測試
                                </h2>
                                <p class="two-line">
                                    以駭客思維及手法嘗試入侵企業指定系統，找出潛在漏洞，驗證企業資料與設備是否可被竊取或破壞。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    資安顧問服務
                                </h2>
                                <p class="two-line">
                                    以紅隊演練為基礎，提供攻擊者視角與可能入侵路徑，協助企業評估資安資源優先順序，並擬定長期防禦策略。
                                </p>
                            </div>
                        </a>
                        <a href="/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    資安教育訓練
                                </h2>
                                <p class="two-line">
                                    從攻擊思維出發，協助企業有效預防資安事故並防禦；以及事件發生時，如何快速判定攻擊目的、手法、漏洞與及應變方式。
                                </p>
                            </div>
                        </a>

                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>研究<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    總覽概要
                                </h2>
                                <p class="two-line">
                                    持續精研資安最新技術及漏洞研究趨勢，全方位檢測企業產品安全性、吸取經驗並轉化為紅隊演練工具與手法。
                                </p>
                            </div>
                        </a>
                        <a href="/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    競賽與獎項
                                </h2>
                                <p class="two-line">
                                    國際級資訊安全競賽獎項肯定。
                                </p>
                            </div>
                        </a>
                        <a href="/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    企業漏洞回報
                                </h2>
                                <p class="two-line">
                                    研究企業系統中的資安風險及各種可能的突破口，並通報企業修補。
                                </p>
                            </div>
                        </a>
                        <a href="/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    國際研討會
                                </h2>
                                <p class="two-line">
                                    參與全球資安盛會，發表、交流漏洞的知識與資訊。
                                </p>
                            </div>
                        </a>
                        <a href="/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE 漏洞列表
                                </h2>
                                <p class="two-line">
                                    挖掘並回報國際知名產品與服務的重大漏洞。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>公司<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                公司簡介
                            </h2>
                            <p>
                                DEVCORE 戴夫寇爾由世界級白帽駭客團隊創立，提供紅隊演練、滲透測試、資安顧問服務、資安教育訓練等服務。
                            </p>
                        </div>
                        </a>
                        <a href="/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    團隊成員
                                </h2>
                                <p class="two-line">
                                    由熱衷挑戰、具備駭客思維的資安專家組成，專注於創新攻擊手法研究，並以「高道德、高自律、高嚴謹」為最高指導原則。
                                </p>
                            </div>
                        </a>
                        <a href="/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    成就與沿革
                                </h2>
                                <p class="two-line">
                                    長期聚焦於攻擊研究，屢屢獲邀參與全球知名資安研討會，已揭露數百個重要產品漏洞、協助企業提升防禦能量。
                                </p>
                            </div>
                        </a>
                        <a href="/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    企業社會責任
                                </h2>
                                <p class="two-line">
                                    提供多元實習管道和研習計畫，提升新世代人才資安能量，推廣資訊安全意識。
                                </p>
                            </div>
                        </a>
                        <a href="/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    工作機會
                                </h2>
                                <p class="two-line">
                                    加入 DEVCORE，共同改善資安產業結構，與我們一起打造更安全的世界。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>新聞<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    DEVCORE 最新消息。
                                </p>
                            </div>
                        </a>
                        <a href="/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    媒體素材下載
                                </h2>
                                <p>
                                    使用 DEVCORE 商標須遵循的使用規範。
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/search/">搜尋</a>
            </li>
            <li>
                <a class="menuLable" href="/contact/">聯絡我們</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>服務</span>
                <div class="menuItem">
                    <a href="/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                紅隊演練
                            </h2>
                        </div>
                    </a>
                    <a href="/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                滲透測試
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                顧問服務
                            </h2>
                        </div>
                    </a>
                    <a href="/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                教育訓練
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>資安研究</span>
                <div class="menuItem">
                    <a href="/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>總覽概要</h2>
                        </div>
                    </a>
                    <a href="/research/awards/">
                        <div class="item">
                            <h2>競賽與獎項</h2>
                        </div>
                    </a>
                    <a href="/research/bug-bounty/">
                        <div class="item">
                            <h2>Bug Bounty</h2>
                        </div>
                    </a>
                    <a href="/research/talks/">
                        <div class="item">
                            <h2>國際研討會</h2>
                        </div>
                    </a>
                    <a href="/research/cve/">
                        <div class="item">
                            <h2>CVE 漏洞列表</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>公司</span>
                <div class="menuItem">
                    <a href="/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>公司簡介</h2>
                        </div>
                    </a>
                    <a href="/company/our-team/">
                        <div class="item">
                            <h2>團隊成員</h2>
                        </div>
                    </a>
                    <a href="/company/history/">
                        <div class="item">
                            <h2>成就與沿革</h2>
                        </div>
                    </a>
                    <a href="/company/csr/">
                        <div class="item">
                            <h2>企業社會責任</h2>
                        </div>
                    </a>
                    <a href="/company/jobs/">
                        <div class="item">
                            <h2>工作機會</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>新聞</span>
                <div class="menuItem">
                    <!-- <a href="/blog/">
                    <div class="item">
                        <h2>所有文章</h2>
                    </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>案例剖析</h2>
                        </div>
                    </a> -->
                    <!-- <a href="">
                        <div class="item">
                            <h2>科普文章</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>技術專欄</h2>
                        </div>
                    </a>
                    <a href="">
                        <div class="item">
                            <h2>資安新聞</h2>
                        </div>
                    </a> -->
                    <a href="/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/media-kit/">
                        <div class="item">
                            <h2>媒體素材下載</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                搜尋
                            </h2>
                        </div>
                    </a>
                    <a href="/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                聯絡我們
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/blog/">所有文章</a>
                </li>
                <li>
                    <a href="/blog/category/最新消息/">最新消息</a>
                </li>
                <li>
                    <a href="/blog/category/技術專欄/">技術專欄</a>
                </li>
                <li>
                    <a href="/blog/category/科普文章/">科普文章</a>
                </li>
                <li>
                    <a href="/blog/category/資安新聞/">資安新聞</a>
                </li>
                <li>
                    <a href="/media-kit/">媒體素材下載</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                    <span class="tag">

                      <a href="/blog/tag/Rails/">#Rails</a> <a href="/blog/tag/Vulnerability/">#Vulnerability</a> <a href="/blog/tag/RCE/">#RCE</a> <a href="/blog/tag/IDOR/">#IDOR</a> 
                    </span>
                    <h1>
                        Rails 動態樣板路徑的風險
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/blog/author/shaolin">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/shaolin.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/blog/author/shaolin">Shaolin</a></span>
                        <span class="date">2015-07-24</span>
                    </div>
                    
                    
                    <div class="article_img">
                        <img src="https://devco.re/assets/img/blog/20150724/rails.png"/>
                    </div>
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<h3 id="前言">前言</h3>

<p>從安全開發的角度來看，Ruby on Rails 是一套很友善的框架。它從框架層避免了很多過去網站常出現的安全問題，例如使用 ORM 避免大部分的 SQL injection 問題、有內建的 authenticity_token 讓開發者不必特別煩惱 CSRF、從機制面規定開發者使用 Strong Parameter 避免 Mass Assignment、預設轉化危險字元避免 XSS 等…。</p>

<p>就我們過去<a href="https://devco.re/services/penetration-test/">滲透測試</a>的經驗來說，Rails 網站雖然還是能找到問題，但相對問題較少，而且很少單純因為 Rails 寫法問題拿到系統操作權。而今天要分享的，是在一次滲透測試中比較特別的例子，因為開發者使用了動態樣板路徑(Dynamic Render Paths)的寫法<sup id="fnref:note1" role="doc-noteref"><a href="#fn:note1" class="footnote" rel="footnote">1</a></sup>，最後造成了嚴重的結果。</p>

<!-- more -->

<p>動態樣板路徑，OWASP 的<a href="https://www.owasp.org/index.php/Ruby_on_Rails_Cheatsheet#Dynamic_Render_Paths">介紹</a>是這樣的：</p>

<blockquote>
  <p>In Rails, controller actions and views can dynamically determine which view or partial to render by calling the “render” method. If user input is used in or for the template name, an attacker could cause the application to render an arbitrary view, such as an administrative page.<br /><br />
Care should be taken when using user input to determine which view to render. If possible, avoid any user input in the name or path to the view.</p>
</blockquote>

<p>OWASP 是說，如果你的樣板路徑是動態產生的，而且使用者可以控制那個樣板路徑，那麼使用者就可以讀取到任意樣板，包含管理介面的樣板。這樣的描述感覺還好，但就我們的發現，這其實是更嚴重的直接存取物件問題(Insecure Direct Object References)，甚至有機會造成遠端命令執行(Remote Code Execution)，怎麼說呢？我們直接看下去。</p>

<h3 id="基本細節">基本細節</h3>

<p>一個動態樣板路徑的寫法如下：</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/controllers/welcome_controller.rb</span>
<span class="k">class</span> <span class="nc">WelcomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">]</span> <span class="o">||</span> <span class="s1">'index'</span>
    <span class="n">render</span> <span class="n">page</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>而 index 的樣板內容是這樣：</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="c">&lt;!-- app/views/welcome/index.html.erb --&gt;</span>
This is INDEX page.</code></pre></figure>

<p>另外建一個 demo 樣板做示意：</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="c">&lt;!-- app/views/welcome/demo.html.erb --&gt;</span>
This is DEMO page.</code></pre></figure>

<p>實際測試，如果我們連到 WelcomeController 的 index action，不帶任何參數會讀取 index 模版。</p>

<p><a href="/assets/img/blog/20150724/render_index.png"><img src="/assets/img/blog/20150724/render_index.png" alt="Rails render index view" title="Rails render index view" /></a></p>

<p>如果帶參數 page=demo，會讀取到 demo 模版。</p>

<p><a href="/assets/img/blog/20150724/render_demo.png"><img src="/assets/img/blog/20150724/render_demo.png" alt="Rails render demo view" title="Rails render demo view" /></a></p>

<p>所以，如果我們知道管理介面的模版路徑，送出路徑參數就可以讀取到管理介面。這就是 OWASP 所描述的風險，攻擊者得以讀取任意模版。</p>

<p><a href="/assets/img/blog/20150724/render_admin.png"><img src="/assets/img/blog/20150724/render_admin.png" alt="Rails render admin view" title="Rails render admin view" /></a></p>

<p>然而，當我們嘗試送出系統絕對路徑例如 /etc/passwd <sup id="fnref:note2" role="doc-noteref"><a href="#fn:note2" class="footnote" rel="footnote">2</a></sup>，網頁竟然吐出了 /etc/passwd 的內容！這就是之前所述的直接存取物件問題，可以遍歷目錄瀏覽檔案。</p>

<p><a href="/assets/img/blog/20150724/render_file_traversal.png"><img src="/assets/img/blog/20150724/render_file_traversal.png" alt="Rails render Insecure Direct Object References" title="Rails render Insecure Direct Object References" /></a></p>

<h3 id="進階攻擊">進階攻擊</h3>

<p>通常在 Rails 環境下能夠讀取任意檔案，攻擊者會優先尋找 secret_token，目的是變造惡意 session cookie 利用 Marshal serialize 的問題做 <a href="http://robertheaton.com/2013/07/22/how-to-hack-a-rails-app-using-its-secret-token/">RCE</a>。然而在本案例系統使用了 Rails 4.1 後的版本，Rails 4.1 預設使用了 JSON-based 的 serializer 防止了之前的 RCE 問題，所以並沒有辦法輕鬆利用。</p>

<p>為了取得系統操作權，我們嘗試尋找其他可利用的地方。在這邊我們發現了該站系統 production.log 中存在 AWS 的上傳紀錄。如下：</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># log/production.log</span>
<span class="no">INFO</span> <span class="o">--</span> <span class="p">:</span> <span class="p">[</span><span class="no">AWS</span> <span class="no">S3</span> <span class="mi">200</span> <span class="mf">0.041347</span> <span class="mi">0</span> <span class="n">retries</span><span class="p">]</span> <span class="n">put_object</span><span class="p">(</span><span class="ss">:acl</span><span class="o">=&gt;</span><span class="ss">:public_read</span><span class="p">,</span><span class="ss">:bucket_name</span><span class="o">=&gt;</span><span class="s2">"xxxx"</span><span class="p">,</span><span class="ss">:content_length</span><span class="o">=&gt;</span><span class="mi">12405</span><span class="p">,</span><span class="ss">:content_type</span><span class="o">=&gt;</span><span class="s2">"image/png"</span><span class="p">,</span><span class="ss">:data</span><span class="o">=&gt;</span><span class="c1">#&lt;File:/Users/shaolin/project/playground/rails/render/public/uploads/tmp/test_upload.png (12405 bytes)&gt;,:key=&gt;"upload_001")</span></code></pre></figure>

<p>於是我們可以利用上傳檔案的 Content-Type 內容，將 Embedded Ruby 語句 &lt;%=`#{params[:devcore]}`%&gt; 添加到 production.log 檔案裡面。於是 log 的內容變成了下面這樣：</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># log/production.log</span>
<span class="no">INFO</span> <span class="o">--</span> <span class="p">:</span> <span class="p">[</span><span class="no">AWS</span> <span class="no">S3</span> <span class="mi">200</span> <span class="mf">0.041347</span> <span class="mi">0</span> <span class="n">retries</span><span class="p">]</span> <span class="n">put_object</span><span class="p">(</span><span class="ss">:acl</span><span class="o">=&gt;</span><span class="ss">:public_read</span><span class="p">,</span><span class="ss">:bucket_name</span><span class="o">=&gt;</span><span class="s2">"xxxx"</span><span class="p">,</span><span class="ss">:content_length</span><span class="o">=&gt;</span><span class="mi">12405</span><span class="p">,</span><span class="ss">:content_type</span><span class="o">=&gt;</span><span class="s2">"image/png"</span><span class="p">,</span><span class="ss">:data</span><span class="o">=&gt;</span><span class="c1">#&lt;File:/Users/shaolin/project/playground/rails/render/public/uploads/tmp/test_upload.png (12405 bytes)&gt;,:key=&gt;"upload_001")</span>

<span class="no">INFO</span> <span class="o">--</span> <span class="p">:</span> <span class="p">[</span><span class="no">AWS</span> <span class="no">S3</span> <span class="mi">200</span> <span class="mf">0.040211</span> <span class="mi">0</span> <span class="n">retries</span><span class="p">]</span> <span class="n">put_object</span><span class="p">(</span><span class="ss">:acl</span><span class="o">=&gt;</span><span class="ss">:public_read</span><span class="p">,</span><span class="ss">:bucket_name</span><span class="o">=&gt;</span><span class="s2">"xxxx"</span><span class="p">,</span><span class="ss">:content_length</span><span class="o">=&gt;</span><span class="mi">12405</span><span class="p">,</span><span class="ss">:content_type</span><span class="o">=&gt;</span><span class="s2">"&lt;%=`</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:devcore</span><span class="p">]</span><span class="si">}</span><span class="s2">`%&gt;"</span><span class="p">,</span><span class="ss">:data</span><span class="o">=&gt;</span><span class="c1">#&lt;File:/Users/shaolin/project/playground/rails/render/public/uploads/tmp/test_upload.png (12405 bytes)&gt;,:key=&gt;"upload_002")</span></code></pre></figure>

<p>接著，我們就可以利用前面的弱點讀取 production.log 檔案，再帶一個 devcore 參數作為指令，如圖，成功取得系統操作權 :p</p>

<p><a href="/assets/img/blog/20150724/render_RCE.png"><img src="/assets/img/blog/20150724/render_RCE.png" alt="Rails render Remote Code Execution" title="Rails render Remote Code Execution" /></a></p>

<h3 id="風險原因">風險原因</h3>

<p>一般來說 Rails 開發並不太會這樣寫，但稍微搜尋一下 Github 還是能發現這種寫法存在一些專案中。我想主要原因多半是開發者想要偷懶，然後也可能想說動態樣板路徑頂多就被看到面板的 html，無傷大雅。誰知道就因為這樣導致整個程式碼內容被讀取。</p>

<p>若有一個 action 要動態顯示不同模版的需求，為了避免上述的問題，就辛苦點先用 case…when 去判斷吧。這跟不要用字串組 SQL 語句避免 SQL injection 一樣，這種外面傳進來的參數都要謹慎處理的觀念要內化在開發中。</p>

<p>除了開發者基本上不應該這樣開發外，Rails 本身也有一點點問題，當 render 路徑沒有副檔名，無法判斷什麼格式時，就會直接採用預設的 template handler。</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/action_view/template/resolver.rb</span>
<span class="k">def</span> <span class="nf">extract_handler_and_format_and_variant</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">default_formats</span><span class="p">)</span>
  <span class="n">pieces</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)</span>
  <span class="n">pieces</span><span class="p">.</span><span class="nf">shift</span>

  <span class="n">extension</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">.</span><span class="nf">pop</span>
  <span class="k">unless</span> <span class="n">extension</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s2">"The file </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2"> did not specify a template handler. The default is currently ERB, "</span> <span class="p">\</span>
              <span class="s2">"but will change to RAW in the future."</span>
    <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="p">.</span><span class="nf">warn</span> <span class="n">message</span>
  <span class="k">end</span>

  <span class="n">handler</span> <span class="o">=</span> <span class="no">Template</span><span class="p">.</span><span class="nf">handler_for_extension</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
  <span class="nb">format</span><span class="p">,</span> <span class="n">variant</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="no">EXTENSIONS</span><span class="p">[</span><span class="ss">:variants</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">pieces</span><span class="p">.</span><span class="nf">last</span>
  <span class="nb">format</span>  <span class="o">&amp;&amp;=</span> <span class="no">Template</span><span class="o">::</span><span class="no">Types</span><span class="p">[</span><span class="nb">format</span><span class="p">]</span>

  <span class="p">[</span><span class="n">handler</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">variant</span><span class="p">]</span>
<span class="k">end</span></code></pre></figure>

<p>而這裡預設的 handler 是 ERB（見 register_default_template_handler），所以有本篇後面提到的進階攻擊，可以被利用來 RCE。</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/action_view/template/handlers.rb</span>
<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
  <span class="n">base</span><span class="p">.</span><span class="nf">register_default_template_handler</span> <span class="ss">:erb</span><span class="p">,</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">base</span><span class="p">.</span><span class="nf">register_template_handler</span> <span class="ss">:builder</span><span class="p">,</span> <span class="no">Builder</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">base</span><span class="p">.</span><span class="nf">register_template_handler</span> <span class="ss">:raw</span><span class="p">,</span> <span class="no">Raw</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">base</span><span class="p">.</span><span class="nf">register_template_handler</span> <span class="ss">:ruby</span><span class="p">,</span> <span class="ss">:source</span><span class="p">.</span><span class="nf">to_proc</span>
<span class="k">end</span></code></pre></figure>

<p>慶幸的是，目前 Rails 已經把預設的 template handler 從 ERB 改成 RAW，不會輕易把要 render 的檔案當成 ERB 執行了。詳細的內容請參考這個 <a href="https://github.com/rails/rails/commit/4be859f0fdf7b3059a28d03c279f03f5938efc80">commit</a>。</p>

<h3 id="結論">結論</h3>

<p>Ruby on Rails 能讓開發者較輕鬆的開發出安全的應用程式，然而，若開發者不注意，還是有可能寫出嚴重的漏洞。本文的動態樣板路徑就是這樣一個例子，它不只是 OWASP 所描述的可以存取任意模版而已，它可以遍歷檔案，甚至因為 rails 預設的 template handler 是 ERB，造成遠端命令執行讓攻擊者取得伺服器操作權。</p>

<p>這個例子又再次驗證，框架可以幫助大家快速開發，增加安全度。但唯有良好的安全意識，才是應用程式安全的基石。</p>

<h3 id="註解">註解</h3>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:note1" role="doc-endnote">
      <p>Dynamic Render Paths 目前並沒有中文翻譯，因為問題之精髓在於要產生的樣板路徑是可變動的，因此筆者認為動態樣板路徑這個翻譯較為貼切。 <a href="#fnref:note1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:note2" role="doc-endnote">
      <p>筆者測試的環境為 Rails 4.1.4，其他 Rails 版本有可能需要用 ../../../../../etc/passwd 跳脫目前目錄。 <a href="#fnref:note2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/blog/author/shaolin">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/shaolin.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/blog/author/shaolin">
                            <h3>Shaolin</h3>
                        </a>
                        <span>Red Team Director</span>
                        <p>
                            喜愛資訊技術、喜歡跟別人走不一樣的路。有一點點智障的熱血人，期望能利用資訊的力量對世界有所貢獻。
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

        <!-- 相關文章 -->
        <section class="recommand articles-list">
            <div class="container">
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/最新消息">最新消息</a>
                        <span class="tag">
    
                          <a href="/blog/tag/公告/">#公告</a> <a href="/blog/tag/徵才/">#徵才</a> 
                        </span>
                        <h2>
                            <a href="/blog/2024/01/05/5nd-internship-program-recruit/">DEVCORE 2024 第五屆實習生計畫</a> 
                        </h2>
                    
                    
                        <span class="date">2024-01-05</span>
                        <p class="line-litmit-3">DEVCORE 第五屆實習生計畫開始，計畫目的希望能培育人才、增強新世代的資安技能，如果您對這個計畫有興趣，歡迎來信報名！
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                        <span class="tag">
    
                          <a href="/blog/tag/CVE/">#CVE</a> <a href="/blog/tag/Pwn2Own/">#Pwn2Own</a> <a href="/blog/tag/RCE/">#RCE</a> <a href="/blog/tag/IoT/">#IoT</a> 
                        </span>
                        <h2>
                            <a href="/blog/2023/11/06/your-printer-is-not-your-printer-hacking-printers-pwn2own-part2/">Your printer is not your printer ! - Hacking Printers at Pwn2Own Part II</a> 
                        </h2>
                    
                    
                        <a class="author" href="/blog/author/shaolin">
                            <h3>angelboy</h3>
                        </a>
                    
                        <span class="date">2023-11-06</span>
                        <p class="line-litmit-3">我們在 Canon 的印表機找到了 Pre-auth RCE 漏洞 (CVE-2023-0853、CVE-2023-0854)，同時在 HP 印表機也有找到 Pre-auth RCE 的漏洞。最終拿下 Pwn2Own Toronto 2022 Master of Pwn。我們將在本文介紹 Canon 及 HP 漏洞的細節及利用方式。
                        </p>
                    </div>
                </article>
              
                <!-- 相關文章 Item -->
                <article class="article">
                    <div class="content">
                        <a class="category" href="/blog/category/技術專欄">技術專欄</a>
                        <span class="tag">
    
                          <a href="/blog/tag/CVE/">#CVE</a> <a href="/blog/tag/Pwn2Own/">#Pwn2Own</a> <a href="/blog/tag/RCE/">#RCE</a> <a href="/blog/tag/IoT/">#IoT</a> 
                        </span>
                        <h2>
                            <a href="/blog/2023/10/05/your-printer-is-not-your-printer-hacking-printers-pwn2own-part1/">Your printer is not your printer ! - Hacking Printers at Pwn2Own Part I</a> 
                        </h2>
                    
                    
                        <a class="author" href="/blog/author/shaolin">
                            <h3>angelboy</h3>
                        </a>
                    
                        <span class="date">2023-10-05</span>
                        <p class="line-litmit-3">我們在 Canon 和 HP 的印表機中發現了 Pre-auth RCE 的漏洞(CVE-2022-24673 及 CVE-2022-3942) 及 Lexmark 發現漏洞(CVE-2021-44734)，並在 Pwn2Own Austin 2021 中取得所有印表機的控制權，成功獲得 Pwn2Own 中駭客大師(Master of Pwn) 的點數，這篇研究將講述 Canon 及 HP 漏洞的細節及我們的利用方式。
                        </p>
                    </div>
                </article>
              

            </div>
        </section>
    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">服務</h6>
        <ul>
            <li><a href="/services/red-team/">紅隊演練</a></li>
            <li><a href="/services/penetration-test/">滲透測試</a></li>
            <li><a href="/services/security-consulting/">資安顧問服務</a></li>
            <li><a href="/services/security-training/">資安教育訓練</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">研究</h6>
        <ul>
            <li><a href="/research/overview/">總覽概要</a></li>
            <li><a href="/research/awards/">競賽與獎項</a></li>
            <li><a href="/research/bug-bounty/">企業漏洞回報</a></li>
            <li><a href="/research/talks/">國際研討會</a></li>
            <li><a href="/research/cve/">CVE 漏洞列表</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">公司</h6>
        <ul>
            <li><a href="/company/about/">公司簡介</a></li>
            <li><a href="/company/our-team/">團隊成員</a></li>
            <li><a href="/company/history/">成就與沿革</a></li>
            <li><a href="/company/csr/">企業社會責任</a></li>
            <li><a href="/company/jobs/">工作機會</a></li>
            <li><a href="/contact/">聯絡我們</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">新聞</h6>
        <ul>
            <li><a href="/blog/">BLOG</a></li>
            <li><a href="/media-kit/">媒體素材下載</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2024 DEVCORE 戴夫寇爾股份有限公司. <b class="line-block">All rights reserved.</b></span>
            <span><a href="/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>

